<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 909) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-909.html">
<link rel="prev" href="index-910.html" type="text/html">
<link rel="next" href="index-908.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/what-s-the-strategy-for-handling-crlf-carriage-return-line-feed-with-git/" class="u-url">What's the strategy for handling CRLF (carriage return, line feed) with Git?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/what-s-the-strategy-for-handling-crlf-carriage-return-line-feed-with-git/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T19:15:16+08:00" itemprop="datePublished" title="2023-02-17 19:15">2023-02-17 19:15</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I tried committing files with CRLF-ending lines, but it failed.</p>
<p>I spent a whole work day on my Windows computer trying different strategies
and was almost drawn to stop trying to use Git and instead try Mercurial.</p>
<p>How to properly handle CRLF line endings?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Almost four years after asking this question, I have finally found <strong>an answer
that completely satisfies me</strong>!</p>
<p>See the details in <strong>github:help</strong> 's guide to Dealing with line endings.</p>
<blockquote>
<p>Git allows you to set the line ending properties for a repo directly using
the text attribute in the <strong><code>.gitattributes</code></strong> file. This file is committed
into the repo and overrides the <code>core.autocrlf</code> setting, allowing you to
ensure consistent behaviour for all users regardless of their git settings.</p>
</blockquote>
<p>And thus</p>
<blockquote>
<p>The advantage of this is that your end of line configuration now travels
with your repository and you don't need to worry about whether or not
collaborators have the proper global settings.</p>
</blockquote>
<p>Here's an example of a <strong><code>.gitattributes</code></strong> file</p>
<div class="code"><pre class="code literal-block"># Auto detect text files and perform LF normalization
*        text=auto

*.cs     text diff=csharp
*.java   text diff=java
*.html   text diff=html
*.css    text
*.js     text
*.sql    text

*.csproj text merge=union
*.sln    text merge=union eol=crlf

*.docx   diff=astextplain
*.DOCX   diff=astextplain

# absolute paths are ok, as are globs
/**/postinst* text eol=lf

# paths that don't start with / are treated relative to the .gitattributes folder
relative/path/*.txt text eol=lf
</pre></div>

<p>There is a convenient collection of ready to use .gitattributes files for the
most popular programming languages. It's useful to get you started.</p>
<p>Once you've created or adjusted your <strong><code>.gitattributes</code></strong> , you should perform
a once-and-for-all line endings re-normalization.</p>
<p>Note that the GitHub Desktop app can suggest and create a <strong><code>.gitattributes</code></strong>
file after you open your project's Git repo in the app. To try that, click the
gear icon (in the upper right corner) &gt; Repository settings ... &gt; Line endings
and attributes. You will be asked to add the recommended <strong><code>.gitattributes</code></strong>
and if you agree, the app will also perform a normalization of all the files
in your repository.</p>
<p>Finally, the Mind the End of Your Line article provides more background and
explains how Git has evolved on the matters at hand. I consider this <em>required
reading</em>.</p>
<p>You've probably got users in your team who use EGit or JGit (tools like
Eclipse and TeamCity use them) to commit their changes. Then you're out of
luck, as @gatinueta explained in this answer's comments:</p>
<blockquote>
<p>This setting will not satisfy you completely if you have people working with
Egit or JGit in your team, since those tools will just ignore .gitattributes
and happily check in CRLF files
https://bugs.eclipse.org/bugs/show_bug.cgi?id=342372</p>
</blockquote>
<p>One trick might be to have them commit their changes in another client, say
SourceTree. Our team back then preferred that tool to Eclipse's EGit for many
use cases.</p>
<p>Who said software is easy? :-/</p>
<p><br></p>
<h3>Suggest</h3>
<p>Don't convert line endings. It's not the VCS's job to interpret data -- just
store and version it. Every modern text editor can read both kinds of line
endings anyway.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/difference-between-map-applymap-and-apply-methods-in-pandas/" class="u-url">Difference between map, applymap and apply methods in Pandas</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/difference-between-map-applymap-and-apply-methods-in-pandas/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T19:14:49+08:00" itemprop="datePublished" title="2023-02-17 19:14">2023-02-17 19:14</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Can you tell me when to use these vectorization methods with basic examples?</p>
<p>I see that <code>map</code> is a <code>Series</code> method whereas the rest are <code>DataFrame</code>
methods. I got confused about <code>apply</code> and <code>applymap</code> methods though. Why do we
have two methods for applying a function to a DataFrame? Again, simple
examples which illustrate the usage would be great!</p>
<p><br><br></p>
<h2>Answer</h2>
<h2>Comparing <code>map</code>, <code>applymap</code> and <code>apply</code>: Context Matters</h2>
<p>First major difference: <strong>DEFINITION</strong></p>
<ul>
<li>
<code>map</code> is defined on Series ONLY</li>
<li>
<code>applymap</code> is defined on DataFrames ONLY</li>
<li>
<code>apply</code> is defined on BOTH</li>
</ul>
<p>Second major difference: <strong>INPUT ARGUMENT</strong></p>
<ul>
<li>
<code>map</code> accepts <code>dict</code>s, <code>Series</code>, or callable</li>
<li>
<code>applymap</code> and <code>apply</code> accept callables only</li>
</ul>
<p>Third major difference: <strong>BEHAVIOR</strong></p>
<ul>
<li>
<code>map</code> is elementwise for Series</li>
<li>
<code>applymap</code> is elementwise for DataFrames</li>
<li>
<code>apply</code> also works elementwise but is suited to more complex operations and aggregation. The behaviour and return value depends on the function.</li>
</ul>
<p>Fourth major difference (the most important one): <strong>USE CASE</strong></p>
<ul>
<li>
<code>map</code> is meant for mapping values from one domain to another, so is optimised for performance (e.g., <code>df['A'].map({1:'a', 2:'b', 3:'c'})</code>)</li>
<li>
<code>applymap</code> is good for elementwise transformations across multiple rows/columns (e.g., <code>df[['A', 'B', 'C']].applymap(str.strip)</code>)</li>
<li>
<code>apply</code> is for applying any function that cannot be vectorised (e.g., <code>df['sentences'].apply(nltk.sent_tokenize)</code>).</li>
</ul>
<p>Also see When should I (not) want to use pandas apply() in my code? for a
writeup I made a while back on the most appropriate scenarios for using
<code>apply</code> (note that there aren't many, but there are a few— apply is generally
<em>slow</em> ).</p>
<hr>
<h2>Summarising</h2>
<p><img alt="enter image description here" src="images/IZys3.png"></p>
<blockquote>
<p><strong>Footnotes</strong></p>
<ol>
<li>
<p><code>map</code> when passed a dictionary/Series will map elements based on the
keys in that dictionary/Series. Missing values will be recorded as NaN in
the output.</p>
</li>
<li>
<p><code>applymap</code> in more recent versions has been optimised for some
operations. You will find <code>applymap</code> slightly faster than <code>apply</code> in some
cases. My suggestion is to test them both and use whatever works better.</p>
</li>
<li>
<p><code>map</code> is optimised for elementwise mappings and transformation.
Operations that involve dictionaries or Series will enable pandas to use
faster code paths for better performance.</p>
</li>
<li>
<p><code>Series.apply</code> returns a scalar for aggregating operations, Series
otherwise. Similarly for <code>DataFrame.apply</code>. Note that <code>apply</code> also has
fastpaths when called with certain NumPy functions such as <code>mean</code>, <code>sum</code>,
etc.</p>
</li>
</ol>
</blockquote>
<p><br></p>
<h3>Suggest</h3>
<h2>Comparing <code>map</code>, <code>applymap</code> and <code>apply</code>: Context Matters</h2>
<p>First major difference: <strong>DEFINITION</strong></p>
<ul>
<li>
<code>map</code> is defined on Series ONLY</li>
<li>
<code>applymap</code> is defined on DataFrames ONLY</li>
<li>
<code>apply</code> is defined on BOTH</li>
</ul>
<p>Second major difference: <strong>INPUT ARGUMENT</strong></p>
<ul>
<li>
<code>map</code> accepts <code>dict</code>s, <code>Series</code>, or callable</li>
<li>
<code>applymap</code> and <code>apply</code> accept callables only</li>
</ul>
<p>Third major difference: <strong>BEHAVIOR</strong></p>
<ul>
<li>
<code>map</code> is elementwise for Series</li>
<li>
<code>applymap</code> is elementwise for DataFrames</li>
<li>
<code>apply</code> also works elementwise but is suited to more complex operations and aggregation. The behaviour and return value depends on the function.</li>
</ul>
<p>Fourth major difference (the most important one): <strong>USE CASE</strong></p>
<ul>
<li>
<code>map</code> is meant for mapping values from one domain to another, so is optimised for performance (e.g., <code>df['A'].map({1:'a', 2:'b', 3:'c'})</code>)</li>
<li>
<code>applymap</code> is good for elementwise transformations across multiple rows/columns (e.g., <code>df[['A', 'B', 'C']].applymap(str.strip)</code>)</li>
<li>
<code>apply</code> is for applying any function that cannot be vectorised (e.g., <code>df['sentences'].apply(nltk.sent_tokenize)</code>).</li>
</ul>
<p>Also see When should I (not) want to use pandas apply() in my code? for a
writeup I made a while back on the most appropriate scenarios for using
<code>apply</code> (note that there aren't many, but there are a few— apply is generally
<em>slow</em> ).</p>
<hr>
<h2>Summarising</h2>
<p><img alt="enter image description here" src="images/IZys3.png"></p>
<blockquote>
<p><strong>Footnotes</strong></p>
<ol>
<li>
<p><code>map</code> when passed a dictionary/Series will map elements based on the
keys in that dictionary/Series. Missing values will be recorded as NaN in
the output.</p>
</li>
<li>
<p><code>applymap</code> in more recent versions has been optimised for some
operations. You will find <code>applymap</code> slightly faster than <code>apply</code> in some
cases. My suggestion is to test them both and use whatever works better.</p>
</li>
<li>
<p><code>map</code> is optimised for elementwise mappings and transformation.
Operations that involve dictionaries or Series will enable pandas to use
faster code paths for better performance.</p>
</li>
<li>
<p><code>Series.apply</code> returns a scalar for aggregating operations, Series
otherwise. Similarly for <code>DataFrame.apply</code>. Note that <code>apply</code> also has
fastpaths when called with certain NumPy functions such as <code>mean</code>, <code>sum</code>,
etc.</p>
</li>
</ol>
</blockquote>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/sqlexception-from-entity-framework-new-transaction-is-not-allowed-because-there-are-other-threads-running-in-the-session/" class="u-url">SqlException from Entity Framework - New transaction is not allowed because there are other threads running in the session</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/sqlexception-from-entity-framework-new-transaction-is-not-allowed-because-there-are-other-threads-running-in-the-session/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T19:14:18+08:00" itemprop="datePublished" title="2023-02-17 19:14">2023-02-17 19:14</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I am currently getting this error:</p>
<blockquote>
<p>System.Data.SqlClient.SqlException: New transaction is not allowed because
there are other threads running in the session.</p>
</blockquote>
<p>while running this code:</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">ProductManager</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">IProductManager</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">#region Declare Models</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">RivWorks</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Negotiation</span><span class="o">.</span><span class="n">RIV_Entities</span><span class="w"> </span><span class="n">_dbRiv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RivWorks</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Stores</span><span class="o">.</span><span class="n">RivEntities</span><span class="p">(</span><span class="n">AppSettings</span><span class="o">.</span><span class="n">RivWorkEntities_connString</span><span class="p">);</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">RivWorks</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">NegotiationAutos</span><span class="o">.</span><span class="n">RivFeedsEntities</span><span class="w"> </span><span class="n">_dbFeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RivWorks</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Stores</span><span class="o">.</span><span class="n">FeedEntities</span><span class="p">(</span><span class="n">AppSettings</span><span class="o">.</span><span class="n">FeedAutosEntities_connString</span><span class="p">);</span>
<span class="w">    </span><span class="c1">#endregion</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">IProduct</span><span class="w"> </span><span class="n">GetProductById</span><span class="p">(</span><span class="n">Guid</span><span class="w"> </span><span class="n">productId</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">quick</span><span class="w"> </span><span class="n">sync</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">feeds</span><span class="o">...</span>
<span class="w">        </span><span class="n">SyncFeeds</span><span class="p">();</span>
<span class="w">        </span><span class="o">...</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">product</span><span class="o">...</span>
<span class="w">        </span><span class="o">...</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">product</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">SyncFeeds</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nb nb-Type">bool</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">string</span><span class="w"> </span><span class="n">feedSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"AUTO"</span><span class="p">;</span>
<span class="w">        </span><span class="n">switch</span><span class="w"> </span><span class="p">(</span><span class="n">feedSource</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">companyFeedDetail</span><span class="o">.</span><span class="n">FeedSourceTable</span><span class="o">.</span><span class="n">ToUpper</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">case</span><span class="w"> </span><span class="s2">"AUTO"</span><span class="p">:</span>
<span class="w">                </span><span class="k">var</span><span class="w"> </span><span class="n">clientList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">_dbFeed</span><span class="o">.</span><span class="n">Client</span><span class="o">.</span><span class="n">Include</span><span class="p">(</span><span class="s2">"Auto"</span><span class="p">)</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">                </span><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">RivWorks</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">NegotiationAutos</span><span class="o">.</span><span class="n">Client</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">clientList</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="k">var</span><span class="w"> </span><span class="n">companyFeedDetailList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">_dbRiv</span><span class="o">.</span><span class="n">AutoNegotiationDetails</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">ClientID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">client</span><span class="o">.</span><span class="n">ClientID</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">                    </span><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">RivWorks</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Negotiation</span><span class="o">.</span><span class="n">AutoNegotiationDetails</span><span class="w"> </span><span class="n">companyFeedDetail</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">companyFeedDetailList</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">companyFeedDetail</span><span class="o">.</span><span class="n">FeedSourceTable</span><span class="o">.</span><span class="n">ToUpper</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"AUTO"</span><span class="p">)</span>
<span class="w">                        </span><span class="p">{</span>
<span class="w">                            </span><span class="k">var</span><span class="w"> </span><span class="n">company</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">_dbRiv</span><span class="o">.</span><span class="n">Company</span><span class="o">.</span><span class="n">Include</span><span class="p">(</span><span class="s2">"Product"</span><span class="p">)</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">CompanyId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">companyFeedDetail</span><span class="o">.</span><span class="n">CompanyId</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">First</span><span class="p">();</span>
<span class="w">                            </span><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">RivWorks</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">NegotiationAutos</span><span class="o">.</span><span class="n">Auto</span><span class="w"> </span><span class="n">sourceProduct</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">client</span><span class="o">.</span><span class="n">Auto</span><span class="p">)</span>
<span class="w">                            </span><span class="p">{</span>
<span class="w">                                </span><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">RivWorks</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Negotiation</span><span class="o">.</span><span class="n">Product</span><span class="w"> </span><span class="n">targetProduct</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">company</span><span class="o">.</span><span class="n">Product</span><span class="p">)</span>
<span class="w">                                </span><span class="p">{</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targetProduct</span><span class="o">.</span><span class="n">alternateProductID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sourceProduct</span><span class="o">.</span><span class="n">AutoID</span><span class="p">)</span>
<span class="w">                                    </span><span class="p">{</span>
<span class="w">                                        </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">                                        </span><span class="k">break</span><span class="p">;</span>
<span class="w">                                    </span><span class="p">}</span>
<span class="w">                                </span><span class="p">}</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
<span class="w">                                </span><span class="p">{</span>
<span class="w">                                    </span><span class="k">var</span><span class="w"> </span><span class="n">newProduct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">RivWorks</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">Negotiation</span><span class="o">.</span><span class="n">Product</span><span class="p">();</span>
<span class="w">                                    </span><span class="n">newProduct</span><span class="o">.</span><span class="n">alternateProductID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sourceProduct</span><span class="o">.</span><span class="n">AutoID</span><span class="p">;</span>
<span class="w">                                    </span><span class="n">newProduct</span><span class="o">.</span><span class="n">isFromFeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">                                    </span><span class="n">newProduct</span><span class="o">.</span><span class="n">isDeleted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">                                    </span><span class="n">newProduct</span><span class="o">.</span><span class="n">SKU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sourceProduct</span><span class="o">.</span><span class="n">StockNumber</span><span class="p">;</span>
<span class="w">                                    </span><span class="n">company</span><span class="o">.</span><span class="n">Product</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">newProduct</span><span class="p">);</span>
<span class="w">                                </span><span class="p">}</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                            </span><span class="n">_dbRiv</span><span class="o">.</span><span class="n">SaveChanges</span><span class="p">();</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="c1">### THIS BREAKS ### //</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Model #1 - This model sits in a database on our Dev Server. Model #1
http://content.screencast.com/users/Keith.Barrows/folders/Jing/media/bdb2b000-6e60-4af0-a7a1-2bb6b05d8bc1/Model1.png</p>
<p>Model #2 - This model sits in a database on our Prod Server and is updated
each day by automatic feeds. alt text
http://content.screencast.com/users/Keith.Barrows/folders/Jing/media/4260259f-bce6-43d5-9d2a-017bd9a980d4/Model2.png</p>
<p>Note - The red circled items in Model #1 are the fields I use to "map" to
Model #2. Please ignore the red circles in Model #2: that is from another
question I had which is now answered.</p>
<p>Note: I still need to put in an isDeleted check so I can soft delete it from
DB1 if it has gone out of our client's inventory.</p>
<p>All I want to do, with this particular code, is connect a company in DB1 with
a client in DB2, get their product list from DB2 and INSERT it in DB1 if it is
not already there. First time through should be a full pull of inventory. Each
time it is run there after nothing should happen unless new inventory came in
on the feed over night.</p>
<blockquote>
<p><strong>So the big question - how to I solve the transaction error I am getting?
Do I need to drop and recreate my context each time through the loops (does
not make sense to me)?</strong></p>
</blockquote>
<p><br><br></p>
<h2>Answer</h2>
<p>After much pulling out of hair I discovered that the <code>foreach</code> loops were the
culprits. What needs to happen is to call EF but return it into an <code>IList&lt;T&gt;</code>
of that target type then loop on the <code>IList&lt;T&gt;</code>.</p>
<p>Example:</p>
<div class="code"><pre class="code literal-block"><span class="n">IList</span><span class="o">&lt;</span><span class="n">Client</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clientList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">_dbFeed</span><span class="o">.</span><span class="n">Client</span><span class="o">.</span><span class="n">Include</span><span class="p">(</span><span class="s2">"Auto"</span><span class="p">)</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">RivWorks</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">NegotiationAutos</span><span class="o">.</span><span class="n">Client</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">clientList</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="k">var</span><span class="w"> </span><span class="n">companyFeedDetailList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">_dbRiv</span><span class="o">.</span><span class="n">AutoNegotiationDetails</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">ClientID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">client</span><span class="o">.</span><span class="n">ClientID</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="o">...</span>
<span class="p">}</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>As you've already identified, you cannot save from within a <code>foreach</code> that is
still drawing from the database via an active reader.</p>
<p>Calling <code>ToList()</code> or <code>ToArray()</code> is fine for small data sets, but when you
have thousands of rows, you will be consuming a large amount of memory.</p>
<p>It's better to load the rows in chunks.</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">EntityFrameworkUtil</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">QueryInChunksOf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">this</span><span class="w"> </span><span class="n">IQueryable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queryable</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">chunkSize</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">queryable</span><span class="o">.</span><span class="n">QueryChunksOfSize</span><span class="p">(</span><span class="n">chunkSize</span><span class="p">)</span><span class="o">.</span><span class="n">SelectMany</span><span class="p">(</span><span class="n">chunk</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">chunk</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">T</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">QueryChunksOfSize</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">this</span><span class="w"> </span><span class="n">IQueryable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queryable</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">chunkSize</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">chunkNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="bp">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">chunkNumber</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                </span><span class="err">?</span><span class="w"> </span><span class="n">queryable</span><span class="w"> </span>
<span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="n">queryable</span><span class="o">.</span><span class="n">Skip</span><span class="p">(</span><span class="n">chunkNumber</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">chunkSize</span><span class="p">);</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">query</span><span class="o">.</span><span class="n">Take</span><span class="p">(</span><span class="n">chunkSize</span><span class="p">)</span><span class="o">.</span><span class="n">ToArray</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">Length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                </span><span class="nb">yield</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="nb">yield</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">chunk</span><span class="p">;</span>
<span class="w">            </span><span class="n">chunkNumber</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Given the above extension methods, you can write your query like this:</p>
<div class="code"><pre class="code literal-block"><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">clientList</span><span class="o">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span><span class="o">.</span><span class="n">QueryInChunksOf</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">stuff</span>
<span class="w">    </span><span class="n">context</span><span class="o">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p><strong>The queryable object you call this method on must be ordered.</strong> This is
because Entity Framework only supports <code>IQueryable&lt;T&gt;.Skip(int)</code> on ordered
queries, which makes sense when you consider that multiple queries for
different ranges require the ordering to be stable. If the ordering isn't
important to you, just order by primary key as that's likely to have a
clustered index.</p>
<p>This version will query the database in batches of 100. Note that
<code>SaveChanges()</code> is called for each entity.</p>
<p>If you want to improve your throughput dramatically, you should call
<code>SaveChanges()</code> less frequently. Use code like this instead:</p>
<div class="code"><pre class="code literal-block"><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">clientList</span><span class="o">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span><span class="o">.</span><span class="n">QueryChunksOfSize</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">chunk</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">stuff</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">context</span><span class="o">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>This results in 100 times fewer database update calls. Of course each of those
calls takes longer to complete, but you still come out way ahead in the end.
Your mileage may vary, but this was worlds faster for me.</p>
<p>And it gets around the exception you were seeing.</p>
<p><strong>EDIT</strong> I revisited this question after running SQL Profiler and updated a
few things to improve performance. For anyone who is interested, here is some
sample SQL that shows what is created by the DB.</p>
<p>The first loop doesn't need to skip anything, so is simpler.</p>
<div class="code"><pre class="code literal-block"><span class="k">SELECT</span><span class="w"> </span><span class="k">TOP</span><span class="w"> </span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w">                     </span><span class="o">--</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="k">size</span><span class="w"> </span>
<span class="o">[</span><span class="n">Extent1</span><span class="o">]</span><span class="p">.</span><span class="o">[</span><span class="n">Id</span><span class="o">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">[</span><span class="n">Id</span><span class="o">]</span><span class="p">,</span><span class="w"> </span>
<span class="o">[</span><span class="n">Extent1</span><span class="o">]</span><span class="p">.</span><span class="o">[</span><span class="n">Name</span><span class="o">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">[</span><span class="n">Name</span><span class="o">]</span><span class="p">,</span><span class="w"> </span>
<span class="k">FROM</span><span class="w"> </span><span class="o">[</span><span class="n">dbo</span><span class="o">]</span><span class="p">.</span><span class="o">[</span><span class="n">Clients</span><span class="o">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">[</span><span class="n">Extent1</span><span class="o">]</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">[</span><span class="n">Extent1</span><span class="o">]</span><span class="p">.</span><span class="o">[</span><span class="n">Id</span><span class="o">]</span><span class="w"> </span><span class="k">ASC</span>
</pre></div>

<p>Subsequent calls need to skip previous chunks of results, so introduces usage
of <code>row_number</code>:</p>
<div class="code"><pre class="code literal-block"><span class="k">SELECT</span><span class="w"> </span><span class="k">TOP</span><span class="w"> </span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w">                     </span><span class="o">--</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="k">size</span>
<span class="o">[</span><span class="n">Extent1</span><span class="o">]</span><span class="p">.</span><span class="o">[</span><span class="n">Id</span><span class="o">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">[</span><span class="n">Id</span><span class="o">]</span><span class="p">,</span><span class="w"> </span>
<span class="o">[</span><span class="n">Extent1</span><span class="o">]</span><span class="p">.</span><span class="o">[</span><span class="n">Name</span><span class="o">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">[</span><span class="n">Name</span><span class="o">]</span><span class="p">,</span><span class="w"> </span>
<span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="o">[</span><span class="n">Extent1</span><span class="o">]</span><span class="p">.</span><span class="o">[</span><span class="n">Id</span><span class="o">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">[</span><span class="n">Id</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">Extent1</span><span class="o">]</span><span class="p">.</span><span class="o">[</span><span class="n">Name</span><span class="o">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">[</span><span class="n">Name</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="nf">row_number</span><span class="p">()</span>
<span class="w">    </span><span class="k">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">[</span><span class="n">Extent1</span><span class="o">]</span><span class="p">.</span><span class="o">[</span><span class="n">Id</span><span class="o">]</span><span class="w"> </span><span class="k">ASC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">[</span><span class="n">row_number</span><span class="o">]</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="o">[</span><span class="n">dbo</span><span class="o">]</span><span class="p">.</span><span class="o">[</span><span class="n">Clients</span><span class="o">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">[</span><span class="n">Extent1</span><span class="o">]</span>
<span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">[</span><span class="n">Extent1</span><span class="o">]</span>
<span class="k">WHERE</span><span class="w"> </span><span class="o">[</span><span class="n">Extent1</span><span class="o">]</span><span class="p">.</span><span class="o">[</span><span class="n">row_number</span><span class="o">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="w">   </span><span class="o">--</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">skip</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">[</span><span class="n">Extent1</span><span class="o">]</span><span class="p">.</span><span class="o">[</span><span class="n">Id</span><span class="o">]</span><span class="w"> </span><span class="k">ASC</span>
</pre></div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-910.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-908.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
