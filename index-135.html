<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 135) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-135.html">
<link rel="prev" href="index-136.html" type="text/html">
<link rel="next" href="index-134.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/ru-he-shi-yong-java-net-urlconnection-hong-fa-he-chu-li-http-qing-qiu/" class="u-url">如何使用 java.net.URLConnection 触发和处理 HTTP 请求</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/ru-he-shi-yong-java-net-urlconnection-hong-fa-he-chu-li-http-qing-qiu/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T22:39:18+08:00" itemprop="datePublished" title="2023-02-16 22:39">2023-02-16 22:39</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>使用 of<code>java.net.URLConnection</code>在这里经常被问到，而且Oracle 教程对此过于 <em>简洁。</em></p>
<p>该教程基本上只展示了如何触发GET请求和读取响应。它没有在任何地方解释如何使用它来执行POST请求、设置请求标头、读取响应标头、处理 cookie、提交
HTML 表单、上传文件等。</p>
<p>那么，我如何使用它<code>java.net.URLConnection</code>来触发和处理“高级”HTTP 请求呢？</p>
<p><br><br></p>
<h2>解答</h2>
<p><em>首先事先声明：发布的代码片段都是基本示例。 您需要处理琐碎的<code>IOException</code>s 和<code>RuntimeException</code>s
之类的事情<code>NullPointerException</code>，<code>ArrayIndexOutOfBoundsException</code>并与自己相处。</em></p>
<p><em>如果您正在为 Android 而不是 Java 进行开发，还请注意，自从引入 API 级别 28 以来， 默认情况下禁用明文 HTTP
请求。我们鼓励您使用<code>HttpsURLConnection</code>，但如果确实有必要，可以在应用程序清单中启用明文。</em></p>
<hr>
<h4>准备中</h4>
<p>我们首先需要至少知道 URL 和字符集。参数是可选的，取决于功能要求。</p>
<div class="code"><pre class="code literal-block"><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"http://example.com"</span><span class="p">;</span>
<span class="nb nb-Type">String</span><span class="w"> </span><span class="n">charset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UTF-8"</span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Or</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Java</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">later</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">constant</span><span class="p">:</span><span class="w"> </span><span class="n">java</span><span class="o">.</span><span class="n">nio</span><span class="o">.</span><span class="n">charset</span><span class="o">.</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="n">UTF_8</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
<span class="nb nb-Type">String</span><span class="w"> </span><span class="n">param1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"value1"</span><span class="p">;</span>
<span class="nb nb-Type">String</span><span class="w"> </span><span class="n">param2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"value2"</span><span class="p">;</span>
<span class="o">//</span><span class="w"> </span><span class="o">...</span>

<span class="nb nb-Type">String</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"param1=</span><span class="si">%s</span><span class="s2">&amp;param2=</span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span>
<span class="w">    </span><span class="n">URLEncoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">param1</span><span class="p">,</span><span class="w"> </span><span class="n">charset</span><span class="p">),</span>
<span class="w">    </span><span class="n">URLEncoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">param2</span><span class="p">,</span><span class="w"> </span><span class="n">charset</span><span class="p">));</span>
</pre></div>

<p>查询参数必须采用<code>name=value</code>格式并由<code>&amp;</code>. 您通常还会使用指定的字符集对查询参数进行 URL 编码<code>URLEncoder#encode()</code>。</p>
<p>只是<code>String#format()</code>为了方便。当我需要<code>+</code>两次以上的字符串连接运算符时，我更喜欢它。</p>
<hr>
<h4>使用（可选）查询参数触发HTTP GET请求</h4>
<p>这是一项微不足道的任务。这是默认的请求方法。</p>
<div class="code"><pre class="code literal-block">URLConnection connection = new URL(url + "?" + query).openConnection();
connection.setRequestProperty("Accept-Charset", charset);
InputStream response = connection.getInputStream();
// ...
</pre></div>

<p>任何查询字符串都应该使用<code>?</code>. 标<code>Accept-
Charset</code>头可能会提示服务器参数的编码方式。如果您不发送任何查询字符串，则可以离开标头<code>Accept-
Charset</code>。如果您不需要设置任何标题，那么您甚至可以使用<code>URL#openStream()</code>快捷方式。</p>
<div class="code"><pre class="code literal-block">InputStream response = new URL(url).openStream();
// ...
</pre></div>

<p>无论哪种方式，如果另一方是<code>HttpServlet</code>，则将<code>doGet()</code>调用其方法并且参数将由<code>HttpServletRequest#getParameter()</code>.</p>
<p>出于测试目的，您可以将响应正文打印到标准输出，如下所示：</p>
<div class="code"><pre class="code literal-block"><span class="nv">try</span><span class="w"> </span><span class="ss">(</span><span class="nv">Scanner</span><span class="w"> </span><span class="nv">scanner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">Scanner</span><span class="ss">(</span><span class="nv">response</span><span class="ss">))</span><span class="w"> </span>{
<span class="w">    </span><span class="nv">String</span><span class="w"> </span><span class="nv">responseBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">scanner</span>.<span class="nv">useDelimiter</span><span class="ss">(</span><span class="s2">"\\A"</span><span class="ss">)</span>.<span class="k">next</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">System</span>.<span class="nv">out</span>.<span class="nv">println</span><span class="ss">(</span><span class="nv">responseBody</span><span class="ss">)</span><span class="c1">;</span>
}
</pre></div>

<hr>
<h4>使用查询参数触发HTTP POST请求</h4>
<p>将 设置<code>URLConnection#setDoOutput()</code>为<code>true</code>隐式将请求方法设置为 POST。Web 表单所做的标准 HTTP POST
属于将<code>application/x-www-form-urlencoded</code>查询字符串写入请求正文的类型。</p>
<div class="code"><pre class="code literal-block">URLConnection connection = new URL(url).openConnection();
connection.setDoOutput(true); // Triggers POST.
connection.setRequestProperty("Accept-Charset", charset);
connection.setRequestProperty("Content-Type", "application/x-www-form-urlencoded;charset=" + charset);

try (OutputStream output = connection.getOutputStream()) {
    output.write(query.getBytes(charset));
}

InputStream response = connection.getInputStream();
// ...
</pre></div>

<p>注意：每当你想以编程方式提交 HTML 表单时，不要忘记将<code>name=value</code>任何<code>&lt;input
type="hidden"&gt;</code>元素对放入查询字符串中，当然还有你想以编程方式“按下”<code>name=value</code>的元素对（因为<code>&lt;input
type="submit"&gt;</code>通常在服务器端使用它来区分按钮是否被按下，如果是，是哪个按钮）。</p>
<p>您也可以将获得的转换<code>URLConnection</code>为<code>HttpURLConnection</code>并使用它<code>HttpURLConnection#setRequestMethod()</code>来代替。但是，如果您尝试使用连接进行输出，您仍然需要设置<code>URLConnection#setDoOutput()</code>为<code>true</code>.</p>
<div class="code"><pre class="code literal-block">HttpURLConnection httpConnection = (HttpURLConnection) new URL(url).openConnection();
httpConnection.setRequestMethod("POST");
// ...
</pre></div>

<p>无论哪种方式，如果另一方是<code>HttpServlet</code>，则将<code>doPost()</code>调用其方法并且参数将由<code>HttpServletRequest#getParameter()</code>.</p>
<hr>
<h4>实际触发 HTTP 请求</h4>
<p>您可以使用 显式触发 HTTP 请求，但是当您想要获取有关 HTTP
响应的任何信息（例如响应正文使用等）<code>URLConnection#connect()</code>时，请求将按需自动触发。<code>URLConnection#getInputStream()</code>上面的例子正是这样做的，所以这个<code>connect()</code>调用实际上是多余的。</p>
<hr>
<h4>收集 HTTP 响应信息</h4>
<ol>
<li>HTTP 响应状态：</li>
</ol>
<p>你需要一个<code>HttpURLConnection</code>这里。如有必要，请先施放它。</p>
<div class="code"><pre class="code literal-block">    int status = httpConnection.getResponseCode();
</pre></div>

<ol>
<li>
<p>HTTP 响应标头：</p>
<div class="code"><pre class="code literal-block"><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">Entry</span><span class="o">&lt;</span><span class="nv">String</span>,<span class="w"> </span><span class="nv">List</span><span class="o">&lt;</span><span class="nv">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nv">header</span><span class="w"> </span>:<span class="w"> </span><span class="nv">connection</span>.<span class="nv">getHeaderFields</span><span class="ss">()</span>.<span class="nv">entrySet</span><span class="ss">())</span><span class="w"> </span>{
<span class="w"> </span><span class="nv">System</span>.<span class="nv">out</span>.<span class="nv">println</span><span class="ss">(</span><span class="nv">header</span>.<span class="nv">getKey</span><span class="ss">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"="</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">header</span>.<span class="nv">getValue</span><span class="ss">())</span><span class="c1">;</span>
</pre></div>

<p>}</p>
</li>
<li>
<p>HTTP 响应编码：</p>
</li>
</ol>
<p>当<code>Content-Type</code>包含<code>charset</code>参数时，响应主体可能是基于文本的，然后我们希望使用服务器端指定的字符编码来处理响应主体。</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="nv">String</span><span class="w"> </span><span class="nv">contentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">connection</span>.<span class="nv">getHeaderField</span><span class="ss">(</span><span class="s2">"Content-Type"</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">String</span><span class="w"> </span><span class="nv">charset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">null</span><span class="c1">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">String</span><span class="w"> </span><span class="nv">param</span><span class="w"> </span>:<span class="w"> </span><span class="nv">contentType</span>.<span class="nv">replace</span><span class="ss">(</span><span class="s2">" "</span>,<span class="w"> </span><span class="s2">""</span><span class="ss">)</span>.<span class="nv">split</span><span class="ss">(</span><span class="s2">";"</span><span class="ss">))</span><span class="w"> </span>{
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">param</span>.<span class="nv">startsWith</span><span class="ss">(</span><span class="s2">"charset="</span><span class="ss">))</span><span class="w"> </span>{
<span class="w">            </span><span class="nv">charset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">param</span>.<span class="nv">split</span><span class="ss">(</span><span class="s2">"="</span>,<span class="w"> </span><span class="mi">2</span><span class="ss">)</span>[<span class="mi">1</span>]<span class="c1">;</span>
<span class="w">            </span><span class="k">break</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">    </span>}

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">charset</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">        </span><span class="nv">try</span><span class="w"> </span><span class="ss">(</span><span class="nv">BufferedReader</span><span class="w"> </span><span class="nv">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">BufferedReader</span><span class="ss">(</span><span class="nv">new</span><span class="w"> </span><span class="nv">InputStreamReader</span><span class="ss">(</span><span class="nv">response</span>,<span class="w"> </span><span class="nv">charset</span><span class="ss">)))</span><span class="w"> </span>{
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">String</span><span class="w"> </span><span class="nv">line</span><span class="c1">; (line = reader.readLine()) != null;) {</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span>...<span class="w"> </span><span class="nv">System</span>.<span class="nv">out</span>.<span class="nv">println</span><span class="ss">(</span><span class="nv">line</span><span class="ss">)</span>?
<span class="w">            </span>}
<span class="w">        </span>}
<span class="w">    </span>}<span class="w"> </span><span class="k">else</span><span class="w"> </span>{
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nv">It</span><span class="err">'s likely binary content, use InputStream/OutputStream.</span>
<span class="err">    }</span>
</pre></div>

<hr>
<h4>维护会话</h4>
<p>服务器端会话通常由 cookie 支持。某些 Web 表单要求您登录和/或被会话跟踪。您可以使用<code>CookieHandler</code>API 来维护
cookie。在发送所有 HTTP 请求之前，您需要准备一个<code>CookieManager</code>和<code>CookiePolicy</code>一个<code>ACCEPT_ALL</code>。</p>
<div class="code"><pre class="code literal-block"><span class="c1">// First set the default cookie manager.</span>
<span class="n">CookieHandler</span><span class="p">.</span><span class="n">setDefault</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">CookieManager</span><span class="p">(</span><span class="nb">null</span><span class="p">,</span><span class="w"> </span><span class="n">CookiePolicy</span><span class="p">.</span><span class="n">ACCEPT_ALL</span><span class="p">));</span>

<span class="c1">// All the following subsequent URLConnections will use the same cookie manager.</span>
<span class="n">URLConnection</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">openConnection</span><span class="p">();</span>
<span class="c1">// ...</span>

<span class="n">connection</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">openConnection</span><span class="p">();</span>
<span class="c1">// ...</span>

<span class="n">connection</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">openConnection</span><span class="p">();</span>
<span class="c1">// ...</span>
</pre></div>

<p>请注意，众所周知，这并不总是在所有情况下都能正常工作。如果它对您来说失败了，那么最好是手动收集和设置 cookie 标头。您基本上需要<code>Set-
Cookie</code>从登录响应或第一个<code>GET</code>请求中获取所有标头，然后将其传递给后续请求。</p>
<div class="code"><pre class="code literal-block"><span class="c1">// Gather all cookies on the first request.</span>
<span class="n">URLConnection</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">openConnection</span><span class="p">();</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cookies</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">connection</span><span class="p">.</span><span class="n">getHeaderFields</span><span class="p">().</span><span class="k">get</span><span class="p">(</span><span class="s">"Set-Cookie"</span><span class="p">);</span>
<span class="c1">// ...</span>

<span class="c1">// Then use the same cookies on all subsequent requests.</span>
<span class="n">connection</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">openConnection</span><span class="p">();</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cookies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">connection</span><span class="p">.</span><span class="n">addRequestProperty</span><span class="p">(</span><span class="s">"Cookie"</span><span class="p">,</span><span class="w"> </span><span class="n">cookie</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">";"</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>
<span class="c1">// ...</span>
</pre></div>

<p>那里<code>split(";", 2)[0]</code>是为了摆脱与服务器端无关的 cookie
属性，例如<code>expires</code>、<code>path</code>等。或者，您也可以使用<code>cookie.substring(0,
cookie.indexOf(';'))</code>instead of <code>split()</code>。</p>
<hr>
<h4>串流模式</h4>
<p><code>HttpURLConnection</code>默认情况下，将在实际发送之前缓冲整个 <em>请求</em>
主体，无论您是否使用<code>connection.setRequestProperty("Content-Length", contentLength);</code>.
<code>OutOfMemoryException</code>每当您并发发送大型 POST
请求（例如上传文件）时，这可能会导致s。为避免这种情况，您需要设置<code>HttpURLConnection#setFixedLengthStreamingMode()</code>.</p>
<div class="code"><pre class="code literal-block">httpConnection.setFixedLengthStreamingMode(contentLength);
</pre></div>

<p>但是如果事先确实不知道内容长度，那么您可以通过相应地设置来使用分块流模式<code>HttpURLConnection#setChunkedStreamingMode()</code>。这将设置
HTTP<code>Transfer-Encoding</code>标头<code>chunked</code>，强制请求正文以块的形式发送。下面的示例将以 1 KB 的块发送正文。</p>
<div class="code"><pre class="code literal-block">httpConnection.setChunkedStreamingMode(1024);
</pre></div>

<hr>
<h4>用户代理</h4>
<p>It can happen that a request returns an unexpected response, while it works
fine with a real web browser. The server side is probably blocking requests
based on the <code>User-Agent</code> request header. The <code>URLConnection</code> will by default
set it to <code>Java/1.6.0_19</code> where the last part is obviously the JRE version.
You can override this as follows:</p>
<div class="code"><pre class="code literal-block"><span class="nv">connection</span>.<span class="nv">setRequestProperty</span><span class="ss">(</span><span class="s2">"User-Agent"</span>,<span class="w"> </span><span class="s2">"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.36"</span><span class="ss">)</span><span class="c1">; // Do as if you're using Chrome 41 on Windows 7.</span>
</pre></div>

<p>Use the User-Agent string from a recent browser.</p>
<hr>
<h4>Error handling</h4>
<p>If the HTTP response code is <code>4nn</code> (Client Error) or <code>5nn</code> (Server Error),
then you may want to read the <code>HttpURLConnection#getErrorStream()</code> to see if
the server has sent any useful error information.</p>
<div class="code"><pre class="code literal-block">InputStream error = ((HttpURLConnection) connection).getErrorStream();
</pre></div>

<p>If the HTTP response code is -1, then something went wrong with connection and
response handling. The <code>HttpURLConnection</code> implementation is in older JREs
somewhat buggy with keeping connections alive. You may want to turn it off by
setting the <code>http.keepAlive</code> system property to <code>false</code>. You can do this
programmatically in the beginning of your application by:</p>
<div class="code"><pre class="code literal-block">System.setProperty("http.keepAlive", "false");
</pre></div>

<hr>
<h4>Uploading files</h4>
<p>You'd normally use <code>multipart/form-data</code> encoding for mixed POST content
(binary and character data). The encoding is in more detail described in
RFC2388.</p>
<div class="code"><pre class="code literal-block"><span class="nt">String</span><span class="w"> </span><span class="nt">param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"value"</span><span class="o">;</span>
<span class="nt">File</span><span class="w"> </span><span class="nt">textFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">File</span><span class="o">(</span><span class="s2">"/path/to/file.txt"</span><span class="o">);</span>
<span class="nt">File</span><span class="w"> </span><span class="nt">binaryFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">File</span><span class="o">(</span><span class="s2">"/path/to/file.bin"</span><span class="o">);</span>
<span class="nt">String</span><span class="w"> </span><span class="nt">boundary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">Long</span><span class="p">.</span><span class="nc">toHexString</span><span class="o">(</span><span class="nt">System</span><span class="p">.</span><span class="nc">currentTimeMillis</span><span class="o">());</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nt">Just</span><span class="w"> </span><span class="nt">generate</span><span class="w"> </span><span class="nt">some</span><span class="w"> </span><span class="nt">unique</span><span class="w"> </span><span class="nt">random</span><span class="w"> </span><span class="nt">value</span><span class="o">.</span>
<span class="nt">String</span><span class="w"> </span><span class="nt">CRLF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"\r\n"</span><span class="o">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nt">Line</span><span class="w"> </span><span class="nt">separator</span><span class="w"> </span><span class="nt">required</span><span class="w"> </span><span class="nt">by</span><span class="w"> </span><span class="nt">multipart</span><span class="o">/</span><span class="nt">form-data</span><span class="o">.</span>
<span class="nt">URLConnection</span><span class="w"> </span><span class="nt">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">URL</span><span class="o">(</span><span class="nt">url</span><span class="o">)</span><span class="p">.</span><span class="nc">openConnection</span><span class="o">();</span>
<span class="nt">connection</span><span class="p">.</span><span class="nc">setDoOutput</span><span class="o">(</span><span class="nt">true</span><span class="o">);</span>
<span class="nt">connection</span><span class="p">.</span><span class="nc">setRequestProperty</span><span class="o">(</span><span class="s2">"Content-Type"</span><span class="o">,</span><span class="w"> </span><span class="s2">"multipart/form-data; boundary="</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nt">boundary</span><span class="o">);</span>

<span class="nt">try</span><span class="w"> </span><span class="o">(</span>
<span class="w">    </span><span class="nt">OutputStream</span><span class="w"> </span><span class="nt">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">connection</span><span class="p">.</span><span class="nc">getOutputStream</span><span class="o">();</span>
<span class="w">    </span><span class="nt">PrintWriter</span><span class="w"> </span><span class="nt">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">PrintWriter</span><span class="o">(</span><span class="nt">new</span><span class="w"> </span><span class="nt">OutputStreamWriter</span><span class="o">(</span><span class="nt">output</span><span class="o">,</span><span class="w"> </span><span class="nt">charset</span><span class="o">),</span><span class="w"> </span><span class="nt">true</span><span class="o">);</span>
<span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">Send</span><span class="w"> </span><span class="err">normal</span><span class="w"> </span><span class="err">param.</span>
<span class="w">    </span><span class="err">writer.append("--"</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">boundary).append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append("</span><span class="n">Content-Disposition</span><span class="p">:</span><span class="w"> </span><span class="n">form-data</span><span class="p">;</span><span class="w"> </span><span class="err">name=\"param\"").append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append("</span><span class="n">Content-Type</span><span class="p">:</span><span class="w"> </span><span class="kc">text</span><span class="o">/</span><span class="n">plain</span><span class="p">;</span><span class="w"> </span><span class="err">charset="</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">charset).append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append(CRLF).append(param).append(CRLF).flush()</span><span class="p">;</span>

<span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">Send</span><span class="w"> </span><span class="err">text</span><span class="w"> </span><span class="err">file.</span>
<span class="w">    </span><span class="err">writer.append("--"</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">boundary).append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append("</span><span class="n">Content-Disposition</span><span class="p">:</span><span class="w"> </span><span class="n">form-data</span><span class="p">;</span><span class="w"> </span><span class="err">name=\"textFile\"</span><span class="p">;</span><span class="w"> </span><span class="err">filename=\""</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">textFile.getName()</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">"\"").append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append("</span><span class="n">Content-Type</span><span class="p">:</span><span class="w"> </span><span class="kc">text</span><span class="o">/</span><span class="n">plain</span><span class="p">;</span><span class="w"> </span><span class="err">charset="</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">charset).append(CRLF)</span><span class="p">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">Text</span><span class="w"> </span><span class="err">file</span><span class="w"> </span><span class="err">itself</span><span class="w"> </span><span class="err">must</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">saved</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">charset!</span>
<span class="w">    </span><span class="err">writer.append(CRLF).flush()</span><span class="p">;</span>
<span class="w">    </span><span class="err">Files.copy(textFile.toPath(),</span><span class="w"> </span><span class="err">output)</span><span class="p">;</span>
<span class="w">    </span><span class="err">output.flush()</span><span class="p">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">Important</span><span class="w"> </span><span class="err">before</span><span class="w"> </span><span class="err">continuing</span><span class="w"> </span><span class="err">with</span><span class="w"> </span><span class="err">writer!</span>
<span class="w">    </span><span class="err">writer.append(CRLF).flush()</span><span class="p">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">CRLF</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">important!</span><span class="w"> </span><span class="err">It</span><span class="w"> </span><span class="err">indicates</span><span class="w"> </span><span class="err">end</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">boundary.</span>

<span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">Send</span><span class="w"> </span><span class="err">binary</span><span class="w"> </span><span class="err">file.</span>
<span class="w">    </span><span class="err">writer.append("--"</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">boundary).append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append("</span><span class="n">Content-Disposition</span><span class="p">:</span><span class="w"> </span><span class="n">form-data</span><span class="p">;</span><span class="w"> </span><span class="err">name=\"binaryFile\"</span><span class="p">;</span><span class="w"> </span><span class="err">filename=\""</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">binaryFile.getName()</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">"\"").append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append("</span><span class="n">Content-Type</span><span class="p">:</span><span class="w"> </span><span class="s2">" + URLConnection.guessContentTypeFromName(binaryFile.getName())).append(CRLF);</span>
<span class="s2">    writer.append("</span><span class="n">Content-Transfer-Encoding</span><span class="o">:</span><span class="w"> </span><span class="n">binary</span><span class="s2">").append(CRLF);</span>
<span class="s2">    writer.append(CRLF).flush();</span>
<span class="s2">    Files.copy(binaryFile.toPath(), output);</span>
<span class="s2">    output.flush(); // Important before continuing with writer!</span>
<span class="s2">    writer.append(CRLF).flush(); // CRLF is important! It indicates end of boundary.</span>

<span class="s2">    // End of multipart/form-data.</span>
<span class="s2">    writer.append("</span><span class="o">--</span><span class="s2">" + boundary + "</span><span class="o">--</span><span class="err">"</span><span class="p">)</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">CRLF</span><span class="p">)</span><span class="o">.</span><span class="nf">flush</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>If the other side is an <code>HttpServlet</code>, then its <code>doPost()</code> method will be
called and the parts will be available by <code>HttpServletRequest#getPart()</code>
(note, thus <strong>not</strong> <code>getParameter()</code> and so on!). The <code>getPart()</code> method is
however relatively new, it's introduced in Servlet 3.0 (Glassfish 3, Tomcat 7,
etc.). Prior to Servlet 3.0, your best choice is using Apache Commons
FileUpload to parse a <code>multipart/form-data</code> request. Also see this answer for
examples of both the FileUpload and the Servelt 3.0 approaches.</p>
<hr>
<h4>Dealing with untrusted or misconfigured HTTPS sites</h4>
<p><em>In case you're developing for Android instead of Java, <strong>be careful</strong> : the
workaround below may save your day if you don't have correct certificates
deployed during development. But you should not use it for production. These
days (April 2021) Google will not allow your app be distributed on Play Store
if they detect insecure hostname verifier, see
https://support.google.com/faqs/answer/7188426.</em></p>
<p>Sometimes you need to connect an HTTPS URL, perhaps because you're writing a
web scraper. In that case, you may likely face a <code>javax.net.ssl.SSLException:
Not trusted server certificate</code> on some HTTPS sites who doesn't keep their SSL
certificates up to date, or a <code>java.security.cert.CertificateException: No
subject alternative DNS name matching [hostname] found</code> or
<code>javax.net.ssl.SSLProtocolException: handshake alert: unrecognized_name</code> on
some misconfigured HTTPS sites.</p>
<p>The following one-time-run <code>static</code> initializer in your web scraper class
should make <code>HttpsURLConnection</code> more lenient as to those HTTPS sites and thus
not throw those exceptions anymore.</p>
<div class="code"><pre class="code literal-block"><span class="k">static</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">TrustManager</span><span class="err">[]</span><span class="w"> </span><span class="n">trustAllCertificates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TrustManager</span><span class="err">[]</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">X509TrustManager</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="nv">@Override</span>
<span class="w">            </span><span class="k">public</span><span class="w"> </span><span class="n">X509Certificate</span><span class="err">[]</span><span class="w"> </span><span class="n">getAcceptedIssuers</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="k">null</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="ow">Not</span><span class="w"> </span><span class="n">relevant</span><span class="p">.</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">            </span><span class="nv">@Override</span>
<span class="w">            </span><span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">checkClientTrusted</span><span class="p">(</span><span class="n">X509Certificate</span><span class="err">[]</span><span class="w"> </span><span class="n">certs</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">authType</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="n">nothing</span><span class="p">.</span><span class="w"> </span><span class="n">Just</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="ow">all</span><span class="p">.</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">            </span><span class="nv">@Override</span>
<span class="w">            </span><span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">checkServerTrusted</span><span class="p">(</span><span class="n">X509Certificate</span><span class="err">[]</span><span class="w"> </span><span class="n">certs</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">authType</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="n">nothing</span><span class="p">.</span><span class="w"> </span><span class="n">Just</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="ow">all</span><span class="p">.</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span><span class="p">;</span>

<span class="w">    </span><span class="n">HostnameVerifier</span><span class="w"> </span><span class="n">trustAllHostnames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HostnameVerifier</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="nv">@Override</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">boolean</span><span class="w"> </span><span class="n">verify</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">hostname</span><span class="p">,</span><span class="w"> </span><span class="n">SSLSession</span><span class="w"> </span><span class="k">session</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Just</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="ow">all</span><span class="p">.</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span><span class="p">;</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">System</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="ss">"jsse.enableSNIExtension"</span><span class="p">,</span><span class="w"> </span><span class="ss">"false"</span><span class="p">);</span>
<span class="w">        </span><span class="n">SSLContext</span><span class="w"> </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSLContext</span><span class="p">.</span><span class="n">getInstance</span><span class="p">(</span><span class="ss">"SSL"</span><span class="p">);</span>
<span class="w">        </span><span class="n">sc</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="n">trustAllCertificates</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecureRandom</span><span class="p">());</span>
<span class="w">        </span><span class="n">HttpsURLConnection</span><span class="p">.</span><span class="n">setDefaultSSLSocketFactory</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">getSocketFactory</span><span class="p">());</span>
<span class="w">        </span><span class="n">HttpsURLConnection</span><span class="p">.</span><span class="n">setDefaultHostnameVerifier</span><span class="p">(</span><span class="n">trustAllHostnames</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">GeneralSecurityException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ExceptionInInitializerError</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<hr>
<h4>Last words</h4>
<p>The Apache HttpComponents HttpClient is <em>much</em> more convenient in this all :)</p>
<ul>
<li>HttpClient Tutorial</li>
<li>HttpClient Examples</li>
</ul>
<hr>
<h4>Parsing and extracting HTML</h4>
<p>If all you want is parsing and extracting data from HTML, then better use a
HTML parser like Jsoup.</p>
<ul>
<li>What are the pros/cons of leading HTML parsers in Java</li>
<li>How to scan and extract a webpage in Java</li>
</ul>
<p><br></p>
<h3>更多建议</h3>
<p>当使用 HTTP
时，引用它几乎总是<code>HttpURLConnection</code>比引用基类更有用<code>URLConnection</code>（因为<code>URLConnection</code>当您在 HTTP
URL 上请求时它是一个抽象类<code>URLConnection.openConnection()</code>，无论如何您都会得到）。</p>
<p>然后，您可以不依赖于<code>URLConnection#setDoOutput(true)</code>将请求方法隐式设置为 <em>POST</em>
，而是执行<code>httpURLConnection.setRequestMethod("POST")</code>某些人可能会觉得更自然的方法（并且还允许您指定其他请求方法，例如
<em>PUT</em> 、 <em>DELETE</em> ……）。</p>
<p>它还提供了有用的 HTTP 常量，因此您可以：</p>
<div class="code"><pre class="code literal-block"><span class="nv">int</span><span class="w"> </span><span class="nv">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">httpURLConnection</span>.<span class="nv">getResponseCode</span><span class="ss">()</span><span class="c1">;</span>

<span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">responseCode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">HttpURLConnection</span>.<span class="nv">HTTP_OK</span><span class="ss">)</span><span class="w"> </span>{
</pre></div>

<p><br><br><a href="posts/how-to-use-java-net-urlconnection-to-fire-and-handle-http-requests/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/fang-fa-he-han-shu-you-shi-yao-qu-bie/" class="u-url">方法和函数有什么区别？</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/fang-fa-he-han-shu-you-shi-yao-qu-bie/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T22:38:33+08:00" itemprop="datePublished" title="2023-02-16 22:38">2023-02-16 22:38</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>有人可以提供OOP 上下文中 <strong>方法</strong> 与 <strong>函数</strong> 的简单解释吗？</p>
<p><br><br></p>
<h2>解答</h2>
<p>函数是一段按名称调用的代码 <strong>。</strong> 它可以传递数据进行操作（即参数），也可以选择返回数据（返回值）。传递给函数的所有数据都是显式传递的。</p>
<p>方法是由与对象关联 <strong>的</strong> 名称调用的一段代码。在大多数方面，它与函数相同，除了两个主要区别：</p>
<ol>
<li>方法被隐式传递给调用它的对象。</li>
<li>方法能够对类中包含的数据进行操作（请记住，对象是类的实例 - 类是定义，对象是该数据的实例）。</li>
</ol>
<p>（这是一个简化的解释，忽略了范围等问题）</p>
<p><br></p>
<h3>更多建议</h3>
<p>方法在对象上或在类中是静态的。<br>
函数独立于任何对象（并且在任何类之外）。</p>
<p>对于 Java 和 C#，只有方法。<br>
对于 C，只有函数。</p>
<p>对于 C++ 和 Python，这取决于您是否在上课。<br>
但是用基本的英语：</p>
<ul>
<li>
<strong>功能</strong> ：独立的特性或功能。</li>
<li>
<strong>方法</strong> ：做某事的一种方式，它具有不同的方法或方法，但与同一方面（也称为类）相关。</li>
</ul>
<p><br><br><a href="posts/what-s-the-difference-between-a-method-and-a-function/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/orm-dui-xiang-guan-xi-ying-she-zhong-de-n-1-xuan-ze-wen-ti-shi-shi-yao/" class="u-url">ORM（对象关系映射）中的“N+1 选择问题”是什么？</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/orm-dui-xiang-guan-xi-ying-she-zhong-de-n-1-xuan-ze-wen-ti-shi-shi-yao/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T22:37:40+08:00" itemprop="datePublished" title="2023-02-16 22:37">2023-02-16 22:37</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>“N+1 选择问题”通常在对象关系映射 (ORM) 讨论中被表述为一个问题，我理解它与必须对对象中看似简单的内容进行大量数据库查询有关世界。</p>
<p>有人对问题有更详细的解释吗？</p>
<p><br><br></p>
<h2>解答</h2>
<p>假设您有一个<code>Car</code>对象集合（数据库行），每个对象<code>Car</code>都有一个对象集合<code>Wheel</code>（也是行）。换句话说，<code>Car</code>→<code>Wheel</code>是一对多的关系。</p>
<p>现在，假设您需要遍历所有汽车，并为每辆汽车打印出一个车轮列表。朴素的 O/R 实现将执行以下操作：</p>
<div class="code"><pre class="code literal-block">SELECT * FROM Cars;
</pre></div>

<p>然后 <strong>对于每个<code>Car</code>：</strong></p>
<div class="code"><pre class="code literal-block">SELECT * FROM Wheel WHERE CarId = ?
</pre></div>

<p>换句话说，您有一个汽车选择，然后是 N 个附加选择，其中 N 是汽车总数。</p>
<p>或者，可以获取所有轮子并在内存中执行查找：</p>
<div class="code"><pre class="code literal-block">SELECT * FROM Wheel;
</pre></div>

<p>这将往返数据库的次数从 N+1 减少到 2。大多数 ORM 工具为您提供了几种方法来防止 N+1 选择。</p>
<p>参考： <em>Java Persistence with Hibernate</em> ，第 13 章。</p>
<p><br></p>
<h3>更多建议</h3>
<h3>什么是N+1查询问题</h3>
<p>N+1 查询问题发生在数据访问框架执行 N 个额外的 SQL 语句以获取在执行主 SQL 查询时可能已检索到的相同数据时。</p>
<p>N的值越大，执行的查询越多，对性能的影响越大。而且，与可以帮助您找到运行缓慢的查询的慢速查询日志不同，N+1
问题不会被发现，因为每个单独的附加查询都运行得足够快，不会触发慢速查询日志。</p>
<p>问题是执行大量额外的查询，总的来说，这些查询需要足够的时间来减慢响应时间。</p>
<p>假设我们有以下形成一对多表关系的 post 和 post_comments 数据库表：</p>
<p><img alt="post 和 post_comments 表" src="images/T1uWG.png"></p>
<p>我们将创建以下 4<code>post</code>行：</p>
<div class="code"><pre class="code literal-block">INSERT INTO post (title, id)
VALUES ('High-Performance Java Persistence - Part 1', 1)

INSERT INTO post (title, id)
VALUES ('High-Performance Java Persistence - Part 2', 2)

INSERT INTO post (title, id)
VALUES ('High-Performance Java Persistence - Part 3', 3)

INSERT INTO post (title, id)
VALUES ('High-Performance Java Persistence - Part 4', 4)
</pre></div>

<p>并且，我们还将创建 4<code>post_comment</code>个子记录：</p>
<div class="code"><pre class="code literal-block"><span class="nv">INSERT</span><span class="w"> </span><span class="nv">INTO</span><span class="w"> </span><span class="nv">post_comment</span><span class="w"> </span><span class="ss">(</span><span class="nv">post_id</span>,<span class="w"> </span><span class="nv">review</span>,<span class="w"> </span><span class="nv">id</span><span class="ss">)</span>
<span class="nv">VALUES</span><span class="w"> </span><span class="ss">(</span><span class="mi">1</span>,<span class="w"> </span><span class="s1">'Excellent book to understand Java Persistence'</span>,<span class="w"> </span><span class="mi">1</span><span class="ss">)</span>

<span class="nv">INSERT</span><span class="w"> </span><span class="nv">INTO</span><span class="w"> </span><span class="nv">post_comment</span><span class="w"> </span><span class="ss">(</span><span class="nv">post_id</span>,<span class="w"> </span><span class="nv">review</span>,<span class="w"> </span><span class="nv">id</span><span class="ss">)</span>
<span class="nv">VALUES</span><span class="w"> </span><span class="ss">(</span><span class="mi">2</span>,<span class="w"> </span><span class="s1">'Must-read for Java developers'</span>,<span class="w"> </span><span class="mi">2</span><span class="ss">)</span>

<span class="nv">INSERT</span><span class="w"> </span><span class="nv">INTO</span><span class="w"> </span><span class="nv">post_comment</span><span class="w"> </span><span class="ss">(</span><span class="nv">post_id</span>,<span class="w"> </span><span class="nv">review</span>,<span class="w"> </span><span class="nv">id</span><span class="ss">)</span>
<span class="nv">VALUES</span><span class="w"> </span><span class="ss">(</span><span class="mi">3</span>,<span class="w"> </span><span class="s1">'Five Stars'</span>,<span class="w"> </span><span class="mi">3</span><span class="ss">)</span>

<span class="nv">INSERT</span><span class="w"> </span><span class="nv">INTO</span><span class="w"> </span><span class="nv">post_comment</span><span class="w"> </span><span class="ss">(</span><span class="nv">post_id</span>,<span class="w"> </span><span class="nv">review</span>,<span class="w"> </span><span class="nv">id</span><span class="ss">)</span>
<span class="nv">VALUES</span><span class="w"> </span><span class="ss">(</span><span class="mi">4</span>,<span class="w"> </span><span class="s1">'A great reference book'</span>,<span class="w"> </span><span class="mi">4</span><span class="ss">)</span>
</pre></div>

<h3>普通 SQL 的 N+1 查询问题</h3>
<p>如果您选择<code>post_comments</code>使用此 SQL 查询：</p>
<div class="code"><pre class="code literal-block"><span class="nf">List</span><span class="err">&lt;</span><span class="no">Tuple</span><span class="err">&gt;</span><span class="w"> </span><span class="no">comments</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">entityManager.createNativeQuery</span><span class="p">(</span><span class="err">"""</span>
<span class="w">    </span><span class="nf">SELECT</span>
<span class="w">        </span><span class="nf">pc.id</span><span class="w"> </span><span class="no">AS</span><span class="w"> </span><span class="no">id</span><span class="p">,</span>
<span class="w">        </span><span class="nf">pc.review</span><span class="w"> </span><span class="no">AS</span><span class="w"> </span><span class="no">review</span><span class="p">,</span>
<span class="w">        </span><span class="nf">pc.post_id</span><span class="w"> </span><span class="no">AS</span><span class="w"> </span><span class="no">postId</span>
<span class="w">    </span><span class="nf">FROM</span><span class="w"> </span><span class="no">post_comment</span><span class="w"> </span><span class="no">pc</span>
<span class="w">    </span><span class="err">""",</span><span class="w"> </span><span class="nf">Tuple.class</span><span class="p">)</span>
<span class="na">.getResultList</span><span class="p">()</span><span class="c1">;</span>
</pre></div>

<p><code>post</code> <code>title</code>并且，稍后，您决定为每个获取关联<code>post_comment</code>：</p>
<div class="code"><pre class="code literal-block"><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">Tuple</span><span class="w"> </span><span class="nv">comment</span><span class="w"> </span>:<span class="w"> </span><span class="nv">comments</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="nv">String</span><span class="w"> </span><span class="nv">review</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">(</span><span class="nv">String</span><span class="ss">)</span><span class="w"> </span><span class="nv">comment</span>.<span class="nv">get</span><span class="ss">(</span><span class="s2">"review"</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">Long</span><span class="w"> </span><span class="nv">postId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">((</span><span class="nv">Number</span><span class="ss">)</span><span class="w"> </span><span class="nv">comment</span>.<span class="nv">get</span><span class="ss">(</span><span class="s2">"postId"</span><span class="ss">))</span>.<span class="nv">longValue</span><span class="ss">()</span><span class="c1">;</span>

<span class="w">    </span><span class="nv">String</span><span class="w"> </span><span class="nv">postTitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">(</span><span class="nv">String</span><span class="ss">)</span><span class="w"> </span><span class="nv">entityManager</span>.<span class="nv">createNativeQuery</span><span class="ss">(</span><span class="s2">""</span><span class="err">"</span>
<span class="err">        SELECT</span>
<span class="err">            p.title</span>
<span class="err">        FROM post p</span>
<span class="err">        WHERE p.id = :postId</span>
<span class="w">        </span><span class="s2">""</span><span class="err">")</span>
<span class="w">    </span>.<span class="nv">setParameter</span><span class="ss">(</span><span class="s2">"postId"</span>,<span class="w"> </span><span class="nv">postId</span><span class="ss">)</span>
<span class="w">    </span>.<span class="nv">getSingleResult</span><span class="ss">()</span><span class="c1">;</span>

<span class="w">    </span><span class="nv">LOGGER</span>.<span class="nv">info</span><span class="ss">(</span>
<span class="w">        </span><span class="s2">"The Post '{}' got this review '{}'"</span>,
<span class="w">        </span><span class="nv">postTitle</span>,
<span class="w">        </span><span class="nv">review</span>
<span class="w">    </span><span class="ss">)</span><span class="c1">;</span>
}
</pre></div>

<p>您将触发 N+1 查询问题，因为您执行了 5 (1 + 4) 次 SQL 查询，而不是一次 SQL 查询：</p>
<div class="code"><pre class="code literal-block"><span class="nv">SELECT</span>
<span class="w">    </span><span class="nv">pc</span>.<span class="nv">id</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">id</span>,
<span class="w">    </span><span class="nv">pc</span>.<span class="nv">review</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">review</span>,
<span class="w">    </span><span class="nv">pc</span>.<span class="nv">post_id</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">postId</span>
<span class="nv">FROM</span><span class="w"> </span><span class="nv">post_comment</span><span class="w"> </span><span class="nv">pc</span>

<span class="nv">SELECT</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">title</span><span class="w"> </span><span class="nv">FROM</span><span class="w"> </span><span class="nv">post</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">WHERE</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="o">--</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Post</span><span class="w"> </span><span class="s1">'High-Performance Java Persistence - Part 1'</span><span class="w"> </span><span class="nv">got</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">review</span>
<span class="o">--</span><span class="w"> </span><span class="s1">'Excellent book to understand Java Persistence'</span>

<span class="nv">SELECT</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">title</span><span class="w"> </span><span class="nv">FROM</span><span class="w"> </span><span class="nv">post</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">WHERE</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="o">--</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Post</span><span class="w"> </span><span class="s1">'High-Performance Java Persistence - Part 2'</span><span class="w"> </span><span class="nv">got</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">review</span>
<span class="o">--</span><span class="w"> </span><span class="s1">'Must-read for Java developers'</span>

<span class="nv">SELECT</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">title</span><span class="w"> </span><span class="nv">FROM</span><span class="w"> </span><span class="nv">post</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">WHERE</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="o">--</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Post</span><span class="w"> </span><span class="s1">'High-Performance Java Persistence - Part 3'</span><span class="w"> </span><span class="nv">got</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">review</span>
<span class="o">--</span><span class="w"> </span><span class="s1">'Five Stars'</span>

<span class="nv">SELECT</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">title</span><span class="w"> </span><span class="nv">FROM</span><span class="w"> </span><span class="nv">post</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">WHERE</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>
<span class="o">--</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Post</span><span class="w"> </span><span class="s1">'High-Performance Java Persistence - Part 4'</span><span class="w"> </span><span class="nv">got</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">review</span>
<span class="o">--</span><span class="w"> </span><span class="s1">'A great reference book'</span>
</pre></div>

<p>修复 N+1 查询问题非常容易。您需要做的就是提取原始 SQL 查询中需要的所有数据，如下所示：</p>
<div class="code"><pre class="code literal-block"><span class="nf">List</span><span class="err">&lt;</span><span class="no">Tuple</span><span class="err">&gt;</span><span class="w"> </span><span class="no">comments</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">entityManager.createNativeQuery</span><span class="p">(</span><span class="err">"""</span>
<span class="w">    </span><span class="nf">SELECT</span>
<span class="w">        </span><span class="nf">pc.id</span><span class="w"> </span><span class="no">AS</span><span class="w"> </span><span class="no">id</span><span class="p">,</span>
<span class="w">        </span><span class="nf">pc.review</span><span class="w"> </span><span class="no">AS</span><span class="w"> </span><span class="no">review</span><span class="p">,</span>
<span class="w">        </span><span class="nf">p.title</span><span class="w"> </span><span class="no">AS</span><span class="w"> </span><span class="no">postTitle</span>
<span class="w">    </span><span class="nf">FROM</span><span class="w"> </span><span class="no">post_comment</span><span class="w"> </span><span class="no">pc</span>
<span class="w">    </span><span class="nf">JOIN</span><span class="w"> </span><span class="no">post</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">ON</span><span class="w"> </span><span class="no">pc.post_id</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">p.id</span>
<span class="w">    </span><span class="err">""",</span><span class="w"> </span><span class="nf">Tuple.class</span><span class="p">)</span>
<span class="na">.getResultList</span><span class="p">()</span><span class="c1">;</span>

<span class="nf">for</span><span class="w"> </span><span class="p">(</span><span class="no">Tuple</span><span class="w"> </span><span class="no">comment</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">comments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">String</span><span class="w"> </span><span class="no">review</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">(</span><span class="no">String</span><span class="p">)</span><span class="w"> </span><span class="no">comment.get</span><span class="p">(</span><span class="err">"</span><span class="no">review</span><span class="err">"</span><span class="p">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nf">String</span><span class="w"> </span><span class="no">postTitle</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">(</span><span class="no">String</span><span class="p">)</span><span class="w"> </span><span class="no">comment.get</span><span class="p">(</span><span class="err">"</span><span class="no">postTitle</span><span class="err">"</span><span class="p">)</span><span class="c1">;</span>

<span class="w">    </span><span class="nf">LOGGER.info</span><span class="p">(</span>
<span class="w">        </span><span class="err">"</span><span class="nf">The</span><span class="w"> </span><span class="no">Post</span><span class="w"> </span><span class="err">'</span><span class="p">{}</span><span class="err">'</span><span class="w"> </span><span class="no">got</span><span class="w"> </span><span class="no">this</span><span class="w"> </span><span class="no">review</span><span class="w"> </span><span class="err">'</span><span class="p">{}</span><span class="err">'"</span><span class="p">,</span>
<span class="w">        </span><span class="nf">postTitle</span><span class="p">,</span>
<span class="w">        </span><span class="nf">review</span>
<span class="w">    </span><span class="err">)</span><span class="c1">;</span>
<span class="err">}</span>
</pre></div>

<p>这一次，只执行一个 SQL 查询来获取我们进一步感兴趣使用的所有数据。</p>
<h3>JPA 和 Hibernate 的 N+1 查询问题</h3>
<p>使用 JPA 和 Hibernate 时，有几种方法可以触发 N+1 查询问题，因此了解如何避免这些情况非常重要。</p>
<p>对于下一个示例，考虑我们将<code>post</code>和<code>post_comments</code>表映射到以下实体：</p>
<p><img alt="Post 和 PostComment 实体" src="images/rZJne.png"></p>
<p>JPA 映射如下所示：</p>
<div class="code"><pre class="code literal-block"><span class="nv">@Entity</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"Post"</span><span class="p">)</span>
<span class="nv">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"post"</span><span class="p">)</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">Post</span><span class="w"> </span><span class="err">{</span>

<span class="w">    </span><span class="nv">@Id</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>

<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">title</span><span class="p">;</span>

<span class="w">    </span><span class="o">//</span><span class="n">Getters</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">setters</span><span class="w"> </span><span class="n">omitted</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">brevity</span>
<span class="err">}</span>

<span class="nv">@Entity</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"PostComment"</span><span class="p">)</span>
<span class="nv">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"post_comment"</span><span class="p">)</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">PostComment</span><span class="w"> </span><span class="err">{</span>

<span class="w">    </span><span class="nv">@Id</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>

<span class="w">    </span><span class="nv">@ManyToOne</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">Post</span><span class="w"> </span><span class="n">post</span><span class="p">;</span>

<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">review</span><span class="p">;</span>

<span class="w">    </span><span class="o">//</span><span class="n">Getters</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">setters</span><span class="w"> </span><span class="n">omitted</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">brevity</span>
<span class="err">}</span>
</pre></div>

<h3><code>FetchType.EAGER</code></h3>
<p>为您的 JPA
关联隐式或显式使用<code>FetchType.EAGER</code>都不是一个好主意，因为您将获取所需的更多数据。而且，该<code>FetchType.EAGER</code>策略也容易出现N+1查询问题。</p>
<p>不幸的是，默认情况下使用<code>@ManyToOne</code>和关联，因此如果您的映射如下所示：<code>@OneToOne``FetchType.EAGER</code></p>
<div class="code"><pre class="code literal-block"><span class="nv">@ManyToOne</span>
<span class="n">private</span><span class="w"> </span><span class="n">Post</span><span class="w"> </span><span class="n">post</span><span class="p">;</span>
</pre></div>

<p>您正在使用该策略，并且每次您在使用 JPQL 或 Criteria API 查询加载某些实体时<code>FetchType.EAGER</code>忘记使用：<code>JOIN
FETCH``PostComment</code></p>
<div class="code"><pre class="code literal-block"><span class="nf">List</span><span class="err">&lt;</span><span class="no">PostComment</span><span class="err">&gt;</span><span class="w"> </span><span class="no">comments</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">entityManager</span>
<span class="na">.createQuery</span><span class="p">(</span><span class="s">"""</span>
<span class="s">    select pc</span>
<span class="s">    from PostComment pc</span>
<span class="s">    """</span><span class="p">,</span><span class="w"> </span><span class="no">PostComment.class</span><span class="p">)</span>
<span class="na">.getResultList</span><span class="p">()</span><span class="c1">;</span>
</pre></div>

<p>您将触发 N+1 查询问题：</p>
<div class="code"><pre class="code literal-block">SELECT 
    pc.id AS id1_1_, 
    pc.post_id AS post_id3_1_, 
    pc.review AS review2_1_ 
FROM 
    post_comment pc

SELECT p.id AS id1_0_0_, p.title AS title2_0_0_ FROM post p WHERE p.id = 1
SELECT p.id AS id1_0_0_, p.title AS title2_0_0_ FROM post p WHERE p.id = 2
SELECT p.id AS id1_0_0_, p.title AS title2_0_0_ FROM post p WHERE p.id = 3
SELECT p.id AS id1_0_0_, p.title AS title2_0_0_ FROM post p WHERE p.id = 4
</pre></div>

<p>请注意执行的其他 SELECT 语句，因为<code>post</code>必须在返回实体之前获取<code>List</code>关联<code>PostComment</code>。</p>
<p>Unlike the default fetch plan, which you are using when calling the <code>find</code>
method of the <code>EntityManager</code>, a JPQL or Criteria API query defines an
explicit plan that Hibernate cannot change by injecting a JOIN FETCH
automatically. So, you need to do it manually.</p>
<p>If you didn't need the <code>post</code> association at all, you are out of luck when
using <code>FetchType.EAGER</code> because there is no way to avoid fetching it. That's
why it's better to use <code>FetchType.LAZY</code> by default.</p>
<p>But, if you wanted to use <code>post</code> association, then you can use <code>JOIN FETCH</code> to
avoid the N+1 query problem:</p>
<div class="code"><pre class="code literal-block"><span class="nf">List</span><span class="err">&lt;</span><span class="no">PostComment</span><span class="err">&gt;</span><span class="w"> </span><span class="no">comments</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">entityManager.createQuery</span><span class="p">(</span><span class="err">"""</span>
<span class="w">    </span><span class="nf">select</span><span class="w"> </span><span class="no">pc</span>
<span class="w">    </span><span class="nf">from</span><span class="w"> </span><span class="no">PostComment</span><span class="w"> </span><span class="no">pc</span>
<span class="w">    </span><span class="nf">join</span><span class="w"> </span><span class="no">fetch</span><span class="w"> </span><span class="no">pc.post</span><span class="w"> </span><span class="no">p</span>
<span class="w">    </span><span class="err">""",</span><span class="w"> </span><span class="nf">PostComment.class</span><span class="p">)</span>
<span class="na">.getResultList</span><span class="p">()</span><span class="c1">;</span>

<span class="nf">for</span><span class="p">(</span><span class="no">PostComment</span><span class="w"> </span><span class="no">comment</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">comments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">LOGGER.info</span><span class="p">(</span>
<span class="w">        </span><span class="err">"</span><span class="nf">The</span><span class="w"> </span><span class="no">Post</span><span class="w"> </span><span class="err">'</span><span class="p">{}</span><span class="err">'</span><span class="w"> </span><span class="no">got</span><span class="w"> </span><span class="no">this</span><span class="w"> </span><span class="no">review</span><span class="w"> </span><span class="err">'</span><span class="p">{}</span><span class="err">'"</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="no">comment.getPost</span><span class="p">().</span><span class="no">getTitle</span><span class="p">(),</span><span class="w"> </span>
<span class="w">        </span><span class="no">comment.getReview</span><span class="p">()</span>
<span class="w">    </span><span class="err">)</span><span class="c1">;</span>
<span class="err">}</span>
</pre></div>

<p>This time, Hibernate will execute a single SQL statement:</p>
<div class="code"><pre class="code literal-block"><span class="nv">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="nv">pc</span>.<span class="nv">id</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">id1_1_0_</span>,<span class="w"> </span>
<span class="w">    </span><span class="nv">pc</span>.<span class="nv">post_id</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">post_id3_1_0_</span>,<span class="w"> </span>
<span class="w">    </span><span class="nv">pc</span>.<span class="nv">review</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">review2_1_0_</span>,<span class="w"> </span>
<span class="w">    </span><span class="nv">p</span>.<span class="nv">id</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">id1_0_1_</span>,<span class="w"> </span>
<span class="w">    </span><span class="nv">p</span>.<span class="nv">title</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">title2_0_1_</span><span class="w"> </span>
<span class="nv">FROM</span><span class="w"> </span>
<span class="w">    </span><span class="nv">post_comment</span><span class="w"> </span><span class="nv">pc</span><span class="w"> </span>
<span class="nv">INNER</span><span class="w"> </span><span class="nv">JOIN</span><span class="w"> </span>
<span class="w">    </span><span class="nv">post</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">ON</span><span class="w"> </span><span class="nv">pc</span>.<span class="nv">post_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id</span>

<span class="o">--</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Post</span><span class="w"> </span><span class="s1">'High-Performance Java Persistence - Part 1'</span><span class="w"> </span><span class="nv">got</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">review</span><span class="w"> </span>
<span class="o">--</span><span class="w"> </span><span class="s1">'Excellent book to understand Java Persistence'</span>

<span class="o">--</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Post</span><span class="w"> </span><span class="s1">'High-Performance Java Persistence - Part 2'</span><span class="w"> </span><span class="nv">got</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">review</span><span class="w"> </span>
<span class="o">--</span><span class="w"> </span><span class="s1">'Must-read for Java developers'</span>

<span class="o">--</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Post</span><span class="w"> </span><span class="s1">'High-Performance Java Persistence - Part 3'</span><span class="w"> </span><span class="nv">got</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">review</span><span class="w"> </span>
<span class="o">--</span><span class="w"> </span><span class="s1">'Five Stars'</span>

<span class="o">--</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Post</span><span class="w"> </span><span class="s1">'High-Performance Java Persistence - Part 4'</span><span class="w"> </span><span class="nv">got</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">review</span><span class="w"> </span>
<span class="o">--</span><span class="w"> </span><span class="s1">'A great reference book'</span>
</pre></div>

<h3><code>FetchType.LAZY</code></h3>
<p>Even if you switch to using <code>FetchType.LAZY</code> explicitly for all associations,
you can still bump into the N+1 issue.</p>
<p>This time, the <code>post</code> association is mapped like this:</p>
<div class="code"><pre class="code literal-block"><span class="nv">@ManyToOne</span><span class="p">(</span><span class="k">fetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FetchType</span><span class="p">.</span><span class="n">LAZY</span><span class="p">)</span>
<span class="n">private</span><span class="w"> </span><span class="n">Post</span><span class="w"> </span><span class="n">post</span><span class="p">;</span>
</pre></div>

<p>Now, when you fetch the <code>PostComment</code> entities:</p>
<div class="code"><pre class="code literal-block"><span class="nf">List</span><span class="err">&lt;</span><span class="no">PostComment</span><span class="err">&gt;</span><span class="w"> </span><span class="no">comments</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">entityManager</span>
<span class="na">.createQuery</span><span class="p">(</span><span class="s">"""</span>
<span class="s">    select pc</span>
<span class="s">    from PostComment pc</span>
<span class="s">    """</span><span class="p">,</span><span class="w"> </span><span class="no">PostComment.class</span><span class="p">)</span>
<span class="na">.getResultList</span><span class="p">()</span><span class="c1">;</span>
</pre></div>

<p>Hibernate will execute a single SQL statement:</p>
<div class="code"><pre class="code literal-block">SELECT 
    pc.id AS id1_1_, 
    pc.post_id AS post_id3_1_, 
    pc.review AS review2_1_ 
FROM 
    post_comment pc
</pre></div>

<p>But, if afterward, you are going to reference the lazy-loaded <code>post</code>
association:</p>
<div class="code"><pre class="code literal-block"><span class="k">for</span><span class="ss">(</span><span class="nv">PostComment</span><span class="w"> </span><span class="nv">comment</span><span class="w"> </span>:<span class="w"> </span><span class="nv">comments</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="nv">LOGGER</span>.<span class="nv">info</span><span class="ss">(</span>
<span class="w">        </span><span class="s2">"The Post '{}' got this review '{}'"</span>,<span class="w"> </span>
<span class="w">        </span><span class="nv">comment</span>.<span class="nv">getPost</span><span class="ss">()</span>.<span class="k">getTitle</span><span class="ss">()</span>,<span class="w"> </span>
<span class="w">        </span><span class="nv">comment</span>.<span class="nv">getReview</span><span class="ss">()</span>
<span class="w">    </span><span class="ss">)</span><span class="c1">;</span>
}
</pre></div>

<p>You will get the N+1 query issue:</p>
<div class="code"><pre class="code literal-block"><span class="nv">SELECT</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">id1_0_0_</span>,<span class="w"> </span><span class="nv">p</span>.<span class="nv">title</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">title2_0_0_</span><span class="w"> </span><span class="nv">FROM</span><span class="w"> </span><span class="nv">post</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">WHERE</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="o">--</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Post</span><span class="w"> </span><span class="s1">'High-Performance Java Persistence - Part 1'</span><span class="w"> </span><span class="nv">got</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">review</span><span class="w"> </span>
<span class="o">--</span><span class="w"> </span><span class="s1">'Excellent book to understand Java Persistence'</span>

<span class="nv">SELECT</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">id1_0_0_</span>,<span class="w"> </span><span class="nv">p</span>.<span class="nv">title</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">title2_0_0_</span><span class="w"> </span><span class="nv">FROM</span><span class="w"> </span><span class="nv">post</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">WHERE</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="o">--</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Post</span><span class="w"> </span><span class="s1">'High-Performance Java Persistence - Part 2'</span><span class="w"> </span><span class="nv">got</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">review</span><span class="w"> </span>
<span class="o">--</span><span class="w"> </span><span class="s1">'Must-read for Java developers'</span>

<span class="nv">SELECT</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">id1_0_0_</span>,<span class="w"> </span><span class="nv">p</span>.<span class="nv">title</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">title2_0_0_</span><span class="w"> </span><span class="nv">FROM</span><span class="w"> </span><span class="nv">post</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">WHERE</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="o">--</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Post</span><span class="w"> </span><span class="s1">'High-Performance Java Persistence - Part 3'</span><span class="w"> </span><span class="nv">got</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">review</span><span class="w"> </span>
<span class="o">--</span><span class="w"> </span><span class="s1">'Five Stars'</span>

<span class="nv">SELECT</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">id1_0_0_</span>,<span class="w"> </span><span class="nv">p</span>.<span class="nv">title</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">title2_0_0_</span><span class="w"> </span><span class="nv">FROM</span><span class="w"> </span><span class="nv">post</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">WHERE</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>
<span class="o">--</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Post</span><span class="w"> </span><span class="s1">'High-Performance Java Persistence - Part 4'</span><span class="w"> </span><span class="nv">got</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">review</span><span class="w"> </span>
<span class="o">--</span><span class="w"> </span><span class="s1">'A great reference book'</span>
</pre></div>

<p>Because the <code>post</code> association is fetched lazily, a secondary SQL statement
will be executed when accessing the lazy association in order to build the log
message.</p>
<p>Again, the fix consists in adding a <code>JOIN FETCH</code> clause to the JPQL query:</p>
<div class="code"><pre class="code literal-block"><span class="nf">List</span><span class="err">&lt;</span><span class="no">PostComment</span><span class="err">&gt;</span><span class="w"> </span><span class="no">comments</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">entityManager.createQuery</span><span class="p">(</span><span class="err">"""</span>
<span class="w">    </span><span class="nf">select</span><span class="w"> </span><span class="no">pc</span>
<span class="w">    </span><span class="nf">from</span><span class="w"> </span><span class="no">PostComment</span><span class="w"> </span><span class="no">pc</span>
<span class="w">    </span><span class="nf">join</span><span class="w"> </span><span class="no">fetch</span><span class="w"> </span><span class="no">pc.post</span><span class="w"> </span><span class="no">p</span>
<span class="w">    </span><span class="err">""",</span><span class="w"> </span><span class="nf">PostComment.class</span><span class="p">)</span>
<span class="na">.getResultList</span><span class="p">()</span><span class="c1">;</span>

<span class="nf">for</span><span class="p">(</span><span class="no">PostComment</span><span class="w"> </span><span class="no">comment</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">comments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">LOGGER.info</span><span class="p">(</span>
<span class="w">        </span><span class="err">"</span><span class="nf">The</span><span class="w"> </span><span class="no">Post</span><span class="w"> </span><span class="err">'</span><span class="p">{}</span><span class="err">'</span><span class="w"> </span><span class="no">got</span><span class="w"> </span><span class="no">this</span><span class="w"> </span><span class="no">review</span><span class="w"> </span><span class="err">'</span><span class="p">{}</span><span class="err">'"</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="no">comment.getPost</span><span class="p">().</span><span class="no">getTitle</span><span class="p">(),</span><span class="w"> </span>
<span class="w">        </span><span class="no">comment.getReview</span><span class="p">()</span>
<span class="w">    </span><span class="err">)</span><span class="c1">;</span>
<span class="err">}</span>
</pre></div>

<p>And, just like in the <code>FetchType.EAGER</code> example, this JPQL query will generate
a single SQL statement.</p>
<blockquote>
<p>Even if you are using <code>FetchType.LAZY</code> and don't reference the child
association of a bidirectional <code>@OneToOne</code> JPA relationship, you can still
trigger the N+1 query issue.</p>
</blockquote>
<h3>How to automatically detect the N+1 query issue</h3>
<p>If you want to automatically detect N+1 query issue in your data access layer,
you can use the <code>db-util</code> open-source project.</p>
<p>First, you need to add the following Maven dependency:</p>
<div class="code"><pre class="code literal-block"><span class="nt">&lt;dependency&gt;</span>
<span class="w">    </span><span class="nt">&lt;groupId&gt;</span>com.vladmihalcea<span class="nt">&lt;/groupId&gt;</span>
<span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>db-util<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;version&gt;</span><span class="cp">${</span><span class="n">db</span><span class="o">-</span><span class="n">util</span><span class="o">.</span><span class="n">version</span><span class="cp">}</span><span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>

<p>Afterward, you just have to use <code>SQLStatementCountValidator</code> utility to assert
the underlying SQL statements that get generated:</p>
<div class="code"><pre class="code literal-block"><span class="nf">SQLStatementCountValidator.reset</span><span class="p">()</span><span class="c1">;</span>

<span class="nf">List</span><span class="err">&lt;</span><span class="no">PostComment</span><span class="err">&gt;</span><span class="w"> </span><span class="no">comments</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">entityManager.createQuery</span><span class="p">(</span><span class="err">"""</span>
<span class="w">    </span><span class="nf">select</span><span class="w"> </span><span class="no">pc</span>
<span class="w">    </span><span class="nf">from</span><span class="w"> </span><span class="no">PostComment</span><span class="w"> </span><span class="no">pc</span>
<span class="w">    </span><span class="err">""",</span><span class="w"> </span><span class="nf">PostComment.class</span><span class="p">)</span>
<span class="na">.getResultList</span><span class="p">()</span><span class="c1">;</span>

<span class="nf">SQLStatementCountValidator.assertSelectCount</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="c1">;</span>
</pre></div>

<p>In case you are using <code>FetchType.EAGER</code> and run the above test case, you will
get the following test case failure:</p>
<div class="code"><pre class="code literal-block">SELECT 
    pc.id as id1_1_, 
    pc.post_id as post_id3_1_, 
    pc.review as review2_1_ 
FROM 
    post_comment pc

SELECT p.id as id1_0_0_, p.title as title2_0_0_ FROM post p WHERE p.id = 1

SELECT p.id as id1_0_0_, p.title as title2_0_0_ FROM post p WHERE p.id = 2


-- SQLStatementCountMismatchException: Expected 1 statement(s) but recorded 3 instead!
</pre></div>

<p><br><br><a href="posts/what-is-the-n-1-selects-problem-in-orm-object-relational-mapping/">查看原文</a></p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-136.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-134.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
