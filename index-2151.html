<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 2151) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-2151.html">
<link rel="prev" href="index-2152.html" type="text/html">
<link rel="next" href="index-2150.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/net-3-5-jit-not-working-when-running-the-application/" class="u-url">.NET 3.5 JIT not working when running the application</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/net-3-5-jit-not-working-when-running-the-application/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T18:46:11+08:00" itemprop="datePublished" title="2023-03-03 18:46">2023-03-03 18:46</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>The following code gives different output when running the release inside
Visual Studio, and running the release outside Visual Studio. I'm using Visual
Studio 2008 and targeting .NET 3.5. I've also tried .NET 3.5 SP1.</p>
<p>When running outside Visual Studio, the JIT should kick in. Either (a) there's
something subtle going on with C# that I'm missing or (b) the JIT is actually
in error. I'm doubtful that the JIT can go wrong, but I'm running out of other
possiblities...</p>
<p>Output when running inside Visual Studio:</p>
<div class="code"><pre class="code literal-block">    0 0,
    0 1,
    1 0,
    1 1,
</pre></div>

<p>Output when running release outside of Visual Studio:</p>
<div class="code"><pre class="code literal-block">    0 2,
    0 2,
    1 2,
    1 2,
</pre></div>

<p>What is the reason?</p>
<div class="code"><pre class="code literal-block"><span class="nv">using</span><span class="w"> </span><span class="nv">System</span><span class="c1">;</span>
<span class="nv">using</span><span class="w"> </span><span class="nv">System</span>.<span class="nv">Collections</span>.<span class="nv">Generic</span><span class="c1">;</span>
<span class="nv">using</span><span class="w"> </span><span class="nv">System</span>.<span class="nv">Linq</span><span class="c1">;</span>
<span class="nv">using</span><span class="w"> </span><span class="nv">System</span>.<span class="nv">Text</span><span class="c1">;</span>

<span class="nv">namespace</span><span class="w"> </span><span class="nv">Test</span>
{
<span class="w">    </span><span class="nv">struct</span><span class="w"> </span><span class="nv">IntVec</span>
<span class="w">    </span>{
<span class="w">        </span><span class="nv">public</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">x</span><span class="c1">;</span>
<span class="w">        </span><span class="nv">public</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">y</span><span class="c1">;</span>
<span class="w">    </span>}

<span class="w">    </span><span class="nv">interface</span><span class="w"> </span><span class="nv">IDoSomething</span>
<span class="w">    </span>{
<span class="w">        </span><span class="nv">void</span><span class="w"> </span><span class="k">Do</span><span class="ss">(</span><span class="nv">IntVec</span><span class="w"> </span><span class="nv">o</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span>}

<span class="w">    </span><span class="nv">class</span><span class="w"> </span><span class="nv">DoSomething</span><span class="w"> </span>:<span class="w"> </span><span class="nv">IDoSomething</span>
<span class="w">    </span>{
<span class="w">        </span><span class="nv">public</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="k">Do</span><span class="ss">(</span><span class="nv">IntVec</span><span class="w"> </span><span class="nv">o</span><span class="ss">)</span>
<span class="w">        </span>{
<span class="w">            </span><span class="nv">Console</span>.<span class="nv">WriteLine</span><span class="ss">(</span><span class="nv">o</span>.<span class="nv">x</span>.<span class="nv">ToString</span><span class="ss">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">" "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">o</span>.<span class="nv">y</span>.<span class="nv">ToString</span><span class="ss">()</span><span class="o">+</span><span class="s2">","</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">    </span>}

<span class="w">    </span><span class="nv">class</span><span class="w"> </span><span class="nv">Program</span>
<span class="w">    </span>{
<span class="w">        </span><span class="nv">static</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">Test</span><span class="ss">(</span><span class="nv">IDoSomething</span><span class="w"> </span><span class="nv">oDoesSomething</span><span class="ss">)</span>
<span class="w">        </span>{
<span class="w">            </span><span class="nv">IntVec</span><span class="w"> </span><span class="nv">oVec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">IntVec</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">oVec</span>.<span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">; oVec.x &lt; 2; oVec.x++)</span>
<span class="w">            </span>{
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">oVec</span>.<span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">; oVec.y &lt; 2; oVec.y++)</span>
<span class="w">                </span>{
<span class="w">                    </span><span class="nv">oDoesSomething</span>.<span class="k">Do</span><span class="ss">(</span><span class="nv">oVec</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">                </span>}
<span class="w">            </span>}
<span class="w">        </span>}

<span class="w">        </span><span class="nv">static</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">Main</span><span class="ss">(</span><span class="nv">string</span>[]<span class="w"> </span><span class="nv">args</span><span class="ss">)</span>
<span class="w">        </span>{
<span class="w">            </span><span class="nv">Test</span><span class="ss">(</span><span class="nv">new</span><span class="w"> </span><span class="nv">DoSomething</span><span class="ss">())</span><span class="c1">;</span>
<span class="w">            </span><span class="nv">Console</span>.<span class="nv">ReadLine</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">    </span>}
}
</pre></div>

<p><br><br></p>
<h2>Answer</h2>
<p>It is a JIT optimizer bug. It is unrolling the inner loop but not updating the
oVec.y value properly:</p>
<div class="code"><pre class="code literal-block"><span class="w">      </span><span class="nt">for</span><span class="w"> </span><span class="o">(</span><span class="nt">oVec</span><span class="p">.</span><span class="nc">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">0</span><span class="o">;</span><span class="w"> </span><span class="nt">oVec</span><span class="p">.</span><span class="nc">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nt">2</span><span class="o">;</span><span class="w"> </span><span class="nt">oVec</span><span class="p">.</span><span class="nc">x</span><span class="o">++)</span><span class="w"> </span><span class="p">{</span>
<span class="err">0000000a</span><span class="w">  </span><span class="err">xor</span><span class="w">         </span><span class="err">esi,esi</span><span class="w">                         </span><span class="p">;</span><span class="w"> </span><span class="err">oVec.x</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">0</span>
<span class="w">        </span><span class="err">for</span><span class="w"> </span><span class="err">(oVec.y</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">0</span><span class="p">;</span><span class="w"> </span><span class="err">oVec.y</span><span class="w"> </span><span class="err">&lt;</span><span class="w"> </span><span class="err">2</span><span class="p">;</span><span class="w"> </span><span class="err">oVec.y++)</span><span class="w"> </span><span class="err">{</span>
<span class="err">0000000c</span><span class="w">  </span><span class="err">mov</span><span class="w">         </span><span class="err">edi,2</span><span class="w">                           </span><span class="p">;</span><span class="w"> </span><span class="err">oVec.y</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">2,</span><span class="w"> </span><span class="err">WRONG!</span>
<span class="w">          </span><span class="err">oDoesSomething.Do(oVec)</span><span class="p">;</span>
<span class="err">00000011</span><span class="w">  </span><span class="err">push</span><span class="w">        </span><span class="err">edi</span><span class="w">  </span>
<span class="err">00000012</span><span class="w">  </span><span class="err">push</span><span class="w">        </span><span class="err">esi</span><span class="w">  </span>
<span class="err">00000013</span><span class="w">  </span><span class="err">mov</span><span class="w">         </span><span class="err">ecx,ebx</span><span class="w"> </span>
<span class="err">00000015</span><span class="w">  </span><span class="err">call</span><span class="w">        </span><span class="err">dword</span><span class="w"> </span><span class="err">ptr</span><span class="w"> </span><span class="n">ds</span><span class="p">:</span><span class="cp">[</span><span class="mi">00170210</span><span class="nx">h</span><span class="cp">]</span><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="err">first</span><span class="w"> </span><span class="err">unrolled</span><span class="w"> </span><span class="err">call</span>
<span class="err">0000001b</span><span class="w">  </span><span class="err">push</span><span class="w">        </span><span class="err">edi</span><span class="w">                             </span><span class="p">;</span><span class="w"> </span><span class="err">WRONG!</span><span class="w"> </span><span class="err">does</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="err">increment</span><span class="w"> </span><span class="err">oVec.y</span>
<span class="err">0000001c</span><span class="w">  </span><span class="err">push</span><span class="w">        </span><span class="err">esi</span><span class="w">  </span>
<span class="err">0000001d</span><span class="w">  </span><span class="err">mov</span><span class="w">         </span><span class="err">ecx,ebx</span><span class="w"> </span>
<span class="err">0000001f</span><span class="w">  </span><span class="err">call</span><span class="w">        </span><span class="err">dword</span><span class="w"> </span><span class="err">ptr</span><span class="w"> </span><span class="n">ds</span><span class="p">:</span><span class="cp">[</span><span class="mi">00170210</span><span class="nx">h</span><span class="cp">]</span><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="err">second</span><span class="w"> </span><span class="err">unrolled</span><span class="w"> </span><span class="err">call</span>
<span class="w">      </span><span class="err">for</span><span class="w"> </span><span class="err">(oVec.x</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">0</span><span class="p">;</span><span class="w"> </span><span class="err">oVec.x</span><span class="w"> </span><span class="err">&lt;</span><span class="w"> </span><span class="err">2</span><span class="p">;</span><span class="w"> </span><span class="err">oVec.x++)</span><span class="w"> </span><span class="err">{</span>
<span class="err">00000025</span><span class="w">  </span><span class="err">inc</span><span class="w">         </span><span class="err">esi</span><span class="w">  </span>
<span class="err">00000026</span><span class="w">  </span><span class="err">cmp</span><span class="w">         </span><span class="err">esi,2</span><span class="w"> </span>
<span class="err">00000029</span><span class="w">  </span><span class="err">jl</span><span class="w">          </span><span class="err">0000000C</span>
</pre></div>

<p>The bug disappears when you let oVec.y increment to 4, that's too many calls
to unroll.</p>
<p>One workaround is this:</p>
<div class="code"><pre class="code literal-block"><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">int</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">; x &lt; 2; x++) {</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">int</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">; y &lt; 2; y++) {</span>
<span class="w">      </span><span class="nv">oDoesSomething</span>.<span class="k">Do</span><span class="ss">(</span><span class="nv">new</span><span class="w"> </span><span class="nv">IntVec</span><span class="ss">(</span><span class="nv">x</span>,<span class="w"> </span><span class="nv">y</span><span class="ss">))</span><span class="c1">;</span>
<span class="w">    </span>}
<span class="w">  </span>}
</pre></div>

<p>UPDATE: re-checked in August 2012, this bug was fixed in the version 4.0.30319
jitter. But is still present in the v2.0.50727 jitter. It seems unlikely
they'll fix this in the old version after this long.</p>
<p><br></p>
<h3>Suggest</h3>
<p>I believe this is in a genuine JIT compilation bug. I would report it to
Microsoft and see what they say. Interestingly, I found that the x64 JIT does
not have the same problem.</p>
<p>Here is my reading of the x86 JIT.</p>
<div class="code"><pre class="code literal-block"><span class="c1">// save context</span>
<span class="mi">00000000</span><span class="w">  </span><span class="n">push</span><span class="w">        </span><span class="n">ebp</span><span class="w">  </span>
<span class="mi">00000001</span><span class="w">  </span><span class="n">mov</span><span class="w">         </span><span class="n">ebp</span><span class="p">,</span><span class="n">esp</span><span class="w"> </span>
<span class="mi">00000003</span><span class="w">  </span><span class="n">push</span><span class="w">        </span><span class="n">edi</span><span class="w">  </span>
<span class="mi">00000004</span><span class="w">  </span><span class="n">push</span><span class="w">        </span><span class="n">esi</span><span class="w">  </span>
<span class="mi">00000005</span><span class="w">  </span><span class="n">push</span><span class="w">        </span><span class="n">ebx</span>

<span class="c1">// put oDoesSomething pointer in ebx</span>
<span class="mi">00000006</span><span class="w">  </span><span class="n">mov</span><span class="w">         </span><span class="n">ebx</span><span class="p">,</span><span class="n">ecx</span>

<span class="c1">// zero out edi, this will store oVec.y</span>
<span class="mi">00000008</span><span class="w">  </span><span class="n">xor</span><span class="w">         </span><span class="n">edi</span><span class="p">,</span><span class="n">edi</span>

<span class="c1">// zero out esi, this will store oVec.x</span>
<span class="mi">0000000</span><span class="n">a</span><span class="w">  </span><span class="n">xor</span><span class="w">         </span><span class="n">esi</span><span class="p">,</span><span class="n">esi</span>

<span class="c1">// NOTE: the inner loop is unrolled here.</span>
<span class="c1">// set oVec.y to 2</span>
<span class="mi">0000000</span><span class="n">c</span><span class="w">  </span><span class="n">mov</span><span class="w">         </span><span class="n">edi</span><span class="p">,</span><span class="mi">2</span>

<span class="c1">// call oDoesSomething.Do(oVec) -- y is always 2!?!</span>
<span class="mi">00000011</span><span class="w">  </span><span class="n">push</span><span class="w">        </span><span class="n">edi</span><span class="w">  </span>
<span class="mi">00000012</span><span class="w">  </span><span class="n">push</span><span class="w">        </span><span class="n">esi</span><span class="w">  </span>
<span class="mi">00000013</span><span class="w">  </span><span class="n">mov</span><span class="w">         </span><span class="n">ecx</span><span class="p">,</span><span class="n">ebx</span><span class="w"> </span>
<span class="mi">00000015</span><span class="w">  </span><span class="nb">call</span><span class="w">        </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="n">ds</span><span class="p">:[</span><span class="mi">002</span><span class="n">F0010h</span><span class="p">]</span>

<span class="c1">// call oDoesSomething.Do(oVec) -- y is always 2?!?!</span>
<span class="mi">0000001</span><span class="n">b</span><span class="w">  </span><span class="n">push</span><span class="w">        </span><span class="n">edi</span><span class="w">  </span>
<span class="mi">0000001</span><span class="n">c</span><span class="w">  </span><span class="n">push</span><span class="w">        </span><span class="n">esi</span><span class="w">  </span>
<span class="mi">0000001</span><span class="n">d</span><span class="w">  </span><span class="n">mov</span><span class="w">         </span><span class="n">ecx</span><span class="p">,</span><span class="n">ebx</span><span class="w"> </span>
<span class="mi">0000001</span><span class="n">f</span><span class="w">  </span><span class="nb">call</span><span class="w">        </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="n">ds</span><span class="p">:[</span><span class="mi">002</span><span class="n">F0010h</span><span class="p">]</span>

<span class="c1">// increment oVec.x</span>
<span class="mi">00000025</span><span class="w">  </span><span class="n">inc</span><span class="w">         </span><span class="n">esi</span>

<span class="c1">// loop back to 0000000C if oVec.x &lt; 2</span>
<span class="mi">00000026</span><span class="w">  </span><span class="n">cmp</span><span class="w">         </span><span class="n">esi</span><span class="p">,</span><span class="mi">2</span><span class="w"> </span>
<span class="mi">00000029</span><span class="w">  </span><span class="n">jl</span><span class="w">          </span><span class="mi">0000000</span><span class="n">C</span>

<span class="c1">// restore context and return</span>
<span class="mi">0000002</span><span class="n">b</span><span class="w">  </span><span class="n">pop</span><span class="w">         </span><span class="n">ebx</span><span class="w">  </span>
<span class="mi">0000002</span><span class="n">c</span><span class="w">  </span><span class="n">pop</span><span class="w">         </span><span class="n">esi</span><span class="w">  </span>
<span class="mi">0000002</span><span class="n">d</span><span class="w">  </span><span class="n">pop</span><span class="w">         </span><span class="n">edi</span><span class="w">  </span>
<span class="mi">0000002</span><span class="n">e</span><span class="w">  </span><span class="n">pop</span><span class="w">         </span><span class="n">ebp</span><span class="w">  </span>
<span class="mi">0000002</span><span class="n">f</span><span class="w">  </span><span class="n">ret</span>
</pre></div>

<p>This looks like an optimization gone bad to me...</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/why-are-c-4-optional-parameters-defined-on-interface-not-enforced-on-implementing-class/" class="u-url">Why are C# 4 optional parameters defined on interface not enforced on implementing class?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/why-are-c-4-optional-parameters-defined-on-interface-not-enforced-on-implementing-class/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T18:44:54+08:00" itemprop="datePublished" title="2023-03-03 18:44">2023-03-03 18:44</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I noticed that with the optional parameters in C# 4 if you specify an optional
parameter on an interface you <strong><em>don,t</em></strong> have to make that parameter optional
on any implementing class:</p>
<div class="code"><pre class="code literal-block">public interface MyInterface
{
    void TestMethod(bool flag = false);
}

public class MyClass : MyInterface
{
    public void TestMethod(bool flag)
    {
        Console.WriteLine(flag);
    }
}
</pre></div>

<p>and therefore:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MyClass</span><span class="p">();</span><span class="w">        </span>
<span class="n">obj</span><span class="o">.</span><span class="n">TestMethod</span><span class="p">();</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="n">error</span>

<span class="k">var</span><span class="w"> </span><span class="n">obj2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MyClass</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">MyInterface</span><span class="p">;</span>
<span class="n">obj2</span><span class="o">.</span><span class="n">TestMethod</span><span class="p">();</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">prints</span><span class="w"> </span><span class="bp">false</span>
</pre></div>

<p>Does anyone know why optional parameters are designed to work this way?</p>
<p>On one hand I suppose the ability to override any default values specified on
the interfaces is useful though to be honest I'm not sure if you should even
be able to specify default values on the interface as that should be an
implementation decision.</p>
<p>On the other hand, this disconnect means you can't always use the concrete
class and the interface interchangeably. This of course, wouldn't be a problem
if the default value is specified on the implementation, but then if you're
exposing your concrete class as the interface (using some IOC framework to
inject the concrete class for instance) then really there's no point having
the default value as the caller will have to always provide it anyway.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>UPDATE: This question was the subject of my blog on May 12th 2011. Thanks for
the great question!</p>
<p>Suppose you have an interface as you describe, and a hundred classes that
implement it. Then you decide to make one of the parameters of one of the
interface's methods optional. Are you suggesting that the right thing to do is
for the compiler to force the developer to find every implementation of that
interface method, and make the parameter optional as well?</p>
<p>Suppose we did that. Now suppose the developer did not have the source code
for the implementation:</p>
<hr>
<div class="code"><pre class="code literal-block"><span class="c1">// in metadata:</span>
<span class="n">public</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="n">B</span><span class="w"> </span>
<span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">TestMethod</span><span class="p">(</span><span class="n">bool</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</pre></div>

<hr>
<div class="code"><pre class="code literal-block"><span class="c1">// in source code</span>
<span class="n">interface</span><span class="w"> </span><span class="n">MyInterface</span><span class="w"> </span>
<span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="n">void</span><span class="w"> </span><span class="n">TestMethod</span><span class="p">(</span><span class="n">bool</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">false</span><span class="p">);</span><span class="w"> </span>
<span class="p">}</span>
<span class="n">class</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">MyInterface</span><span class="w"> </span><span class="p">{}</span>
<span class="c1">// Legal because D's base class has a public method </span>
<span class="c1">// that implements the interface method</span>
</pre></div>

<p>How is the author of D supposed to make this work? Are they required in your
world to call up the author of B on the phone and ask them to please ship them
a new version of B that makes the method have an optional parameter?</p>
<p>That's not going to fly. What if <em>two</em> people call up the author of B, and one
of them wants the default to be true and one of them wants it to be false?
What if the author of B simply refuses to play along?</p>
<p>Perhaps in that case they would be required to say:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span> <span class="n">D</span> : <span class="n">B</span>, <span class="n">MyInterface</span> 
{
    <span class="n">public</span> <span class="nb">new</span> <span class="n">void</span> <span class="n">TestMethod</span>(<span class="n">bool</span> <span class="n">b</span> = <span class="n">false</span>)
    {
        <span class="nb">base</span>.<span class="n">TestMethod</span>(<span class="n">b</span>);
    }
}
</pre></div>

<p>The proposed feature seems to add a lot of inconvenience for the programmer
with no corresponding increase in representative power. What's the compelling
benefit of this feature which justifies the increased cost to the user?</p>
<hr>
<p>UPDATE: In the comments below, supercat suggests a language feature that would
genuinely add power to the language and enable some scenarios similar to the
one described in this question. FYI, that feature -- default implementations
of methods in interfaces -- will be added to C# 8.</p>
<p><br></p>
<h3>Suggest</h3>
<p>An optional parameter is just tagged with an attribute. This attribute tells
the compiler to insert the default value for that parameter at the call-site.</p>
<p>The call <code>obj2.TestMethod();</code> is replaced by <code>obj2.TestMethod(false);</code> when
the C# code gets compiled to IL, and not at JIT-time.</p>
<p>So in a way it's always the caller providing the default value with optional
parameters. This also has consequences on binary versioning: If you change the
default value but don't recompile the calling code it will continue to use the
old default value.</p>
<blockquote>
<p>On the other hand, this disconnect means you can't always use the concrete
class and the interface interchangeably.</p>
</blockquote>
<p>You already can't do that if the interface method was implemented explicitly.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/system-currenttimemillis-vs-system-nanotime/" class="u-url">System.currentTimeMillis vs System.nanoTime</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/system-currenttimemillis-vs-system-nanotime/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T18:43:34+08:00" itemprop="datePublished" title="2023-03-03 18:43">2023-03-03 18:43</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <h3><strong>Accuracy Vs. Precision</strong></h3>
<p>What I would like to know is whether I should use
<strong>System.currentTimeMillis()</strong> or <strong>System.nanoTime()</strong> when updating my
object's positions in my game? Their change in movement is directly
proportional to the elapsed time since the last call and I want to be as
precise as possible.</p>
<p>I've read that there are some serious time-resolution issues between different
operating systems (namely that Mac / Linux have an almost 1 ms resolution
while Windows has a 50ms resolution??). I'm primarly running my apps on
windows and 50ms resolution seems pretty inaccurate.</p>
<p>Are there better options than the two I listed?</p>
<p>Any suggestions / comments?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>If you're just looking for extremely precise measurements of <strong>elapsed time</strong>
, use <code>System.nanoTime()</code>. <code>System.currentTimeMillis()</code> will give you the most
accurate possible elapsed time in milliseconds since the epoch, but
<code>System.nanoTime()</code> gives you a nanosecond-precise time, relative to some
arbitrary point.</p>
<p>From the Java Documentation:</p>
<blockquote>
<div class="code"><pre class="code literal-block">public static long nanoTime()
</pre></div>

<p>Returns the current value of the most precise available system timer, in
nanoseconds.</p>
<p>This method can only be used to measure elapsed time and is not related to
any other notion of system or wall-clock time. The value returned represents
nanoseconds since some fixed but arbitrary <em>origin</em> time (perhaps in the
future, so values may be negative). This method provides nanosecond
precision, but not necessarily nanosecond accuracy. No guarantees are made
about how frequently values change. Differences in successive calls that
span greater than approximately 292 years (263 nanoseconds) will not
accurately compute elapsed time due to numerical overflow.</p>
</blockquote>
<p>For example, to measure how long some code takes to execute:</p>
<div class="code"><pre class="code literal-block">long startTime = System.nanoTime();    
// ... the code being measured ...    
long estimatedTime = System.nanoTime() - startTime;
</pre></div>

<p>See also: JavaDoc System.nanoTime() and JavaDoc System.currentTimeMillis() for
more info.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Since no one else has mentioned this…</p>
<p>It is not safe to compare the results of <code>System.nanoTime()</code> calls between
different JVMs, each JVM may have an independent 'origin' time.</p>
<p><code>System.currentTimeMillis()</code> will return the (approximate) same value between
JVMs, because it is tied to the system wall clock time.</p>
<p>If you want to compute the amount of time that has elapsed between two events,
like a stopwatch, use <code>nanoTime()</code>; changes in the system wall-clock make
<code>currentTimeMillis()</code> incorrect for this use case.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2152.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2150.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
