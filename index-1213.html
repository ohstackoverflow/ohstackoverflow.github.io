<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1213) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1213.html">
<link rel="prev" href="index-1214.html" type="text/html">
<link rel="next" href="index-1212.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-to-set-the-authorization-header-using-curl/" class="u-url">How to set the authorization header using cURL</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-to-set-the-authorization-header-using-curl/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T03:57:30+08:00" itemprop="datePublished" title="2023-02-18 03:57">2023-02-18 03:57</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>How do I pass authorization header using cURL? ( executable in
<code>/usr/bin/curl</code>).</p>
<p><br><br></p>
<h2>Answer</h2>
<p>http://curl.se/docs/httpscripting.html</p>
<p>See part 6. HTTP Authentication</p>
<blockquote>
<p>HTTP Authentication</p>
<p>HTTP Authentication is the ability to tell the server your username and
password so that it can verify that you're allowed to do the request you're
doing. The Basic authentication used in HTTP (which is the type curl uses by
default) is <em>plain</em> <em>text</em> based, which means it sends username and password
only slightly obfuscated, but still fully readable by anyone that sniffs on
the network between you and the remote server.</p>
<p>To tell curl to use a user and password for authentication:</p>
<div class="code"><pre class="code literal-block">curl --user name:password http://www.example.com
</pre></div>

<p>The site might require a different authentication method (check the headers
returned by the server), and then --ntlm, --digest, --negotiate or even
--anyauth might be options that suit you.</p>
<p>Sometimes your HTTP access is only available through the use of a HTTP
proxy. This seems to be especially common at various companies. A HTTP proxy
may require its own user and password to allow the client to get through to
the Internet. To specify those with curl, run something like:</p>
<div class="code"><pre class="code literal-block">curl --proxy-user proxyuser:proxypassword curl.haxx.se
</pre></div>

<p>If your proxy requires the authentication to be done using the NTLM method,
use --proxy-ntlm, if it requires Digest use --proxy-digest.</p>
<p>If you use any one these user+password options but leave out the password
part, curl will prompt for the password interactively.</p>
<p>Do note that when a program is run, its parameters might be possible to see
when listing the running processes of the system. Thus, other users may be
able to watch your passwords if you pass them as plain command line options.
There are ways to circumvent this.</p>
<p>It is worth noting that while this is how HTTP Authentication works, very
many web sites will not use this concept when they provide logins etc. See
the Web Login chapter further below for more details on that.</p>
</blockquote>
<p><br></p>
<h3>Suggest</h3>
<p>Just adding so you don't have to click-through:</p>
<div class="code"><pre class="code literal-block">curl --user name:password http://www.example.com
</pre></div>

<p>or if you're trying to do send authentication for OAuth 2:</p>
<div class="code"><pre class="code literal-block">curl -H "Authorization: OAuth &lt;ACCESS_TOKEN&gt;" http://www.example.com
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-to-get-the-last-char-of-a-string-in-php/" class="u-url">How to get the last char of a string in PHP?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-to-get-the-last-char-of-a-string-in-php/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T03:57:03+08:00" itemprop="datePublished" title="2023-02-18 03:57">2023-02-18 03:57</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I need to get the last character of a string. Say I have "testers" as input
string and I want the result to be "s". how can I do that in PHP?</p>
<p><br><br></p>
<h2>Answer</h2>
<div class="code"><pre class="code literal-block">substr("testers", -1); // returns "s"
</pre></div>

<p>Or, for multibyte strings :</p>
<div class="code"><pre class="code literal-block">mb_substr("multibyte string…", -1); // returns "…"
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<div class="code"><pre class="code literal-block">substr($string, -1)
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/nginx-no-www-to-www-and-www-to-no-www/" class="u-url">Nginx no-www to www and www to no-www</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/nginx-no-www-to-www-and-www-to-no-www/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T03:56:36+08:00" itemprop="datePublished" title="2023-02-18 03:56">2023-02-18 03:56</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I am using nginx on Rackspace cloud following a tutorial and having searched
the net and so far can't get this sorted.</p>
<p>I want <code>www.mysite.example</code> to go to <code>mysite.example</code> as normal in .htaccess
for SEO and other reasons.</p>
<p>My <strong>/etc/nginx/sites-available/www.example.com.vhost</strong> config:</p>
<div class="code"><pre class="code literal-block"><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">       </span><span class="n">server_name</span><span class="w"> </span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">       </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">web</span><span class="p">;</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">http_host</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"www.example.com"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                 </span><span class="n">rewrite</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">$</span><span class="n">request_uri</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
</pre></div>

<p>I have also tried</p>
<div class="code"><pre class="code literal-block"><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">       </span><span class="n">server_name</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">       </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">web</span><span class="p">;</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">http_host</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"www.example.com"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                 </span><span class="n">rewrite</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">$</span><span class="n">request_uri</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
</pre></div>

<p>I also tried. Both the second attempts give redirect loop errors.</p>
<div class="code"><pre class="code literal-block"><span class="nt">if</span><span class="w"> </span><span class="o">($</span><span class="nt">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'www.example.com'</span><span class="w"> </span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="err">rewrite</span><span class="w"> </span><span class="err">^</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="err">$</span><span class="n">uri</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>My DNS is setup as standard:</p>
<div class="code"><pre class="code literal-block">site.example 192.192.6.8 A type at 300 seconds
www.site.example 192.192.6.8 A type at 300 seconds
</pre></div>

<p>(example IPs and folders have been used for examples and to help people in
future). I use Ubuntu 11.</p>
<p><br><br></p>
<h2>Answer</h2>
<h2>HTTP Solution</h2>
<p>From the documentation, "the right way is to define a separate server for
<code>example.org</code>":</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">listen</span><span class="w">       </span><span class="err">80</span><span class="p">;</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">return</span><span class="w">       </span><span class="err">301</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">listen</span><span class="w">       </span><span class="err">80</span><span class="p">;</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">www.example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">...</span>
<span class="p">}</span>
</pre></div>

<h2>HTTPS Solution</h2>
<p>For those who want a solution including <code>https://</code>...</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">listen</span><span class="w"> </span><span class="err">80</span><span class="p">;</span>
<span class="w">        </span><span class="err">server_name</span><span class="w"> </span><span class="err">www.domain.example</span><span class="p">;</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="err">$scheme</span><span class="w"> </span><span class="err">will</span><span class="w"> </span><span class="err">get</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">http</span><span class="w"> </span><span class="err">protocol</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">301</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">best</span><span class="w"> </span><span class="err">practice</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">tablet,</span><span class="w"> </span><span class="err">phone,</span><span class="w"> </span><span class="err">desktop</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">seo</span>
<span class="w">        </span><span class="err">return</span><span class="w"> </span><span class="err">301</span><span class="w"> </span><span class="err">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//</span><span class="n">domain</span><span class="o">.</span><span class="n">example</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">listen</span><span class="w"> </span><span class="err">80</span><span class="p">;</span>
<span class="w">        </span><span class="err">server_name</span><span class="w"> </span><span class="err">domain.example</span><span class="p">;</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="err">here</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">config</span><span class="w"> </span><span class="err">file</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="err">example</span>
<span class="w">        </span><span class="err">location</span><span class="w"> </span><span class="err">/</span><span class="w"> </span><span class="err">{</span>

<span class="w">            </span><span class="err">rewrite</span><span class="w"> </span><span class="err">^/cp/login?$</span><span class="w"> </span><span class="err">/cp/login.php</span><span class="w"> </span><span class="err">last</span><span class="p">;</span>
<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="err">etc</span><span class="w"> </span><span class="err">etc...</span>

<span class="w">        </span><span class="p">}</span>
<span class="err">}</span>
</pre></div>

<p>Note: I have not originally included <code>https://</code> in my solution since we use
loadbalancers and our https:// server is a high-traffic SSL payment server: we
do not mix https:// and http://.</p>
<hr>
<p>To check the Nginx version, use <code>nginx -v</code>.</p>
<p><strong>Strip www from URL with Nginx redirect</strong></p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">www.domain.example</span><span class="p">;</span>
<span class="w">    </span><span class="err">rewrite</span><span class="w"> </span><span class="err">^(.*)</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">domain</span><span class="o">.</span><span class="n">example</span><span class="err">$</span><span class="mi">1</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">domain.example</span><span class="p">;</span>
<span class="w">    </span><span class="err">#The</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">configuration</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">here#</span>
<span class="p">}</span>
</pre></div>

<p>So you need to have TWO server codes.</p>
<p><strong>Add the www to the URL with Nginx redirect</strong></p>
<p>If what you need is the opposite, to redirect from <code>domain.example</code> to
<code>www.domain.example</code>, you can use this:</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">domain.example</span><span class="p">;</span>
<span class="w">    </span><span class="err">rewrite</span><span class="w"> </span><span class="err">^(.*)</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">example</span><span class="err">$</span><span class="mi">1</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">www.domain.example</span><span class="p">;</span>
<span class="w">    </span><span class="err">#The</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">configuration</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">here#</span>
<span class="p">}</span>
</pre></div>

<p>As you can imagine, this is just the opposite and works the same way the first
example. This way, you don't get SEO marks down, as it is complete perm
redirect and move. The no WWW is forced and the directory shown!</p>
<h3>Some of my code shown below for a better view:</h3>
<div class="code"><pre class="code literal-block"><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w">  </span><span class="n">www</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">rewrite</span><span class="w"> </span><span class="o">^</span><span class="p">(</span><span class="o">.*</span><span class="p">)</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">$</span><span class="mi">1</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">       </span><span class="n">server_name</span><span class="w"> </span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">       </span><span class="n">index</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">html</span><span class="p">;</span>
<span class="w">       </span><span class="c1">####</span>
<span class="w">       </span><span class="c1"># now pull the site from one directory #</span>
<span class="w">       </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">www</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">web</span><span class="p">;</span>
<span class="w">       </span><span class="c1"># done #</span>
<span class="w">       </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">favicon</span><span class="o">.</span><span class="n">ico</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">                </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>Actually you don't even need a rewrite.</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">#listen</span><span class="w"> </span><span class="err">80</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">default</span>
<span class="w">    </span><span class="err">server_name</span><span class="w"> </span><span class="err">www.example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">301</span><span class="w"> </span><span class="err">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">#listen</span><span class="w"> </span><span class="err">80</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">default</span>
<span class="w">    </span><span class="err">server_name</span><span class="w"> </span><span class="err">example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">##</span><span class="w"> </span><span class="err">here</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">conf...</span>
<span class="p">}</span>
</pre></div>

<p>As my answer is getting more and more up votes but the above as well. You
should never use a <code>rewrite</code> in this context. Why? Because nginx has to
process and start a search. If you use <code>return</code> (which should be available in
any nginx version) it directly stops execution. This is preferred in any
context.</p>
<p>Redirect both, non-SSL and SSL to their non-www counterpart:</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">listen</span><span class="w">               </span><span class="err">80</span><span class="p">;</span>
<span class="w">    </span><span class="err">listen</span><span class="w">               </span><span class="err">443</span><span class="w"> </span><span class="err">ssl</span><span class="p">;</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">          </span><span class="err">www.example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">ssl_certificate</span><span class="w">      </span><span class="err">path/to/cert</span><span class="p">;</span>
<span class="w">    </span><span class="err">ssl_certificate_key</span><span class="w">  </span><span class="err">path/to/key</span><span class="p">;</span>

<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">301</span><span class="w"> </span><span class="err">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">listen</span><span class="w">               </span><span class="err">80</span><span class="p">;</span>
<span class="w">    </span><span class="err">listen</span><span class="w">               </span><span class="err">443</span><span class="w"> </span><span class="err">ssl</span><span class="p">;</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">          </span><span class="err">example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">ssl_certificate</span><span class="w">      </span><span class="err">path/to/cert</span><span class="p">;</span>
<span class="w">    </span><span class="err">ssl_certificate_key</span><span class="w">  </span><span class="err">path/to/key</span><span class="p">;</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">here...</span>
<span class="p">}</span>
</pre></div>

<p>The <code>$scheme</code> variable will only contain <code>http</code> if your server is only
listening on port 80 (default) and the listen option does not contain the
<code>ssl</code> keyword. Not using the variable will not gain you any performance.</p>
<p>Note that you need even more server blocks if you use HSTS, because the HSTS
headers should not be sent over non-encrypted connections. Hence, you need
unencrypted server blocks with redirects and encrypted server blocks with
redirects and HSTS headers.</p>
<p>Redirect everything to SSL (personal config on UNIX with IPv4, IPv6, SPDY,
...):</p>
<div class="code"><pre class="code literal-block"><span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="n">Redirect</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">www</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">www</span>
<span class="err">#</span>
<span class="n">server</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w">          </span><span class="n">www</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate</span><span class="w">      </span><span class="n">ssl</span><span class="o">/</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">crt</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate_key</span><span class="w">  </span><span class="n">ssl</span><span class="o">/</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="k">key</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">*</span><span class="err">:</span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">*</span><span class="err">:</span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">spdy</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">[</span><span class="n">::</span><span class="o">]</span><span class="err">:</span><span class="mi">80</span><span class="w"> </span><span class="n">ipv6only</span><span class="o">=</span><span class="k">on</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">[</span><span class="n">::</span><span class="o">]</span><span class="err">:</span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">spdy</span><span class="w"> </span><span class="n">ipv6only</span><span class="o">=</span><span class="k">on</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="err">}</span>

<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="n">Redirect</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">encrypted</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">encrypted</span>
<span class="err">#</span>
<span class="n">server</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w">          </span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">*</span><span class="err">:</span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">[</span><span class="n">::</span><span class="o">]</span><span class="err">:</span><span class="mi">80</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="err">}</span>

<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="n">There</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="k">go</span><span class="err">!</span>
<span class="err">#</span>
<span class="n">server</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w">          </span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate</span><span class="w">      </span><span class="n">ssl</span><span class="o">/</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">crt</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate_key</span><span class="w">  </span><span class="n">ssl</span><span class="o">/</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="k">key</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">*</span><span class="err">:</span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">spdy</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">[</span><span class="n">::</span><span class="o">]</span><span class="err">:</span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">spdy</span><span class="p">;</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">rest</span><span class="w"> </span><span class="n">goes</span><span class="w"> </span><span class="n">here</span><span class="p">...</span>
<span class="err">}</span>
</pre></div>

<p>I guess you can imagine other compounds with this pattern now by yourself.</p>
<p>More of my configs? Go here and here.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1214.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1212.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
