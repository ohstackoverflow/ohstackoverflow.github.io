<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1635) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1635.html">
<link rel="prev" href="index-1636.html" type="text/html">
<link rel="next" href="index-1634.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/most-efficient-way-to-increment-a-map-value-in-java/" class="u-url">Most efficient way to increment a Map value in Java</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/most-efficient-way-to-increment-a-map-value-in-java/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T05:43:59+08:00" itemprop="datePublished" title="2023-03-03 05:43">2023-03-03 05:43</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I hope this question is not considered too basic for this forum, but we'll
see. I'm wondering how to refactor some code for better performance that is
getting run a bunch of times.</p>
<p>Say I'm creating a word frequency list, using a Map (probably a HashMap),
where each key is a String with the word that's being counted and the value is
an Integer that's incremented each time a token of the word is found.</p>
<p>In Perl, incrementing such a value would be trivially easy:</p>
<div class="code"><pre class="code literal-block"><span class="x">$map</span><span class="cp">{</span><span class="nv">$word</span><span class="cp">}</span><span class="x">++;</span>
</pre></div>

<p>But in Java, it's much more complicated. Here the way I'm currently doing it:</p>
<div class="code"><pre class="code literal-block">int count = map.containsKey(word) ? map.get(word) : 0;
map.put(word, count + 1);
</pre></div>

<p>Which of course relies on the autoboxing feature in the newer Java versions. I
wonder if you can suggest a more efficient way of incrementing such a value.
Are there even good performance reasons for eschewing the Collections
framework and using a something else instead?</p>
<p>Update: I've done a test of several of the answers. See below.</p>
<p><br><br></p>
<h2>Answer</h2>
<h3>Some test results</h3>
<p>I've gotten a lot of good answers to this question--thanks folks--so I decided
to run some tests and figure out which method is actually fastest. The five
methods I tested are these:</p>
<ul>
<li>the "ContainsKey" method that I presented in the question</li>
<li>the "TestForNull" method suggested by Aleksandar Dimitrov</li>
<li>the "AtomicLong" method suggested by Hank Gay</li>
<li>the "Trove" method suggested by jrudolph</li>
<li>the "MutableInt" method suggested by phax.myopenid.com</li>
</ul>
<h3>Method</h3>
<p>Here's what I did...</p>
<ol>
<li>created five classes that were identical except for the differences shown below. Each class had to perform an operation typical of the scenario I presented: opening a 10MB file and reading it in, then performing a frequency count of all the word tokens in the file. Since this took an average of only 3 seconds, I had it perform the frequency count (not the I/O) 10 times.</li>
<li>timed the loop of 10 iterations but <em>not the I/O operation</em> and recorded the total time taken (in clock seconds) essentially using Ian Darwin's method in the Java Cookbook.</li>
<li>performed all five tests in series, and then did this another three times.</li>
<li>averaged the four results for each method.</li>
</ol>
<h3>Results</h3>
<p>I'll present the results first and the code below for those who are
interested.</p>
<p>The <strong>ContainsKey</strong> method was, as expected, the slowest, so I'll give the
speed of each method in comparison to the speed of that method.</p>
<ul>
<li>
<strong>ContainsKey:</strong> 30.654 seconds (baseline)</li>
<li>
<strong>AtomicLong:</strong> 29.780 seconds (1.03 times as fast)</li>
<li>
<strong>TestForNull:</strong> 28.804 seconds (1.06 times as fast)</li>
<li>
<strong>Trove:</strong> 26.313 seconds (1.16 times as fast)</li>
<li>
<strong>MutableInt:</strong> 25.747 seconds (1.19 times as fast)</li>
</ul>
<h3>Conclusions</h3>
<p>It would appear that only the MutableInt method and the Trove method are
significantly faster, in that only they give a performance boost of more than
10%. However, if threading is an issue, AtomicLong might be more attractive
than the others (I'm not really sure). I also ran TestForNull with <code>final</code>
variables, but the difference was negligible.</p>
<p>Note that I haven't profiled memory usage in the different scenarios. I'd be
happy to hear from anybody who has good insights into how the MutableInt and
Trove methods would be likely to affect memory usage.</p>
<p>Personally, I find the MutableInt method the most attractive, since it doesn't
require loading any third-party classes. So unless I discover problems with
it, that's the way I'm most likely to go.</p>
<h3>The code</h3>
<p>Here is the crucial code from each method.</p>
<h4>ContainsKey</h4>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>
<span class="o">...</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span><span class="p">();</span>
<span class="o">...</span>
<span class="nb">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">freq</span><span class="o">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="err">?</span> <span class="n">freq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">freq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>

<h4>TestForNull</h4>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>
<span class="o">...</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span><span class="p">();</span>
<span class="o">...</span>
<span class="n">Integer</span> <span class="n">count</span> <span class="o">=</span> <span class="n">freq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">freq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="n">freq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<h4>AtomicLong</h4>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="p">;</span>
<span class="o">...</span>
<span class="n">final</span> <span class="n">ConcurrentMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">AtomicLong</span><span class="o">&gt;</span> <span class="nb">map</span> <span class="o">=</span> 
    <span class="n">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">AtomicLong</span><span class="o">&gt;</span><span class="p">();</span>
<span class="o">...</span>
<span class="nb">map</span><span class="o">.</span><span class="n">putIfAbsent</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">new</span> <span class="n">AtomicLong</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="nb">map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="o">.</span><span class="n">incrementAndGet</span><span class="p">();</span>
</pre></div>

<h4>Trove</h4>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">gnu.trove.TObjectIntHashMap</span><span class="p">;</span>
<span class="o">...</span>
<span class="n">TObjectIntHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">new</span> <span class="n">TObjectIntHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>
<span class="o">...</span>
<span class="n">freq</span><span class="o">.</span><span class="n">adjustOrPutValue</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>

<h4>MutableInt</h4>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">MutableInt</span> <span class="p">{</span>
  <span class="nb">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">//</span> <span class="n">note</span> <span class="n">that</span> <span class="n">we</span> <span class="n">start</span> <span class="n">at</span> <span class="mi">1</span> <span class="n">since</span> <span class="n">we</span><span class="s1">'re counting</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">increment</span> <span class="p">()</span> <span class="p">{</span> <span class="o">++</span><span class="n">value</span><span class="p">;</span>      <span class="p">}</span>
  <span class="n">public</span> <span class="nb">int</span>  <span class="n">get</span> <span class="p">()</span>       <span class="p">{</span> <span class="k">return</span> <span class="n">value</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
<span class="o">...</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">MutableInt</span><span class="o">&gt;</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">MutableInt</span><span class="o">&gt;</span><span class="p">();</span>
<span class="o">...</span>
<span class="n">MutableInt</span> <span class="n">count</span> <span class="o">=</span> <span class="n">freq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">freq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">new</span> <span class="n">MutableInt</span><span class="p">());</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="n">count</span><span class="o">.</span><span class="n">increment</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<h3>Some test results</h3>
<p>I've gotten a lot of good answers to this question--thanks folks--so I decided
to run some tests and figure out which method is actually fastest. The five
methods I tested are these:</p>
<ul>
<li>the "ContainsKey" method that I presented in the question</li>
<li>the "TestForNull" method suggested by Aleksandar Dimitrov</li>
<li>the "AtomicLong" method suggested by Hank Gay</li>
<li>the "Trove" method suggested by jrudolph</li>
<li>the "MutableInt" method suggested by phax.myopenid.com</li>
</ul>
<h3>Method</h3>
<p>Here's what I did...</p>
<ol>
<li>created five classes that were identical except for the differences shown below. Each class had to perform an operation typical of the scenario I presented: opening a 10MB file and reading it in, then performing a frequency count of all the word tokens in the file. Since this took an average of only 3 seconds, I had it perform the frequency count (not the I/O) 10 times.</li>
<li>timed the loop of 10 iterations but <em>not the I/O operation</em> and recorded the total time taken (in clock seconds) essentially using Ian Darwin's method in the Java Cookbook.</li>
<li>performed all five tests in series, and then did this another three times.</li>
<li>averaged the four results for each method.</li>
</ol>
<h3>Results</h3>
<p>I'll present the results first and the code below for those who are
interested.</p>
<p>The <strong>ContainsKey</strong> method was, as expected, the slowest, so I'll give the
speed of each method in comparison to the speed of that method.</p>
<ul>
<li>
<strong>ContainsKey:</strong> 30.654 seconds (baseline)</li>
<li>
<strong>AtomicLong:</strong> 29.780 seconds (1.03 times as fast)</li>
<li>
<strong>TestForNull:</strong> 28.804 seconds (1.06 times as fast)</li>
<li>
<strong>Trove:</strong> 26.313 seconds (1.16 times as fast)</li>
<li>
<strong>MutableInt:</strong> 25.747 seconds (1.19 times as fast)</li>
</ul>
<h3>Conclusions</h3>
<p>It would appear that only the MutableInt method and the Trove method are
significantly faster, in that only they give a performance boost of more than
10%. However, if threading is an issue, AtomicLong might be more attractive
than the others (I'm not really sure). I also ran TestForNull with <code>final</code>
variables, but the difference was negligible.</p>
<p>Note that I haven't profiled memory usage in the different scenarios. I'd be
happy to hear from anybody who has good insights into how the MutableInt and
Trove methods would be likely to affect memory usage.</p>
<p>Personally, I find the MutableInt method the most attractive, since it doesn't
require loading any third-party classes. So unless I discover problems with
it, that's the way I'm most likely to go.</p>
<h3>The code</h3>
<p>Here is the crucial code from each method.</p>
<h4>ContainsKey</h4>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>
<span class="o">...</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span><span class="p">();</span>
<span class="o">...</span>
<span class="nb">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">freq</span><span class="o">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="err">?</span> <span class="n">freq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">freq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>

<h4>TestForNull</h4>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>
<span class="o">...</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span><span class="p">();</span>
<span class="o">...</span>
<span class="n">Integer</span> <span class="n">count</span> <span class="o">=</span> <span class="n">freq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">freq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="n">freq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<h4>AtomicLong</h4>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="p">;</span>
<span class="o">...</span>
<span class="n">final</span> <span class="n">ConcurrentMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">AtomicLong</span><span class="o">&gt;</span> <span class="nb">map</span> <span class="o">=</span> 
    <span class="n">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">AtomicLong</span><span class="o">&gt;</span><span class="p">();</span>
<span class="o">...</span>
<span class="nb">map</span><span class="o">.</span><span class="n">putIfAbsent</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">new</span> <span class="n">AtomicLong</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="nb">map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="o">.</span><span class="n">incrementAndGet</span><span class="p">();</span>
</pre></div>

<h4>Trove</h4>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">gnu.trove.TObjectIntHashMap</span><span class="p">;</span>
<span class="o">...</span>
<span class="n">TObjectIntHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">new</span> <span class="n">TObjectIntHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>
<span class="o">...</span>
<span class="n">freq</span><span class="o">.</span><span class="n">adjustOrPutValue</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>

<h4>MutableInt</h4>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">MutableInt</span> <span class="p">{</span>
  <span class="nb">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">//</span> <span class="n">note</span> <span class="n">that</span> <span class="n">we</span> <span class="n">start</span> <span class="n">at</span> <span class="mi">1</span> <span class="n">since</span> <span class="n">we</span><span class="s1">'re counting</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">increment</span> <span class="p">()</span> <span class="p">{</span> <span class="o">++</span><span class="n">value</span><span class="p">;</span>      <span class="p">}</span>
  <span class="n">public</span> <span class="nb">int</span>  <span class="n">get</span> <span class="p">()</span>       <span class="p">{</span> <span class="k">return</span> <span class="n">value</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
<span class="o">...</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">MutableInt</span><span class="o">&gt;</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">MutableInt</span><span class="o">&gt;</span><span class="p">();</span>
<span class="o">...</span>
<span class="n">MutableInt</span> <span class="n">count</span> <span class="o">=</span> <span class="n">freq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">freq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">new</span> <span class="n">MutableInt</span><span class="p">());</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="n">count</span><span class="o">.</span><span class="n">increment</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/android-how-to-handle-right-to-left-swipe-gestures/" class="u-url">Android: How to handle right to left swipe gestures</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/android-how-to-handle-right-to-left-swipe-gestures/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T05:43:25+08:00" itemprop="datePublished" title="2023-03-03 05:43">2023-03-03 05:43</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I want my app to recognize when a user swipes from right to left on the phone
screen.</p>
<p>How to do this?</p>
<p><br><br></p>
<h2>Answer</h2>
<p><em>OnSwipeTouchListener.java</em> :</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">android.content.Context</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">android.view.GestureDetector</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">android.view.GestureDetector.SimpleOnGestureListener</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">android.view.MotionEvent</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">android.view.View.OnTouchListener</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">OnSwipeTouchListener</span> <span class="n">implements</span> <span class="n">OnTouchListener</span> <span class="p">{</span>

    <span class="n">private</span> <span class="n">final</span> <span class="n">GestureDetector</span> <span class="n">gestureDetector</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">OnSwipeTouchListener</span> <span class="p">(</span><span class="n">Context</span> <span class="n">ctx</span><span class="p">){</span>
        <span class="n">gestureDetector</span> <span class="o">=</span> <span class="n">new</span> <span class="n">GestureDetector</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">new</span> <span class="n">GestureListener</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">boolean</span> <span class="n">onTouch</span><span class="p">(</span><span class="n">View</span> <span class="n">v</span><span class="p">,</span> <span class="n">MotionEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">gestureDetector</span><span class="o">.</span><span class="n">onTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">private</span> <span class="n">final</span> <span class="k">class</span> <span class="nc">GestureListener</span> <span class="n">extends</span> <span class="n">SimpleOnGestureListener</span> <span class="p">{</span>

        <span class="n">private</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">SWIPE_THRESHOLD</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
        <span class="n">private</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">SWIPE_VELOCITY_THRESHOLD</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

        <span class="nd">@Override</span>
        <span class="n">public</span> <span class="n">boolean</span> <span class="n">onDown</span><span class="p">(</span><span class="n">MotionEvent</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nd">@Override</span>
        <span class="n">public</span> <span class="n">boolean</span> <span class="n">onFling</span><span class="p">(</span><span class="n">MotionEvent</span> <span class="n">e1</span><span class="p">,</span> <span class="n">MotionEvent</span> <span class="n">e2</span><span class="p">,</span> <span class="nb">float</span> <span class="n">velocityX</span><span class="p">,</span> <span class="nb">float</span> <span class="n">velocityY</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="nb">float</span> <span class="n">diffY</span> <span class="o">=</span> <span class="n">e2</span><span class="o">.</span><span class="n">getY</span><span class="p">()</span> <span class="o">-</span> <span class="n">e1</span><span class="o">.</span><span class="n">getY</span><span class="p">();</span>
                <span class="nb">float</span> <span class="n">diffX</span> <span class="o">=</span> <span class="n">e2</span><span class="o">.</span><span class="n">getX</span><span class="p">()</span> <span class="o">-</span> <span class="n">e1</span><span class="o">.</span><span class="n">getX</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diffX</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diffY</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diffX</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SWIPE_THRESHOLD</span> <span class="o">&amp;&amp;</span> <span class="n">Math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">velocityX</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SWIPE_VELOCITY_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">diffX</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">onSwipeRight</span><span class="p">();</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="n">onSwipeLeft</span><span class="p">();</span>
                        <span class="p">}</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diffY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SWIPE_THRESHOLD</span> <span class="o">&amp;&amp;</span> <span class="n">Math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">velocityY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SWIPE_VELOCITY_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">diffY</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">onSwipeBottom</span><span class="p">();</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">onSwipeTop</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">exception</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">exception</span><span class="o">.</span><span class="n">printStackTrace</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">onSwipeRight</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">onSwipeLeft</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">onSwipeTop</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">onSwipeBottom</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Usage:</p>
<div class="code"><pre class="code literal-block"><span class="nv">imageView</span>.<span class="nv">setOnTouchListener</span><span class="ss">(</span><span class="nv">new</span><span class="w"> </span><span class="nv">OnSwipeTouchListener</span><span class="ss">(</span><span class="nv">MyActivity</span>.<span class="nv">this</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">onSwipeTop</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">        </span><span class="nv">Toast</span>.<span class="nv">makeText</span><span class="ss">(</span><span class="nv">MyActivity</span>.<span class="nv">this</span>,<span class="w"> </span><span class="s2">"top"</span>,<span class="w"> </span><span class="nv">Toast</span>.<span class="nv">LENGTH_SHORT</span><span class="ss">)</span>.<span class="k">show</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span>}
<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">onSwipeRight</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">        </span><span class="nv">Toast</span>.<span class="nv">makeText</span><span class="ss">(</span><span class="nv">MyActivity</span>.<span class="nv">this</span>,<span class="w"> </span><span class="s2">"right"</span>,<span class="w"> </span><span class="nv">Toast</span>.<span class="nv">LENGTH_SHORT</span><span class="ss">)</span>.<span class="k">show</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span>}
<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">onSwipeLeft</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">        </span><span class="nv">Toast</span>.<span class="nv">makeText</span><span class="ss">(</span><span class="nv">MyActivity</span>.<span class="nv">this</span>,<span class="w"> </span><span class="s2">"left"</span>,<span class="w"> </span><span class="nv">Toast</span>.<span class="nv">LENGTH_SHORT</span><span class="ss">)</span>.<span class="k">show</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span>}
<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">onSwipeBottom</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">        </span><span class="nv">Toast</span>.<span class="nv">makeText</span><span class="ss">(</span><span class="nv">MyActivity</span>.<span class="nv">this</span>,<span class="w"> </span><span class="s2">"bottom"</span>,<span class="w"> </span><span class="nv">Toast</span>.<span class="nv">LENGTH_SHORT</span><span class="ss">)</span>.<span class="k">show</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span>}

}<span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>This code detects left and right swipes, avoids deprecated API calls, and has
other miscellaneous improvements over earlier answers.</p>
<div class="code"><pre class="code literal-block"><span class="o">/**</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Detects</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="n">swipes</span><span class="w"> </span><span class="n">across</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">view</span><span class="o">.</span>
<span class="w"> </span><span class="o">*/</span>
<span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">OnSwipeTouchListener</span><span class="w"> </span><span class="n">implements</span><span class="w"> </span><span class="n">OnTouchListener</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="n">GestureDetector</span><span class="w"> </span><span class="n">gestureDetector</span><span class="p">;</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">OnSwipeTouchListener</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">gestureDetector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">GestureDetector</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">GestureListener</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">onSwipeLeft</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">onSwipeRight</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">boolean</span><span class="w"> </span><span class="n">onTouch</span><span class="p">(</span><span class="n">View</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">MotionEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">gestureDetector</span><span class="o">.</span><span class="n">onTouchEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">GestureListener</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">SimpleOnGestureListener</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">SWIPE_DISTANCE_THRESHOLD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">SWIPE_VELOCITY_THRESHOLD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="w">        </span><span class="err">@</span><span class="n">Override</span>
<span class="w">        </span><span class="n">public</span><span class="w"> </span><span class="n">boolean</span><span class="w"> </span><span class="n">onDown</span><span class="p">(</span><span class="n">MotionEvent</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="err">@</span><span class="n">Override</span>
<span class="w">        </span><span class="n">public</span><span class="w"> </span><span class="n">boolean</span><span class="w"> </span><span class="n">onFling</span><span class="p">(</span><span class="n">MotionEvent</span><span class="w"> </span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">MotionEvent</span><span class="w"> </span><span class="n">e2</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">float</span><span class="w"> </span><span class="n">velocityX</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">float</span><span class="w"> </span><span class="n">velocityY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb nb-Type">float</span><span class="w"> </span><span class="n">distanceX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e2</span><span class="o">.</span><span class="n">getX</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">e1</span><span class="o">.</span><span class="n">getX</span><span class="p">();</span>
<span class="w">            </span><span class="nb nb-Type">float</span><span class="w"> </span><span class="n">distanceY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e2</span><span class="o">.</span><span class="n">getY</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">e1</span><span class="o">.</span><span class="n">getY</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distanceX</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">Math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distanceY</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distanceX</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">SWIPE_DISTANCE_THRESHOLD</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">velocityX</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">SWIPE_VELOCITY_THRESHOLD</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">distanceX</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                    </span><span class="n">onSwipeRight</span><span class="p">();</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="n">onSwipeLeft</span><span class="p">();</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Use it like this:</p>
<div class="code"><pre class="code literal-block"><span class="k">view</span><span class="p">.</span><span class="n">setOnTouchListener</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">OnSwipeTouchListener</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="nv">@Override</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">onSwipeLeft</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Whatever</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span><span class="p">);</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-to-determine-a-user-s-ip-address-in-node/" class="u-url">How to determine a user's IP address in node</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-to-determine-a-user-s-ip-address-in-node/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T05:42:57+08:00" itemprop="datePublished" title="2023-03-03 05:42">2023-03-03 05:42</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>How can I determine the IP address of a given request from within a
controller? For example (in express):</p>
<div class="code"><pre class="code literal-block">app.post('/get/ip/address', function (req, res) {
    // need access to IP address here
})
</pre></div>

<p><br><br></p>
<h2>Answer</h2>
<p>In your <code>request</code> object there is a property called <code>socket</code>, which is a
<code>net.Socket</code> object. The <code>net.Socket</code> object has a property <code>remoteAddress</code>,
therefore you should be able to get the IP with this call:</p>
<div class="code"><pre class="code literal-block">request.socket.remoteAddress
</pre></div>

<p>(if your node version is below 13, use the deprecated now
<code>request.connection.remoteAddress</code>)</p>
<p><strong>EDIT</strong></p>
<p>As @juand points out in the comments, the correct method to get the remote IP,
if the server is behind a proxy, is <code>request.headers['x-forwarded-for']</code></p>
<p><strong>EDIT 2</strong></p>
<p>When using <code>express</code> with Node.js:</p>
<p>If you set <code>app.set('trust proxy', true)</code>, <code>req.ip</code> will return the real IP
address even if behind proxy. Check the documentation for further information</p>
<p><br></p>
<h3>Suggest</h3>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">'x-forwarded-for'</span><span class="p">]</span><span class="w"> </span><span class="o">||</span>
<span class="w">     </span><span class="n">req</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">remoteAddress</span><span class="w"> </span><span class="o">||</span>
<span class="w">     </span><span class="nb nb-Type">null</span><span class="p">;</span>
</pre></div>

<p>Note that sometimes you can get more than one IP address in
<code>req.headers['x-forwarded-for']</code>. Also, an <code>x-forwarded-for</code> header will not
always be set which may throw an error.</p>
<p>The general format of the field is:</p>
<p><strong>x-forwarded-for:</strong> <code>client, proxy1, proxy2, proxy3</code></p>
<p>where the value is a comma+space separated list of IP addresses, the left-most
being the original client, and each successive proxy that passed the request
adding the IP address where it received the request from. In this example, the
request passed through <code>proxy1</code>, <code>proxy2</code>, and then <code>proxy3</code>. <code>proxy3</code> appears
as remote address of the request.</p>
<p>This is the solution suggested by Arnav Gupta with a fix Martin has suggested
below in the comments for cases when <code>x-forwarded-for</code> is not set :</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">'x-forwarded-for'</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>
<span class="w">         </span><span class="n">req</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">remoteAddress</span>
</pre></div>

<p>Suggestion using modern JS:</p>
<ul>
<li>processing <code>x-forwarded-for</code> only if set, if so, take the first address</li>
<li>
<p>other parameters use optional chaining (?.)</p>
<p>const parseIp = (req) =&gt;
    req.headers['x-forwarded-for']?.split(',').shift()
    || req.socket?.remoteAddress</p>
<p>console.log(parseIp(req))
// =&gt; 127.0.0.1</p>
</li>
</ul>
</div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1636.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1634.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
