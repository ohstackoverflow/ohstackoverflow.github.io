<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 697) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-697.html">
<link rel="prev" href="index-698.html" type="text/html">
<link rel="next" href="index-696.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-do-i-determine-whether-my-calculation-of-pi-is-accurate/" class="u-url">How do I determine whether my calculation of pi is accurate?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-do-i-determine-whether-my-calculation-of-pi-is-accurate/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T13:34:25+08:00" itemprop="datePublished" title="2023-02-17 13:34">2023-02-17 13:34</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I was trying various methods to implement a program that gives the digits of
pi sequentially. I tried the Taylor series method, but it proved to converge
extremely slowly (when I compared my result with the online values after some
time). Anyway, I am trying better algorithms.</p>
<p>So, while writing the program I got stuck on a problem, as with all
algorithms: How do I know that the <code>n</code> digits that I've calculated are
accurate?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Since I'm the current world record holder for the most digits of pi, I'll add
my two cents:</p>
<p>Unless you're actually setting a new world record, the common practice is just
to verify the computed digits against the known values. So that's simple
enough.</p>
<p>In fact, I have a webpage that lists snippets of digits for the purpose of
verifying computations against them: http://www.numberworld.org/digits/Pi/</p>
<hr>
<p>But when you get into world-record territory, there's nothing to compare
against.</p>
<p>Historically, the standard approach for verifying that computed digits are
correct is to recompute the digits using a second algorithm. So if either
computation goes bad, the digits at the end won't match.</p>
<p>This does typically more than double the amount of time needed (since the
second algorithm is usually slower). But it's the only way to verify the
computed digits once you've wandered into the uncharted territory of never-
before-computed digits and a new world record.</p>
<hr>
<p>Back in the days where supercomputers were setting the records, two different
AGM algorithms were commonly used:</p>
<ul>
<li>Gauss–Legendre algorithm</li>
<li>Borwein's algorithm</li>
</ul>
<p>These are both <code>O(N log(N)^2)</code> algorithms that were fairly easy to implement.</p>
<p>However, nowadays, things are a bit different. In the last three world
records, instead of performing two computations, we performed only one
computation using the fastest known formula (Chudnovsky Formula):</p>
<p><img alt="Enter image description here" src="images/YO0MI.png"></p>
<p>This algorithm is much harder to implement, but it is a lot faster than the
AGM algorithms.</p>
<p>Then we verify the binary digits using the BBP formulas for digit extraction.</p>
<p><img alt="Enter image description here" src="images/yC73N.png"></p>
<p>This formula allows you to compute arbitrary binary digits <em>without</em> computing
all the digits before it. So it is used to verify the last few computed binary
digits. Therefore it is <strong><em>much</em></strong> faster than a full computation.</p>
<p>The advantage of this is:</p>
<ol>
<li>Only one expensive computation is needed.</li>
</ol>
<p>The disadvantage is:</p>
<ol>
<li>An implementation of the Bailey–Borwein–Plouffe (BBP) formula is needed.</li>
<li>An additional step is needed to verify the radix conversion from binary to decimal.</li>
</ol>
<p>I've glossed over some details of why verifying the last few digits implies
that all the digits are correct. But it is easy to see this since any
computation error will propagate to the last digits.</p>
<hr>
<p>Now this last step (verifying the conversion) is actually fairly important.
One of the previous world record holders <strong><em>actually called us out</em></strong> on this
because, initially, I didn't give a sufficient description of how it worked.</p>
<p>So I've pulled this snippet from my blog:</p>
<div class="code"><pre class="code literal-block">N = # of decimal digits desired
p = 64-bit prime number
</pre></div>

<p><img alt="Enter image description here" src="images/eM9bu.png"></p>
<p>Compute A using base 10 arithmetic and B using binary arithmetic.</p>
<p><img alt="Enter image description here" src="images/pyxWt.png"></p>
<p>If <code>A = B</code>, then with "extremely high probability", the conversion is correct.</p>
<hr>
<p>For further reading, see my blog post <strong>Pi - 5 Trillion Digits</strong>.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Undoubtedly, for your purposes (which I assume is just a programming
exercise), the best thing is to check your results against any of the listings
of the digits of pi on the web.</p>
<p>And how do we know that those values are correct? Well, I could say that there
are computer-science-y ways to prove that an implementation of an algorithm is
correct.</p>
<p>More pragmatically, if different people use different algorithms, and they all
agree to (pick a number) a thousand (million, whatever) decimal places, that
should give you a warm fuzzy feeling that they got it right.</p>
<p>Historically, William Shanks published pi to 707 decimal places in 1873. Poor
guy, he made a mistake starting at the 528th decimal place.</p>
<p>Very interestingly, in 1995 an algorithm was published that had the property
that would directly calculate the nth digit (base 16) of pi <em>without having to
calculate all the previous digits</em>!</p>
<p>Finally, I hope your initial algorithm wasn't <code>pi/4 = 1 - 1/3 + 1/5 - 1/7 +
...</code> That may be the simplest to program, but it's also one of the slowest
ways to do so. Check out the pi article on Wikipedia for faster approaches.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-can-i-capitalize-the-first-letter-of-each-word-in-a-string/" class="u-url">How can I capitalize the first letter of each word in a string?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-can-i-capitalize-the-first-letter-of-each-word-in-a-string/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T13:33:59+08:00" itemprop="datePublished" title="2023-02-17 13:33">2023-02-17 13:33</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <div class="code"><pre class="code literal-block">s = 'the brown fox'
</pre></div>

<p>...do something here...</p>
<p><code>s</code> should be:</p>
<div class="code"><pre class="code literal-block">'The Brown Fox'
</pre></div>

<p>What's the easiest way to do this?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>The <code>.title()</code> method of a string (either ASCII or Unicode is fine) does this:</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; "hello world".title()
'Hello World'
&gt;&gt;&gt; u"hello world".title()
u'Hello World'
</pre></div>

<p>However, look out for strings with embedded apostrophes, as noted in the docs.</p>
<blockquote>
<p>The algorithm uses a simple language-independent definition of a word as
groups of consecutive letters. The definition works in many contexts but it
means that apostrophes in contractions and possessives form word boundaries,
which may not be the desired result:</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; "they're bill's friends from the UK".title()
"They'Re Bill'S Friends From The Uk"
</pre></div>

</blockquote>
<p><br></p>
<h3>Suggest</h3>
<p>The <code>.title()</code> method can't work well,</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; "they're bill's friends from the UK".title()
"They'Re Bill'S Friends From The Uk"
</pre></div>

<p>Try <code>string.capwords()</code> method,</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">string</span>
<span class="n">string</span><span class="o">.</span><span class="n">capwords</span><span class="p">(</span><span class="s2">"they're bill's friends from the UK"</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span><span class="s2">"They're Bill's Friends From The Uk"</span>
</pre></div>

<p>From the Python documentation on capwords:</p>
<blockquote>
<p>Split the argument into words using str.split(), capitalize each word using
str.capitalize(), and join the capitalized words using str.join(). If the
optional second argument sep is absent or None, runs of whitespace
characters are replaced by a single space and leading and trailing
whitespace are removed, otherwise sep is used to split and join the words.</p>
</blockquote>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/why-is-my-program-slow-when-looping-over-exactly-8192-elements/" class="u-url">Why is my program slow when looping over exactly 8192 elements?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/why-is-my-program-slow-when-looping-over-exactly-8192-elements/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T13:33:16+08:00" itemprop="datePublished" title="2023-02-17 13:33">2023-02-17 13:33</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Here is the extract from the program in question. The matrix <code>img[][]</code> has the
size SIZE×SIZE, and is initialized at:</p>
<p><code>img[j][i] = 2 * j + i</code></p>
<p>Then, you make a matrix <code>res[][]</code>, and each field in here is made to be the
average of the 9 fields around it in the img matrix. The border is left at 0
for simplicity.</p>
<div class="code"><pre class="code literal-block"><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="k">SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="k">SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]=</span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="n">l</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span><span class="n">l</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span><span class="n">l</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<span class="w">                </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j+l</span><span class="o">][</span><span class="n">i+k</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span>
<span class="err">}</span>
</pre></div>

<p>That's all there's to the program. For completeness' sake, here is what comes
before. No code comes after. As you can see, it's just initialization.</p>
<div class="code"><pre class="code literal-block"><span class="n">#define</span><span class="w"> </span><span class="k">SIZE</span><span class="w"> </span><span class="mi">8192</span>
<span class="nc">float</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">SIZE</span><span class="o">][</span><span class="n">SIZE</span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="nc">image</span>
<span class="nc">float</span><span class="w"> </span><span class="n">res</span><span class="o">[</span><span class="n">SIZE</span><span class="o">][</span><span class="n">SIZE</span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="k">result</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="k">filter</span>
<span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="k">SIZE</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="k">SIZE</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="n">img</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">%</span><span class="mi">8196</span><span class="p">;</span>
</pre></div>

<p>Basically, this program is slow when SIZE is a multiple of 2048, e.g. the
execution times:</p>
<div class="code"><pre class="code literal-block">SIZE = 8191: 3.44 secs
SIZE = 8192: 7.20 secs
SIZE = 8193: 3.18 secs
</pre></div>

<p>The compiler is GCC. From what I know, this is because of memory management,
but I don't really know too much about that subject, which is why I'm asking
here.</p>
<p>Also how to fix this would be nice, but if someone could explain these
execution times I'd already be happy enough.</p>
<p>I already know of malloc/free, but the problem is not amount of memory used,
it's merely execution time, so I don't know how that would help.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>The difference is caused by the same super-alignment issue from the following
related questions:</p>
<ul>
<li>Why is transposing a matrix of 512x512 much slower than transposing a matrix of 513x513?</li>
<li>Matrix multiplication: Small difference in matrix size, large difference in timings</li>
</ul>
<p>But that's only because there's one other problem with the code.</p>
<p>Starting from the original loop:</p>
<div class="code"><pre class="code literal-block"><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="k">SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="k">SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]=</span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="n">l</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span><span class="n">l</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span><span class="n">l</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
<span class="w">                </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j+l</span><span class="o">][</span><span class="n">i+k</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span>
<span class="err">}</span>
</pre></div>

<p>First notice that the two inner loops are trivial. They can be unrolled as
follows:</p>
<div class="code"><pre class="code literal-block"><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="k">SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="k">SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]=</span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j-1</span><span class="o">][</span><span class="n">i-1</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j  </span><span class="o">][</span><span class="n">i-1</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j+1</span><span class="o">][</span><span class="n">i-1</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j-1</span><span class="o">][</span><span class="n">i  </span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j  </span><span class="o">][</span><span class="n">i  </span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j+1</span><span class="o">][</span><span class="n">i  </span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j-1</span><span class="o">][</span><span class="n">i+1</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j  </span><span class="o">][</span><span class="n">i+1</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j+1</span><span class="o">][</span><span class="n">i+1</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>So that leaves the two outer-loops that we're interested in.</p>
<p>Now we can see the problem is the same in this question: Why does the order of
the loops affect performance when iterating over a 2D array?</p>
<p>You are iterating the matrix column-wise instead of row-wise.</p>
<hr>
<p>To solve this problem, you should interchange the two loops.</p>
<div class="code"><pre class="code literal-block"><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="k">SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="k">SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]=</span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j-1</span><span class="o">][</span><span class="n">i-1</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j  </span><span class="o">][</span><span class="n">i-1</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j+1</span><span class="o">][</span><span class="n">i-1</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j-1</span><span class="o">][</span><span class="n">i  </span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j  </span><span class="o">][</span><span class="n">i  </span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j+1</span><span class="o">][</span><span class="n">i  </span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j-1</span><span class="o">][</span><span class="n">i+1</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j  </span><span class="o">][</span><span class="n">i+1</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">img</span><span class="o">[</span><span class="n">j+1</span><span class="o">][</span><span class="n">i+1</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>This eliminates all the non-sequential access completely so you no longer get
random slow-downs on large powers-of-two.</p>
<hr>
<p><strong>Core i7 920 @ 3.5 GHz</strong></p>
<p>Original code:</p>
<div class="code"><pre class="code literal-block"><span class="mi">8191</span><span class="o">:</span><span class="w"> </span><span class="mf">1.499</span><span class="w"> </span><span class="n">seconds</span>
<span class="mi">8192</span><span class="o">:</span><span class="w"> </span><span class="mf">2.122</span><span class="w"> </span><span class="n">seconds</span>
<span class="mi">8193</span><span class="o">:</span><span class="w"> </span><span class="mf">1.582</span><span class="w"> </span><span class="n">seconds</span>
</pre></div>

<p>Interchanged Outer-Loops:</p>
<div class="code"><pre class="code literal-block"><span class="mi">8191</span><span class="o">:</span><span class="w"> </span><span class="mf">0.376</span><span class="w"> </span><span class="n">seconds</span>
<span class="mi">8192</span><span class="o">:</span><span class="w"> </span><span class="mf">0.357</span><span class="w"> </span><span class="n">seconds</span>
<span class="mi">8193</span><span class="o">:</span><span class="w"> </span><span class="mf">0.351</span><span class="w"> </span><span class="n">seconds</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>The following tests have been done with Visual C++ compiler as it is used by
the default Qt Creator install (I guess with no optimization flag). When using
GCC, there is no big difference between Mystical's version and my "optimized"
code. So the conclusion is that compiler optimizations take care off micro
optimization better than humans (me at last). I leave the rest of my answer
for reference.</p>
<hr>
<p>It's not efficient to process images this way. It's better to use single
dimension arrays. Processing all pixels is the done in one loop. Random access
to points could be done using:</p>
<div class="code"><pre class="code literal-block">pointer + (x + y*width)*(sizeOfOnePixel)
</pre></div>

<p>In this particular case, it's better to compute and cache the sum of three
pixels groups horizontally because they are used three times each.</p>
<p>I've done some tests and I think it's worth sharing. Each result is an average
of five tests.</p>
<p>Original code by user1615209:</p>
<div class="code"><pre class="code literal-block"><span class="mi">8193</span><span class="o">:</span><span class="w"> </span><span class="mi">4392</span><span class="w"> </span><span class="n">ms</span>
<span class="mi">8192</span><span class="o">:</span><span class="w"> </span><span class="mi">9570</span><span class="w"> </span><span class="n">ms</span>
</pre></div>

<p>Mystical's version:</p>
<div class="code"><pre class="code literal-block"><span class="mi">8193</span><span class="o">:</span><span class="w"> </span><span class="mi">2393</span><span class="w"> </span><span class="n">ms</span>
<span class="mi">8192</span><span class="o">:</span><span class="w"> </span><span class="mi">2190</span><span class="w"> </span><span class="n">ms</span>
</pre></div>

<p>Two pass using a 1D array: first pass for horizontal sums, second for vertical
sum and average. Two pass addressing with three pointers and only increments
like this:</p>
<div class="code"><pre class="code literal-block"><span class="n">imgPointer1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">avg1</span><span class="o">[</span><span class="n">0</span><span class="o">][</span><span class="n">0</span><span class="o">]</span><span class="p">;</span>
<span class="n">imgPointer2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">avg1</span><span class="o">[</span><span class="n">0</span><span class="o">][</span><span class="n">SIZE</span><span class="o">]</span><span class="p">;</span>
<span class="n">imgPointer3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">avg1</span><span class="o">[</span><span class="n">0</span><span class="o">][</span><span class="n">SIZE+SIZE</span><span class="o">]</span><span class="p">;</span>

<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="k">SIZE</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">totalSize</span><span class="o">-</span><span class="k">SIZE</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="err">{</span>
<span class="w">    </span><span class="n">resPointer</span><span class="o">[</span><span class="n">i</span><span class="o">]=</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">imgPointer1</span><span class="o">++</span><span class="p">)</span><span class="o">+*</span><span class="p">(</span><span class="n">imgPointer2</span><span class="o">++</span><span class="p">)</span><span class="o">+*</span><span class="p">(</span><span class="n">imgPointer3</span><span class="o">++</span><span class="p">))</span><span class="o">/</span><span class="mi">9</span><span class="p">;</span>
<span class="err">}</span>

<span class="mi">8193</span><span class="err">:</span><span class="w"> </span><span class="mi">938</span><span class="w"> </span><span class="n">ms</span>
<span class="mi">8192</span><span class="err">:</span><span class="w"> </span><span class="mi">974</span><span class="w"> </span><span class="n">ms</span>
</pre></div>

<p>Two pass using a 1D array and addressing like this:</p>
<div class="code"><pre class="code literal-block"><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="k">SIZE</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">totalSize</span><span class="o">-</span><span class="k">SIZE</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="err">{</span>
<span class="w">    </span><span class="n">resPointer</span><span class="o">[</span><span class="n">i</span><span class="o">]=</span><span class="p">(</span><span class="n">hsumPointer</span><span class="o">[</span><span class="n">i-SIZE</span><span class="o">]+</span><span class="n">hsumPointer</span><span class="o">[</span><span class="n">i</span><span class="o">]+</span><span class="n">hsumPointer</span><span class="o">[</span><span class="n">i+SIZE</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="mi">9</span><span class="p">;</span>
<span class="err">}</span>

<span class="mi">8193</span><span class="err">:</span><span class="w"> </span><span class="mi">932</span><span class="w"> </span><span class="n">ms</span>
<span class="mi">8192</span><span class="err">:</span><span class="w"> </span><span class="mi">925</span><span class="w"> </span><span class="n">ms</span>
</pre></div>

<p>One pass caching horizontal sums just one row ahead so they stay in cache:</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="n">Horizontal</span><span class="w"> </span><span class="n">sums</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">first</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">lines</span>
<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="k">SIZE</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="err">{</span>
<span class="w">    </span><span class="n">hsumPointer</span><span class="o">[</span><span class="n">i</span><span class="o">]=</span><span class="n">imgPointer</span><span class="o">[</span><span class="n">i-1</span><span class="o">]+</span><span class="n">imgPointer</span><span class="o">[</span><span class="n">i</span><span class="o">]+</span><span class="n">imgPointer</span><span class="o">[</span><span class="n">i+1</span><span class="o">]</span><span class="p">;</span>
<span class="err">}</span>
<span class="o">//</span><span class="w"> </span><span class="n">Rest</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">computation</span>
<span class="k">for</span><span class="p">(;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">totalSize</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Compute</span><span class="w"> </span><span class="n">horizontal</span><span class="w"> </span><span class="nf">sum</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="n">line</span>
<span class="w">    </span><span class="n">hsumPointer</span><span class="o">[</span><span class="n">i</span><span class="o">]=</span><span class="n">imgPointer</span><span class="o">[</span><span class="n">i-1</span><span class="o">]+</span><span class="n">imgPointer</span><span class="o">[</span><span class="n">i</span><span class="o">]+</span><span class="n">imgPointer</span><span class="o">[</span><span class="n">i+1</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Final</span><span class="w"> </span><span class="k">result</span>
<span class="w">    </span><span class="n">resPointer</span><span class="o">[</span><span class="n">i-SIZE</span><span class="o">]=</span><span class="p">(</span><span class="n">hsumPointer</span><span class="o">[</span><span class="n">i-SIZE-SIZE</span><span class="o">]+</span><span class="n">hsumPointer</span><span class="o">[</span><span class="n">i-SIZE</span><span class="o">]+</span><span class="n">hsumPointer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="mi">9</span><span class="p">;</span>
<span class="err">}</span>

<span class="mi">8193</span><span class="err">:</span><span class="w"> </span><span class="mi">599</span><span class="w"> </span><span class="n">ms</span>
<span class="mi">8192</span><span class="err">:</span><span class="w"> </span><span class="mi">652</span><span class="w"> </span><span class="n">ms</span>
</pre></div>

<p>Conclusion:</p>
<ul>
<li>No benefits of using several pointers and just increments (I thought it would have been faster)</li>
<li>Caching horizontal sums is better than computing them several time.</li>
<li>Two pass is not three times faster, two times only.</li>
<li>It's possible to achieve 3.6 times faster using both a single pass and caching an intermediary result</li>
</ul>
<p>I'm sure it's possible to do much better.</p>
<p><strong>NOTE</strong> Please, note that I wrote this answer to target general performance
issues rather than the cache problem explained in Mystical's excellent answer.
At the beginning it was just pseudo code. I was asked to do tests in the
comments... Here is a completely refactored version with tests.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-698.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-696.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
