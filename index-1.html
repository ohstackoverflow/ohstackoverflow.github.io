<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1.html">
<link rel="prev" href="index-2.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-do-i-undo-the-most-recent-local-commits-in-git/" class="u-url">How do I undo the most recent local commits in Git?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-do-i-undo-the-most-recent-local-commits-in-git/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T18:11:46+08:00" itemprop="datePublished" title="2023-02-16 18:11">2023-02-16 18:11</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I accidentally committed the wrong files to <strong>Git</strong> , but didn't push the
commit to the server yet.</p>
<blockquote>
<p>How do I undo those commits from the <em><strong>local</strong></em> repository?</p>
</blockquote>
<p><br><br></p>
<h2>Answer</h2>
<h2>Undo a commit &amp; redo</h2>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">"Something terribly misguided"</span><span class="w"> </span><span class="c1"># (0: Your Accident)</span>
$<span class="w"> </span>git<span class="w"> </span>reset<span class="w"> </span>HEAD~<span class="w">                              </span><span class="c1"># (1)</span>
<span class="o">[</span><span class="w"> </span>edit<span class="w"> </span>files<span class="w"> </span>as<span class="w"> </span>necessary<span class="w"> </span><span class="o">]</span><span class="w">                    </span><span class="c1"># (2)</span>
$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.<span class="w">                                    </span><span class="c1"># (3)</span>
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-c<span class="w"> </span>ORIG_HEAD<span class="w">                      </span><span class="c1"># (4)</span>
</pre></div>

<ol>
<li>
<code>git reset</code> is the command responsible for the <strong>undo</strong>. It will undo your last commit while <strong>leaving your working tree (the state of your files on disk) untouched.</strong> You'll need to add them again before you can commit them again).</li>
<li>Make corrections to working tree files.</li>
<li>
<code>git add</code> anything that you want to include in your new commit.</li>
<li>Commit the changes, reusing the old commit message. <code>reset</code> copied the old head to <code>.git/ORIG_HEAD</code>; <code>commit</code> with <code>-c ORIG_HEAD</code> will open an editor, which initially contains the log message from the old commit and allows you to edit it. If you do not need to edit the message, you could use the <code>-C</code> option.</li>
</ol>
<p><strong>Alternatively, to edit the previous commit (or just its commit message)</strong> ,
<code>commit --amend</code> will add changes within the current index to the previous
commit.</p>
<p><strong>To remove (not revert) a commit that has been pushed to the server</strong> ,
rewriting history with <code>git push origin main --force[-with-lease]</code> is
necessary. It's <em>almost always</em> a bad idea to use <code>--force</code>; prefer <code>--force-
with-lease</code> instead, and as noted in the git manual:</p>
<blockquote>
<p>You should understand the implications of rewriting history if you [rewrite
history] has already been published.</p>
</blockquote>
<hr>
<h3>Further Reading</h3>
<p>You can use <code>git reflog</code> to determine the SHA-1 for the commit to which you
wish to revert. Once you have this value, use the sequence of commands as
explained above.</p>
<hr>
<p><code>HEAD~</code> is the same as <code>HEAD~1</code>. The article What is the HEAD in git? is
helpful if you want to uncommit multiple commits.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Undoing a commit is a little scary if you don't know how it works. But it's
actually amazingly easy if you do understand. I'll show you the 4 different
ways you can undo a commit.</p>
<p>Say you have this, where C is your HEAD and (F) is the state of your files.</p>
<div class="code"><pre class="code literal-block">   (F)
A-B-C
    ↑
  master
</pre></div>

<h4>Option 1: <code>git reset --hard</code>
</h4>
<p>You want to <strong>destroy commit C and also throw away any uncommitted changes</strong>.
You do this:</p>
<div class="code"><pre class="code literal-block">git reset --hard HEAD~1
</pre></div>

<p>The result is:</p>
<div class="code"><pre class="code literal-block"> (F)
A-B
  ↑
master
</pre></div>

<p>Now B is the HEAD. Because you used <code>--hard</code>, your files are reset to their
state at commit B.</p>
<h4>Option 2: <code>git reset</code>
</h4>
<p>Maybe commit C wasn't a disaster, but just a bit off. You want to <strong>undo the
commit but keep your changes</strong> for a bit of editing before you do a better
commit. Starting again from here, with C as your HEAD:</p>
<div class="code"><pre class="code literal-block">   (F)
A-B-C
    ↑
  master
</pre></div>

<p>Do this, leaving off the <code>--hard</code>:</p>
<div class="code"><pre class="code literal-block">git reset HEAD~1
</pre></div>

<p>In this case, the result is:</p>
<div class="code"><pre class="code literal-block">   (F)
A-B-C
  ↑
master
</pre></div>

<p>In both cases, HEAD is just a pointer to the latest commit. When you do a <code>git
reset HEAD~1</code>, you tell Git to move the HEAD pointer back one commit. But
(unless you use <code>--hard</code>) you leave your files as they were. So now <code>git
status</code> shows the changes you had checked into C. You haven't lost a thing!</p>
<h4>Option 3: <code>git reset --soft</code>
</h4>
<p>For the lightest touch, you can even <strong>undo your commit but leave your files
and your index</strong> :</p>
<div class="code"><pre class="code literal-block">git reset --soft HEAD~1
</pre></div>

<p>This not only leaves your files alone, it even leaves your <em>index</em> alone. When
you do <code>git status</code>, you'll see that the same files are in the index as
before. In fact, right after this command, you could do <code>git commit</code> and you'd
be redoing the same commit you just had.</p>
<h4>Option 4: you did <code>git reset --hard</code> and need to get that code back</h4>
<p>One more thing: Suppose you <strong>destroy a commit</strong> as in the first example,
<strong>but then discover you needed it after all</strong>? Tough luck, right?</p>
<p>Nope, there's <em>still</em> a way to get it back. Type this</p>
<div class="code"><pre class="code literal-block">git reflog
</pre></div>

<p>and you'll see a list of (partial) commit shas (that is, hashes) that you've
moved around in. Find the commit you destroyed, and do this:</p>
<div class="code"><pre class="code literal-block">git checkout -b someNewBranchName shaYouDestroyed
</pre></div>

<p>You've now resurrected that commit. Commits don't actually get destroyed in
Git for some 90 days, so you can usually go back and rescue one you didn't
mean to get rid of.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/why-is-processing-a-sorted-array-faster-than-processing-an-unsorted-array/" class="u-url">Why is processing a sorted array faster than processing an unsorted array?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/why-is-processing-a-sorted-array-faster-than-processing-an-unsorted-array/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T18:11:09+08:00" itemprop="datePublished" title="2023-02-16 18:11">2023-02-16 18:11</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Here is a piece of C++ code that shows some very peculiar behavior.</p>
<p>For some reason, sorting the data ( <em>before</em> the timed region) miraculously
makes the primary loop almost six times faster:</p>
<div class="code"><pre class="code literal-block"><span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">algorithm</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">ctime</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">iostream</span><span class="o">&gt;</span>

<span class="nc">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span>
<span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Generate</span><span class="w"> </span><span class="k">data</span>
<span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">arraySize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32768</span><span class="p">;</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">arraySize</span><span class="o">]</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">unsigned</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">arraySize</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span>
<span class="w">        </span><span class="k">data</span><span class="o">[</span><span class="n">c</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">std</span><span class="p">:</span><span class="err">:</span><span class="nf">rand</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="err">!!!</span><span class="w"> </span><span class="k">With</span><span class="w"> </span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="n">runs</span><span class="w"> </span><span class="n">faster</span><span class="p">.</span>
<span class="w">    </span><span class="nl">std</span><span class="p">:</span><span class="err">:</span><span class="n">sort</span><span class="p">(</span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">arraySize</span><span class="p">);</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Test</span>
<span class="w">    </span><span class="n">clock_t</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock</span><span class="p">();</span>
<span class="w">    </span><span class="n">long</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="nf">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100000</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">unsigned</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">arraySize</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span>
<span class="w">        </span><span class="err">{</span><span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="k">Primary</span><span class="w"> </span><span class="n">loop</span><span class="p">.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">c</span><span class="o">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span>
<span class="w">                </span><span class="nf">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">c</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">double</span><span class="w"> </span><span class="n">elapsedTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">static_cast</span><span class="o">&lt;</span><span class="k">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">clock</span><span class="p">()</span><span class="o">-</span><span class="k">start</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CLOCKS_PER_SEC</span><span class="p">;</span>

<span class="w">    </span><span class="nl">std</span><span class="p">:</span><span class="err">:</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">elapsedTime</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">'\n'</span><span class="p">;</span>
<span class="w">    </span><span class="nl">std</span><span class="p">:</span><span class="err">:</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">"sum = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nf">sum</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">'\n'</span><span class="p">;</span>
<span class="err">}</span>
</pre></div>

<ul>
<li>Without <code>std::sort(data, data + arraySize);</code>, the code runs in 11.54 seconds.</li>
<li>With the sorted data, the code runs in 1.93 seconds.</li>
</ul>
<p>(Sorting itself takes more time than this one pass over the array, so it's not
actually worth doing if we needed to calculate this for an unknown array.)</p>
<hr>
<p>Initially, I thought this might be just a language or compiler anomaly, so I
tried Java:</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">Main</span>
<span class="p">{</span>
    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">//</span> <span class="n">Generate</span> <span class="n">data</span>
        <span class="nb">int</span> <span class="n">arraySize</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">;</span>
        <span class="nb">int</span> <span class="n">data</span><span class="p">[]</span> <span class="o">=</span> <span class="n">new</span> <span class="nb">int</span><span class="p">[</span><span class="n">arraySize</span><span class="p">];</span>

        <span class="n">Random</span> <span class="n">rnd</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Random</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">arraySize</span><span class="p">;</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="n">nextInt</span><span class="p">()</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>

        <span class="o">//</span> <span class="err">!!!</span> <span class="n">With</span> <span class="n">this</span><span class="p">,</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">loop</span> <span class="n">runs</span> <span class="n">faster</span>
        <span class="n">Arrays</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

        <span class="o">//</span> <span class="n">Test</span>
        <span class="n">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">nanoTime</span><span class="p">();</span>
        <span class="n">long</span> <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">arraySize</span><span class="p">;</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span>
            <span class="p">{</span>   <span class="o">//</span> <span class="n">Primary</span> <span class="n">loop</span><span class="o">.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span>
                    <span class="nb">sum</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">((</span><span class="n">System</span><span class="o">.</span><span class="n">nanoTime</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000000000.0</span><span class="p">);</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">"sum = "</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>With a similar but less extreme result.</p>
<hr>
<p>My first thought was that sorting brings the data into the cache, but that's
silly because the array was just generated.</p>
<ul>
<li>What is going on?</li>
<li>Why is processing a sorted array faster than processing an unsorted array?</li>
</ul>
<p>The code is summing up some independent terms, so the order should not matter.</p>
<hr>
<p><strong>Related / follow-up Q &amp;As</strong> about the same effect with different/later
compilers and options:</p>
<ul>
<li>Why is processing an unsorted array the same speed as processing a sorted array with modern x86-64 clang?</li>
<li>gcc optimization flag -O3 makes code slower than -O2</li>
</ul>
<p><br><br></p>
<h2>Answer</h2>
<p><strong>You are a victim of branch prediction fail.</strong></p>
<hr>
<h3>What is Branch Prediction?</h3>
<p>Consider a railroad junction:</p>
<p><img alt="Image showing a railroad junction" src="images/muxnt.jpg"> Image by Mecanismo,
via Wikimedia Commons. Used under the CC-By-SA 3.0 license.</p>
<p>Now for the sake of argument, suppose this is back in the 1800s - before long-
distance or radio communication.</p>
<p>You are a blind operator of a junction and you hear a train coming. You have
no idea which way it is supposed to go. You stop the train to ask the driver
which direction they want. And then you set the switch appropriately.</p>
<p><em>Trains are heavy and have a lot of inertia, so they take forever to start up
and slow down.</em></p>
<p>Is there a better way? You guess which direction the train will go!</p>
<ul>
<li>If you guessed right, it continues on.</li>
<li>If you guessed wrong, the captain will stop, back up, and yell at you to flip the switch. Then it can restart down the other path.</li>
</ul>
<p><strong>If you guess right every time</strong> , the train will never have to stop.<br><strong>If you guess wrong too often</strong> , the train will spend a lot of time
stopping, backing up, and restarting.</p>
<hr>
<p><strong>Consider an if-statement:</strong> At the processor level, it is a branch
instruction:</p>
<p><img alt="Screenshot of compiled code containing an if statement" src="images/pyfwC.png"></p>
<p>You are a processor and you see a branch. You have no idea which way it will
go. What do you do? You halt execution and wait until the previous
instructions are complete. Then you continue down the correct path.</p>
<p><em>Modern processors are complicated and have long pipelines. This means they
take forever to "warm up" and "slow down".</em></p>
<p>Is there a better way? You guess which direction the branch will go!</p>
<ul>
<li>If you guessed right, you continue executing.</li>
<li>If you guessed wrong, you need to flush the pipeline and roll back to the branch. Then you can restart down the other path.</li>
</ul>
<p><strong>If you guess right every time</strong> , the execution will never have to stop.<br><strong>If you guess wrong too often</strong> , you spend a lot of time stalling, rolling
back, and restarting.</p>
<hr>
<p>This is branch prediction. I admit it's not the best analogy since the train
could just signal the direction with a flag. But in computers, the processor
doesn't know which direction a branch will go until the last moment.</p>
<p>How would you strategically guess to minimize the number of times that the
train must back up and go down the other path? You look at the past history!
If the train goes left 99% of the time, then you guess left. If it alternates,
then you alternate your guesses. If it goes one way every three times, you
guess the same...</p>
<p><em><strong>In other words, you try to identify a pattern and follow it.</strong></em> This is
more or less how branch predictors work.</p>
<p>Most applications have well-behaved branches. Therefore, modern branch
predictors will typically achieve &gt;90% hit rates. But when faced with
unpredictable branches with no recognizable patterns, branch predictors are
virtually useless.</p>
<p>Further reading: "Branch predictor" article on Wikipedia.</p>
<hr>
<h3>As hinted from above, the culprit is this if-statement:</h3>
<div class="code"><pre class="code literal-block"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">c</span><span class="o">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span>
<span class="w">    </span><span class="nf">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">c</span><span class="o">]</span><span class="p">;</span>
</pre></div>

<p>Notice that the data is evenly distributed between 0 and 255. When the data is
sorted, roughly the first half of the iterations will not enter the if-
statement. After that, they will all enter the if-statement.</p>
<p>This is very friendly to the branch predictor since the branch consecutively
goes the same direction many times. Even a simple saturating counter will
correctly predict the branch except for the few iterations after it switches
direction.</p>
<p><strong>Quick visualization:</strong></p>
<div class="code"><pre class="code literal-block">T = branch taken
N = branch not taken

data[] = 0, 1, 2, 3, 4, ... 126, 127, 128, 129, 130, ... 250, 251, 252, ...
branch = N  N  N  N  N  ...   N    N    T    T    T  ...   T    T    T  ...

       = NNNNNNNNNNNN ... NNNNNNNTTTTTTTTT ... TTTTTTTTTT  (easy to predict)
</pre></div>

<p>However, when the data is completely random, the branch predictor is rendered
useless, because it can't predict random data. Thus there will probably be
around 50% misprediction (no better than random guessing).</p>
<div class="code"><pre class="code literal-block"><span class="nv">data</span>[]<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">226</span>,<span class="w"> </span><span class="mi">185</span>,<span class="w"> </span><span class="mi">125</span>,<span class="w"> </span><span class="mi">158</span>,<span class="w"> </span><span class="mi">198</span>,<span class="w"> </span><span class="mi">144</span>,<span class="w"> </span><span class="mi">217</span>,<span class="w"> </span><span class="mi">79</span>,<span class="w"> </span><span class="mi">202</span>,<span class="w"> </span><span class="mi">118</span>,<span class="w">  </span><span class="mi">14</span>,<span class="w"> </span><span class="mi">150</span>,<span class="w"> </span><span class="mi">177</span>,<span class="w"> </span><span class="mi">182</span>,<span class="w"> </span>...
<span class="nv">branch</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="nv">T</span>,<span class="w">   </span><span class="nv">T</span>,<span class="w">   </span><span class="nv">N</span>,<span class="w">   </span><span class="nv">T</span>,<span class="w">   </span><span class="nv">T</span>,<span class="w">   </span><span class="nv">T</span>,<span class="w">   </span><span class="nv">T</span>,<span class="w">  </span><span class="nv">N</span>,<span class="w">   </span><span class="nv">T</span>,<span class="w">   </span><span class="nv">N</span>,<span class="w">   </span><span class="nv">N</span>,<span class="w">   </span><span class="nv">T</span>,<span class="w">   </span><span class="nv">T</span>,<span class="w">   </span><span class="nv">T</span><span class="w">  </span>...

<span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">TTNTTTTNTNNTTT</span><span class="w"> </span>...<span class="w">   </span><span class="ss">(</span><span class="nv">completely</span><span class="w"> </span><span class="k">random</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">impossible</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">predict</span><span class="ss">)</span>
</pre></div>

<hr>
<p><strong>What can be done?</strong></p>
<p>If the compiler isn't able to optimize the branch into a conditional move, you
can try some hacks if you are willing to sacrifice readability for
performance.</p>
<p>Replace:</p>
<div class="code"><pre class="code literal-block"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">c</span><span class="o">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span>
<span class="w">    </span><span class="nf">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">c</span><span class="o">]</span><span class="p">;</span>
</pre></div>

<p>with:</p>
<div class="code"><pre class="code literal-block"><span class="nc">int</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">c</span><span class="o">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">31</span><span class="p">;</span>
<span class="nf">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="o">~</span><span class="n">t</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="k">data</span><span class="o">[</span><span class="n">c</span><span class="o">]</span><span class="p">;</span>
</pre></div>

<p>This eliminates the branch and replaces it with some bitwise operations.</p>
<p>(Note that this hack is not strictly equivalent to the original if-statement.
But in this case, it's valid for all the input values of <code>data[]</code>.)</p>
<p><strong>Benchmarks: Core i7 920 @ 3.5 GHz</strong></p>
<p>C++ - Visual Studio 2010 - x64 Release</p>
<table>
<thead><tr>
<th>Scenario</th>
<th>Time (seconds)</th>
</tr></thead>
<tbody>
<tr>
<td>Branching - Random data</td>
<td>11.777</td>
</tr>
<tr>
<td>Branching - Sorted data</td>
<td>2.352</td>
</tr>
<tr>
<td>Branchless - Random data</td>
<td>2.564</td>
</tr>
<tr>
<td>Branchless - Sorted data</td>
<td>2.587</td>
</tr>
</tbody>
</table>
<p>Java - NetBeans 7.1.1 JDK 7 - x64</p>
<table>
<thead><tr>
<th>Scenario</th>
<th>Time (seconds)</th>
</tr></thead>
<tbody>
<tr>
<td>Branching - Random data</td>
<td>10.93293813</td>
</tr>
<tr>
<td>Branching - Sorted data</td>
<td>5.643797077</td>
</tr>
<tr>
<td>Branchless - Random data</td>
<td>3.113581453</td>
</tr>
<tr>
<td>Branchless - Sorted data</td>
<td>3.186068823</td>
</tr>
</tbody>
</table>
<p>Observations:</p>
<ul>
<li>
<strong>With the Branch:</strong> There is a huge difference between the sorted and unsorted data.</li>
<li>
<strong>With the Hack:</strong> There is no difference between sorted and unsorted data.</li>
<li>In the C++ case, the hack is actually a tad slower than with the branch when the data is sorted.</li>
</ul>
<p>A general rule of thumb is to avoid data-dependent branching in critical loops
(such as in this example).</p>
<hr>
<p><strong>Update:</strong></p>
<ul>
<li>GCC 4.6.1 with <code>-O3</code> or <code>-ftree-vectorize</code> on x64 is able to generate a conditional move, so there is no difference between the sorted and unsorted data - both are fast.</li>
</ul>
<p>(Or somewhat fast: for the already-sorted case, <code>cmov</code> can be slower
especially if GCC puts it on the critical path instead of just <code>add</code>,
especially on Intel before Broadwell where <code>cmov</code> has 2 cycle latency: gcc
optimization flag -O3 makes code slower than -O2)</p>
<ul>
<li>
<p>VC++ 2010 is unable to generate conditional moves for this branch even under <code>/Ox</code>.</p>
</li>
<li>
<p>Intel C++ Compiler (ICC) 11 does something miraculous. It interchanges the two loops, thereby hoisting the unpredictable branch to the outer loop. Not only is it immune to the mispredictions, it's also twice as fast as whatever VC++ and GCC can generate! In other words, ICC took advantage of the test-loop to defeat the benchmark...</p>
</li>
<li>
<p>If you give the Intel compiler the branchless code, it just outright vectorizes it... and is just as fast as with the branch (with the loop interchange).</p>
</li>
</ul>
<p>This goes to show that even mature modern compilers can vary wildly in their
ability to optimize code...</p>
<p><br></p>
<h3>Suggest</h3>
<p><strong>Branch prediction.</strong></p>
<p>With a sorted array, the condition <code>data[c] &gt;= 128</code> is first <code>false</code> for a
streak of values, then becomes <code>true</code> for all later values. That's easy to
predict. With an unsorted array, you pay for the branching cost.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/welcome-to-nikola/" class="u-url">Welcome to Nikola</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/roberto-alsina/">Roberto Alsina</a>
            </span></p>
            <p class="dateline">
            <a href="posts/welcome-to-nikola/" rel="bookmark">
            <time class="published dt-published" datetime="2012-03-30T23:00:00-03:00" itemprop="datePublished" title="2012-03-30 23:00">2012-03-30 23:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <figure><a class="reference external image-reference" href="https://farm1.staticflickr.com/138/352972944_4f9d568680_z.jpg?zz=1"><img alt="Nikola Tesla Corner by nicwest, on Flickr" class="thumbnail" src="https://farm1.staticflickr.com/138/352972944_4f9d568680.jpg"></a>
</figure><p>If you can see this in a web browser, it means you managed to install Nikola,
and build a site using it. Congratulations!</p>
<p>Next steps:</p>
<ul>
<li>
<p><a href="posts/welcome-to-nikola/#system-message-1"><span class="problematic" id="problematic-1">:doc:`Read the manual &lt;handbook&gt;`</span></a></p>
<aside class="system-message" id="system-message-1"><p class="system-message-title">System Message: ERROR/3 (<span class="docutils literal">&lt;string&gt;</span>, line 11); <em><a href="posts/welcome-to-nikola/#problematic-1">backlink</a></em></p>
<p>"handbook" slug doesn't exist.</p>
</aside>
</li>
<li><p><a class="reference external" href="https://getnikola.com">Visit the Nikola website to learn more</a></p></li>
<li><p><a class="reference external" href="galleries/demo/">See a demo photo gallery</a></p></li>
<li><p><a class="reference external" href="pages/listings-demo/">See a demo listing</a></p></li>
<li><p><a class="reference external" href="pages/dr-nikolas-vendetta/">See a demo of a longer text</a></p></li>
</ul>
<p>Send feedback to <a class="reference external" href="mailto:info@getnikola.com">info@getnikola.com</a>!</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2.html" rel="prev">Newer posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
