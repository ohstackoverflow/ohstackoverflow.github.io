<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 2743) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-2743.html">
<link rel="prev" href="index-2744.html" type="text/html">
<link rel="next" href="index-2742.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/where-is-httpcontent-readasasync/" class="u-url">Where is HttpContent.ReadAsAsync?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/where-is-httpcontent-readasasync/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T14:34:46+08:00" itemprop="datePublished" title="2023-03-05 14:34">2023-03-05 14:34</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I see in tons of examples on the web using the new <code>HttpClient</code> object (as
part of the new Web API) that there should be <code>HttpContent.ReadAsAsync&lt;T&gt;</code>
method. However, MSDN doesn't mention this method, nor does IntelliSense find
it.</p>
<p>Where did it go, and how do I work around it?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>It looks like it is an extension method (in System.Net.Http.Formatting):</p>
<p>HttpContentExtensions Class</p>
<p><strong>Update:</strong></p>
<blockquote>
<p>PM&gt; install-package Microsoft.AspNet.WebApi.Client</p>
</blockquote>
<p>According to the System.Net.Http.Formatting NuGet package page, the
<code>System.Net.Http.Formatting</code> package is now legacy and can instead be found in
the <code>Microsoft.AspNet.WebApi.Client</code> package available on NuGet here.</p>
<p><br></p>
<h3>Suggest</h3>
<p>I have the same problem, so I simply get JSON string and deserialize to my
class:</p>
<div class="code"><pre class="code literal-block">HttpResponseMessage response = await client.GetAsync("Products");
//get data as Json string 
string data = await response.Content.ReadAsStringAsync();
//use JavaScriptSerializer from System.Web.Script.Serialization
JavaScriptSerializer JSserializer = new JavaScriptSerializer();
//deserialize to your class
products = JSserializer.Deserialize&lt;List&lt;Product&gt;&gt;(data);
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/when-exactly-is-it-leak-safe-to-use-anonymous-inner-classes/" class="u-url">When exactly is it leak safe to use (anonymous) inner classes?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/when-exactly-is-it-leak-safe-to-use-anonymous-inner-classes/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T14:33:19+08:00" itemprop="datePublished" title="2023-03-05 14:33">2023-03-05 14:33</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I have been reading some articles on memory leaks in Android and watched this
interesting video from Google I/O on the subject.</p>
<p>Still, I don't fully understand the concept, and especially when it is safe or
dangerous to user <strong>inner classes inside an Activity</strong>.</p>
<p>This is what I understood:</p>
<p>A memory leak will occur if an instance of an inner class survives longer than
its outer class (an Activity). -&gt; <strong>In which situations can this happen?</strong></p>
<p>In this example, I suppose there is no risk of leak, because there is no way
the anonymous class extending <code>OnClickListener</code> will live longer than the
activity, right?</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="nv">final</span><span class="w"> </span><span class="nv">Dialog</span><span class="w"> </span><span class="nv">dialog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">Dialog</span><span class="ss">(</span><span class="nv">this</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">dialog</span>.<span class="nv">setContentView</span><span class="ss">(</span><span class="nv">R</span>.<span class="nv">layout</span>.<span class="nv">dialog_generic</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">Button</span><span class="w"> </span><span class="nv">okButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">(</span><span class="nv">Button</span><span class="ss">)</span><span class="w"> </span><span class="nv">dialog</span>.<span class="nv">findViewById</span><span class="ss">(</span><span class="nv">R</span>.<span class="nv">id</span>.<span class="nv">dialog_button_ok</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">TextView</span><span class="w"> </span><span class="nv">titleTv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">(</span><span class="nv">TextView</span><span class="ss">)</span><span class="w"> </span><span class="nv">dialog</span>.<span class="nv">findViewById</span><span class="ss">(</span><span class="nv">R</span>.<span class="nv">id</span>.<span class="nv">dialog_generic_title</span><span class="ss">)</span><span class="c1">;</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="o">***</span><span class="w"> </span><span class="nv">Handle</span><span class="w"> </span><span class="nv">button</span><span class="w"> </span><span class="nv">click</span>
<span class="w">    </span><span class="nv">okButton</span>.<span class="nv">setOnClickListener</span><span class="ss">(</span><span class="nv">new</span><span class="w"> </span><span class="nv">OnClickListener</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">        </span><span class="nv">public</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">onClick</span><span class="ss">(</span><span class="nv">View</span><span class="w"> </span><span class="nv">v</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">            </span><span class="nv">dialog</span>.<span class="nv">dismiss</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">    </span>}<span class="ss">)</span><span class="c1">;</span>

<span class="w">    </span><span class="nv">titleTv</span>.<span class="nv">setText</span><span class="ss">(</span><span class="s2">"dialog title"</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">dialog</span>.<span class="k">show</span><span class="ss">()</span><span class="c1">;</span>
</pre></div>

<p>Now, is this example dangerous, and why?</p>
<div class="code"><pre class="code literal-block"><span class="c1">// We are still inside an Activity</span>
<span class="n">_handlerToDelayDroidMove</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Handler</span><span class="p">();</span>
<span class="n">_handlerToDelayDroidMove</span><span class="p">.</span><span class="n">postDelayed</span><span class="p">(</span><span class="n">_droidPlayRunnable</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">);</span>

<span class="n">private</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="n">_droidPlayRunnable</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Runnable</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">_someFieldOfTheActivity</span><span class="p">.</span><span class="n">performLongCalculation</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>

<p>I have a doubt regarding the fact that understanding this topic has to do with
understanding in detail what is kept when an activity is destroyed and re-
created.</p>
<p>Is it?</p>
<p>Let say I just changed the orientation of the device (which is the most common
cause of leaks). When <code>super.onCreate(savedInstanceState)</code> will be called in
my <code>onCreate()</code>, will this restore the values of the fields (as they were
before orientation change)? Will this also restore the states of inner
classes?</p>
<p>I realize my question is not very precise, but I'd really appreciate any
explanation that could make things clearer.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>What you are asking is a pretty tough question. While you may think it is just
one question, you are actually asking several questions at once. I'll do my
best with the knowledge that I have to cover it and, hopefully, some others
will join in to cover what I may miss.</p>
<p><strong>Nested Classes: Introduction</strong></p>
<p>As I'm not sure how comfortable you are with OOP in Java, this will hit a
couple of basics. A nested class is when a class definition is contained
within another class. There are basically two types: Static Nested Classes and
Inner Classes. The real difference between these are:</p>
<ul>
<li>Static Nested Classes: <ul>
<li>Are considered "top-level". </li>
<li>Do not require an instance of the containing class to be constructed.</li>
<li>May not reference the containing class members without an explicit reference.</li>
<li>Have their own lifetime.</li>
</ul>
</li>
<li>Inner Nested Classes: <ul>
<li>Always require an instance of the containing class to be constructed.</li>
<li>Automatically have an implicit reference to the containing instance.</li>
<li>May access the container's class members without the reference.</li>
<li>Lifetime is <em>supposed</em> to be no longer than that of the container.</li>
</ul>
</li>
</ul>
<p><strong>Garbage Collection and Inner Classes</strong></p>
<p>Garbage Collection is automatic but tries to remove objects based on whether
it thinks they are being used. The Garbage Collector is pretty smart, but not
flawless. It can only determine if something is being used by whether or not
there is an active reference to the object.</p>
<p>The real issue here is when a inner class has been kept alive longer than its
container. This is because of the implicit reference to the containing class.
The only way this can occur is if an object outside of the containing class
keeps a reference to the inner object, without regard to the containing
object.</p>
<p>This can lead to a situation where the inner object is alive (via reference)
but the references to the containing object has already been removed from all
other objects. The inner object is, therefore, keeping the containing object
alive because it will <em>always</em> have a reference to it. The problem with this
is that unless it is programmed, there is no way to get back to the containing
object to check if it is even alive.</p>
<p>The most important aspect to this realization is that it makes no difference
whether it is in an Activity or is a drawable. You will <strong><em>always</em></strong> have to
be methodical when using inner classes and make sure that they never outlive
objects of the container. Luckily, if it isn't a core object of your code, the
leaks may be small in comparison. Unfortunately, these are some of the hardest
leaks to find, because they are likely to go unnoticed until many of them have
leaked.</p>
<p><strong>Solutions: Inner Classes</strong></p>
<ul>
<li>Gain temporary references from the containing object. </li>
<li>Allow the containing object to be the only one to keep long-lived references to the inner objects. </li>
<li>Use established patterns such as the Factory. </li>
<li>If the inner class does not require access to the containing class members, consider turning it into a static class.</li>
<li>Use with caution, regardless of whether it is in an Activity or not.</li>
</ul>
<p><strong>Activities and Views: Introduction</strong></p>
<p>Activities contain a lot of information to be able to run and display.
Activities are defined by the characteristic that they must have a View. They
also have certain automatic handlers. Whether you specify it or not, the
Activity has an implicit reference to the View it contains.</p>
<p>In order for a View to be created, it must know where to create it and whether
it has any children so that it can display. This means that every View has an
reference to the Activity (via <code>getContext()</code>). Moreover, every View keeps
references to its children (i.e. <code>getChildAt()</code>). Finally, each View keeps a
reference to the rendered Bitmap that represents its display.</p>
<p>Whenever you have a reference to an Activity (or Activity Context), this means
that you can follow the ENTIRE chain down the layout hierarchy. This is why
memory leaks regarding Activities or Views are such a huge deal. It can be a
<strong>ton</strong> of memory being leaked all at once.</p>
<p><strong>Activities, Views and Inner Classes</strong></p>
<p>Given the information above about Inner Classes, these are the most common
memory leaks, but also the most commonly avoided. While it is desirable to
have an inner class have direct access to an Activities class members, many
are willing to just make them static to avoid potential issues. The problem
with Activities and Views goes much deeper than that.</p>
<p><strong>Leaked Activities, Views and Activity Contexts</strong></p>
<p>It all comes down to the Context and the LifeCycle. There are certain events
(such as orientation) that will kill an Activity Context. Since so many
classes and methods require a Context, developers will sometimes try to save
some code by grabbing a reference to a Context and holding onto it. It just so
happens that many of the objects we have to create to run our Activity have to
exist outside of the Activity LifeCycle in order to allow the Activity to do
what it needs to do. If any of your objects happen to have a reference to an
Activity, its Context, or any of its Views when it is destroyed, you have just
leaked that Activity and its entire View tree.</p>
<p><strong>Solutions: Activities and Views</strong></p>
<ul>
<li>Avoid, at all costs, making a Static reference to a View or Activity. </li>
<li>All references to Activity Contexts should be short lived (the duration of the function)</li>
<li>If you need a long-lived Context, use the Application Context (<code>getBaseContext()</code> or <code>getApplicationContext()</code>). These do not keep references implicitly.</li>
<li>Alternatively, you may limit the destruction of an Activity by overriding Configuration Changes. However, this does not stop other potential events from destroying the Activity. While you <em>can</em> do this, you may still want to refer to the above practices.</li>
</ul>
<p><strong>Runnables: Introduction</strong></p>
<p>Runnables are actually not that bad. I mean, they <em>could</em> be, but really we've
already hit most of the danger zones. A Runnable is an asynchronous operation
that performs a task independant from the thread it was created on. Most
runnables are instantiated from the UI thread. In essence, using a Runnable is
creating another thread, just slightly more managed. If you class a Runnable
like a standard class and follow the guidelines above, you should run into few
problem. The reality is that many developers do not do this.</p>
<p>Out of ease, readability and logical program flow, many developers utilize
Anonymous Inner Classes to define their Runnables, such as the example you
create above. This results in an example like the one you typed above. An
Anonymous Inner Class is basically a discrete Inner Class. You just don't have
to create a whole new definition and simply override the appropriate methods.
In all other respects it is a Inner Class, which means that it keeps an
implicit reference to its container.</p>
<p><strong>Runnables and Activities/Views</strong></p>
<p>Yay! This section can be short! Due to the fact that Runnables run outside of
the current thread, the danger with these comes to long running asynchronous
operations. If the runnable is defined in an Activity or View as an Anonymous
Inner Class OR nested Inner Class, there are some very serious dangers. This
is because, as previously stated, it <strong><em>has</em></strong> to know who its container is.
Enter the orientation change (or system kill). Now just refer back to the
previous sections to understand what just happened. Yes, your example is quite
dangerous.</p>
<p><strong>Solutions: Runnables</strong></p>
<ul>
<li>Try and extend Runnable, if it doesn't break the logic of your code.</li>
<li>Do your best to make extended Runnables static, if they must be nested classes.</li>
<li>If you must use Anonymous Runnables, avoid creating them in <strong><em>any</em></strong> object that has a long-lived reference to an Activity or View that is in use.</li>
<li>Many Runnables could just as easily have been AsyncTasks. Consider using AsyncTask as those are VM Managed by default.</li>
</ul>
<p><strong>Answering the Final Question</strong> Now to answer the questions that were not
<em>directly</em> addressed by the other sections of this post. You asked "When can
an object of an inner class survive longer than its outer class?" Before we
get to this, let me reemphasize: though you are right to worry about this in
Activities, it can cause a leak anywhere. I shall provide a simple example
(without using an Activity) just to demonstrate.</p>
<p>Below is a common example of a basic factory (missing the code).</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">class</span><span class="w"> </span><span class="nv">LeakFactory</span>
{<span class="o">//</span><span class="nv">Just</span><span class="w"> </span><span class="nv">so</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">we</span><span class="w"> </span><span class="nv">have</span><span class="w"> </span><span class="nv">some</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">leak</span>
<span class="w">    </span><span class="nv">int</span><span class="w"> </span><span class="nv">myID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">;</span>
<span class="o">//</span><span class="w"> </span><span class="nv">Necessary</span><span class="w"> </span><span class="nv">because</span><span class="w"> </span><span class="nv">our</span><span class="w"> </span><span class="nv">Leak</span><span class="w"> </span><span class="nv">class</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">Inner</span><span class="w"> </span><span class="nv">class</span>
<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">Leak</span><span class="w"> </span><span class="nv">createLeak</span><span class="ss">()</span>
<span class="w">    </span>{
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">Leak</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span>}

<span class="o">//</span><span class="w"> </span><span class="nv">Mass</span><span class="w"> </span><span class="nv">Manufactured</span><span class="w"> </span><span class="nv">Leak</span><span class="w"> </span><span class="nv">class</span>
<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">class</span><span class="w"> </span><span class="nv">Leak</span>
<span class="w">    </span>{<span class="o">//</span><span class="nv">Again</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">little</span><span class="w"> </span><span class="nv">data</span>.
<span class="w">       </span><span class="nv">int</span><span class="w"> </span><span class="nv">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="c1">;</span>
<span class="w">    </span>}
}
</pre></div>

<p>This is a not as common example, but simple enough to demonstrate. The key
here is the constructor...</p>
<div class="code"><pre class="code literal-block"><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">SwissCheese</span>
<span class="err">{</span><span class="o">//</span><span class="n">Can</span><span class="s1">'t have swiss cheese without some holes</span>
<span class="s1">    public Leak[] myHoles;</span>

<span class="s1">    public SwissCheese()</span>
<span class="s1">    {//Gotta have a Factory to make my holes</span>
<span class="s1">        LeakFactory _holeDriller = new LeakFactory()</span>
<span class="s1">    // Now, let'</span><span class="n">s</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">holes</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">them</span><span class="p">.</span>
<span class="w">        </span><span class="n">myHoles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Leak</span><span class="o">[</span><span class="n">1000</span><span class="o">]</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">1000</span><span class="p">)</span>
<span class="w">        </span><span class="err">{</span><span class="o">//</span><span class="n">Store</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="k">member</span>
<span class="w">            </span><span class="n">myHoles</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_holeDriller</span><span class="p">.</span><span class="n">createLeak</span><span class="p">();</span>
<span class="w">        </span><span class="err">}</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Yay</span><span class="err">!</span><span class="w"> </span><span class="n">We</span><span class="s1">'re done!</span>

<span class="s1">    // Buh-bye LeakFactory. I don'</span><span class="n">t</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">anymore</span><span class="p">...</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>Now, we have Leaks, but no Factory. Even though we released the Factory, it
will remain in memory because every single Leak has a reference to it. It
doesn't even matter that the outer class has no data. This happens far more
often than one might think. We don't need the creator, just its creations. So
we create one temporarily, but use the creations indefinitely.</p>
<p>Imagine what happens when we change the constructor just slightly.</p>
<div class="code"><pre class="code literal-block"><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">SwissCheese</span>
<span class="err">{</span><span class="o">//</span><span class="n">Can</span><span class="s1">'t have swiss cheese without some holes</span>
<span class="s1">    public Leak[] myHoles;</span>

<span class="s1">    public SwissCheese()</span>
<span class="s1">    {//Now, let'</span><span class="n">s</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">holes</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">them</span><span class="p">.</span>
<span class="w">        </span><span class="n">myHoles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Leak</span><span class="o">[</span><span class="n">1000</span><span class="o">]</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">1000</span><span class="p">)</span>
<span class="w">        </span><span class="err">{</span><span class="o">//</span><span class="n">WOW</span><span class="err">!</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">don</span><span class="err">'</span><span class="n">t</span><span class="w"> </span><span class="n">even</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">Factory</span><span class="p">...</span><span class="w"> </span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">SOOOO</span><span class="w"> </span><span class="n">much</span><span class="w"> </span><span class="n">prettier</span><span class="p">....</span>
<span class="w">            </span><span class="n">myHoles</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LeakFactory</span><span class="p">().</span><span class="n">createLeak</span><span class="p">();</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>Now, every single one of those new LeakFactories has just been leaked. What do
you think of that? Those are two very common examples of how a inner class can
outlive an outer class of any type. If that outer class had been an Activity,
imagine how much worse it would have been.</p>
<p><strong>Conclusion</strong></p>
<p>These list the primarily known dangers of using these objects inappropriately.
In general, this post should have covered most of your questions, but I
understand it was a loooong post, so if you need clarification, just let me
know. As long as you follow the above practices, you will have very little
worry of leakage.</p>
<p><br></p>
<h3>Suggest</h3>
<p>You have 2 questions in 1 post:</p>
<ol>
<li>It's never safe to use inner class without declaring it as <code>static</code>. It's not limited to just Android but applicable to the whole Java world.</li>
</ol>
<p>More detailed explanation here</p>
<p>Examples of common inner classes to check whether you are using <code>static class
InnerAdapter</code> or just <code>class InnerAdapter</code> are lists (<code>ListView</code> or
<code>RecyclerView</code>, tab + page layout (<code>ViewPager</code>), dropdown and <strong>AsyncTask
subclasses</strong></p>
<ol>
<li>Doesn't matter whether you use Handler + Runnable, AsyncTask, RxJava or whatever else, if the operation completes after the Activity/ Fragment/ View is destroyed, you'd create a rouge reference of the Activity/ Fragment/ View object (which are huge) that cannot garbage collected (memory slots that cannot be freed)</li>
</ol>
<p>So make sure to cancel those long-running task in <code>onDestroy()</code> or earlier and
there would be no memory leak</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-the-single-threaded-non-blocking-io-model-works-in-node-js/" class="u-url">How the single threaded non blocking IO model works in Node.js</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-the-single-threaded-non-blocking-io-model-works-in-node-js/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T14:31:58+08:00" itemprop="datePublished" title="2023-03-05 14:31">2023-03-05 14:31</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I'm not a Node programmer, but I'm interested in how <strong>the single-threaded
non-blocking IO model</strong> works. After I read the article understanding-the-
node-js-event-loop, I'm really confused about it. It gave an example for the
model:</p>
<div class="code"><pre class="code literal-block">c.query(
<span class="w">   </span>'SELECT<span class="w"> </span>SLEEP(20);',
<span class="w">   </span>function<span class="w"> </span>(err,<span class="w"> </span>results,<span class="w"> </span>fields)<span class="w"> </span>{
<span class="w">     </span>if<span class="w"> </span>(err)<span class="w"> </span>{
<span class="w">       </span>throw<span class="w"> </span>err;
<span class="w">     </span>}
<span class="w">     </span>res.writeHead(200,<span class="w"> </span>{'Content-Type':<span class="w"> </span>'text/html'});
<span class="w">     </span>res.end('<span class="nt">&lt;html&gt;&lt;head&gt;&lt;title&gt;</span>Hello<span class="nt">&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;</span>Return<span class="w"> </span>from<span class="w"> </span>async<span class="w"> </span>DB<span class="w"> </span>query<span class="nt">&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span>');
<span class="w">     </span>c.end();
<span class="w">    </span>}
);
</pre></div>

<p><strong>Que:</strong> When there are two requests A(comes first) and B since there is only
a single thread, the server-side program will handle the request A firstly:
doing SQL querying is asleep statement standing for I/O wait. And The program
is stuck at the <code>I/O</code> waiting, and cannot execute the code which renders the
web page behind. Will the program switch to request B during the waiting? In
my opinion, because of the single thread model, there is no way to switch one
request from another. But the title of the example code says that <strong>everything
runs in parallel except your code</strong>.</p>
<blockquote>
<p>(P.S I'm not sure if I misunderstand the code or not since I have never used
Node.)How Node switch A to B during the waiting? And can you explain <strong>the
single-threaded non-blocking IO model</strong> of Node in a simple way? I would
appreciate it if you could help me. :)</p>
</blockquote>
<p><br><br></p>
<h2>Answer</h2>
<p>Node.js is built upon libuv, a cross-platform library that abstracts
apis/syscalls for asynchronous (non-blocking) input/output provided by the
supported OSes (Unix, OS X and Windows at least).</p>
<h3>Asynchronous IO</h3>
<p>In this programming model open/read/write operation on devices and resources
(sockets, filesystem, etc.) managed by the file-system <em>don't block the
calling thread</em> (as in the typical synchronous c-like model) and just mark the
process (in kernel/OS level data structure) to be notified when new data or
events are available. In case of a web-server-like app, the process is then
responsible to figure out which request/context the notified event belongs to
and proceed processing the request from there. Note that this will necessarily
mean you'll be on a different stack frame from the one that originated the
request to the OS as the latter had to yield to a process' dispatcher in order
for a single threaded process to handle new events.</p>
<p>The problem with the model I described is that it's not familiar and hard to
reason about for the programmer as it's non-sequential in nature. "You need to
make request in function A and handle the result in a different function where
your locals from A are usually not available."</p>
<h3>Node's model (Continuation Passing Style and Event Loop)</h3>
<p>Node tackles the problem leveraging javascript's language features to make
this model a little more synchronous-looking by inducing the programmer to
employ a certain programming style. Every function that requests IO has a
signature like <code>function (... parameters ..., callback)</code> and needs to be given
a callback that will be invoked when the requested operation is completed
(keep in mind that most of the time is spent waiting for the OS to signal the
completion - time that can be spent doing other work). Javascript's support
for closures allows you to use variables you've defined in the outer (calling)
function inside the body of the callback - this allows to keep state between
different functions that will be invoked by the node runtime independently.
See also Continuation Passing Style.</p>
<p>Moreover, after invoking a function spawning an IO operation the calling
function will usually <code>return</code> control to node's <strong>event loop</strong>. This loop
will invoke the next callback or function that was scheduled for execution
(most likely because the corresponding event was notified by the OS) - this
allows the concurrent processing of multiple requests.</p>
<p>You can think of node's event loop as <strong>somewhat similar to the kernel's
dispatcher</strong> : the kernel would schedule for execution a blocked thread once
its pending IO is completed while node will schedule a callback when the
corresponding event has occured.</p>
<h3>Highly concurrent, no parallelism</h3>
<p>As a final remark, the phrase "everything runs in parallel except your code"
does a decent job of capturing the point that node allows your code to handle
requests from <em>hundreds of thousands open socket with a single thread</em>
concurrently by multiplexing and sequencing all your js logic in a single
stream of execution (even though saying "everything runs in parallel" is
probably not correct here - see Concurrency vs Parallelism - What is the
difference?). This works pretty well for webapp servers as most of the time is
actually spent on waiting for network or disk (database / sockets) and the
logic is not really CPU intensive - that is to say: <strong>this works well for IO-
bound workloads</strong>.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Well, to give some perspective, let me compare node.js with apache.</p>
<p>Apache is a multi-threaded HTTP server, for each and every request that the
server receives, it creates a separate thread which handles that request.</p>
<p>Node.js on the other hand is event driven, handling all requests
asynchronously from single thread.</p>
<p>When A and B are received on apache, two threads are created which handle
requests. Each handling the query separately, each waiting for the query
results before serving the page. The page is only served until the query is
finished. The query fetch is blocking because the server cannot execute the
rest of thread until it receives the result.</p>
<p>In node, c.query is handled asynchronously, which means while c.query fetches
the results for A, it jumps to handle c.query for B, and when the results
arrive for A arrive it sends back the results to callback which sends the
response. Node.js knows to execute callback when fetch finishes.</p>
<blockquote>
<p>In my opinion, because it's a single thread model, there is no way to switch
from one request to another.</p>
</blockquote>
<p>Actually the node server does exactly that for you all the time. To make
switches, (the asynchronous behavior) most functions that you would use will
have callbacks.</p>
<h4>Edit</h4>
<p>The SQL query is taken from mysql library. It implements callback style as
well as event emitter to queue SQL requests. It does not execute them
asynchronously, that is done by the internal libuv threads that provide the
abstraction of non-blocking I/O. The following steps happen for making a query
:</p>
<ol>
<li>Open a connection to db, connection itself can be made asynchronously.</li>
<li>Once db is connected, query is passed on to the server. Queries can be queued.</li>
<li>The main event loop gets notified of the completion with callback or event.</li>
<li>Main loop executes your callback/eventhandler.</li>
</ol>
<p>The incoming requests to http server are handled in the similar fashion. The
internal thread architecture is something like this:</p>
<p><img alt="node.js event loop" src="images/YCTgK.png"></p>
<p>The C++ threads are the libuv ones which do the asynchronous I/O (disk or
network). The main event loop continues to execute after the dispatching the
request to thread pool. It can accept more requests as it does not wait or
sleep. SQL queries/HTTP requests/file system reads all happen this way.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2744.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2742.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
