<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1490) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1490.html">
<link rel="prev" href="index-1491.html" type="text/html">
<link rel="next" href="index-1489.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-to-set-up-and-use-the-kin-blockchain-in-a-unity-app-step-by-step/" class="u-url">How to set up and use the Kin blockchain in a Unity app - Step by step</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-to-set-up-and-use-the-kin-blockchain-in-a-unity-app-step-by-step/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-28T05:12:22+08:00" itemprop="datePublished" title="2023-02-28 05:12">2023-02-28 05:12</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>What is a good step by step explanation on how to use the Kin Unity SDK in an
empty project in Unity?</p>
<p><br><br></p>
<h2>Answer</h2>
<h2>Option 1: Use a pre-made wrapper</h2>
<p>Use the wrapper in this 10 minute set up code (client and server) and call it
as follows:</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="nv">kinWrapper</span>.<span class="nv">SendPayment</span><span class="ss">(</span><span class="mi">1</span>.<span class="mi">00</span><span class="nv">M</span>,<span class="w"> </span><span class="s2">"test send"</span>,<span class="w"> </span><span class="nv">address</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">kinWrapper</span>.<span class="nv">Balance</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span><span class="o">//</span><span class="nv">etc</span>
</pre></div>

<p>Here is a detailed tutorial on implmenting the wrapper.</p>
<h2>Option 2: Create your own wrapper</h2>
<p>The Kin blockchain is a fork of the stellar protocol. As such, operations in
your app will boil down to the following:</p>
<ol>
<li>Creating accounts on the blockchain</li>
<li>Funding accounts on the blockchain</li>
<li>Sending payments</li>
</ol>
<p>You can clone a sample implementation here - or you can follow the steps below
to get a basic understanding.</p>
<h2>Installation</h2>
<p>Create an empty Unity project, and install the Kin Unity Plugin and modify
your gradle file as described here.</p>
<p><strong>NOTE:</strong> The SDK only runs on an Android/iOS device or emulator. The SDK
<em>will not run</em> in the unity editor or unity remote -so you will need to
compile and run the code in an emulator or device.</p>
<h2>Implementation</h2>
<p>Create an empty MonoBehaviour script - name it <em>KinWrapper</em> , and declare the
Kin namespace:</p>
<div class="code"><pre class="code literal-block">    using Kin;
</pre></div>

<p>You can also enable blockchain listeners by adding the following to your
MonoBehaviour :</p>
<div class="code"><pre class="code literal-block">    public class KinWrapper : MonoBehaviour, IPaymentListener, IBalanceListener
</pre></div>

<h3>Instantiating</h3>
<p>Next declare instances of the Kin Client and Kin Account</p>
<div class="code"><pre class="code literal-block">    private KinClient kinClient;
    private KinAccount kinAccount;
</pre></div>

<p>The <em>client</em> handles the native code depending on the platform you are using.
(Android or iOS). The <em>account</em> is the main interface you will be using.</p>
<h4>Creating an account</h4>
<p>Before using the account, you first have to instantiate it through the client.</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="nv">kinClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">KinClient</span><span class="ss">(</span><span class="nv">Kin</span>.<span class="nv">Environment</span>.<span class="nv">Test</span>,<span class="w"> </span><span class="s2">"appId"</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="o">!</span><span class="nv">kinClient</span>.<span class="nv">HasAccount</span><span class="ss">())</span><span class="w"> </span>
<span class="w">    </span>{
<span class="w">        </span><span class="nv">kinAccount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">kinClient</span>.<span class="nv">AddAccount</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span>}<span class="k">else</span>{
<span class="w">        </span><span class="nv">kinAccount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">kinClient</span>.<span class="nv">GetAccount</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span>}
</pre></div>

<p>The code above first checks to see if a local account exists on the device. If
it doesn't, it creates an account on the device and returns that as a
reference.</p>
<p><strong>NOTE:</strong> A 'created account' is simply a public key and private key generated
on the device. These local keys enable the device to communicate with the
blockchain.</p>
<p>You can now get the public key (client's blockchain address) by calling:</p>
<div class="code"><pre class="code literal-block">    kinAccount.GetPublicAddress();
</pre></div>

<h4>Onboarding/ Funding an account</h4>
<p>Because this key only exists locally, you need to 'on-board' it to the
blockchain. In other words, a special function needs to be called, to fund and
register it online. Before this step is done, the address is considered
invalid on the blockchain, and cannot receive or make transactions. This is
part of the stellar protocol to avoid spam and unnecessary account creation.</p>
<p>You can check if the account has been on-boarded and funded by calling the
following function:</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="nv">kinAccount</span>.<span class="nv">GetStatus</span><span class="ss">(</span><span class="nv">GetStatusCallback</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">void</span><span class="w"> </span><span class="nv">GetStatusCallback</span><span class="ss">(</span><span class="nv">KinException</span><span class="w"> </span><span class="nv">ex</span>,<span class="w"> </span><span class="nv">AccountStatus</span><span class="w"> </span><span class="nv">status</span><span class="ss">)</span>
<span class="w">    </span>{
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">AccountStatus</span>.<span class="nv">Created</span><span class="ss">)</span>
<span class="w">         </span>{

<span class="w">         </span>}
<span class="w">          </span><span class="k">else</span>
<span class="w">         </span>{

<span class="w">         </span>}
<span class="w">    </span>}
</pre></div>

<p>To on-board and fund an account on the test blockchain, you have 3 options:</p>
<p><strong>Option 1:</strong> You can do this manually by pasting the address on Kin's friend-
bot service. This will on-board the account for you automatically.</p>
<p><strong>Option 2:</strong> You can call the friend-bot through your code as an http request
https://friendbot-testnet.kininfrastructure.com/?addr=address_here</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">IEnumerator</span><span class="w"> </span><span class="n">FundAccount</span><span class="p">(</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">publicAddress</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&lt;</span><span class="nb nb-Type">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">onComplete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"http://friendbot-testnet.kininfrastructure.com/?addr="</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">publicAddress</span><span class="p">;</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnityWebRequest</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="p">);</span>

<span class="w">        </span><span class="nb">yield</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">SendWebRequest</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">isNetworkError</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">isHttpError</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Debug</span><span class="o">.</span><span class="n">Log</span><span class="p">(</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">error</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">onComplete</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="p">)</span>
<span class="w">                </span><span class="n">onComplete</span><span class="p">(</span><span class="w"> </span><span class="bp">false</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Debug</span><span class="o">.</span><span class="n">Log</span><span class="p">(</span><span class="w"> </span><span class="s2">"response code: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">responseCode</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="n">Debug</span><span class="o">.</span><span class="n">Log</span><span class="p">(</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">downloadHandler</span><span class="o">.</span><span class="n">text</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">onComplete</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="p">)</span>
<span class="w">                </span><span class="n">onComplete</span><span class="p">(</span><span class="w"> </span><span class="bp">true</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>

<p><strong>Option 3:</strong> You can use server side code to fund it yourself (which you must
do in a production environment). Basically, your client will need to call your
server and request to be on-boarded. Your server can then use Kin's python SDK
or node SDK to perform the on-boarding.</p>
<p>Here is a handy python implementation or Node.js implementation you can use
for your server.</p>
<p>Calling the implementation from Unity is as simple as follows:</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">IEnumerator</span><span class="w"> </span><span class="n">FundMe</span><span class="p">(</span><span class="n">decimal</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&lt;</span><span class="nb nb-Type">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fundCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">WWWForm</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">WWWForm</span><span class="p">();</span>
<span class="w">        </span><span class="n">form</span><span class="o">.</span><span class="n">AddField</span><span class="p">(</span><span class="s2">"address"</span><span class="p">,</span><span class="w"> </span><span class="n">kinAccount</span><span class="o">.</span><span class="n">GetPublicAddress</span><span class="p">());</span>
<span class="w">        </span><span class="n">form</span><span class="o">.</span><span class="n">AddField</span><span class="p">(</span><span class="s2">"amount"</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="o">.</span><span class="n">ToString</span><span class="p">());</span>
<span class="w">        </span><span class="n">reqUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"http://address.to.your.server"</span><span class="p">;</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnityWebRequest</span><span class="o">.</span><span class="n">Post</span><span class="p">(</span><span class="n">reqUrl</span><span class="p">,</span><span class="w"> </span><span class="n">form</span><span class="p">);</span>
<span class="w">        </span><span class="nb">yield</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">SendWebRequest</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">isNetworkError</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">isHttpError</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Debug</span><span class="o">.</span><span class="n">LogError</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">error</span><span class="p">);</span>
<span class="w">            </span><span class="n">fundCallback</span><span class="p">(</span><span class="bp">false</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">fundCallback</span><span class="p">(</span><span class="bp">true</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>

<p><strong>NOTE:</strong> Kin has two blockchains. Production and Test. The test blockchain
merely has "play currency" that you can run tests on without incurring costs.
The production blockchain has real world value Kin</p>
<h3>Calling Other Functions</h3>
<h4>GetBalance()</h4>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="nt">account</span><span class="p">.</span><span class="nc">GetBalance</span><span class="o">(</span><span class="nt">GetBalanceCallback</span><span class="o">);</span>
<span class="w">    </span><span class="nt">void</span><span class="w"> </span><span class="nt">GetBalanceCallback</span><span class="o">(</span><span class="nt">KinException</span><span class="w"> </span><span class="nt">ex</span><span class="o">,</span><span class="w"> </span><span class="nt">decimal</span><span class="w"> </span><span class="nt">balance</span><span class="o">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">(ex</span><span class="w"> </span><span class="err">==</span><span class="w"> </span><span class="err">null)</span>
<span class="w">        </span><span class="err">{</span>
<span class="w">            </span><span class="err">Debug.Log(</span><span class="w"> </span><span class="err">"</span><span class="n">Balance</span><span class="p">:</span><span class="w"> </span><span class="s2">" + balance );</span>
<span class="s2">        }</span>
<span class="s2">        else</span>
<span class="s2">        {</span>
<span class="s2">            Debug.LogError( "</span><span class="n">Get</span><span class="w"> </span><span class="n">Balance</span><span class="w"> </span><span class="n">Failed</span><span class="o">.</span><span class="w"> </span><span class="err">"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="err">}</span>
</pre></div>

<h4>DeleteAccount()</h4>
<div class="code"><pre class="code literal-block">    kinClient.DeleteAccount(0);
</pre></div>

<p><strong>NOTE:</strong> GetBalance() needs a callback because it's communicating with the
blockchain online. DeleteAccount() doesn't because it simply deletes the
private and public keys on the client. Once deleted, these keys can not be
recovered.</p>
<h3>Handling transactions</h3>
<p>Transactions have the following parameters:</p>
<ol>
<li>
<p><strong>Memo:</strong> an optional string with extra information.</p>
</li>
<li>
<p><strong>Address:</strong> the address of the recipient</p>
</li>
<li>
<p><strong>Amount:</strong> amount of Kin you are sending (excluding fees)</p>
</li>
<li>
<p><strong>Fee:</strong> the fee you will pay for your transaction to be processed by the blockchain. The current fee is 100/100000 KIN. This fee protects the blockchain from spam.</p>
</li>
</ol>
<p><strong>NOTE:</strong> The fee is denominated in the smallest unit of Kin. (Quark). Just
like the smallest unit of a dollar is a cent. So when calling a transaction,
set the fee to 100 (quarks) - which is 100/100000 KIN. Setting the fee tells
the blockchain you are explicitly agreeing to pay the transaction fee. If you
set the fee too low, your transaction will be rejected.</p>
<p>You can view all transactions on Kin's blockchain at:
https://laboratory.kin.org/index.html#explorer?resource=payments</p>
<p>To send a payment, first build the transaction locally :</p>
<div class="code"><pre class="code literal-block">    kinAccount.BuildTransaction(address, amount, fee, memo, BuildTransactionCallBack);
</pre></div>

<p>Building a transaction performs several operations on the client to authorise
it and sign it. After the transaction is built, use the following callback to
send it to Kin's blockchain.</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="nv">void</span><span class="w"> </span><span class="nv">BuildTransactionCallBack</span><span class="ss">(</span><span class="nv">KinException</span><span class="w"> </span><span class="nv">ex</span>,<span class="w"> </span><span class="nv">Transaction</span><span class="w"> </span><span class="nv">transaction</span><span class="ss">)</span>
<span class="w">    </span>{
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">ex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span>
<span class="w">        </span>{
<span class="w">            </span><span class="nv">kinAccount</span>.<span class="nv">SendTransaction</span><span class="ss">(</span><span class="nv">transaction</span>,<span class="w"> </span><span class="nv">SendTransactionCallback</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span>{
<span class="w">            </span><span class="nv">Debug</span>.<span class="nv">LogError</span><span class="ss">(</span><span class="s2">"Build Transaction Failed. "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">ex</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">    </span>}
</pre></div>

<p>Once you have sent the transaction to Kin's blockchain, you can listen for the
response, to make sure it went through correctly. A transaction typically
takes less than 10 seconds to complete.</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="nv">void</span><span class="w"> </span><span class="nv">SendTransactionCallback</span><span class="ss">(</span><span class="nv">KinException</span><span class="w"> </span><span class="nv">ex</span>,<span class="w"> </span><span class="nv">String</span><span class="w"> </span><span class="nv">transactionId</span><span class="ss">)</span>
<span class="w">    </span>{
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">ex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span>
<span class="w">        </span>{
<span class="w">            </span><span class="o">//</span><span class="nv">Success</span>
<span class="w">        </span>}
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span>{
<span class="w">            </span><span class="nv">Debug</span>.<span class="nv">LogError</span><span class="ss">(</span><span class="s2">"Send Transaction Failed. "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">ex</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">    </span>}
</pre></div>

<p><strong>NOTE:</strong> You should use co-routines for functions that need to wait. This
will prevent your code from hanging while waiting for responses, and will
create a better user experience.</p>
<h3>Sending transactions with zero fees</h3>
<p>You can send transactions with zero fees by being whitelisted by the Kin
Foundation. To get whitelisted, simply register with the Kin Developer
Program. Once approved, you can perform an extra step to let your client send
transactions with zero fees.</p>
<p>To send a zero-fee transaction after building the transaction:</p>
<ol>
<li>
<p>The client will need to contact your whitelisted server.</p>
</li>
<li>
<p>Your server will approve/ sign the transaction and send it back to the client.</p>
</li>
<li>
<p>The client will then send this approved transaction to Kin's blockchain, and it will be processed for free.</p>
</li>
</ol>
<p>We have already built the transaction, now we whitelist it</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="nv">void</span><span class="w"> </span><span class="nv">BuildTransactionCallBack</span><span class="ss">(</span><span class="nv">KinException</span><span class="w"> </span><span class="nv">ex</span>,<span class="w"> </span><span class="nv">Transaction</span><span class="w"> </span><span class="nv">transaction</span><span class="ss">)</span>
<span class="w">    </span>{
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">ex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span>
<span class="w">        </span>{
<span class="w">            </span><span class="nv">StartCoroutine</span><span class="ss">(</span><span class="nv">WhitelistTransaction</span><span class="ss">(</span><span class="nv">transaction</span>,<span class="w"> </span><span class="nv">WhitelistTransactionCallback</span><span class="ss">))</span>
<span class="w">        </span>}
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span>{
<span class="w">            </span><span class="nv">Debug</span>.<span class="nv">LogError</span><span class="ss">(</span><span class="s2">"Build Transaction Failed. "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">ex</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">    </span>}
</pre></div>

<p>We are calling our whitelisted server to authorise the transaction</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="n">IEnumerator</span><span class="w"> </span><span class="n">WhitelistTransaction</span><span class="p">(</span><span class="n">Transaction</span><span class="w"> </span><span class="n">transaction</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">onComplete</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">postDataObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">WhitelistPostData</span><span class="p">(</span><span class="n">transaction</span><span class="p">);</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">postData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JsonUtility</span><span class="o">.</span><span class="n">ToJson</span><span class="p">(</span><span class="n">postDataObj</span><span class="p">);</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">rawPostData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Encoding</span><span class="o">.</span><span class="n">UTF8</span><span class="o">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">postData</span><span class="p">);</span>

<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">UnityWebRequest</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">correclty</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">posting</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">JSON</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">byte</span><span class="p">[]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">hacky</span><span class="w"> </span><span class="n">workaround</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnityWebRequest</span><span class="o">.</span><span class="n">Post</span><span class="p">(</span><span class="n">baseURL</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">whitelistURL</span><span class="p">,</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">);</span>
<span class="w">        </span><span class="n">req</span><span class="o">.</span><span class="n">SetRequestHeader</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span><span class="w"> </span><span class="s2">"application/json"</span><span class="p">);</span>
<span class="w">        </span><span class="n">req</span><span class="o">.</span><span class="n">uploadHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">UploadHandlerRaw</span><span class="p">(</span><span class="n">rawPostData</span><span class="p">);</span>

<span class="w">        </span><span class="nb">yield</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">SendWebRequest</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">isNetworkError</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">isHttpError</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Debug</span><span class="o">.</span><span class="n">LogError</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">error</span><span class="p">);</span>
<span class="w">            </span><span class="n">onComplete</span><span class="p">(</span><span class="nb nb-Type">null</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">onComplete</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">downloadHandler</span><span class="o">.</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="n">transaction</span><span class="o">.</span><span class="n">Id</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>

<p>Our server has approved the transaction and sent back a signed string. We now
send this signed string to Kin's blockchain</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="nv">void</span><span class="w"> </span><span class="nv">WhitelistTransactionCallback</span><span class="ss">(</span><span class="nv">string</span><span class="w"> </span><span class="nv">whitelistTransaction</span>,<span class="w"> </span><span class="nv">string</span><span class="w"> </span><span class="nv">transactionId</span><span class="ss">)</span>
<span class="w">    </span>{
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">whitelistTransaction</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span>
<span class="w">        </span>{
<span class="w">            </span><span class="nv">kinAccount</span>.<span class="nv">SendWhitelistTransaction</span><span class="ss">(</span><span class="nv">transactionId</span>,<span class="w"> </span><span class="nv">whitelistTransaction</span>,<span class="w"> </span><span class="nv">SendTransactionCallback</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span>{
<span class="w">            </span><span class="nv">Debug</span>.<span class="nv">LogError</span><span class="ss">(</span><span class="s2">"Whitelisting Transaction Failed. "</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">    </span>}
</pre></div>

<p>As usual, we wait to see if the transaction was successful</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="nv">void</span><span class="w"> </span><span class="nv">SendTransactionCallback</span><span class="ss">(</span><span class="nv">KinException</span><span class="w"> </span><span class="nv">ex</span>,<span class="w"> </span><span class="nv">String</span><span class="w"> </span><span class="nv">transactionId</span><span class="ss">)</span>
<span class="w">    </span>{
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">ex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span>
<span class="w">        </span>{
<span class="w">            </span><span class="o">//</span><span class="nv">Success</span>
<span class="w">        </span>}
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span>{
<span class="w">            </span><span class="nv">Debug</span>.<span class="nv">LogError</span><span class="ss">(</span><span class="s2">"Send Transaction Failed. "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">ex</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">    </span>}
</pre></div>

<p>Before your server has been approved for whitelisting, you can use this pre-
approved server in the TEST environment. http://34.239.111.38:3000/whitelist.</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">IEnumerator</span><span class="w"> </span><span class="n">WhitelistTransaction</span><span class="p">(</span><span class="w"> </span><span class="n">Transaction</span><span class="w"> </span><span class="n">transaction</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">onComplete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">postDataObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">WhitelistPostData</span><span class="p">(</span><span class="w"> </span><span class="n">transaction</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">postData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JsonUtility</span><span class="o">.</span><span class="n">ToJson</span><span class="p">(</span><span class="w"> </span><span class="n">postDataObj</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">rawPostData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Encoding</span><span class="o">.</span><span class="n">UTF8</span><span class="o">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="w"> </span><span class="n">postData</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">UnityWebRequest</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">correclty</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">posting</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">JSON</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">byte</span><span class="p">[]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">hacky</span><span class="w"> </span><span class="n">workaround</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"http://34.239.111.38:3000/whitelist"</span><span class="p">;</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnityWebRequest</span><span class="o">.</span><span class="n">Post</span><span class="p">(</span><span class="w"> </span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="s2">"POST"</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="n">req</span><span class="o">.</span><span class="n">SetRequestHeader</span><span class="p">(</span><span class="w"> </span><span class="s2">"Content-Type"</span><span class="p">,</span><span class="w"> </span><span class="s2">"application/json"</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="n">req</span><span class="o">.</span><span class="n">uploadHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">UploadHandlerRaw</span><span class="p">(</span><span class="w"> </span><span class="n">rawPostData</span><span class="w"> </span><span class="p">);</span>

<span class="w">        </span><span class="nb">yield</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">SendWebRequest</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">isNetworkError</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">isHttpError</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Debug</span><span class="o">.</span><span class="n">Log</span><span class="p">(</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">error</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">onComplete</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="p">)</span>
<span class="w">                </span><span class="n">onComplete</span><span class="p">(</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Debug</span><span class="o">.</span><span class="n">Log</span><span class="p">(</span><span class="w"> </span><span class="s2">"response code: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">responseCode</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="n">Debug</span><span class="o">.</span><span class="n">Log</span><span class="p">(</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">downloadHandler</span><span class="o">.</span><span class="n">text</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">onComplete</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="p">)</span>
<span class="w">                </span><span class="n">onComplete</span><span class="p">(</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">downloadHandler</span><span class="o">.</span><span class="n">text</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>

<p>Once approved, you can use the sample python implementation or Node.js
implementation to approve transactions on your server. You can also use the
node.js SDK.</p>
<h3>Listening to events on the blockchain</h3>
<p>You can add listeners to prevent your client from over-querying the
blockchain. Simply add the following code</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="nv">kinAccount</span>.<span class="nv">AddPaymentListener</span><span class="ss">(</span><span class="nv">this</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">kinAccount</span>.<span class="nv">AddBalanceListener</span><span class="ss">(</span><span class="nv">this</span><span class="ss">)</span><span class="c1">;</span>

<span class="w">   </span><span class="nv">public</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">OnEvent</span><span class="ss">(</span><span class="nv">PaymentInfo</span><span class="w"> </span><span class="nv">data</span><span class="ss">)</span>
<span class="w">   </span>{
<span class="w">         </span><span class="o">//</span><span class="nv">Listening</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">incoming</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">outgoing</span><span class="w"> </span><span class="nv">payments</span>
<span class="w">   </span>}

<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">OnEvent</span><span class="ss">(</span><span class="nv">decimal</span><span class="w"> </span><span class="nv">balance</span><span class="ss">)</span>
<span class="w">    </span>{
<span class="w">        </span><span class="o">//</span><span class="nv">Listening</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">changes</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">client</span><span class="err">'s balance</span>
<span class="err">    }</span>
</pre></div>

<h4>Putting it all together</h4>
<p>You can find this code implemented on: https://github.com/hitwill/kin-sdk-
unity-tutorial under the MIT license.</p>
<h4>Developer Playbook</h4>
<p>You can also check this Developer Playbook - for some higher level concepts of
creating with Kin.</p>
<h2>Best practices</h2>
<h3>UX</h3>
<p>(placeholder)</p>
<h3>Server side security</h3>
<p>Here is a great writeup on server side security.</p>
<h3>Client side security</h3>
<p>(placeholder)</p>
<h3>Reducing calls to the blockchain</h3>
<p>(placeholder)</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/what-happens-when-certificates-got-renewed-in-hyperledger-fabric/" class="u-url">What happens when certificates got renewed in Hyperledger Fabric?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/what-happens-when-certificates-got-renewed-in-hyperledger-fabric/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-28T05:12:04+08:00" itemprop="datePublished" title="2023-02-28 05:12">2023-02-28 05:12</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I'm adopting the Hyperledger Fabric to build applications for my business.</p>
<p>Since permissioned blockchains like Fabric rely heavily on the PKI for
identity management, and the fact that every transaction on the network
requires signatures from participating components along way the transaction
flow and transactions with those signatures finally got immutably persisted in
the ledger.</p>
<p><strong>I wonder what happens if participating components would have to renew their
certificates?</strong> For example, the original certificates expired or private keys
got compromised.</p>
<p>Specifically, I want to know:</p>
<ol>
<li>
<p>Should renewal of a certificate require a new PKI key pair in best practice, or should a new certificate be created with the original key pair be created with its validity extended?</p>
</li>
<li>
<p>What if it's the case when a private key got compromised, and I have to revoke the original certificate and use a new one with a new key pair. In this case, how should I validate signatures of transactions that were already persisted in the ledger? I wonder if it means that even if a certificate were revoked, it should be kept for validating history signatures.</p>
</li>
</ol>
<p><br><br></p>
<h2>Answer</h2>
<p>First of all, there are 2 types of certificates in Fabric:</p>
<ul>
<li>TLS certificates </li>
<li>Enrollment certificates</li>
</ul>
<p>For TLS certificates, when they expire - they cannot be used anymore but
obviously active TLS connections aren't being terminated when it happens.</p>
<p>For enrollment certificates - when they expire they still keep on being useful
regardless of their expiration. This is to prevent a fork when peers join the
Blockchain late. So, in short - certificate expiration has no effect in
enrollment certificates.</p>
<blockquote>
<div class="code"><pre class="code literal-block">Should renewal of a certificate require a new PKI key pair in best
</pre></div>

<p>practice, or should a new certificate be created with the original key</p>
<p>pair be created with its validity extended?</p>
</blockquote>
<p>In most cases, Fabric treats 2 certificates with the same public key but
different attributes as 2 completely different identities (unless you take
into account de-duplication at transaction validation) so if you have a chance
to renew a certificate of a node or a client - you might as well also use a
fresh key. It is not required but it is possible.</p>
<blockquote>
<p>What if it's the case when a private key got compromised, and I have to
revoke the original certificate and use a new one with a new key pair. In
this case, how should I validate signatures of transactions that were
already persisted in the ledger? I wonder if it means that even if a
certificate were revoked, it should be kept for validating history
signatures.</p>
</blockquote>
<p>For TLS certificates, Fabric doesn't use CRLs so you can only rely on short
expiration periods, or you can always just replace the entire certification
chain and this would implicitly invalidate the leaf certificates of the old
chain.</p>
<p>For Enrollment certificates you can issue a CRL config update to all channels
and this would make it impossible to use the compromised key in future
transactions, however signatures of transactions made in the past (in the
blocks that precede the revocation of the certificate) would still be valid
from obvious reasons.</p>
<p>However, there is a code path that checks expiration of enrollment
certificates: Whenever a request from a peer or a client is authenticated to
access a resource (i.e a client wants to execute a chaincode, or a peer wants
to pull blocks) - then the certificate expiration of enrollment certificates
is also checked by the server (peer/orderer).</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/soldity-iterate-through-address-mapping/" class="u-url">Soldity: Iterate through address mapping</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/soldity-iterate-through-address-mapping/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-28T05:11:34+08:00" itemprop="datePublished" title="2023-02-28 05:11">2023-02-28 05:11</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I am looking for a way to iterate through a mapping in Solidity. For example I
have this mapping:</p>
<p><code>mapping (address =&gt; uint) private shares;</code></p>
<p>And I want to iterate in a function through all addresses and send them ether
according to their shares.</p>
<p>Something like:</p>
<div class="code"><pre class="code literal-block"><span class="nv">function</span><span class="w"> </span><span class="nv">giveOutEth</span><span class="ss">()</span><span class="w"> </span><span class="nv">onlyOwner</span><span class="w"> </span><span class="nv">returns</span><span class="w"> </span><span class="ss">(</span><span class="nv">bool</span><span class="w"> </span><span class="nv">success</span><span class="ss">)</span>{
<span class="k">for</span><span class="ss">(</span><span class="nv">uint</span><span class="w"> </span><span class="nv">i</span><span class="o">=</span><span class="mi">0</span><span class="c1">; i &lt; shares.length ; i++){</span>
<span class="o">//</span><span class="nv">get</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">address</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="k">send</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">value</span>
}
</pre></div>

<p>}</p>
<p>How can I achieve this?</p>
<p>Thanks</p>
<p><br><br></p>
<h2>Answer</h2>
<p>I recieved an answer by drlecks:</p>
<div class="code"><pre class="code literal-block"><span class="n">contract</span><span class="w">  </span><span class="n">Holders</span><span class="err">{</span>

<span class="n">uint</span><span class="w"> </span><span class="n">_totalHolders</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="k">initialize</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">constructor</span>
<span class="n">mapping</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">holders</span><span class="p">;</span>
<span class="n">mapping</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">uint</span><span class="p">)</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">shares</span><span class="p">;</span>

<span class="k">function</span><span class="w"> </span><span class="n">GetShares</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">shares</span><span class="p">)</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="p">...</span><span class="w"> </span>
<span class="w">    </span><span class="n">holders</span><span class="o">[</span><span class="n">_totalHolders</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
<span class="w">    </span><span class="n">shares</span><span class="o">[</span><span class="n">msg.sender</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shares</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="n">_totalHolders</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">...</span>
<span class="err">}</span>

<span class="k">function</span><span class="w"> </span><span class="n">PayOut</span><span class="p">()</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">shares</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">_totalHolders</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">shares</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shares</span><span class="o">[</span><span class="n">holders[i</span><span class="o">]</span><span class="err">]</span><span class="p">;</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="p">...</span><span class="w"> </span>
<span class="err">}</span>
</pre></div>

<p>}</p>
<p>but keep in mind that it will consume gas, and maybe its better that the stake
holders withdraw their ETH and pay for gas themselfs.</p>
<p><br></p>
<h3>Suggest</h3>
<p>If you want something more general, you can use a library. I've included one
I'm using below. It could probably use some improvements (ie, <code>Element</code> should
be changed to an interface) and it may be overkill (plus, TBH I haven't done
any gas consumption comparisons yet). Coming from a more object-oriented
background, I prefer using reusable libraries like this, but this is the best
I could come up with given Solidity's limitations.</p>
<p>Feel free to use it and/or improve on it.</p>
<div class="code"><pre class="code literal-block"><span class="n">pragma</span><span class="w"> </span><span class="n">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.4.19</span><span class="p">;</span>
<span class="n">pragma</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="ss">"ABIEncoderV2"</span><span class="p">;</span>
<span class="o">//</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="n">needed</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">ethereum</span><span class="o">/</span><span class="n">solidity</span><span class="o">/</span><span class="n">issues</span><span class="o">/</span><span class="mi">3069</span>

<span class="n">library</span><span class="w"> </span><span class="n">SetLib</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">SetLib</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">Set</span><span class="p">;</span>

<span class="w">  </span><span class="n">struct</span><span class="w"> </span><span class="k">Set</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">mapping</span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">IndexData</span><span class="p">)</span><span class="w"> </span><span class="n">_dataMap</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint16</span><span class="w"> </span><span class="n">_size</span><span class="p">;</span>
<span class="w">    </span><span class="n">IndexData</span><span class="err">[]</span><span class="w"> </span><span class="n">_dataIndex</span><span class="p">;</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="n">struct</span><span class="w"> </span><span class="n">IndexData</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">uint16</span><span class="w"> </span><span class="n">_index</span><span class="p">;</span>
<span class="w">    </span><span class="n">bool</span><span class="w"> </span><span class="n">_isDeleted</span><span class="p">;</span>
<span class="w">    </span><span class="k">Element</span><span class="w"> </span><span class="n">_element</span><span class="p">;</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="n">struct</span><span class="w"> </span><span class="k">Element</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">address</span><span class="w"> </span><span class="n">_value</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint8</span><span class="w"> </span><span class="n">_status</span><span class="p">;</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="k">function</span><span class="w"> </span><span class="k">add</span><span class="p">(</span><span class="k">Set</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">Element</span><span class="w"> </span><span class="k">element</span><span class="p">)</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">bool</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">element</span><span class="p">.</span><span class="n">_value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">contains</span><span class="p">(</span><span class="k">element</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="n">IndexData</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="k">data</span><span class="p">;</span>

<span class="w">    </span><span class="k">data</span><span class="p">.</span><span class="n">_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uint16</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_dataIndex</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
<span class="w">    </span><span class="k">data</span><span class="p">.</span><span class="n">_element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">element</span><span class="p">;</span>

<span class="w">    </span><span class="n">self</span><span class="p">.</span><span class="n">_dataMap</span><span class="o">[</span><span class="n">element._value</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="p">;</span>
<span class="w">    </span><span class="n">self</span><span class="p">.</span><span class="n">_dataIndex</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="k">data</span><span class="p">);</span>
<span class="w">    </span><span class="n">self</span><span class="p">.</span><span class="n">_size</span><span class="o">++</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="k">function</span><span class="w"> </span><span class="k">update</span><span class="p">(</span><span class="k">Set</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">Element</span><span class="w"> </span><span class="k">element</span><span class="p">)</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">element</span><span class="p">.</span><span class="n">_value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="n">IndexData</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_dataMap</span><span class="o">[</span><span class="n">element._value</span><span class="o">]</span><span class="p">;</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="n">_element</span><span class="p">.</span><span class="n">_value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">element</span><span class="p">.</span><span class="n">_value</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">!</span><span class="k">data</span><span class="p">.</span><span class="n">_isDeleted</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">element</span><span class="p">.</span><span class="n">_status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">_element</span><span class="p">.</span><span class="n">_status</span><span class="p">)</span>
<span class="w">        </span><span class="k">data</span><span class="p">.</span><span class="n">_element</span><span class="p">.</span><span class="n">_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">element</span><span class="p">.</span><span class="n">_status</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="k">function</span><span class="w"> </span><span class="n">getByIndex</span><span class="p">(</span><span class="k">Set</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">uint16</span><span class="w"> </span><span class="k">index</span><span class="p">)</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="k">Element</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">IndexData</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_dataIndex</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="k">data</span><span class="p">.</span><span class="n">_isDeleted</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">_element</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="k">function</span><span class="w"> </span><span class="k">get</span><span class="p">(</span><span class="k">Set</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="k">Element</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">IndexData</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_dataMap</span><span class="o">[</span><span class="n">addr</span><span class="o">]</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="k">data</span><span class="p">.</span><span class="n">_isDeleted</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">_element</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="k">function</span><span class="w"> </span><span class="k">contains</span><span class="p">(</span><span class="k">Set</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">Element</span><span class="w"> </span><span class="k">element</span><span class="p">)</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">bool</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="k">contains</span><span class="p">(</span><span class="k">element</span><span class="p">.</span><span class="n">_value</span><span class="p">);</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="k">function</span><span class="w"> </span><span class="k">contains</span><span class="p">(</span><span class="k">Set</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">bool</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="n">IndexData</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_dataMap</span><span class="o">[</span><span class="n">addr</span><span class="o">]</span><span class="p">;</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">_index</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">!</span><span class="k">data</span><span class="p">.</span><span class="n">_isDeleted</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="k">function</span><span class="w"> </span><span class="n">remove</span><span class="p">(</span><span class="k">Set</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">uint16</span><span class="w"> </span><span class="k">index</span><span class="p">)</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="k">Element</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">IndexData</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_dataIndex</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="n">_element</span><span class="p">.</span><span class="n">_value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">!</span><span class="k">data</span><span class="p">.</span><span class="n">_isDeleted</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="k">data</span><span class="p">.</span><span class="n">_isDeleted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">      </span><span class="n">self</span><span class="p">.</span><span class="n">_size</span><span class="o">--</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">_element</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="k">function</span><span class="w"> </span><span class="n">remove</span><span class="p">(</span><span class="k">Set</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="k">Element</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="n">IndexData</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_dataMap</span><span class="o">[</span><span class="n">addr</span><span class="o">]</span><span class="p">;</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="n">_element</span><span class="p">.</span><span class="n">_value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">!</span><span class="k">data</span><span class="p">.</span><span class="n">_isDeleted</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">data</span><span class="p">.</span><span class="n">_isDeleted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_size</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">_element</span><span class="p">;</span>
<span class="w">      </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="k">function</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="k">Set</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">uint16</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_size</span><span class="p">;</span>
<span class="w">  </span><span class="err">}</span>
<span class="err">}</span>

<span class="n">library</span><span class="w"> </span><span class="n">IteratorLib</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">SetLib</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">SetLib</span><span class="p">.</span><span class="k">Set</span><span class="p">;</span>

<span class="w">  </span><span class="n">struct</span><span class="w"> </span><span class="n">Iterator</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">bool</span><span class="w"> </span><span class="n">_started</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">making</span><span class="w"> </span><span class="n">_curIndex</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="k">state</span><span class="p">.</span>
<span class="w">    </span><span class="n">uint16</span><span class="w"> </span><span class="n">_curIndex</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint16</span><span class="w"> </span><span class="n">_size</span><span class="p">;</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="k">function</span><span class="w"> </span><span class="n">iterator</span><span class="p">(</span><span class="n">SetLib</span><span class="p">.</span><span class="k">Set</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="k">set</span><span class="p">)</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">IteratorLib</span><span class="p">.</span><span class="n">Iterator</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">IteratorLib</span><span class="p">.</span><span class="n">Iterator</span><span class="p">(</span><span class="k">false</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">set</span><span class="p">.</span><span class="k">size</span><span class="p">());</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="k">function</span><span class="w"> </span><span class="n">hasNext</span><span class="p">(</span><span class="n">Iterator</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">SetLib</span><span class="p">.</span><span class="k">Set</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="k">set</span><span class="p">)</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">bool</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">uint16</span><span class="w"> </span><span class="n">testIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_curIndex</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">testIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_size</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">set</span><span class="p">.</span><span class="n">_dataIndex</span><span class="o">[</span><span class="n">testIndex</span><span class="o">]</span><span class="p">.</span><span class="n">_element</span><span class="p">.</span><span class="n">_value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">!</span><span class="k">set</span><span class="p">.</span><span class="n">_dataIndex</span><span class="o">[</span><span class="n">testIndex</span><span class="o">]</span><span class="p">.</span><span class="n">_isDeleted</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>

<span class="w">      </span><span class="n">testIndex</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="k">function</span><span class="w"> </span><span class="k">next</span><span class="p">(</span><span class="n">Iterator</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">SetLib</span><span class="p">.</span><span class="k">Set</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="k">set</span><span class="p">)</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">SetLib</span><span class="p">.</span><span class="k">Element</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">SetLib</span><span class="p">.</span><span class="k">Element</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="k">element</span><span class="p">;</span>

<span class="w">    </span><span class="n">do</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_curIndex</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="err">}</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_started</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="w">      </span><span class="err">}</span>

<span class="w">      </span><span class="k">element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">set</span><span class="p">.</span><span class="n">getByIndex</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_curIndex</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">element</span><span class="p">.</span><span class="n">_value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_curIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_size</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">element</span><span class="p">;</span>
<span class="w">  </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1491.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1489.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
