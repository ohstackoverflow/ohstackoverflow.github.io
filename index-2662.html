<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 2662) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-2662.html">
<link rel="prev" href="index-2663.html" type="text/html">
<link rel="next" href="index-2661.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/after-upgrading-to-xcode-11-2-from-xcode-11-1-app-crashes-due-to-uitextlayoutview/" class="u-url">After upgrading to Xcode 11.2 from Xcode 11.1, app crashes due to _UITextLayoutView</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/after-upgrading-to-xcode-11-2-from-xcode-11-1-app-crashes-due-to-uitextlayoutview/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T08:33:57+08:00" itemprop="datePublished" title="2023-03-05 08:33">2023-03-05 08:33</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>After upgrading to Xcode 11.2 from Xcode 11.1 my app crashes:</p>
<blockquote>
<p>*** Terminating app due to uncaught exception
'NSInvalidUnarchiveOperationException', reason: 'Could not instantiate class
named _UITextLayoutView because no class named _UITextLayoutView was found;
the class needs to be defined in source code or linked in from a library
(ensure the class is part of the correct target)'</p>
</blockquote>
<p>Why is this happening? How can I prevent this crash?</p>
<p><br><br></p>
<h2>Answer</h2>
<p><strong>Congratulation</strong></p>
<p>The New version of Xcode (11.2.1) is available now which is the best way to
get rid off this issue.</p>
<p><strong>Workarounds</strong></p>
<p>@Mojtaba Hosseini the solution I proposed was from the help and the
participation from my side to my fellow developers over StackOverflow. You, me
and all the rest of the developer here already know that when the new version
is announced by Apple, this issue will be gone.</p>
<p><strong>But Beside Everything</strong></p>
<p>The solution aforementioned was definitely accepted by Apple Review as there
is no private API involved at all. This approach is very similar to the
creating property like</p>
<blockquote>
<p>@interface UITextView (Layout)</p>
</blockquote>
<p>Or</p>
<blockquote>
<p>UITextView+Layout.h</p>
</blockquote>
<p>So when you are creating property you are directly using APPLE Private
Components and re-moduling them as per you depends or requirement.</p>
<p>The Simple Example is AMFNetworking classes</p>
<div class="code"><pre class="code literal-block"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setImageWithURL:</span><span class="p">(</span><span class="bp">NSURL</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="nv">url</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">[</span><span class="nb">self</span><span class="w"> </span><span class="n">setImageWithURL</span><span class="o">:</span><span class="n">url</span><span class="w"> </span><span class="n">placeholderImage</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>

<p>Hope I am done with the Allegation</p>
<p>The answer below was just some help from my side to enable developer to
continue developing as you we initially proposed developer to roll back Xcode.
This was a bad practice to download 8 GB Xcode again since we all know that
the new version of Xcode will be released soon.</p>
<p>While it is fixed in Xcode 11.2.1, I got one solution for Xcode 11.2 by which
you can get rid off this crash:</p>
<blockquote>
<p>*** Terminating app due to uncaught exception
'NSInvalidUnarchiveOperationException', reason: 'Could not instantiate class
named _UITextLayoutView because no class named _UITextLayoutView was found;
the class needs to be defined in source code or linked in from a library
(ensure the class is part of the correct target)'</p>
</blockquote>
<p><strong>SOLUTION</strong></p>
<p>Go to the Build Setting search for "DEAD_CODE_STRIPPING" and set it to NO</p>
<div class="code"><pre class="code literal-block">DEAD_CODE_STRIPPING = NO
</pre></div>

<p><strong>Then</strong></p>
<blockquote>
<p>create files UITextViewWorkaround</p>
</blockquote>
<p><strong>UITextViewWorkaround.h</strong></p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>


<span class="w">    </span><span class="k">@interface</span> <span class="nc">UITextViewWorkaround</span> : <span class="bp">NSObject</span>
<span class="w">    </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">executeWorkaround</span><span class="p">;</span><span class="w"> </span>
<span class="k">@end</span>
</pre></div>

<p><strong>UITextViewWorkaround.m</strong></p>
<div class="code"><pre class="code literal-block"><span class="cp">#import "UITextViewWorkaround.h"</span>
<span class="cp">#import  &lt;objc/runtime.h&gt;</span>



<span class="w">    </span><span class="k">@implementation</span> <span class="nc">UITextViewWorkaround</span>

<span class="w">    </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">executeWorkaround</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(@</span><span class="n">available</span><span class="p">(</span><span class="n">iOS</span><span class="w"> </span><span class="mf">13.2</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"_UITextLayoutView"</span><span class="p">;</span>
<span class="w">            </span><span class="kt">Class</span><span class="w"> </span><span class="n">cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objc_getClass</span><span class="p">(</span><span class="n">className</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cls</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">nil</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objc_allocateClassPair</span><span class="p">([</span><span class="bp">UIView</span><span class="w"> </span><span class="k">class</span><span class="p">],</span><span class="w"> </span><span class="n">className</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">                </span><span class="n">objc_registerClassPair</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>
<span class="w">    </span><span class="cp">#if DEBUG</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">"added %s dynamically</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">className</span><span class="p">);</span>
<span class="w">    </span><span class="cp">#endif</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">@end</span>
</pre></div>

<blockquote>
<p>execute it in the app delegate</p>
</blockquote>
<div class="code"><pre class="code literal-block"><span class="c1">#import "UITextViewWorkaround.h"</span>

        <span class="o">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">application</span><span class="p">:(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="n">application</span> <span class="n">didFinishLaunchingWithOptions</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">launchOptions</span> <span class="p">{</span>
            <span class="o">//</span> <span class="n">Override</span> <span class="n">point</span> <span class="k">for</span> <span class="n">customization</span> <span class="n">after</span> <span class="n">application</span> <span class="n">launch</span><span class="o">.</span>

            <span class="p">[</span><span class="n">UITextViewWorkaround</span> <span class="n">executeWorkaround</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">yes</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>

<p>Compile the code and you will have a running app :)</p>
<p><br></p>
<h3>Suggest</h3>
<p><strong>Congratulation</strong></p>
<p>The New version of Xcode (11.2.1) is available now which is the best way to
get rid off this issue.</p>
<p><strong>Workarounds</strong></p>
<p>@Mojtaba Hosseini the solution I proposed was from the help and the
participation from my side to my fellow developers over StackOverflow. You, me
and all the rest of the developer here already know that when the new version
is announced by Apple, this issue will be gone.</p>
<p><strong>But Beside Everything</strong></p>
<p>The solution aforementioned was definitely accepted by Apple Review as there
is no private API involved at all. This approach is very similar to the
creating property like</p>
<blockquote>
<p>@interface UITextView (Layout)</p>
</blockquote>
<p>Or</p>
<blockquote>
<p>UITextView+Layout.h</p>
</blockquote>
<p>So when you are creating property you are directly using APPLE Private
Components and re-moduling them as per you depends or requirement.</p>
<p>The Simple Example is AMFNetworking classes</p>
<div class="code"><pre class="code literal-block"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setImageWithURL:</span><span class="p">(</span><span class="bp">NSURL</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="nv">url</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">[</span><span class="nb">self</span><span class="w"> </span><span class="n">setImageWithURL</span><span class="o">:</span><span class="n">url</span><span class="w"> </span><span class="n">placeholderImage</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>

<p>Hope I am done with the Allegation</p>
<p>The answer below was just some help from my side to enable developer to
continue developing as you we initially proposed developer to roll back Xcode.
This was a bad practice to download 8 GB Xcode again since we all know that
the new version of Xcode will be released soon.</p>
<p>While it is fixed in Xcode 11.2.1, I got one solution for Xcode 11.2 by which
you can get rid off this crash:</p>
<blockquote>
<p>*** Terminating app due to uncaught exception
'NSInvalidUnarchiveOperationException', reason: 'Could not instantiate class
named _UITextLayoutView because no class named _UITextLayoutView was found;
the class needs to be defined in source code or linked in from a library
(ensure the class is part of the correct target)'</p>
</blockquote>
<p><strong>SOLUTION</strong></p>
<p>Go to the Build Setting search for "DEAD_CODE_STRIPPING" and set it to NO</p>
<div class="code"><pre class="code literal-block">DEAD_CODE_STRIPPING = NO
</pre></div>

<p><strong>Then</strong></p>
<blockquote>
<p>create files UITextViewWorkaround</p>
</blockquote>
<p><strong>UITextViewWorkaround.h</strong></p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>


<span class="w">    </span><span class="k">@interface</span> <span class="nc">UITextViewWorkaround</span> : <span class="bp">NSObject</span>
<span class="w">    </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">executeWorkaround</span><span class="p">;</span><span class="w"> </span>
<span class="k">@end</span>
</pre></div>

<p><strong>UITextViewWorkaround.m</strong></p>
<div class="code"><pre class="code literal-block"><span class="cp">#import "UITextViewWorkaround.h"</span>
<span class="cp">#import  &lt;objc/runtime.h&gt;</span>



<span class="w">    </span><span class="k">@implementation</span> <span class="nc">UITextViewWorkaround</span>

<span class="w">    </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">executeWorkaround</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(@</span><span class="n">available</span><span class="p">(</span><span class="n">iOS</span><span class="w"> </span><span class="mf">13.2</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"_UITextLayoutView"</span><span class="p">;</span>
<span class="w">            </span><span class="kt">Class</span><span class="w"> </span><span class="n">cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objc_getClass</span><span class="p">(</span><span class="n">className</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cls</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">nil</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objc_allocateClassPair</span><span class="p">([</span><span class="bp">UIView</span><span class="w"> </span><span class="k">class</span><span class="p">],</span><span class="w"> </span><span class="n">className</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">                </span><span class="n">objc_registerClassPair</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>
<span class="w">    </span><span class="cp">#if DEBUG</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">"added %s dynamically</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">className</span><span class="p">);</span>
<span class="w">    </span><span class="cp">#endif</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">@end</span>
</pre></div>

<blockquote>
<p>execute it in the app delegate</p>
</blockquote>
<div class="code"><pre class="code literal-block"><span class="c1">#import "UITextViewWorkaround.h"</span>

        <span class="o">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">application</span><span class="p">:(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="n">application</span> <span class="n">didFinishLaunchingWithOptions</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">launchOptions</span> <span class="p">{</span>
            <span class="o">//</span> <span class="n">Override</span> <span class="n">point</span> <span class="k">for</span> <span class="n">customization</span> <span class="n">after</span> <span class="n">application</span> <span class="n">launch</span><span class="o">.</span>

            <span class="p">[</span><span class="n">UITextViewWorkaround</span> <span class="n">executeWorkaround</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">yes</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>

<p>Compile the code and you will have a running app :)</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/why-required-and-optional-is-removed-in-protocol-buffers-3/" class="u-url">Why required and optional is removed in Protocol Buffers 3</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/why-required-and-optional-is-removed-in-protocol-buffers-3/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T08:32:35+08:00" itemprop="datePublished" title="2023-03-05 08:32">2023-03-05 08:32</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I'm recently using <code>gRPC</code> with <code>proto3</code>, and I've noticed that <code>required</code> and
<code>optional</code> has been removed in new syntax.</p>
<p>Would anyone kindly explain why required/optional are removed in proto3? Such
kind of constraints just seem necessary to make definition robust.</p>
<p>syntax proto2:</p>
<div class="code"><pre class="code literal-block">message SearchRequest {
  required string query = 1;
  optional int32 page_number = 2;
  optional int32 result_per_page = 3;
}
</pre></div>

<p>syntax proto3:</p>
<div class="code"><pre class="code literal-block">syntax = "proto3";
message SearchRequest {
  string query = 1;
  int32 page_number = 2;
  int32 result_per_page = 3;
}
</pre></div>

<p><br><br></p>
<h2>Answer</h2>
<p>The usefulness of <code>required</code> has been at the heart of many a debate and flame
war. Large camps have existed on both sides. One camp liked guaranteeing a
value was present and was willing to live with its limitations but the other
camp felt <code>required</code> dangerous or unhelpful as it can't be safely added nor
removed.</p>
<p>Let me explain more of the reasoning why <code>required</code> fields should be used
sparingly. If you are already using a proto, you can't add a required field
because old application's won't be providing that field and applications in
general don't handle the failure well. You can make sure that all old
applications are upgraded first, but it can be easy to make a mistake and it
doesn't help if you are storing the protos in <em>any</em> datastore (even short-
lived, like memcached). The same sort of situation applies when removing a
required field.</p>
<p>Many required fields were "obviously" required until... they weren't. Let's
say you have an <code>id</code> field for a <code>Get</code> method. That is <em>obviously</em> required.
Except, later you might need to change the <code>id</code> from int to string, or int32
to int64. That requires adding a new <code>muchBetterId</code> field, and now you are
left with the old <code>id</code> field that <em>must</em> be specified, but eventually is
completely ignored.</p>
<p>When those two problems are combined, the number of beneficial <code>required</code>
fields becomes limited and the camps argue over whether it still has value.
The opponents of <code>required</code> weren't necessarily against the idea, but its
current form. Some suggested developing a more expressive validation library
that could check <code>required</code> along with something more advanced like
<code>name.length &gt; 10</code>, while also making sure to have a better failure model.</p>
<p>Proto3 overall seems to favor simplicity, and <code>required</code> removal is simpler.
But maybe more convincing, removing <code>required</code> made sense for proto3 when
combined with other features, like removal of field presence for primitives
and removal of overriding default values.</p>
<p>I'm not a protobuf developer and am in no way authoritative on the subject,
but I still hope that the explanation is useful.</p>
<p><br></p>
<h3>Suggest</h3>
<p>You can find the explanation in this protobuf Github issue:</p>
<blockquote>
<p>We dropped required fields in proto3 because required fields are generally
considered harmful and violating protobuf's compatibility semantics. The
whole idea of using protobuf is that it allows you to add/remove fields from
your protocol definition while still being fully forward/backward compatible
with newer/older binaries. Required fields break this though. You can never
safely add a required field to a .proto definition, nor can you safely
remove an existing required field because both of these actions break wire
compatibility. For example, if you add a required field to a .proto
definition, binaries built with the new definition won't be able to parse
data serialized using the old definition because the required field is not
present in old data. In a complex system where .proto definitions are shared
widely across many different components of the system, adding/removing
required fields could easily bring down multiple parts of the system. We
have seen production issues caused by this multiple times and it's pretty
much banned everywhere inside Google for anyone to add/remove required
fields. For this reason we completely removed required fields in proto3.</p>
<p>After the removal of "required", "optional" is just redundant so we removed
"optional" as well.</p>
</blockquote>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/package-with-both-a-library-and-a-binary/" class="u-url">Package with both a library and a binary?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/package-with-both-a-library-and-a-binary/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T08:31:14+08:00" itemprop="datePublished" title="2023-03-05 08:31">2023-03-05 08:31</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I would like to make a Rust package that contains both a reusable library
(where most of the program is implemented), and also an executable that uses
it.</p>
<p>Assuming I have not confused any semantics in the Rust module system, what
should my <code>Cargo.toml</code> file look like?</p>
<p><br><br></p>
<h2>Answer</h2>
<div class="code"><pre class="code literal-block"><span class="n">Tok</span><span class="o">:</span><span class="n">tmp</span><span class="w"> </span><span class="n">doug$</span><span class="w"> </span><span class="n">du</span><span class="w"> </span><span class="o">-</span><span class="n">a</span>

<span class="mi">8</span><span class="w">   </span><span class="o">./</span><span class="n">Cargo</span><span class="o">.</span><span class="na">toml</span>
<span class="mi">8</span><span class="w">   </span><span class="o">./</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">.</span><span class="na">rs</span>
<span class="mi">8</span><span class="w">   </span><span class="o">./</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="o">.</span><span class="na">rs</span>
<span class="mi">16</span><span class="w">  </span><span class="o">./</span><span class="n">src</span>
</pre></div>

<p>Cargo.toml:</p>
<div class="code"><pre class="code literal-block"><span class="k">[package]</span>
<span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"mything"</span>
<span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.0.1"</span>
<span class="na">authors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">["me &lt;me@gmail.com&gt;"]</span>

<span class="k">[lib]</span>
<span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"mylib"</span>
<span class="na">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"src/lib.rs"</span>

<span class="k">[[bin]]</span>
<span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"mybin"</span>
<span class="na">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"src/bin.rs"</span>
</pre></div>

<p>src/lib.rs:</p>
<div class="code"><pre class="code literal-block">pub fn test() {
    println!("Test");
}
</pre></div>

<p>src/bin.rs:</p>
<div class="code"><pre class="code literal-block"><span class="nt">extern</span><span class="w"> </span><span class="nt">crate</span><span class="w"> </span><span class="nt">mylib</span><span class="o">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nt">not</span><span class="w"> </span><span class="nt">needed</span><span class="w"> </span><span class="nt">since</span><span class="w"> </span><span class="nt">Rust</span><span class="w"> </span><span class="nt">edition</span><span class="w"> </span><span class="nt">2018</span>

<span class="nt">use</span><span class="w"> </span><span class="nt">mylib</span><span class="p">::</span><span class="nd">test</span><span class="o">;</span>

<span class="nt">pub</span><span class="w"> </span><span class="nt">fn</span><span class="w"> </span><span class="nt">main</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">test()</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<h2>Simple</h2>
<p>Create a <code>src/main.rs</code> that will be used as the defacto executable. You do not
need to modify your <code>Cargo.toml</code> and this file will be compiled to a binary of
the same name as the library.</p>
<p>The project contents:</p>
<div class="code"><pre class="code literal-block"><span class="c">% tree</span>
<span class="p">.</span>
├──<span class="w"> </span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span>
└──<span class="w"> </span><span class="n">src</span>
<span class="w">    </span>├──<span class="w"> </span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span>
<span class="w">    </span>└──<span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>
</pre></div>

<p><strong>Cargo.toml</strong></p>
<div class="code"><pre class="code literal-block"><span class="k">[package]</span>
<span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"example"</span>
<span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span>
<span class="na">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"2018"</span>
</pre></div>

<p><strong>src/lib.rs</strong></p>
<div class="code"><pre class="code literal-block"><span class="nt">use</span><span class="w"> </span><span class="nt">std</span><span class="p">::</span><span class="nd">error</span><span class="p">::</span><span class="nd">Error</span><span class="o">;</span>

<span class="nt">pub</span><span class="w"> </span><span class="nt">fn</span><span class="w"> </span><span class="nt">really_complicated_code</span><span class="o">(</span><span class="nt">a</span><span class="o">:</span><span class="w"> </span><span class="nt">u8</span><span class="o">,</span><span class="w"> </span><span class="nt">b</span><span class="o">:</span><span class="w"> </span><span class="nt">u8</span><span class="o">)</span><span class="w"> </span><span class="nt">-</span><span class="o">&gt;</span><span class="w"> </span><span class="nt">Result</span><span class="o">&lt;</span><span class="nt">u8</span><span class="o">,</span><span class="w"> </span><span class="nt">Box</span><span class="o">&lt;</span><span class="nt">dyn</span><span class="w"> </span><span class="nt">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">Ok(a</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">b)</span>
<span class="p">}</span>
</pre></div>

<p><strong>src/main.rs</strong></p>
<div class="code"><pre class="code literal-block"><span class="nt">fn</span><span class="w"> </span><span class="nt">main</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">println!(</span>
<span class="w">        </span><span class="err">"I'm</span><span class="w"> </span><span class="err">using</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="n">library</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="o">:?</span><span class="p">}</span><span class="err">"</span><span class="o">,</span>
<span class="w">        </span><span class="nt">example</span><span class="p">::</span><span class="nd">really_complicated_code</span><span class="o">(</span><span class="nt">1</span><span class="o">,</span><span class="w"> </span><span class="nt">2</span><span class="o">)</span>
<span class="w">    </span><span class="o">);</span>
<span class="err">}</span>
</pre></div>

<p>And execute it:</p>
<div class="code"><pre class="code literal-block"><span class="c">% cargo run -q</span>
<span class="n">I</span><span class="o">'</span><span class="n">m</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">library</span><span class="p">:</span><span class="w"> </span><span class="n">Ok</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

<h2>Flexible</h2>
<p>If you wish to control the name of the binary or have multiple binaries, you
can create multiple binary source files in <code>src/bin</code> and the rest of your
library sources in <code>src</code>. You can see an example in my project. You do not
need to modify your <code>Cargo.toml</code> at all, and each source file in <code>src/bin</code>
will be compiled to a binary of the same name.</p>
<p>The project contents:</p>
<div class="code"><pre class="code literal-block"><span class="c">% tree</span>
<span class="p">.</span>
├──<span class="w"> </span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span>
└──<span class="w"> </span><span class="n">src</span>
<span class="w">    </span>├──<span class="w"> </span><span class="n">bin</span>
<span class="w">    </span>│<span class="w">   </span>└──<span class="w"> </span><span class="n">mybin</span><span class="p">.</span><span class="n">rs</span>
<span class="w">    </span>└──<span class="w"> </span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span>
</pre></div>

<p><strong>Cargo.toml</strong></p>
<div class="code"><pre class="code literal-block"><span class="k">[package]</span>
<span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"example"</span>
<span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span>
<span class="na">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"2018"</span>
</pre></div>

<p><strong>src/lib.rs</strong></p>
<div class="code"><pre class="code literal-block"><span class="nt">use</span><span class="w"> </span><span class="nt">std</span><span class="p">::</span><span class="nd">error</span><span class="p">::</span><span class="nd">Error</span><span class="o">;</span>

<span class="nt">pub</span><span class="w"> </span><span class="nt">fn</span><span class="w"> </span><span class="nt">really_complicated_code</span><span class="o">(</span><span class="nt">a</span><span class="o">:</span><span class="w"> </span><span class="nt">u8</span><span class="o">,</span><span class="w"> </span><span class="nt">b</span><span class="o">:</span><span class="w"> </span><span class="nt">u8</span><span class="o">)</span><span class="w"> </span><span class="nt">-</span><span class="o">&gt;</span><span class="w"> </span><span class="nt">Result</span><span class="o">&lt;</span><span class="nt">u8</span><span class="o">,</span><span class="w"> </span><span class="nt">Box</span><span class="o">&lt;</span><span class="nt">dyn</span><span class="w"> </span><span class="nt">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">Ok(a</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">b)</span>
<span class="p">}</span>
</pre></div>

<p><strong>src/bin/mybin.rs</strong></p>
<div class="code"><pre class="code literal-block"><span class="nt">fn</span><span class="w"> </span><span class="nt">main</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">println!(</span>
<span class="w">        </span><span class="err">"I'm</span><span class="w"> </span><span class="err">using</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="n">library</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="o">:?</span><span class="p">}</span><span class="err">"</span><span class="o">,</span>
<span class="w">        </span><span class="nt">example</span><span class="p">::</span><span class="nd">really_complicated_code</span><span class="o">(</span><span class="nt">1</span><span class="o">,</span><span class="w"> </span><span class="nt">2</span><span class="o">)</span>
<span class="w">    </span><span class="o">);</span>
<span class="err">}</span>
</pre></div>

<p>And execute it:</p>
<div class="code"><pre class="code literal-block"><span class="c">% cargo run --bin mybin -q</span>
<span class="n">I</span><span class="o">'</span><span class="n">m</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">library</span><span class="p">:</span><span class="w"> </span><span class="n">Ok</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

<p>See also:</p>
<ul>
<li>How can I specify which crate <code>cargo run</code> runs by default in the root of a Cargo workspace?</li>
</ul>
</div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2663.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2661.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
