<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1006) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1006.html">
<link rel="prev" href="index-1007.html" type="text/html">
<link rel="next" href="index-1005.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/confused-about-service-vs-factory/" class="u-url">Confused about Service vs Factory</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/confused-about-service-vs-factory/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T22:18:07+08:00" itemprop="datePublished" title="2023-02-17 22:18">2023-02-17 22:18</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>As I understand it, when inside a factory I return an object that gets
injected into a controller. When inside a service I am dealing with the object
using <code>this</code> and not returning anything.</p>
<p>I was under the assumption that a service was <em>always a singleton</em> , and that
a <strong>new factory object</strong> gets injected in every controller. However, as it
turns out, a factory object is a singleton too?</p>
<p>Example code to demonstrate:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">factories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">angular</span><span class="o">.</span><span class="n">module</span><span class="p">(</span><span class="s1">'app.factories'</span><span class="p">,</span><span class="w"> </span><span class="p">[]);</span>
<span class="k">var</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">angular</span><span class="o">.</span><span class="n">module</span><span class="p">(</span><span class="s1">'app'</span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="s1">'ngResource'</span><span class="p">,</span><span class="w"> </span><span class="s1">'app.factories'</span><span class="p">]);</span>

<span class="n">factories</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="s1">'User'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">first</span><span class="p">:</span><span class="w"> </span><span class="s1">'John'</span><span class="p">,</span>
<span class="w">    </span><span class="n">last</span><span class="p">:</span><span class="w"> </span><span class="s1">'Doe'</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">});</span>

<span class="n">app</span><span class="o">.</span><span class="n">controller</span><span class="p">(</span><span class="s1">'ACtrl'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="o">$</span><span class="n">scope</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">$</span><span class="n">scope</span><span class="o">.</span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">User</span><span class="p">;</span>
<span class="p">});</span>

<span class="n">app</span><span class="o">.</span><span class="n">controller</span><span class="p">(</span><span class="s1">'BCtrl'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="o">$</span><span class="n">scope</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">$</span><span class="n">scope</span><span class="o">.</span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">User</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>

<p>When changing <code>user.first</code> in <code>ACtrl</code> it turns out that <code>user.first</code> in
<code>BCtrl</code> is also changed, e.g. <code>User</code> is a singleton?</p>
<p>My assumption was that a new instance was injected in a controller with a
factory?</p>
<p><br><br></p>
<h2>Answer</h2>
<p><strong>All angular services are singletons</strong> :</p>
<p>Docs (see <em>Services as singletons</em> ):
https://docs.angularjs.org/guide/services</p>
<blockquote>
<p>Lastly, it is important to realize that all Angular services are application
singletons. This means that there is only one instance of a given service
per injector.</p>
</blockquote>
<p>Basically the difference between the service and factory is as follows:</p>
<div class="code"><pre class="code literal-block"><span class="n">app</span><span class="o">.</span><span class="n">service</span><span class="p">(</span><span class="s1">'myService'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">constructor</span><span class="w"> </span><span class="n">function</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="s1">'new'</span>

<span class="w">  </span><span class="n">this</span><span class="o">.</span><span class="n">sayHello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="s2">"Hi "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"!"</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">});</span>

<span class="n">app</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="s1">'myFactory'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">factory</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">object</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">before</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">sayHello</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="s2">"Hi "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"!"</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p>Check out this presentation about $provide:
http://slides.wesalvaro.com/20121113/#/</p>
<p>Those slides were used in one of the AngularJs meetups:
http://blog.angularjs.org/2012/11/more-angularjs-meetup-videos.html</p>
<p><br></p>
<h3>Suggest</h3>
<p>For me the revelation came when I realise that they all work the same way: by
running something <strong>once</strong> , storing the value they get, and then cough up
<strong>that same stored value</strong> when referenced through Dependency Injection.</p>
<p>Say we have:</p>
<div class="code"><pre class="code literal-block">app.factory('a', fn);
app.service('b', fn);
app.provider('c', fn);
</pre></div>

<p>The difference between the three is that:</p>
<ol>
<li>
<code>a</code>'s stored value comes from running <code>fn</code> , in other words: <code>fn()</code>
</li>
<li>
<code>b</code>’s stored value comes from <code>new</code>ing <code>fn</code>, in other words: <code>new fn()</code>
</li>
<li>
<code>c</code>’s stored value comes from first getting an instance by <code>new</code>ing <code>fn</code>, and then running a <code>$get</code> method of the instance</li>
</ol>
<p>which means, there’s something like a cache object inside angular, whose value
of each injection is only assigned once, when they've been injected the first
time, and where:</p>
<div class="code"><pre class="code literal-block">cache.a = fn()
cache.b = new fn()
cache.c = (new fn()).$get()
</pre></div>

<p>This is why we use <code>this</code> in services, and define a <code>this.$get</code> in providers.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-many-files-can-i-put-in-a-directory/" class="u-url">How many files can I put in a directory?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-many-files-can-i-put-in-a-directory/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T22:17:36+08:00" itemprop="datePublished" title="2023-02-17 22:17">2023-02-17 22:17</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Does it matter how many files I keep in a single directory? If so, how many
files in a directory is too many, and what are the impacts of having too many
files? (This is on a Linux server.)</p>
<p>Background: I have a photo album website, and every image uploaded is renamed
to an 8-hex-digit id (say, a58f375c.jpg). This is to avoid filename conflicts
(if lots of "IMG0001.JPG" files are uploaded, for example). The original
filename and any useful metadata is stored in a database. Right now, I have
somewhere around 1500 files in the images directory. This makes listing the
files in the directory (through FTP or SSH client) take a few seconds. But I
can't see that it has any effect other than that. In particular, there doesn't
seem to be any impact on how quickly an image file is served to the user.</p>
<p>I've thought about reducing the number of images by making 16 subdirectories:
0-9 and a-f. Then I'd move the images into the subdirectories based on what
the first hex digit of the filename was. But I'm not sure that there's any
reason to do so except for the occasional listing of the directory through
FTP/SSH.</p>
<p><br><br></p>
<h2>Answer</h2>
<h2>FAT32:</h2>
<ul>
<li>Maximum number of files: 268,173,300</li>
<li>Maximum number of files per directory: 216 - 1 (65,535)</li>
<li>Maximum file size: 2 GiB - 1 without LFS, 4 GiB - 1 with </li>
</ul>
<h2>NTFS:</h2>
<ul>
<li>Maximum number of files: 232 - 1 (4,294,967,295) </li>
<li>Maximum file size <ul>
<li>Implementation: 244 - 26 bytes (16 TiB - 64 KiB)</li>
<li>Theoretical: 264 - 26 bytes (16 EiB - 64 KiB)</li>
</ul>
</li>
<li>Maximum volume size <ul>
<li>Implementation: 232 - 1 clusters (256 TiB - 64 KiB)</li>
<li>Theoretical: 264 - 1 clusters (1 YiB - 64 KiB)</li>
</ul>
</li>
</ul>
<h2>ext2:</h2>
<ul>
<li>Maximum number of files: 1018</li>
<li>Maximum number of files per directory: ~1.3 × 1020 (performance issues past 10,000)</li>
<li>Maximum file size <ul>
<li>16 GiB (block size of 1 KiB)</li>
<li>256 GiB (block size of 2 KiB)</li>
<li>2 TiB (block size of 4 KiB)</li>
<li>2 TiB (block size of 8 KiB)</li>
</ul>
</li>
<li>Maximum volume size <ul>
<li>4 TiB (block size of 1 KiB)</li>
<li>8 TiB (block size of 2 KiB)</li>
<li>16 TiB (block size of 4 KiB)</li>
<li>32 TiB (block size of 8 KiB)</li>
</ul>
</li>
</ul>
<h2>ext3:</h2>
<ul>
<li>Maximum number of files: min(volumeSize / 213, numberOfBlocks) </li>
<li>Maximum file size: <em>same as ext2</em>
</li>
<li>Maximum volume size: <em>same as ext2</em>
</li>
</ul>
<h2>ext4:</h2>
<ul>
<li>Maximum number of files: 232 - 1 (4,294,967,295)</li>
<li>Maximum number of files per directory: unlimited</li>
<li>Maximum file size: 244 - 1 bytes (16 TiB - 1)</li>
<li>Maximum volume size: 248 - 1 bytes (256 TiB - 1)</li>
</ul>
<p><br></p>
<h3>Suggest</h3>
<p>I have had over 8 million files in a single ext3 directory. libc <code>readdir()</code>
which is used by <code>find</code>, <code>ls</code> and most of the other methods discussed in this
thread to list large directories.</p>
<p>The reason <code>ls</code> and <code>find</code> are slow in this case is that <code>readdir()</code> only
reads 32K of directory entries at a time, so on slow disks it will require
many many reads to list a directory. There is a solution to this speed
problem. I wrote a pretty detailed article about it at:
http://www.olark.com/spw/2011/08/you-can-list-a-directory-with-8-million-
files-but-not-with-ls/</p>
<p>The key take away is: use <code>getdents()</code> directly --
http://www.kernel.org/doc/man-pages/online/pages/man2/getdents.2.html rather
than anything that's based on libc <code>readdir()</code> so you can specify the buffer
size when reading directory entries from disk.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-do-you-create-a-custom-authorizeattribute-in-asp-net-core/" class="u-url">How do you create a custom AuthorizeAttribute in ASP.NET Core?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-do-you-create-a-custom-authorizeattribute-in-asp-net-core/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T22:17:03+08:00" itemprop="datePublished" title="2023-02-17 22:17">2023-02-17 22:17</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I'm trying to make a custom authorization attribute in ASP.NET Core. In
previous versions it was possible to override <code>bool
AuthorizeCore(HttpContextBase httpContext)</code>. But this no longer exists in
<code>AuthorizeAttribute</code>.</p>
<p>What is the current approach to make a custom AuthorizeAttribute?</p>
<p>What I am trying to accomplish: I am receiving a session ID in the Header
Authorization. From that ID I'll know whether a particular action is valid.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>The approach recommended by the ASP.Net Core team is to use the new policy
design which is fully documented here. The basic idea behind the new approach
is to use the new <code>[Authorize]</code> attribute to designate a "policy" (e.g.
<code>[Authorize( Policy = "YouNeedToBe18ToDoThis")]</code> where the policy is
registered in the application's <code>Startup.cs</code> to execute some block of code
(i.e. ensure the user has an age claim where the age is 18 or older).</p>
<p>The policy design is a great addition to the framework and the ASP.Net
Security Core team should be commended for its introduction. That said, it
isn't well-suited for all cases. The shortcoming of this approach is that it
fails to provide a convenient solution for the most common need of simply
asserting that a given controller or action requires a given claim type. In
the case where an application may have hundreds of discrete permissions
governing CRUD operations on individual REST resources ("CanCreateOrder",
"CanReadOrder", "CanUpdateOrder", "CanDeleteOrder", etc.), the new approach
either requires repetitive one-to-one mappings between a policy name and a
claim name (e.g. <code>options.AddPolicy("CanUpdateOrder", policy =&gt;
policy.RequireClaim(MyClaimTypes.Permission, "CanUpdateOrder));</code>), or writing
some code to perform these registrations at run time (e.g. read all claim
types from a database and perform the aforementioned call in a loop). The
problem with this approach for the majority of cases is that it's unnecessary
overhead.</p>
<p>While the ASP.Net Core Security team recommends never creating your own
solution, in some cases this may be the most prudent option with which to
start.</p>
<p>The following is an implementation which uses the <code>IAuthorizationFilter</code> to
provide a simple way to express a claim requirement for a given controller or
action:</p>
<div class="code"><pre class="code literal-block"><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">ClaimRequirementAttribute</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">TypeFilterAttribute</span>
<span class="err">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">ClaimRequirementAttribute</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">claimType</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">claimValue</span><span class="p">)</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">base</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">ClaimRequirementFilter</span><span class="p">))</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="n">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">object</span><span class="err">[]</span><span class="w"> </span><span class="err">{</span><span class="k">new</span><span class="w"> </span><span class="n">Claim</span><span class="p">(</span><span class="n">claimType</span><span class="p">,</span><span class="w"> </span><span class="n">claimValue</span><span class="p">)</span><span class="w"> </span><span class="err">}</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">ClaimRequirementFilter</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">IAuthorizationFilter</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">readonly</span><span class="w"> </span><span class="n">Claim</span><span class="w"> </span><span class="n">_claim</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">ClaimRequirementFilter</span><span class="p">(</span><span class="n">Claim</span><span class="w"> </span><span class="n">claim</span><span class="p">)</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="n">_claim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">claim</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">OnAuthorization</span><span class="p">(</span><span class="n">AuthorizationFilterContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">hasClaim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="k">User</span><span class="p">.</span><span class="n">Claims</span><span class="p">.</span><span class="ow">Any</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">_claim</span><span class="p">.</span><span class="n">Type</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="k">Value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">_claim</span><span class="p">.</span><span class="k">Value</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">hasClaim</span><span class="p">)</span>
<span class="w">        </span><span class="err">{</span>
<span class="w">            </span><span class="n">context</span><span class="p">.</span><span class="k">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ForbidResult</span><span class="p">();</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>


<span class="o">[</span><span class="n">Route("api/resource")</span><span class="o">]</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MyController</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">Controller</span>
<span class="err">{</span>
<span class="w">    </span><span class="o">[</span><span class="n">ClaimRequirement(MyClaimTypes.Permission, "CanReadResource")</span><span class="o">]</span>
<span class="w">    </span><span class="o">[</span><span class="n">HttpGet</span><span class="o">]</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">IActionResult</span><span class="w"> </span><span class="n">GetResource</span><span class="p">()</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Ok</span><span class="p">();</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>I'm the asp.net security person. <del>Firstly let me apologize that none of this
is documented yet outside of the music store sample or unit tests, and it's
all still being refined in terms of exposed APIs.</del> Detailed documentation is
here.</p>
<p>We don't want you writing custom authorize attributes. If you need to do that
we've done something wrong. Instead, you should be writing authorization
<em>requirements</em>.</p>
<p>Authorization acts upon Identities. Identities are created by authentication.</p>
<p>You say in comments you want to check a session ID in a header. Your session
ID would be the basis for identity. If you wanted to use the <code>Authorize</code>
attribute you'd write an authentication middleware to take that header and
turn it into an authenticated <code>ClaimsPrincipal</code>. You would then check that
inside an authorization requirement. Authorization requirements can be as
complicated as you like, for example here's one that takes a date of birth
claim on the current identity and will authorize if the user is over 18;</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">Over18Requirement</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">AuthorizationHandler</span><span class="o">&lt;</span><span class="n">Over18Requirement</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">IAuthorizationRequirement</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">Handle</span><span class="p">(</span><span class="n">AuthorizationHandlerContext</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Over18Requirement</span><span class="w"> </span><span class="n">requirement</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">HasClaim</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ClaimTypes</span><span class="o">.</span><span class="n">DateOfBirth</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">context</span><span class="o">.</span><span class="n">Fail</span><span class="p">();</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">dobVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">FindFirst</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ClaimTypes</span><span class="o">.</span><span class="n">DateOfBirth</span><span class="p">)</span><span class="o">.</span><span class="n">Value</span><span class="p">;</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">dateOfBirth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Convert</span><span class="o">.</span><span class="n">ToDateTime</span><span class="p">(</span><span class="n">dobVal</span><span class="p">);</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateTime</span><span class="o">.</span><span class="n">Today</span><span class="o">.</span><span class="n">Year</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dateOfBirth</span><span class="o">.</span><span class="n">Year</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dateOfBirth</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">DateTime</span><span class="o">.</span><span class="n">Today</span><span class="o">.</span><span class="n">AddYears</span><span class="p">(</span><span class="o">-</span><span class="n">age</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">age</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">age</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">18</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">context</span><span class="o">.</span><span class="n">Succeed</span><span class="p">(</span><span class="n">requirement</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">context</span><span class="o">.</span><span class="n">Fail</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Then in your <code>ConfigureServices()</code> function you'd wire it up</p>
<div class="code"><pre class="code literal-block">services.AddAuthorization(options =&gt;
{
    options.AddPolicy("Over18", 
        policy =&gt; policy.Requirements.Add(new Authorization.Over18Requirement()));
});
</pre></div>

<p>And finally, apply it to a controller or action method with</p>
<div class="code"><pre class="code literal-block">[Authorize(Policy = "Over18")]
</pre></div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1007.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1005.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
