<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 2555) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-2555.html">
<link rel="prev" href="index-2556.html" type="text/html">
<link rel="next" href="index-2554.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/using-transactions-or-savechanges-false-and-acceptallchanges/" class="u-url">Using Transactions or SaveChanges(false) and AcceptAllChanges()?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/using-transactions-or-savechanges-false-and-acceptallchanges/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T00:45:22+08:00" itemprop="datePublished" title="2023-03-05 00:45">2023-03-05 00:45</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I have been investigating transactions and it appears that they take care of
themselves in EF as long as I pass <code>false</code> to <code>SaveChanges()</code> and then call
<code>AcceptAllChanges()</code> if there are no errors:</p>
<div class="code"><pre class="code literal-block">SaveChanges(false);
// ...
AcceptAllChanges();
</pre></div>

<p>What if something goes bad? don't I have to rollback or, as soon as my method
goes out of scope, is the transaction ended?</p>
<p>What happens to any indentiy columns that were assigned half way through the
transaction? I presume if somebody else added a record after mine before mine
went bad then this means there will be a missing Identity value.</p>
<p>Is there any reason to use the standard <code>TransactionScope</code> class in my code?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>With the Entity Framework most of the time <code>SaveChanges()</code> is sufficient. This
creates a transaction, or enlists in any ambient transaction, and does all the
necessary work in that transaction.</p>
<p>Sometimes though the <code>SaveChanges(false) + AcceptAllChanges()</code> pairing is
useful.</p>
<p>The most useful place for this is in situations where you want to do a
distributed transaction across two different Contexts.</p>
<p>I.e. something like this (bad):</p>
<div class="code"><pre class="code literal-block"><span class="nv">using</span><span class="w"> </span><span class="ss">(</span><span class="nv">TransactionScope</span><span class="w"> </span><span class="nv">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">TransactionScope</span><span class="ss">())</span>
{
<span class="w">    </span><span class="o">//</span><span class="k">Do</span><span class="w"> </span><span class="nv">something</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">context1</span>
<span class="w">    </span><span class="o">//</span><span class="k">Do</span><span class="w"> </span><span class="nv">something</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">context2</span>

<span class="w">    </span><span class="o">//</span><span class="nv">Save</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">discard</span><span class="w"> </span><span class="nv">changes</span>
<span class="w">    </span><span class="nv">context1</span>.<span class="nv">SaveChanges</span><span class="ss">()</span><span class="c1">;</span>

<span class="w">    </span><span class="o">//</span><span class="nv">Save</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">discard</span><span class="w"> </span><span class="nv">changes</span>
<span class="w">    </span><span class="nv">context2</span>.<span class="nv">SaveChanges</span><span class="ss">()</span><span class="c1">;</span>

<span class="w">    </span><span class="o">//</span><span class="k">if</span><span class="w"> </span><span class="nv">we</span><span class="w"> </span><span class="nv">get</span><span class="w"> </span><span class="nv">here</span><span class="w"> </span><span class="nv">things</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">looking</span><span class="w"> </span><span class="nv">good</span>.
<span class="w">    </span><span class="nv">scope</span>.<span class="nv">Complete</span><span class="ss">()</span><span class="c1">;</span>
}
</pre></div>

<p>If <code>context1.SaveChanges()</code> succeeds but <code>context2.SaveChanges()</code> fails the
whole distributed transaction is aborted. But unfortunately the Entity
Framework has already discarded the changes on <code>context1</code>, so you can't replay
or effectively log the failure.</p>
<p>But if you change your code to look like this:</p>
<div class="code"><pre class="code literal-block"><span class="nv">using</span><span class="w"> </span><span class="ss">(</span><span class="nv">TransactionScope</span><span class="w"> </span><span class="nv">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">TransactionScope</span><span class="ss">())</span>
{
<span class="w">    </span><span class="o">//</span><span class="k">Do</span><span class="w"> </span><span class="nv">something</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">context1</span>
<span class="w">    </span><span class="o">//</span><span class="k">Do</span><span class="w"> </span><span class="nv">something</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">context2</span>

<span class="w">    </span><span class="o">//</span><span class="nv">Save</span><span class="w"> </span><span class="nv">Changes</span><span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">don</span><span class="err">'t discard yet</span>
<span class="err">    context1.SaveChanges(false);</span>

<span class="w">    </span><span class="o">//</span><span class="nv">Save</span><span class="w"> </span><span class="nv">Changes</span><span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">don</span><span class="err">'t discard yet</span>
<span class="err">    context2.SaveChanges(false);</span>

<span class="err">    //if we get here things are looking good.</span>
<span class="err">    scope.Complete();</span>
<span class="err">    context1.AcceptAllChanges();</span>
<span class="err">    context2.AcceptAllChanges();</span>

<span class="err">}</span>
</pre></div>

<p>While the call to <code>SaveChanges(false)</code> sends the necessary commands to the
database, the context itself is not changed, so you can do it again if
necessary, or you can interrogate the <code>ObjectStateManager</code> if you want.</p>
<p>This means if the transaction actually throws an exception you can compensate,
by either re-trying or logging state of each contexts <code>ObjectStateManager</code>
somewhere.</p>
<p>See my blog post for more.</p>
<p><br></p>
<h3>Suggest</h3>
<p>If you are using EF6 (Entity Framework 6+), this has changed for database
calls to SQL.<br>
See: https://learn.microsoft.com/en-us/ef/ef6/saving/transactions</p>
<p>Use <code>context.Database.BeginTransaction</code>.</p>
<h3>From MSDN:</h3>
<blockquote>
<div class="code"><pre class="code literal-block"><span class="n">using</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">BloggingContext</span><span class="p">())</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">using</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">dbContextTransaction</span><span class="w"> </span><span class="o">=</span>
</pre></div>

<p>context.Database.BeginTransaction())
        {
            try
            {
                context.Database.ExecuteSqlCommand(
                    @"UPDATE Blogs SET Rating = 5" +
                        " WHERE Name LIKE '%Entity Framework%'"
                    );</p>
<div class="code"><pre class="code literal-block"><span class="w">            </span><span class="n">var</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Posts</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">Blog</span><span class="p">.</span><span class="n">Rating</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">            </span><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="n">post</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">query</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">post</span><span class="p">.</span><span class="n">Title</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">"[Cool Blog]"</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>

<span class="w">            </span><span class="n">dbContextTransaction</span><span class="p">.</span><span class="n">Commit</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">dbContextTransaction</span><span class="p">.</span><span class="n">Rollback</span><span class="p">();</span><span class="w"> </span><span class="c1">//Required according to</span>
</pre></div>

<p>MSDN article
                throw; //Not in MSDN article, but recommended so the
exception still bubbles up
            }
        }
    }
</p>
</blockquote>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/difference-between-wait-and-sleep/" class="u-url">Difference between wait and sleep</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/difference-between-wait-and-sleep/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T00:43:37+08:00" itemprop="datePublished" title="2023-03-05 00:43">2023-03-05 00:43</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>What is difference between <code>wait</code> and <code>sleep</code>?</p>
<p><br><br></p>
<h2>Answer</h2>
<p><code>wait</code> waits for a process to finish; <code>sleep</code> sleeps for a certain amount of
seconds.</p>
<p><br></p>
<h3>Suggest</h3>
<p>wait is a BASH built-in command. From <code>man bash</code>:</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="k">wait</span><span class="w"> </span>[<span class="nv">n</span><span class="w"> </span>...]
<span class="w">        </span><span class="k">Wait</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nv">each</span><span class="w"> </span><span class="nv">specified</span><span class="w"> </span><span class="nv">process</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nv">its</span><span class="w"> </span><span class="nv">termination</span><span class="w"> </span><span class="nv">sta</span><span class="o">-</span>
<span class="w">        </span><span class="nv">tus</span>.<span class="w">  </span><span class="nv">Each</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">may</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">process</span><span class="w"> </span><span class="nv">ID</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">job</span><span class="w">  </span><span class="nv">specification</span><span class="c1">;  if  a</span>
<span class="w">        </span><span class="nv">job</span><span class="w">  </span><span class="nv">spec</span><span class="w">  </span><span class="nv">is</span><span class="w">  </span><span class="nv">given</span>,<span class="w">  </span><span class="nv">all</span><span class="w">  </span><span class="nv">processes</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">job</span><span class="err">'s pipeline are</span>
<span class="err">        waited for.  If n is not given, all currently active child  pro-</span>
<span class="err">        cesses  are  waited  for,  and  the return status is zero.  If n</span>
<span class="err">        specifies a non-existent process or job, the  return  status  is</span>
<span class="err">        127.   Otherwise,  the  return  status is the exit status of the</span>
<span class="err">        last process or job waited for.</span>
</pre></div>

<p>sleep is not a shell built-in command. It is a utility that delays for a
specified amount of time.</p>
<p>The <code>sleep</code> command may support waiting in various units of time. GNU
coreutils 8.4 <code>man sleep</code> says:</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="n">SYNOPSIS</span>
<span class="w">        </span><span class="n">sleep</span><span class="w"> </span><span class="n">NUMBER</span><span class="o">[</span><span class="n">SUFFIX</span><span class="o">]</span><span class="p">...</span>

<span class="w">    </span><span class="n">DESCRIPTION</span>
<span class="w">        </span><span class="n">Pause</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">NUMBER</span><span class="w"> </span><span class="n">seconds</span><span class="p">.</span><span class="w">  </span><span class="n">SUFFIX</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="err">‘</span><span class="n">s</span><span class="err">’</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="p">(</span><span class="n">the</span><span class="w"> </span><span class="k">default</span><span class="p">),</span>
<span class="w">        </span><span class="err">‘</span><span class="n">m</span><span class="err">’</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">minutes</span><span class="p">,</span><span class="w"> </span><span class="err">‘</span><span class="n">h</span><span class="err">’</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">hours</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="err">‘</span><span class="n">d</span><span class="err">’</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">days</span><span class="p">.</span><span class="w">  </span><span class="n">Unlike</span><span class="w"> </span><span class="n">most</span><span class="w">  </span><span class="n">implemen</span><span class="o">-</span>
<span class="w">        </span><span class="n">tations</span><span class="w">  </span><span class="n">that</span><span class="w"> </span><span class="n">require</span><span class="w"> </span><span class="n">NUMBER</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="k">integer</span><span class="p">,</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="n">NUMBER</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">arbi</span><span class="o">-</span>
<span class="w">        </span><span class="n">trary</span><span class="w"> </span><span class="n">floating</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">number</span><span class="p">.</span><span class="w">  </span><span class="n">Given</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">more</span><span class="w">  </span><span class="n">arguments</span><span class="p">,</span><span class="w">  </span><span class="n">pause</span><span class="w">  </span><span class="k">for</span>
<span class="w">        </span><span class="n">the</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nc">time</span><span class="w"> </span><span class="n">specified</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nf">sum</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="k">values</span><span class="p">.</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/android-m-check-runtime-permission-how-to-determine-if-the-user-checked-never-ask-again/" class="u-url">Android M - check runtime permission - how to determine if the user checked "Never ask again"?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/android-m-check-runtime-permission-how-to-determine-if-the-user-checked-never-ask-again/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T00:41:42+08:00" itemprop="datePublished" title="2023-03-05 00:41">2023-03-05 00:41</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>According to this: http://developer.android.com/preview/features/runtime-
permissions.html#coding an app can check for runtime permissions and request
permissions if it hasn't been granted already. The following dialog will be
displayed then:</p>
<p><img alt="enter image description here" src="images/JiZCa.png"></p>
<p>In case the user declines an important permission, imo an app should display
an explanation why the permission is needed and what impact declining has.
That dialog has two options:</p>
<ol>
<li>re-try again (permission is requested again)</li>
<li>deny (app will work without that permission).</li>
</ol>
<p>If the user checks <code>Never ask again</code> however, the second dialog with the
explanation shouldn't be shown, especially if the user already declined once
before. Now the question is: how does my app know whether the user has checked
the <code>Never ask again</code>? IMO the <code>onRequestPermissionsResult(int requestCode,
String[] permissions, int[] grantResults)</code> doesn't give me that information.</p>
<p>A second question would be: does Google have plans to incorporate a custom
message in the permission dialog that would explain why the app needs the
permission? That way there would never be a second dialog which would
certainly make for a better ux.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Developer Preview 2 brings some changes to how permissions are requested by
the app (see also
http://developer.android.com/preview/support.html#preview2-notes).</p>
<p>The first dialog now looks like this:</p>
<p><img alt="enter image description here" src="images/T9lCb.png"></p>
<p>There's no "Never show again" check-box (unlike developer preview 1). If the
user denies the permission and if the permission is essential for the app it
could present another dialog to explain the reason the app asks for that
permission, e.g. like this:</p>
<p><img alt="enter image description here" src="images/299nH.png"></p>
<p>If the user declines again the app should either shut down if it absolutely
needs that permission or keep running with limited functionality. If the user
reconsiders (and selects re-try), the permission is requested again. This time
the prompt looks like this:</p>
<p><img alt="enter image description here" src="images/RVmdo.png"></p>
<p>The second time the "Never ask again" check-box is shown. If the user denies
again and the check-box is ticked nothing more should happen. Whether or not
the check-box is ticked can be determined by using
Activity.shouldShowRequestPermissionRationale(String), e.g. like this:</p>
<div class="code"><pre class="code literal-block"><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">shouldShowRequestPermissionRationale</span><span class="ss">(</span><span class="nv">Manifest</span>.<span class="nv">permission</span>.<span class="nv">WRITE_CONTACTS</span><span class="ss">))</span><span class="w"> </span>{...
</pre></div>

<p>That's what the Android documentation says
(https://developer.android.com/training/permissions/requesting.html):</p>
<blockquote>
<p>To help find the situations where you need to provide extra explanation, the
system provides the Activity.shouldShowRequestPermissionRationale(String)
method. This method returns true if the app has requested this permission
previously and the user denied the request. That indicates that you should
probably explain to the user why you need the permission.</p>
<p>If the user turned down the permission request in the past and chose the
Don't ask again option in the permission request system dialog, this method
returns false. The method also returns false if the device policy prohibits
the app from having that permission.</p>
</blockquote>
<p>To know if the user denied with "never ask again" you can check again the
<em>shouldShowRequestPermissionRationale</em> method in your
onRequestPermissionsResult when the user did not grant the permission.</p>
<div class="code"><pre class="code literal-block"><span class="nv">@Override</span>
<span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">onRequestPermissionsResult</span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">requestCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="err">[]</span><span class="w"> </span><span class="nf">permissions</span><span class="p">,</span><span class="w"> </span><span class="nc">int</span><span class="err">[]</span><span class="w"> </span><span class="n">grantResults</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">requestCode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">REQUEST_PERMISSION</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="n">permission</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="n">granted</span><span class="o">/</span><span class="n">denied</span><span class="w"> </span><span class="n">them</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">rationale</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">single</span><span class="w"> </span><span class="n">dialog</span><span class="p">,</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">example</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nf">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">permissions</span><span class="p">.</span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nf">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">permission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">permissions</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">grantResults</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="n">PERMISSION_DENIED</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="n">rejected</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">permission</span>
<span class="w">                </span><span class="k">boolean</span><span class="w"> </span><span class="n">showRationale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shouldShowRequestPermissionRationale</span><span class="p">(</span><span class="w"> </span><span class="n">permission</span><span class="w"> </span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="w"> </span><span class="n">showRationale</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                    </span><span class="o">//</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">CHECKED</span><span class="w"> </span><span class="ss">"never ask again"</span>
<span class="w">                    </span><span class="o">//</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">either</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="ow">some</span><span class="w"> </span><span class="n">fall</span><span class="w"> </span><span class="n">back</span><span class="p">,</span>
<span class="w">                    </span><span class="o">//</span><span class="w"> </span><span class="n">disable</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">app</span>
<span class="w">                    </span><span class="o">//</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="k">open</span><span class="w"> </span><span class="n">another</span><span class="w"> </span><span class="n">dialog</span><span class="w"> </span><span class="n">explaining</span>
<span class="w">                    </span><span class="o">//</span><span class="w"> </span><span class="n">again</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">permission</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">directing</span><span class="w"> </span><span class="k">to</span>
<span class="w">                    </span><span class="o">//</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="n">setting</span>
<span class="w">                </span><span class="err">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Manifest</span><span class="p">.</span><span class="n">permission</span><span class="p">.</span><span class="n">WRITE_CONTACTS</span><span class="p">.</span><span class="k">equals</span><span class="p">(</span><span class="n">permission</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">                    </span><span class="n">showRationale</span><span class="p">(</span><span class="n">permission</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">permission_denied_contacts</span><span class="p">);</span>
<span class="w">                    </span><span class="o">//</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="n">did</span><span class="w"> </span><span class="ow">NOT</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="ss">"never ask again"</span>
<span class="w">                    </span><span class="o">//</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">good</span><span class="w"> </span><span class="n">place</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">explain</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">user</span>
<span class="w">                    </span><span class="o">//</span><span class="w"> </span><span class="n">why</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">permission</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">ask</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">he</span><span class="w"> </span><span class="n">wants</span>
<span class="w">                    </span><span class="o">//</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">accept</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="p">(</span><span class="n">the</span><span class="w"> </span><span class="n">rationale</span><span class="p">)</span>
<span class="w">                </span><span class="err">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="cm">/* possibly check more permissions...*/</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="err">}</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>You can open your app setting with this code:</p>
<div class="code"><pre class="code literal-block">Intent intent = new Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);
Uri uri = Uri.fromParts("package", getPackageName(), null);
intent.setData(uri);
startActivityForResult(intent, REQUEST_PERMISSION_SETTING);
</pre></div>

<p>There is no way of sending the user directly to the Authorization page.</p>
<p><br></p>
<h3>Suggest</h3>
<p>You can check <code>shouldShowRequestPermissionRationale()</code> in your
<code>onRequestPermissionsResult()</code>.</p>
<p><img alt="shouldShowRequestPermissionRationale" src="images/e67lS.jpg">
https://youtu.be/C8lUdPVSzDk?t=2m23s</p>
<p>Check whether permission was granted or not in <code>onRequestPermissionsResult()</code>.
If <strong>not</strong> then check <code>shouldShowRequestPermissionRationale()</code>.</p>
<ol>
<li>If this method returns <code>true</code> then show an explanation that why this particular permission is needed. Then depending on user's choice again <code>requestPermissions()</code>.</li>
<li>If it returns <code>false</code> then show an error message that permission was not granted and app cannot proceed further or a particular feature is disabled.</li>
</ol>
<p>Below is sample code.</p>
<div class="code"><pre class="code literal-block"><span class="err">@</span><span class="n">Override</span>
<span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">onRequestPermissionsResult</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">requestCode</span><span class="p">,</span><span class="w"> </span><span class="err">@</span><span class="n">NonNull</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="p">[]</span><span class="w"> </span><span class="n">permissions</span><span class="p">,</span><span class="w"> </span><span class="err">@</span><span class="n">NonNull</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">[]</span><span class="w"> </span><span class="n">grantResults</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">super</span><span class="o">.</span><span class="n">onRequestPermissionsResult</span><span class="p">(</span><span class="n">requestCode</span><span class="p">,</span><span class="w"> </span><span class="n">permissions</span><span class="p">,</span><span class="w"> </span><span class="n">grantResults</span><span class="p">);</span>
<span class="w">    </span><span class="n">switch</span><span class="w"> </span><span class="p">(</span><span class="n">requestCode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">case</span><span class="w"> </span><span class="n">STORAGE_PERMISSION_REQUEST</span><span class="p">:</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">grantResults</span><span class="o">.</span><span class="n">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">grantResults</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PackageManager</span><span class="o">.</span><span class="n">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">permission</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">granted</span><span class="w"> </span><span class="p">:)</span>
<span class="w">                </span><span class="n">downloadFile</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">permission</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">granted</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getActivity</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">return</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ActivityCompat</span><span class="o">.</span><span class="n">shouldShowRequestPermissionRationale</span><span class="p">(</span><span class="n">getActivity</span><span class="p">(),</span><span class="w"> </span><span class="n">Manifest</span><span class="o">.</span><span class="n">permission</span><span class="o">.</span><span class="n">WRITE_EXTERNAL_STORAGE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">showStoragePermissionRationale</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Snackbar</span><span class="w"> </span><span class="n">snackbar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Snackbar</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">getView</span><span class="p">(),</span><span class="w"> </span><span class="n">getResources</span><span class="p">()</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">message_no_storage_permission_snackbar</span><span class="p">),</span><span class="w"> </span><span class="n">Snackbar</span><span class="o">.</span><span class="n">LENGTH_LONG</span><span class="p">);</span>
<span class="w">                    </span><span class="n">snackbar</span><span class="o">.</span><span class="n">setAction</span><span class="p">(</span><span class="n">getResources</span><span class="p">()</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">settings</span><span class="p">),</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">View</span><span class="o">.</span><span class="n">OnClickListener</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="err">@</span><span class="n">Override</span>
<span class="w">                        </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">onClick</span><span class="p">(</span><span class="n">View</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getActivity</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="k">return</span><span class="p">;</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                            </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">();</span>
<span class="w">                            </span><span class="n">intent</span><span class="o">.</span><span class="n">setAction</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">ACTION_APPLICATION_DETAILS_SETTINGS</span><span class="p">);</span>
<span class="w">                            </span><span class="n">Uri</span><span class="w"> </span><span class="n">uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uri</span><span class="o">.</span><span class="n">fromParts</span><span class="p">(</span><span class="s2">"package"</span><span class="p">,</span><span class="w"> </span><span class="n">getActivity</span><span class="p">()</span><span class="o">.</span><span class="n">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">);</span>
<span class="w">                            </span><span class="n">intent</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">uri</span><span class="p">);</span>
<span class="w">                            </span><span class="n">OrderDetailFragment</span><span class="o">.</span><span class="n">this</span><span class="o">.</span><span class="n">startActivity</span><span class="p">(</span><span class="n">intent</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">});</span>
<span class="w">                    </span><span class="n">snackbar</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Apparently, google maps does exactly this for location permission.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2556.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2554.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
