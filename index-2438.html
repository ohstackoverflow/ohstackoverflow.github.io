<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 2438) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-2438.html">
<link rel="prev" href="index-2439.html" type="text/html">
<link rel="next" href="index-2437.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/why-can-t-i-store-a-value-and-a-reference-to-that-value-in-the-same-struct/" class="u-url">Why can't I store a value and a reference to that value in the same struct?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/why-can-t-i-store-a-value-and-a-reference-to-that-value-in-the-same-struct/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-04T16:10:07+08:00" itemprop="datePublished" title="2023-03-04 16:10">2023-03-04 16:10</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I have a value and I want to store that value and a reference to something
inside that value in my own type:</p>
<div class="code"><pre class="code literal-block"><span class="nt">struct</span><span class="w"> </span><span class="nt">Thing</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">count</span><span class="p">:</span><span class="w"> </span><span class="n">u32</span><span class="p">,</span>
<span class="p">}</span>

<span class="nt">struct</span><span class="w"> </span><span class="nt">Combined</span><span class="o">&lt;</span><span class="s1">'a&gt;(Thing, &amp;'</span><span class="nt">a</span><span class="w"> </span><span class="nt">u32</span><span class="o">);</span>

<span class="nt">fn</span><span class="w"> </span><span class="nt">make_combined</span><span class="o">&lt;</span><span class="s1">'a&gt;() -&gt; Combined&lt;'</span><span class="nt">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">let</span><span class="w"> </span><span class="err">thing</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">Thing</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">count</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="p">}</span><span class="o">;</span>

<span class="w">    </span><span class="nt">Combined</span><span class="o">(</span><span class="nt">thing</span><span class="o">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nt">thing</span><span class="p">.</span><span class="nc">count</span><span class="o">)</span>
<span class="err">}</span>
</pre></div>

<p>Sometimes, I have a value and I want to store that value and a reference to
that value in the same structure:</p>
<div class="code"><pre class="code literal-block"><span class="nt">struct</span><span class="w"> </span><span class="nt">Combined</span><span class="o">&lt;</span><span class="s1">'a&gt;(Thing, &amp;'</span><span class="nt">a</span><span class="w"> </span><span class="nt">Thing</span><span class="o">);</span>

<span class="nt">fn</span><span class="w"> </span><span class="nt">make_combined</span><span class="o">&lt;</span><span class="s1">'a&gt;() -&gt; Combined&lt;'</span><span class="nt">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">let</span><span class="w"> </span><span class="err">thing</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="n">Thing</span><span class="p">:</span><span class="o">:</span><span class="nf">new</span><span class="p">();</span>

<span class="w">    </span><span class="err">Combined(thing,</span><span class="w"> </span><span class="err">&amp;thing)</span>
<span class="p">}</span>
</pre></div>

<p>Sometimes, I'm not even taking a reference of the value and I get the same
error:</p>
<div class="code"><pre class="code literal-block"><span class="nt">struct</span><span class="w"> </span><span class="nt">Combined</span><span class="o">&lt;</span><span class="s1">'a&gt;(Parent, Child&lt;'</span><span class="nt">a</span><span class="o">&gt;);</span>

<span class="nt">fn</span><span class="w"> </span><span class="nt">make_combined</span><span class="o">&lt;</span><span class="s1">'a&gt;() -&gt; Combined&lt;'</span><span class="nt">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">let</span><span class="w"> </span><span class="err">parent</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="n">Parent</span><span class="p">:</span><span class="o">:</span><span class="nf">new</span><span class="p">();</span>
<span class="w">    </span><span class="err">let</span><span class="w"> </span><span class="err">child</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">parent.child()</span><span class="p">;</span>

<span class="w">    </span><span class="err">Combined(parent,</span><span class="w"> </span><span class="err">child)</span>
<span class="p">}</span>
</pre></div>

<p>In each of these cases, I get an error that one of the values "does not live
long enough". What does this error mean?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Let's look at a simple implementation of this:</p>
<div class="code"><pre class="code literal-block"><span class="nt">struct</span><span class="w"> </span><span class="nt">Parent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">count</span><span class="p">:</span><span class="w"> </span><span class="n">u32</span><span class="p">,</span>
<span class="p">}</span>

<span class="nt">struct</span><span class="w"> </span><span class="nt">Child</span><span class="o">&lt;</span><span class="s1">'a&gt; {</span>
<span class="s1">    parent: &amp;'</span><span class="nt">a</span><span class="w"> </span><span class="nt">Parent</span><span class="o">,</span>
<span class="err">}</span>

<span class="nt">struct</span><span class="w"> </span><span class="nt">Combined</span><span class="o">&lt;</span><span class="s1">'a&gt; {</span>
<span class="s1">    parent: Parent,</span>
<span class="s1">    child: Child&lt;'</span><span class="nt">a</span><span class="o">&gt;,</span>
<span class="err">}</span>

<span class="nt">impl</span><span class="o">&lt;</span><span class="s1">'a&gt; Combined&lt;'</span><span class="nt">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">fn</span><span class="w"> </span><span class="err">new()</span><span class="w"> </span><span class="err">-&gt;</span><span class="w"> </span><span class="err">Self</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="err">let</span><span class="w"> </span><span class="err">parent</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">Parent</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">count</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="p">}</span><span class="o">;</span>
<span class="w">        </span><span class="nt">let</span><span class="w"> </span><span class="nt">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">Child</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">parent</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parent</span><span class="w"> </span><span class="p">}</span><span class="o">;</span>

<span class="w">        </span><span class="nt">Combined</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">parent,</span><span class="w"> </span><span class="err">child</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>

<span class="nt">fn</span><span class="w"> </span><span class="nt">main</span><span class="o">()</span><span class="w"> </span><span class="p">{}</span>
</pre></div>

<p>This will fail with the error:</p>
<div class="code"><pre class="code literal-block"><span class="k">error</span><span class="err">[</span><span class="n">E0515</span><span class="err">]</span><span class="o">:</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="n">referencing</span><span class="w"> </span><span class="k">local</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n n-Quoted">`parent`</span>
<span class="w">  </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">19</span><span class="o">:</span><span class="mi">9</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="n">let</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Child</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">parent</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parent</span><span class="w"> </span><span class="err">}</span><span class="p">;</span>
<span class="w">   </span><span class="o">|</span><span class="w">                                     </span><span class="o">-------</span><span class="w"> </span><span class="n n-Quoted">`parent`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">borrowed</span><span class="w"> </span><span class="n">here</span>
<span class="mi">18</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>
<span class="mi">19</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="n">Combined</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="err">}</span>
<span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="n">referencing</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="n">owned</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="k">function</span>

<span class="k">error</span><span class="err">[</span><span class="n">E0505</span><span class="err">]</span><span class="o">:</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n n-Quoted">`parent`</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">borrowed</span>
<span class="w">  </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">19</span><span class="o">:</span><span class="mi">20</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">14</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">impl</span><span class="o">&lt;</span><span class="s1">'a&gt; Combined&lt;'</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="c1">-- lifetime `'a` defined here</span>
<span class="p">...</span>
<span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="n">let</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Child</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">parent</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parent</span><span class="w"> </span><span class="err">}</span><span class="p">;</span>
<span class="w">   </span><span class="o">|</span><span class="w">                                     </span><span class="o">-------</span><span class="w"> </span><span class="n">borrow</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n n-Quoted">`parent`</span><span class="w"> </span><span class="n">occurs</span><span class="w"> </span><span class="n">here</span>
<span class="mi">18</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>
<span class="mi">19</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="n">Combined</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="err">}</span>
<span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="o">-----------^^^^^^---------</span>
<span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">          </span><span class="o">|</span>
<span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">          </span><span class="n">move</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n n-Quoted">`parent`</span><span class="w"> </span><span class="n">occurs</span><span class="w"> </span><span class="n">here</span>
<span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="k">returning</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n n-Quoted">`parent`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">borrowed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n n-Quoted">`'a`</span>
</pre></div>

<p>To completely understand this error, you have to think about how the values
are represented in memory and what happens when you <em>move</em> those values. Let's
annotate <code>Combined::new</code> with some hypothetical memory addresses that show
where values are located:</p>
<div class="code"><pre class="code literal-block"><span class="n">let</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Parent</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">count</span><span class="o">:</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="err">}</span><span class="p">;</span>
<span class="o">//</span><span class="w"> </span><span class="n n-Quoted">`parent`</span><span class="w"> </span><span class="n">lives</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x1000</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bytes</span>
<span class="o">//</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n n-Quoted">`parent`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span>
<span class="n">let</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Child</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">parent</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parent</span><span class="w"> </span><span class="err">}</span><span class="p">;</span>
<span class="o">//</span><span class="w"> </span><span class="n n-Quoted">`child`</span><span class="w"> </span><span class="n">lives</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x1010</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bytes</span>
<span class="o">//</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n n-Quoted">`child`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="mh">0x1000</span>

<span class="n">Combined</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="err">}</span>
<span class="o">//</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="n">lives</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0x2000</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bytes</span>
<span class="o">//</span><span class="w"> </span><span class="n n-Quoted">`parent`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">moved</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mh">0x2000</span>
<span class="o">//</span><span class="w"> </span><span class="n n-Quoted">`child`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="nv">?</span>
</pre></div>

<p>What should happen to <code>child</code>? If the value was just moved like <code>parent</code> was,
then it would refer to memory that no longer is guaranteed to have a valid
value in it. Any other piece of code is allowed to store values at memory
address 0x1000. Accessing that memory assuming it was an integer could lead to
crashes and/or security bugs, and is one of the main categories of errors that
Rust prevents.</p>
<p>This is exactly the problem that <em>lifetimes</em> prevent. A lifetime is a bit of
metadata that allows you and the compiler to know how long a value will be
valid at its <strong>current memory location</strong>. That's an important distinction, as
it's a common mistake Rust newcomers make. Rust lifetimes are <em>not</em> the time
period between when an object is created and when it is destroyed!</p>
<p>As an analogy, think of it this way: During a person's life, they will reside
in many different locations, each with a distinct address. A Rust lifetime is
concerned with the address you <em>currently reside at</em> , not about whenever you
will die in the future (although dying also changes your address). Every time
you move it's relevant because your address is no longer valid.</p>
<p>It's also important to note that lifetimes <em>do not</em> change your code; your
code controls the lifetimes, your lifetimes don't control the code. The pithy
saying is "lifetimes are descriptive, not prescriptive".</p>
<p>Let's annotate <code>Combined::new</code> with some line numbers which we will use to
highlight lifetimes:</p>
<div class="code"><pre class="code literal-block"><span class="p">{</span><span class="w">                                          </span><span class="err">//</span><span class="w"> </span><span class="err">0</span>
<span class="w">    </span><span class="err">let</span><span class="w"> </span><span class="err">parent</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">Parent</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">count</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="p">}</span><span class="o">;</span><span class="w">     </span><span class="o">//</span><span class="w"> </span><span class="nt">1</span>
<span class="w">    </span><span class="nt">let</span><span class="w"> </span><span class="nt">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">Child</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">parent</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parent</span><span class="w"> </span><span class="p">}</span><span class="o">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nt">2</span>
<span class="w">                                           </span><span class="o">//</span><span class="w"> </span><span class="nt">3</span>
<span class="w">    </span><span class="nt">Combined</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">parent,</span><span class="w"> </span><span class="err">child</span><span class="w"> </span><span class="p">}</span><span class="w">             </span><span class="o">//</span><span class="w"> </span><span class="nt">4</span>
<span class="err">}</span><span class="w">                                          </span><span class="o">//</span><span class="w"> </span><span class="nt">5</span>
</pre></div>

<p>The <em>concrete lifetime</em> of <code>parent</code> is from 1 to 4, inclusive (which I'll
represent as <code>[1,4]</code>). The concrete lifetime of <code>child</code> is <code>[2,4]</code>, and the
concrete lifetime of the return value is <code>[4,5]</code>. It's possible to have
concrete lifetimes that start at zero - that would represent the lifetime of a
parameter to a function or something that existed outside of the block.</p>
<p>Note that the lifetime of <code>child</code> itself is <code>[2,4]</code>, but that it <strong>refers to</strong>
a value with a lifetime of <code>[1,4]</code>. This is fine as long as the referring
value becomes invalid before the referred-to value does. The problem occurs
when we try to return <code>child</code> from the block. This would "over-extend" the
lifetime beyond its natural length.</p>
<p>This new knowledge should explain the first two examples. The third one
requires looking at the implementation of <code>Parent::child</code>. Chances are, it
will look something like this:</p>
<div class="code"><pre class="code literal-block"><span class="n">impl</span><span class="w"> </span><span class="n">Parent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">fn</span><span class="w"> </span><span class="n">child</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Child</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>This uses <em>lifetime elision</em> to avoid writing explicit <em>generic lifetime
parameters</em>. It is equivalent to:</p>
<div class="code"><pre class="code literal-block"><span class="n">impl</span><span class="w"> </span><span class="n">Parent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">fn</span><span class="w"> </span><span class="n">child</span><span class="o">&lt;</span><span class="s">'a&gt;(&amp;'</span><span class="n">a</span><span class="w"> </span><span class="kr">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Child</span><span class="o">&lt;</span><span class="s">'a&gt; { /* ... */ }</span>
<span class="s">}</span>
</pre></div>

<p>In both cases, the method says that a <code>Child</code> structure will be returned that
has been parameterized with the concrete lifetime of <code>self</code>. Said another way,
the <code>Child</code> instance contains a reference to the <code>Parent</code> that created it, and
thus cannot live longer than that <code>Parent</code> instance.</p>
<p>This also lets us recognize that something is really wrong with our creation
function:</p>
<div class="code"><pre class="code literal-block"><span class="n">fn</span><span class="w"> </span><span class="n">make_combined</span><span class="o">&lt;</span><span class="s">'a&gt;() -&gt; Combined&lt;'</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>
</pre></div>

<p>Although you are more likely to see this written in a different form:</p>
<div class="code"><pre class="code literal-block"><span class="n">impl</span><span class="o">&lt;</span><span class="s">'a&gt; Combined&lt;'</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">fn</span><span class="w"> </span><span class="n">new</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Combined</span><span class="o">&lt;</span><span class="s">'a&gt; { /* ... */ }</span>
<span class="s">}</span>
</pre></div>

<p>In both cases, there is no lifetime parameter being provided via an argument.
This means that the lifetime that <code>Combined</code> will be parameterized with isn't
constrained by anything - it can be whatever the caller wants it to be. This
is nonsensical, because the caller could specify the <code>'static</code> lifetime and
there's no way to meet that condition.</p>
<h4>How do I fix it?</h4>
<p>The easiest and most recommended solution is to not attempt to put these items
in the same structure together. By doing this, your structure nesting will
mimic the lifetimes of your code. Place types that own data into a structure
together and then provide methods that allow you to get references or objects
containing references as needed.</p>
<p>There is a special case where the lifetime tracking is overzealous: when you
have something placed on the heap. This occurs when you use a <code>Box&lt;T&gt;</code>, for
example. In this case, the structure that is moved contains a pointer into the
heap. The pointed-at value will remain stable, but the address of the pointer
itself will move. In practice, this doesn't matter, as you always follow the
pointer.</p>
<p>Some crates provide ways of representing this case, but they require that the
base address <em>never move</em>. This rules out mutating vectors, which may cause a
reallocation and a move of the heap-allocated values.</p>
<ul>
<li>rental (no longer maintained or supported)</li>
<li>owning_ref (has multiple soundness issues)</li>
<li>ouroboros</li>
<li>self_cell</li>
</ul>
<p>Examples of problems solved with Rental:</p>
<ul>
<li>Is there an owned version of String::chars?</li>
<li>Returning a RWLockReadGuard independently from a method</li>
<li>How can I return an iterator over a locked struct member in Rust?</li>
<li>How to return a reference to a sub-value of a value that is under a mutex?</li>
<li>How do I store a result using Serde Zero-copy deserialization of a Futures-enabled Hyper Chunk?</li>
<li>How to store a reference without having to deal with lifetimes?</li>
</ul>
<p>In other cases, you may wish to move to some type of reference-counting, such
as by using <code>Rc</code> or <code>Arc</code>.</p>
<h4>More information</h4>
<blockquote>
<p>After moving <code>parent</code> into the struct, why is the compiler not able to get a
new reference to <code>parent</code> and assign it to <code>child</code> in the struct?</p>
</blockquote>
<p>While it is theoretically possible to do this, doing so would introduce a
large amount of complexity and overhead. Every time that the object is moved,
the compiler would need to insert code to "fix up" the reference. This would
mean that copying a struct is no longer a very cheap operation that just moves
some bits around. It could even mean that code like this is expensive,
depending on how good a hypothetical optimizer would be:</p>
<div class="code"><pre class="code literal-block"><span class="nt">let</span><span class="w"> </span><span class="nt">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">Object</span><span class="p">::</span><span class="nd">new</span><span class="o">();</span>
<span class="nt">let</span><span class="w"> </span><span class="nt">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">a</span><span class="o">;</span>
<span class="nt">let</span><span class="w"> </span><span class="nt">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">b</span><span class="o">;</span>
</pre></div>

<p>Instead of forcing this to happen for <em>every</em> move, the programmer gets to
<em>choose</em> when this will happen by creating methods that will take the
appropriate references only when you call them.</p>
<h4>A type with a reference to itself</h4>
<p>There's one specific case where you <em>can</em> create a type with a reference to
itself. You need to use something like <code>Option</code> to make it in two steps
though:</p>
<div class="code"><pre class="code literal-block"><span class="err">#</span><span class="cp">[</span><span class="nx">derive</span><span class="p">(</span><span class="nx">Debug</span><span class="p">)</span><span class="cp">]</span>
<span class="nt">struct</span><span class="w"> </span><span class="nt">WhatAboutThis</span><span class="o">&lt;</span><span class="s1">'a&gt; {</span>
<span class="s1">    name: String,</span>
<span class="s1">    nickname: Option&lt;&amp;'</span><span class="nt">a</span><span class="w"> </span><span class="nt">str</span><span class="o">&gt;,</span>
<span class="err">}</span>

<span class="nt">fn</span><span class="w"> </span><span class="nt">main</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">let</span><span class="w"> </span><span class="err">mut</span><span class="w"> </span><span class="err">tricky</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">WhatAboutThis</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="s2">"Annabelle"</span><span class="o">.</span><span class="nf">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">nickname</span><span class="o">:</span><span class="w"> </span><span class="n">None</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span><span class="o">;</span>
<span class="w">    </span><span class="nt">tricky</span><span class="p">.</span><span class="nc">nickname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">Some</span><span class="o">(&amp;</span><span class="nt">tricky</span><span class="p">.</span><span class="nc">name</span><span class="cp">[</span><span class="nx">..4</span><span class="cp">]</span><span class="o">);</span>

<span class="w">    </span><span class="nt">println</span><span class="o">!(</span><span class="s2">"{:?}"</span><span class="o">,</span><span class="w"> </span><span class="nt">tricky</span><span class="o">);</span>
<span class="err">}</span>
</pre></div>

<p>This does work, in some sense, but the created value is highly restricted - it
can <em>never</em> be moved. Notably, this means it cannot be returned from a
function or passed by-value to anything. A constructor function shows the same
problem with the lifetimes as above:</p>
<div class="code"><pre class="code literal-block"><span class="n">fn</span><span class="w"> </span><span class="n">creator</span><span class="o">&lt;</span><span class="s">'a&gt;() -&gt; WhatAboutThis&lt;'</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>
</pre></div>

<p>If you try to do this same code with a method, you'll need the alluring but
ultimately useless <code>&amp;'a self</code>. When that's involved, this code is even more
restricted and you will get borrow-checker errors after the first method call:</p>
<div class="code"><pre class="code literal-block"><span class="c1">#[derive(Debug)]</span>
<span class="n">struct</span><span class="w"> </span><span class="n">WhatAboutThis</span><span class="o">&lt;</span><span class="s1">'a&gt; {</span>
<span class="s1">    name: String,</span>
<span class="s1">    nickname: Option&lt;&amp;'</span><span class="n">a</span><span class="w"> </span><span class="n">str</span><span class="o">&gt;</span><span class="p">,</span>
<span class="err">}</span>

<span class="n">impl</span><span class="o">&lt;</span><span class="s1">'a&gt; WhatAboutThis&lt;'</span><span class="n">a</span><span class="o">&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">fn</span><span class="w"> </span><span class="n">tie_the_knot</span><span class="p">(</span><span class="o">&amp;</span><span class="s1">'a mut self) {</span>
<span class="s1">       self.nickname = Some(&amp;self.name[..4]); </span>
<span class="s1">    }</span>
<span class="s1">}</span>

<span class="s1">fn main() {</span>
<span class="s1">    let mut tricky = WhatAboutThis {</span>
<span class="s1">        name: "Annabelle".to_string(),</span>
<span class="s1">        nickname: None,</span>
<span class="s1">    };</span>
<span class="s1">    tricky.tie_the_knot();</span>

<span class="s1">    // cannot borrow `tricky` as immutable because it is also borrowed as mutable</span>
<span class="s1">    // println!("{:?}", tricky);</span>
<span class="s1">}</span>
</pre></div>

<p>See also:</p>
<ul>
<li>Cannot borrow as mutable more than once at a time in one code - but can in another very similar</li>
</ul>
<h4>What about <code>Pin</code>?</h4>
<p><code>Pin</code>, stabilized in Rust 1.33, has this in the module documentation:</p>
<blockquote>
<p>A prime example of such a scenario would be building self-referential
structs, since moving an object with pointers to itself will invalidate
them, which could cause undefined behavior.</p>
</blockquote>
<p>It's important to note that "self-referential" doesn't necessarily mean using
<em>a reference</em>. Indeed, the example of a self-referential struct specifically
says (emphasis mine):</p>
<blockquote>
<p>We cannot inform the compiler about that with a normal reference, since this
pattern cannot be described with the usual borrowing rules. Instead <strong>we use
a raw pointer</strong> , though one which is known to not be null, since we know
it's pointing at the string.</p>
</blockquote>
<p>The ability to use a raw pointer for this behavior has existed since Rust 1.0.
Indeed, owning-ref and rental use raw pointers under the hood.</p>
<p>The only thing that <code>Pin</code> adds to the table is a common way to state that a
given value is guaranteed to not move.</p>
<p>See also:</p>
<ul>
<li>How to use the Pin struct with self-referential structures?</li>
</ul>
<p><br></p>
<h3>Suggest</h3>
<p>A slightly different issue which causes very similar compiler messages is
object lifetime dependency, rather than storing an explicit reference. An
example of that is the ssh2 library. When developing something bigger than a
test project, it is tempting to try to put the <code>Session</code> and <code>Channel</code>
obtained from that session alongside each other into a struct, hiding the
implementation details from the user. However, note that the <code>Channel</code>
definition has the <code>'sess</code> lifetime in its type annotation, while <code>Session</code>
doesn't.</p>
<p>This causes similar compiler errors related to lifetimes.</p>
<p>One way to solve it in a very simple way is to declare the <code>Session</code> outside
in the caller, and then for annotate the reference within the struct with a
lifetime, similar to the answer in this Rust User's Forum post talking about
the same issue while encapsulating SFTP. This will not look elegant and may
not always apply - because now you have two entities to deal with, rather than
one that you wanted!</p>
<p>Turns out the rental crate or the owning_ref crate from the other answer are
the solutions for this issue too. Let's consider the owning_ref, which has the
special object for this exact purpose: <code>OwningHandle</code>. To avoid the underlying
object moving, we allocate it on the heap using a <code>Box</code>, which gives us the
following possible solution:</p>
<div class="code"><pre class="code literal-block"><span class="nt">use</span><span class="w"> </span><span class="nt">ssh2</span><span class="o">::</span><span class="p">{</span><span class="err">Channel,</span><span class="w"> </span><span class="err">Error,</span><span class="w"> </span><span class="err">Session</span><span class="p">}</span><span class="o">;</span>
<span class="nt">use</span><span class="w"> </span><span class="nt">std</span><span class="p">::</span><span class="nd">net</span><span class="p">::</span><span class="nd">TcpStream</span><span class="o">;</span>

<span class="nt">use</span><span class="w"> </span><span class="nt">owning_ref</span><span class="p">::</span><span class="nd">OwningHandle</span><span class="o">;</span>

<span class="nt">struct</span><span class="w"> </span><span class="nt">DeviceSSHConnection</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tcp</span><span class="p">:</span><span class="w"> </span><span class="n">TcpStream</span><span class="p">,</span>
<span class="w">    </span><span class="n">channel</span><span class="o">:</span><span class="w"> </span><span class="n">OwningHandle</span><span class="o">&lt;</span><span class="n">Box</span><span class="o">&lt;</span><span class="n">Session</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Box</span><span class="o">&lt;</span><span class="n">Channel</span><span class="o">&lt;</span><span class="err">'</span><span class="kc">static</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nt">impl</span><span class="w"> </span><span class="nt">DeviceSSHConnection</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">fn</span><span class="w"> </span><span class="err">new(</span><span class="n">targ</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">c_user</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">c_pass</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Self</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">use</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpStream</span><span class="p">;</span>
<span class="w">        </span><span class="err">let</span><span class="w"> </span><span class="err">mut</span><span class="w"> </span><span class="err">session</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="n">Session</span><span class="p">:</span><span class="o">:</span><span class="nf">new</span><span class="p">()</span><span class="o">.</span><span class="nf">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="err">let</span><span class="w"> </span><span class="err">mut</span><span class="w"> </span><span class="err">tcp</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="n">TcpStream</span><span class="p">:</span><span class="o">:</span><span class="nf">connect</span><span class="p">(</span><span class="n">targ</span><span class="p">)</span><span class="o">.</span><span class="nf">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="err">session.handshake(&amp;tcp).unwrap()</span><span class="p">;</span>
<span class="w">        </span><span class="err">session.set_timeout(5000)</span><span class="p">;</span>
<span class="w">        </span><span class="err">session.userauth_password(c_user,</span><span class="w"> </span><span class="err">c_pass).unwrap()</span><span class="p">;</span>

<span class="w">        </span><span class="err">let</span><span class="w"> </span><span class="err">mut</span><span class="w"> </span><span class="err">sess</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="n">Box</span><span class="p">:</span><span class="o">:</span><span class="nf">new</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
<span class="w">        </span><span class="err">let</span><span class="w"> </span><span class="err">mut</span><span class="w"> </span><span class="err">oref</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="n">OwningHandle</span><span class="p">:</span><span class="o">:</span><span class="nf">new_with_fn</span><span class="p">(</span>
<span class="w">            </span><span class="n">sess</span><span class="p">,</span>
<span class="w">            </span><span class="n">unsafe</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="err">|</span><span class="n">x</span><span class="err">|</span><span class="w"> </span><span class="n">Box</span><span class="err">::</span><span class="nf">new</span><span class="p">(</span><span class="err">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="err">.</span><span class="nf">channel_session</span><span class="p">()</span><span class="err">.</span><span class="nf">unwrap</span><span class="p">())</span><span class="w"> </span><span class="p">}</span><span class="o">,</span>
<span class="w">        </span><span class="o">);</span>

<span class="w">        </span><span class="nt">oref</span><span class="p">.</span><span class="nc">shell</span><span class="o">()</span><span class="p">.</span><span class="nc">unwrap</span><span class="o">();</span>
<span class="w">        </span><span class="nt">let</span><span class="w"> </span><span class="nt">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">DeviceSSHConnection</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">tcp</span><span class="p">:</span><span class="w"> </span><span class="n">tcp</span><span class="p">,</span>
<span class="w">            </span><span class="n">channel</span><span class="o">:</span><span class="w"> </span><span class="n">oref</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span><span class="o">;</span>
<span class="w">        </span><span class="nt">ret</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>The result of this code is that we can not use the <code>Session</code> anymore, but it
is stored alongside with the <code>Channel</code> which we will be using. Because the
<code>OwningHandle</code> object dereferences to <code>Box</code>, which dereferences to <code>Channel</code>,
when storing it in a struct, we name it as such. <strong>NOTE:</strong> This is just my
understanding. I have a suspicion this may not be correct, since it appears to
be quite close to discussion of <code>OwningHandle</code> unsafety.</p>
<p>One curious detail here is that the <code>Session</code> logically has a similar
relationship with <code>TcpStream</code> as <code>Channel</code> has to <code>Session</code>, yet its ownership
is not taken and there are no type annotations around doing so. Instead, it is
up to the user to take care of this, as the documentation of handshake method
says:</p>
<blockquote>
<p>This session does not take ownership of the socket provided, it is
recommended to ensure that the socket persists the lifetime of this session
to ensure that communication is correctly performed.</p>
<p>It is also highly recommended that the stream provided is not used
concurrently elsewhere for the duration of this session as it may interfere
with the protocol.</p>
</blockquote>
<p>So with the <code>TcpStream</code> usage, is completely up to the programmer to ensure
the correctness of the code. With the <code>OwningHandle</code>, the attention to where
the "dangerous magic" happens is drawn using the <code>unsafe {}</code> block.</p>
<p>A further and a more high-level discussion of this issue is in this Rust
User's Forum thread - which includes a different example and its solution
using the rental crate, which does not contain unsafe blocks.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/what-represents-a-double-in-sql-server/" class="u-url">What represents a double in sql server?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/what-represents-a-double-in-sql-server/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-04T16:08:50+08:00" itemprop="datePublished" title="2023-03-04 16:08">2023-03-04 16:08</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I have a couple of properties in <code>C#</code> which are <code>double</code> and I want to store
these in a table in SQL Server, but noticed there is no <code>double</code> type, so what
is best to use, <code>decimal</code> or <code>float</code>?</p>
<p>This will store latitude and longitude values, so I need the most accurate
precision.</p>
<p>Thanks for the responses so far.</p>
<p><br><br></p>
<h2>Answer</h2>
<div class="code"><pre class="code literal-block">float
</pre></div>

<p>Or if you want to go old-school:</p>
<div class="code"><pre class="code literal-block">real
</pre></div>

<p>You can also use float(53), but it means the same thing as float.</p>
<p>("real" is equivalent to float(24), not float/float(53).)</p>
<p>The <strong>decimal(x,y)</strong> SQL Server type is for when you want <em>exact</em> decimal
numbers rather than floating point (which can be approximations). This is in
contrast to the C# "decimal" data type, which is more like a 128-bit floating
point number.</p>
<p>MSSQL's <strong>float</strong> type is equivalent to the 64-bit <strong>double</strong> type in .NET.
(My original answer from 2011 said there could be a slight difference in
mantissa, but I've tested this in 2020 and they appear to be 100% compatible
in their binary representation of both very small and very large numbers --
see https://dotnetfiddle.net/wLX5Ox for my test).</p>
<p>To make things more confusing, a "float" in C# is only 32-bit, so it would be
more equivalent in SQL to the real/float(24) type in MSSQL than
float/float(53).</p>
<p><strong>In your specific use case...</strong> All you need is 5 places after the decimal
point to represent latitude and longitude within about one-meter precision,
and you only need up to three digits before the decimal point for the degrees.
Float(24) or decimal(8,5) will best fit your needs in MSSQL, and using float
in C# is good enough, you don't need double. In fact, your users will probably
thank you for rounding to 5 decimal places rather than having a bunch of
insignificant digits coming along for the ride.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Also, here is a good answer for SQL-CLR Type Mapping with a useful chart.</p>
<p>From that post (by David): <img alt="enter image description here" src="images/HKZCS.gif"></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-can-i-return-pivot-table-output-in-mysql/" class="u-url">How can I return pivot table output in MySQL?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-can-i-return-pivot-table-output-in-mysql/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-04T16:07:19+08:00" itemprop="datePublished" title="2023-03-04 16:07">2023-03-04 16:07</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>If I have a MySQL table looking something like this:</p>
<div class="code"><pre class="code literal-block">company_name    action  pagecount
-------------------------------
Company A       PRINT   3
Company A       PRINT   2
Company A       PRINT   3
Company B       EMAIL   
Company B       PRINT   2
Company B       PRINT   2
Company B       PRINT   1
Company A       PRINT   3
</pre></div>

<p>Is it possible to run a MySQL query to get output like this:</p>
<div class="code"><pre class="code literal-block">company_name    EMAIL   PRINT 1 pages   PRINT 2 pages   PRINT 3 pages
-------------------------------------------------------------
CompanyA        0       0               1               3
CompanyB        1       1               2               0
</pre></div>

<p>The idea is that <code>pagecount</code> can vary so the output column amount should
reflect that, one column for each <code>action</code>/<code>pagecount</code> pair and then number of
hits per <code>company_name</code>. I'm not sure if this is called a pivot table but
someone suggested that?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>This basically <em>is</em> a pivot table.</p>
<p>A nice tutorial on how to achieve this can be found here:
http://www.artfulsoftware.com/infotree/qrytip.php?id=78</p>
<p>I advise reading this post and adapt this solution to your needs.</p>
<p><strong><em>Update</em></strong></p>
<p>After the link above is currently not available any longer I feel obliged to
provide some additional information for all of you searching for mysql pivot
answers in here. It really had a vast amount of information, and I won't put
everything from there in here (even more since I just don't want to copy their
vast knowledge), but I'll give some advice on how to deal with pivot tables
the sql way generally with the example from peku who asked the question in the
first place.</p>
<p>Maybe the link comes back soon, I'll keep an eye out for it.</p>
<p><strong>The spreadsheet way...</strong></p>
<p>Many people just use a tool like MSExcel, OpenOffice or other spreadsheet-
tools for this purpose. This is a valid solution, just copy the data over
there and use the tools the GUI offer to solve this.</p>
<p>But... this wasn't the question, and it might even lead to some disadvantages,
like how to get the data into the spreadsheet, problematic scaling and so on.</p>
<p><strong>The SQL way...</strong></p>
<p>Given his table looks something like this:</p>
<div class="code"><pre class="code literal-block"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n n-Quoted">`test_pivot`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n n-Quoted">`pid`</span><span class="w"> </span><span class="kt">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">AUTO_INCREMENT</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`company_name`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`action`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`pagecount`</span><span class="w"> </span><span class="kt">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`pid`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">ENGINE</span><span class="o">=</span><span class="n">MyISAM</span><span class="p">;</span>
</pre></div>

<p>Now look into his/her desired table:</p>
<div class="code"><pre class="code literal-block">company_name    EMAIL   PRINT 1 pages   PRINT 2 pages   PRINT 3 pages
-------------------------------------------------------------
CompanyA        0       0               1               3
CompanyB        1       1               2               0
</pre></div>

<p>The rows (<code>EMAIL</code>, <code>PRINT x pages</code>) resemble conditions. The main grouping is
by <code>company_name</code>.</p>
<p>In order to set up the conditions this rather shouts for using the
<code>CASE</code>-statement. In order to group by something, well, use ... <code>GROUP BY</code>.</p>
<p>The basic SQL providing this pivot can look something like this:</p>
<div class="code"><pre class="code literal-block"><span class="k">SELECT</span><span class="w">  </span><span class="n">P</span><span class="p">.</span><span class="n n-Quoted">`company_name`</span><span class="p">,</span>
<span class="w">    </span><span class="nf">COUNT</span><span class="p">(</span>
<span class="w">        </span><span class="k">CASE</span><span class="w"> </span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n n-Quoted">`action`</span><span class="o">=</span><span class="s1">'EMAIL'</span><span class="w"> </span>
<span class="w">            </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="w">            </span><span class="k">ELSE</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span>
<span class="w">        </span><span class="k">END</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s1">'EMAIL'</span><span class="p">,</span>
<span class="w">    </span><span class="nf">COUNT</span><span class="p">(</span>
<span class="w">        </span><span class="k">CASE</span><span class="w"> </span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n n-Quoted">`action`</span><span class="o">=</span><span class="s1">'PRINT'</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n n-Quoted">`pagecount`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'1'</span><span class="w"> </span>
<span class="w">            </span><span class="k">THEN</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n n-Quoted">`pagecount`</span><span class="w"> </span>
<span class="w">            </span><span class="k">ELSE</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span>
<span class="w">        </span><span class="k">END</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s1">'PRINT 1 pages'</span><span class="p">,</span>
<span class="w">    </span><span class="nf">COUNT</span><span class="p">(</span>
<span class="w">        </span><span class="k">CASE</span><span class="w"> </span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n n-Quoted">`action`</span><span class="o">=</span><span class="s1">'PRINT'</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n n-Quoted">`pagecount`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'2'</span><span class="w"> </span>
<span class="w">            </span><span class="k">THEN</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n n-Quoted">`pagecount`</span><span class="w"> </span>
<span class="w">            </span><span class="k">ELSE</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span>
<span class="w">        </span><span class="k">END</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s1">'PRINT 2 pages'</span><span class="p">,</span>
<span class="w">    </span><span class="nf">COUNT</span><span class="p">(</span>
<span class="w">        </span><span class="k">CASE</span><span class="w"> </span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n n-Quoted">`action`</span><span class="o">=</span><span class="s1">'PRINT'</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n n-Quoted">`pagecount`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'3'</span><span class="w"> </span>
<span class="w">            </span><span class="k">THEN</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n n-Quoted">`pagecount`</span><span class="w"> </span>
<span class="w">            </span><span class="k">ELSE</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span>
<span class="w">        </span><span class="k">END</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s1">'PRINT 3 pages'</span>
<span class="k">FROM</span><span class="w">    </span><span class="n">test_pivot</span><span class="w"> </span><span class="n">P</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">P</span><span class="p">.</span><span class="n n-Quoted">`company_name`</span><span class="p">;</span>
</pre></div>

<p>This should provide the desired result very fast. The major downside for this
approach, the more rows you want in your pivot table, the more conditions you
need to define in your SQL statement.</p>
<p>This can be dealt with, too, therefore people tend to use prepared statements,
routines, counters and such.</p>
<p>Some additional links about this topic:</p>
<ul>
<li>http://anothermysqldba.blogspot.de/2013/06/pivot-tables-example-in-mysql.html</li>
<li>http://www.codeproject.com/Articles/363339/Cross-Tabulation-Pivot-Tables-with-MySQL</li>
<li>http://datacharmer.org/downloads/pivot_tables_mysql_5.pdf</li>
<li>https://codingsight.com/pivot-tables-in-mysql/</li>
</ul>
<p><br></p>
<h3>Suggest</h3>
<p>My solution is in T-SQL without any pivots:</p>
<div class="code"><pre class="code literal-block"><span class="n">SELECT</span>
    <span class="n">CompanyName</span><span class="p">,</span>  
    <span class="n">SUM</span><span class="p">(</span><span class="kr">CASE</span> <span class="n">WHEN</span> <span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s">'EMAIL'</span><span class="p">)</span> <span class="kr">THEN</span> <span class="mi">1</span> <span class="kr">ELSE</span> <span class="mi">0</span> <span class="kr">END</span><span class="p">)</span> <span class="n">AS</span> <span class="n">Email</span><span class="p">,</span>
    <span class="n">SUM</span><span class="p">(</span><span class="kr">CASE</span> <span class="n">WHEN</span> <span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s">'PRINT'</span> <span class="n">AND</span> <span class="n">pagecount</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="kr">THEN</span> <span class="mi">1</span> <span class="kr">ELSE</span> <span class="mi">0</span> <span class="kr">END</span><span class="p">)</span> <span class="n">AS</span> <span class="n">Print1Pages</span><span class="p">,</span>
    <span class="n">SUM</span><span class="p">(</span><span class="kr">CASE</span> <span class="n">WHEN</span> <span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s">'PRINT'</span> <span class="n">AND</span> <span class="n">pagecount</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="kr">THEN</span> <span class="mi">1</span> <span class="kr">ELSE</span> <span class="mi">0</span> <span class="kr">END</span><span class="p">)</span> <span class="n">AS</span> <span class="n">Print2Pages</span><span class="p">,</span>
    <span class="n">SUM</span><span class="p">(</span><span class="kr">CASE</span> <span class="n">WHEN</span> <span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s">'PRINT'</span> <span class="n">AND</span> <span class="n">pagecount</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="kr">THEN</span> <span class="mi">1</span> <span class="kr">ELSE</span> <span class="mi">0</span> <span class="kr">END</span><span class="p">)</span> <span class="n">AS</span> <span class="n">Print3Pages</span>
<span class="n">FROM</span> 
    <span class="n">Company</span>
<span class="n">GROUP</span> <span class="kr">BY</span> 
    <span class="n">CompanyName</span>
</pre></div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2439.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2437.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
