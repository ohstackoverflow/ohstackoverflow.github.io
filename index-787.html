<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 787) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-787.html">
<link rel="prev" href="index-788.html" type="text/html">
<link rel="next" href="index-786.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/xiang-dang-yu-ruby-zhong-de-continue/" class="u-url">相当于 Ruby 中的“continue”</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/xiang-dang-yu-ruby-zhong-de-continue/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T16:07:44+08:00" itemprop="datePublished" title="2023-02-17 16:07">2023-02-17 16:07</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>在 C 和许多其他语言中，有一个<code>continue</code>关键字，当在循环内部使用时，它会跳转到循环的下一次迭代。Ruby 中是否有
this<code>continue</code>关键字的等价物？</p>
<p><br><br></p>
<h2>解答</h2>
<p>是的，它叫做<code>next</code>.</p>
<div class="code"><pre class="code literal-block"><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.</span><span class="o">.</span><span class="mi">5</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span>
<span class="w">     </span><span class="n">next</span>
<span class="w">   </span><span class="n">end</span>
<span class="w">   </span><span class="n">puts</span><span class="w"> </span><span class="s2">"Value of local variable is #{i}"</span>
<span class="n">end</span>
</pre></div>

<p>这将输出以下内容：</p>
<div class="code"><pre class="code literal-block"><span class="n">Value</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="mi">2</span>
<span class="n">Value</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="mi">3</span>
<span class="n">Value</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="mi">4</span>
<span class="n">Value</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="mi">5</span>
<span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mf">0.</span><span class="o">.</span><span class="mi">5</span>
</pre></div>

<p><br></p>
<h3>更多建议</h3>
<p><code>next</code></p>
<p>另外，看看<code>redo</code>哪个重做 <em>当前</em> 迭代。</p>
<p><br><br><a href="posts/equivalent-of-continue-in-ruby/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/pdo-yu-chu-li-yu-ju-shi-fou-zu-yi-fang-zhi-sql-zhu-ru/" class="u-url">PDO 预处理语句是否足以防止 SQL 注入？</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/pdo-yu-chu-li-yu-ju-shi-fou-zu-yi-fang-zhi-sql-zhu-ru/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T16:07:22+08:00" itemprop="datePublished" title="2023-02-17 16:07">2023-02-17 16:07</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>假设我有这样的代码：</p>
<div class="code"><pre class="code literal-block"><span class="err">$</span><span class="n">dbh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">PDO</span><span class="p">(</span><span class="s">"blahblah"</span><span class="p">);</span>

<span class="err">$</span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">dbh</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">'SELECT * FROM users where username = :username'</span><span class="p">);</span>
<span class="err">$</span><span class="n">stmt</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="s">':username'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">$</span><span class="n">_REQUEST</span><span class="p">[</span><span class="s">'username'</span><span class="p">])</span><span class="w"> </span><span class="p">);</span>
</pre></div>

<p>PDO 文档说：</p>
<blockquote>
<p>准备语句的参数不需要引用；司机为您处理。</p>
</blockquote>
<p><strong>这真的是我需要做的所有事情来避免 SQL 注入吗？ 真的那么容易吗？</strong></p>
<p>如果它有所作为，您可以假设使用 MySQL。另外，我真的只是对针对 SQL 注入使用准备好的语句感到好奇。在这种情况下，我不关心 XSS 或其他可能的漏洞。</p>
<p><br><br></p>
<h2>解答</h2>
<p>简短的回答是 <strong>肯定的</strong> ，如果使用得当，PDO 准备就足够安全了。</p>
<hr>
<p>我正在调整这个答案来谈论 PDO ...</p>
<p>长答案并不容易。它基于此处演示的攻击。</p>
<h2>攻击</h2>
<p>那么，让我们从展示攻击开始……</p>
<div class="code"><pre class="code literal-block"><span class="o">$</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span><span class="s1">'SET NAMES gbk'</span><span class="p">);</span>
<span class="o">$</span><span class="k">var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="se">\xbf\x27</span><span class="s2"> OR 1=1 /*"</span><span class="p">;</span>
<span class="o">$</span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SELECT * FROM test WHERE name = ? LIMIT 1'</span><span class="p">;</span>
<span class="o">$</span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="o">$</span><span class="n">query</span><span class="p">);</span>
<span class="o">$</span><span class="n">stmt</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="o">$</span><span class="k">var</span><span class="p">));</span>
</pre></div>

<p>在某些情况下，这将返回多于 1 行。让我们剖析一下这里发生了什么：</p>
<ol>
<li>
<strong>选择字符集</strong><div class="code"><pre class="code literal-block"><span class="err">$</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span><span class="s">'SET NAMES gbk'</span><span class="p">);</span>
</pre></div>

</li>
</ol>
<p>为了使这种攻击起作用，我们需要服务器在连接上期望的编码既要<code>'</code>像 ASCII 中那样进行编码，<code>0x27</code> <em>即，又要</em> 有一些字符，其最终字节是
ASCII，<code>\</code>即<code>0x5c</code>。事实证明，MySQL 5.6 默认支持 5
种这样的编码：<code>big5</code>、<code>cp932</code>、<code>gb2312</code>和。我们就选择这里。<code>gbk``sjis``gbk</code></p>
<p>现在，注意<code>SET NAMES</code>此处的使用非常重要。 <strong>这会在服务器上</strong> 设置字符集。还有另一种方法，但我们很快就会实现。</p>
<ol>
<li><strong>有效载荷</strong></li>
</ol>
<p>我们要用于此注入的有效负载以字节序列开始<code>0xbf27</code>。在 中<code>gbk</code>，这是一个无效的多字节字符；在
中<code>latin1</code>，它是字符串<code>¿'</code>。请注意，在<code>latin1</code> <strong>and</strong> <code>gbk</code>中，<code>0x27</code>它本身是一个文字<code>'</code>字符。</p>
<p>我们选择这个有效负载是因为，如果我们调用<code>addslashes()</code>它，我们会在字符之前插入一个 ASCII <code>\</code>ie
。所以我们最终得到，这是一个两个字符序列：后跟。或者换句话说，一个 <em>有效</em> 字符后跟一个未转义的. 但是我们没有使用.
那么继续下一步......<code>0x5c``'``0xbf5c27``gbk``0xbf5c``0x27</code> __<code>'``addslashes()</code></p>
<ol>
<li><strong>$stmt- &gt;执行()</strong></li>
</ol>
<p>这里要意识到的重要一点是 PDO 默认情况下不会 <strong>执行</strong> 真正的准备好的语句。它模拟它们（对于 MySQL）。因此，PDO
在内部构建查询字符串，<code>mysql_real_escape_string()</code>在每个绑定字符串值上调用（MySQL C API 函数）。</p>
<p>C API
调用的<code>mysql_real_escape_string()</code>不同之处<code>addslashes()</code>在于它知道连接字符集。因此它可以为服务器期望的字符集正确执行转义。然而，到目前为止，客户认为我们仍在使用<code>latin1</code>连接，因为我们从未告诉过它。我们确实告诉
<em>服务器</em> 我们正在使用<code>gbk</code>，但 <em>客户端</em> 仍然认为它是<code>latin1</code>。</p>
<p>因此调用<code>mysql_real_escape_string()</code>插入反斜杠，我们<code>'</code>的“转义”内容中有一个自由悬挂的字符！事实上，如果我们查看字符<code>$var</code>集<code>gbk</code>，我们会看到：</p>
<div class="code"><pre class="code literal-block">    缞' OR 1=1 /*
</pre></div>

<p>这正是攻击所需要的。</p>
<ol>
<li><strong>查询</strong></li>
</ol>
<p>这部分只是一种形式，但这是呈现的查询：</p>
<div class="code"><pre class="code literal-block">    SELECT * FROM test WHERE name = '縗' OR 1=1 /*' LIMIT 1
</pre></div>

<p>恭喜，您刚刚使用 PDO 准备语句成功攻击了一个程序...</p>
<h2>简单的修复</h2>
<p>现在，值得注意的是，您可以通过禁用模拟的准备好的语句来防止这种情况发生：</p>
<div class="code"><pre class="code literal-block"><span class="o">$</span><span class="nt">pdo-</span><span class="o">&gt;</span><span class="nt">setAttribute</span><span class="o">(</span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ATTR_EMULATE_PREPARES</span><span class="o">,</span><span class="w"> </span><span class="nt">false</span><span class="o">);</span>
</pre></div>

<p>这通常会 <em>产生</em> 一个真正的准备好的语句（即数据在一个单独的数据包中从查询中发送）。但是，请注意 PDO 将默默地回退到模拟 MySQL
无法本地准备的语句：手册中列出了它可以准备的语句，但要注意选择适当的服务器版本）。</p>
<h2>正确的修复</h2>
<p>这里的问题是我们使用了<code>SET NAMES</code>而不是 C API's <code>mysql_set_charset()</code>。否则，攻击就不会成功。但最糟糕的是，PDO
直到 5.3.6 才公开 C API <code>mysql_set_charset()</code>，因此在之前的版本中，它 <strong>无法</strong>
针对每个可能的命令阻止这种攻击！它现在公开为DSN 参数，应该使用它 <strong>而不是</strong> <code>SET NAMES</code>...</p>
<p>这是假设我们使用的是 2006 年以来的 MySQL 版本。如果您使用的是较早的 MySQL
版本，那么一个错误意味着<code>mysql_real_escape_string()</code>无效的多字节字符（例如我们有效负载中的那些字符）被视为单字节以用于转义目的，
<em>即使客户端有被正确告知连接编码</em> ，因此这种攻击仍然会成功。该错误已在MySQL 4.1.20、5.0.22和5.1.11中修复。</p>
<h2>拯救恩典</h2>
<p>正如我们一开始所说，要使这种攻击起作用，必须使用易受攻击的字符集对数据库连接进行编码。<code>utf8mb4</code>不 <em>易受攻击</em> ，但可以支持 <em>每个</em>
Unicode 字符：因此您可以选择使用它——但它仅在 MySQL 5.5.3 之后可用。另一种方法是<code>utf8</code>，它也不 <em>容易受到攻击</em> ，可以支持整个
Unicode基本多语言平面。</p>
<p>或者，您可以启用<code>NO_BACKSLASH_ESCAPES</code>SQL 模式，这（除其他外）改变了<code>mysql_real_escape_string()</code>.
启用此模式后，<code>0x27</code>将被替换为<code>0x2727</code>而不是<code>0x5c27</code>，因此转义过程 <em>无法</em>
在之前不存在的任何易受攻击的编码中创建有效字符（即<code>0xbf27</code>仍然存在<code>0xbf27</code>等）——因此服务器仍将拒绝该字符串为无效.
但是，请参阅@eggyal对使用此 SQL 模式（尽管不是 PDO）可能产生的不同漏洞的回答。</p>
<h2>安全示例</h2>
<p>以下示例是安全的：</p>
<div class="code"><pre class="code literal-block"><span class="n">mysql_query</span><span class="p">(</span><span class="s1">'SET NAMES utf8'</span><span class="p">);</span>
<span class="o">$</span><span class="k">var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mysql_real_escape_string</span><span class="p">(</span><span class="s2">"</span><span class="se">\xbf\x27</span><span class="s2"> OR 1=1 /*"</span><span class="p">);</span>
<span class="n">mysql_query</span><span class="p">(</span><span class="s2">"SELECT * FROM test WHERE name = '$var' LIMIT 1"</span><span class="p">);</span>
</pre></div>

<p>因为服务器期望<code>utf8</code>...</p>
<div class="code"><pre class="code literal-block"><span class="n">mysql_set_charset</span><span class="p">(</span><span class="s1">'gbk'</span><span class="p">);</span>
<span class="o">$</span><span class="k">var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mysql_real_escape_string</span><span class="p">(</span><span class="s2">"</span><span class="se">\xbf\x27</span><span class="s2"> OR 1=1 /*"</span><span class="p">);</span>
<span class="n">mysql_query</span><span class="p">(</span><span class="s2">"SELECT * FROM test WHERE name = '$var' LIMIT 1"</span><span class="p">);</span>
</pre></div>

<p>因为我们已经正确设置了字符集，所以客户端和服务器匹配。</p>
<div class="code"><pre class="code literal-block"><span class="o">$</span><span class="nt">pdo-</span><span class="o">&gt;</span><span class="nt">setAttribute</span><span class="o">(</span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ATTR_EMULATE_PREPARES</span><span class="o">,</span><span class="w"> </span><span class="nt">false</span><span class="o">);</span>
<span class="o">$</span><span class="nt">pdo-</span><span class="o">&gt;</span><span class="nt">query</span><span class="o">(</span><span class="s1">'SET NAMES gbk'</span><span class="o">);</span>
<span class="o">$</span><span class="nt">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="nt">pdo-</span><span class="o">&gt;</span><span class="nt">prepare</span><span class="o">(</span><span class="s1">'SELECT * FROM test WHERE name = ? LIMIT 1'</span><span class="o">);</span>
<span class="o">$</span><span class="nt">stmt-</span><span class="o">&gt;</span><span class="nt">execute</span><span class="o">(</span><span class="nt">array</span><span class="o">(</span><span class="s2">"\xbf\x27 OR 1=1 /*"</span><span class="o">));</span>
</pre></div>

<p>Because we've turned off emulated prepared statements.</p>
<div class="code"><pre class="code literal-block"><span class="o">$</span><span class="nt">pdo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">PDO</span><span class="o">(</span><span class="s1">'mysql:host=localhost;dbname=testdb;charset=gbk'</span><span class="o">,</span><span class="w"> </span><span class="o">$</span><span class="nt">user</span><span class="o">,</span><span class="w"> </span><span class="o">$</span><span class="nt">password</span><span class="o">);</span>
<span class="o">$</span><span class="nt">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="nt">pdo-</span><span class="o">&gt;</span><span class="nt">prepare</span><span class="o">(</span><span class="s1">'SELECT * FROM test WHERE name = ? LIMIT 1'</span><span class="o">);</span>
<span class="o">$</span><span class="nt">stmt-</span><span class="o">&gt;</span><span class="nt">execute</span><span class="o">(</span><span class="nt">array</span><span class="o">(</span><span class="s2">"\xbf\x27 OR 1=1 /*"</span><span class="o">));</span>
</pre></div>

<p>Because we've set the character set properly.</p>
<div class="code"><pre class="code literal-block"><span class="err">$</span><span class="n">mysqli</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span><span class="s">'SET NAMES gbk'</span><span class="p">);</span>
<span class="err">$</span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">mysqli</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">'SELECT * FROM test WHERE name = ? LIMIT 1'</span><span class="p">);</span>
<span class="err">$</span><span class="n">param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"\xbf\x27 OR 1=1 /*"</span><span class="p">;</span>
<span class="err">$</span><span class="n">stmt</span><span class="o">-&gt;</span><span class="n">bind_param</span><span class="p">(</span><span class="s">'s'</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">param</span><span class="p">);</span>
<span class="err">$</span><span class="n">stmt</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">();</span>
</pre></div>

<p>Because MySQLi does true prepared statements all the time.</p>
<h2>Wrapping Up</h2>
<p>If you:</p>
<ul>
<li>Use Modern Versions of MySQL (late 5.1, all 5.5, 5.6, etc) <strong>AND</strong> PDO's DSN charset parameter (in PHP ≥ 5.3.6)</li>
</ul>
<p><strong>OR</strong></p>
<ul>
<li>Don't use a vulnerable character set for connection encoding (you only use <code>utf8</code> / <code>latin1</code> / <code>ascii</code> / etc)</li>
</ul>
<p><strong>OR</strong></p>
<ul>
<li>Enable <code>NO_BACKSLASH_ESCAPES</code> SQL mode</li>
</ul>
<p>You're 100% safe.</p>
<p>Otherwise, you're vulnerable <strong>even though you're using PDO Prepared
Statements...</strong></p>
<h2>Addendum</h2>
<p>I've been slowly working on a patch to change the default to not emulate
prepares for a future version of PHP. The problem that I'm running into is
that a LOT of tests break when I do that. One problem is that emulated
prepares will only throw syntax errors on execute, but true prepares will
throw errors on prepare. So that can cause issues (and is part of the reason
tests are borking).</p>
<p><br></p>
<h3>更多建议</h3>
<p>准备好的语句/参数化查询足以防止 SQL 注入，但只有在应用程序中的每个查询始终使用时才有效。</p>
<p>如果您在应用程序的其他任何地方使用未经检查的动态 SQL，它仍然容易受到 <em>二阶</em> 注入的攻击。</p>
<p>二阶注入意味着数据在被包含在查询中之前已经在数据库中循环了一次，并且更难实现。AFAIK，你几乎从未见过真正的二阶攻击，因为攻击者通常更容易通过社会工程学进入，但有时你会因为额外的良性字符或类似字符而出现二阶错误<code>'</code>。</p>
<p>当您可以将一个值存储在数据库中，该值稍后用作查询中的文字时，您就可以完成二阶注入攻击。例如，假设您在网站上创建帐户时输入以下信息作为您的新用户名（假设此问题使用
MySQL DB）：</p>
<div class="code"><pre class="code literal-block">' + (SELECT UserName + '_' + Password FROM Users LIMIT 1) + '
</pre></div>

<p>如果对用户名没有其他限制，准备好的语句仍然会确保在插入时不执行上述嵌入式查询，并将值正确存储在数据库中。但是，假设稍后应用程序从数据库中检索您的用户名，并使用字符串连接将该值包含在新查询中。您可能会看到其他人的密码。由于用户表中的前几个名字往往是管理员，您可能也刚刚放弃了农场。（另请注意：这是不以明文形式存储密码的另一个原因！）</p>
<p>那么，我们看到，如果准备好的语句仅用于单个查询，而忽略所有其他查询，那么这个查询不足以 <strong>防止</strong> 整个应用程序中的 sql
注入攻击，因为它们缺乏强制所有访问的机制应用程序中的数据库使用安全代码。然而，作为良好应用程序设计的一部分——可能包括代码审查或静态分析等实践，或使用
ORM、数据层或限制动态 sql 的服务层——<strong>准备好的语句是解决问题 <em>的</em> 主要 _工具SQL 注入问题。</strong>_
如果您遵循良好的应用程序设计原则，以便将您的数据访问与程序的其余部分分开，则可以很容易地强制执行或审核每个查询是否正确使用参数化。在这种情况下，完全防止了
sql 注入（一阶和二阶）。</p>
<hr>
<p>*事实证明，MySql/PHP（很久很久以前）在涉及宽字符时对处理参数的处理很愚蠢，并且在此处的其他高度投票的答案中概述了一种 <em>罕见的</em> 情况，可以允许注入通过参数化查询</p>
<p><br><br><a href="posts/are-pdo-prepared-statements-sufficient-to-prevent-sql-injection/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/huo-qu-mei-zu-de-qian-1-xing/" class="u-url">获取每组的前 1 行</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/huo-qu-mei-zu-de-qian-1-xing/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T16:06:56+08:00" itemprop="datePublished" title="2023-02-17 16:06">2023-02-17 16:06</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>我有一张表，我想获取每个组的最新条目。这是表格：</p>
<p><code>DocumentStatusLogs</code>桌子</p>
<div class="code"><pre class="code literal-block">|ID| DocumentID | Status | DateCreated |
| 2| 1          | S1     | 7/29/2011   |
| 3| 1          | S2     | 7/30/2011   |
| 6| 1          | S1     | 8/02/2011   |
| 1| 2          | S1     | 7/28/2011   |
| 4| 2          | S2     | 7/30/2011   |
| 5| 2          | S3     | 8/01/2011   |
| 6| 3          | S1     | 8/02/2011   |
</pre></div>

<p>该表将按降序分组<code>DocumentID</code>和排序。<code>DateCreated</code>对于每个<code>DocumentID</code>，我想获得最新状态。</p>
<p>我的首选输出：</p>
<div class="code"><pre class="code literal-block">| DocumentID | Status | DateCreated |
| 1          | S1     | 8/02/2011   |
| 2          | S3     | 8/01/2011   |
| 3          | S1     | 8/02/2011   |
</pre></div>

<ul>
<li>
<p>是否有任何聚合函数可以仅从每个组中获取顶部？请参阅下面的伪代码<code>GetOnlyTheTop</code>：</p>
<div class="code"><pre class="code literal-block">SELECT
</pre></div>

<p>DocumentID,
  GetOnlyTheTop(Status),
  GetOnlyTheTop(DateCreated)
FROM DocumentStatusLogs
GROUP BY DocumentID
ORDER BY DateCreated DESC</p>
</li>
<li>
<p>如果不存在这样的功能，有什么办法可以实现我想要的输出？</p>
</li>
<li>
<p>或者首先，这可能是由未规范化的数据库引起的吗？我在想，既然我要找的只是一行，那它<code>status</code>也应该位于父表中吗？</p>
</li>
</ul>
<p>有关更多信息，请参阅父表：</p>
<p>当前<code>Documents</code>表</p>
<div class="code"><pre class="code literal-block">| DocumentID | Title  | Content  | DateCreated |
| 1          | TitleA | ...      | ...         |
| 2          | TitleB | ...      | ...         |
| 3          | TitleC | ...      | ...         |
</pre></div>

<p>父表是否应该像这样，以便我可以轻松访问其状态？</p>
<div class="code"><pre class="code literal-block">| DocumentID | Title  | Content  | DateCreated | CurrentStatus |
| 1          | TitleA | ...      | ...         | s1            |
| 2          | TitleB | ...      | ...         | s3            |
| 3          | TitleC | ...      | ...         | s1            |
</pre></div>

<p><strong>更新</strong> 我刚刚学会了如何使用“应用”，这使得解决此类问题变得更加容易。</p>
<p><br><br></p>
<h2>解答</h2>
<div class="code"><pre class="code literal-block">;WITH cte AS
(
   SELECT *,
         ROW_NUMBER() OVER (PARTITION BY DocumentID ORDER BY DateCreated DESC) AS rn
   FROM DocumentStatusLogs
)
SELECT *
FROM cte
WHERE rn = 1
</pre></div>

<p>如果您希望每天有 2 个条目，那么这将任意选择一个。要获取一天的两个条目，请改用 DENSE_RANK</p>
<p>至于标准化与否，取决于您是否要：</p>
<ul>
<li>在 2 个地方保持状态</li>
<li>保留状态历史</li>
<li>...</li>
</ul>
<p>就目前而言，您可以保留状态历史记录。如果您也想要父表中的最新状态（这是非规范化），您需要一个触发器来维护父表中的“状态”。或删除此状态历史表。</p>
<p><br></p>
<h3>更多建议</h3>
<p>我刚刚学会了如何使用<code>cross apply</code>. 以下是在这种情况下如何使用它：</p>
<div class="code"><pre class="code literal-block"> select d.DocumentID, ds.Status, ds.DateCreated 
 from Documents as d 
 cross apply 
     (select top 1 Status, DateCreated
      from DocumentStatusLogs 
      where DocumentID = d.DocumentId
      order by DateCreated desc) as ds
</pre></div>

<p><br><br><a href="posts/get-top-1-row-of-each-group/">查看原文</a></p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-788.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-786.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
