<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 787) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-787.html">
<link rel="prev" href="index-788.html" type="text/html">
<link rel="next" href="index-786.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/dynamic-linq-orderby-on-ienumerable-t-iqueryable-t/" class="u-url">Dynamic LINQ OrderBy on IEnumerable&lt;T&gt; / IQueryable&lt;T&gt;</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/dynamic-linq-orderby-on-ienumerable-t-iqueryable-t/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T15:58:51+08:00" itemprop="datePublished" title="2023-02-17 15:58">2023-02-17 15:58</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I found an example in the VS2008 Examples for Dynamic LINQ that allows you to
use a SQL-like string (e.g. <code>OrderBy("Name, Age DESC"))</code> for ordering.
Unfortunately, the method included only works on <code>IQueryable&lt;T&gt;</code>. Is there any
way to get this functionality on <code>IEnumerable&lt;T&gt;</code>?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Just stumbled into this oldie...</p>
<p>To do this without the dynamic LINQ library, you just need the code as below.
This covers most common scenarios including nested properties.</p>
<p>To get it working with <code>IEnumerable&lt;T&gt;</code> you could add some wrapper methods
that go via <code>AsQueryable</code> - but the code below is the core <code>Expression</code> logic
needed.</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">static</span><span class="w"> </span><span class="nv">IOrderedQueryable</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">OrderBy</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="ss">(</span>
<span class="w">    </span><span class="nv">this</span><span class="w"> </span><span class="nv">IQueryable</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">source</span>,<span class="w"> </span>
<span class="w">    </span><span class="nv">string</span><span class="w"> </span><span class="nv">property</span><span class="ss">)</span>
{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">ApplyOrder</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="ss">(</span><span class="nv">source</span>,<span class="w"> </span><span class="nv">property</span>,<span class="w"> </span><span class="s2">"OrderBy"</span><span class="ss">)</span><span class="c1">;</span>
}

<span class="nv">public</span><span class="w"> </span><span class="nv">static</span><span class="w"> </span><span class="nv">IOrderedQueryable</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">OrderByDescending</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="ss">(</span>
<span class="w">    </span><span class="nv">this</span><span class="w"> </span><span class="nv">IQueryable</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">source</span>,<span class="w"> </span>
<span class="w">    </span><span class="nv">string</span><span class="w"> </span><span class="nv">property</span><span class="ss">)</span>
{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">ApplyOrder</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="ss">(</span><span class="nv">source</span>,<span class="w"> </span><span class="nv">property</span>,<span class="w"> </span><span class="s2">"OrderByDescending"</span><span class="ss">)</span><span class="c1">;</span>
}

<span class="nv">public</span><span class="w"> </span><span class="nv">static</span><span class="w"> </span><span class="nv">IOrderedQueryable</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">ThenBy</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="ss">(</span>
<span class="w">    </span><span class="nv">this</span><span class="w"> </span><span class="nv">IOrderedQueryable</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">source</span>,<span class="w"> </span>
<span class="w">    </span><span class="nv">string</span><span class="w"> </span><span class="nv">property</span><span class="ss">)</span>
{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">ApplyOrder</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="ss">(</span><span class="nv">source</span>,<span class="w"> </span><span class="nv">property</span>,<span class="w"> </span><span class="s2">"ThenBy"</span><span class="ss">)</span><span class="c1">;</span>
}

<span class="nv">public</span><span class="w"> </span><span class="nv">static</span><span class="w"> </span><span class="nv">IOrderedQueryable</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">ThenByDescending</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="ss">(</span>
<span class="w">    </span><span class="nv">this</span><span class="w"> </span><span class="nv">IOrderedQueryable</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">source</span>,<span class="w"> </span>
<span class="w">    </span><span class="nv">string</span><span class="w"> </span><span class="nv">property</span><span class="ss">)</span>
{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">ApplyOrder</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="ss">(</span><span class="nv">source</span>,<span class="w"> </span><span class="nv">property</span>,<span class="w"> </span><span class="s2">"ThenByDescending"</span><span class="ss">)</span><span class="c1">;</span>
}

<span class="nv">static</span><span class="w"> </span><span class="nv">IOrderedQueryable</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">ApplyOrder</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="ss">(</span>
<span class="w">    </span><span class="nv">IQueryable</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">source</span>,<span class="w"> </span>
<span class="w">    </span><span class="nv">string</span><span class="w"> </span><span class="nv">property</span>,<span class="w"> </span>
<span class="w">    </span><span class="nv">string</span><span class="w"> </span><span class="nv">methodName</span><span class="ss">)</span><span class="w"> </span>
{
<span class="w">    </span><span class="nv">string</span>[]<span class="w"> </span><span class="nv">props</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">property</span>.<span class="nv">Split</span><span class="ss">(</span><span class="s1">'.'</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">Type</span><span class="w"> </span><span class="nv">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">typeof</span><span class="ss">(</span><span class="nv">T</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">ParameterExpression</span><span class="w"> </span><span class="nv">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Expression</span>.<span class="nv">Parameter</span><span class="ss">(</span><span class="nv">type</span>,<span class="w"> </span><span class="s2">"x"</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">Expression</span><span class="w"> </span><span class="nv">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">arg</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">foreach</span><span class="ss">(</span><span class="nv">string</span><span class="w"> </span><span class="nv">prop</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">props</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nv">use</span><span class="w"> </span><span class="nv">reflection</span><span class="w"> </span><span class="ss">(</span><span class="nv">not</span><span class="w"> </span><span class="nv">ComponentModel</span><span class="ss">)</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">mirror</span><span class="w"> </span><span class="nv">LINQ</span>
<span class="w">        </span><span class="nv">PropertyInfo</span><span class="w"> </span><span class="nv">pi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">type</span>.<span class="nv">GetProperty</span><span class="ss">(</span><span class="nv">prop</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span><span class="nv">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Expression</span>.<span class="nv">Property</span><span class="ss">(</span><span class="nv">expr</span>,<span class="w"> </span><span class="nv">pi</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span><span class="nv">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">pi</span>.<span class="nv">PropertyType</span><span class="c1">;</span>
<span class="w">    </span>}
<span class="w">    </span><span class="nv">Type</span><span class="w"> </span><span class="nv">delegateType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">typeof</span><span class="ss">(</span><span class="nv">Func</span><span class="o">&lt;</span>,<span class="o">&gt;</span><span class="ss">)</span>.<span class="nv">MakeGenericType</span><span class="ss">(</span><span class="nv">typeof</span><span class="ss">(</span><span class="nv">T</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">type</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">LambdaExpression</span><span class="w"> </span><span class="nv">lambda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Expression</span>.<span class="nv">Lambda</span><span class="ss">(</span><span class="nv">delegateType</span>,<span class="w"> </span><span class="nv">expr</span>,<span class="w"> </span><span class="nv">arg</span><span class="ss">)</span><span class="c1">;</span>

<span class="w">    </span><span class="nv">object</span><span class="w"> </span><span class="nb">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">typeof</span><span class="ss">(</span><span class="nv">Queryable</span><span class="ss">)</span>.<span class="nv">GetMethods</span><span class="ss">()</span>.<span class="nv">Single</span><span class="ss">(</span>
<span class="w">            </span><span class="nv">method</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">method</span>.<span class="nv">Name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">methodName</span>
<span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">method</span>.<span class="nv">IsGenericMethodDefinition</span>
<span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">method</span>.<span class="nv">GetGenericArguments</span><span class="ss">()</span>.<span class="nv">Length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">method</span>.<span class="nv">GetParameters</span><span class="ss">()</span>.<span class="nv">Length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="ss">)</span>
<span class="w">            </span>.<span class="nv">MakeGenericMethod</span><span class="ss">(</span><span class="nv">typeof</span><span class="ss">(</span><span class="nv">T</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">type</span><span class="ss">)</span>
<span class="w">            </span>.<span class="nv">Invoke</span><span class="ss">(</span><span class="nv">null</span>,<span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">object</span>[]<span class="w"> </span>{<span class="nv">source</span>,<span class="w"> </span><span class="nv">lambda</span>}<span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ss">(</span><span class="nv">IOrderedQueryable</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="ss">)</span><span class="nb">result</span><span class="c1">;</span>
}
</pre></div>

<hr>
<p>Edit: it gets more fun if you want to mix that with <code>dynamic</code> - although note
that <code>dynamic</code> only applies to LINQ-to-Objects (expression-trees for ORMs etc
can't really represent <code>dynamic</code> queries - <code>MemberExpression</code> doesn't support
it). But here's a way to do it with LINQ-to-Objects. Note that the choice of
<code>Hashtable</code> is due to favorable locking semantics:</p>
<div class="code"><pre class="code literal-block"><span class="k">using</span><span class="w"> </span><span class="n">Microsoft</span><span class="p">.</span><span class="n">CSharp</span><span class="p">.</span><span class="n">RuntimeBinder</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="k">System</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="k">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="k">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Generic</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="k">System</span><span class="p">.</span><span class="k">Dynamic</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="k">System</span><span class="p">.</span><span class="n">Linq</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="k">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">Program</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">AccessorCache</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">Hashtable</span><span class="w"> </span><span class="n">accessors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Hashtable</span><span class="p">();</span>

<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">Hashtable</span><span class="w"> </span><span class="n">callSites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Hashtable</span><span class="p">();</span>

<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">CallSite</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&lt;</span><span class="n">CallSite</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">GetCallSiteLocked</span><span class="p">(</span>
<span class="w">            </span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="err">{</span>
<span class="w">            </span><span class="nf">var</span><span class="w"> </span><span class="n">callSite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">CallSite</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&lt;</span><span class="n">CallSite</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="n">callSites</span><span class="o">[</span><span class="n">name</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">callSite</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<span class="w">            </span><span class="err">{</span>
<span class="w">                </span><span class="n">callSites</span><span class="o">[</span><span class="n">name</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callSite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CallSite</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&lt;</span><span class="n">CallSite</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="o">&gt;&gt;</span>
<span class="w">                    </span><span class="p">.</span><span class="k">Create</span><span class="p">(</span><span class="n">Binder</span><span class="p">.</span><span class="n">GetMember</span><span class="p">(</span>
<span class="w">                                </span><span class="n">CSharpBinderFlags</span><span class="p">.</span><span class="k">None</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                </span><span class="n">name</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                </span><span class="n">typeof</span><span class="p">(</span><span class="n">AccessorCache</span><span class="p">),</span>
<span class="w">                                </span><span class="k">new</span><span class="w"> </span><span class="n">CSharpArgumentInfo</span><span class="err">[]</span><span class="w"> </span><span class="err">{</span><span class="w"> </span>
<span class="w">                                    </span><span class="n">CSharpArgumentInfo</span><span class="p">.</span><span class="k">Create</span><span class="p">(</span>
<span class="w">                                        </span><span class="n">CSharpArgumentInfoFlags</span><span class="p">.</span><span class="k">None</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                        </span><span class="k">null</span><span class="p">)</span><span class="w"> </span>
<span class="w">                                </span><span class="err">}</span><span class="p">));</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">callSite</span><span class="p">;</span>
<span class="w">        </span><span class="err">}</span>

<span class="w">        </span><span class="n">internal</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">Func</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="p">,</span><span class="k">object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetAccessor</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">)</span>
<span class="w">        </span><span class="err">{</span>
<span class="w">            </span><span class="n">Func</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">accessor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Func</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="o">&gt;</span><span class="p">)</span><span class="n">accessors</span><span class="o">[</span><span class="n">name</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">accessor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<span class="w">            </span><span class="err">{</span>
<span class="w">                </span><span class="n">lock</span><span class="w"> </span><span class="p">(</span><span class="n">accessors</span><span class="w"> </span><span class="p">)</span>
<span class="w">                </span><span class="err">{</span>
<span class="w">                    </span><span class="n">accessor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Func</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="o">&gt;</span><span class="p">)</span><span class="n">accessors</span><span class="o">[</span><span class="n">name</span><span class="o">]</span><span class="p">;</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">accessor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<span class="w">                    </span><span class="err">{</span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                            </span><span class="n">string</span><span class="err">[]</span><span class="w"> </span><span class="n">props</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">);</span>
<span class="w">                            </span><span class="n">CallSite</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&lt;</span><span class="n">CallSite</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="o">&gt;&gt;</span><span class="err">[]</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span>
<span class="w">                                </span><span class="o">=</span><span class="w"> </span><span class="k">Array</span><span class="p">.</span><span class="n">ConvertAll</span><span class="p">(</span><span class="n">props</span><span class="p">,</span><span class="w"> </span><span class="n">GetCallSiteLocked</span><span class="p">);</span>
<span class="w">                            </span><span class="n">accessor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">                            </span><span class="err">{</span>
<span class="w">                                </span><span class="k">object</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">object</span><span class="p">)</span><span class="n">target</span><span class="p">;</span>
<span class="w">                                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">arr</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">                                </span><span class="err">{</span>
<span class="w">                                    </span><span class="nf">var</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
<span class="w">                                    </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cs</span><span class="p">.</span><span class="n">Target</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<span class="w">                                </span><span class="err">}</span>
<span class="w">                                </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="w">                            </span><span class="err">}</span><span class="p">;</span>
<span class="w">                        </span><span class="err">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="err">{</span>
<span class="w">                            </span><span class="nf">var</span><span class="w"> </span><span class="n">callSite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetCallSiteLocked</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="w">                            </span><span class="n">accessor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">                            </span><span class="err">{</span>
<span class="w">                                </span><span class="k">return</span><span class="w"> </span><span class="n">callSite</span><span class="p">.</span><span class="n">Target</span><span class="p">(</span><span class="n">callSite</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">object</span><span class="p">)</span><span class="n">target</span><span class="p">);</span>
<span class="w">                            </span><span class="err">}</span><span class="p">;</span>
<span class="w">                        </span><span class="err">}</span>
<span class="w">                        </span><span class="n">accessors</span><span class="o">[</span><span class="n">name</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accessor</span><span class="p">;</span>
<span class="w">                    </span><span class="err">}</span>
<span class="w">                </span><span class="err">}</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">accessor</span><span class="p">;</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">IOrderedEnumerable</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OrderBy</span><span class="p">(</span>
<span class="w">        </span><span class="n">this</span><span class="w"> </span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">string</span><span class="w"> </span><span class="n">property</span><span class="p">)</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Enumerable</span><span class="p">.</span><span class="n">OrderBy</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">source</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">AccessorCache</span><span class="p">.</span><span class="n">GetAccessor</span><span class="p">(</span><span class="n">property</span><span class="p">),</span><span class="w"> </span>
<span class="w">            </span><span class="n">Comparer</span><span class="o">&lt;</span><span class="k">object</span><span class="o">&gt;</span><span class="p">.</span><span class="k">Default</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">IOrderedEnumerable</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OrderByDescending</span><span class="p">(</span>
<span class="w">        </span><span class="n">this</span><span class="w"> </span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">string</span><span class="w"> </span><span class="n">property</span><span class="p">)</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Enumerable</span><span class="p">.</span><span class="n">OrderByDescending</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">source</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">AccessorCache</span><span class="p">.</span><span class="n">GetAccessor</span><span class="p">(</span><span class="n">property</span><span class="p">),</span><span class="w"> </span>
<span class="w">            </span><span class="n">Comparer</span><span class="o">&lt;</span><span class="k">object</span><span class="o">&gt;</span><span class="p">.</span><span class="k">Default</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">IOrderedEnumerable</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ThenBy</span><span class="p">(</span>
<span class="w">        </span><span class="n">this</span><span class="w"> </span><span class="n">IOrderedEnumerable</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">string</span><span class="w"> </span><span class="n">property</span><span class="p">)</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Enumerable</span><span class="p">.</span><span class="n">ThenBy</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">source</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">AccessorCache</span><span class="p">.</span><span class="n">GetAccessor</span><span class="p">(</span><span class="n">property</span><span class="p">),</span><span class="w"> </span>
<span class="w">            </span><span class="n">Comparer</span><span class="o">&lt;</span><span class="k">object</span><span class="o">&gt;</span><span class="p">.</span><span class="k">Default</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">IOrderedEnumerable</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ThenByDescending</span><span class="p">(</span>
<span class="w">        </span><span class="n">this</span><span class="w"> </span><span class="n">IOrderedEnumerable</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">string</span><span class="w"> </span><span class="n">property</span><span class="p">)</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Enumerable</span><span class="p">.</span><span class="n">ThenByDescending</span><span class="o">&lt;</span><span class="k">dynamic</span><span class="p">,</span><span class="w"> </span><span class="k">object</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">source</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">AccessorCache</span><span class="p">.</span><span class="n">GetAccessor</span><span class="p">(</span><span class="n">property</span><span class="p">),</span><span class="w"> </span>
<span class="w">            </span><span class="n">Comparer</span><span class="o">&lt;</span><span class="k">object</span><span class="o">&gt;</span><span class="p">.</span><span class="k">Default</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">Main</span><span class="p">()</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="k">dynamic</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ExpandoObject</span><span class="p">(),</span><span class="w"> </span>
<span class="w">                </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ExpandoObject</span><span class="p">(),</span><span class="w"> </span>
<span class="w">                </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ExpandoObject</span><span class="p">();</span>
<span class="w">        </span><span class="n">a</span><span class="p">.</span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"abc"</span><span class="p">;</span>
<span class="w">        </span><span class="n">b</span><span class="p">.</span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"ghi"</span><span class="p">;</span>
<span class="w">        </span><span class="n">c</span><span class="p">.</span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"def"</span><span class="p">;</span>
<span class="w">        </span><span class="k">dynamic</span><span class="err">[]</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="err">[]</span><span class="w"> </span><span class="err">{</span><span class="w"> </span>
<span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="err">}</span><span class="p">,</span>
<span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="err">}</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="err">}</span><span class="w"> </span>
<span class="w">        </span><span class="err">}</span><span class="p">;</span>

<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">ordered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">OrderByDescending</span><span class="p">(</span><span class="ss">"Y.X"</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
<span class="w">        </span><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="nf">var</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">ordered</span><span class="p">)</span>
<span class="w">        </span><span class="err">{</span>
<span class="w">            </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">Y</span><span class="p">.</span><span class="n">X</span><span class="p">);</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>Too easy without any complication:</p>
<ol>
<li>Add <code>using System.Linq.Dynamic;</code> at the top.</li>
<li>Use <code>vehicles = vehicles.AsQueryable().OrderBy("Make ASC, Year DESC").ToList();</code>
</li>
</ol>
<p><strong>Edit</strong> : to save some time, the <strong>System.Linq.Dynamic.Core</strong>
(System.Linq.Dynamic is deprecated) assembly is not part of the framework, but
can be installed from nuget: System.Linq.Dynamic.Core</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/why-is-my-spring-autowired-field-null/" class="u-url">Why is my Spring @Autowired field null?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/why-is-my-spring-autowired-field-null/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T15:58:19+08:00" itemprop="datePublished" title="2023-02-17 15:58">2023-02-17 15:58</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p><em>Note: This is intended to be a canonical answer for a common problem.</em></p>
<p>I have a Spring <code>@Service</code> class (<code>MileageFeeCalculator</code>) that has an
<code>@Autowired</code> field (<code>rateService</code>), but the field is <code>null</code> when I try to use
it. The logs show that both the <code>MileageFeeCalculator</code> bean and the
<code>MileageRateService</code> bean are being created, but I get a
<code>NullPointerException</code> whenever I try to call the <code>mileageCharge</code> method on my
service bean. Why isn't Spring autowiring the field?</p>
<p>Controller class:</p>
<div class="code"><pre class="code literal-block"><span class="nv">@Controller</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MileageFeeController</span><span class="w"> </span><span class="err">{</span><span class="w">    </span>
<span class="w">    </span><span class="nv">@RequestMapping</span><span class="p">(</span><span class="ss">"/mileage/{miles}"</span><span class="p">)</span>
<span class="w">    </span><span class="nv">@ResponseBody</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="n">mileageFee</span><span class="p">(</span><span class="nv">@PathVariable</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">miles</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">MileageFeeCalculator</span><span class="w"> </span><span class="n">calc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MileageFeeCalculator</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">calc</span><span class="p">.</span><span class="n">mileageCharge</span><span class="p">(</span><span class="n">miles</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>Service class:</p>
<div class="code"><pre class="code literal-block"><span class="nv">@Service</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MileageFeeCalculator</span><span class="w"> </span><span class="err">{</span>

<span class="w">    </span><span class="nv">@Autowired</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">MileageRateService</span><span class="w"> </span><span class="n">rateService</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="o">&lt;---</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">autowired</span><span class="p">,</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="n">mileageCharge</span><span class="p">(</span><span class="n">final</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">miles</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">miles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rateService</span><span class="p">.</span><span class="n">ratePerMile</span><span class="p">());</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="o">&lt;---</span><span class="w"> </span><span class="n">throws</span><span class="w"> </span><span class="n">NPE</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>Service bean that should be autowired in <code>MileageFeeCalculator</code> but it isn't:</p>
<div class="code"><pre class="code literal-block"><span class="nv">@Service</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MileageRateService</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="n">ratePerMile</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mf">0.565</span><span class="n">f</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>When I try to <code>GET /mileage/3</code>, I get this exception:</p>
<div class="code"><pre class="code literal-block"><span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="nl">NullPointerException:</span><span class="w"> </span><span class="n">null</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="n">chrylis</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">spring_autowired_npe</span><span class="p">.</span><span class="n">MileageFeeCalculator</span><span class="p">.</span><span class="n">mileageCharge</span><span class="p">(</span><span class="n">MileageFeeCalculator</span><span class="p">.</span><span class="nl">java:</span><span class="mh">13</span><span class="p">)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="n">chrylis</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">spring_autowired_npe</span><span class="p">.</span><span class="n">MileageFeeController</span><span class="p">.</span><span class="n">mileageFee</span><span class="p">(</span><span class="n">MileageFeeController</span><span class="p">.</span><span class="nl">java:</span><span class="mh">14</span><span class="p">)</span>
<span class="w">    </span><span class="p">...</span>
</pre></div>

<p><br><br></p>
<h2>Answer</h2>
<p>The field annotated <code>@Autowired</code> is <code>null</code> because Spring doesn't know about
the copy of <code>MileageFeeCalculator</code> that you created with <code>new</code> and didn't know
to autowire it.</p>
<p>The Spring Inversion of Control (IoC) container has three main logical
components: a registry (called the <code>ApplicationContext</code>) of components (beans)
that are available to be used by the application, a configurer system that
injects objects' dependencies into them by matching up the dependencies with
beans in the context, and a dependency solver that can look at a configuration
of many different beans and determine how to instantiate and configure them in
the necessary order.</p>
<p>The IoC container isn't magic, and it has no way of knowing about Java objects
unless you somehow inform it of them. When you call <code>new</code>, the JVM
instantiates a copy of the new object and hands it straight to you--it never
goes through the configuration process. There are three ways that you can get
your beans configured.</p>
<p>I have posted all of this code, using Spring Boot to launch, at this GitHub
project; you can look at a full running project for each approach to see
everything you need to make it work. <strong>Tag with the<code>NullPointerException</code>:
<code>nonworking</code></strong></p>
<h3>Inject your beans</h3>
<p>The most preferable option is to let Spring autowire all of your beans; this
requires the least amount of code and is the most maintainable. To make the
autowiring work like you wanted, also autowire the <code>MileageFeeCalculator</code> like
this:</p>
<div class="code"><pre class="code literal-block"><span class="nv">@Controller</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MileageFeeController</span><span class="w"> </span><span class="err">{</span>

<span class="w">    </span><span class="nv">@Autowired</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">MileageFeeCalculator</span><span class="w"> </span><span class="n">calc</span><span class="p">;</span>

<span class="w">    </span><span class="nv">@RequestMapping</span><span class="p">(</span><span class="ss">"/mileage/{miles}"</span><span class="p">)</span>
<span class="w">    </span><span class="nv">@ResponseBody</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="n">mileageFee</span><span class="p">(</span><span class="nv">@PathVariable</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">miles</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">calc</span><span class="p">.</span><span class="n">mileageCharge</span><span class="p">(</span><span class="n">miles</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>If you need to create a new instance of your service object for different
requests, you can still use injection by using the Spring bean scopes.</p>
<p><strong>Tag that works by injecting the<code>@MileageFeeCalculator</code> service object:
<code>working-inject-bean</code></strong></p>
<h3>Use @Configurable</h3>
<p>If you really need objects created with <code>new</code> to be autowired, you can use the
Spring <code>@Configurable</code> annotation along with AspectJ compile-time weaving to
inject your objects. This approach inserts code into your object's constructor
that alerts Spring that it's being created so that Spring can configure the
new instance. This requires a bit of configuration in your build (such as
compiling with <code>ajc</code>) and turning on Spring's runtime configuration handlers
(<code>@EnableSpringConfigured</code> with the JavaConfig syntax). This approach is used
by the Roo Active Record system to allow <code>new</code> instances of your entities to
get the necessary persistence information injected.</p>
<div class="code"><pre class="code literal-block"><span class="nv">@Service</span>
<span class="nv">@Configurable</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MileageFeeCalculator</span><span class="w"> </span><span class="err">{</span>

<span class="w">    </span><span class="nv">@Autowired</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">MileageRateService</span><span class="w"> </span><span class="n">rateService</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="n">mileageCharge</span><span class="p">(</span><span class="n">final</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">miles</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">miles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rateService</span><span class="p">.</span><span class="n">ratePerMile</span><span class="p">());</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p><strong>Tag that works by using<code>@Configurable</code> on the service object: <code>working-
configurable</code></strong></p>
<h3>Manual bean lookup: not recommended</h3>
<p>This approach is suitable only for interfacing with legacy code in special
situations. It is nearly always preferable to create a singleton adapter class
that Spring can autowire and the legacy code can call, but it is possible to
directly ask the Spring application context for a bean.</p>
<p>To do this, you need a class to which Spring can give a reference to the
<code>ApplicationContext</code> object:</p>
<div class="code"><pre class="code literal-block"><span class="nv">@Component</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">ApplicationContextHolder</span><span class="w"> </span><span class="n">implements</span><span class="w"> </span><span class="n">ApplicationContextAware</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>

<span class="w">    </span><span class="nv">@Override</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">setApplicationContext</span><span class="p">(</span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">)</span><span class="w"> </span><span class="n">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">;</span><span class="w">   </span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">getContext</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>Then your legacy code can call <code>getContext()</code> and retrieve the beans it needs:</p>
<div class="code"><pre class="code literal-block"><span class="nv">@Controller</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MileageFeeController</span><span class="w"> </span><span class="err">{</span><span class="w">    </span>
<span class="w">    </span><span class="nv">@RequestMapping</span><span class="p">(</span><span class="ss">"/mileage/{miles}"</span><span class="p">)</span>
<span class="w">    </span><span class="nv">@ResponseBody</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="n">mileageFee</span><span class="p">(</span><span class="nv">@PathVariable</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">miles</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">MileageFeeCalculator</span><span class="w"> </span><span class="n">calc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ApplicationContextHolder</span><span class="p">.</span><span class="n">getContext</span><span class="p">().</span><span class="n">getBean</span><span class="p">(</span><span class="n">MileageFeeCalculator</span><span class="p">.</span><span class="k">class</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">calc</span><span class="p">.</span><span class="n">mileageCharge</span><span class="p">(</span><span class="n">miles</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p><strong>Tag that works by manually looking up the service object in the Spring
context:<code>working-manual-lookup</code></strong></p>
<p><br></p>
<h3>Suggest</h3>
<p>If you are not coding a web application, make sure your class in which
@Autowiring is done is a spring bean. Typically, spring container won't be
aware of the class which we might think of as a spring bean. We have to tell
the Spring container about our spring classes.</p>
<p>This can be achieved by configuring in appln-contxt or <strong>the better way</strong> is
to annotate class as <strong>@Component</strong> and please do not create the annotated
class using new operator. Make sure you get it from Appln-context as below.</p>
<div class="code"><pre class="code literal-block"><span class="nv">@Component</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MyDemo</span><span class="w"> </span><span class="err">{</span>


<span class="w">    </span><span class="nv">@Autowired</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">MyService</span><span class="w">  </span><span class="n">myService</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * @param args</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="err">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">Auto</span><span class="o">-</span><span class="n">generated</span><span class="w"> </span><span class="k">method</span><span class="w"> </span><span class="n">stub</span>
<span class="w">            </span><span class="k">System</span><span class="p">.</span><span class="k">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="ss">"test"</span><span class="p">);</span>
<span class="w">            </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">ctx</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="ss">"spring.xml"</span><span class="p">);</span>
<span class="w">            </span><span class="k">System</span><span class="p">.</span><span class="k">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="ss">"ctx&gt;&gt;"</span><span class="o">+</span><span class="n">ctx</span><span class="p">);</span>

<span class="w">            </span><span class="n">Customer</span><span class="w"> </span><span class="n">c1</span><span class="o">=</span><span class="k">null</span><span class="p">;</span>
<span class="w">            </span><span class="n">MyDemo</span><span class="w"> </span><span class="n">myDemo</span><span class="o">=</span><span class="n">ctx</span><span class="p">.</span><span class="n">getBean</span><span class="p">(</span><span class="n">MyDemo</span><span class="p">.</span><span class="k">class</span><span class="p">);</span>
<span class="w">            </span><span class="k">System</span><span class="p">.</span><span class="k">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">myDemo</span><span class="p">);</span>
<span class="w">            </span><span class="n">myDemo</span><span class="p">.</span><span class="n">callService</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>


<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">callService</span><span class="p">(</span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">Auto</span><span class="o">-</span><span class="n">generated</span><span class="w"> </span><span class="k">method</span><span class="w"> </span><span class="n">stub</span>
<span class="w">        </span><span class="k">System</span><span class="p">.</span><span class="k">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="ss">"---callService---"</span><span class="p">);</span>
<span class="w">        </span><span class="k">System</span><span class="p">.</span><span class="k">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">myService</span><span class="p">);</span>
<span class="w">        </span><span class="n">myService</span><span class="p">.</span><span class="n">callMydao</span><span class="p">();</span>

<span class="w">    </span><span class="err">}</span>

<span class="err">}</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-can-bcrypt-have-built-in-salts/" class="u-url">How can bcrypt have built-in salts?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-can-bcrypt-have-built-in-salts/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T15:57:55+08:00" itemprop="datePublished" title="2023-02-17 15:57">2023-02-17 15:57</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Coda Hale's article "How To Safely Store a Password" claims that:</p>
<blockquote>
<p>bcrypt has salts built-in to prevent rainbow table attacks.</p>
</blockquote>
<p>He cites this paper, which says that in OpenBSD's implementation of <code>bcrypt</code>:</p>
<blockquote>
<p>OpenBSD generates the 128-bit bcrypt salt from an arcfour (arc4random(3))
key stream, seeded with random data the kernel collects from device timings.</p>
</blockquote>
<p>I don't understand how this can work. In my conception of a salt:</p>
<ul>
<li>It needs to be different for each stored password, so that a separate rainbow table would have to be generated for each</li>
<li>It needs to be stored somewhere so that it's repeatable: when a user tries to log in, we take their password attempt, repeat the same salt-and-hash procedure we did when we originally stored their password, and compare</li>
</ul>
<p>When I'm using Devise (a Rails login manager) with bcrypt, there is no salt
column in the database, so I'm confused. If the salt is random and not stored
anywhere, how can we reliably repeat the hashing process?</p>
<p>In short, <strong>how can bcrypt have built-in salts</strong>?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>This is bcrypt:</p>
<p>Generate a random salt. A "cost" factor has been pre-configured. Collect a
password.</p>
<p>Derive an encryption key from the password using the salt and cost factor. Use
it to encrypt a well-known string. <em>Store</em> the cost, <em>salt,</em> and cipher text.
Because these three elements have a known length, it's easy to concatenate
them and store them in a single field, yet be able to split them apart later.</p>
<p>When someone tries to authenticate, retrieve the stored cost and salt. Derive
a key from the input password, cost and salt. Encrypt the same well-known
string. If the generated cipher text matches the stored cipher text, the
password is a match.</p>
<p>Bcrypt operates in a very similar manner to more traditional schemes based on
algorithms like PBKDF2. The main difference is its use of a derived key to
encrypt known plain text; other schemes (reasonably) assume the key derivation
function is irreversible, and store the derived key directly.</p>
<hr>
<p>Stored in the database, a <code>bcrypt</code> "hash" might look something like this:</p>
<blockquote>
<p>$2a$10$vI8aWBnW3fID.ZQ4/zo1G.q1lRps.9cGLcZEiGDMVr5yUP1KUOYTa</p>
</blockquote>
<p>This is actually three fields, delimited by "$":</p>
<ul>
<li>
<code>2a</code> identifies the <code>bcrypt</code> algorithm version that was used.</li>
<li>
<code>10</code> is the cost factor; 210 iterations of the key derivation function are used (which is not enough, by the way. I'd recommend a cost of 12 or more.)</li>
<li>
<code>vI8aWBnW3fID.ZQ4/zo1G.q1lRps.9cGLcZEiGDMVr5yUP1KUOYTa</code> is the salt and the cipher text, concatenated and encoded in a modified Base-64. The first 22 characters decode to a 16-byte value for the salt. The remaining characters are cipher text to be compared for authentication.</li>
</ul>
<p>This example is taken from the documentation for Coda Hale's ruby
implementation.</p>
<p><br></p>
<h3>Suggest</h3>
<p>I believe that phrase should have been worded as follows:</p>
<blockquote>
<p>bcrypt has salts <strong><em>built into the generated hashes</em></strong> to prevent rainbow
table attacks.</p>
</blockquote>
<p>The <code>bcrypt</code> utility itself does not appear to maintain a list of salts.
Rather, salts are generated randomly and appended to the output of the
function so that they are remembered later on (according to the Java
implementation of <code>bcrypt</code>). Put another way, the "hash" generated by <code>bcrypt</code>
is not <strong><em>just</em></strong> the hash. Rather, it is the hash <strong><em>and</em></strong> the salt
concatenated.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-788.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-786.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
