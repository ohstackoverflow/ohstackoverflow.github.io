<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 569) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-569.html">
<link rel="prev" href="index-570.html" type="text/html">
<link rel="next" href="index-568.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/why-are-these-constructs-using-pre-and-post-increment-undefined-behavior/" class="u-url">Why are these constructs using pre and post-increment undefined behavior?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/why-are-these-constructs-using-pre-and-post-increment-undefined-behavior/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T10:11:52+08:00" itemprop="datePublished" title="2023-02-17 10:11">2023-02-17 10:11</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <div class="code"><pre class="code literal-block"><span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="nc">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">   </span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">;</span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="ss">"%d\n"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">3</span>

<span class="w">   </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">   </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">++</span><span class="p">);</span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="ss">"%d\n"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">Should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="vm">?</span>

<span class="w">   </span><span class="n">volatile</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="o">++</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">++</span><span class="n">u</span><span class="p">;</span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="ss">"%d\n"</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">1</span>

<span class="w">   </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">   </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="o">++</span><span class="p">);</span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="ss">"%d\n"</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">Should</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">one</span><span class="p">,</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="vm">?</span>

<span class="w">   </span><span class="n">register</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="o">++</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">++</span><span class="n">v</span><span class="p">;</span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="ss">"%d\n"</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">Should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="vm">?</span><span class="p">)</span>

<span class="w">   </span><span class="nc">int</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="ss">"%d %d\n"</span><span class="p">,</span><span class="w"> </span><span class="o">++</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">shouldn</span><span class="s1">'t this print 1 1</span>

<span class="s1">   int x[2] = { 5, 8 }, y = 0;</span>
<span class="s1">   x[y] = y ++;</span>
<span class="s1">   printf("%d %d\n", x[0], x[1]); // shouldn'</span><span class="n">t</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">print</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">8</span><span class="vm">?</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">0</span><span class="vm">?</span>
<span class="err">}</span>
</pre></div>

<p><br><br></p>
<h2>Answer</h2>
<p>C has the concept of undefined behavior, i.e. some language constructs are
syntactically valid but you can't predict the behavior when the code is run.</p>
<p>As far as I know, the standard doesn't explicitly say <em>why</em> the concept of
undefined behavior exists. In my mind, it's simply because the language
designers wanted there to be some leeway in the semantics, instead of i.e.
requiring that all implementations handle integer overflow in the exact same
way, which would very likely impose serious performance costs, they just left
the behavior undefined so that if you write code that causes integer overflow,
anything can happen.</p>
<p>So, with that in mind, why are these "issues"? The language clearly says that
certain things lead to undefined behavior. There is no problem, there is no
"should" involved. If the undefined behavior changes when one of the involved
variables is declared <code>volatile</code>, that doesn't prove or change anything. It is
<em>undefined</em> ; you cannot reason about the behavior.</p>
<p>Your most interesting-looking example, the one with</p>
<div class="code"><pre class="code literal-block">u = (u++);
</pre></div>

<p>is a text-book example of undefined behavior (see Wikipedia's entry on
sequence points).</p>
<p><br></p>
<h3>Suggest</h3>
<p>Most of the answers here quoted from C standard emphasizing that the behavior
of these constructs are undefined. To understand <strong>why the behavior of these
constructs are undefined</strong> , let's understand these terms first in the light
of C11 standard:</p>
<p><strong>Sequenced:</strong> (5.1.2.3)</p>
<blockquote>
<p>Given any two evaluations <code>A</code> and <code>B</code>, if <code>A</code> is sequenced before <code>B</code>, then
the execution of <code>A</code> shall precede the execution of <code>B</code>.</p>
</blockquote>
<p><strong>Unsequenced:</strong></p>
<blockquote>
<p>If <code>A</code> is not sequenced before or after <code>B</code>, then <code>A</code> and <code>B</code> are
unsequenced.</p>
</blockquote>
<p>Evaluations can be one of two things:</p>
<ul>
<li>
<strong>value computations</strong> , which work out the result of an expression; and</li>
<li>
<strong>side effects</strong> , which are modifications of objects.</li>
</ul>
<p><strong>Sequence Point:</strong></p>
<blockquote>
<p>The presence of a sequence point between the evaluation of expressions <code>A</code>
and <code>B</code> implies that every <em>value computation</em> and <em>side effect</em> associated
with <code>A</code> is sequenced before every <em>value computation</em> and <em>side effect</em>
associated with <code>B</code>.</p>
</blockquote>
<p>Now coming to the question, for the expressions like</p>
<div class="code"><pre class="code literal-block">int i = 1;
i = i++;
</pre></div>

<p>standard says that:</p>
<h4>6.5 Expressions:</h4>
<blockquote>
<p><strong>If a side effect on a scalar object is unsequenced relative to</strong> either
<strong>a different side effect on the same scalar object</strong> or a value computation
using the value of the same scalar object, <strong>the behavior is undefined</strong>.
[...]</p>
</blockquote>
<p>Therefore, the above expression invokes UB because two side effects on the
same object <code>i</code> is unsequenced relative to each other. That means it is not
sequenced whether the side effect by assignment to <code>i</code> will be done before or
after the side effect by <code>++</code>.<br>
Depending on whether assignment occurs before or after the increment,
different results will be produced and that's the one of the case of
<strong>undefined behavior</strong>.</p>
<p>Lets rename the <code>i</code> at left of assignment be <code>il</code> and at the right of
assignment (in the expression <code>i++</code>) be <code>ir</code>, then the expression be like</p>
<div class="code"><pre class="code literal-block"><span class="nv">il</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ir</span><span class="o">++</span><span class="w">     </span><span class="o">//</span><span class="w"> </span><span class="nv">Note</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">suffix</span><span class="w"> </span><span class="nv">l</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">r</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">used</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">sake</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">clarity</span>.
<span class="w">              </span><span class="o">//</span><span class="w"> </span><span class="nv">Both</span><span class="w"> </span><span class="nv">il</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">ir</span><span class="w"> </span><span class="nv">represents</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">same</span><span class="w"> </span><span class="nv">object</span>.
</pre></div>

<p>An important point regarding Postfix <code>++</code> operator is that:</p>
<blockquote>
<p><strong>just because the<code>++</code> comes after the variable does not mean that the
increment happens late</strong>. The increment can happen as early as the compiler
likes <em>as long as the compiler ensures that the original value is used</em>.</p>
</blockquote>
<p>It means the expression <code>il = ir++</code> could be evaluated either as</p>
<div class="code"><pre class="code literal-block"><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ir</span><span class="p">;</span><span class="w">      </span><span class="c1">// i = 1</span>
<span class="n">ir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ir</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span><span class="w">    </span><span class="c1">// i = 2   side effect by ++ before assignment</span>
<span class="n">il</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w">      </span><span class="c1">// i = 1   result is 1</span>
</pre></div>

<p>or</p>
<div class="code"><pre class="code literal-block"><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ir</span><span class="p">;</span><span class="w">      </span><span class="c1">// i = 1</span>
<span class="n">il</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w">      </span><span class="c1">// i = 1   side effect by assignment before ++</span>
<span class="n">ir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ir</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span><span class="w">    </span><span class="c1">// i = 2   result is 2</span>
</pre></div>

<p>resulting in two different results <code>1</code> and <code>2</code> which depends on the sequence
of side effects by assignment and <code>++</code> and hence invokes UB.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/parsing-a-string-to-a-date-in-javascript/" class="u-url">Parsing a string to a date in JavaScript</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/parsing-a-string-to-a-date-in-javascript/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T10:11:15+08:00" itemprop="datePublished" title="2023-02-17 10:11">2023-02-17 10:11</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>How can I convert a string to a Date object in JavaScript?</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"date in some format"</span>
<span class="k">var</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Date</span><span class="p">();</span>

<span class="k">var</span><span class="w"> </span><span class="n">dt_st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">st</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dt</span><span class="o">.</span>
</pre></div>

<p><br><br></p>
<h2>Answer</h2>
<p>The best string format for string parsing is the date ISO format together with
the JavaScript Date object constructor.</p>
<p>Examples of ISO format: <code>YYYY-MM-DD</code> or <code>YYYY-MM-DDTHH:MM:SS</code>.</p>
<p><strong>But wait!</strong> Just using the "ISO format" doesn't work reliably by itself.
String are sometimes parsed as UTC and sometimes as localtime (based on
browser vendor and version). The best practice should always be to store dates
as UTC and make computations as UTC.</p>
<p>To parse a date as UTC, append a <strong>Z</strong> - e.g.: <code>new
Date('2011-04-11T10:20:30Z')</code>.</p>
<p>To display a date in UTC, use <code>.toUTCString()</code>,<br>
to display a date in user's local time, use <code>.toString()</code>.</p>
<p>More info on MDN | Date and this answer.</p>
<p>For old Internet Explorer compatibility (IE versions less than 9 do not
support ISO format in Date constructor), you should split datetime string
representation to it's parts and then you can use constructor using datetime
parts, e.g.: <code>new Date('2011', '04' - 1, '11', '11', '51', '00')</code>. Note that
the number of the month must be 1 less.</p>
<hr>
<p><strong>Alternate method - use an appropriate library:</strong></p>
<p>You can also take advantage of the library Moment.js that allows parsing date
with the specified time zone.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Unfortunately I found out that</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">mydate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Date</span><span class="p">(</span><span class="s1">'2014-04-03'</span><span class="p">);</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">toDateString</span><span class="p">());</span>
</pre></div>

<p>returns "Wed Apr 02 2014". I know it sounds crazy, but it happens for some
users.</p>
<p>The <strong>bulletproof solution</strong> is the following:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">parts</span><span class="w"> </span><span class="o">=</span><span class="s1">'2014-04-03'</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'-'</span><span class="p">);</span>
<span class="o">//</span><span class="w"> </span><span class="n">Please</span><span class="w"> </span><span class="n">pay</span><span class="w"> </span><span class="n">attention</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">month</span><span class="w"> </span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"> </span><span class="n">JavaScript</span><span class="w"> </span><span class="n">counts</span><span class="w"> </span><span class="n">months</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="o">//</span><span class="w"> </span><span class="n">January</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">February</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="o">.</span>
<span class="k">var</span><span class="w"> </span><span class="n">mydate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Date</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"> </span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">toDateString</span><span class="p">());</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/efficiency-of-java-double-brace-initialization/" class="u-url">Efficiency of Java "Double Brace Initialization"?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/efficiency-of-java-double-brace-initialization/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T10:10:41+08:00" itemprop="datePublished" title="2023-02-17 10:10">2023-02-17 10:10</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>In Hidden Features of Java the top answer mentions Double Brace
Initialization, with a <em>very</em> enticing syntax:</p>
<div class="code"><pre class="code literal-block">Set&lt;String&gt; flavors = new HashSet&lt;String&gt;() {{
    add("vanilla");
    add("strawberry");
    add("chocolate");
    add("butter pecan");
}};
</pre></div>

<p>This idiom creates an anonymous inner class with just an instance initializer
in it, which "can use any [...] methods in the containing scope".</p>
<p>Main question: Is this as <strong>inefficient</strong> as it sounds? Should its use be
limited to one-off initializations? (And of course showing off!)</p>
<p>Second question: The new HashSet must be the "this" used in the instance
initializer ... can anyone shed light on the mechanism?</p>
<p>Third question: Is this idiom too <strong>obscure</strong> to use in production code?</p>
<p><strong>Summary:</strong> Very, very nice answers, thanks everyone. On question (3), people
felt the syntax should be clear (though I'd recommend an occasional comment,
especially if your code will pass on to developers who may not be familiar
with it).</p>
<p>On question (1), the generated code should run quickly. The extra .class files
do cause jar file clutter, and slow program startup slightly (thanks to
@coobird for measuring that). @Thilo pointed out that garbage collection can
be affected, and the memory cost for the extra loaded classes may be a factor
in some cases.</p>
<p>Question (2) turned out to be most interesting to me. If I understand the
answers, what's happening in DBI is that the anonymous inner class extends the
class of the object being constructed by the new operator, and hence has a
"this" value referencing the instance being constructed. Very neat.</p>
<p>Overall, DBI strikes me as something of an intellectual curiousity. Coobird
and others point out you can achieve the same effect with Arrays.asList,
varargs methods, Google Collections, and the proposed Java 7 Collection
literals. Newer JVM languages like Scala, JRuby, and Groovy also offer concise
notations for list construction, and interoperate well with Java. Given that
DBI clutters up the classpath, slows down class loading a bit, and makes the
code a tad more obscure, I'd probably shy away from it. However, I plan to
spring this on a friend who's just gotten his SCJP and loves good natured
jousts about Java semantics! ;-) Thanks everyone!</p>
<p>7/2017: Baeldung has a good summary of double brace initialization and
considers it an anti-pattern.</p>
<p>12/2017: @Basil Bourque notes that in the new Java 9 you can say:</p>
<div class="code"><pre class="code literal-block">Set&lt;String&gt; flavors = Set.of("vanilla", "strawberry", "chocolate", "butter pecan");
</pre></div>

<p>That's for sure the way to go. If you're stuck with an earlier version, take a
look at Google Collections' ImmutableSet.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Here's the problem when I get too carried away with anonymous inner classes:</p>
<div class="code"><pre class="code literal-block"><span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">1</span><span class="p">,</span><span class="mf">602</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">1.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">1</span><span class="p">,</span><span class="mf">976</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">10.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">1</span><span class="p">,</span><span class="mf">919</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">11.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">2</span><span class="p">,</span><span class="mf">404</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">12.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">1</span><span class="p">,</span><span class="mf">197</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">13.</span><span class="n">class</span>

<span class="o">/*</span><span class="w"> </span><span class="n">snip</span><span class="w"> </span><span class="o">*/</span>

<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">1</span><span class="p">,</span><span class="mf">953</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">30.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">1</span><span class="p">,</span><span class="mf">910</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">31.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">2</span><span class="p">,</span><span class="mf">007</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">32.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">               </span><span class="mf">926</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">33</span><span class="err">$</span><span class="mf">1</span><span class="err">$</span><span class="mf">1.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">4</span><span class="p">,</span><span class="mf">104</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">33</span><span class="err">$</span><span class="mf">1.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">2</span><span class="p">,</span><span class="mf">849</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">33.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">               </span><span class="mf">926</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">34</span><span class="err">$</span><span class="mf">1</span><span class="err">$</span><span class="mf">1.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">4</span><span class="p">,</span><span class="mf">234</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">34</span><span class="err">$</span><span class="mf">1.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">2</span><span class="p">,</span><span class="mf">849</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">34.</span><span class="n">class</span>

<span class="o">/*</span><span class="w"> </span><span class="n">snip</span><span class="w"> </span><span class="o">*/</span>

<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">               </span><span class="mf">614</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">40.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">2</span><span class="p">,</span><span class="mf">344</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">5.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">1</span><span class="p">,</span><span class="mf">551</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">6.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">1</span><span class="p">,</span><span class="mf">604</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">7.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">1</span><span class="p">,</span><span class="mf">809</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">8.</span><span class="n">class</span>
<span class="mf">2009</span><span class="o">/</span><span class="mf">05</span><span class="o">/</span><span class="mf">27</span><span class="w">  </span><span class="mf">16</span><span class="p">:</span><span class="mf">35</span><span class="w">             </span><span class="mf">2</span><span class="p">,</span><span class="mf">022</span><span class="w"> </span><span class="n">DemoApp2$</span><span class="mf">9.</span><span class="n">class</span>
</pre></div>

<p>These are all classes which were generated when I was making a simple
application, and used copious amounts of anonymous inner classes -- each class
will be compiled into a separate <code>class</code> file.</p>
<p>The "double brace initialization", as already mentioned, is an anonymous inner
class with an instance initialization block, which means that a new class is
created for each "initialization", all for the purpose of usually making a
single object.</p>
<p>Considering that the Java Virtual Machine will need to read all those classes
when using them, that can lead to some time in the bytecode verfication
process and such. Not to mention the increase in the needed disk space in
order to store all those <code>class</code> files.</p>
<p>It seems as if there is a bit of overhead when utilizing double-brace
initialization, so it's probably not such a good idea to go too overboard with
it. But as Eddie has noted in the comments, it's not possible to be absolutely
sure of the impact.</p>
<hr>
<p>Just for reference, double brace initialization is the following:</p>
<div class="code"><pre class="code literal-block">List&lt;String&gt; list = new ArrayList&lt;String&gt;() {{
    add("Hello");
    add("World!");
}};
</pre></div>

<p>It looks like a "hidden" feature of Java, but it is just a rewrite of:</p>
<div class="code"><pre class="code literal-block">List&lt;String&gt; list = new ArrayList&lt;String&gt;() {

    // Instance initialization block
    {
        add("Hello");
        add("World!");
    }
};
</pre></div>

<p>So it's basically a instance initialization block that is part of an anonymous
inner class.</p>
<hr>
<p>Joshua Bloch's Collection Literals proposal for Project Coin was along the
lines of:</p>
<div class="code"><pre class="code literal-block">List&lt;Integer&gt; intList = [1, 2, 3, 4];

Set&lt;String&gt; strSet = {"Apple", "Banana", "Cactus"};

Map&lt;String, Integer&gt; truthMap = { "answer" : 42 };
</pre></div>

<p>Sadly, it didn't make its way into neither Java 7 nor 8 and was shelved
indefinitely.</p>
<hr>
<p><strong>Experiment</strong></p>
<p>Here's the simple experiment I've tested -- make 1000 <code>ArrayList</code>s with the
elements <code>"Hello"</code> and <code>"World!"</code> added to them via the <code>add</code> method, using
the two methods:</p>
<p><em>Method 1: Double Brace Initialization</em></p>
<div class="code"><pre class="code literal-block">List&lt;String&gt; l = new ArrayList&lt;String&gt;() {{
  add("Hello");
  add("World!");
}};
</pre></div>

<p><em>Method 2: Instantiate an<code>ArrayList</code> and <code>add</code></em></p>
<div class="code"><pre class="code literal-block">List&lt;String&gt; l = new ArrayList&lt;String&gt;();
l.add("Hello");
l.add("World!");
</pre></div>

<p>I created a simple program to write out a Java source file to perform 1000
initializations using the two methods:</p>
<p><em>Test 1:</em></p>
<div class="code"><pre class="code literal-block"><span class="k">class</span> <span class="n">Test1</span> {
  <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span>(<span class="n">String</span>[] <span class="nb">s</span>) {
    <span class="nb">long</span> <span class="n">st</span> = <span class="n">System</span>.<span class="n">currentTimeMillis</span>();

    <span class="nb">List</span><span class="s">&lt;String&gt;</span> <span class="n">l0</span> = <span class="nb">new</span> <span class="n">ArrayList</span><span class="s">&lt;String&gt;</span>() {{
      <span class="nb">add</span>(<span class="s">"Hello"</span>);
      <span class="nb">add</span>(<span class="s">"World!"</span>);
    }};

    <span class="nb">List</span><span class="s">&lt;String&gt;</span> <span class="n">l1</span> = <span class="nb">new</span> <span class="n">ArrayList</span><span class="s">&lt;String&gt;</span>() {{
      <span class="nb">add</span>(<span class="s">"Hello"</span>);
      <span class="nb">add</span>(<span class="s">"World!"</span>);
    }};

    /* <span class="n">snip</span> */

    <span class="nb">List</span><span class="s">&lt;String&gt;</span> <span class="n">l999</span> = <span class="nb">new</span> <span class="n">ArrayList</span><span class="s">&lt;String&gt;</span>() {{
      <span class="nb">add</span>(<span class="s">"Hello"</span>);
      <span class="nb">add</span>(<span class="s">"World!"</span>);
    }};

    <span class="n">System</span>.<span class="n">out</span>.<span class="n">println</span>(<span class="n">System</span>.<span class="n">currentTimeMillis</span>() - <span class="n">st</span>);
  }
}
</pre></div>

<p><em>Test 2:</em></p>
<div class="code"><pre class="code literal-block"><span class="k">class</span> <span class="n">Test2</span> {
  <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span>(<span class="n">String</span>[] <span class="nb">s</span>) {
    <span class="nb">long</span> <span class="n">st</span> = <span class="n">System</span>.<span class="n">currentTimeMillis</span>();

    <span class="nb">List</span><span class="s">&lt;String&gt;</span> <span class="n">l0</span> = <span class="nb">new</span> <span class="n">ArrayList</span><span class="s">&lt;String&gt;</span>();
    <span class="n">l0</span>.<span class="nb">add</span>(<span class="s">"Hello"</span>);
    <span class="n">l0</span>.<span class="nb">add</span>(<span class="s">"World!"</span>);

    <span class="nb">List</span><span class="s">&lt;String&gt;</span> <span class="n">l1</span> = <span class="nb">new</span> <span class="n">ArrayList</span><span class="s">&lt;String&gt;</span>();
    <span class="n">l1</span>.<span class="nb">add</span>(<span class="s">"Hello"</span>);
    <span class="n">l1</span>.<span class="nb">add</span>(<span class="s">"World!"</span>);

    /* <span class="n">snip</span> */

    <span class="nb">List</span><span class="s">&lt;String&gt;</span> <span class="n">l999</span> = <span class="nb">new</span> <span class="n">ArrayList</span><span class="s">&lt;String&gt;</span>();
    <span class="n">l999</span>.<span class="nb">add</span>(<span class="s">"Hello"</span>);
    <span class="n">l999</span>.<span class="nb">add</span>(<span class="s">"World!"</span>);

    <span class="n">System</span>.<span class="n">out</span>.<span class="n">println</span>(<span class="n">System</span>.<span class="n">currentTimeMillis</span>() - <span class="n">st</span>);
  }
}
</pre></div>

<p>Please note, that the elapsed time to initialize the 1000 <code>ArrayList</code>s and the
1000 anonymous inner classes extending <code>ArrayList</code> is checked using the
<code>System.currentTimeMillis</code>, so the timer does not have a very high resolution.
On my Windows system, the resolution is around 15-16 milliseconds.</p>
<p>The results for 10 runs of the two tests were the following:</p>
<div class="code"><pre class="code literal-block">Test1 Times (ms)           Test2 Times (ms)
----------------           ----------------
           187                          0
           203                          0
           203                          0
           188                          0
           188                          0
           187                          0
           203                          0
           188                          0
           188                          0
           203                          0
</pre></div>

<p>As can be seen, the double brace initialization has a noticeable execution
time of around 190 ms.</p>
<p>Meanwhile, the <code>ArrayList</code> initialization execution time came out to be 0 ms.
Of course, the timer resolution should be taken into account, but it is likely
to be under 15 ms.</p>
<p>So, there seems to be a noticeable difference in the execution time of the two
methods. It does appear that there is indeed some overhead in the two
initialization methods.</p>
<p>And yes, there were 1000 <code>.class</code> files generated by compiling the <code>Test1</code>
double brace initialization test program.</p>
<p><br></p>
<h3>Suggest</h3>
<p>One property of this approach that has not been pointed out so far is that
because you create inner classes, the whole containing class is captured in
its scope. This means that as long as your Set is alive, it will retain a
pointer to the containing instance (<code>this$0</code>) and keep that from being
garbage-collected, which could be an issue.</p>
<p>This, and the fact that a new class gets created in the first place even
though a regular HashSet would work just fine (or even better), makes me not
want to use this construct (even though I really long for the syntactic
sugar).</p>
<blockquote>
<p>Second question: The new HashSet must be the "this" used in the instance
initializer ... can anyone shed light on the mechanism? I'd have naively
expected "this" to refer to the object initializing "flavors".</p>
</blockquote>
<p>This is just how inner classes work. They get their own <code>this</code>, but they also
have pointers to the parent instance, so that you can call methods on the
containing object as well. In case of a naming conflict, the inner class (in
your case HashSet) takes precedence, but you can prefix "this" with a
classname to get the outer method as well.</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">class</span><span class="w"> </span><span class="nv">Test</span><span class="w"> </span>{

<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">add</span><span class="ss">(</span><span class="nv">Object</span><span class="w"> </span><span class="nv">o</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span>}

<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">Set</span><span class="o">&lt;</span><span class="nv">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">makeSet</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">HashSet</span><span class="o">&lt;</span><span class="nv">String</span><span class="o">&gt;</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">            </span>{
<span class="w">              </span><span class="nv">add</span><span class="ss">(</span><span class="s2">"hello"</span><span class="ss">)</span><span class="c1">; // HashSet</span>
<span class="w">              </span><span class="nv">Test</span>.<span class="nv">this</span>.<span class="nv">add</span><span class="ss">(</span><span class="s2">"hello"</span><span class="ss">)</span><span class="c1">; // outer instance </span>
<span class="w">            </span>}
<span class="w">        </span>}<span class="c1">;</span>
<span class="w">    </span>}
}
</pre></div>

<p>To be clear on the anonymous subclass being created, you could define methods
in there as well. For example override <code>HashSet.add()</code></p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">makeSet</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="err">{</span>
<span class="w">              </span><span class="k">add</span><span class="p">(</span><span class="ss">"hello"</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">HashSet</span><span class="w"> </span><span class="n">anymore</span><span class="w"> </span><span class="p">...</span>
<span class="w">            </span><span class="err">}</span>

<span class="w">            </span><span class="nv">@Override</span>
<span class="w">            </span><span class="k">boolean</span><span class="w"> </span><span class="k">add</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="err">{</span>

<span class="w">            </span><span class="err">}</span>

<span class="w">        </span><span class="err">}</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
</pre></div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-570.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-568.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
