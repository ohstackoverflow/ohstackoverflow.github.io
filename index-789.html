<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 789) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-789.html">
<link rel="prev" href="index-790.html" type="text/html">
<link rel="next" href="index-788.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/the-usestate-set-method-is-not-reflecting-a-change-immediately/" class="u-url">The useState set method is not reflecting a change immediately</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/the-usestate-set-method-is-not-reflecting-a-change-immediately/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T16:02:04+08:00" itemprop="datePublished" title="2023-02-17 16:02">2023-02-17 16:02</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I am trying to learn hooks and the <code>useState</code> method has made me confused. I
am assigning an initial value to a state in the form of an array. The set
method in <code>useState</code> is not working for me, both with and without the spread
syntax.</p>
<p>I have made an API on another PC that I am calling and fetching the data which
I want to set into the state.</p>
<p>Here is my code:</p>
<div class="code"><pre class="code literal-block"><span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">"root"</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">script</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"text/babel"</span> <span class="n">defer</span><span class="o">&gt;</span>
<span class="o">//</span> <span class="kn">import</span> <span class="nn">React</span><span class="o">,</span> <span class="p">{</span> <span class="n">useState</span><span class="p">,</span> <span class="n">useEffect</span> <span class="p">}</span> <span class="kn">from</span> <span class="s2">"react"</span><span class="p">;</span>
<span class="o">//</span> <span class="kn">import</span> <span class="nn">ReactDOM</span> <span class="kn">from</span> <span class="s2">"react-dom"</span><span class="p">;</span>
<span class="n">const</span> <span class="p">{</span> <span class="n">useState</span><span class="p">,</span> <span class="n">useEffect</span> <span class="p">}</span> <span class="o">=</span> <span class="n">React</span><span class="p">;</span> <span class="o">//</span> <span class="n">web</span><span class="o">-</span><span class="n">browser</span> <span class="n">variant</span>

<span class="n">const</span> <span class="n">StateSelector</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="n">const</span> <span class="n">initialValue</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="n">category</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="n">photo</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="n">description</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nb">id</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">name</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="n">rating</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>
  <span class="p">];</span>

  <span class="n">const</span> <span class="p">[</span><span class="n">movies</span><span class="p">,</span> <span class="n">setMovies</span><span class="p">]</span> <span class="o">=</span> <span class="n">useState</span><span class="p">(</span><span class="n">initialValue</span><span class="p">);</span>

  <span class="n">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="p">(</span><span class="k">async</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="o">//</span> <span class="n">const</span> <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fetch</span><span class="p">(</span><span class="s2">"http://192.168.1.164:5000/movies/display"</span><span class="p">);</span>
        <span class="o">//</span> <span class="n">const</span> <span class="n">json</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">();</span>
        <span class="o">//</span> <span class="n">const</span> <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">result</span><span class="p">;</span>
        <span class="n">const</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="n">category</span><span class="p">:</span> <span class="s2">"cat1"</span><span class="p">,</span>
            <span class="n">description</span><span class="p">:</span> <span class="s2">"desc1"</span><span class="p">,</span>
            <span class="nb">id</span><span class="p">:</span> <span class="s2">"1546514491119"</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="s2">"randomname2"</span><span class="p">,</span>
            <span class="n">photo</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
            <span class="n">rating</span><span class="p">:</span> <span class="s2">"3"</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="n">category</span><span class="p">:</span> <span class="s2">"cat2"</span><span class="p">,</span>
            <span class="n">description</span><span class="p">:</span> <span class="s2">"desc1"</span><span class="p">,</span>
            <span class="nb">id</span><span class="p">:</span> <span class="s2">"1546837819818"</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="s2">"randomname1"</span><span class="p">,</span>
            <span class="n">rating</span><span class="p">:</span> <span class="s2">"5"</span>
          <span class="p">}</span>
        <span class="p">];</span>
        <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">"result ="</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
        <span class="n">setMovies</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
        <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">"movies ="</span><span class="p">,</span> <span class="n">movies</span><span class="p">);</span>
      <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">})();</span>
  <span class="p">},</span> <span class="p">[]);</span>

  <span class="k">return</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">hello</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">const</span> <span class="n">rootElement</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s2">"root"</span><span class="p">);</span>
<span class="n">ReactDOM</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">&lt;</span><span class="n">StateSelector</span> <span class="o">/&gt;</span><span class="p">,</span> <span class="n">rootElement</span><span class="p">);</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">"https://unpkg.com/@babel/standalone@7/babel.min.js"</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">"https://unpkg.com/react@17/umd/react.production.min.js"</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">"https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>

<p>Neither <code>setMovies(result)</code> nor <code>setMovies(...result)</code> works.</p>
<p>I expect the <code>result</code> variable to be pushed into the <code>movies</code> array.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Much like <code>.setState()</code> in class components created by extending
<code>React.Component</code> or <code>React.PureComponent</code>, the state update using the updater
provided by <code>useState</code> hook is also asynchronous, and will not be reflected
immediately.</p>
<p><strong>Also, the main issue here is not just the asynchronous nature but the fact
that state values are used by functions based on their current closures, and
state updates will reflect in the next re-render by which the existing
closures are not affected, but new ones are created</strong>. Now in the current
state, the values within hooks are obtained by existing closures, and when a
re-render happens, the closures are updated based on whether the function is
recreated again or not.</p>
<p>Even if you add a <code>setTimeout</code> the function, though the timeout will run after
some time by which the re-render would have happened, the <code>setTimeout</code> will
still use the value from its previous closure and not the updated one.</p>
<div class="code"><pre class="code literal-block">setMovies(result);
console.log(movies) // movies here will not be updated
</pre></div>

<p>If you want to perform an action on state update, you need to use the
<code>useEffect</code> hook, much like using <code>componentDidUpdate</code> in class components
since the setter returned by <code>useState</code> doesn't have a callback pattern</p>
<div class="code"><pre class="code literal-block"><span class="n">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">action</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">movies</span>
<span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">movies</span><span class="o">]</span><span class="p">);</span>
</pre></div>

<p>As far as the syntax to update state is concerned, <code>setMovies(result)</code> will
replace the previous <code>movies</code> value in the state with those available from the
async request.</p>
<p>However, if you want to merge the response with the previously existing
values, you must use the callback syntax of state updation along with the
correct use of spread syntax like</p>
<div class="code"><pre class="code literal-block">setMovies(prevMovies =&gt; ([...prevMovies, ...result]));
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p><em>Additional details to the previous answer:</em></p>
<p>While React's <code>setState</code> <em>is</em> asynchronous (both classes and hooks), and it's
tempting to use that fact to explain the observed behavior, it is not the
<em><strong>reason why</strong></em> it happens.</p>
<p>TLDR: The reason is a closure scope around an immutable <code>const</code> value.</p>
<hr>
<h4><em>Solutions:</em></h4>
<ul>
<li>
<p>read the value in render function (not inside nested functions):</p>
<div class="code"><pre class="code literal-block">  useEffect(() =&gt; { setMovies(result) }, [])
</pre></div>

<p>console.log(movies)</p>
</li>
<li>
<p>add the variable into dependencies (and use the react-hooks/exhaustive-deps eslint rule):</p>
<div class="code"><pre class="code literal-block">  useEffect(() =&gt; { setMovies(result) }, [])
</pre></div>

<p>useEffect(() =&gt; { console.log(movies) }, [movies])</p>
</li>
<li>
<p>use a temporary variable:</p>
<div class="code"><pre class="code literal-block"><span class="w">  </span><span class="n">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="k">const</span><span class="w"> </span><span class="n">newMovies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">newMovies</span><span class="p">)</span>
<span class="n">setMovies</span><span class="p">(</span><span class="n">newMovies</span><span class="p">)</span>
</pre></div>

<p>}, [])</p>
</li>
<li>
<p>use a mutable reference (if we don't need a state and only want to remember the value - updating a ref doesn't trigger re-render):</p>
<div class="code"><pre class="code literal-block"><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">moviesRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">useRef</span><span class="p">(</span><span class="n">initialValue</span><span class="p">)</span>
</pre></div>

<p>useEffect(() =&gt; {
    moviesRef.current = result
    console.log(moviesRef.current)
  }, [])</p>
</li>
</ul>
<hr>
<h4><em>Explanation why it happens:</em></h4>
<p>If async was the only reason, it would be possible to <code>await setState()</code>.</p>
<p>However, both <code>props</code> and <code>state</code> are assumed to be unchanging during 1
render.</p>
<blockquote>
<p>Treat <code>this.state</code> as if it were immutable.</p>
</blockquote>
<p>With hooks, this assumption is enhanced by using <strong>constant values</strong> with the
<code>const</code> keyword:</p>
<div class="code"><pre class="code literal-block"><span class="k">const</span><span class="w"> </span><span class="p">[</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">setState</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">useState</span><span class="p">(</span><span class="s1">'initial'</span><span class="p">)</span>
</pre></div>

<p>The value might be different between 2 renders, but remains a constant inside
the render itself and inside any closures (functions that live longer even
after render is finished, e.g. <code>useEffect</code>, event handlers, inside any Promise
or setTimeout).</p>
<p>Consider following fake, but <strong>synchronous</strong> , React-like implementation:</p>
<div class="code"><pre class="code literal-block">//<span class="w"> </span>sync<span class="w"> </span>implementation:

let<span class="w"> </span>internalState
let<span class="w"> </span>renderAgain

const<span class="w"> </span>setState<span class="w"> </span>=<span class="w"> </span>(updateFn)<span class="w"> </span>=&gt;<span class="w"> </span>{
<span class="w">  </span>internalState<span class="w"> </span>=<span class="w"> </span>updateFn(internalState)
<span class="w">  </span>renderAgain()
}

const<span class="w"> </span>useState<span class="w"> </span>=<span class="w"> </span>(defaultState)<span class="w"> </span>=&gt;<span class="w"> </span>{
<span class="w">  </span>if<span class="w"> </span>(!internalState)<span class="w"> </span>{
<span class="w">    </span>internalState<span class="w"> </span>=<span class="w"> </span>defaultState
<span class="w">  </span>}
<span class="w">  </span>return<span class="w"> </span>[internalState,<span class="w"> </span>setState]
}

const<span class="w"> </span>render<span class="w"> </span>=<span class="w"> </span>(component,<span class="w"> </span>node)<span class="w"> </span>=&gt;<span class="w"> </span>{
<span class="w">  </span>const<span class="w"> </span>{html,<span class="w"> </span>handleClick}<span class="w"> </span>=<span class="w"> </span>component()
<span class="w">  </span>node.innerHTML<span class="w"> </span>=<span class="w"> </span>html
<span class="w">  </span>renderAgain<span class="w"> </span>=<span class="w"> </span>()<span class="w"> </span>=&gt;<span class="w"> </span>render(component,<span class="w"> </span>node)
<span class="w">  </span>return<span class="w"> </span>handleClick
}

//<span class="w"> </span>test:

const<span class="w"> </span>MyComponent<span class="w"> </span>=<span class="w"> </span>()<span class="w"> </span>=&gt;<span class="w"> </span>{
<span class="w">  </span>const<span class="w"> </span>[x,<span class="w"> </span>setX]<span class="w"> </span>=<span class="w"> </span>useState(1)
<span class="w">  </span>console.log('in<span class="w"> </span>render:',<span class="w"> </span>x)<span class="w"> </span>//<span class="w"> </span>✅

<span class="w">  </span>const<span class="w"> </span>handleClick<span class="w"> </span>=<span class="w"> </span>()<span class="w"> </span>=&gt;<span class="w"> </span>{
<span class="w">    </span>setX(current<span class="w"> </span>=&gt;<span class="w"> </span>current<span class="w"> </span>+<span class="w"> </span>1)
<span class="w">    </span>console.log('in<span class="w"> </span>handler/effect/Promise/setTimeout:',<span class="w"> </span>x)<span class="w"> </span>//<span class="w"> </span>❌<span class="w"> </span>NOT<span class="w"> </span>updated
<span class="w">  </span>}

<span class="w">  </span>return<span class="w"> </span>{
<span class="w">    </span>html:<span class="w"> </span>`<span class="nt">&lt;button&gt;</span><span class="cp">${</span><span class="n">x</span><span class="cp">}</span><span class="nt">&lt;/button&gt;</span>`,
<span class="w">    </span>handleClick
<span class="w">  </span>}
}

const<span class="w"> </span>triggerClick<span class="w"> </span>=<span class="w"> </span>render(MyComponent,<span class="w"> </span>document.getElementById('root'))
triggerClick()
triggerClick()
triggerClick()


<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"root"</span><span class="nt">&gt;&lt;/div&gt;</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-to-pretty-format-json-output-in-ruby-on-rails/" class="u-url">How to "pretty" format JSON output in Ruby on Rails</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-to-pretty-format-json-output-in-ruby-on-rails/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T16:01:36+08:00" itemprop="datePublished" title="2023-02-17 16:01">2023-02-17 16:01</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I would like my JSON output in Ruby on Rails to be "pretty" or nicely
formatted.</p>
<p>Right now, I call <code>to_json</code> and my JSON is all on one line. At times this can
be difficult to see if there is a problem in the JSON output stream.</p>
<p>Is there way to configure to make my JSON "pretty" or nicely formatted in
Rails?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Use the <code>pretty_generate()</code> function, built into later versions of JSON. For
example:</p>
<div class="code"><pre class="code literal-block">require 'json'
my_object = { :array =&gt; [1, 2, 3, { :sample =&gt; "hash"} ], :foo =&gt; "bar" }
puts JSON.pretty_generate(my_object)
</pre></div>

<p>Which gets you:</p>
<div class="code"><pre class="code literal-block">{
  "array": [
    1,
    2,
    3,
    {
      "sample": "hash"
    }
  ],
  "foo": "bar"
}
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>The <code>&lt;pre&gt;</code> tag in HTML, used with <code>JSON.pretty_generate</code>, will render the
JSON pretty in your view. I was so happy when my illustrious boss showed me
this:</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;%</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="vi">@data</span><span class="o">.</span><span class="n">present?</span><span class="w"> </span><span class="cp">%&gt;</span>
<span class="w">   </span><span class="nt">&lt;pre&gt;</span><span class="cp">&lt;%=</span><span class="w"> </span><span class="no">JSON</span><span class="o">.</span><span class="n">pretty_generate</span><span class="p">(</span><span class="vi">@data</span><span class="p">)</span><span class="w"> </span><span class="cp">%&gt;</span><span class="nt">&lt;/pre&gt;</span>
<span class="cp">&lt;%</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="cp">%&gt;</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-can-i-remove-the-first-line-of-a-text-file-using-bash-sed-script/" class="u-url">How can I remove the first line of a text file using bash/sed script?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-can-i-remove-the-first-line-of-a-text-file-using-bash-sed-script/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T16:00:50+08:00" itemprop="datePublished" title="2023-02-17 16:00">2023-02-17 16:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I need to repeatedly remove the first line from a huge text file using a bash
script.</p>
<p>Right now I am using <code>sed -i -e "1d" $FILE</code> - but it takes around a minute to
do the deletion.</p>
<p>Is there a more efficient way to accomplish this?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Try tail:</p>
<div class="code"><pre class="code literal-block">tail -n +2 "$FILE"
</pre></div>

<p><code>-n x</code>: Just print the last <code>x</code> lines. <code>tail -n 5</code> would give you the last 5
lines of the input. The <code>+</code> sign kind of inverts the argument and make <code>tail</code>
print anything but the first <code>x-1</code> lines. <code>tail -n +1</code> would print the whole
file, <code>tail -n +2</code> everything but the first line, etc.</p>
<p>GNU <code>tail</code> is much faster than <code>sed</code>. <code>tail</code> is also available on BSD and the
<code>-n +2</code> flag is consistent across both tools. Check the FreeBSD or OS X man
pages for more.</p>
<p>The BSD version can be much slower than <code>sed</code>, though. I wonder how they
managed that; <code>tail</code> should just read a file line by line while <code>sed</code> does
pretty complex operations involving interpreting a script, applying regular
expressions and the like.</p>
<p>Note: You may be tempted to use</p>
<div class="code"><pre class="code literal-block"># THIS WILL GIVE YOU AN EMPTY FILE!
tail -n +2 "$FILE" &gt; "$FILE"
</pre></div>

<p>but this will give you an <strong>empty file</strong>. The reason is that the redirection
(<code>&gt;</code>) happens before <code>tail</code> is invoked by the shell:</p>
<ol>
<li>Shell truncates file <code>$FILE</code>
</li>
<li>Shell creates a new process for <code>tail</code>
</li>
<li>Shell redirects stdout of the <code>tail</code> process to <code>$FILE</code>
</li>
<li>
<code>tail</code> reads from the now empty <code>$FILE</code>
</li>
</ol>
<p>If you want to remove the first line inside the file, you should use:</p>
<div class="code"><pre class="code literal-block">tail -n +2 "$FILE" &gt; "$FILE.tmp" &amp;&amp; mv "$FILE.tmp" "$FILE"
</pre></div>

<p>The <code>&amp;&amp;</code> will make sure that the file doesn't get overwritten when there is a
problem.</p>
<p><br></p>
<h3>Suggest</h3>
<p>You can use -i to update the file without using '&gt;' operator. The following
command will delete the first line from the file and save it to the file (uses
a temp file behind the scenes).</p>
<div class="code"><pre class="code literal-block">sed -i '1d' filename
</pre></div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-790.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-788.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
