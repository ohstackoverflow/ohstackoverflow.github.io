<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 28) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-28.html">
<link rel="prev" href="index-29.html" type="text/html">
<link rel="next" href="index-27.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- Ê®°ÊÄÅÊ°ÜÔºàModalÔºâ --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">√ó
				</button>
				<h4 class="modal-title" id="myModalLabel">
					Êü•ÊâæÁªìÊûú
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				Êü•Êâæ‰∏≠ÔºåËØ∑Á®çÂêé...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					ÂÖ≥Èó≠
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-do-i-copy-to-the-clipboard-in-javascript/" class="u-url">How do I copy to the clipboard in JavaScript?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-do-i-copy-to-the-clipboard-in-javascript/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T19:01:47+08:00" itemprop="datePublished" title="2023-02-16 19:01">2023-02-16 19:01</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p><strong>This question's answers are a community effort</strong>. Edit existing answers to
improve this post. It is not currently accepting new answers or interactions.</p>
<p>How do I copy text to the clipboard (multi-browser)?</p>
<p>Related: <em>How does Trello access the user's clipboard?</em></p>
<p><br><br></p>
<h2>Answer</h2>
<h2>Overview</h2>
<p>There are three primary browser APIs for copying to the clipboard:</p>
<ol>
<li>
<p>Async Clipboard API <code>[navigator.clipboard.writeText]</code></p>
<ul>
<li>Text-focused portion available in Chrome 66 (March 2018)</li>
<li>Access is asynchronous and uses JavaScript Promises, can be written so security user prompts (if displayed) don't interrupt the JavaScript in the page.</li>
<li>Text can be copied to the clipboard directly from a variable.</li>
<li>Only supported on pages served over HTTPS.</li>
<li>In Chrome 66 pages inactive tabs can write to the clipboard without a permissions prompt.</li>
<li>
<p><code>document.execCommand('copy')</code> ( _ <strong>deprecated</strong>_ ) üëé</p>
</li>
<li>
<p>Most browsers support this as of ~April 2015 (see Browser Support below).</p>
</li>
<li>Access is synchronous, i.e. stops JavaScript in the page until complete including displaying and user interacting with any security prompts.</li>
<li>Text is read from the DOM and placed on the clipboard.</li>
<li>During testing ~April 2015 only Internet Explorer was noted as displaying permissions prompts whilst writing to the clipboard.</li>
<li>
<p>Overriding the copy event</p>
</li>
<li>
<p>See Clipboard API documentation on Overriding the copy event.</p>
</li>
<li>Allows you to modify what appears on the clipboard from any copy event, can include other formats of data other than plain text.</li>
<li>Not covered here as it doesn't directly answer the question.</li>
</ul>
</li>
</ol>
<h2>General development notes</h2>
<p>Don't expect clipboard related commands to work whilst you are testing code in
the console. Generally, the page is required to be active (Async Clipboard
API) or requires user interaction (e.g. a user click) to allow
(<code>document.execCommand('copy')</code>) to access the clipboard see below for more
detail.</p>
<h3>
<strong>IMPORTANT</strong> (noted here 2020/02/20)</h3>
<p>Note that since this post was originally written deprecation of permissions in
cross-origin IFRAMEs and other IFRAME "sandboxing" prevents the embedded demos
"Run code snippet" buttons and "codepen.io example" from working in some
browsers (including Chrome and Microsoft Edge).</p>
<p>To develop create your own web page, serve that page over an HTTPS connection
to test and develop against.</p>
<p>Here is a test/demo page which demonstrates the code working:
https://deanmarktaylor.github.io/clipboard-test/</p>
<h2>Async + Fallback</h2>
<p>Due to the level of browser support for the new Async Clipboard API, you will
likely want to fall back to the <code>document.execCommand('copy')</code> method to get
good browser coverage.</p>
<p>Here is a simple example (may not work embedded in this site, read "important"
note above):</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">fallbackCopyTextToClipboard</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">var</span><span class="w"> </span><span class="n">textArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s2">"textarea"</span><span class="p">);</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">text</span><span class="p">;</span>

<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Avoid</span><span class="w"> </span><span class="n">scrolling</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">bottom</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0"</span><span class="p">;</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0"</span><span class="p">;</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"fixed"</span><span class="p">;</span>

<span class="w">  </span><span class="n">document</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">textArea</span><span class="p">);</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">focus</span><span class="p">();</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">select</span><span class="p">();</span>

<span class="w">  </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">successful</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">execCommand</span><span class="p">(</span><span class="s1">'copy'</span><span class="p">);</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">successful</span><span class="w"> </span><span class="err">?</span><span class="w"> </span><span class="s1">'successful'</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s1">'unsuccessful'</span><span class="p">;</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">'Fallback: Copying text command was '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">'Fallback: Oops, unable to copy'</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">document</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">removeChild</span><span class="p">(</span><span class="n">textArea</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">function</span><span class="w"> </span><span class="n">copyTextToClipboard</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">navigator</span><span class="o">.</span><span class="n">clipboard</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">fallbackCopyTextToClipboard</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">navigator</span><span class="o">.</span><span class="n">clipboard</span><span class="o">.</span><span class="n">writeText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">'Async: Copying to clipboard was successful!'</span><span class="p">);</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">'Async: Could not copy text: '</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="k">var</span><span class="w"> </span><span class="n">copyBobBtn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">'.js-copy-bob-btn'</span><span class="p">),</span>
<span class="w">  </span><span class="n">copyJaneBtn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">'.js-copy-jane-btn'</span><span class="p">);</span>

<span class="n">copyBobBtn</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">copyTextToClipboard</span><span class="p">(</span><span class="s1">'Bob'</span><span class="p">);</span>
<span class="p">});</span>


<span class="n">copyJaneBtn</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">copyTextToClipboard</span><span class="p">(</span><span class="s1">'Jane'</span><span class="p">);</span>
<span class="p">});</span>


<span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">style</span><span class="o">=</span><span class="s2">"display:inline-block; vertical-align:top;"</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">button</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">"js-copy-bob-btn"</span><span class="o">&gt;</span><span class="n">Set</span><span class="w"> </span><span class="n">clipboard</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">BOB</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;&lt;</span><span class="n">br</span><span class="w"> </span><span class="o">/&gt;&lt;</span><span class="n">br</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">button</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">"js-copy-jane-btn"</span><span class="o">&gt;</span><span class="n">Set</span><span class="w"> </span><span class="n">clipboard</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">JANE</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">style</span><span class="o">=</span><span class="s2">"display:inline-block;"</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">textarea</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">"js-test-textarea"</span><span class="w"> </span><span class="n">cols</span><span class="o">=</span><span class="s2">"35"</span><span class="w"> </span><span class="n">rows</span><span class="o">=</span><span class="s2">"4"</span><span class="o">&gt;</span><span class="n">Try</span><span class="w"> </span><span class="n">pasting</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">clipboard</span><span class="p">:</span>

<span class="w">  </span><span class="o">&lt;/</span><span class="n">textarea</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>

<p>(codepen.io example may not work, read "important" note above) Note that this
snippet is not working well in Stack Overflow's embedded preview you can try
it here: https://codepen.io/DeanMarkTaylor/pen/RMRaJX?editors=1011</p>
<h2>Async Clipboard API</h2>
<ul>
<li>MDN Reference</li>
<li>Chrome 66 announcement post (March 2018)</li>
<li>Reference Async Clipboard API draft documentation</li>
</ul>
<p>Note that there is an ability to "request permission" and test for access to
the clipboard via the permissions API in Chrome 66.</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Example text to appear on clipboard"</span><span class="p">;</span>
<span class="n">navigator</span><span class="o">.</span><span class="n">clipboard</span><span class="o">.</span><span class="n">writeText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">'Async: Copying to clipboard was successful!'</span><span class="p">);</span>
<span class="p">},</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">'Async: Could not copy text: '</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<h2>document.execCommand('copy')</h2>
<p>The rest of this post goes into the nuances and detail of the
<code>document.execCommand('copy')</code> API.</p>
<h3>Browser Support</h3>
<p><del>The JavaScript<code>document.execCommand('copy')</code> support has grown, see the
links below for browser updates:</del> ( _ <strong>deprecated</strong>_ ) üëé</p>
<ul>
<li>Internet Explorer 10+ (although this document indicates some support was there from Internet Explorer 5.5+).</li>
<li>Google Chrome 43+ (~April 2015)</li>
<li>Mozilla Firefox 41+ (shipping ~September 2015)</li>
<li>Opera 29+ (based on Chromium 42, ~April 2015)</li>
</ul>
<h3>Simple Example</h3>
<p>(may not work embedded in this site, read "important" note above)</p>
<div class="code"><pre class="code literal-block">var<span class="w"> </span>copyTextareaBtn<span class="w"> </span>=<span class="w"> </span>document.querySelector('.js-textareacopybtn');

copyTextareaBtn.addEventListener('click',<span class="w"> </span>function(event)<span class="w"> </span>{
<span class="w">  </span>var<span class="w"> </span>copyTextarea<span class="w"> </span>=<span class="w"> </span>document.querySelector('.js-copytextarea');
<span class="w">  </span>copyTextarea.focus();
<span class="w">  </span>copyTextarea.select();

<span class="w">  </span>try<span class="w"> </span>{
<span class="w">    </span>var<span class="w"> </span>successful<span class="w"> </span>=<span class="w"> </span>document.execCommand('copy');
<span class="w">    </span>var<span class="w"> </span>msg<span class="w"> </span>=<span class="w"> </span>successful<span class="w"> </span>?<span class="w"> </span>'successful'<span class="w"> </span>:<span class="w"> </span>'unsuccessful';
<span class="w">    </span>console.log('Copying<span class="w"> </span>text<span class="w"> </span>command<span class="w"> </span>was<span class="w"> </span>'<span class="w"> </span>+<span class="w"> </span>msg);
<span class="w">  </span>}<span class="w"> </span>catch<span class="w"> </span>(err)<span class="w"> </span>{
<span class="w">    </span>console.log('Oops,<span class="w"> </span>unable<span class="w"> </span>to<span class="w"> </span>copy');
<span class="w">  </span>}
});


<span class="nt">&lt;p&gt;</span>
<span class="w">  </span><span class="nt">&lt;button</span><span class="w"> </span><span class="na">class=</span><span class="s">"js-textareacopybtn"</span><span class="w"> </span><span class="na">style=</span><span class="s">"vertical-align:top;"</span><span class="nt">&gt;</span>Copy<span class="w"> </span>Textarea<span class="nt">&lt;/button&gt;</span>
<span class="w">  </span><span class="nt">&lt;textarea</span><span class="w"> </span><span class="na">class=</span><span class="s">"js-copytextarea"</span><span class="nt">&gt;</span>Hello<span class="w"> </span>I'm<span class="w"> </span>some<span class="w"> </span>text<span class="nt">&lt;/textarea&gt;</span>
<span class="nt">&lt;/p&gt;</span>
</pre></div>

<h3>Complex Example: Copy to clipboard without displaying input</h3>
<p>The above simple example works great if there is a <code>textarea</code> or <code>input</code>
element visible on the screen.</p>
<p>In some cases, you might wish to copy text to the clipboard without displaying
an <code>input</code> / <code>textarea</code> element. This is one example of a way to work around
this (basically insert an element, copy to clipboard, remove element):</p>
<p>Tested with Google Chrome 44, Firefox 42.0a1, and Internet Explorer
11.0.8600.17814.</p>
<p>(may not work embedded in this site, read "important" note above)</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">copyTextToClipboard</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">var</span><span class="w"> </span><span class="n">textArea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s2">"textarea"</span><span class="p">);</span>

<span class="w">  </span><span class="o">//</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="o">***</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">styling</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">likely</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">required</span><span class="o">.</span><span class="w"> </span><span class="o">***</span>
<span class="w">  </span><span class="o">//</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Why</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">here</span><span class="err">?</span><span class="w"> </span><span class="n">To</span><span class="w"> </span><span class="n">ensure</span><span class="p">:</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">able</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">focus</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">selection</span><span class="o">.</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">flash</span><span class="w"> </span><span class="n">render</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">minimal</span><span class="w"> </span><span class="n">visual</span><span class="w"> </span><span class="n">impact</span><span class="o">.</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="mf">3.</span><span class="w"> </span><span class="n">less</span><span class="w"> </span><span class="n">flakyness</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">selection</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">copying</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="o">**</span><span class="n">might</span><span class="o">**</span><span class="w"> </span><span class="n">occur</span><span class="w"> </span><span class="k">if</span>
<span class="w">  </span><span class="o">//</span><span class="w">    </span><span class="n">the</span><span class="w"> </span><span class="n">textarea</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">visible</span><span class="o">.</span>
<span class="w">  </span><span class="o">//</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">likelihood</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="n">won</span><span class="s1">'t even render, not even a</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">flash</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">these</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">precautions</span><span class="o">.</span><span class="w"> </span><span class="n">However</span><span class="w"> </span><span class="ow">in</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Internet</span><span class="w"> </span><span class="n">Explorer</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">visible</span><span class="w"> </span><span class="n">whilst</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">popup</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">asking</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">permission</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">web</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">to</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">copy</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">clipboard</span><span class="o">.</span>
<span class="w">  </span><span class="o">//</span>

<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Place</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">top</span><span class="o">-</span><span class="n">left</span><span class="w"> </span><span class="n">corner</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">screen</span><span class="w"> </span><span class="n">regardless</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">scroll</span><span class="w"> </span><span class="n">position</span><span class="o">.</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'fixed'</span><span class="p">;</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Ensure</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">small</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">height</span><span class="o">.</span><span class="w"> </span><span class="n">Setting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">1</span><span class="n">px</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1</span><span class="n">em</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">doesn</span><span class="s1">'t work as this gives a negative w/h on some browsers.</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'2em'</span><span class="p">;</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'2em'</span><span class="p">;</span>

<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">don</span><span class="s1">'t need padding, reducing the size if it does flash render.</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">padding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Clean</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">borders</span><span class="o">.</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'none'</span><span class="p">;</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">outline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'none'</span><span class="p">;</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">boxShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'none'</span><span class="p">;</span>

<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Avoid</span><span class="w"> </span><span class="n">flash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">white</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">rendered</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">reason</span><span class="o">.</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'transparent'</span><span class="p">;</span>


<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">text</span><span class="p">;</span>

<span class="w">  </span><span class="n">document</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">textArea</span><span class="p">);</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">focus</span><span class="p">();</span>
<span class="w">  </span><span class="n">textArea</span><span class="o">.</span><span class="n">select</span><span class="p">();</span>

<span class="w">  </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">successful</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">execCommand</span><span class="p">(</span><span class="s1">'copy'</span><span class="p">);</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">successful</span><span class="w"> </span><span class="err">?</span><span class="w"> </span><span class="s1">'successful'</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s1">'unsuccessful'</span><span class="p">;</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">'Copying text command was '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">'Oops, unable to copy'</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">document</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">removeChild</span><span class="p">(</span><span class="n">textArea</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">var</span><span class="w"> </span><span class="n">copyBobBtn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">'.js-copy-bob-btn'</span><span class="p">),</span>
<span class="w">  </span><span class="n">copyJaneBtn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">'.js-copy-jane-btn'</span><span class="p">);</span>

<span class="n">copyBobBtn</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">copyTextToClipboard</span><span class="p">(</span><span class="s1">'Bob'</span><span class="p">);</span>
<span class="p">});</span>


<span class="n">copyJaneBtn</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">copyTextToClipboard</span><span class="p">(</span><span class="s1">'Jane'</span><span class="p">);</span>
<span class="p">});</span>


<span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">style</span><span class="o">=</span><span class="s2">"display:inline-block; vertical-align:top;"</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">button</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">"js-copy-bob-btn"</span><span class="o">&gt;</span><span class="n">Set</span><span class="w"> </span><span class="n">clipboard</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">BOB</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;&lt;</span><span class="n">br</span><span class="w"> </span><span class="o">/&gt;&lt;</span><span class="n">br</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">button</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">"js-copy-jane-btn"</span><span class="o">&gt;</span><span class="n">Set</span><span class="w"> </span><span class="n">clipboard</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">JANE</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">style</span><span class="o">=</span><span class="s2">"display:inline-block;"</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">textarea</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">"js-test-textarea"</span><span class="w"> </span><span class="n">cols</span><span class="o">=</span><span class="s2">"35"</span><span class="w"> </span><span class="n">rows</span><span class="o">=</span><span class="s2">"4"</span><span class="o">&gt;</span><span class="n">Try</span><span class="w"> </span><span class="n">pasting</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">clipboard</span><span class="p">:</span>

<span class="w">  </span><span class="o">&lt;/</span><span class="n">textarea</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>

<h3>Additional notes</h3>
<h4>Only works if the user takes an action</h4>
<p>All <code>document.execCommand('copy')</code> calls must take place as a direct result of
a user action, e.g. click event handler. This is a measure to prevent messing
with the user's clipboard when they don't expect it.</p>
<p>See the Google Developers post here for more info.</p>
<h4>Clipboard API</h4>
<p>Note the full Clipboard API draft specification can be found here:
https://w3c.github.io/clipboard-apis/</p>
<h4>Is it supported?</h4>
<ul>
<li>
<code>document.queryCommandSupported('copy')</code> should return <code>true</code> if the command "is supported by the browser".</li>
<li>and <code>document.queryCommandEnabled('copy')</code> return <code>true</code> if the <code>document.execCommand('copy')</code> will succeed if called now. Checking to ensure the command was called from a user-initiated thread and other requirements are met.</li>
</ul>
<p>However, as an example of browser compatibility issues, Google Chrome from
~April to ~October 2015 only returned <code>true</code> from
<code>document.queryCommandSupported('copy')</code> if the command was called from a
user-initiated thread.</p>
<p>Note compatibility detail below.</p>
<h4>Browser Compatibility Detail</h4>
<p>Whilst a simple call to <code>document.execCommand('copy')</code> wrapped in a
<code>try</code>/<code>catch</code> block called as a result of a user click will get you the most
compatibility use the following has some provisos:</p>
<p>Any call to <code>document.execCommand</code>, <code>document.queryCommandSupported</code> or
<code>document.queryCommandEnabled</code> should be wrapped in a <code>try</code>/<code>catch</code> block.</p>
<p>Different browser implementations and browser versions throw differing types
of exceptions when called instead of returning <code>false</code>.</p>
<p>Different browser implementations are still in flux and the Clipboard API is
still in draft, so remember to do your testing.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Automatic copying to the clipboard may be dangerous, and therefore most
browsers (except Internet Explorer) make it very difficult. Personally, I use
the following simple trick:</p>
<div class="code"><pre class="code literal-block"><span class="nt">function</span><span class="w"> </span><span class="nt">copyToClipboard</span><span class="o">(</span><span class="nt">text</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="err">window.prompt("Copy</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="n">clipboard</span><span class="p">:</span><span class="w"> </span><span class="n">Ctrl</span><span class="o">+</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">Enter</span><span class="err">"</span><span class="p">,</span><span class="w"> </span><span class="kc">text</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>The user is presented with the prompt box, where the text to be copied is
already selected. Now it's enough to press <code>Ctrl</code>+<code>C</code> and <code>Enter</code> (to close
the box) -- and voila!</p>
<p>Now the clipboard copy operation is <em>safe</em> , because the user does it manually
(but in a pretty straightforward way). Of course, it works in all browsers.</p>
<div class="code"><pre class="code literal-block"><span class="nt">&lt;button</span><span class="w"> </span><span class="na">id=</span><span class="s">"demo"</span><span class="w"> </span><span class="na">onclick=</span><span class="s">"copyToClipboard(document.getElementById('demo').innerHTML)"</span><span class="nt">&gt;</span>This<span class="w"> </span>is<span class="w"> </span>what<span class="w"> </span>I<span class="w"> </span>want<span class="w"> </span>to<span class="w"> </span>copy<span class="nt">&lt;/button&gt;</span>

<span class="nt">&lt;script&gt;</span>
<span class="w">  </span>function<span class="w"> </span>copyToClipboard(text)<span class="w"> </span>{
<span class="w">    </span>window.prompt("Copy<span class="w"> </span>to<span class="w"> </span>clipboard:<span class="w"> </span>Ctrl+C,<span class="w"> </span>Enter",<span class="w"> </span>text);
<span class="w">  </span>}
<span class="nt">&lt;/script&gt;</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/avoiding-nullpointerexception-in-java/" class="u-url">Avoiding NullPointerException in Java</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/avoiding-nullpointerexception-in-java/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T19:01:15+08:00" itemprop="datePublished" title="2023-02-16 19:01">2023-02-16 19:01</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I use <code>x != null</code> to avoid <code>NullPointerException</code>. Is there an alternative?</p>
<div class="code"><pre class="code literal-block"><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">x</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="o">//</span><span class="w"> </span>...
}
</pre></div>

<p><br><br></p>
<h2>Answer</h2>
<p>This to me sounds like a reasonably common problem that junior to intermediate
developers tend to face at some point: they either don't know or don't trust
the contracts they are participating in and defensively overcheck for nulls.
Additionally, when writing their own code, they tend to rely on returning
nulls to indicate something thus requiring the caller to check for nulls.</p>
<p>To put this another way, there are two instances where null checking comes up:</p>
<ol>
<li>
<p>Where null is a valid response in terms of the contract; and</p>
</li>
<li>
<p>Where it isn't a valid response.</p>
</li>
</ol>
<p>(2) is easy. As of Java 1.7 you can use <code>Objects.requireNonNull(foo)</code>. (If you
are stuck with a previous version then <code>assert</code>ions may be a good
alternative.)</p>
<p>"Proper" usage of this method would be like below. The method returns the
object passed into it and throws a <code>NullPointerException</code> if the object is
null. This means that the returned value is always non-null. The method is
primarily intended for validating parameters.</p>
<div class="code"><pre class="code literal-block">public Foo(Bar bar) {
    this.bar = Objects.requireNonNull(bar);
}
</pre></div>

<p>It can also be used like an <code>assert</code>ion though since it throws an exception if
the object is null. In both uses, a message can be added which will be shown
in the exception. Below is using it like an assertion and providing a message.</p>
<div class="code"><pre class="code literal-block"><span class="nv">Objects</span>.<span class="nv">requireNonNull</span><span class="ss">(</span><span class="nv">someobject</span>,<span class="w"> </span><span class="s2">"if someobject is null then something is wrong"</span><span class="ss">)</span><span class="c1">;</span>
<span class="nv">someobject</span>.<span class="nv">doCalc</span><span class="ss">()</span><span class="c1">;</span>
</pre></div>

<p>Generally throwing a specific exception like <code>NullPointerException</code> when a
value is null but shouldn't be is favorable to throwing a more general
exception like <code>AssertionError</code>. This is the approach the Java library takes;
favoring <code>NullPointerException</code> over <code>IllegalArgumentException</code> when an
argument is not allowed to be null.</p>
<p>(1) is a little harder. If you have no control over the code you're calling
then you're stuck. If null is a valid response, you have to check for it.</p>
<p>If it's code that you do control, however (and this is often the case), then
it's a different story. Avoid using nulls as a response. With methods that
return collections, it's easy: return empty collections (or arrays) instead of
nulls pretty much all the time.</p>
<p>With non-collections it might be harder. Consider this as an example: if you
have these interfaces:</p>
<div class="code"><pre class="code literal-block">public interface Action {
  void doSomething();
}

public interface Parser {
  Action findAction(String userInput);
}
</pre></div>

<p>where Parser takes raw user input and finds something to do, perhaps if you're
implementing a command line interface for something. Now you might make the
contract that it returns null if there's no appropriate action. That leads the
null checking you're talking about.</p>
<p>An alternative solution is to never return null and instead use the Null
Object pattern:</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">class</span><span class="w"> </span><span class="nv">MyParser</span><span class="w"> </span><span class="nv">implements</span><span class="w"> </span><span class="nv">Parser</span><span class="w"> </span>{
<span class="w">  </span><span class="nv">private</span><span class="w"> </span><span class="nv">static</span><span class="w"> </span><span class="nv">Action</span><span class="w"> </span><span class="nv">DO_NOTHING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">Action</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">doSomething</span><span class="ss">()</span><span class="w"> </span>{<span class="w"> </span><span class="cm">/* do nothing */</span><span class="w"> </span>}
<span class="w">  </span>}<span class="c1">;</span>

<span class="w">  </span><span class="nv">public</span><span class="w"> </span><span class="nv">Action</span><span class="w"> </span><span class="nv">findAction</span><span class="ss">(</span><span class="nv">String</span><span class="w"> </span><span class="nv">userInput</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="o">//</span><span class="w"> </span>...
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="w"> </span><span class="cm">/* we can't find any actions */</span><span class="w"> </span><span class="ss">)</span><span class="w"> </span>{
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nv">DO_NOTHING</span><span class="c1">;</span>
<span class="w">    </span>}
<span class="w">  </span>}
}
</pre></div>

<p>Compare:</p>
<div class="code"><pre class="code literal-block"><span class="nv">Parser</span><span class="w"> </span><span class="nv">parser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ParserFactory</span>.<span class="nv">getParser</span><span class="ss">()</span><span class="c1">;</span>
<span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">parser</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="nv">now</span><span class="w"> </span><span class="nv">what</span>?
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">would</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">example</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">where</span><span class="w"> </span><span class="nv">null</span><span class="w"> </span><span class="nv">isn</span><span class="s1">'t (or shouldn'</span><span class="nv">t</span><span class="w"> </span><span class="nv">be</span><span class="ss">)</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">valid</span><span class="w"> </span><span class="nv">response</span>
}
<span class="nv">Action</span><span class="w"> </span><span class="nv">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">parser</span>.<span class="nv">findAction</span><span class="ss">(</span><span class="nv">someInput</span><span class="ss">)</span><span class="c1">;</span>
<span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">nothing</span>
}<span class="w"> </span><span class="k">else</span><span class="w"> </span>{
<span class="w">  </span><span class="nv">action</span>.<span class="nv">doSomething</span><span class="ss">()</span><span class="c1">;</span>
}
</pre></div>

<p>to</p>
<div class="code"><pre class="code literal-block">ParserFactory.getParser().findAction(someInput).doSomething();
</pre></div>

<p>which is a much better design because it leads to more concise code.</p>
<p>That said, perhaps it is entirely appropriate for the findAction() method to
throw an Exception with a meaningful error message -- especially in this case
where you are relying on user input. It would be much better for the
findAction method to throw an Exception than for the calling method to blow up
with a simple NullPointerException with no explanation.</p>
<div class="code"><pre class="code literal-block">try {
    ParserFactory.getParser().findAction(someInput).doSomething();
} catch(ActionNotFoundException anfe) {
    userConsole.err(anfe.getMessage());
}
</pre></div>

<p>Or if you think the try/catch mechanism is too ugly, rather than Do Nothing
your default action should provide feedback to the user.</p>
<div class="code"><pre class="code literal-block"><span class="nt">public</span><span class="w"> </span><span class="nt">Action</span><span class="w"> </span><span class="nt">findAction</span><span class="o">(</span><span class="nt">final</span><span class="w"> </span><span class="nt">String</span><span class="w"> </span><span class="nt">userInput</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c">/* Code to return requested Action if found */</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">new</span><span class="w"> </span><span class="err">Action()</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="err">public</span><span class="w"> </span><span class="err">void</span><span class="w"> </span><span class="err">doSomething()</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="err">userConsole.err("Action</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="n">found</span><span class="p">:</span><span class="w"> </span><span class="err">"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userInput</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>If you use (or planning to use) a Java IDE like JetBrains IntelliJ IDEA,
Eclipse or Netbeans or a tool like findbugs then you can use annotations to
solve this problem.</p>
<p>Basically, you've got <code>@Nullable</code> and <code>@NotNull</code>.</p>
<p>You can use in method and parameters, like this:</p>
<div class="code"><pre class="code literal-block"><span class="nv">@NotNull</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">helloWorld</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ss">"Hello World"</span><span class="p">;</span>
<span class="err">}</span>
</pre></div>

<p>or</p>
<div class="code"><pre class="code literal-block"><span class="nv">@Nullable</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">helloWorld</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ss">"Hello World"</span><span class="p">;</span>
<span class="err">}</span>
</pre></div>

<p>The second example won't compile (in IntelliJ IDEA).</p>
<p>When you use the first <code>helloWorld()</code> function in another piece of code:</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">static</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">main</span><span class="ss">(</span><span class="nv">String</span>[]<span class="w"> </span><span class="nv">args</span><span class="ss">)</span>
{
<span class="w">    </span><span class="nv">String</span><span class="w"> </span><span class="nb">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">helloWorld</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span><span class="k">if</span><span class="ss">(</span><span class="nb">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">        </span><span class="nv">System</span>.<span class="nv">out</span>.<span class="nv">println</span><span class="ss">(</span><span class="nb">result</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span>}
}
</pre></div>

<p>Now the IntelliJ IDEA compiler will tell you that the check is useless, since
the <code>helloWorld()</code> function won't return <code>null</code>, ever.</p>
<p>Using parameter</p>
<div class="code"><pre class="code literal-block"><span class="n">void</span><span class="w"> </span><span class="n">someMethod</span><span class="p">(</span><span class="nv">@NotNull</span><span class="w"> </span><span class="n">someParameter</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="err">}</span>
</pre></div>

<p>if you write something like:</p>
<div class="code"><pre class="code literal-block">someMethod(null);
</pre></div>

<p>This won't compile.</p>
<p>Last example using <code>@Nullable</code></p>
<div class="code"><pre class="code literal-block"><span class="nv">@Nullable</span><span class="w"> </span><span class="n">iWantToDestroyEverything</span><span class="p">()</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">null</span><span class="p">;</span><span class="w"> </span><span class="err">}</span>
</pre></div>

<p>Doing this</p>
<div class="code"><pre class="code literal-block">iWantToDestroyEverything().something();
</pre></div>

<p>And you can be sure that this won't happen. :)</p>
<p>It's a nice way to let the compiler check something more than it usually does
and to enforce your contracts to be stronger. Unfortunately, it's not
supported by all the compilers.</p>
<p>In IntelliJ IDEA 10.5 and on, they added support for any other <code>@Nullable</code>
<code>@NotNull</code> implementations.</p>
<p>See blog post <em>More flexible and configurable @Nullable/@NotNull annotations</em>.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/why-does-google-prepend-while-1-to-their-json-responses/" class="u-url">Why does Google prepend while(1); to their JSON responses?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/why-does-google-prepend-while-1-to-their-json-responses/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T19:00:49+08:00" itemprop="datePublished" title="2023-02-16 19:00">2023-02-16 19:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Why does Google prepend <code>while(1);</code> to their (private) JSON responses?</p>
<p>For example, here's a response while turning a calendar on and off in Google
Calendar:</p>
<div class="code"><pre class="code literal-block"><span class="k">while</span><span class="w"> </span><span class="ss">(</span><span class="mi">1</span><span class="ss">)</span><span class="c1">;</span>
[
<span class="w">  </span>[<span class="s1">'u'</span>,<span class="w"> </span>[
<span class="w">    </span>[<span class="s1">'smsSentFlag'</span>,<span class="w"> </span><span class="s1">'false'</span>],
<span class="w">    </span>[<span class="s1">'hideInvitations'</span>,<span class="w"> </span><span class="s1">'false'</span>],
<span class="w">    </span>[<span class="s1">'remindOnRespondedEventsOnly'</span>,<span class="w"> </span><span class="s1">'true'</span>],
<span class="w">    </span>[<span class="s1">'hideInvitations_remindOnRespondedEventsOnly'</span>,<span class="w"> </span><span class="s1">'false_true'</span>],
<span class="w">    </span>[<span class="s1">'Calendar ID stripped for privacy'</span>,<span class="w"> </span><span class="s1">'false'</span>],
<span class="w">    </span>[<span class="s1">'smsVerifiedFlag'</span>,<span class="w"> </span><span class="s1">'true'</span>]
<span class="w">  </span>]]
]
</pre></div>

<p>I would assume this is to prevent people from doing an <code>eval()</code> on it, but all
you'd really have to do is replace the <code>while</code> and then you'd be set. I would
assume the eval prevention is to make sure people write safe JSON parsing
code.</p>
<p>I've seen this used in a couple of other places, too, but a lot more so with
Google (Mail, Calendar, Contacts, etc.) Strangely enough, Google Docs starts
with <code>&amp;&amp;&amp;START&amp;&amp;&amp;</code> instead, and Google Contacts seems to start with <code>while(1);
&amp;&amp;&amp;START&amp;&amp;&amp;</code>.</p>
<p>What's going on here?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>It prevents JSON hijacking, a major JSON security issue that is formally fixed
in all major browsers since 2011 with ECMAScript 5.</p>
<p>Contrived example: say Google has a URL like
<code>mail.google.com/json?action=inbox</code> which returns the first 50 messages of
your inbox in JSON format. Evil websites on other domains can't make AJAX
requests to get this data due to the same-origin policy, but they can include
the URL via a <code>&lt;script&gt;</code> tag. The URL is visited with <em>your</em> cookies, and by
overriding the global array constructor or accessor methods they can have a
method called whenever an object (array or hash) attribute is set, allowing
them to read the JSON content.</p>
<p>The <code>while(1);</code> or <code>&amp;&amp;&amp;BLAH&amp;&amp;&amp;</code> prevents this: an AJAX request at
<code>mail.google.com</code> will have full access to the text content, and can strip it
away. But a <code>&lt;script&gt;</code> tag insertion blindly executes the JavaScript without
any processing, resulting in either an infinite loop or a syntax error.</p>
<p>This does not address the issue of cross-site request forgery.</p>
<p><br></p>
<h3>Suggest</h3>
<p>It prevents disclosure of the response through JSON hijacking.</p>
<p>In theory, the content of HTTP responses is protected by the Same Origin
Policy: pages from one domain cannot get any pieces of information from pages
on the other domain (unless explicitly allowed).</p>
<p>An attacker can request pages on other domains on your behalf, e.g. by using a
<code>&lt;script src=...&gt;</code> or <code>&lt;img&gt;</code> tag, but it can't get any information about the
result (headers, contents).</p>
<p>Thus, if you visit an attacker's page, it couldn't read your email from
gmail.com.</p>
<p>Except that when using a script tag to request JSON content, the JSON is
executed as JavaScript in an attacker's controlled environment. If the
attacker can replace the Array or Object constructor or some other method used
during object construction, anything in the JSON would pass through the
attacker's code, and be disclosed.</p>
<p>Note that this happens when the JSON is executed as JavaScript, not when it's
parsed.</p>
<p>There are multiple countermeasures:</p>
<h2>Making sure the JSON never executes</h2>
<p>By placing a <code>while(1);</code> statement before the JSON data, Google ensures that
the JSON data is never executed as JavaScript.</p>
<p>Only a legitimate page could actually get the whole content, strip the
<code>while(1);</code>, and parse the remainder as JSON.</p>
<p>Things like <code>for(;;);</code> have been seen on Facebook for instance, with the same
results.</p>
<h2>Making sure the JSON is not valid JavaScript</h2>
<p>Similarly, adding invalid tokens before the JSON, like <code>&amp;&amp;&amp;START&amp;&amp;&amp;</code>, makes
sure that it is never executed.</p>
<h2>Always return JSON with an Object on the outside</h2>
<p>This is OWASP recommended way to protect from JSON hijacking and is the less
intrusive one.</p>
<p>Similarly to the previous counter-measures, it makes sure that the JSON is
never executed as JavaScript.</p>
<p>A valid JSON object, when not enclosed by anything, is not valid in
JavaScript, since the <code>{ }</code> gets interpreted as a code block:</p>
<div class="code"><pre class="code literal-block">eval('{"foo":"bar"}')
// SyntaxError: Unexpected token :
</pre></div>

<p>This is however valid JSON:</p>
<div class="code"><pre class="code literal-block">JSON.parse('{"foo":"bar"}')
// Object {foo: "bar"}
</pre></div>

<p>So, make sure you always return an Object at the top level of the response and
make sure that the JSON is not valid JavaScript, while still being valid JSON.</p>
<p>As noted by @hvd in the comments, the empty object <code>{}</code> is valid JavaScript,
and knowing the object is empty may itself be valuable information.</p>
<h2>Comparison of the above methods</h2>
<p>The OWASP way is less intrusive, as it needs no client library changes, and
transfers valid JSON. It is unsure whether past or future browser bugs could
defeat this, however. As noted by @oriadam, it is unclear whether data could
be leaked in a parse error through an error handling or not (e.g.
window.onerror).</p>
<p>Google's way requires a client library in order for it to support automatic
de-serialization and can be considered to be safer with regard to browser
bugs.</p>
<p>Both methods require server-side changes in order to avoid developers
accidentally sending vulnerable JSON.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-29.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-27.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents ¬© 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
