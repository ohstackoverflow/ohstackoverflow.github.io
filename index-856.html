<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 856) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-856.html">
<link rel="prev" href="index-857.html" type="text/html">
<link rel="next" href="index-855.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/shi-yong-cssshi-divchui-zhi-gun-dong/" class="u-url">使用CSS使div垂直滚动</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/shi-yong-cssshi-divchui-zhi-gun-dong/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T18:00:46+08:00" itemprop="datePublished" title="2023-02-17 18:00">2023-02-17 18:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>这</p>
<div class="code"><pre class="code literal-block"><span class="o">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="nt">id</span><span class="o">=</span><span class="s2">""</span><span class="w"> </span><span class="nt">style</span><span class="o">=</span><span class="s2">"overflow:scroll; height:400px;"</span><span class="o">&gt;</span>
</pre></div>

<p>给出一个<code>div</code>用户可以水平和垂直滚动的选项。如何更改它以便 div 只能 <em>垂直</em> 滚动？</p>
<p><br><br></p>
<h2>解答</h2>
<p>除了使用错误的属性外，您已经涵盖了它。<code>overflow</code>滚动条可以用任何属性, <code>overflow-x</code>,
或触发<code>overflow-y</code>，并且每个属性都可以设置为<code>visible</code>, <code>hidden</code>, <code>scroll</code>, <code>auto</code>,
或中的任何一个<code>inherit</code>。您当前正在查看这两个：</p>
<ul>
<li>
<p><code>auto</code>- 该值将查看框的宽度和高度。如果它们被定义，它不会让盒子扩展超过这些边界。相反（如果内容超出这些边界），它将为超出其长度的任一边界（或两者）创建一个滚动条。</p>
</li>
<li>
<p><code>scroll</code>- 这个值 <em>会强制</em> 滚动条，无论如何，即使内容没有超过设置的边界。如果不需要滚动内容，该栏将显示为“已禁用”或不可交互。</p>
</li>
</ul>
<p><strong>如果你 <em>总是</em> 希望垂直滚动条出现：</strong></p>
<p>你应该使用<code>overflow-y: scroll</code>. 无论是否需要，这 <em>都会强制为垂直轴显示一个滚动条。</em>
如果您实际上无法滚动上下文，它将显示为“已禁用”滚动条。</p>
<p><strong>如果您只希望在可以滚动框的情况下出现滚动条：</strong></p>
<p>只需使用<code>overflow: auto</code>.
由于默认情况下您的内容在当前行放不下时会跳转到下一行，因此不会创建水平滚动条（除非它位于禁用了自动换行的元素上）。对于垂直条，它将允许内容扩展到您指定的高度。如果超过这个高度，它会显示一个垂直滚动条来查看剩余的内容，但如果不超过这个高度则不会显示滚动条。</p>
<p><br></p>
<h3>更多建议</h3>
<p>像这样尝试。</p>
<div class="code"><pre class="code literal-block"><span class="o">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="nt">style</span><span class="o">=</span><span class="s2">"overflow-y: scroll; height:400px;"</span><span class="o">&gt;</span>
</pre></div>

<p><br><br><a href="posts/making-a-div-vertically-scrollable-using-css/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/wo-ru-he-da-dao-mei-ge-zhou-qi-4-ge-flops-de-li-lun-zui-da-zhi/" class="u-url">我如何达到每个周期 4 个 FLOPs 的理论最大值？</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/wo-ru-he-da-dao-mei-ge-zhou-qi-4-ge-flops-de-li-lun-zui-da-zhi/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T18:00:16+08:00" itemprop="datePublished" title="2023-02-17 18:00">2023-02-17 18:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>如何在现代 x86-64 Intel CPU 上实现每个周期 4 个浮点运算（双精度）的理论峰值性能？</p>
<p>据我所知，在大多数现代英特尔 CPU 上， SSE <code>add</code>需要三个周期，a 需要五个周期才能<code>mul</code>完成（例如，参见Agner Fog
的“指令表”）。<code>add</code>由于流水线，如果算法至少有三个独立的求和，则每个周期可以获得一个吞吐量。由于打包版本和标量版本都是如此，<code>addpd</code>并且<code>addsd</code>SSE
寄存器可以包含两个<code>double</code>''，因此吞吐量可以高达每个周期两个触发器。</p>
<p>此外，似乎（虽然我还没有看到任何关于此的适当文档）<code>add</code>和<code>mul</code>可以并行执行，从而提供每个周期四个触发器的理论最大吞吐量。</p>
<p>但是，我无法使用简单的 C/C++ 程序复制该性能。我最好的尝试结果是大约 2.7 次失败/周期。如果有人可以贡献一个简单的 C/C++
或汇编程序来展示最佳性能，那将不胜感激。</p>
<p>我的尝试：</p>
<div class="code"><pre class="code literal-block"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/time.h&gt;</span>

<span class="kt">double</span><span class="w"> </span><span class="nf">stoptime</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">struct</span><span class="w"> </span><span class="nc">timeval</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">   </span><span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">tv_usec</span><span class="o">/</span><span class="mf">1000000.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span><span class="w"> </span><span class="nf">addmul</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">add</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">mul</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ops</span><span class="p">){</span>
<span class="w">   </span><span class="c1">// Need to initialise differently otherwise compiler might optimise away</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">sum1</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="o">=</span><span class="mf">-0.1</span><span class="p">,</span><span class="w"> </span><span class="n">sum3</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="n">sum4</span><span class="o">=</span><span class="mf">-0.2</span><span class="p">,</span><span class="w"> </span><span class="n">sum5</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">mul1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="n">mul2</span><span class="o">=</span><span class="w"> </span><span class="mf">1.1</span><span class="p">,</span><span class="w"> </span><span class="n">mul3</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span><span class="w"> </span><span class="n">mul4</span><span class="o">=</span><span class="w"> </span><span class="mf">1.3</span><span class="p">,</span><span class="w"> </span><span class="n">mul5</span><span class="o">=</span><span class="mf">1.4</span><span class="p">;</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="n">ops</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span><span class="w">          </span><span class="c1">// We have 10 floating point operations inside the loop</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.0</span><span class="o">*</span><span class="n">add</span><span class="o">*</span><span class="n">loops</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">sum1</span><span class="o">+</span><span class="n">sum2</span><span class="o">+</span><span class="n">sum3</span><span class="o">+</span><span class="n">sum4</span><span class="o">+</span><span class="n">sum5</span><span class="p">)</span>
<span class="w">               </span><span class="o">+</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span><span class="n">loops</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">mul1</span><span class="o">+</span><span class="n">mul2</span><span class="o">+</span><span class="n">mul3</span><span class="o">+</span><span class="n">mul4</span><span class="o">+</span><span class="n">mul5</span><span class="p">);</span>

<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">loops</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">mul1</span><span class="o">*=</span><span class="n">mul</span><span class="p">;</span><span class="w"> </span><span class="n">mul2</span><span class="o">*=</span><span class="n">mul</span><span class="p">;</span><span class="w"> </span><span class="n">mul3</span><span class="o">*=</span><span class="n">mul</span><span class="p">;</span><span class="w"> </span><span class="n">mul4</span><span class="o">*=</span><span class="n">mul</span><span class="p">;</span><span class="w"> </span><span class="n">mul5</span><span class="o">*=</span><span class="n">mul</span><span class="p">;</span>
<span class="w">      </span><span class="n">sum1</span><span class="o">+=</span><span class="n">add</span><span class="p">;</span><span class="w"> </span><span class="n">sum2</span><span class="o">+=</span><span class="n">add</span><span class="p">;</span><span class="w"> </span><span class="n">sum3</span><span class="o">+=</span><span class="n">add</span><span class="p">;</span><span class="w"> </span><span class="n">sum4</span><span class="o">+=</span><span class="n">add</span><span class="p">;</span><span class="w"> </span><span class="n">sum5</span><span class="o">+=</span><span class="n">add</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="k">return</span><span class="w">  </span><span class="n">sum1</span><span class="o">+</span><span class="n">sum2</span><span class="o">+</span><span class="n">sum3</span><span class="o">+</span><span class="n">sum4</span><span class="o">+</span><span class="n">sum5</span><span class="o">+</span><span class="n">mul1</span><span class="o">+</span><span class="n">mul2</span><span class="o">+</span><span class="n">mul3</span><span class="o">+</span><span class="n">mul4</span><span class="o">+</span><span class="n">mul5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">expected</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">"usage: %s &lt;num&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">"number of operations: &lt;num&gt; millions</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">      </span><span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>
<span class="w">       </span><span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">;</span>

<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M_PI</span><span class="p">;</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1e-8</span><span class="p">;</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stoptime</span><span class="p">();</span>
<span class="w">   </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="w">   </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stoptime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">"addmul:</span><span class="se">\t</span><span class="s"> %.3f s, %.3f Gflops, res=%f</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">n</span><span class="o">/</span><span class="n">t</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>编译：</p>
<div class="code"><pre class="code literal-block">g++ -O2 -march=native addmul.cpp ; ./a.out 1000
</pre></div>

<p>在 Intel Core i5-750, 2.66 GHz 上产生以下输出：</p>
<div class="code"><pre class="code literal-block"><span class="n">addmul</span><span class="o">:</span><span class="w">  </span><span class="mf">0.270</span><span class="w"> </span><span class="n">s</span><span class="o">,</span><span class="w"> </span><span class="mf">3.707</span><span class="w"> </span><span class="n">Gflops</span><span class="o">,</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="mf">1.326463</span>
</pre></div>

<p>也就是说，每个周期只有大约 1.4 个触发器。查看带有<code>g++ -S -O2 -march=native -masm=intel
addmul.cpp</code>主循环的汇编代码对我来说似乎是最佳选择。</p>
<div class="code"><pre class="code literal-block"><span class="nl">.L4:</span>
<span class="nf">inc</span><span class="w">    </span><span class="no">eax</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm8</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm7</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm6</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm5</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm13</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm12</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm11</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm10</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm9</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">cmp</span><span class="w">    </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="no">ebx</span>
<span class="nf">jne</span><span class="w">    </span><span class="no">.L4</span>
</pre></div>

<p>使用压缩版本 (<code>addpd</code>和<code>mulpd</code>) 更改标量版本将使触发器计数加倍，而不会更改执行时间，因此我得到的每个周期只有 2.8
个触发器。有没有一个简单的例子可以实现每个周期四次触发器？</p>
<p>Mysticial 的不错的小程序；这是我的结果（尽管只运行了几秒钟）：</p>
<ul>
<li>
<code>gcc -O2 -march=nocona</code>: 5.6 Gflops out of 10.66 Gflops (2.1 flops/cycle)</li>
<li>
<code>cl /O2</code>, openmp 移除：10.1 Gflops out of 10.66 Gflops (3.8 flops/cycle)</li>
</ul>
<p>这一切看起来有点复杂，但到目前为止我的结论是：</p>
<ul>
<li>
<p><code>gcc -O2</code>更改独立浮点运算的顺序，目的是在可能的情况下交替使用<code>addpd</code>and <code>mulpd</code>。同样适用于<code>gcc-4.6.2 -O2 -march=core2</code>.</p>
</li>
<li>
<p><code>gcc -O2 -march=nocona</code>似乎保持了 C++ 源代码中定义的浮点运算顺序。</p>
</li>
<li>
<p><code>cl /O2</code>， Windows 7 SDK中的 64 位编译器会自动展开循环，并且似乎会尝试安排操作，以便三个一组<code>addpd</code>与三个一组交替<code>mulpd</code>（好吧，至少在我的系统和我的简单程序中是这样） .</p>
</li>
<li>
<p>我的Core i5 750（Nehalem 架构）不喜欢交替使用加法和乘法，并且似乎无法并行运行这两种操作。然而，如果以 3 为一组，它突然像魔术一样起作用。</p>
</li>
<li>
<p>如果其他架构（可能是Sandy Bridge和其他架构）在汇编代码中交替出现，它们似乎能够并行执行 add/mul 而不会出现问题。</p>
</li>
<li>
<p>虽然很难承认，但在我的系统上，<code>cl /O2</code>我的系统在低级优化操作方面做得更好，并且为上面的小 C++ 示例实现了接近峰值的性能。我测得在 1.85-2.01 触发器/周期之间（在 Windows 中使用了 clock()，这不是那么精确。我想，需要使用更好的计时器 - 感谢 Mackie Messer）。</p>
</li>
<li>
<p>我设法做到的最好的方法<code>gcc</code>是手动循环展开并以三人为一组安排加法和乘法。我得到<code>g++ -O2 -march=nocona addmul_unroll.cpp</code>的最好结果<code>0.207s, 4.825 Gflops</code>相当于 1.8 次触发器/周期，我现在对此非常满意。</p>
</li>
</ul>
<p>在 C++ 代码中，我将循环替换<code>for</code>为：</p>
<div class="code"><pre class="code literal-block"><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">int</span><span class="w"> </span><span class="nv">i</span><span class="o">=</span><span class="mi">0</span><span class="c1">; i&lt;loops/3; i++) {</span>
<span class="w">       </span><span class="nv">mul1</span><span class="o">*=</span><span class="nv">mul</span><span class="c1">; mul2*=mul; mul3*=mul;</span>
<span class="w">       </span><span class="nv">sum1</span><span class="o">+=</span><span class="nv">add</span><span class="c1">; sum2+=add; sum3+=add;</span>
<span class="w">       </span><span class="nv">mul4</span><span class="o">*=</span><span class="nv">mul</span><span class="c1">; mul5*=mul; mul1*=mul;</span>
<span class="w">       </span><span class="nv">sum4</span><span class="o">+=</span><span class="nv">add</span><span class="c1">; sum5+=add; sum1+=add;</span>

<span class="w">       </span><span class="nv">mul2</span><span class="o">*=</span><span class="nv">mul</span><span class="c1">; mul3*=mul; mul4*=mul;</span>
<span class="w">       </span><span class="nv">sum2</span><span class="o">+=</span><span class="nv">add</span><span class="c1">; sum3+=add; sum4+=add;</span>
<span class="w">       </span><span class="nv">mul5</span><span class="o">*=</span><span class="nv">mul</span><span class="c1">; mul1*=mul; mul2*=mul;</span>
<span class="w">       </span><span class="nv">sum5</span><span class="o">+=</span><span class="nv">add</span><span class="c1">; sum1+=add; sum2+=add;</span>

<span class="w">       </span><span class="nv">mul3</span><span class="o">*=</span><span class="nv">mul</span><span class="c1">; mul4*=mul; mul5*=mul;</span>
<span class="w">       </span><span class="nv">sum3</span><span class="o">+=</span><span class="nv">add</span><span class="c1">; sum4+=add; sum5+=add;</span>
<span class="w">   </span>}
</pre></div>

<p>程序集现在看起来像：</p>
<div class="code"><pre class="code literal-block"><span class="nl">.L4:</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm8</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm7</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm6</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm13</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm12</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm11</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm5</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm8</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm10</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm9</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm13</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="na">...</span>
</pre></div>

<p><br><br></p>
<h2>解答</h2>
<p>我以前做过这个确切的任务。但它主要是测量功耗和CPU温度。以下代码（相当长）在我的 Core i7 2600K 上接近最佳。</p>
<p>这里要注意的关键是大量的手动循环展开以及乘法和加法的交错......</p>
<p>完整的项目可以在我的 GitHub 上找到：https ://github.com/Mysticial/Flops</p>
<h2>警告：</h2>
<p><strong>如果您决定编译并运行它，请注意您的 CPU 温度！！！</strong><br>
确保不要过热。并确保 CPU 节流不会影响您的结果！</p>
<p>此外，对于运行此代码可能造成的任何损害，我概不负责。</p>
<p><strong>笔记：</strong></p>
<ul>
<li>此代码针对 x64 进行了优化。x86 没有足够的寄存器来很好地编译它。</li>
<li>
<p>此代码已经过测试，可以在 Visual Studio 2010/2012 和 GCC 4.6 上正常运行。<br>
ICC 11（英特尔编译器 11）出人意料地无法很好地编译它。</p>
</li>
<li>
<p>这些适用于 FMA 之前的处理器。为了在 Intel Haswell 和 AMD Bulldozer 处理器（及更高版本）上实现峰值 FLOPS，将需要 FMA（融合乘加）指令。这些超出了本基准测试的范围。</p>
<h2>include <emmintrin.h></emmintrin.h>
</h2>
<h2>include <omp.h></omp.h>
</h2>
<h2>include <iostream></iostream>
</h2>
<p>using namespace std;</p>
<p>typedef unsigned long long uint64;</p>
<p>double test_dp_mac_SSE(double x,double y,uint64 iterations){
    register __m128d r0,r1,r2,r3,r4,r5,r6,r7,r8,r9,rA,rB,rC,rD,rE,rF;</p>
<div class="code"><pre class="code literal-block"><span class="c1">//  Generate starting data.</span>
<span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>

<span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0</span><span class="p">);</span>

<span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_xor_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r8</span><span class="p">);</span>
<span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r8</span><span class="p">);</span>
<span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_andnot_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">r0</span><span class="p">);</span>
<span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">0.37796447300922722721</span><span class="p">));</span>
<span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">0.24253562503633297352</span><span class="p">));</span>
<span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">4.1231056256176605498</span><span class="p">));</span>
<span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">0.37796447300922722721</span><span class="p">));</span>
<span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">0.24253562503633297352</span><span class="p">));</span>
<span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">4.1231056256176605498</span><span class="p">));</span>
<span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">4.1231056256176605498</span><span class="p">));</span>

<span class="n">rC</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">1.4142135623730950488</span><span class="p">);</span>
<span class="n">rD</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">1.7320508075688772935</span><span class="p">);</span>
<span class="n">rE</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">0.57735026918962576451</span><span class="p">);</span>
<span class="n">rF</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">0.70710678118654752440</span><span class="p">);</span>

<span class="n">uint64</span><span class="w"> </span><span class="n">iMASK</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x800fffffffffffffull</span><span class="p">;</span>
<span class="n">__m128d</span><span class="w"> </span><span class="n">MASK</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iMASK</span><span class="p">);</span>
<span class="n">__m128d</span><span class="w"> </span><span class="n">vONE</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>

<span class="n">uint64</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iterations</span><span class="p">){</span>
<span class="w">    </span><span class="n">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">){</span>
<span class="w">        </span><span class="c1">//  Here's the meat - the part that really matters.</span>

<span class="w">        </span><span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>

<span class="w">        </span><span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>

<span class="w">        </span><span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>

<span class="w">        </span><span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>

<span class="w">        </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//  Need to renormalize to prevent denormal/overflow.</span>
<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>

<span class="w">    </span><span class="n">c</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r1</span><span class="p">);</span>
<span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">r3</span><span class="p">);</span>
<span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">r5</span><span class="p">);</span>
<span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">r7</span><span class="p">);</span>
<span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">r9</span><span class="p">);</span>
<span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rB</span><span class="p">);</span>

<span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r2</span><span class="p">);</span>
<span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">r6</span><span class="p">);</span>
<span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rA</span><span class="p">);</span>

<span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r4</span><span class="p">);</span>
<span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r8</span><span class="p">);</span>

<span class="c1">//  Prevent Dead Code Elimination</span>
<span class="nb">double</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">__m128d</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">r0</span><span class="p">;</span>
<span class="n">out</span><span class="w"> </span><span class="o">+</span><span class="p">=</span><span class="w"> </span><span class="p">((</span><span class="nb">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">out</span><span class="w"> </span><span class="o">+</span><span class="p">=</span><span class="w"> </span><span class="p">((</span><span class="nb">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

<span class="k">return</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
</pre></div>

<p>}</p>
<p>void test_dp_mac_SSE(int tds,uint64 iterations){</p>
<div class="code"><pre class="code literal-block">double *sum = (double*)malloc(tds * sizeof(double));
double start = omp_get_wtime();
</pre></div>

<h2>pragma omp parallel num_threads(tds)</h2>
<div class="code"><pre class="code literal-block">{
<span class="w">    </span><span class="nv">double</span><span class="w"> </span><span class="nv">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">test_dp_mac_SSE</span><span class="ss">(</span><span class="mi">1</span>.<span class="mi">1</span>,<span class="mi">2</span>.<span class="mi">1</span>,<span class="nv">iterations</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">sum</span>[<span class="nv">omp_get_thread_num</span><span class="ss">()</span>]<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ret</span><span class="c1">;</span>
}

<span class="nv">double</span><span class="w"> </span><span class="nv">secs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">omp_get_wtime</span><span class="ss">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">start</span><span class="c1">;</span>
<span class="nv">uint64</span><span class="w"> </span><span class="nv">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">iterations</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">tds</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="c1">;</span>
<span class="nv">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s2">"Seconds = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">secs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">endl</span><span class="c1">;</span>
<span class="nv">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s2">"FP Ops  = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">ops</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">endl</span><span class="c1">;</span>
<span class="nv">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s2">"FLOPs   = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">ops</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">secs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">endl</span><span class="c1">;</span>

<span class="nv">double</span><span class="w"> </span><span class="nv">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">;</span>
<span class="nv">int</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">;</span>
<span class="k">while</span><span class="w"> </span><span class="ss">(</span><span class="nv">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">tds</span><span class="ss">)</span>{
<span class="w">    </span><span class="nv">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">sum</span>[<span class="nv">c</span><span class="o">++</span>]<span class="c1">;</span>
}

<span class="nv">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s2">"sum = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">out</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">endl</span><span class="c1">;</span>
<span class="nv">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">endl</span><span class="c1">;</span>

<span class="nv">free</span><span class="ss">(</span><span class="nv">sum</span><span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p>}</p>
<p>int main(){
    //  (threads, iterations)
    test_dp_mac_SSE(8,10000000);</p>
<div class="code"><pre class="code literal-block"><span class="nv">system</span><span class="ss">(</span><span class="s2">"pause"</span><span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p>}</p>
</li>
</ul>
<p><strong>输出（1 个线程，10000000 次迭代）- 使用 Visual Studio 2010 SP1 编译 - x64 版本：</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 55.5104
FP Ops  = 960000000000
FLOPs   = 1.7294e+010
sum = 2.22652
</pre></div>

<p>该机器是 Core i7 2600K @ 4.4 GHz。理论上的 SSE 峰值是 4 触发器 * 4.4 GHz = <strong>17.6 GFlops</strong>
。此代码达到 <strong>17.3 GFlops</strong> - 不错。</p>
<p><strong>输出（8 个线程，10000000 次迭代）- 使用 Visual Studio 2010 SP1 编译 - x64 版本：</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 117.202
FP Ops  = 7680000000000
FLOPs   = 6.55279e+010
sum = 17.8122
</pre></div>

<p>理论上的 SSE 峰值是 4 个触发器 * 4 个内核 * 4.4 GHz = <strong>70.4 GFlops。</strong> 实际是 <strong>65.5 GFlops</strong> 。</p>
<hr>
<h3>让我们更进一步。AVX...</h3>
<div class="code"><pre class="code literal-block"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;immintrin.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="n">using</span><span class="w"> </span><span class="n">namespace</span><span class="w"> </span><span class="nn">std</span><span class="p">;</span>

<span class="kr">typedef</span><span class="w"> </span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="n">uint64</span><span class="p">;</span>

<span class="kr">double</span><span class="w"> </span><span class="nf">test_dp_mac_AVX</span><span class="p">(</span><span class="kr">double</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="kr">double</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="n">uint64</span><span class="w"> </span><span class="n">iterations</span><span class="p">){</span>
<span class="w">    </span><span class="kr">register</span><span class="w"> </span><span class="n">__m256d</span><span class="w"> </span><span class="n">r0</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">r3</span><span class="p">,</span><span class="n">r4</span><span class="p">,</span><span class="n">r5</span><span class="p">,</span><span class="n">r6</span><span class="p">,</span><span class="n">r7</span><span class="p">,</span><span class="n">r8</span><span class="p">,</span><span class="n">r9</span><span class="p">,</span><span class="n">rA</span><span class="p">,</span><span class="n">rB</span><span class="p">,</span><span class="n">rC</span><span class="p">,</span><span class="n">rD</span><span class="p">,</span><span class="n">rE</span><span class="p">,</span><span class="n">rF</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//  Generate starting data.</span>
<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="w">    </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>

<span class="w">    </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">-0.0</span><span class="p">);</span>

<span class="w">    </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_xor_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r8</span><span class="p">);</span>
<span class="w">    </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r8</span><span class="p">);</span>
<span class="w">    </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_andnot_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">r0</span><span class="p">);</span>
<span class="w">    </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">0.37796447300922722721</span><span class="p">));</span>
<span class="w">    </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">0.24253562503633297352</span><span class="p">));</span>
<span class="w">    </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">4.1231056256176605498</span><span class="p">));</span>
<span class="w">    </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">0.37796447300922722721</span><span class="p">));</span>
<span class="w">    </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">0.24253562503633297352</span><span class="p">));</span>
<span class="w">    </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">4.1231056256176605498</span><span class="p">));</span>
<span class="w">    </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">4.1231056256176605498</span><span class="p">));</span>

<span class="w">    </span><span class="n">rC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">1.4142135623730950488</span><span class="p">);</span>
<span class="w">    </span><span class="n">rD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">1.7320508075688772935</span><span class="p">);</span>
<span class="w">    </span><span class="n">rE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">0.57735026918962576451</span><span class="p">);</span>
<span class="w">    </span><span class="n">rF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">0.70710678118654752440</span><span class="p">);</span>

<span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">iMASK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x800fffffffffffffull</span><span class="p">;</span>
<span class="w">    </span><span class="n">__m256d</span><span class="w"> </span><span class="n">MASK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kr">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iMASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">__m256d</span><span class="w"> </span><span class="n">vONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>

<span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iterations</span><span class="p">){</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">){</span>
<span class="w">            </span><span class="c1">//  Here's the meat - the part that really matters.</span>

<span class="w">            </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>

<span class="w">            </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>

<span class="w">            </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>

<span class="w">            </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>

<span class="w">            </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">//  Need to renormalize to prevent denormal/overflow.</span>
<span class="w">        </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>

<span class="w">        </span><span class="n">c</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r1</span><span class="p">);</span>
<span class="w">    </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">r3</span><span class="p">);</span>
<span class="w">    </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">r5</span><span class="p">);</span>
<span class="w">    </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">r7</span><span class="p">);</span>
<span class="w">    </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">r9</span><span class="p">);</span>
<span class="w">    </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rB</span><span class="p">);</span>

<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r2</span><span class="p">);</span>
<span class="w">    </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">r6</span><span class="p">);</span>
<span class="w">    </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rA</span><span class="p">);</span>

<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r4</span><span class="p">);</span>
<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r8</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//  Prevent Dead Code Elimination</span>
<span class="w">    </span><span class="kr">double</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">__m256d</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r0</span><span class="p">;</span>
<span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="kr">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="kr">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="kr">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="kr">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)[</span><span class="mi">3</span><span class="p">];</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">void</span><span class="w"> </span><span class="nf">test_dp_mac_AVX</span><span class="p">(</span><span class="kr">int</span><span class="w"> </span><span class="n">tds</span><span class="p">,</span><span class="n">uint64</span><span class="w"> </span><span class="n">iterations</span><span class="p">){</span>

<span class="w">    </span><span class="kr">double</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kr">double</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">tds</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">sizeof</span><span class="p">(</span><span class="kr">double</span><span class="p">));</span>
<span class="w">    </span><span class="kr">double</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omp_get_wtime</span><span class="p">();</span>

<span class="cp">#pragma omp parallel num_threads(tds)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kr">double</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_dp_mac_AVX</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span><span class="mf">2.1</span><span class="p">,</span><span class="n">iterations</span><span class="p">);</span>
<span class="w">        </span><span class="n">sum</span><span class="p">[</span><span class="n">omp_get_thread_num</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">double</span><span class="w"> </span><span class="n">secs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omp_get_wtime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tds</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Seconds = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">secs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"FP Ops  = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ops</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"FLOPs   = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ops</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">secs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>

<span class="w">    </span><span class="kr">double</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kr">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tds</span><span class="p">){</span>
<span class="w">        </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sum</span><span class="p">[</span><span class="n">c</span><span class="o">++</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"sum = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>

<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">sum</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span>
<span class="w">    </span><span class="c1">//  (threads, iterations)</span>
<span class="w">    </span><span class="n">test_dp_mac_AVX</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">10000000</span><span class="p">);</span>

<span class="w">    </span><span class="n">system</span><span class="p">(</span><span class="s">"pause"</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p><strong>输出（1 个线程，10000000 次迭代）- 使用 Visual Studio 2010 SP1 编译 - x64 版本：</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 57.4679
FP Ops  = 1920000000000
FLOPs   = 3.34099e+010
sum = 4.45305
</pre></div>

<p>理论 AVX 峰值为 8 触发器 * 4.4 GHz = <strong>35.2 GFlops</strong> 。实际是 <strong>33.4 GFlops</strong> 。</p>
<p><strong>输出（8 个线程，10000000 次迭代）- 使用 Visual Studio 2010 SP1 编译 - x64 版本：</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 111.119
FP Ops  = 15360000000000
FLOPs   = 1.3823e+011
sum = 35.6244
</pre></div>

<p>理论 AVX 峰值为 8 触发器 * 4 核 * 4.4 GHz = <strong>140.8 GFlops。</strong> 实际是 <strong>138.2 GFlops</strong> 。</p>
<hr>
<p><strong>现在进行一些解释：</strong></p>
<p>The performance critical part is obviously the 48 instructions inside the
inner loop. You'll notice that it's broken into 4 blocks of 12 instructions
each. Each of these 12 instructions blocks are completely independent from
each other - and take on average 6 cycles to execute.</p>
<p>So there's 12 instructions and 6 cycles between issue-to-use. The latency of
multiplication is 5 cycles, so it's just enough to avoid latency stalls.</p>
<p>The normalization step is needed to keep the data from over/underflowing. This
is needed since the do-nothing code will slowly increase/decrease the
magnitude of the data.</p>
<p>So it's actually possible to do better than this if you just use all zeros and
get rid of the normalization step. However, since I wrote the benchmark to
measure power consumption and temperature, <strong>I had to make sure the flops were
on "real" data, rather than zeros</strong> - as the execution units may very well
have special case-handling for zeros that use less power and produce less
heat.</p>
<hr>
<h3>More Results:</h3>
<ul>
<li><strong>Intel Core i7 920 @ 3.5 GHz</strong></li>
<li>Windows 7 Ultimate x64</li>
<li>Visual Studio 2010 SP1 - x64 Release</li>
</ul>
<p><strong>Threads: 1</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 72.1116
FP Ops  = 960000000000
FLOPs   = 1.33127e+010
sum = 2.22652
</pre></div>

<p>Theoretical SSE Peak: 4 flops * 3.5 GHz = <strong>14.0 GFlops</strong>. Actual is <strong>13.3
GFlops</strong>.</p>
<p><strong>Threads: 8</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 149.576
FP Ops  = 7680000000000
FLOPs   = 5.13452e+010
sum = 17.8122
</pre></div>

<p>Theoretical SSE Peak: 4 flops * 4 cores * 3.5 GHz = <strong>56.0 GFlops</strong>. Actual is
<strong>51.3 GFlops</strong>.</p>
<p><em><strong>My processor temps hit 76C on the multi-threaded run! If you runs these, be
sure the results aren't affected by CPU throttling.</strong></em></p>
<hr>
<ul>
<li><strong>2 x Intel Xeon X5482 Harpertown @ 3.2 GHz</strong></li>
<li>Ubuntu Linux 10 x64</li>
<li>GCC 4.5.2 x64 - (-O2 -msse3 -fopenmp)</li>
</ul>
<p><strong>Threads: 1</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 78.3357
FP Ops  = 960000000000
FLOPs   = 1.22549e+10
sum = 2.22652
</pre></div>

<p>Theoretical SSE Peak: 4 flops * 3.2 GHz = <strong>12.8 GFlops</strong>. Actual is <strong>12.3
GFlops</strong>.</p>
<p><strong>Threads: 8</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 78.4733
FP Ops  = 7680000000000
FLOPs   = 9.78676e+10
sum = 17.8122
</pre></div>

<p>Theoretical SSE Peak: 4 flops * 8 cores * 3.2 GHz = <strong>102.4 GFlops</strong>. Actual
is <strong>97.9 GFlops</strong>.</p>
<p><br></p>
<h3>更多建议</h3>
<p>Intel 架构中有一点人们经常忘记，调度端口在 Int 和 FP/SIMD 之间共享。这意味着在循环逻辑在您的浮点流中创建气泡之前，您只会获得一定数量的
FP/SIMD 突发。Mystical 从他的代码中得到了更多的失败，因为他在展开的循环中使用了更长的步幅。</p>
<p>如果您在此处查看 Nehalem/Sandy Bridge
架构http://www.realworldtech.com/page.cfm?ArticleID=RWT091810191937&amp;p=6就会很清楚发生了什么。</p>
<p>相比之下，在 AMD（Bulldozer）上应该更容易达到峰值性能，因为 INT 和 FP/SIMD 管道有独立的问题端口和它们自己的调度程序。</p>
<p>这只是理论上的，因为我没有测试这些处理器。</p>
<p><br><br><a href="posts/how-do-i-achieve-the-theoretical-maximum-of-4-flops-per-cycle/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/ru-he-zai-bu-diu-shi-xin-xi-de-qing-kuang-xia-jiang-yin-zi-zhuan-huan-wei-zheng-shu-shu-zi/" class="u-url">如何在不丢失信息的情况下将因子转换为整数\数字？</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/ru-he-zai-bu-diu-shi-xin-xi-de-qing-kuang-xia-jiang-yin-zi-zhuan-huan-wei-zheng-shu-shu-zi/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T17:58:06+08:00" itemprop="datePublished" title="2023-02-17 17:58">2023-02-17 17:58</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>当我将一个因子转换为数字或整数时，我得到了底层代码，而不是作为数字的值。</p>
<div class="code"><pre class="code literal-block"><span class="n">f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="nf">sample</span><span class="p">(</span><span class="nf">runif</span><span class="p">(</span><span class="m">5</span><span class="p">),</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span>
<span class="c1">##  [1] 0.0248644019011408 0.0248644019011408 0.179684827337041 </span>
<span class="c1">##  [4] 0.0284090070053935 0.363644931698218  0.363644931698218 </span>
<span class="c1">##  [7] 0.179684827337041  0.249704354675487  0.249704354675487 </span>
<span class="c1">## [10] 0.0248644019011408 0.249704354675487  0.0284090070053935</span>
<span class="c1">## [13] 0.179684827337041  0.0248644019011408 0.179684827337041 </span>
<span class="c1">## [16] 0.363644931698218  0.249704354675487  0.363644931698218 </span>
<span class="c1">## [19] 0.179684827337041  0.0284090070053935</span>
<span class="c1">## 5 Levels: 0.0248644019011408 0.0284090070053935 ... 0.363644931698218</span>

<span class="nf">as.numeric</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="c1">##  [1] 1 1 3 2 5 5 3 4 4 1 4 2 3 1 3 5 4 5 3 2</span>

<span class="nf">as.integer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="c1">##  [1] 1 1 3 2 5 5 3 4 4 1 4 2 3 1 3 5 4 5 3 2</span>
</pre></div>

<p>我必须求助于<code>paste</code>获得真正的价值：</p>
<div class="code"><pre class="code literal-block">as.numeric(paste(f))
##  [1] 0.02486440 0.02486440 0.17968483 0.02840901 0.36364493 0.36364493
##  [7] 0.17968483 0.24970435 0.24970435 0.02486440 0.24970435 0.02840901
## [13] 0.17968483 0.02486440 0.17968483 0.36364493 0.24970435 0.36364493
## [19] 0.17968483 0.02840901
</pre></div>

<p>有没有更好的方法将因子转换为数字？</p>
<p><br><br></p>
<h2>解答</h2>
<p>请参阅以下的警告部分<code>?factor</code>：</p>
<blockquote>
<p>特别是，<code>as.numeric</code>应用于一个因素是没有意义的，并且可能通过隐式强制转换发生。要将因子转换<code>f</code>为其原始数值的近似值，<code>as.numeric(levels(f))[f]</code>建议使用
，并且比 稍微更有效<code>as.numeric(as.character(f))</code>。</p>
</blockquote>
<p>R 上的 FAQ有类似的建议。</p>
<hr>
<p><strong>为什么<code>as.numeric(levels(f))[f]</code>比 更有效<code>as.numeric(as.character(f))</code>？</strong></p>
<p><code>as.numeric(as.character(f))</code>是有效的，所以你是在值而不是值<code>as.numeric(levels(f)[f])</code>上执行到数字的转换。对于级别很少的长向量，速度差异最为明显。如果值大多是唯一的，则速度不会有太大差异。无论您如何进行转换，此操作都不太可能成为您代码中的瓶颈，因此不必太担心。<code>length(x)``nlevels(x)</code></p>
<hr>
<p><strong>一些时间</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">library</span><span class="p">(</span><span class="n">microbenchmark</span><span class="p">)</span>
<span class="n">microbenchmark</span><span class="p">(</span>
<span class="w">  </span><span class="k">as</span><span class="p">.</span><span class="nc">numeric</span><span class="p">(</span><span class="n">levels</span><span class="p">(</span><span class="n">f</span><span class="p">))</span><span class="o">[</span><span class="n">f</span><span class="o">]</span><span class="p">,</span>
<span class="w">  </span><span class="k">as</span><span class="p">.</span><span class="nc">numeric</span><span class="p">(</span><span class="n">levels</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">[</span><span class="n">f</span><span class="o">]</span><span class="p">),</span>
<span class="w">  </span><span class="k">as</span><span class="p">.</span><span class="nc">numeric</span><span class="p">(</span><span class="k">as</span><span class="p">.</span><span class="k">character</span><span class="p">(</span><span class="n">f</span><span class="p">)),</span>
<span class="w">  </span><span class="n">paste0</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<span class="w">  </span><span class="n">paste</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<span class="w">  </span><span class="n">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e5</span>
<span class="p">)</span>
<span class="err">##</span><span class="w"> </span><span class="nl">Unit</span><span class="p">:</span><span class="w"> </span><span class="n">microseconds</span>
<span class="err">##</span><span class="w">                         </span><span class="n">expr</span><span class="w">   </span><span class="nf">min</span><span class="w">    </span><span class="n">lq</span><span class="w">      </span><span class="n">mean</span><span class="w"> </span><span class="n">median</span><span class="w">     </span><span class="n">uq</span><span class="w">      </span><span class="nf">max</span><span class="w"> </span><span class="n">neval</span>
<span class="err">##</span><span class="w">     </span><span class="k">as</span><span class="p">.</span><span class="nc">numeric</span><span class="p">(</span><span class="n">levels</span><span class="p">(</span><span class="n">f</span><span class="p">))</span><span class="o">[</span><span class="n">f</span><span class="o">]</span><span class="w"> </span><span class="mf">3.982</span><span class="w"> </span><span class="mf">5.120</span><span class="w">  </span><span class="mf">6.088624</span><span class="w">  </span><span class="mf">5.405</span><span class="w">  </span><span class="mf">5.974</span><span class="w"> </span><span class="mf">1981.418</span><span class="w"> </span><span class="mf">1e+05</span>
<span class="err">##</span><span class="w">     </span><span class="k">as</span><span class="p">.</span><span class="nc">numeric</span><span class="p">(</span><span class="n">levels</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">[</span><span class="n">f</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="mf">5.973</span><span class="w"> </span><span class="mf">7.111</span><span class="w">  </span><span class="mf">8.352032</span><span class="w">  </span><span class="mf">7.396</span><span class="w">  </span><span class="mf">8.250</span><span class="w"> </span><span class="mf">4256.380</span><span class="w"> </span><span class="mf">1e+05</span>
<span class="err">##</span><span class="w">  </span><span class="k">as</span><span class="p">.</span><span class="nc">numeric</span><span class="p">(</span><span class="k">as</span><span class="p">.</span><span class="k">character</span><span class="p">(</span><span class="n">f</span><span class="p">))</span><span class="w"> </span><span class="mf">6.827</span><span class="w"> </span><span class="mf">8.249</span><span class="w">  </span><span class="mf">9.628264</span><span class="w">  </span><span class="mf">8.534</span><span class="w">  </span><span class="mf">9.671</span><span class="w"> </span><span class="mf">1983.694</span><span class="w"> </span><span class="mf">1e+05</span>
<span class="err">##</span><span class="w">                    </span><span class="n">paste0</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="mf">7.964</span><span class="w"> </span><span class="mf">9.387</span><span class="w"> </span><span class="mf">11.026351</span><span class="w">  </span><span class="mf">9.956</span><span class="w"> </span><span class="mf">10.810</span><span class="w"> </span><span class="mf">2911.257</span><span class="w"> </span><span class="mf">1e+05</span>
<span class="err">##</span><span class="w">                     </span><span class="n">paste</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="mf">7.965</span><span class="w"> </span><span class="mf">9.387</span><span class="w"> </span><span class="mf">11.127308</span><span class="w">  </span><span class="mf">9.956</span><span class="w"> </span><span class="mf">11.093</span><span class="w"> </span><span class="mf">2419.458</span><span class="w"> </span><span class="mf">1e+05</span>
</pre></div>

<p><br></p>
<h3>更多建议</h3>
<p>R 有许多（未记录的）转换因子的便利函数：</p>
<ul>
<li><code>as.character.factor</code></li>
<li><code>as.data.frame.factor</code></li>
<li><code>as.Date.factor</code></li>
<li><code>as.list.factor</code></li>
<li><code>as.vector.factor</code></li>
<li>...</li>
</ul>
<p>但令人恼火的是，没有什么可以处理 _factor - &gt; numeric_转换。作为 Joshua Ulrich
回答的延伸，我建议通过定义您自己的惯用函数来克服这一遗漏：</p>
<div class="code"><pre class="code literal-block"><span class="k">as</span><span class="p">.</span><span class="k">double</span><span class="p">.</span><span class="n">factor</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="k">as</span><span class="p">.</span><span class="nc">numeric</span><span class="p">(</span><span class="n">levels</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">[</span><span class="n">x</span><span class="o">]</span><span class="err">}</span>
</pre></div>

<p>您可以将其存储在脚本的开头，甚至更好地存储在您的<code>.Rprofile</code>文件中。</p>
<p><br><br><a href="posts/how-to-convert-a-factor-to-integer-numeric-without-loss-of-information/">查看原文</a></p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-857.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-855.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
