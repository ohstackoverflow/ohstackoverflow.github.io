<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1248) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1248.html">
<link rel="prev" href="index-1249.html" type="text/html">
<link rel="next" href="index-1247.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/resolving-instances-with-asp-net-core-di-from-within-configureservices/" class="u-url">Resolving instances with ASP.NET Core DI from within ConfigureServices</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/resolving-instances-with-asp-net-core-di-from-within-configureservices/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T04:48:31+08:00" itemprop="datePublished" title="2023-02-18 04:48">2023-02-18 04:48</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>How do I manually resolve a type using the ASP.NET Core MVC built-in
dependency injection framework?</p>
<p>Setting up the container is easy enough:</p>
<div class="code"><pre class="code literal-block">public void ConfigureServices(IServiceCollection services)
{
    // ...

    services.AddTransient&lt;ISomeService, SomeConcreteService&gt;();
}
</pre></div>

<p>But how can I resolve <code>ISomeService</code> without performing injection? For
example, I want to do this:</p>
<div class="code"><pre class="code literal-block">ISomeService service = services.Resolve&lt;ISomeService&gt;();
</pre></div>

<p>There are no such methods in <code>IServiceCollection</code>.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>The <code>IServiceCollection</code> interface is used for <em>building</em> a dependency
injection container. After it's fully built, it gets composed to an
<code>IServiceProvider</code> instance which you can use to resolve services. You can
inject an <code>IServiceProvider</code> into any class. The <code>IApplicationBuilder</code> and
<code>HttpContext</code> classes can provide the service provider as well, via their
<code>ApplicationServices</code> or <code>RequestServices</code> properties respectively.</p>
<p><code>IServiceProvider</code> defines a <code>GetService(Type type)</code> method to resolve a
service:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">IFooService</span><span class="p">)</span><span class="n">serviceProvider</span><span class="o">.</span><span class="n">GetService</span><span class="p">(</span><span class="nb">typeof</span><span class="p">(</span><span class="n">IFooService</span><span class="p">));</span>
</pre></div>

<p>There are also several convenience extension methods available, such as
<code>serviceProvider.GetService&lt;IFooService&gt;()</code> (add a <code>using</code> for
<code>Microsoft.Extensions.DependencyInjection</code>).</p>
<h3>Resolving services inside the startup class</h3>
<h4>Injecting dependencies</h4>
<p>The runtime's hosting service provider can inject certain services into the
constructor of the <code>Startup</code> class, such as <code>IConfiguration</code>,
<code>IWebHostEnvironment</code> (<code>IHostingEnvironment</code> in pre-3.0 versions),
<code>ILoggerFactory</code> and <code>IServiceProvider</code>. Note that the latter is an instance
built by the hosting layer and <strong>contains only the essential services for
starting up an application</strong>.</p>
<p>The <code>ConfigureServices()</code> method does not allow injecting services, it only
accepts an <code>IServiceCollection</code> argument. This makes sense because
<code>ConfigureServices()</code> is where you register the services required by your
application. However you can use services injected in the startup's
constructor here, for example:</p>
<div class="code"><pre class="code literal-block">public Startup(IConfiguration configuration)
{
    Configuration = configuration;
}

public IConfiguration Configuration { get; }

public void ConfigureServices(IServiceCollection services)
{
    // Use Configuration here
}
</pre></div>

<p>Any services registered in <code>ConfigureServices()</code> can then be injected into the
<code>Configure()</code> method; you can add an arbitrary number of services after the
<code>IApplicationBuilder</code> parameter:</p>
<div class="code"><pre class="code literal-block">public void ConfigureServices(IServiceCollection services)
{
    services.AddScoped&lt;IFooService&gt;();
}

public void Configure(IApplicationBuilder app, IFooService fooService)
{
    fooService.Bar();
}
</pre></div>

<h4>Manually resolving dependencies</h4>
<p>If you need to manually resolve services, you should preferably use the
<code>ApplicationServices</code> provided by <code>IApplicationBuilder</code> in the <code>Configure()</code>
method:</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">Configure</span><span class="p">(</span><span class="n">IApplicationBuilder</span><span class="w"> </span><span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">serviceProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">app</span><span class="o">.</span><span class="n">ApplicationServices</span><span class="p">;</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">hostingEnv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serviceProvider</span><span class="o">.</span><span class="n">GetService</span><span class="o">&lt;</span><span class="n">IHostingEnvironment</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>It is possible to pass and directly use an <code>IServiceProvider</code> in the
constructor of your <code>Startup</code> class, but as above <strong>this will contain a
limited subset of services</strong> , and thus has limited utility:</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="n">Startup</span><span class="p">(</span><span class="n">IServiceProvider</span><span class="w"> </span><span class="n">serviceProvider</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">hostingEnv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serviceProvider</span><span class="o">.</span><span class="n">GetService</span><span class="o">&lt;</span><span class="n">IWebHostEnvironment</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>If you must resolve services in the <code>ConfigureServices()</code> method, a different
approach is required. You can build an intermediate <code>IServiceProvider</code> from
the <code>IServiceCollection</code> instance which contains the services which have been
registered <strong>up to that point</strong> :</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span><span class="w"> </span><span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">services</span><span class="o">.</span><span class="n">AddSingleton</span><span class="o">&lt;</span><span class="n">IFooService</span><span class="p">,</span><span class="w"> </span><span class="n">FooService</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">intermediate</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="n">provider</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">services</span><span class="o">.</span><span class="n">BuildServiceProvider</span><span class="p">();</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">succeed</span><span class="o">.</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">fooService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="o">.</span><span class="n">GetService</span><span class="o">&lt;</span><span class="n">IFooService</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">fail</span><span class="w"> </span><span class="p">(</span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">),</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">IBarService</span><span class="w"> </span><span class="n">hasn</span><span class="s1">'t been registered yet.</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">barService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="o">.</span><span class="n">GetService</span><span class="o">&lt;</span><span class="n">IBarService</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p><strong>Please note:</strong> Generally you should avoid resolving services inside the
<code>ConfigureServices()</code> method, as this is actually the place where you're
<em>configuring</em> the application services. Sometimes you just need access to an
<code>IOptions&lt;MyOptions&gt;</code> instance. You can accomplish this by binding the values
from the <code>IConfiguration</code> instance to an instance of <code>MyOptions</code> (which is
essentially what the options framework does):</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span><span class="w"> </span><span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">myOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MyOptions</span><span class="p">();</span>
<span class="w">    </span><span class="n">Configuration</span><span class="o">.</span><span class="n">GetSection</span><span class="p">(</span><span class="s2">"SomeSection"</span><span class="p">)</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">myOptions</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Or use an overload for <code>AddSingleton/AddScoped/AddTransient</code>:</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="n">Works</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AddScoped</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">AddTransient</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">well</span>
<span class="n">services</span><span class="o">.</span><span class="n">AddSingleton</span><span class="o">&lt;</span><span class="n">IBarService</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sp</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">fooService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="o">.</span><span class="n">GetRequiredService</span><span class="o">&lt;</span><span class="n">IFooService</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">BarService</span><span class="p">(</span><span class="n">fooService</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Manually resolving services (aka Service Locator) is generally considered an
anti-pattern. While it has its use-cases (for frameworks and/or infrastructure
layers), you should avoid it as much as possible.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Manually resolving instances involves using the <code>IServiceProvider</code> interface:</p>
<h2>Resolving Dependency in Startup.ConfigureServices</h2>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span><span class="w"> </span><span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">services</span><span class="o">.</span><span class="n">AddTransient</span><span class="o">&lt;</span><span class="n">IMyService</span><span class="p">,</span><span class="w"> </span><span class="n">MyService</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">serviceProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">services</span><span class="o">.</span><span class="n">BuildServiceProvider</span><span class="p">();</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serviceProvider</span><span class="o">.</span><span class="n">GetService</span><span class="o">&lt;</span><span class="n">IMyService</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<h2>Resolving Dependencies in Startup.Configure</h2>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">Configure</span><span class="p">(</span>
<span class="w">    </span><span class="n">IApplicationBuilder</span><span class="w"> </span><span class="n">application</span><span class="p">,</span>
<span class="w">    </span><span class="n">IServiceProvider</span><span class="w"> </span><span class="n">serviceProvider</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">By</span><span class="w"> </span><span class="n">type</span><span class="o">.</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">service1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">MyService</span><span class="p">)</span><span class="n">serviceProvider</span><span class="o">.</span><span class="n">GetService</span><span class="p">(</span><span class="nb">typeof</span><span class="p">(</span><span class="n">MyService</span><span class="p">));</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">method</span><span class="o">.</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">service2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serviceProvider</span><span class="o">.</span><span class="n">GetService</span><span class="o">&lt;</span><span class="n">MyService</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="o">...</span>
<span class="p">}</span>
</pre></div>

<h2>Resolving Dependencies in Startup.Configure in ASP.NET Core 3</h2>
<div class="code"><pre class="code literal-block">public void Configure(
    IApplicationBuilder application,
    IWebHostEnvironment webHostEnvironment)
{
    application.ApplicationServices.GetService&lt;MyService&gt;();
}
</pre></div>

<h2>Using Runtime Injected Services</h2>
<p>Some types can be injected as method parameters:</p>
<div class="code"><pre class="code literal-block">public class Startup
{
    public Startup(
        IHostingEnvironment hostingEnvironment,
        ILoggerFactory loggerFactory)
    {
    }

    public void ConfigureServices(
        IServiceCollection services)
    {
    }

    public void Configure(
        IApplicationBuilder application,
        IHostingEnvironment hostingEnvironment,
        IServiceProvider serviceProvider,
        ILoggerFactory loggerfactory,
        IApplicationLifetime applicationLifetime)
    {
    }
}
</pre></div>

<h2>Resolving Dependencies in Controller Actions</h2>
<div class="code"><pre class="code literal-block"><span class="k">[HttpGet("/some-action")]</span>
<span class="na">public string SomeAction([FromServices] IMyService myService)</span><span class="w"> </span><span class="o">=</span><span class="s">&gt; "Hello"</span><span class="c1">;</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/create-a-temporary-table-in-a-select-statement-without-a-separate-create-table/" class="u-url">Create a temporary table in a SELECT statement without a separate CREATE TABLE</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/create-a-temporary-table-in-a-select-statement-without-a-separate-create-table/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T04:48:10+08:00" itemprop="datePublished" title="2023-02-18 04:48">2023-02-18 04:48</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Is it possible to create a temporary (session only) table from a select
statement without using a create table statement and specifying each column
type? I know derived tables are capable of this, but those are super-temporary
(statement-only) and I want to re-use.</p>
<p>It would save time if I did not have to write up a create table command and
keep the column list and type list matched up.</p>
<p><br><br></p>
<h2>Answer</h2>
<div class="code"><pre class="code literal-block"><span class="nv">CREATE</span><span class="w"> </span><span class="nv">TEMPORARY</span><span class="w"> </span><span class="nv">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="nv">NOT</span><span class="w"> </span><span class="nv">EXISTS</span><span class="w"> </span><span class="nv">table2</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="ss">(</span><span class="nv">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">FROM</span><span class="w"> </span><span class="nv">table1</span><span class="ss">)</span>
</pre></div>

<p>From the manual found at http://dev.mysql.com/doc/refman/5.7/en/create-
table.html</p>
<blockquote>
<p>You can use the TEMPORARY keyword when creating a table. A TEMPORARY table
is <strong>visible only to the current session</strong> , and is <strong>dropped
automatically</strong> when the session is closed. This means that two different
sessions can use the same temporary table name without conflicting with each
other or with an existing non-TEMPORARY table of the same name. (The
existing table is hidden until the temporary table is dropped.) To create
temporary tables, you must have the CREATE TEMPORARY TABLES privilege.</p>
</blockquote>
<p><br></p>
<h3>Suggest</h3>
<p>In addition to <em>psparrow's</em> answer if you need to <strong>add an index</strong> to your
temporary table do:</p>
<div class="code"><pre class="code literal-block"><span class="nv">CREATE</span><span class="w"> </span><span class="nv">TEMPORARY</span><span class="w"> </span><span class="nv">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="nv">NOT</span><span class="w"> </span><span class="nv">EXISTS</span><span class="w"> </span>
<span class="w">  </span><span class="nv">temp_table</span><span class="w"> </span><span class="ss">(</span><span class="w"> </span><span class="nv">INDEX</span><span class="ss">(</span><span class="nv">col_2</span><span class="ss">)</span><span class="w"> </span><span class="ss">)</span><span class="w"> </span>
<span class="nv">ENGINE</span><span class="o">=</span><span class="nv">MyISAM</span><span class="w"> </span>
<span class="nv">AS</span><span class="w"> </span><span class="ss">(</span>
<span class="w">  </span><span class="nv">SELECT</span><span class="w"> </span><span class="nv">col_1</span>,<span class="w"> </span><span class="nv">coll_2</span>,<span class="w"> </span><span class="nv">coll_3</span>
<span class="w">  </span><span class="nv">FROM</span><span class="w"> </span><span class="nv">mytable</span>
<span class="ss">)</span>
</pre></div>

<p>It also works with <code>PRIMARY KEY</code></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/can-t-specify-the-async-modifier-on-the-main-method-of-a-console-app/" class="u-url">Can't specify the 'async' modifier on the 'Main' method of a console app</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/can-t-specify-the-async-modifier-on-the-main-method-of-a-console-app/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T04:47:43+08:00" itemprop="datePublished" title="2023-02-18 04:47">2023-02-18 04:47</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I am new to asynchronous programming with the <code>async</code> modifier. I am trying to
figure out how to make sure that my <code>Main</code> method of a console application
actually runs asynchronously.</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">Program</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">Main</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Bootstrapper</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Bootstrapper</span><span class="p">();</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bs</span><span class="o">.</span><span class="n">GetList</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">Bootstrapper</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">TvChannel</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">GetList</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">GetPrograms</span><span class="w"> </span><span class="n">pro</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">GetPrograms</span><span class="p">();</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">pro</span><span class="o">.</span><span class="n">DownloadTvChannels</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>I know this is not running asynchronously from "the top." Since it is not
possible to specify the <code>async</code> modifier on the <code>Main</code> method, how can I run
code within <code>main</code> asynchronously?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>As you discovered, in VS11 the compiler will disallow an <code>async Main</code> method.
This was allowed (but never recommended) in VS2010 with the Async CTP.</p>
<p><strong>Update, 2017-11-30:</strong> As of Visual Studio 2017 Update 3 (15.3), the language
now supports an <code>async Main</code> - as long as it returns <code>Task</code> or <code>Task&lt;T&gt;</code>. So
you can now do this:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">Program</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="n">Main</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Bootstrapper</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Bootstrapper</span><span class="p">();</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">bs</span><span class="o">.</span><span class="n">GetList</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>The semantics appear to be the same as the <code>GetAwaiter().GetResult()</code> style of
blocking the main thread. However, there's no language spec for C# 7.1 yet, so
this is only an assumption.</p>
<hr>
<p>I have recent blog posts about async/await and asynchronous console programs
in particular. Here's some background info from the intro post:</p>
<blockquote>
<p>If "await" sees that the awaitable has not completed, then it acts
asynchronously. It tells the awaitable to run the remainder of the method
when it completes, and then <em>returns</em> from the async method. Await will also
capture the current <strong>context</strong> when it passes the remainder of the method
to the awaitable.</p>
<p>Later on, when the awaitable completes, it will execute the remainder of the
async method (within the captured context).</p>
</blockquote>
<p>Here's why this is a problem in Console programs with an <code>async Main</code>:</p>
<blockquote>
<p>Remember from our intro post that an async method will <em>return</em> to its
caller before it is complete. This works perfectly in UI applications (the
method just returns to the UI event loop) and ASP.NET applications (the
method returns off the thread but keeps the request alive). It doesn't work
out so well for Console programs: Main returns to the OS - so your program
exits.</p>
</blockquote>
<p>One solution is to provide your own context - a "main loop" for your console
program that is async-compatible.</p>
<p>If you have a machine with the Async CTP, you can use
<code>GeneralThreadAffineContext</code> from <em>My Documents\Microsoft Visual Studio Async
CTP\Samples(C# Testing) Unit Testing\AsyncTestUtilities</em>. Alternatively, you
can use <code>AsyncContext</code> from my Nito.AsyncEx NuGet package.</p>
<p>Here's an example using <code>AsyncContext</code>; <code>GeneralThreadAffineContext</code> has
almost identical usage:</p>
<div class="code"><pre class="code literal-block"><span class="n">using</span><span class="w"> </span><span class="n">Nito</span><span class="o">.</span><span class="n">AsyncEx</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="n">Program</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">Main</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">AsyncContext</span><span class="o">.</span><span class="n">Run</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">MainAsync</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">MainAsync</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Bootstrapper</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Bootstrapper</span><span class="p">();</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">bs</span><span class="o">.</span><span class="n">GetList</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Alternatively, you can just block the main Console thread until your
asynchronous work has completed:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">Program</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">Main</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">MainAsync</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">GetAwaiter</span><span class="p">()</span><span class="o">.</span><span class="n">GetResult</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="n">MainAsync</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Bootstrapper</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Bootstrapper</span><span class="p">();</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">bs</span><span class="o">.</span><span class="n">GetList</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Note the use of <code>GetAwaiter().GetResult()</code>; this avoids the
<code>AggregateException</code> wrapping that happens if you use <code>Wait()</code> or <code>Result</code>.</p>
<p><br></p>
<h3>Suggest</h3>
<p>You can solve this with this simple construct:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span> <span class="n">Program</span>
{
    <span class="n">static</span> <span class="n">void</span> <span class="n">Main</span>(<span class="n">string</span>[] <span class="nb">args</span>)
    {
        <span class="n">Task</span>.<span class="n">Run</span>(<span class="n">async</span> () =&gt;
        {
            // <span class="n">Do</span> <span class="nb">any</span> <span class="n">async</span> <span class="n">anything</span> <span class="n">you</span> <span class="k">need</span> <span class="n">here</span> <span class="k">without</span> <span class="n">worry</span>
        }).<span class="n">GetAwaiter</span>().<span class="n">GetResult</span>();
    }
}
</pre></div>

<p>That will put everything you do out on the ThreadPool where you'd want it (so
other Tasks you start/await don't attempt to rejoin a Thread they shouldn't),
and wait until everything's done before closing the Console app. No need for
special loops or outside libs.</p>
<p>Edit: Incorporate Andrew's solution for uncaught Exceptions.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1249.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1247.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
