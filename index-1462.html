<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1462) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1462.html">
<link rel="prev" href="index-1463.html" type="text/html">
<link rel="next" href="index-1461.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-can-i-find-out-the-number-of-times-an-rsk-transaction-has-been-confirmed-on-the-rsk-blockchain/" class="u-url">How can I find out the number of times an RSK transaction has been confirmed on the RSK blockchain?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-can-i-find-out-the-number-of-times-an-rsk-transaction-has-been-confirmed-on-the-rsk-blockchain/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-28T04:41:42+08:00" itemprop="datePublished" title="2023-02-28 04:41">2023-02-28 04:41</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>It would be good to know how many times a transaction has been confirmed on
the RSK blockchain so that when one user sends RIF to another wallet or to an
exchange wallet for example we can see how many confirmations have occurred</p>
<p><br><br></p>
<h2>Answer</h2>
<p>You can also do it with web3.js. As function</p>
<div class="code"><pre class="code literal-block"><span class="k">const</span><span class="w"> </span><span class="n">getTxConfirmations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">txHash</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">([</span>
<span class="w">    </span><span class="n">web3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">getTransaction</span><span class="p">(</span><span class="n">txHash</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">tx</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">tx</span><span class="o">.</span><span class="n">blockNumber</span><span class="p">),</span>
<span class="w">    </span><span class="n">web3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">getBlockNumber</span><span class="p">()</span>
<span class="p">])</span><span class="o">.</span><span class="n">then</span><span class="p">(([</span><span class="n">blockNumber</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlockNumber</span><span class="p">])</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">currentBlockNumber</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">blockNumber</span><span class="p">))</span>
</pre></div>

<p>And with Truffle console:</p>
<div class="code"><pre class="code literal-block"><span class="n">truffle</span><span class="p">(</span><span class="n">develop</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">web3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">getTransaction</span><span class="p">(</span><span class="s1">'0x7a28a121c41085ef52d449f64120dbc422ec70b4d324c076c8d89222cf7188c8'</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">tx</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">tx</span><span class="o">.</span><span class="n">blockNumber</span><span class="p">)</span>
<span class="mi">1</span>
<span class="n">truffle</span><span class="p">(</span><span class="n">develop</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">web3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">getBlockNumber</span><span class="p">()</span>
<span class="mi">5</span>
<span class="n">truffle</span><span class="p">(</span><span class="n">develop</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">getTxConfirmations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">txHash</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">web3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">getTransaction</span><span class="p">(</span><span class="n">txHash</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">tx</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">tx</span><span class="o">.</span><span class="n">blockNumber</span><span class="p">),</span><span class="w"> </span><span class="n">web3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">getBlockNumber</span><span class="p">()])</span><span class="o">.</span><span class="n">then</span><span class="p">(([</span><span class="n">blockNumber</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlockNumber</span><span class="p">])</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">currentBlockNumber</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">blockNumber</span><span class="p">))</span>
<span class="n">undefined</span>
<span class="n">truffle</span><span class="p">(</span><span class="n">develop</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getTxConfirmations</span><span class="p">(</span><span class="s1">'0x7a28a121c41085ef52d449f64120dbc422ec70b4d324c076c8d89222cf7188c8'</span><span class="p">)</span>
<span class="mi">4</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>You can also do it with web3.js. As function</p>
<div class="code"><pre class="code literal-block"><span class="k">const</span><span class="w"> </span><span class="n">getTxConfirmations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">txHash</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">([</span>
<span class="w">    </span><span class="n">web3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">getTransaction</span><span class="p">(</span><span class="n">txHash</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">tx</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">tx</span><span class="o">.</span><span class="n">blockNumber</span><span class="p">),</span>
<span class="w">    </span><span class="n">web3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">getBlockNumber</span><span class="p">()</span>
<span class="p">])</span><span class="o">.</span><span class="n">then</span><span class="p">(([</span><span class="n">blockNumber</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlockNumber</span><span class="p">])</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">currentBlockNumber</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">blockNumber</span><span class="p">))</span>
</pre></div>

<p>And with Truffle console:</p>
<div class="code"><pre class="code literal-block"><span class="n">truffle</span><span class="p">(</span><span class="n">develop</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">web3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">getTransaction</span><span class="p">(</span><span class="s1">'0x7a28a121c41085ef52d449f64120dbc422ec70b4d324c076c8d89222cf7188c8'</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">tx</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">tx</span><span class="o">.</span><span class="n">blockNumber</span><span class="p">)</span>
<span class="mi">1</span>
<span class="n">truffle</span><span class="p">(</span><span class="n">develop</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">web3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">getBlockNumber</span><span class="p">()</span>
<span class="mi">5</span>
<span class="n">truffle</span><span class="p">(</span><span class="n">develop</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">getTxConfirmations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">txHash</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">web3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">getTransaction</span><span class="p">(</span><span class="n">txHash</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">tx</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">tx</span><span class="o">.</span><span class="n">blockNumber</span><span class="p">),</span><span class="w"> </span><span class="n">web3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">getBlockNumber</span><span class="p">()])</span><span class="o">.</span><span class="n">then</span><span class="p">(([</span><span class="n">blockNumber</span><span class="p">,</span><span class="w"> </span><span class="n">currentBlockNumber</span><span class="p">])</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">currentBlockNumber</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">blockNumber</span><span class="p">))</span>
<span class="n">undefined</span>
<span class="n">truffle</span><span class="p">(</span><span class="n">develop</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getTxConfirmations</span><span class="p">(</span><span class="s1">'0x7a28a121c41085ef52d449f64120dbc422ec70b4d324c076c8d89222cf7188c8'</span><span class="p">)</span>
<span class="mi">4</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/what-is-difference-between-internal-and-private-in-solidity/" class="u-url">What is difference between internal and private in Solidity?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/what-is-difference-between-internal-and-private-in-solidity/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-28T04:41:22+08:00" itemprop="datePublished" title="2023-02-28 04:41">2023-02-28 04:41</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>In Solidity we have four types of access. Two of them are <code>private</code> and
<code>internal</code>. What is the difference if both of them can be used inside smart
contract and both of them are not visible after deploying?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Access types:</p>
<p><code>public</code> - can be used when contract was deployed, can be used in inherited
contract</p>
<p><code>external</code> can be used when contract was deployed , can NOT be used in
inherited contract</p>
<p><code>internal</code> - can NOT be used when contract was deployed , can be used in
inherited contract</p>
<p><code>private</code> - can NOT be used when contract was deployed, can NOT be used in
inherited contract</p>
<p><br></p>
<h3>Suggest</h3>
<p><code>internal</code> properties can be accessed from child contracts (but not from
external contracts).</p>
<p><code>private</code> properties can't be accessed even from child contracts.</p>
<div class="code"><pre class="code literal-block">pragma solidity ^0.8;

contract Parent {
    bool internal internalProperty;
    bool private privateProperty;
}

contract Child is Parent {
    function foo() external {
        // ok
        internalProperty = true;

        // error, not visible
        privateProperty = true;
    }
}
</pre></div>

<p>You can find more info in the docs section Visibility and Getters.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-to-sign-bitcoin-psbt-with-ledger/" class="u-url">how to sign bitcoin psbt with ledger?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-to-sign-bitcoin-psbt-with-ledger/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-28T04:40:57+08:00" itemprop="datePublished" title="2023-02-28 04:40">2023-02-28 04:40</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I'm trying to sign a Psbt transaction from bitcoinjs-lib following what I
found here:</p>
<p>https://github.com/helperbit/helperbit-
wallet/blob/master/app/components/dashboard.wallet/bitcoin.service/ledger.ts</p>
<p>I've checked that the compressed publicKey both from ledger, and the one from
bitcoinjsLib returned the same value.</p>
<p>I could sign it with the bitcoinjs-lib ECPair, but when I tries to sign it
using ledger, it is always invalid.</p>
<p>Can someone helps me point out where did I made a mistake?</p>
<p>These variables is already mentioned in the code below, but for clarity
purpose:</p>
<div class="code"><pre class="code literal-block">- mnemonics: 
abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about

- previousTx:
02000000000101869362410c61a69ab9390b2167d08219662196e869626e8b0350f1a8e4075efb0100000017160014ef3fdddccdb6b53e6dd1f5a97299a6ba2e1c11c3ffffffff0240420f000000000017a914f748afee815f78f97672be5a9840056d8ed77f4887df9de6050000000017a9142ff4aa6ffa987335c7bdba58ef4cbfecbe9e49938702473044022061a01bf0fbac4650a9b3d035b3d9282255a5c6040aa1d04fd9b6b52ed9f4d20a022064e8e2739ef532e6b2cb461321dd20f5a5d63cf34da3056c428475d42c9aff870121025fb5240daab4cee5fa097eef475f3f2e004f7be702c421b6607d8afea1affa9b00000000

- paths:
["0'/0/0"]

- redeemScript: (non-multisig segwit)
00144328adace54072cd069abf108f97cf80420b212b
</pre></div>

<p>This is my minimum reproducible code I've got.</p>
<div class="code"><pre class="code literal-block"><span class="o">/*</span><span class="w"> </span><span class="n">tslint</span><span class="p">:</span><span class="n">disable</span><span class="w"> </span><span class="o">*/</span>
<span class="o">//</span><span class="w"> </span><span class="err">@</span><span class="n">ts</span><span class="o">-</span><span class="n">check</span>
<span class="n">require</span><span class="p">(</span><span class="s1">'regenerator-runtime'</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="n">bip39</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">'bip39'</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">default</span><span class="p">:</span><span class="w"> </span><span class="n">Transport</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">'@ledgerhq/hw-transport-node-hid'</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">default</span><span class="p">:</span><span class="w"> </span><span class="n">AppBtc</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">'@ledgerhq/hw-app-btc'</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="n">bitcoin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">'bitcoinjs-lib'</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="n">mnemonics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about'</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">NETWORK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">regtest</span><span class="p">;</span>

<span class="o">/**</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">param</span><span class="w"> </span><span class="p">{</span><span class="n">string</span><span class="p">}</span><span class="w"> </span><span class="n">pk</span><span class="w"> </span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">returns</span><span class="w"> </span><span class="p">{</span><span class="n">string</span><span class="p">}</span>
<span class="w"> </span><span class="o">*/</span>
<span class="n">function</span><span class="w"> </span><span class="n">compressPublicKey</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">publicKey</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="o">.</span><span class="n">ECPair</span><span class="o">.</span><span class="n">fromPublicKey</span><span class="p">(</span><span class="n">Buffer</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span><span class="w"> </span><span class="s1">'hex'</span><span class="p">));</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">publicKey</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">/**</span><span class="w"> </span><span class="err">@</span><span class="n">returns</span><span class="w"> </span><span class="p">{</span><span class="n">Promise</span><span class="o">&lt;</span><span class="n">any</span><span class="o">&gt;</span><span class="p">}</span><span class="w"> </span><span class="o">*/</span>
<span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">appBtc</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">transport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">Transport</span><span class="o">.</span><span class="n">create</span><span class="p">();</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">btc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">AppBtc</span><span class="p">(</span><span class="n">transport</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">btc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span><span class="w"> </span><span class="n">signTransaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">ledger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">appBtc</span><span class="p">();</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">paths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"0'/0/0"</span><span class="p">];</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paths</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">previousTx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"02000000000101869362410c61a69ab9390b2167d08219662196e869626e8b0350f1a8e4075efb0100000017160014ef3fdddccdb6b53e6dd1f5a97299a6ba2e1c11c3ffffffff0240420f000000000017a914f748afee815f78f97672be5a9840056d8ed77f4887df9de6050000000017a9142ff4aa6ffa987335c7bdba58ef4cbfecbe9e49938702473044022061a01bf0fbac4650a9b3d035b3d9282255a5c6040aa1d04fd9b6b52ed9f4d20a022064e8e2739ef532e6b2cb461321dd20f5a5d63cf34da3056c428475d42c9aff870121025fb5240daab4cee5fa097eef475f3f2e004f7be702c421b6607d8afea1affa9b00000000"</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">utxo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="o">.</span><span class="n">Transaction</span><span class="o">.</span><span class="n">fromHex</span><span class="p">(</span><span class="n">previousTx</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">segwit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utxo</span><span class="o">.</span><span class="n">hasWitnesses</span><span class="p">();</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">txIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">ecpairs</span><span class="w"> </span><span class="n">things</span><span class="o">.</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="nb">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">bip39</span><span class="o">.</span><span class="n">mnemonicToSeed</span><span class="p">(</span><span class="n">mnemonics</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="o">.</span><span class="n">bip32</span><span class="o">.</span><span class="n">fromSeed</span><span class="p">(</span><span class="nb">seed</span><span class="p">,</span><span class="w"> </span><span class="n">NETWORK</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">ecPrivate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="o">.</span><span class="n">derivePath</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">ecPublic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="o">.</span><span class="n">ECPair</span><span class="o">.</span><span class="n">fromPublicKey</span><span class="p">(</span><span class="n">ecPrivate</span><span class="o">.</span><span class="n">publicKey</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">network</span><span class="p">:</span><span class="w"> </span><span class="n">NETWORK</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">p2wpkh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="o">.</span><span class="n">payments</span><span class="o">.</span><span class="n">p2wpkh</span><span class="p">({</span><span class="w"> </span><span class="n">pubkey</span><span class="p">:</span><span class="w"> </span><span class="n">ecPublic</span><span class="o">.</span><span class="n">publicKey</span><span class="p">,</span><span class="w"> </span><span class="n">network</span><span class="p">:</span><span class="w"> </span><span class="n">NETWORK</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">p2sh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="o">.</span><span class="n">payments</span><span class="o">.</span><span class="n">p2sh</span><span class="p">({</span><span class="w"> </span><span class="n">redeem</span><span class="p">:</span><span class="w"> </span><span class="n">p2wpkh</span><span class="p">,</span><span class="w"> </span><span class="n">network</span><span class="p">:</span><span class="w"> </span><span class="n">NETWORK</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">redeemScript</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p2sh</span><span class="o">.</span><span class="n">redeem</span><span class="o">.</span><span class="n">output</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">fromLedger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ledger</span><span class="o">.</span><span class="n">getWalletPublicKey</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">format</span><span class="p">:</span><span class="w"> </span><span class="s1">'p2sh'</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">ledgerPublicKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compressPublicKey</span><span class="p">(</span><span class="n">fromLedger</span><span class="o">.</span><span class="n">publicKey</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">bitcoinJsPublicKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ecPublic</span><span class="o">.</span><span class="n">publicKey</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">);</span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="w"> </span><span class="n">ledgerPublicKey</span><span class="p">,</span><span class="w"> </span><span class="n">bitcoinJsPublicKey</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="n">p2sh</span><span class="o">.</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">segwit</span><span class="p">,</span><span class="w"> </span><span class="n">fromLedger</span><span class="p">,</span><span class="w"> </span><span class="n">redeemScript</span><span class="p">:</span><span class="w"> </span><span class="n">redeemScript</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">)</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="k">var</span><span class="w"> </span><span class="n">tx1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ledger</span><span class="o">.</span><span class="n">splitTransaction</span><span class="p">(</span><span class="n">previousTx</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">psbt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">bitcoin</span><span class="o">.</span><span class="n">Psbt</span><span class="p">({</span><span class="w"> </span><span class="n">network</span><span class="p">:</span><span class="w"> </span><span class="n">NETWORK</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="n">psbt</span><span class="o">.</span><span class="n">addInput</span><span class="p">({</span>
<span class="w">    </span><span class="nb">hash</span><span class="p">:</span><span class="w"> </span><span class="n">utxo</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span>
<span class="w">    </span><span class="n">index</span><span class="p">:</span><span class="w"> </span><span class="n">txIndex</span><span class="p">,</span>
<span class="w">    </span><span class="n">nonWitnessUtxo</span><span class="p">:</span><span class="w"> </span><span class="n">Buffer</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">previousTx</span><span class="p">,</span><span class="w"> </span><span class="s1">'hex'</span><span class="p">),</span>
<span class="w">    </span><span class="n">redeemScript</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="n">psbt</span><span class="o">.</span><span class="n">addOutput</span><span class="p">({</span>
<span class="w">    </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="s1">'mgWUuj1J1N882jmqFxtDepEC73Rr22E9GU'</span><span class="p">,</span>
<span class="w">    </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="n">psbt</span><span class="o">.</span><span class="n">setMaximumFeeRate</span><span class="p">(</span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">ignore</span><span class="w"> </span><span class="n">maxFeeRate</span><span class="w"> </span><span class="n">we</span><span class="s1">'re testnet anyway.</span>
<span class="w">  </span><span class="n">psbt</span><span class="o">.</span><span class="n">setVersion</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">  </span><span class="o">/**</span><span class="w"> </span><span class="err">@</span><span class="n">type</span><span class="w"> </span><span class="p">{</span><span class="n">string</span><span class="p">}</span><span class="w"> </span><span class="o">*/</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">@</span><span class="n">ts</span><span class="o">-</span><span class="n">ignore</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">newTx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">psbt</span><span class="o">.</span><span class="n">__CACHE</span><span class="o">.</span><span class="n">__TX</span><span class="o">.</span><span class="n">toHex</span><span class="p">();</span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="w"> </span><span class="n">newTx</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">splitNewTx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ledger</span><span class="o">.</span><span class="n">splitTransaction</span><span class="p">(</span><span class="n">newTx</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">outputScriptHex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ledger</span><span class="o">.</span><span class="n">serializeTransactionOutputs</span><span class="p">(</span><span class="n">splitNewTx</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s2">"hex"</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">expectedOutscriptHex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'0188130000000000001976a9140ae1441568d0d293764a347b191025c51556cecd88ac'</span><span class="p">;</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">stolen</span><span class="w"> </span><span class="n">from</span><span class="p">:</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">LedgerHQ</span><span class="o">/</span><span class="n">ledgerjs</span><span class="o">/</span><span class="n">blob</span><span class="o">/</span><span class="k">master</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">hw</span><span class="o">-</span><span class="n">app</span><span class="o">-</span><span class="n">btc</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">Btc</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">js</span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="w"> </span><span class="n">outputScriptHex</span><span class="p">,</span><span class="w"> </span><span class="n">expectedOutscriptHex</span><span class="p">,</span><span class="w"> </span><span class="n">eq</span><span class="p">:</span><span class="w"> </span><span class="n">expectedOutscriptHex</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">outputScriptHex</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">[</span><span class="n">tx1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">p2sh</span><span class="o">.</span><span class="n">redeem</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">)</span><span class="w"> </span><span class="o">/**</span><span class="w"> </span><span class="err">???</span><span class="w"> </span><span class="o">*/</span><span class="p">]</span><span class="w"> </span><span class="p">];</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">ledgerSignatures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ledger</span><span class="o">.</span><span class="n">signP2SHTransaction</span><span class="p">(</span>
<span class="w">    </span><span class="n">inputs</span><span class="p">,</span>
<span class="w">    </span><span class="n">paths</span><span class="p">,</span>
<span class="w">    </span><span class="n">outputScriptHex</span><span class="p">,</span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">lockTime</span><span class="p">,</span>
<span class="w">    </span><span class="n">undefined</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">sigHashType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SIGHASH_ALL</span><span class="w"> </span><span class="err">???</span>
<span class="w">    </span><span class="n">utxo</span><span class="o">.</span><span class="n">hasWitnesses</span><span class="p">(),</span>
<span class="w">    </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">version</span><span class="err">??</span><span class="p">,</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">signer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">network</span><span class="p">:</span><span class="w"> </span><span class="n">NETWORK</span><span class="p">,</span>
<span class="w">    </span><span class="n">publicKey</span><span class="p">:</span><span class="w"> </span><span class="n">ecPrivate</span><span class="o">.</span><span class="n">publicKey</span><span class="p">,</span>
<span class="w">    </span><span class="o">/**</span><span class="w"> </span><span class="err">@</span><span class="n">param</span><span class="w"> </span><span class="p">{</span><span class="n">Buffer</span><span class="p">}</span><span class="w"> </span><span class="o">$</span><span class="nb">hash</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="nb">sign</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="nb">hash</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">expectedSignature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ecPrivate</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="o">$</span><span class="nb">hash</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">comparison</span><span class="o">.</span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="n">ledgerSignature0</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ledgerSignatures</span><span class="p">;</span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">decodedLedgerSignature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">Buffer</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">ledgerSignature0</span><span class="p">,</span><span class="w"> </span><span class="s1">'hex'</span><span class="p">));</span>
<span class="w">      </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">({</span>
<span class="w">        </span><span class="o">$</span><span class="nb">hash</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="nb">hash</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">),</span>
<span class="w">        </span><span class="n">expectedSignature</span><span class="p">:</span><span class="w"> </span><span class="n">expectedSignature</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">),</span>
<span class="w">        </span><span class="n">actualSignature</span><span class="p">:</span><span class="w"> </span><span class="n">decodedLedgerSignature</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">),</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="o">//</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">signature</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">decodedLedgerSignature</span><span class="o">.</span><span class="n">signature</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="n">psbt</span><span class="o">.</span><span class="n">signInput</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">signer</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">validated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">psbt</span><span class="o">.</span><span class="n">validateSignaturesOfInput</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">psbt</span><span class="o">.</span><span class="n">finalizeAllInputs</span><span class="p">();</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">hex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">psbt</span><span class="o">.</span><span class="n">extractTransaction</span><span class="p">()</span><span class="o">.</span><span class="n">toHex</span><span class="p">();</span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="w"> </span><span class="n">validated</span><span class="p">,</span><span class="w"> </span><span class="n">hex</span><span class="w"> </span><span class="p">});</span>
<span class="p">};</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">__filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">signTransaction</span><span class="p">()</span><span class="o">.</span><span class="n">catch</span><span class="p">(</span><span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

<p><br><br></p>
<h2>Answer</h2>
<p>Ooof, finally got it working.</p>
<p>My mistake was I was trying to sign a p2sh-p2ms, By following a reference on
how to sign a p2sh-p2wsh-p2ms.</p>
<p>And, also, that missing last 2 bit (01), which I think represent SIGHASH_ALL
caused an error when I try to decode the signature.</p>
<p>this is my finalized working example.</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="nv">@ts</span><span class="o">-</span><span class="k">check</span>
<span class="n">require</span><span class="p">(</span><span class="s1">'regenerator-runtime'</span><span class="p">);</span>
<span class="n">const</span><span class="w"> </span><span class="n">bip39</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">'bip39'</span><span class="p">);</span>
<span class="n">const</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="k">default</span><span class="err">:</span><span class="w"> </span><span class="n">Transport</span><span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">'@ledgerhq/hw-transport-node-hid'</span><span class="p">);</span>
<span class="n">const</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="k">default</span><span class="err">:</span><span class="w"> </span><span class="n">AppBtc</span><span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">'@ledgerhq/hw-app-btc'</span><span class="p">);</span>
<span class="n">const</span><span class="w"> </span><span class="n">serializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">'@ledgerhq/hw-app-btc/lib/serializeTransaction'</span><span class="p">);</span>
<span class="n">const</span><span class="w"> </span><span class="n">bitcoin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">'bitcoinjs-lib'</span><span class="p">);</span>
<span class="n">const</span><span class="w"> </span><span class="n">mnemonics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about'</span><span class="p">;</span>
<span class="n">const</span><span class="w"> </span><span class="n">NETWORK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="p">.</span><span class="n">networks</span><span class="p">.</span><span class="n">regtest</span><span class="p">;</span>
<span class="n">const</span><span class="w"> </span><span class="n">DEFAULT_LOCK_TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">const</span><span class="w"> </span><span class="n">SIGHASH_ALL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="n">const</span><span class="w"> </span><span class="n">PATHS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">"m/49'/1'/0'/0/0", "m/49'/1'/0'/0/1"</span><span class="o">]</span><span class="p">;</span>

<span class="n">async</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">appBtc</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">transport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">Transport</span><span class="p">.</span><span class="k">create</span><span class="p">();</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">btc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppBtc</span><span class="p">(</span><span class="n">transport</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">btc</span><span class="p">;</span>
<span class="err">}</span>

<span class="cm">/**</span>
<span class="cm"> * @param {string} pk </span>
<span class="cm"> * @returns {string}</span>
<span class="cm"> */</span>
<span class="k">function</span><span class="w"> </span><span class="n">compressPublicKey</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">publicKey</span>
<span class="w">  </span><span class="err">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="p">.</span><span class="n">ECPair</span><span class="p">.</span><span class="n">fromPublicKey</span><span class="p">(</span><span class="n">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span><span class="w"> </span><span class="s1">'hex'</span><span class="p">));</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">publicKey</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">);</span>
<span class="err">}</span>

<span class="cm">/**</span>
<span class="cm"> * @param {AppBtc} ledger</span>
<span class="cm"> * @param {bitcoin.Transaction} tx</span>
<span class="cm"> */</span>
<span class="k">function</span><span class="w"> </span><span class="n">splitTransaction</span><span class="p">(</span><span class="n">ledger</span><span class="p">,</span><span class="w"> </span><span class="n">tx</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ledger</span><span class="p">.</span><span class="n">splitTransaction</span><span class="p">(</span><span class="n">tx</span><span class="p">.</span><span class="n">toHex</span><span class="p">(),</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">hasWitnesses</span><span class="p">());</span>
<span class="err">}</span>

<span class="n">const</span><span class="w"> </span><span class="n">signTransaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">bip39</span><span class="p">.</span><span class="n">mnemonicToSeed</span><span class="p">(</span><span class="n">mnemonics</span><span class="p">);</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="p">.</span><span class="n">bip32</span><span class="p">.</span><span class="n">fromSeed</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span><span class="w"> </span><span class="n">NETWORK</span><span class="p">);</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">signers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PATHS</span><span class="p">.</span><span class="k">map</span><span class="p">((</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">derivePath</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">publicKeys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">signers</span><span class="p">.</span><span class="k">map</span><span class="p">((</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">publicKey</span><span class="p">);</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">p2ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="p">.</span><span class="n">payments</span><span class="p">.</span><span class="n">p2ms</span><span class="p">(</span><span class="err">{</span><span class="w"> </span><span class="nl">pubkeys</span><span class="p">:</span><span class="w"> </span><span class="n">publicKeys</span><span class="p">,</span><span class="w"> </span><span class="nl">network</span><span class="p">:</span><span class="w"> </span><span class="n">NETWORK</span><span class="p">,</span><span class="w"> </span><span class="nl">m</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">}</span><span class="p">);</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">p2shP2ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="p">.</span><span class="n">payments</span><span class="p">.</span><span class="n">p2sh</span><span class="p">(</span><span class="err">{</span><span class="w"> </span><span class="nl">redeem</span><span class="p">:</span><span class="w"> </span><span class="n">p2ms</span><span class="p">,</span><span class="w"> </span><span class="nl">network</span><span class="p">:</span><span class="w"> </span><span class="n">NETWORK</span><span class="w"> </span><span class="err">}</span><span class="p">);</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">previousTx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'02000000000101588e8fc89afea9adb79de2650f0cdba762f7d0880c29a1f20e7b468f97da9f850100000017160014345766130a8f8e83aef8621122ca14fff88e6d51ffffffff0240420f000000000017a914a0546d83e5f8876045d7025a230d87bf69db893287df9de6050000000017a9142ff4aa6ffa987335c7bdba58ef4cbfecbe9e49938702483045022100c654271a891af98e46ca4d82ede8cccb0503a430e50745f959274294c98030750220331b455fed13ff4286f6db699eca06aa0c1c37c45c9f3aed3a77a3b0187ff4ac0121037ebcf3cf122678b9dc89b339017c5b76bee9fedd068c7401f4a8eb1d7e841c3a00000000'</span><span class="p">;</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">utxo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="p">.</span><span class="k">Transaction</span><span class="p">.</span><span class="n">fromHex</span><span class="p">(</span><span class="n">previousTx</span><span class="p">);</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">txIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">destination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p2shP2ms</span><span class="p">;</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">redeemScript</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">destination</span><span class="p">.</span><span class="n">redeem</span><span class="p">.</span><span class="k">output</span><span class="p">;</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">witnessScript</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">destination</span><span class="p">.</span><span class="n">redeem</span><span class="p">.</span><span class="n">redeem</span><span class="p">.</span><span class="k">output</span><span class="p">;</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">ledgerRedeemScript</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redeemScript</span><span class="p">;</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">witness</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">outgoing</span><span class="w"> </span><span class="k">transaction</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">p2sh</span><span class="o">-</span><span class="n">p2wsh</span><span class="o">-</span><span class="n">p2ms</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">p2sh</span><span class="o">-</span><span class="n">p2ms</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">fee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="w">  </span><span class="cm">/** @type {number} */</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="nv">@ts</span><span class="o">-</span><span class="k">ignore</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utxo</span><span class="p">.</span><span class="n">outs</span><span class="o">[</span><span class="n">txIndex</span><span class="o">]</span><span class="p">.</span><span class="k">value</span><span class="p">;</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">withdrawAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">fee</span><span class="p">;</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">psbt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">bitcoin</span><span class="p">.</span><span class="n">Psbt</span><span class="p">(</span><span class="err">{</span><span class="w"> </span><span class="nl">network</span><span class="p">:</span><span class="w"> </span><span class="n">NETWORK</span><span class="w"> </span><span class="err">}</span><span class="p">);</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">psbt</span><span class="p">.</span><span class="n">addInput</span><span class="p">(</span><span class="err">{</span>
<span class="w">    </span><span class="nl">hash</span><span class="p">:</span><span class="w"> </span><span class="n">utxo</span><span class="p">.</span><span class="n">getId</span><span class="p">(),</span>
<span class="w">    </span><span class="k">index</span><span class="err">:</span><span class="w"> </span><span class="n">txIndex</span><span class="p">,</span>
<span class="w">    </span><span class="nl">nonWitnessUtxo</span><span class="p">:</span><span class="w"> </span><span class="n">utxo</span><span class="p">.</span><span class="n">toBuffer</span><span class="p">(),</span>
<span class="w">    </span><span class="n">redeemScript</span><span class="p">,</span>
<span class="w">  </span><span class="err">}</span><span class="p">);</span>
<span class="w">  </span><span class="n">psbt</span><span class="p">.</span><span class="n">addOutput</span><span class="p">(</span><span class="err">{</span>
<span class="w">    </span><span class="nl">address</span><span class="p">:</span><span class="w"> </span><span class="s1">'2MsK2NdiVEPCjBMFWbjFvQ39mxWPMopp5vp'</span><span class="p">,</span>
<span class="w">    </span><span class="k">value</span><span class="err">:</span><span class="w"> </span><span class="n">withdrawAmount</span>
<span class="w">  </span><span class="err">}</span><span class="p">);</span>
<span class="w">  </span><span class="n">psbt</span><span class="p">.</span><span class="n">setVersion</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
<span class="w">  </span><span class="cm">/** @type {bitcoin.Transaction}  */</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="nv">@ts</span><span class="o">-</span><span class="k">ignore</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">newTx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">psbt</span><span class="p">.</span><span class="n">__CACHE</span><span class="p">.</span><span class="n">__TX</span><span class="p">;</span>

<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">ledger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">appBtc</span><span class="p">();</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">inLedgerTx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">splitTransaction</span><span class="p">(</span><span class="n">ledger</span><span class="p">,</span><span class="w"> </span><span class="n">utxo</span><span class="p">);</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">outLedgerTx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">splitTransaction</span><span class="p">(</span><span class="n">ledger</span><span class="p">,</span><span class="w"> </span><span class="n">newTx</span><span class="p">);</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">outputScriptHex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">serializer</span><span class="p">.</span><span class="n">serializeTransactionOutputs</span><span class="p">(</span><span class="n">outLedgerTx</span><span class="p">).</span><span class="n">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/** @param {string} path */</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">signer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">path</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="n">ecPrivate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">derivePath</span><span class="p">(</span><span class="k">path</span><span class="p">);</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">actually</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="n">publicKey</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">needed</span><span class="p">,</span><span class="w"> </span><span class="n">albeit</span><span class="w"> </span><span class="n">ledger</span><span class="w"> </span><span class="n">give</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">uncompressed</span><span class="w"> </span><span class="n">one</span><span class="p">.</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="nl">publicKey</span><span class="p">:</span><span class="w"> </span><span class="n">uncompressedPublicKey</span><span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ledger</span><span class="p">.</span><span class="n">getWalletPublicKey</span><span class="p">(</span><span class="k">path</span><span class="p">);</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="n">publicKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compressPublicKey</span><span class="p">(</span><span class="n">publicKey</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="nl">network</span><span class="p">:</span><span class="w"> </span><span class="n">NETWORK</span><span class="p">,</span>
<span class="w">      </span><span class="nl">publicKey</span><span class="p">:</span><span class="w"> </span><span class="n">ecPrivate</span><span class="p">.</span><span class="n">publicKey</span><span class="p">,</span>
<span class="w">      </span><span class="cm">/** @param {Buffer} $hash */</span>
<span class="w">      </span><span class="nf">sign</span><span class="err">:</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">hash</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">const</span><span class="w"> </span><span class="n">ledgerTxSignatures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">ledger</span><span class="p">.</span><span class="n">signP2SHTransaction</span><span class="p">(</span><span class="err">{</span>
<span class="w">          </span><span class="nl">inputs</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">[inLedgerTx, txIndex, ledgerRedeemScript.toString('hex')</span><span class="o">]</span><span class="err">]</span><span class="p">,</span>
<span class="w">          </span><span class="nl">associatedKeysets</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n"> path </span><span class="o">]</span><span class="p">,</span>
<span class="w">          </span><span class="n">outputScriptHex</span><span class="p">,</span>
<span class="w">          </span><span class="nl">lockTime</span><span class="p">:</span><span class="w"> </span><span class="n">DEFAULT_LOCK_TIME</span><span class="p">,</span>
<span class="w">          </span><span class="nl">segwit</span><span class="p">:</span><span class="w"> </span><span class="n">newTx</span><span class="p">.</span><span class="n">hasWitnesses</span><span class="p">(),</span>
<span class="w">          </span><span class="nl">transactionVersion</span><span class="p">:</span><span class="w"> </span><span class="n">version</span><span class="p">,</span>
<span class="w">          </span><span class="nl">sigHashType</span><span class="p">:</span><span class="w"> </span><span class="n">SIGHASH_ALL</span><span class="p">,</span>
<span class="w">        </span><span class="err">}</span><span class="p">);</span>
<span class="w">        </span><span class="n">const</span><span class="w"> </span><span class="o">[</span><span class="n"> ledgerSignature </span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ledgerTxSignatures</span><span class="p">;</span>
<span class="w">        </span><span class="n">const</span><span class="w"> </span><span class="n">expectedSignature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ecPrivate</span><span class="p">.</span><span class="nf">sign</span><span class="p">(</span><span class="err">$</span><span class="n">hash</span><span class="p">);</span>
<span class="w">        </span><span class="n">const</span><span class="w"> </span><span class="n">finalSignature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newTx</span><span class="p">.</span><span class="n">hasWitnesses</span><span class="p">())</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="n">ledgerSignature</span><span class="p">,</span><span class="w"> </span><span class="s1">'hex'</span><span class="p">);</span>
<span class="w">          </span><span class="err">}</span><span class="p">;</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Buffer</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="o">[</span>
<span class="n">            ledgerSignature,</span>
<span class="n">            Buffer.from('01', 'hex'), // SIGHASH_ALL</span>
<span class="n">          </span><span class="o">]</span><span class="p">);</span>
<span class="w">        </span><span class="err">}</span><span class="p">)();</span>
<span class="w">        </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="err">{</span>
<span class="w">          </span><span class="nl">expectedSignature</span><span class="p">:</span><span class="w"> </span><span class="n">expectedSignature</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">),</span>
<span class="w">          </span><span class="nl">finalSignature</span><span class="p">:</span><span class="w"> </span><span class="n">finalSignature</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">),</span>
<span class="w">        </span><span class="err">}</span><span class="p">);</span>
<span class="w">        </span><span class="n">const</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bitcoin</span><span class="p">.</span><span class="n">script</span><span class="p">.</span><span class="n">signature</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">finalSignature</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">signature</span><span class="p">;</span>
<span class="w">      </span><span class="err">}</span><span class="p">,</span>
<span class="w">    </span><span class="err">}</span><span class="p">;</span>
<span class="w">  </span><span class="err">}</span>
<span class="w">  </span><span class="n">await</span><span class="w"> </span><span class="n">psbt</span><span class="p">.</span><span class="n">signInputAsync</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">signer</span><span class="p">(</span><span class="n">PATHS</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">));</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">validate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">psbt</span><span class="p">.</span><span class="n">validateSignaturesOfAllInputs</span><span class="p">();</span>
<span class="w">  </span><span class="n">await</span><span class="w"> </span><span class="n">psbt</span><span class="p">.</span><span class="n">finalizeAllInputs</span><span class="p">();</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">hex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">psbt</span><span class="p">.</span><span class="n">extractTransaction</span><span class="p">().</span><span class="n">toHex</span><span class="p">();</span>
<span class="w">  </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="err">{</span><span class="w"> </span><span class="n">validate</span><span class="p">,</span><span class="w"> </span><span class="n">hex</span><span class="w"> </span><span class="err">}</span><span class="p">);</span>
<span class="err">}</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">process</span><span class="p">.</span><span class="n">argv</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">__filename</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="n">signTransaction</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="n">console</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
<span class="err">}</span>
</pre></div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1463.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1461.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
