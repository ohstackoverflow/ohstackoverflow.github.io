<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 596) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-596.html">
<link rel="prev" href="index-597.html" type="text/html">
<link rel="next" href="index-595.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/sql-server-zhong-de-datetime2-yu-datetime/" class="u-url">SQL Server 中的 DateTime2 与 DateTime</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/sql-server-zhong-de-datetime2-yu-datetime/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T11:02:55+08:00" itemprop="datePublished" title="2023-02-17 11:02">2023-02-17 11:02</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>哪一个：</p>
<ul>
<li><code>datetime</code></li>
<li><code>datetime2</code></li>
</ul>
<p>在 SQL Server 2008+ 中存储日期和时间的推荐方法 <em>是</em> 什么？</p>
<p>我知道精度（可能还有存储空间）的差异，但暂时忽略这些差异，是否有关于何时使用什么的最佳实践文档，或者我们应该只使用<code>datetime2</code>？</p>
<p><br><br></p>
<h2>解答</h2>
<p>datetime的 MSDN 文档建议使用datetime2。这是他们的建议：</p>
<blockquote>
<p>将<code>time</code>、<code>date</code>和<code>datetime2</code>数据<code>datetimeoffset</code>类型用于新工作。这些类型符合 SQL
标准。它们更便携。<code>time</code>,<code>datetime2</code>并<code>datetimeoffset</code>提供更多的秒精度。<code>datetimeoffset</code>为全球部署的应用程序提供时区支持。</p>
</blockquote>
<p>datetime2 具有更大的日期范围、更大的默认小数精度和可选的用户指定精度。此外，根据用户指定的精度，它可能会使用更少的存储空间。</p>
<p><br></p>
<h3>更多建议</h3>
<p><code>DATETIME2</code>日期范围为“0001 / 01 / 01”到“9999 / 12 / 31”，而该<code>DATETIME</code>类型仅支持 1753-9999
年。</p>
<p>另外，如果需要，<code>DATETIME2</code>可以在时间上更精确；DATETIME 被限制为 3 1/3 毫秒，同时<code>DATETIME2</code>可以精确到 100ns。</p>
<p>两种类型都映射到<code>System.DateTime</code>.NET - 没有区别。</p>
<p>如果您有选择，我建议<code>DATETIME2</code>尽可能使用。我没有看到使用任何好处<code>DATETIME</code>（除了向后兼容性） -
你会遇到更少的麻烦（日期超出范围并且像那样麻烦）。</p>
<p>另外：如果您只需要日期（没有时间部分），请使用 DATE - 它和<code>DATETIME2</code>节省空间一样好！:-) 同样适用于时间 - 使用<code>TIME</code>.
这就是这些类型的用途！</p>
<p><br><br><a href="posts/datetime2-vs-datetime-in-sql-server/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/windows-pi-chu-li-wen-jian-bat-huan-shi-cmd/" class="u-url">Windows 批处理文件：.bat 还是 .cmd？</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/windows-pi-chu-li-wen-jian-bat-huan-shi-cmd/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T11:02:28+08:00" itemprop="datePublished" title="2023-02-17 11:02">2023-02-17 11:02</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>据我了解，<code>.bat</code>是旧的 16 位命名约定，<code>.cmd</code>适用于 32 位 Windows，即以 NT 开头。但我继续看到 .bat
文件无处不在，它们似乎使用任一后缀都完全相同。假设我的代码永远不需要在 NT
之前的任何系统上运行，那么我命名我的批处理文件的方式真的很重要吗，或者是否有一些陷阱在 <strong>等待</strong> 我使用错误的后缀？</p>
<p><br><br></p>
<h2>解答</h2>
<p>来自Mark Zbikowski本人发布的新闻组：</p>
<blockquote>
<p>就 CMD.EXE 而言，.CMD 和 .BAT 之间的区别是：启用扩展后，.CMD 文件中的 PATH/APPEND/PROMPT/SET/ASSOC
将设置 ERRORLEVEL，而不管错误。.BAT 仅在出现错误时设置 ERRORLEVEL。</p>
</blockquote>
<p>换句话说，如果将 ERRORLEVEL 设置为非 0，然后运行这些命令之一，则生成的 ERRORLEVEL 将是：</p>
<ul>
<li>在 .bat 文件中保留其非 0 值</li>
<li>在 .cmd 文件中重置为 0。</li>
</ul>
<p><br></p>
<h3>更多建议</h3>
<p>以下是来自该线程中各种答案和引用参考的经过验证的信息的汇编：</p>
<ol>
<li>
<code>command.com</code>是MS-DOS中引入的16位命令处理器，也曾用于Win9x系列操作系统。</li>
<li>
<code>cmd.exe</code>是 Windows NT 中的 32 位命令处理器（64 位 Windows 操作系统也有 64 位版本）。<code>cmd.exe</code>从来就不是 Windows 9x 的一部分。它起源于 OS/2 版本 1.0，而 OS/2 版本<code>cmd</code>开始于 16 位（但仍然是一个完全成熟的保护模式程序，带有诸如 之类的命令<code>start</code>）。Windows NT 继承<code>cmd</code>自 OS/2，但 Windows NT 的 Win32 版本从 32 位开始。尽管 OS/2 在 1992 年成为 32 位的，但它<code>cmd</code>仍然是一个 16 位的 OS/2 1.x 程序。</li>
<li>env变量定义哪个程序由脚本<code>ComSpec</code>启动。（从 WinNT 开始默认为.）<code>.bat``.cmd``cmd.exe</code>
</li>
<li>
<code>cmd.exe</code>向后兼容<code>command.com</code>.</li>
<li>设计用于的脚本<code>cmd.exe</code>可以命名<code>.cmd</code>以防止在 Windows 9x 上意外执行。此文件扩展名也可以追溯到 OS/2 1.0 版和 1987 年。</li>
</ol>
<p><code>cmd.exe</code>以下是不支持的功能列表<code>command.com</code>：</p>
<ul>
<li>长文件名（超过 8.3 格式）</li>
<li>命令历史</li>
<li>选项卡补全</li>
<li>转义字符：（<code>^</code>用于<code>\ &amp; | &gt; &lt; ^</code>：）</li>
<li>目录栈：<code>PUSHD</code>/<code>POPD</code>
</li>
<li>整数运算：<code>SET /A i+=1</code>
</li>
<li>搜索/替换/子字符串：<code>SET %varname:expression%</code>
</li>
<li>命令替换：（<code>FOR /F</code>之前存在，已增强）</li>
<li>功能：<code>CALL :label</code>
</li>
</ul>
<p>执行顺序：</p>
<p>如果脚本的 .bat 和 .cmd 版本（test.bat、test.cmd）都在同一个文件夹中，并且您运行不带扩展名 (test)
的脚本，默认情况下将运行脚本的 .bat 版本，即使在 64 位 Windows 7 上。执行顺序由 PATHEXT
环境变量控制。有关详细信息，请参阅命令提示符执行文件的顺序。</p>
<p>参考：</p>
<ul>
<li>命令执行程序</li>
<li>命令.com</li>
</ul>
<p>维基百科：命令 shell 的比较</p>
<p><br><br><a href="posts/windows-batch-files-bat-vs-cmd/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/wen-jian-shang-chuan-asp-net-mvc-3-0/" class="u-url">文件上传 ASP.NET MVC 3.0</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/wen-jian-shang-chuan-asp-net-mvc-3-0/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T11:02:01+08:00" itemprop="datePublished" title="2023-02-17 11:02">2023-02-17 11:02</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>（前言：本题是关于2011年发布的ASP.NET MVC 3.0 ，不是2019年发布的 <strong>ASP.NET Core 3.0 ）</strong></p>
<p>我想在 asp.net mvc 中上传文件。如何使用 html<code>input file</code>控件上传文件？</p>
<p><br><br></p>
<h2>解答</h2>
<p>您不使用文件输入控件。ASP.NET MVC 中不使用服务器端控件。查看以下博客文章，其中说明了如何在 ASP.NET MVC 中实现这一点。</p>
<p>因此，您将从创建一个包含文件输入的 HTML 表单开始：</p>
<div class="code"><pre class="code literal-block"><span class="nv">@using</span><span class="w"> </span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">BeginForm</span><span class="p">(</span><span class="ss">"Index"</span><span class="p">,</span><span class="w"> </span><span class="ss">"Home"</span><span class="p">,</span><span class="w"> </span><span class="n">FormMethod</span><span class="p">.</span><span class="n">Post</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">enctype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"multipart/form-data"</span><span class="w"> </span><span class="err">}</span><span class="p">))</span>
<span class="err">{</span>
<span class="w">    </span><span class="o">&lt;</span><span class="k">input</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="ss">"file"</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="ss">"file"</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="k">input</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="ss">"submit"</span><span class="w"> </span><span class="k">value</span><span class="o">=</span><span class="ss">"OK"</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="err">}</span>
</pre></div>

<p>然后你会有一个控制器来处理上传：</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">HomeController</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Controller</span>
<span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="n">renders</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">form</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">ActionResult</span><span class="w"> </span><span class="n">Index</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">View</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="n">handles</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">upload</span>
<span class="w">    </span><span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">ActionResult</span><span class="w"> </span><span class="n">Index</span><span class="p">(</span><span class="n">HttpPostedFileBase</span><span class="w"> </span><span class="n">file</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">selected</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">file</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">file</span><span class="o">.</span><span class="n">ContentLength</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">extract</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">filename</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="o">.</span><span class="n">GetFileName</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">FileName</span><span class="p">);</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">inside</span><span class="w"> </span><span class="o">~/</span><span class="n">App_Data</span><span class="o">/</span><span class="n">uploads</span><span class="w"> </span><span class="n">folder</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="o">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">Server</span><span class="o">.</span><span class="n">MapPath</span><span class="p">(</span><span class="s2">"~/App_Data/uploads"</span><span class="p">),</span><span class="w"> </span><span class="n">fileName</span><span class="p">);</span>
<span class="w">            </span><span class="n">file</span><span class="o">.</span><span class="n">SaveAs</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">redirect</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="n">again</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">RedirectToAction</span><span class="p">(</span><span class="s2">"Index"</span><span class="p">);</span><span class="w">        </span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><br></p>
<h3>更多建议</h3>
<p>转移到<code>byte[]</code>（例如保存到数据库）：</p>
<div class="code"><pre class="code literal-block">using (MemoryStream ms = new MemoryStream()) {
    file.InputStream.CopyTo(ms);
    byte[] array = ms.GetBuffer();
}
</pre></div>

<p>要将输入流直接传输到数据库中，而不将其存储在内存中，您可以使用从此处获取的此类并稍作更改：</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">VarbinaryStream</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="p">{</span>
<span class="n">private</span><span class="w"> </span><span class="n">SqlConnection</span><span class="w"> </span><span class="n">_Connection</span><span class="p">;</span>

<span class="n">private</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">_TableName</span><span class="p">;</span>
<span class="n">private</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">_BinaryColumn</span><span class="p">;</span>
<span class="n">private</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">_KeyColumn</span><span class="p">;</span>
<span class="n">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_KeyValue</span><span class="p">;</span>

<span class="n">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">_Offset</span><span class="p">;</span>

<span class="n">private</span><span class="w"> </span><span class="n">SqlDataReader</span><span class="w"> </span><span class="n">_SQLReader</span><span class="p">;</span>
<span class="n">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">_SQLReadPosition</span><span class="p">;</span>

<span class="n">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">_AllowedToRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="n">public</span><span class="w"> </span><span class="nf">VarbinaryStream</span><span class="p">(</span>
<span class="w">    </span><span class="n">string</span><span class="w"> </span><span class="n">ConnectionString</span><span class="p">,</span>
<span class="w">    </span><span class="n">string</span><span class="w"> </span><span class="n">TableName</span><span class="p">,</span>
<span class="w">    </span><span class="n">string</span><span class="w"> </span><span class="n">BinaryColumn</span><span class="p">,</span>
<span class="w">    </span><span class="n">string</span><span class="w"> </span><span class="n">KeyColumn</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">KeyValue</span><span class="p">,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">AllowRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// create own connection with the connection string.</span>
<span class="w">  </span><span class="n">_Connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">SqlConnection</span><span class="p">(</span><span class="n">ConnectionString</span><span class="p">);</span>

<span class="w">  </span><span class="n">_TableName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TableName</span><span class="p">;</span>
<span class="w">  </span><span class="n">_BinaryColumn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BinaryColumn</span><span class="p">;</span>
<span class="w">  </span><span class="n">_KeyColumn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyColumn</span><span class="p">;</span>
<span class="w">  </span><span class="n">_KeyValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyValue</span><span class="p">;</span>


<span class="w">  </span><span class="c1">// only query the database for a result if we are going to be reading, otherwise skip.</span>
<span class="w">  </span><span class="n">_AllowedToRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AllowRead</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_AllowedToRead</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">try</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_Connection</span><span class="p">.</span><span class="n">State</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ConnectionState</span><span class="p">.</span><span class="n">Open</span><span class="p">)</span>
<span class="w">        </span><span class="n">_Connection</span><span class="p">.</span><span class="n">Open</span><span class="p">();</span>

<span class="w">      </span><span class="n">SqlCommand</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">SqlCommand</span><span class="p">(</span>
<span class="w">                      </span><span class="s">@"SELECT TOP 1 ["</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_BinaryColumn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">@"]</span>
<span class="w">                            </span><span class="n">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="s">" + _TableName + @"</span><span class="p">]</span>
<span class="w">                            </span><span class="n">WHERE</span><span class="w"> </span><span class="p">[</span><span class="s">" + _KeyColumn + "</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@</span><span class="kt">id</span><span class="s">",</span>
<span class="w">                  </span><span class="n">_Connection</span><span class="p">);</span>

<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">SqlParameter</span><span class="p">(</span><span class="s">"@id"</span><span class="p">,</span><span class="w"> </span><span class="n">_KeyValue</span><span class="p">));</span>

<span class="w">      </span><span class="n">_SQLReader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">(</span>
<span class="w">          </span><span class="n">CommandBehavior</span><span class="p">.</span><span class="n">SequentialAccess</span><span class="w"> </span><span class="o">|</span>
<span class="w">          </span><span class="n">CommandBehavior</span><span class="p">.</span><span class="n">SingleResult</span><span class="w"> </span><span class="o">|</span>
<span class="w">          </span><span class="n">CommandBehavior</span><span class="p">.</span><span class="n">SingleRow</span><span class="w"> </span><span class="o">|</span>
<span class="w">          </span><span class="n">CommandBehavior</span><span class="p">.</span><span class="n">CloseConnection</span><span class="p">);</span>

<span class="w">      </span><span class="n">_SQLReader</span><span class="p">.</span><span class="n">Read</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// log errors here</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// this method will be called as part of the Stream ímplementation when we try to write to our VarbinaryStream class.</span>
<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Write</span><span class="p">(</span><span class="n">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">try</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_Connection</span><span class="p">.</span><span class="n">State</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ConnectionState</span><span class="p">.</span><span class="n">Open</span><span class="p">)</span>
<span class="w">      </span><span class="n">_Connection</span><span class="p">.</span><span class="n">Open</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_Offset</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// for the first write we just send the bytes to the Column</span>
<span class="w">      </span><span class="n">SqlCommand</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">SqlCommand</span><span class="p">(</span>
<span class="w">                                  </span><span class="s">@"UPDATE [dbo].["</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_TableName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">@"]</span>
<span class="w">                                            </span><span class="n">SET</span><span class="w"> </span><span class="p">[</span><span class="s">" + _BinaryColumn + @"</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@</span><span class="n">firstchunk</span><span class="w"> </span>
<span class="w">                                        </span><span class="n">WHERE</span><span class="w"> </span><span class="p">[</span><span class="s">" + _KeyColumn + "</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@</span><span class="kt">id</span><span class="s">",</span>
<span class="w">                              </span><span class="n">_Connection</span><span class="p">);</span>

<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">SqlParameter</span><span class="p">(</span><span class="s">"@firstchunk"</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">));</span>
<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">SqlParameter</span><span class="p">(</span><span class="s">"@id"</span><span class="p">,</span><span class="w"> </span><span class="n">_KeyValue</span><span class="p">));</span>

<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteNonQuery</span><span class="p">();</span>

<span class="w">      </span><span class="n">_Offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// for all updates after the first one we use the TSQL command .WRITE() to append the data in the database</span>
<span class="w">      </span><span class="n">SqlCommand</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">SqlCommand</span><span class="p">(</span>
<span class="w">                              </span><span class="s">@"UPDATE [dbo].["</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_TableName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">@"]</span>
<span class="w">                                        </span><span class="n">SET</span><span class="w"> </span><span class="p">[</span><span class="s">" + _BinaryColumn + @"</span><span class="p">].</span><span class="n">WRITE</span><span class="p">(@</span><span class="n">chunk</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">@</span><span class="n">length</span><span class="p">)</span>
<span class="w">                                    </span><span class="n">WHERE</span><span class="w"> </span><span class="p">[</span><span class="s">" + _KeyColumn + "</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@</span><span class="kt">id</span><span class="s">",</span>
<span class="w">                           </span><span class="n">_Connection</span><span class="p">);</span>

<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">SqlParameter</span><span class="p">(</span><span class="s">"@chunk"</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">));</span>
<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">SqlParameter</span><span class="p">(</span><span class="s">"@length"</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">));</span>
<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">SqlParameter</span><span class="p">(</span><span class="s">"@id"</span><span class="p">,</span><span class="w"> </span><span class="n">_KeyValue</span><span class="p">));</span>

<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteNonQuery</span><span class="p">();</span>

<span class="w">      </span><span class="n">_Offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// log errors here</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// this method will be called as part of the Stream ímplementation when we try to read from our VarbinaryStream class.</span>
<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Read</span><span class="p">(</span><span class="n">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">try</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">bytesRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_SQLReader</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">_SQLReadPosition</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="n">_SQLReadPosition</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bytesRead</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">bytesRead</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// log errors here</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">CanRead</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">get</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_AllowedToRead</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">protected</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Dispose</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">disposing</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_Connection</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">null</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_Connection</span><span class="p">.</span><span class="n">State</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ConnectionState</span><span class="p">.</span><span class="n">Closed</span><span class="p">)</span>
<span class="w">      </span><span class="n">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_Connection</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span><span class="w">           </span><span class="p">}</span>
<span class="w">      </span><span class="n">catch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">_Connection</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">base</span><span class="p">.</span><span class="n">Dispose</span><span class="p">(</span><span class="n">disposing</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#region unimplemented methods</span>
<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">CanSeek</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">get</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">CanWrite</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">get</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Flush</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NotImplementedException</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">Length</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">get</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NotImplementedException</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">Position</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">get</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NotImplementedException</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">set</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NotImplementedException</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">Seek</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">SeekOrigin</span><span class="w"> </span><span class="n">origin</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NotImplementedException</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">SetLength</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NotImplementedException</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#endregion unimplemented methods  }</span>
</pre></div>

<p>和用法：</p>
<div class="code"><pre class="code literal-block"><span class="w">  </span><span class="n">using</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">filestream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">VarbinaryStream</span><span class="p">(</span>
<span class="w">                            </span><span class="s2">"Connection_String"</span><span class="p">,</span>
<span class="w">                            </span><span class="s2">"Table_Name"</span><span class="p">,</span>
<span class="w">                            </span><span class="s2">"Varbinary_Column_name"</span><span class="p">,</span>
<span class="w">                            </span><span class="s2">"Key_Column_Name"</span><span class="p">,</span>
<span class="w">                            </span><span class="n">keyValueId</span><span class="p">,</span>
<span class="w">                            </span><span class="bp">true</span><span class="p">))</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">postedFile</span><span class="o">.</span><span class="n">InputStream</span><span class="o">.</span><span class="n">CopyTo</span><span class="p">(</span><span class="n">filestream</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>

<p><br><br><a href="posts/file-upload-asp-net-mvc-3-0/">查看原文</a></p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-597.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-595.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
