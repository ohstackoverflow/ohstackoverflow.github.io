<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 2097) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-2097.html">
<link rel="prev" href="index-2098.html" type="text/html">
<link rel="next" href="index-2096.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-dangerous-is-it-to-compare-floating-point-values/" class="u-url">How dangerous is it to compare floating point values?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-dangerous-is-it-to-compare-floating-point-values/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T16:50:57+08:00" itemprop="datePublished" title="2023-03-03 16:50">2023-03-03 16:50</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I know <code>UIKit</code> uses <code>CGFloat</code> because of the resolution independent coordinate
system.</p>
<p>But every time I want to check if for example <code>frame.origin.x</code> is <code>0</code> it makes
me feel sick:</p>
<div class="code"><pre class="code literal-block"><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">theView</span>.<span class="nv">frame</span>.<span class="nv">origin</span>.<span class="nv">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">important</span><span class="w"> </span><span class="nv">operation</span>
}
</pre></div>

<p>Isn't <code>CGFloat</code> vulnerable to false positives when comparing with <code>==</code>, <code>&lt;=</code>,
<code>&gt;=</code>, <code>&lt;</code>, <code>&gt;</code>? It is a floating point and they have unprecision problems:
<code>0.0000000000041</code> for example.</p>
<p>Is <code>Objective-C</code> handling this internally when comparing or can it happen that
a <code>origin.x</code> which reads as zero does not compare to <code>0</code> as true?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>First of all, floating point values are not "random" in their behavior. Exact
comparison can and does make sense in plenty of real-world usages. But if
you're going to use floating point you need to be aware of how it works.
Erring on the side of assuming floating point works like real numbers will get
you code that quickly breaks. Erring on the side of assuming floating point
results have large random fuzz associated with them (like most of the answers
here suggest) will get you code that appears to work at first but ends up
having large-magnitude errors and broken corner cases.</p>
<p>First of all, if you want to program with floating point, you should read
this:</p>
<p>What Every Computer Scientist Should Know About Floating-Point Arithmetic</p>
<p>Yes, read all of it. If that's too much of a burden, you should use
integers/fixed point for your calculations until you have time to read it. :-)</p>
<p>Now, with that said, the biggest issues with exact floating point comparisons
come down to:</p>
<ol>
<li>
<p>The fact that lots of values you may write in the source, or read in with <code>scanf</code> or <code>strtod</code>, <em>do not exist</em> as floating point values and get silently converted to the nearest approximation. This is what demon9733's answer was talking about.</p>
</li>
<li>
<p>The fact that many results get rounded due to not having enough precision to represent the actual result. An easy example where you can see this is adding <code>x = 0x1fffffe</code> and <code>y = 1</code> as floats. Here, <code>x</code> has 24 bits of precision in the mantissa (ok) and <code>y</code> has just 1 bit, but when you add them, their bits are not in overlapping places, and the result would need 25 bits of precision. Instead, it gets rounded (to <code>0x2000000</code> in the default rounding mode).</p>
</li>
<li>
<p>The fact that many results get rounded due to needing infinitely many places for the correct value. This includes both rational results like 1/3 (which you're familiar with from decimal where it takes infinitely many places) but also 1/10 (which also takes infinitely many places in binary, since 5 is not a power of 2), as well as irrational results like the square root of anything that's not a perfect square.</p>
</li>
<li>
<p>Double rounding. On some systems (particularly x86), floating point expressions are evaluated in higher precision than their nominal types. This means that when one of the above types of rounding happens, you'll get two rounding steps, first a rounding of the result to the higher-precision type, then a rounding to the final type. As an example, consider what happens in decimal if you round 1.49 to an integer (1), versus what happens if you first round it to one decimal place (1.5) then round that result to an integer (2). This is actually one of the nastiest areas to deal with in floating point, since the behaviour of the compiler (especially for buggy, non-conforming compilers like GCC) is unpredictable.</p>
</li>
<li>
<p>Transcendental functions (<code>trig</code>, <code>exp</code>, <code>log</code>, etc.) are not specified to have correctly rounded results; the result is just specified to be correct within one unit in the last place of precision (usually referred to as <strong>1ulp</strong> ).</p>
</li>
</ol>
<p>When you're writing floating point code, you need to keep in mind what you're
doing with the numbers that could cause the results to be inexact, and make
comparisons accordingly. Often times it will make sense to compare with an
"epsilon", but that epsilon should be based on the <em>magnitude of the numbers
you are comparing</em> , not an absolute constant. (In cases where an absolute
constant epsilon would work, that's strongly indicative that fixed point, not
floating point, is the right tool for the job!)</p>
<p><strong>Edit:</strong> In particular, a magnitude-relative epsilon check should look
something like:</p>
<div class="code"><pre class="code literal-block"><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">fabs</span><span class="ss">(</span><span class="nv">x</span><span class="o">-</span><span class="nv">y</span><span class="ss">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">K</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">FLT_EPSILON</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">fabs</span><span class="ss">(</span><span class="nv">x</span><span class="o">+</span><span class="nv">y</span><span class="ss">))</span>
</pre></div>

<p>Where <code>FLT_EPSILON</code> is the constant from <code>float.h</code> (replace it with
<code>DBL_EPSILON</code> for<code>double</code>s or <code>LDBL_EPSILON</code> for <code>long double</code>s) and <code>K</code> is a
constant you choose such that the accumulated error of your computations is
definitely bounded by <code>K</code> units in the last place (and if you're not sure you
got the error bound calculation right, make <code>K</code> a few times bigger than what
your calculations say it should be).</p>
<p>Finally, note that if you use this, some special care may be needed near zero,
since <code>FLT_EPSILON</code> does not make sense for denormals. A quick fix would be to
make it:</p>
<div class="code"><pre class="code literal-block"><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">fabs</span><span class="ss">(</span><span class="nv">x</span><span class="o">-</span><span class="nv">y</span><span class="ss">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">K</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">FLT_EPSILON</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">fabs</span><span class="ss">(</span><span class="nv">x</span><span class="o">+</span><span class="nv">y</span><span class="ss">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">fabs</span><span class="ss">(</span><span class="nv">x</span><span class="o">-</span><span class="nv">y</span><span class="ss">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">FLT_MIN</span><span class="ss">)</span>
</pre></div>

<p>and likewise substitute <code>DBL_MIN</code> if using doubles.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Since 0 is exactly representable as an IEEE754 floating-point number (or using
any other implementation of f-p numbers I've ever worked with) comparison with
0 is probably safe. You might get bitten, however, if your program computes a
value (such as <code>theView.frame.origin.x</code>) which you have reason to believe
ought to be 0 but which your computation cannot guarantee to be 0.</p>
<p>To clarify a little, a computation such as :</p>
<div class="code"><pre class="code literal-block">areal = 0.0
</pre></div>

<p>will (unless your language or system is broken) create a value such that
(areal==0.0) returns true but another computation such as</p>
<div class="code"><pre class="code literal-block">areal = 1.386 - 2.1*(0.66)
</pre></div>

<p>may not.</p>
<p>If you can assure yourself that your computations produce values which are 0
(and not just that they produce values which ought to be 0) then you can go
ahead and compare f-p values with 0. If you can't assure yourself to the
required degree, best stick to the usual approach of 'toleranced equality'.</p>
<p>In the worst cases the careless comparison of f-p values can be extremely
dangerous: think avionics, weapons-guidance, power-plant operations, vehicle
navigation, almost any application in which computation meets the real world.</p>
<p>For Angry Birds, not so dangerous.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/real-differences-between-java-server-and-java-client/" class="u-url">Real differences between "java -server" and "java -client"?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/real-differences-between-java-server-and-java-client/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T16:50:32+08:00" itemprop="datePublished" title="2023-03-03 16:50">2023-03-03 16:50</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Is there any real practical difference between "java -server" and "java
-client"?</p>
<p>All I can find on Sun's site is a vague</p>
<blockquote>
<p>"-server starts slower but should run faster".</p>
</blockquote>
<p>What are the real differences? (Using JDK 1.6.0_07 currently.)</p>
<p><br><br></p>
<h2>Answer</h2>
<p>This is really linked to <em>HotSpot</em> and the default <em>option values</em> (Java
HotSpot VM Options) which differ between client and server configuration.</p>
<p>From Chapter 2 of the whitepaper (The Java HotSpot Performance Engine
Architecture):</p>
<blockquote>
<p>The JDK includes two flavors of the VM -- a client-side offering, and a VM
tuned for server applications. These two solutions share the Java HotSpot
runtime environment code base, but use different compilers that are suited
to the distinctly unique performance characteristics of clients and servers.
These differences include the compilation inlining policy and heap defaults.</p>
<p>Although the Server and the Client VMs are similar, the Server VM has been
specially tuned to maximize peak operating speed. It is intended for
executing long-running server applications, which need the fastest possible
operating speed more than a fast start-up time or smaller runtime memory
footprint.</p>
<p>The Client VM compiler serves as an upgrade for both the Classic VM and the
just-in-time (JIT) compilers used by previous versions of the JDK. The
Client VM offers improved run time performance for applications and applets.
The Java HotSpot Client VM has been specially tuned to reduce application
start-up time and memory footprint, making it particularly well suited for
client environments. In general, the client system is better for GUIs.</p>
</blockquote>
<p>So the real difference is also on the compiler level:</p>
<blockquote>
<p>The Client VM compiler does not try to execute many of the more complex
optimizations performed by the compiler in the Server VM, but in exchange,
it requires less time to analyze and compile a piece of code. This means the
Client VM can start up faster and requires a smaller memory footprint.</p>
<p>The Server VM contains an advanced adaptive compiler that supports many of
the same types of optimizations performed by optimizing C++ compilers, as
well as some optimizations that cannot be done by traditional compilers,
such as aggressive inlining across virtual method invocations. This is a
competitive and performance advantage over static compilers. Adaptive
optimization technology is very flexible in its approach, and typically
outperforms even advanced static analysis and compilation techniques.</p>
</blockquote>
<p>Note: The release of <em>jdk6 update 10</em> (see Update Release Notes:Changes in
1.6.0_10) tried to improve startup time, but for a different reason than the
hotspot options, being packaged differently with a much smaller kernel.</p>
<hr>
<p>G. Demecki points out in the comments that in 64-bit versions of JDK, the
<code>-client</code> option is ignored for many years.<br>
See Windows <code>java</code> command:</p>
<div class="code"><pre class="code literal-block">-client
</pre></div>

<blockquote>
<p>Selects the Java HotSpot Client VM.<br><strong>A 64-bit capable JDK currently ignores this option and instead uses the
Java Hotspot Server VM</strong>.</p>
</blockquote>
<hr>
<p>2022: Holger references in the comments the JavaSE6 / Server-Class Machine
Detection, adding:</p>
<blockquote>
<p>Only on 32 bit Windows systems, <code>-client</code> was ever chosen unconditionally.<br>
 Other systems checked whether the machine was “server class” which was
fulfilled when having at least 2 cores and at least 2GiB of memory.</p>
<p>Which explains why almost everything uses <code>-server</code> for quite some time now.
Even the cheapest computers you can find, are “server class” machines. The
Sun/Oracle 64 builds did not even ship with a client JVM.</p>
</blockquote>
<p><br></p>
<h3>Suggest</h3>
<p>The most visible immediate difference in older versions of Java would be the
memory allocated to a <code>-client</code> as opposed to a <code>-server</code> application. For
instance, on my Linux system, I get:</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>java<span class="w"> </span>-XX:+PrintFlagsFinal<span class="w"> </span>-version<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>-E<span class="w"> </span><span class="s1">'heapsize|permsize|version'</span>
uintx<span class="w"> </span><span class="nv">AdaptivePermSizeWeight</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="w">               </span><span class="o">{</span>product<span class="o">}</span>
uintx<span class="w"> </span><span class="nv">ErgoHeapSizeLimit</span><span class="w">                    </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w">                </span><span class="o">{</span>product<span class="o">}</span>
uintx<span class="w"> </span>InitialHeapSize<span class="w">                     </span>:<span class="o">=</span><span class="w"> </span><span class="m">66328448</span><span class="w">         </span><span class="o">{</span>product<span class="o">}</span>
uintx<span class="w"> </span><span class="nv">LargePageHeapSizeThreshold</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="m">134217728</span><span class="w">        </span><span class="o">{</span>product<span class="o">}</span>
uintx<span class="w"> </span>MaxHeapSize<span class="w">                         </span>:<span class="o">=</span><span class="w"> </span><span class="m">1063256064</span><span class="w">       </span><span class="o">{</span>product<span class="o">}</span>
uintx<span class="w"> </span><span class="nv">MaxPermSize</span><span class="w">                          </span><span class="o">=</span><span class="w"> </span><span class="m">67108864</span><span class="w">         </span><span class="o">{</span>pd<span class="w"> </span>product<span class="o">}</span>
uintx<span class="w"> </span><span class="nv">PermSize</span><span class="w">                             </span><span class="o">=</span><span class="w"> </span><span class="m">16777216</span><span class="w">         </span><span class="o">{</span>pd<span class="w"> </span>product<span class="o">}</span>
java<span class="w"> </span>version<span class="w"> </span><span class="s2">"1.6.0_24"</span>
</pre></div>

<p>as it defaults to <code>-server</code>, but with the <code>-client</code> option I get:</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>java<span class="w"> </span>-client<span class="w"> </span>-XX:+PrintFlagsFinal<span class="w"> </span>-version<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>-E<span class="w"> </span><span class="s1">'heapsize|permsize|version'</span>
uintx<span class="w"> </span><span class="nv">AdaptivePermSizeWeight</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="w">               </span><span class="o">{</span>product<span class="o">}</span>
uintx<span class="w"> </span><span class="nv">ErgoHeapSizeLimit</span><span class="w">                    </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w">                </span><span class="o">{</span>product<span class="o">}</span>
uintx<span class="w"> </span>InitialHeapSize<span class="w">                     </span>:<span class="o">=</span><span class="w"> </span><span class="m">16777216</span><span class="w">         </span><span class="o">{</span>product<span class="o">}</span>
uintx<span class="w"> </span><span class="nv">LargePageHeapSizeThreshold</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="m">134217728</span><span class="w">        </span><span class="o">{</span>product<span class="o">}</span>
uintx<span class="w"> </span>MaxHeapSize<span class="w">                         </span>:<span class="o">=</span><span class="w"> </span><span class="m">268435456</span><span class="w">        </span><span class="o">{</span>product<span class="o">}</span>
uintx<span class="w"> </span><span class="nv">MaxPermSize</span><span class="w">                          </span><span class="o">=</span><span class="w"> </span><span class="m">67108864</span><span class="w">         </span><span class="o">{</span>pd<span class="w"> </span>product<span class="o">}</span>
uintx<span class="w"> </span><span class="nv">PermSize</span><span class="w">                             </span><span class="o">=</span><span class="w"> </span><span class="m">12582912</span><span class="w">         </span><span class="o">{</span>pd<span class="w"> </span>product<span class="o">}</span>
java<span class="w"> </span>version<span class="w"> </span><span class="s2">"1.6.0_24"</span>
</pre></div>

<p>so with <code>-server</code> most of the memory limits and initial allocations are much
higher for this <code>java</code> version.</p>
<p>These values can change for different combinations of architecture, operating
system and jvm version however. Recent versions of the jvm have removed flags
and re-moved many of the distinctions between server and client.</p>
<p>Remember too that you can see all the details of a running <code>jvm</code> using
<code>jvisualvm</code>. This is useful if you have users who or modules which set
<code>JAVA_OPTS</code> or use scripts which change command line options. This will also
let you monitor, in real time, <em>heap</em> and <em>permgen</em> space usage along with
lots of other stats.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/java-256-bit-aes-password-based-encryption/" class="u-url">Java 256-bit AES Password-Based Encryption</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/java-256-bit-aes-password-based-encryption/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T16:50:07+08:00" itemprop="datePublished" title="2023-03-03 16:50">2023-03-03 16:50</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I need to implement 256 bit AES encryption, but all the examples I have found
online use a "KeyGenerator" to generate a 256 bit key, but I would like to use
my own passkey. How can I create my own key? I have tried padding it out to
256 bits, but then I get an error saying that the key is too long. I do have
the unlimited jurisdiction patch installed, so thats not the problem :)</p>
<p>Ie. The KeyGenerator looks like this ...</p>
<div class="code"><pre class="code literal-block"><span class="c1">// Get the KeyGenerator</span>
<span class="n">KeyGenerator</span><span class="w"> </span><span class="n">kgen</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">KeyGenerator</span><span class="p">.</span><span class="n">getInstance</span><span class="p">(</span><span class="s">"AES"</span><span class="p">);</span>
<span class="n">kgen</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span><span class="w"> </span><span class="c1">// 192 and 256 bits may not be available</span>

<span class="c1">// Generate the secret key specs.</span>
<span class="n">SecretKey</span><span class="w"> </span><span class="n">skey</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kgen</span><span class="p">.</span><span class="n">generateKey</span><span class="p">();</span>
<span class="n">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">skey</span><span class="p">.</span><span class="n">getEncoded</span><span class="p">();</span>
</pre></div>

<p>Code taken from here</p>
<p><strong>EDIT</strong></p>
<p>I was actually padding the password out to 256 bytes, not bits, which is too
long. The following is some code I am using now that I have some more
experience with this.</p>
<div class="code"><pre class="code literal-block">byte[] key = null; // TODO
byte[] input = null; // TODO
byte[] output = null;
SecretKeySpec keySpec = null;
keySpec = new SecretKeySpec(key, "AES");
Cipher cipher = Cipher.getInstance("AES/CBC/PKCS7Padding");
cipher.init(Cipher.ENCRYPT_MODE, keySpec);
output = cipher.doFinal(input)
</pre></div>

<p>The "TODO" bits you need to do yourself :-)</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Share the <code>password</code> (a <code>char[]</code>) and <code>salt</code> (a <code>byte[]</code>—8 bytes selected by a
<code>SecureRandom</code> makes a good salt—which doesn't need to be kept secret) with
the recipient out-of-band. Then to derive a good key from this information:</p>
<div class="code"><pre class="code literal-block"><span class="o">/*</span><span class="w"> </span><span class="n">Derive</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">given</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="nb">and</span><span class="w"> </span><span class="n">salt</span><span class="p">.</span><span class="w"> </span><span class="o">*/</span>
<span class="n">SecretKeyFactory</span><span class="w"> </span><span class="n">factory</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">SecretKeyFactory</span><span class="p">.</span><span class="n">getInstance</span><span class="p">(</span><span class="s">"PBKDF2WithHmacSHA256"</span><span class="p">);</span>
<span class="n">KeySpec</span><span class="w"> </span><span class="nb">spec</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">PBEKeySpec</span><span class="p">(</span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="n">salt</span><span class="p">,</span><span class="w"> </span><span class="mi">65536</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">);</span>
<span class="n">SecretKey</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">factory</span><span class="p">.</span><span class="n">generateSecret</span><span class="p">(</span><span class="nb">spec</span><span class="p">);</span>
<span class="n">SecretKey</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">SecretKeySpec</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">getEncoded</span><span class="p">(),</span><span class="w"> </span><span class="s">"AES"</span><span class="p">);</span>
</pre></div>

<p>The magic numbers (which could be defined as constants somewhere) 65536 and
256 are the key derivation iteration count and the key size, respectively.</p>
<p>The key derivation function is iterated to require significant computational
effort, and that prevents attackers from quickly trying many different
passwords. The iteration count can be changed depending on the computing
resources available.</p>
<p>The key size can be reduced to 128 bits, which is still considered "strong"
encryption, but it doesn't give much of a safety margin if attacks are
discovered that weaken AES.</p>
<p>Used with a proper block-chaining mode, the same derived key can be used to
encrypt many messages. In Cipher Block Chaining (CBC), a random initialization
vector (IV) is generated for each message, yielding different cipher text even
if the plain text is identical. CBC may not be the most secure mode available
to you (see AEAD below); there are many other modes with different security
properties, but they all use a similar random input. In any case, the outputs
of each encryption operation are the cipher text <em>and</em> the initialization
vector:</p>
<div class="code"><pre class="code literal-block"><span class="o">/*</span><span class="w"> </span><span class="n">Encrypt</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="w"> </span><span class="o">*/</span>
<span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="n">getInstance</span><span class="p">(</span><span class="s">"AES/CBC/PKCS5Padding"</span><span class="p">);</span>
<span class="n">cipher</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="n">ENCRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">);</span>
<span class="n">AlgorithmParameters</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="n">getParameters</span><span class="p">();</span>
<span class="n">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">iv</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="n">getParameterSpec</span><span class="p">(</span><span class="n">IvParameterSpec</span><span class="p">.</span><span class="n">class</span><span class="p">).</span><span class="n">getIV</span><span class="p">();</span>
<span class="n">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">ciphertext</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="n">doFinal</span><span class="p">(</span><span class="s">"Hello, World!"</span><span class="p">.</span><span class="n">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="n">UTF_8</span><span class="p">));</span>
</pre></div>

<p>Store the <code>ciphertext</code> and the <code>iv</code>. On decryption, the <code>SecretKey</code> is
regenerated in exactly the same way, using using the password with the same
salt and iteration parameters. Initialize the cipher with this key <em>and</em> the
initialization vector stored with the message:</p>
<div class="code"><pre class="code literal-block"><span class="o">/*</span><span class="w"> </span><span class="n">Decrypt</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">given</span><span class="w"> </span><span class="n">derived</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="nb">and</span><span class="w"> </span><span class="n">initialization</span><span class="w"> </span><span class="n">vector</span><span class="p">.</span><span class="w"> </span><span class="o">*/</span>
<span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="n">getInstance</span><span class="p">(</span><span class="s">"AES/CBC/PKCS5Padding"</span><span class="p">);</span>
<span class="n">cipher</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="n">DECRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">IvParameterSpec</span><span class="p">(</span><span class="n">iv</span><span class="p">));</span>
<span class="n">String</span><span class="w"> </span><span class="n">plaintext</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">cipher</span><span class="p">.</span><span class="n">doFinal</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">),</span><span class="w"> </span><span class="n">StandardCharsets</span><span class="p">.</span><span class="n">UTF_8</span><span class="p">);</span>
<span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">plaintext</span><span class="p">);</span>
</pre></div>

<hr>
<p>Java 7 included API support for AEAD cipher modes, and the "SunJCE" provider
included with OpenJDK and Oracle distributions implements these beginning with
Java 8. One of these modes is strongly recommended in place of CBC; it will
protect the integrity of the data as well as their privacy.</p>
<hr>
<p>A <code>java.security.InvalidKeyException</code> with the message "Illegal key size or
default parameters" means that the cryptography strength <em>is</em> limited; the
unlimited strength jurisdiction policy files are not in the correct location.
In a JDK, they should be placed under <code>${jdk}/jre/lib/security</code></p>
<p>Based on the problem description, it sounds like the policy files are not
correctly installed. Systems can easily have multiple Java runtimes; double-
check to make sure that the correct location is being used.</p>
<p><br></p>
<h3>Suggest</h3>
<h3>Consider using the Spring Security Crypto Module</h3>
<blockquote>
<p>The Spring Security Crypto module provides support for symmetric encryption,
key generation, and password encoding. The code is distributed as part of
the core module but has no dependencies on any other Spring Security (or
Spring) code.</p>
</blockquote>
<p>It's provides a simple abstraction for encryption and seems to match what's
required here,</p>
<blockquote>
<p>The "standard" encryption method is 256-bit AES using PKCS #5's PBKDF2
(Password-Based Key Derivation Function #2). This method requires Java 6.
The password used to generate the SecretKey should be kept in a secure place
and not be shared. The salt is used to prevent dictionary attacks against
the key in the event your encrypted data is compromised. A 16-byte random
initialization vector is also applied so each encrypted message is unique.</p>
</blockquote>
<p>A look at the internals reveals a structure similar to erickson's answer.</p>
<p>As noted in the question, this also requires the <em>Java Cryptography Extension
(JCE) Unlimited Strength Jurisdiction Policy</em> (else you'll encounter
<code>InvalidKeyException: Illegal Key Size</code>). It's downloadable for Java 6, Java 7
and Java 8.</p>
<h4>Example usage</h4>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">org.springframework.security.crypto.encrypt.Encryptors</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.encrypt.TextEncryptor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.keygen.KeyGenerators</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">CryptoExample</span> <span class="p">{</span>
    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">final</span> <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="s2">"I AM SHERLOCKED"</span><span class="p">;</span>  
        <span class="n">final</span> <span class="n">String</span> <span class="n">salt</span> <span class="o">=</span> <span class="n">KeyGenerators</span><span class="o">.</span><span class="n">string</span><span class="p">()</span><span class="o">.</span><span class="n">generateKey</span><span class="p">();</span>

        <span class="n">TextEncryptor</span> <span class="n">encryptor</span> <span class="o">=</span> <span class="n">Encryptors</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="p">);</span>      
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">"Salt: </span><span class="se">\"</span><span class="s2">"</span> <span class="o">+</span> <span class="n">salt</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">"</span><span class="p">);</span>

        <span class="n">String</span> <span class="n">textToEncrypt</span> <span class="o">=</span> <span class="s2">"*royal secrets*"</span><span class="p">;</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">"Original text: </span><span class="se">\"</span><span class="s2">"</span> <span class="o">+</span> <span class="n">textToEncrypt</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">"</span><span class="p">);</span>

        <span class="n">String</span> <span class="n">encryptedText</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">textToEncrypt</span><span class="p">);</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">"Encrypted text: </span><span class="se">\"</span><span class="s2">"</span> <span class="o">+</span> <span class="n">encryptedText</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">"</span><span class="p">);</span>

        <span class="o">//</span> <span class="n">Could</span> <span class="n">reuse</span> <span class="n">encryptor</span> <span class="n">but</span> <span class="n">wanted</span> <span class="n">to</span> <span class="n">show</span> <span class="n">reconstructing</span> <span class="n">TextEncryptor</span>
        <span class="n">TextEncryptor</span> <span class="n">decryptor</span> <span class="o">=</span> <span class="n">Encryptors</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">decryptedText</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encryptedText</span><span class="p">);</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">"Decrypted text: </span><span class="se">\"</span><span class="s2">"</span> <span class="o">+</span> <span class="n">decryptedText</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">"</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">textToEncrypt</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">decryptedText</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">"Success: decrypted text matches"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">"Failed: decrypted text does not match"</span><span class="p">);</span>
        <span class="p">}</span>       
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>And sample output,</p>
<div class="code"><pre class="code literal-block">Salt: "feacbc02a3a697b0"
Original text: "*royal secrets*"
Encrypted text: "7c73c5a83fa580b5d6f8208768adc931ef3123291ac8bc335a1277a39d256d9a" 
Decrypted text: "*royal secrets*"
Success: decrypted text matches
</pre></div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2098.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2096.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
