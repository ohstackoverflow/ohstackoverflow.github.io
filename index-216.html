<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 216) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-216.html">
<link rel="prev" href="index-217.html" type="text/html">
<link rel="next" href="index-215.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/ru-he-jiang-json-shu-ju-xie-ru-wen-jian/" class="u-url">如何将 JSON 数据写入文件？</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/ru-he-jiang-json-shu-ju-xie-ru-wen-jian/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T01:13:28+08:00" itemprop="datePublished" title="2023-02-17 01:13">2023-02-17 01:13</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>如何将存储在字典中的 JSON 数据写入<code>data</code>文件？</p>
<div class="code"><pre class="code literal-block">f = open('data.json', 'wb')
f.write(data)
</pre></div>

<p>这给出了错误：</p>
<blockquote>
<p>类型错误：必须是字符串或缓冲区，而不是字典</p>
</blockquote>
<p><br><br></p>
<h2>解答</h2>
<p><code>data</code>是一个 Python 字典。在写入之前需要将其编码为JSON。</p>
<p>使用它以获得最大兼容性（Python 2 和 3）：</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">json</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'data.json'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>

<p>在现代系统（即 Python 3 和 UTF-8 支持）上，您可以使用以下方法编写更好的文件：</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">json</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'data.json'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

<p>请参阅<code>json</code>文档。</p>
<p><br></p>
<h3>更多建议</h3>
<p>要在 Python 2 的接受答案中获取 <strong> <em>utf8</em></strong> <em>编码</em> 文件而不是 <strong> <em>ascii</em></strong> <em>编码文件，请使用：</em></p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">json</span>
<span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'data.txt'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>

<p>Python 3 中的代码更简单：</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">json</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'data.txt'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

<p>在 Windows 上，<code>encoding='utf-8'</code>参数 to<code>open</code>仍然是必需的。</p>
<p>为了避免在内存中存储数据的编码副本（结果）并在 Python 2 和 3 中<code>dumps</code>输出 <em>utf8 编码的字节串，请使用：</em></p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">codecs</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'data.txt'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getwriter</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)(</span><span class="n">f</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

<p><em>该<code>codecs.getwriter</code>调用在 Python 3 中是多余的，但在 Python 2 中是必需的</em></p>
<hr>
<p><strong>可读性和大小：</strong></p>
<p>使用<code>ensure_ascii=False</code>提供更好的可读性和更小的尺寸：</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; json.dumps({'price': '€10'})
'{"price": "\\u20ac10"}'
&gt;&gt;&gt; json.dumps({'price': '€10'}, ensure_ascii=False)
'{"price": "€10"}'

&gt;&gt;&gt; len(json.dumps({'абвгд': 1}))
37
&gt;&gt;&gt; len(json.dumps({'абвгд': 1}, ensure_ascii=False).encode('utf8'))
17
</pre></div>

<p>通过向 or的参数添加标志<code>indent=4, sort_keys=True</code>（如dinos66建议的那样）进一步提高可读性。这样，您将在 json
文件中获得一个很好的缩进排序结构，但代价是文件大小稍大。<code>dump``dumps</code></p>
<p><br><br><a href="posts/how-do-i-write-json-data-to-a-file/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/huo-qu-shu-ju-ku-zhong-suo-you-biao-de-da-xiao/" class="u-url">获取数据库中所有表的大小</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/huo-qu-shu-ju-ku-zhong-suo-you-biao-de-da-xiao/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T01:13:03+08:00" itemprop="datePublished" title="2023-02-17 01:13">2023-02-17 01:13</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>我继承了一个相当大的 SQL Server 数据库。考虑到它包含的数据，它占用的空间似乎比我预期的要多。</p>
<p>有没有一种简单的方法可以确定每个表在磁盘上占用了多少空间？</p>
<p><br><br></p>
<h2>解答</h2>
<div class="code"><pre class="code literal-block">SELECT 
    t.NAME AS TableName,
    s.Name AS SchemaName,
    p.rows,
    SUM(a.total_pages) * 8 AS TotalSpaceKB, 
    CAST(ROUND(((SUM(a.total_pages) * 8) / 1024.00), 2) AS NUMERIC(36, 2)) AS TotalSpaceMB,
    SUM(a.used_pages) * 8 AS UsedSpaceKB, 
    CAST(ROUND(((SUM(a.used_pages) * 8) / 1024.00), 2) AS NUMERIC(36, 2)) AS UsedSpaceMB, 
    (SUM(a.total_pages) - SUM(a.used_pages)) * 8 AS UnusedSpaceKB,
    CAST(ROUND(((SUM(a.total_pages) - SUM(a.used_pages)) * 8) / 1024.00, 2) AS NUMERIC(36, 2)) AS UnusedSpaceMB
FROM 
    sys.tables t
INNER JOIN      
    sys.indexes i ON t.OBJECT_ID = i.object_id
INNER JOIN 
    sys.partitions p ON i.object_id = p.OBJECT_ID AND i.index_id = p.index_id
INNER JOIN 
    sys.allocation_units a ON p.partition_id = a.container_id
LEFT OUTER JOIN 
    sys.schemas s ON t.schema_id = s.schema_id
WHERE 
    t.NAME NOT LIKE 'dt%' 
    AND t.is_ms_shipped = 0
    AND i.OBJECT_ID &gt; 255 
GROUP BY 
    t.Name, s.Name, p.Rows
ORDER BY 
    TotalSpaceMB DESC, t.Name
</pre></div>

<p><br></p>
<h3>更多建议</h3>
<p>如果您使用的是 <strong>SQL Server Management Studio</strong> (SSMS)，您可以运行 <strong>标准报告</strong> 而不是运行查询（
<em>在我的例子中返回重复行</em> ） 。 ****</p>
<ol>
<li>右键单击数据库</li>
<li>导航到 <strong>报告 &gt; 标准报告 &gt; 磁盘使用情况（按表）</strong>
</li>
</ol>
<p>注意：数据库兼容级别必须设置为 90 或更高才能正常工作。请参阅http://msdn.microsoft.com/en-
gb/library/bb510680.aspx</p>
<p>注意：此报告在使用 Azure SQL 数据库时不可用</p>
<p><br><br><a href="posts/get-size-of-all-tables-in-database/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/try-catch-jia-su-wo-de-dai-ma/" class="u-url">Try-catch 加速我的代码？</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/try-catch-jia-su-wo-de-dai-ma/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T01:12:33+08:00" itemprop="datePublished" title="2023-02-17 01:12">2023-02-17 01:12</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>我写了一些代码来测试 try-catch 的影响，但看到了一些令人惊讶的结果。</p>
<div class="code"><pre class="code literal-block"><span class="nt">static</span><span class="w"> </span><span class="nt">void</span><span class="w"> </span><span class="nt">Main</span><span class="o">(</span><span class="nt">string</span><span class="cp">[]</span><span class="w"> </span><span class="nt">args</span><span class="o">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="err">Thread.CurrentThread.Priority</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">ThreadPriority.Highest</span><span class="p">;</span>
<span class="w">    </span><span class="err">Process.GetCurrentProcess().PriorityClass</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">ProcessPriorityClass.RealTime</span><span class="p">;</span>

<span class="w">    </span><span class="err">long</span><span class="w"> </span><span class="err">start</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">0,</span><span class="w"> </span><span class="err">stop</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">0,</span><span class="w"> </span><span class="err">elapsed</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">0</span><span class="p">;</span>
<span class="w">    </span><span class="err">double</span><span class="w"> </span><span class="err">avg</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="err">long</span><span class="w"> </span><span class="err">temp</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">Fibo(1)</span><span class="p">;</span>

<span class="w">    </span><span class="err">for</span><span class="w"> </span><span class="err">(int</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">1</span><span class="p">;</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">&lt;</span><span class="w"> </span><span class="err">100000000</span><span class="p">;</span><span class="w"> </span><span class="err">i++)</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="err">start</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">Stopwatch.GetTimestamp()</span><span class="p">;</span>
<span class="w">        </span><span class="err">temp</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">Fibo(100)</span><span class="p">;</span>
<span class="w">        </span><span class="err">stop</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">Stopwatch.GetTimestamp()</span><span class="p">;</span>

<span class="w">        </span><span class="err">elapsed</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">stop</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">start</span><span class="p">;</span>
<span class="w">        </span><span class="err">avg</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">avg</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">((double)elapsed</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">avg)</span><span class="w"> </span><span class="err">/</span><span class="w"> </span><span class="err">i</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nt">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="o">(</span><span class="s2">"Elapsed: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nt">avg</span><span class="o">);</span>
<span class="w">    </span><span class="nt">Console</span><span class="p">.</span><span class="nc">ReadKey</span><span class="o">();</span>
<span class="err">}</span>

<span class="nt">static</span><span class="w"> </span><span class="nt">long</span><span class="w"> </span><span class="nt">Fibo</span><span class="o">(</span><span class="nt">int</span><span class="w"> </span><span class="nt">n</span><span class="o">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="err">long</span><span class="w"> </span><span class="err">n1</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">0,</span><span class="w"> </span><span class="err">n2</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">1,</span><span class="w"> </span><span class="err">fibo</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">0</span><span class="p">;</span>
<span class="w">    </span><span class="err">n++</span><span class="p">;</span>

<span class="w">    </span><span class="err">for</span><span class="w"> </span><span class="err">(int</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">1</span><span class="p">;</span><span class="w"> </span><span class="err">i</span><span class="w"> </span><span class="err">&lt;</span><span class="w"> </span><span class="err">n</span><span class="p">;</span><span class="w"> </span><span class="err">i++)</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="err">n1</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">n2</span><span class="p">;</span>
<span class="w">        </span><span class="err">n2</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">fibo</span><span class="p">;</span>
<span class="w">        </span><span class="err">fibo</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">n1</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">n2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nt">return</span><span class="w"> </span><span class="nt">fibo</span><span class="o">;</span>
<span class="err">}</span>
</pre></div>

<p>在我的电脑上，这始终打印出一个大约 0.96 的值。</p>
<p>当我用这样的 try-catch 块将 for 循环包装在 Fibo() 中时：</p>
<div class="code"><pre class="code literal-block"><span class="nv">static</span><span class="w"> </span><span class="nv">long</span><span class="w"> </span><span class="nv">Fibo</span><span class="ss">(</span><span class="nv">int</span><span class="w"> </span><span class="nv">n</span><span class="ss">)</span>
{
<span class="w">    </span><span class="nv">long</span><span class="w"> </span><span class="nv">n1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>,<span class="w"> </span><span class="nv">n2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>,<span class="w"> </span><span class="nv">fibo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">n</span><span class="o">++</span><span class="c1">;</span>

<span class="w">    </span><span class="nv">try</span>
<span class="w">    </span>{
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">int</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="c1">; i &lt; n; i++)</span>
<span class="w">        </span>{
<span class="w">            </span><span class="nv">n1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">n2</span><span class="c1">;</span>
<span class="w">            </span><span class="nv">n2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fibo</span><span class="c1">;</span>
<span class="w">            </span><span class="nv">fibo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">n1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">n2</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">    </span>}
<span class="w">    </span><span class="nv">catch</span><span class="w"> </span>{}

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">fibo</span><span class="c1">;</span>
}
</pre></div>

<p>现在它始终打印出 0.69...——它实际上运行得更快！但为什么？</p>
<p>注意：我使用发布配置编译它并直接运行 EXE 文件（在 Visual Studio 之外）。</p>
<p>编辑：Jon Skeet 的 <em>出色</em> 分析表明，try-catch 以某种方式导致 x86 CLR 在这种特定情况下以更有利的方式使用 CPU
寄存器（我认为我们还不明白为什么）。我证实了 Jon 的发现，即 x64 CLR 没有这种差异，而且它比 x86 CLR 更快。我还使用<code>int</code>Fibo
方法中的类型而不是<code>long</code>类型进行了测试，然后 x86 CLR 与 x64 CLR 一样快。</p>
<hr>
<p><strong>更新：</strong> 看起来这个问题已经被 Roslyn 解决了。同一台机器，相同的 CLR 版本——使用 VS 2013 编译时问题仍然如上，但使用 VS
2015 编译时问题消失。</p>
<p><br><br></p>
<h2>解答</h2>
<p>一位专门研究堆栈使用优化的Roslyn工程师查看了这个并向我报告说，C# 编译器生成局部变量存储的方式与 JIT
编译器注册的方式之间的交互似乎存在问题在相应的 x86 代码中调度。结果是在本地的加载和存储上生成次优代码。</p>
<p>由于某些我们都不清楚的原因，当 JITter 知道该块位于 try-protected 区域时，就会避免有问题的代码生成路径。</p>
<p>这很奇怪。我们将跟进 JITter 团队，看看我们是否可以输入错误，以便他们可以修复此问题。</p>
<p>此外，我们正在努力改进 Roslyn 对 C# 和 VB
编译器算法的改进，以确定何时可以将局部变量设置为“短暂的”——也就是说，只是在堆栈上压入和弹出，而不是在堆栈上分配一个特定的位置用于激活的持续时间。我们相信
JITter 将能够更好地完成寄存器分配和诸如此类的工作，如果我们给它更好的提示关于何时可以让本地人更早“死”。</p>
<p>感谢您提请我们注意此事，并对奇怪的行为表示歉意。</p>
<p><br></p>
<h3>更多建议</h3>
<p>好吧，我觉得你计时的方式很讨厌。只为整个循环计时会更明智：</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">stopwatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stopwatch</span><span class="o">.</span><span class="n">StartNew</span><span class="p">();</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100000000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Fibo</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">stopwatch</span><span class="o">.</span><span class="n">Stop</span><span class="p">();</span>
<span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s2">"Elapsed time: {0}"</span><span class="p">,</span><span class="w"> </span><span class="n">stopwatch</span><span class="o">.</span><span class="n">Elapsed</span><span class="p">);</span>
</pre></div>

<p>这样你就不会受到微小时间、浮点运算和累积误差的支配。</p>
<p>进行更改后，查看“非捕获”版本是否仍然比“捕获”版本慢。</p>
<p>编辑：好的，我自己试过了——我看到了同样的结果。很奇怪。我想知道 try/catch
是否禁用了一些错误的内联，但是使用<code>[MethodImpl(MethodImplOptions.NoInlining)]</code>代替并没有帮助......</p>
<p>基本上你需要查看 cordbg 下优化的 JITted 代码，我怀疑......</p>
<p>编辑：更多信息：</p>
<ul>
<li>将 try/catch 放在行周围<code>n++;</code>仍然可以提高性能，但不如将它放在整个块周围那么多</li>
<li>如果你捕获到一个特定的异常（<code>ArgumentException</code>在我的测试中）它仍然很快</li>
<li>如果您在 catch 块中打印异常，它仍然很快</li>
<li>如果你在 catch 块中重新抛出异常，它又会变慢</li>
<li>如果您使用 finally 块而不是 catch 块，它又会变慢</li>
<li>如果同时使用 finally 块 <em>和</em> catch 块，速度会很快</li>
</ul>
<p>诡异的...</p>
<p>编辑：好的，我们有拆卸......</p>
<p>这是使用 C# 2 编译器和 .NET 2（32 位）CLR，使用 mdbg 反汇编（因为我的机器上没有
cordbg）。即使在调试器下，我仍然看到相同的性能效果。快速版本使用一个<code>try</code>块来包围变量声明和返回语句之间的所有内容，只有一个<code>catch{}</code>处理程序。显然，慢速版本除了没有
try/catch 之外是一样的。调用代码（即 Main）在这两种情况下是相同的，并且具有相同的程序集表示形式（因此这不是内联问题）。</p>
<p>快速版本的反汇编代码：</p>
<div class="code"><pre class="code literal-block"> [0000] push        ebp
 [0001] mov         ebp,esp
 [0003] push        edi
 [0004] push        esi
 [0005] push        ebx
 [0006] sub         esp,1Ch
 [0009] xor         eax,eax
 [000b] mov         dword ptr [ebp-20h],eax
 [000e] mov         dword ptr [ebp-1Ch],eax
 [0011] mov         dword ptr [ebp-18h],eax
 [0014] mov         dword ptr [ebp-14h],eax
 [0017] xor         eax,eax
 [0019] mov         dword ptr [ebp-18h],eax
*[001c] mov         esi,1
 [0021] xor         edi,edi
 [0023] mov         dword ptr [ebp-28h],1
 [002a] mov         dword ptr [ebp-24h],0
 [0031] inc         ecx
 [0032] mov         ebx,2
 [0037] cmp         ecx,2
 [003a] jle         00000024
 [003c] mov         eax,esi
 [003e] mov         edx,edi
 [0040] mov         esi,dword ptr [ebp-28h]
 [0043] mov         edi,dword ptr [ebp-24h]
 [0046] add         eax,dword ptr [ebp-28h]
 [0049] adc         edx,dword ptr [ebp-24h]
 [004c] mov         dword ptr [ebp-28h],eax
 [004f] mov         dword ptr [ebp-24h],edx
 [0052] inc         ebx
 [0053] cmp         ebx,ecx
 [0055] jl          FFFFFFE7
 [0057] jmp         00000007
 [0059] call        64571ACB
 [005e] mov         eax,dword ptr [ebp-28h]
 [0061] mov         edx,dword ptr [ebp-24h]
 [0064] lea         esp,[ebp-0Ch]
 [0067] pop         ebx
 [0068] pop         esi
 [0069] pop         edi
 [006a] pop         ebp
 [006b] ret
</pre></div>

<p>慢速版本的反汇编代码：</p>
<div class="code"><pre class="code literal-block"> [0000] push        ebp
 [0001] mov         ebp,esp
 [0003] push        esi
 [0004] sub         esp,18h
*[0007] mov         dword ptr [ebp-14h],1
 [000e] mov         dword ptr [ebp-10h],0
 [0015] mov         dword ptr [ebp-1Ch],1
 [001c] mov         dword ptr [ebp-18h],0
 [0023] inc         ecx
 [0024] mov         esi,2
 [0029] cmp         ecx,2
 [002c] jle         00000031
 [002e] mov         eax,dword ptr [ebp-14h]
 [0031] mov         edx,dword ptr [ebp-10h]
 [0034] mov         dword ptr [ebp-0Ch],eax
 [0037] mov         dword ptr [ebp-8],edx
 [003a] mov         eax,dword ptr [ebp-1Ch]
 [003d] mov         edx,dword ptr [ebp-18h]
 [0040] mov         dword ptr [ebp-14h],eax
 [0043] mov         dword ptr [ebp-10h],edx
 [0046] mov         eax,dword ptr [ebp-0Ch]
 [0049] mov         edx,dword ptr [ebp-8]
 [004c] add         eax,dword ptr [ebp-1Ch]
 [004f] adc         edx,dword ptr [ebp-18h]
 [0052] mov         dword ptr [ebp-1Ch],eax
 [0055] mov         dword ptr [ebp-18h],edx
 [0058] inc         esi
 [0059] cmp         esi,ecx
 [005b] jl          FFFFFFD3
 [005d] mov         eax,dword ptr [ebp-1Ch]
 [0060] mov         edx,dword ptr [ebp-18h]
 [0063] lea         esp,[ebp-4]
 [0066] pop         esi
 [0067] pop         ebp
 [0068] ret
</pre></div>

<p>在每种情况下，<code>*</code>都显示调试器在简单的“单步执行”中进入的位置。</p>
<p>编辑：好的，我现在已经查看了代码，我想我可以看到每个版本是如何工作的……而且我相信较慢的版本更慢，因为它使用更少的寄存器和更多的堆栈空间。对于较小的值<code>n</code>可能会更快
- 但是当循环占用大部分时间时，它会变慢。</p>
<p>可能 try/catch 块 <em>会强制</em> 保存和恢复更多的寄存器，因此 JIT 也将它们用于循环……这恰好提高了整体性能。不清楚 JIT在“正常”代码中
<em>不使用尽可能多的寄存器是否是一个合理的决定。</em></p>
<p>编辑：刚刚在我的 x64 机器上试过这个。在此代码上，x64 CLR比 x86 CLR <em>快得多</em> （大约快 3-4 倍），并且在 x64
下，try/catch 块没有明显区别。</p>
<p><br><br><a href="posts/try-catch-speeding-up-my-code/">查看原文</a></p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-217.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-215.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
