<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1212) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1212.html">
<link rel="prev" href="index-1213.html" type="text/html">
<link rel="next" href="index-1211.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/nginx-no-www-to-www-and-www-to-no-www/" class="u-url">Nginx no-www to www and www to no-www</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/nginx-no-www-to-www-and-www-to-no-www/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T03:56:36+08:00" itemprop="datePublished" title="2023-02-18 03:56">2023-02-18 03:56</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I am using nginx on Rackspace cloud following a tutorial and having searched
the net and so far can't get this sorted.</p>
<p>I want <code>www.mysite.example</code> to go to <code>mysite.example</code> as normal in .htaccess
for SEO and other reasons.</p>
<p>My <strong>/etc/nginx/sites-available/www.example.com.vhost</strong> config:</p>
<div class="code"><pre class="code literal-block"><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">       </span><span class="n">server_name</span><span class="w"> </span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">       </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">web</span><span class="p">;</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">http_host</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"www.example.com"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                 </span><span class="n">rewrite</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">$</span><span class="n">request_uri</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
</pre></div>

<p>I have also tried</p>
<div class="code"><pre class="code literal-block"><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">       </span><span class="n">server_name</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">       </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">web</span><span class="p">;</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">http_host</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"www.example.com"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                 </span><span class="n">rewrite</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">$</span><span class="n">request_uri</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
</pre></div>

<p>I also tried. Both the second attempts give redirect loop errors.</p>
<div class="code"><pre class="code literal-block"><span class="nt">if</span><span class="w"> </span><span class="o">($</span><span class="nt">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'www.example.com'</span><span class="w"> </span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="err">rewrite</span><span class="w"> </span><span class="err">^</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="err">$</span><span class="n">uri</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>My DNS is setup as standard:</p>
<div class="code"><pre class="code literal-block">site.example 192.192.6.8 A type at 300 seconds
www.site.example 192.192.6.8 A type at 300 seconds
</pre></div>

<p>(example IPs and folders have been used for examples and to help people in
future). I use Ubuntu 11.</p>
<p><br><br></p>
<h2>Answer</h2>
<h2>HTTP Solution</h2>
<p>From the documentation, "the right way is to define a separate server for
<code>example.org</code>":</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">listen</span><span class="w">       </span><span class="err">80</span><span class="p">;</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">return</span><span class="w">       </span><span class="err">301</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">listen</span><span class="w">       </span><span class="err">80</span><span class="p">;</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">www.example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">...</span>
<span class="p">}</span>
</pre></div>

<h2>HTTPS Solution</h2>
<p>For those who want a solution including <code>https://</code>...</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">listen</span><span class="w"> </span><span class="err">80</span><span class="p">;</span>
<span class="w">        </span><span class="err">server_name</span><span class="w"> </span><span class="err">www.domain.example</span><span class="p">;</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="err">$scheme</span><span class="w"> </span><span class="err">will</span><span class="w"> </span><span class="err">get</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">http</span><span class="w"> </span><span class="err">protocol</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">301</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">best</span><span class="w"> </span><span class="err">practice</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">tablet,</span><span class="w"> </span><span class="err">phone,</span><span class="w"> </span><span class="err">desktop</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">seo</span>
<span class="w">        </span><span class="err">return</span><span class="w"> </span><span class="err">301</span><span class="w"> </span><span class="err">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//</span><span class="n">domain</span><span class="o">.</span><span class="n">example</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">listen</span><span class="w"> </span><span class="err">80</span><span class="p">;</span>
<span class="w">        </span><span class="err">server_name</span><span class="w"> </span><span class="err">domain.example</span><span class="p">;</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="err">here</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">config</span><span class="w"> </span><span class="err">file</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="err">example</span>
<span class="w">        </span><span class="err">location</span><span class="w"> </span><span class="err">/</span><span class="w"> </span><span class="err">{</span>

<span class="w">            </span><span class="err">rewrite</span><span class="w"> </span><span class="err">^/cp/login?$</span><span class="w"> </span><span class="err">/cp/login.php</span><span class="w"> </span><span class="err">last</span><span class="p">;</span>
<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="err">etc</span><span class="w"> </span><span class="err">etc...</span>

<span class="w">        </span><span class="p">}</span>
<span class="err">}</span>
</pre></div>

<p>Note: I have not originally included <code>https://</code> in my solution since we use
loadbalancers and our https:// server is a high-traffic SSL payment server: we
do not mix https:// and http://.</p>
<hr>
<p>To check the Nginx version, use <code>nginx -v</code>.</p>
<p><strong>Strip www from URL with Nginx redirect</strong></p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">www.domain.example</span><span class="p">;</span>
<span class="w">    </span><span class="err">rewrite</span><span class="w"> </span><span class="err">^(.*)</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">domain</span><span class="o">.</span><span class="n">example</span><span class="err">$</span><span class="mi">1</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">domain.example</span><span class="p">;</span>
<span class="w">    </span><span class="err">#The</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">configuration</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">here#</span>
<span class="p">}</span>
</pre></div>

<p>So you need to have TWO server codes.</p>
<p><strong>Add the www to the URL with Nginx redirect</strong></p>
<p>If what you need is the opposite, to redirect from <code>domain.example</code> to
<code>www.domain.example</code>, you can use this:</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">domain.example</span><span class="p">;</span>
<span class="w">    </span><span class="err">rewrite</span><span class="w"> </span><span class="err">^(.*)</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">example</span><span class="err">$</span><span class="mi">1</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">www.domain.example</span><span class="p">;</span>
<span class="w">    </span><span class="err">#The</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">configuration</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">here#</span>
<span class="p">}</span>
</pre></div>

<p>As you can imagine, this is just the opposite and works the same way the first
example. This way, you don't get SEO marks down, as it is complete perm
redirect and move. The no WWW is forced and the directory shown!</p>
<h3>Some of my code shown below for a better view:</h3>
<div class="code"><pre class="code literal-block"><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w">  </span><span class="n">www</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">rewrite</span><span class="w"> </span><span class="o">^</span><span class="p">(</span><span class="o">.*</span><span class="p">)</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">$</span><span class="mi">1</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">       </span><span class="n">server_name</span><span class="w"> </span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">       </span><span class="n">index</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">html</span><span class="p">;</span>
<span class="w">       </span><span class="c1">####</span>
<span class="w">       </span><span class="c1"># now pull the site from one directory #</span>
<span class="w">       </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">www</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">web</span><span class="p">;</span>
<span class="w">       </span><span class="c1"># done #</span>
<span class="w">       </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">favicon</span><span class="o">.</span><span class="n">ico</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">                </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>Actually you don't even need a rewrite.</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">#listen</span><span class="w"> </span><span class="err">80</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">default</span>
<span class="w">    </span><span class="err">server_name</span><span class="w"> </span><span class="err">www.example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">301</span><span class="w"> </span><span class="err">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">#listen</span><span class="w"> </span><span class="err">80</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">default</span>
<span class="w">    </span><span class="err">server_name</span><span class="w"> </span><span class="err">example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">##</span><span class="w"> </span><span class="err">here</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">conf...</span>
<span class="p">}</span>
</pre></div>

<p>As my answer is getting more and more up votes but the above as well. You
should never use a <code>rewrite</code> in this context. Why? Because nginx has to
process and start a search. If you use <code>return</code> (which should be available in
any nginx version) it directly stops execution. This is preferred in any
context.</p>
<p>Redirect both, non-SSL and SSL to their non-www counterpart:</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">listen</span><span class="w">               </span><span class="err">80</span><span class="p">;</span>
<span class="w">    </span><span class="err">listen</span><span class="w">               </span><span class="err">443</span><span class="w"> </span><span class="err">ssl</span><span class="p">;</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">          </span><span class="err">www.example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">ssl_certificate</span><span class="w">      </span><span class="err">path/to/cert</span><span class="p">;</span>
<span class="w">    </span><span class="err">ssl_certificate_key</span><span class="w">  </span><span class="err">path/to/key</span><span class="p">;</span>

<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">301</span><span class="w"> </span><span class="err">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">listen</span><span class="w">               </span><span class="err">80</span><span class="p">;</span>
<span class="w">    </span><span class="err">listen</span><span class="w">               </span><span class="err">443</span><span class="w"> </span><span class="err">ssl</span><span class="p">;</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">          </span><span class="err">example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">ssl_certificate</span><span class="w">      </span><span class="err">path/to/cert</span><span class="p">;</span>
<span class="w">    </span><span class="err">ssl_certificate_key</span><span class="w">  </span><span class="err">path/to/key</span><span class="p">;</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">here...</span>
<span class="p">}</span>
</pre></div>

<p>The <code>$scheme</code> variable will only contain <code>http</code> if your server is only
listening on port 80 (default) and the listen option does not contain the
<code>ssl</code> keyword. Not using the variable will not gain you any performance.</p>
<p>Note that you need even more server blocks if you use HSTS, because the HSTS
headers should not be sent over non-encrypted connections. Hence, you need
unencrypted server blocks with redirects and encrypted server blocks with
redirects and HSTS headers.</p>
<p>Redirect everything to SSL (personal config on UNIX with IPv4, IPv6, SPDY,
...):</p>
<div class="code"><pre class="code literal-block"><span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="n">Redirect</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">www</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">www</span>
<span class="err">#</span>
<span class="n">server</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w">          </span><span class="n">www</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate</span><span class="w">      </span><span class="n">ssl</span><span class="o">/</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">crt</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate_key</span><span class="w">  </span><span class="n">ssl</span><span class="o">/</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="k">key</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">*</span><span class="err">:</span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">*</span><span class="err">:</span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">spdy</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">[</span><span class="n">::</span><span class="o">]</span><span class="err">:</span><span class="mi">80</span><span class="w"> </span><span class="n">ipv6only</span><span class="o">=</span><span class="k">on</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">[</span><span class="n">::</span><span class="o">]</span><span class="err">:</span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">spdy</span><span class="w"> </span><span class="n">ipv6only</span><span class="o">=</span><span class="k">on</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="err">}</span>

<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="n">Redirect</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">encrypted</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">encrypted</span>
<span class="err">#</span>
<span class="n">server</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w">          </span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">*</span><span class="err">:</span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">[</span><span class="n">::</span><span class="o">]</span><span class="err">:</span><span class="mi">80</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="err">}</span>

<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="n">There</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="k">go</span><span class="err">!</span>
<span class="err">#</span>
<span class="n">server</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w">          </span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate</span><span class="w">      </span><span class="n">ssl</span><span class="o">/</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">crt</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate_key</span><span class="w">  </span><span class="n">ssl</span><span class="o">/</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="k">key</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">*</span><span class="err">:</span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">spdy</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">[</span><span class="n">::</span><span class="o">]</span><span class="err">:</span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">spdy</span><span class="p">;</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">rest</span><span class="w"> </span><span class="n">goes</span><span class="w"> </span><span class="n">here</span><span class="p">...</span>
<span class="err">}</span>
</pre></div>

<p>I guess you can imagine other compounds with this pattern now by yourself.</p>
<p>More of my configs? Go here and here.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/what-algorithms-compute-directions-from-point-a-to-point-b-on-a-map/" class="u-url">What algorithms compute directions from point A to point B on a map?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/what-algorithms-compute-directions-from-point-a-to-point-b-on-a-map/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T03:56:10+08:00" itemprop="datePublished" title="2023-02-18 03:56">2023-02-18 03:56</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>How do map providers (such as Google or Yahoo! Maps) suggest directions?</p>
<p>I mean, they probably have real-world data in some form, certainly including
distances but also perhaps things like driving speeds, presence of sidewalks,
train schedules, etc. But suppose the data were in a simpler format, say a
very large directed graph with edge weights reflecting distances. I want to be
able to quickly compute directions from one arbitrary point to another.
Sometimes these points will be close together (within one city) while
sometimes they will be far apart (cross-country).</p>
<p>Graph algorithms like Dijkstra's algorithm will not work because the graph is
enormous. Luckily, heuristic algorithms like A* will probably work. However,
our data is very structured, and perhaps some kind of tiered approach might
work? (For example, store precomputed directions between certain "key" points
far apart, as well as some local directions. Then directions for two far-away
points will involve local directions to a key points, global directions to
another key point, and then local directions again.)</p>
<p>What algorithms are actually used in practice?</p>
<p>PS. This question was motivated by finding quirks in online mapping
directions. Contrary to the triangle inequality, sometimes Google Maps thinks
that X-Z takes longer and is farther than using an intermediate point as in
X-Y-Z. But maybe their walking directions optimize for another parameter, too?</p>
<p>PPS. Here's another violation of the triangle inequality that suggests (to me)
that they use some kind of tiered approach: X-Z versus X-Y-Z. The former seems
to use prominent Boulevard de Sebastopol even though it's slightly out of the
way.</p>
<p><strong>Edit</strong> : Neither of these examples seem to work anymore, but both did at the
time of the original post.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Speaking as someone who spent 18 months working at a mapping company, which
included working on the routing algorithm... yes, Dijkstra's does work, with a
couple of modifications:</p>
<ul>
<li>Instead of doing Dijkstra's once from source to dest, you start at each end, and expand both sides until they meet in the middle. This eliminates roughly half the work (2<em>pi</em>(r/2)^2 vs pi*r^2).</li>
<li>To avoid exploring the back-alleys of every city between your source and destination, you can have several layers of map data: A 'highways' layer that contains only highways, a 'secondary' layer that contains only secondary streets, and so forth. Then, you explore only smaller sections of the more detailed layers, expanding as necessary. Obviously this description leaves out a lot of detail, but you get the idea.</li>
</ul>
<p>With modifications along those lines, you can do even cross-country routing in
a very reasonable timeframe.</p>
<p><br></p>
<h3>Suggest</h3>
<p>This question has been an active area of research in the last years. The main
idea is to do a <strong>preprocessing</strong> on the graph <strong>once</strong> , to <strong>speed up</strong> all
<strong>following queries</strong>. With this additional information itineraries can be
computed very fast. Still, <strong>Dijkstra's Algorithm</strong> is the basis for all
optimisations.</p>
<p><em>Arachnid</em> described the usage of bidirectional search and edge pruning based
on hierarchical information. These speedup techniques work quite well, but the
most recent algorithms outperform these techniques by all means. With current
algorithms a shortest paths can be computed in considerable less time than
<strong>one millisecond</strong> on a continental road network. A fast implementation of
the unmodified algorithm of Dijkstra needs about <strong>10 seconds</strong>.</p>
<p>The article Engineering Fast Route Planning Algorithms gives an overview of
the progress of research in that field. See the references of that paper for
further information.</p>
<p>The fastest known algorithms do not use information about the hierarchical
status of the road in the data, i.e. if it is a highway or a local road.
Instead, they compute in a preprocessing step an own hierarchy that optimised
to speed up route planning. This precomputation can then be used to prune the
search: Far away from start and destination slow roads need not be considered
during Dijkstra's Algorithm. The benefits are very good <strong>performance</strong> and a
<strong>correctness</strong> guarantee for the result.</p>
<p>The first optimised route planning algorithms dealt only with static road
networks, that means an edge in the graph has a fixed cost value. This not
true in practice, since we want to take dynamic information like traffic jams
or vehicle dependent restrictrions into account. Latest algorithms can also
deal with such issues, but there are still problems to solve and the research
is going on.</p>
<p>If you need the shortest path distances to compute a solution for the <strong>TSP</strong>
, then you are probably interested in matrices that contain all distances
between your sources and destinations. For this you could consider Computing
Many-to-Many Shortest Paths Using Highway Hierarchies. Note, that this has
been improved by newer approaches in the last 2 years.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/map-vs-object-in-javascript/" class="u-url">Map vs Object in JavaScript</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/map-vs-object-in-javascript/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T03:55:42+08:00" itemprop="datePublished" title="2023-02-18 03:55">2023-02-18 03:55</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I just discovered this feature:</p>
<blockquote>
<p>Map: Map objects are simple key/value maps.</p>
</blockquote>
<p>That confused me. Regular JavaScript objects are dictionaries, so how is a
<code>Map</code> different from a dictionary? Conceptually, they're identical (according
to another question on Stack Overflow)</p>
<p>The documentation doesn't help either:</p>
<blockquote>
<p>Map objects are collections of key/value pairs where both the keys and
values may be arbitrary ECMAScript language values. A distinct key value may
only occur in one key/value pair within the Map’s collection. Distinct key
values as discriminated using the a comparision algorithm that is selected
when the Map is created.</p>
<p>A Map object can iterate its elements in insertion order. Map object must be
implemented using either hash tables or other mechanisms that, on average,
provide access times that are sublinear on the number of elements in the
collection. The data structures used in this Map objects specification is
only intended to describe the required observable semantics of Map objects.
It is not intended to be a viable implementation model.</p>
</blockquote>
<p>…still sounds like an object to me, so clearly I've missed something.</p>
<p>Why is JavaScript gaining a (well-supported) <code>Map</code> object? What does it do?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>According to MDN:</p>
<blockquote>
<p>A Map object can iterate its elements in insertion order - a <code>for..of</code> loop
will return an array of [key, value] for each iteration.</p>
</blockquote>
<p>and</p>
<blockquote>
<p>Objects are similar to Maps in that both let you set keys to values,
retrieve those values, delete keys, and detect whether something is stored
at a key. Because of this, Objects have been used as Maps historically;
however, there are important differences between Objects and Maps that make
using a Map better.</p>
<p>An Object has a prototype, so there are default keys in the map. However,
this can be bypassed using map = Object.create(null). The keys of an Object
are Strings, where they can be any value for a Map. You can get the size of
a Map easily while you have to manually keep track of size for an Object.</p>
</blockquote>
<p><em>Map</em></p>
<p>The iterability-in-order is a feature that has long been wanted by developers,
in part because it ensures the same performance in all browsers. So to me
that's a big one.</p>
<p>The <code>myMap.has(key)</code> method will be especially handy, and also the
<code>myMap.size</code> property.</p>
<p><br></p>
<h3>Suggest</h3>
<p>The key difference is that Objects only support string and Symbol keys where
as Maps support more or less any key type.</p>
<p>If I do <code>obj[123] = true</code> and then <code>Object.keys(obj)</code> then I will get
<code>["123"]</code> rather than <code>[123]</code>. A Map would preserve the type of the key and
return <code>[123]</code> which is great. Maps also allow you to use Objects as keys.
Traditionally to do this you would have to give objects some kind of unique
identifier to hash them (I don't think I've ever seen anything like
<code>getObjectId</code> in JavaScript as part of the standard). Maps also guarantee
preservation of order so are all round better for preservation and can
sometimes save you needing to do a few sorts.</p>
<p>Between maps and objects in practice there are several pros and cons. Objects
gain both advantages and disadvantages being very tightly integrated into the
core of JavaScript which sets them apart from significantly Map beyond the
difference in key support.</p>
<p>An immediate advantage is that you have syntactical support for Objects making
it easy to access elements. You also have direct support for it with JSON.
When used as a hash it's annoying to get an object without any properties at
all. By default if you want to use Objects as a hash table they will be
polluted and you will often have to call <code>hasOwnProperty</code> on them when
accessing properties. You can see here how by default Objects are polluted and
how to create hopefully unpolluted objects for use as hashes:</p>
<div class="code"><pre class="code literal-block"><span class="p">({}).</span><span class="n">toString</span>
<span class="w">    </span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="n">native</span><span class="w"> </span><span class="n">code</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="n">JSON</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="err">'</span><span class="p">{}</span><span class="err">'</span><span class="p">).</span><span class="n">toString</span>
<span class="w">    </span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="n">native</span><span class="w"> </span><span class="n">code</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="p">(</span><span class="n">Object</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">null</span><span class="p">)).</span><span class="n">toString</span>
<span class="w">    </span><span class="n">undefined</span>
<span class="n">JSON</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="err">'</span><span class="p">{}</span><span class="err">'</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">typeof</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="err">'</span><span class="n">object</span><span class="err">'</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="n">setPrototypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">null</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="n">v</span><span class="p">)).</span><span class="n">toString</span>
<span class="w">    </span><span class="n">undefined</span>
</pre></div>

<p>Pollution on objects is not only something that makes code more annoying,
slower, etc., but can also have potential consequences for security.</p>
<p>Objects are not pure hash tables, but they are trying to do more. You have
headaches like <code>hasOwnProperty</code>, not being able to get the length easily
(<code>Object.keys(obj).length</code>) and so on. Objects are not meant to purely be used
as hash maps, but as dynamic extensible Objects as well and so when you use
them as pure hash tables problems arise.</p>
<p>Comparison/List of various common operations:</p>
<div class="code"><pre class="code literal-block"><span class="k">Object</span><span class="err">:</span>
<span class="w">   </span><span class="nf">var</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{}</span><span class="p">;</span>
<span class="w">   </span><span class="nf">var</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">Object</span><span class="p">.</span><span class="k">create</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>
<span class="w">   </span><span class="n">o</span><span class="p">.</span><span class="k">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">   </span><span class="n">o</span><span class="p">.</span><span class="k">key</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="n">o</span><span class="o">[</span><span class="n">k</span><span class="o">]++</span><span class="p">;</span>
<span class="w">   </span><span class="nf">var</span><span class="w"> </span><span class="nf">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">Object</span><span class="p">.</span><span class="k">values</span><span class="p">(</span><span class="n">m</span><span class="p">))</span><span class="w"> </span><span class="nf">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="s1">'key'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">o</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">hasOwnProperty</span><span class="p">(</span><span class="s1">'key'</span><span class="p">));</span>
<span class="w">   </span><span class="k">delete</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="k">key</span><span class="p">);</span>
<span class="w">   </span><span class="k">Object</span><span class="p">.</span><span class="n">keys</span><span class="p">(</span><span class="n">o</span><span class="p">).</span><span class="n">length</span>
<span class="k">Map</span><span class="err">:</span>
<span class="w">   </span><span class="nf">var</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">Map</span><span class="p">();</span>
<span class="w">   </span><span class="n">m</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="s1">'key'</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">   </span><span class="n">m</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="s1">'key'</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s1">'key'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="w">   </span><span class="n">m</span><span class="p">.</span><span class="n">foreach</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">   </span><span class="nf">var</span><span class="w"> </span><span class="nf">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">values</span><span class="p">())</span><span class="w"> </span><span class="nf">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">has</span><span class="p">(</span><span class="s1">'key'</span><span class="p">));</span>
<span class="w">   </span><span class="n">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'key'</span><span class="p">);</span>
<span class="w">   </span><span class="n">m</span><span class="p">.</span><span class="k">size</span><span class="p">();</span>
</pre></div>

<p>There are a few other options, approaches, methodologies, etc. with varying
ups and downs (performance, terse, portable, extendable, etc.). Objects are a
bit strange being core to the language so you have a lot of static methods for
working with them.</p>
<p>Besides the advantage of Maps preserving key types as well as being able to
support things like objects as keys they are isolated from the side effects
that objects much have. A Map is a pure hash, there's no confusion about
trying to be an object at the same time. Maps can also be easily extended with
proxy functions. Object's currently have a Proxy class however performance and
memory usage is grim, in fact creating your own proxy that looks like Map for
Objects currently performs better than Proxy.</p>
<p>A substantial disadvantage for Maps is that they are not supported with JSON
directly. Parsing is possible, but it has several hangups:</p>
<div class="code"><pre class="code literal-block"><span class="n">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nf">str</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">typeof</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">'object'</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="w">    </span><span class="n">let</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">Map</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="o">[</span><span class="n">k</span><span class="o">]</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="err">}</span><span class="p">);</span>
</pre></div>

<p>The above will introduce a serious performance hit and will also not support
any string keys. JSON encoding is even more difficult and problematic (this is
one of many approaches):</p>
<div class="code"><pre class="code literal-block"><span class="c1">// An alternative to this it to use a replacer in JSON.stringify.</span>
<span class="n">Map</span><span class="p">.</span><span class="n">prototype</span><span class="p">.</span><span class="n">toJSON</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="n">stringify</span><span class="p">({</span>
<span class="w">        </span><span class="n">keys</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">keys</span><span class="p">()),</span>
<span class="w">        </span><span class="n">values</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">values</span><span class="p">())</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">};</span>
</pre></div>

<p>This is not so bad if you're purely using Maps, but it will have problems when
you are mixing types or using non-scalar values as keys (not that JSON is
perfect with that kind of issue as it is, IE circular object reference). I
haven't tested it, but chances are that it will severely hurt performance
compared to stringify.</p>
<p>Other scripting languages often don't have such problems as they have explicit
non-scalar types for Map, Object and Array. Web development is often a pain
with non-scalar types where you have to deal with things like PHP merges
Array/Map with Object using A/M for properties and JavaScript merges
Map/Object with Array extending M/O. Merging complex types is the devil's bane
of high level scripting languages.</p>
<p>So far these are largely issues around implementation, but performance for
basic operations is important as well. Performance is also complex because it
depends on engine and usage. Take my tests with a grain of salt as I cannot
rule out any mistake (I have to rush this). You should also run your own tests
to confirm as mine examine only very specific simple scenarios to give a rough
indication only. According to tests in Chrome for very large objects/maps the
performance for objects is worse because of delete which is apparently somehow
proportionate to the number of keys rather than O(1):</p>
<div class="code"><pre class="code literal-block">Object Set Took: 146
Object Update Took: 7
Object Get Took: 4
Object Delete Took: 8239
Map Set Took: 80
Map Update Took: 51
Map Get Took: 40
Map Delete Took: 2
</pre></div>

<p>Chrome clearly has a strong advantage with getting and updating, but the
delete performance is horrific. Maps use a tiny amount more memory in this
case (overhead), but with only one Object/Map being tested with millions of
keys the impact of overhead for maps is not expressed well. With memory
management objects also do seem to free earlier if I am reading the profile
correctly which might be one benefit in favor of objects.</p>
<p>In Firefox for this particular benchmark it is a different story:</p>
<div class="code"><pre class="code literal-block">Object Set Took: 435
Object Update Took: 126
Object Get Took: 50
Object Delete Took: 2
Map Set Took: 63
Map Update Took: 59
Map Get Took: 33
Map Delete Took: 1
</pre></div>

<p>I should immediately point out that in this particular benchmark deleting from
objects in Firefox is not causing any problems, however in other benchmarks it
has caused problems especially when there are many keys just as in Chrome.
Maps are clearly superior in Firefox for large collections.</p>
<p>However this is not the end of the story, what about many small objects or
maps? I have done a quick benchmark of this, but not an exhaustive one
(setting/getting) of which performs best with a small number of keys in the
above operations. This test is more about memory and initialization.</p>
<div class="code"><pre class="code literal-block">Map Create: 69    // new Map
Object Create: 34 // {}
</pre></div>

<p>Again these figures vary, but basically Object has a good lead. In some cases
the lead for Objects over maps is extreme (~10 times better), but on average
it was around 2-3 times better. It seems extreme performance spikes can work
both ways. I only tested this in Chrome and creation to profile memory usage
and overhead. I was quite surprised to see that in Chrome it appears that Maps
with one key use around 30 times more memory than Objects with one key.</p>
<p>For testing many small objects with all the above operations (4 keys):</p>
<div class="code"><pre class="code literal-block">Chrome Object Took: 61
Chrome Map Took: 67
Firefox Object Took: 54
Firefox Map Took: 139
</pre></div>

<p>In terms of memory allocation these behaved the same in terms of freeing/GC,
but Map used five times more memory. This test used four keys where as in the
last test I only set one key so this would explain the reduction in memory
overhead. I ran this test a few times and Map/Object are more or less neck and
neck overall for Chrome in terms of overall speed. In Firefox for small
Objects there is a definite performance advantage over maps overall.</p>
<p>This of course doesn't include the individual options which could vary wildly.
I would not advice micro-optimizing with these figures. What you can get out
of this is that as a rule of thumb, consider Maps more strongly for very large
key value stores and objects for small key value stores.</p>
<p>Beyond that the best strategy with these two it to implement it and just make
it work first. When profiling it is important to keep in mind that sometimes
things that you wouldn't think would be slow when looking at them can be
incredibly slow because of engine quirks as seen with the object key deletion
case.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1213.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1211.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
