<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 54) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-54.html">
<link rel="prev" href="index-55.html" type="text/html">
<link rel="next" href="index-53.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/zui-bu-liang-ya-he-ke-bian-mo-ren-can-shu/" class="u-url">“最不惊讶”和可变默认参数</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/zui-bu-liang-ya-he-ke-bian-mo-ren-can-shu/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T19:50:10+08:00" itemprop="datePublished" title="2023-02-16 19:50">2023-02-16 19:50</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>任何长期使用 Python 的人都会被以下问题困扰（或撕成碎片）：</p>
<div class="code"><pre class="code literal-block"><span class="nv">def</span><span class="w"> </span><span class="nv">foo</span><span class="ss">(</span><span class="nv">a</span><span class="o">=</span>[]<span class="ss">)</span>:
<span class="w">    </span><span class="nv">a</span>.<span class="nv">append</span><span class="ss">(</span><span class="mi">5</span><span class="ss">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">a</span>
</pre></div>

<p>Python 新手会期望这个不带参数调用的函数总是返回只有一个元素的列表：<code>[5]</code>。结果却截然不同，而且非常令人惊讶（对于新手而言）：</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; foo()
[5]
&gt;&gt;&gt; foo()
[5, 5]
&gt;&gt;&gt; foo()
[5, 5, 5]
&gt;&gt;&gt; foo()
[5, 5, 5, 5]
&gt;&gt;&gt; foo()
</pre></div>

<p>我的一位经理曾经第一次遇到这个功能，并称其为该语言的“戏剧性设计缺陷”。我回答说这个行为是有原因的，如果不了解内部结构，确实很费解和意想不到。但是，我无法（对自己）回答以下问题：在函数定义时而不是在函数执行时绑定默认参数的原因是什么？我怀疑经验丰富的行为是否具有实际用途（谁真正在
C 中使用了静态变量，而没有滋生错误？）</p>
<p><strong>编辑</strong> ：</p>
<p>Baczek 举了一个有趣的例子。结合您的大部分评论，尤其是 Utaal 的评论，我进一步阐述了：</p>
<div class="code"><pre class="code literal-block"><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">def</span><span class="w"> </span><span class="nv">a</span><span class="ss">()</span>:
...<span class="w">     </span><span class="nv">print</span><span class="ss">(</span><span class="s2">"a executed"</span><span class="ss">)</span>
...<span class="w">     </span><span class="k">return</span><span class="w"> </span>[]
...<span class="w"> </span>
<span class="o">&gt;&gt;&gt;</span><span class="w">            </span>
<span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">def</span><span class="w"> </span><span class="nv">b</span><span class="ss">(</span><span class="nv">x</span><span class="o">=</span><span class="nv">a</span><span class="ss">())</span>:
...<span class="w">     </span><span class="nv">x</span>.<span class="nv">append</span><span class="ss">(</span><span class="mi">5</span><span class="ss">)</span>
...<span class="w">     </span><span class="nv">print</span><span class="ss">(</span><span class="nv">x</span><span class="ss">)</span>
...<span class="w"> </span>
<span class="nv">a</span><span class="w"> </span><span class="nv">executed</span>
<span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">b</span><span class="ss">()</span>
[<span class="mi">5</span>]
<span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">b</span><span class="ss">()</span>
[<span class="mi">5</span>,<span class="w"> </span><span class="mi">5</span>]
</pre></div>

<p>在我看来，设计决策似乎与将参数范围放在哪里有关：在函数内部，还是与它“在一起”？</p>
<p>在函数内部进行绑定意味着<code>x</code>当函数被调用而不是定义时它被有效地绑定到指定的默认值，这会带来一个严重的缺陷：<code>def</code>从某种意义上说，该行将是“混合”的一部分绑定（函数对象）将发生在定义时，部分（默认参数的分配）发生在函数调用时。</p>
<p>实际行为更加一致：当该行被执行时，该行的所有内容都会被评估，这意味着在函数定义时。</p>
<p><br><br></p>
<h2>解答</h2>
<p>实际上，这不是设计缺陷，也不是内部结构或性能问题。它只是因为 Python 中的函数是一流的对象，而不仅仅是一段代码。</p>
<p>一旦你这样想，它就完全有道理了：函数是一个根据其定义求值的对象；默认参数是一种“成员数据”，因此它们的状态可能会从一个调用更改为另一个调用 -
与任何其他对象完全一样。</p>
<p>无论如何，effbot (Fredrik Lundh) 在Python
中的默认参数值中对这种行为的原因进行了很好的解释。我发现它非常清楚，我真的建议阅读它以更好地了解函数对象的工作原理。</p>
<p><br></p>
<h3>更多建议</h3>
<p>假设你有以下代码</p>
<div class="code"><pre class="code literal-block">fruits = ("apples", "bananas", "loganberries")

def eat(food=fruits):
    ...
</pre></div>

<p>当我看到 eat 的声明时，最不令人惊讶的是认为如果没有给出第一个参数，它将等于元组<code>("apples", "bananas",
"loganberries")</code></p>
<p>但是，假设稍后在代码中，我做了类似的事情</p>
<div class="code"><pre class="code literal-block">def some_random_function():
    global fruits
    fruits = ("blueberries", "mangos")
</pre></div>

<p>那么如果默认参数是在函数执行时绑定的而不是函数声明时，我会惊讶地（以一种非常糟糕的方式）发现 fruits
已经被改变了。这比发现你<code>foo</code>上面的函数正在改变列表更令人惊讶的 IMO。</p>
<p>真正的问题在于可变变量，所有语言都在某种程度上存在这个问题。这是一个问题：假设在 Java 中我有以下代码：</p>
<div class="code"><pre class="code literal-block">StringBuffer s = new StringBuffer("Hello World!");
Map&lt;StringBuffer,Integer&gt; counts = new HashMap&lt;StringBuffer,Integer&gt;();
counts.put(s, 5);
s.append("!!!!");
System.out.println( counts.get(s) );  // does this work?
</pre></div>

<p><code>StringBuffer</code>现在，我的地图是在将其放入地图时使用键的值，还是通过引用存储键？无论哪种方式，有人感到惊讶。要么是试图使用与<code>Map</code>放入对象的值相同的值将对象从对象中取出的人，要么是即使他们使用的键实际上是同一个对象但似乎无法检索对象的人用于将其放入映射中（这实际上是
Python 不允许将其可变内置数据类型用作字典键的原因）。</p>
<p>你的例子是 Python
新手会感到惊讶和被咬的一个很好的例子。但我认为，如果我们“解决”这个问题，那只会造成一种不同的情况，他们反而会被咬，而且这种情况会更不直观。此外，在处理可变变量时总是如此；您总是会遇到这样的情况，即某人可以根据他们正在编写的代码直观地期望一种或相反的行为。</p>
<p>我个人喜欢 Python
当前的方法：在定义函数时评估默认函数参数，并且该对象始终是默认值。我想他们可以使用一个空列表作为特殊情况，但那种特殊情况会引起更多的惊讶，更不用说向后不兼容了。</p>
<p><br><br><a href="posts/least-astonishment-and-the-mutable-default-argument/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/ti-gao-sqlite-de-mei-miao-cha-ru-xing-neng/" class="u-url">提高 SQLite 的每秒插入性能</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/ti-gao-sqlite-de-mei-miao-cha-ru-xing-neng/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T19:49:28+08:00" itemprop="datePublished" title="2023-02-16 19:49">2023-02-16 19:49</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>优化 SQLite 很棘手。C 应用程序的批量插入性能从每秒 85 次插入到每秒超过 96,000 次插入不等！</p>
<p><strong>背景：</strong> 我们将 SQLite 用作桌面应用程序的一部分。我们有大量的配置数据存储在 XML 文件中，当应用程序初始化时，这些文件被解析并加载到
SQLite 数据库中以供进一步处理。SQLite 非常适合这种情况，因为它速度快，不需要专门的配置，并且数据库作为单个文件存储在磁盘上。</p>
<p><strong>理由：</strong> <em>最初我对所看到的性能感到失望。</em> 事实证明，SQLite
的性能可能会有很大差异（对于批量插入和选择），具体取决于数据库的配置方式以及您使用 API
的方式。弄清楚所有选项和技术是什么不是一件小事，因此我认为创建此社区 wiki 条目以与 Stack Overflow
读者分享结果以避免其他人进行相同调查的麻烦是明智的。</p>
<p><strong>实验：</strong> 与其简单地谈论一般意义上的性能提示（即 <em>“使用事务！”</em> ），我认为最好编写一些 C 代码并 <em>实际测量</em>
各种选项的影响。我们将从一些简单的数据开始：</p>
<ul>
<li>多伦多市完整公交时间表的 28 MB 制表符分隔文本文件（约 865,000 条记录）</li>
<li>我的测试机器是运行 Windows XP 的 3.60 GHz P4。</li>
<li>代码使用Visual C++ 2005 编译为“Release”，具有“Full Optimization”(/Ox) 和 Favor Fast Code (/Ot)。</li>
<li>我正在使用直接编译到我的测试应用程序中的 SQLite“Amalgamation”。我碰巧拥有的 SQLite 版本有点旧（3.6.7），但我怀疑这些结果与最新版本相当（如果您有不同看法，请发表评论）。</li>
</ul>
<p><em>让我们写一些代码吧！</em></p>
<p><strong>代码：</strong> 一个简单的 C 程序，逐行读取文本文件，将字符串拆分为值，然后将数据插入 SQLite
数据库。在此代码的“基线”版本中，创建了数据库，但实际上我们不会插入数据：</p>
<div class="code"><pre class="code literal-block"><span class="cm">/*************************************************************</span>
<span class="cm">    Baseline code to experiment with SQLite performance.</span>

<span class="cm">    Input data is a 28 MB TAB-delimited text file of the</span>
<span class="cm">    complete Toronto Transit System schedule/route info</span>
<span class="cm">    from http://www.toronto.ca/open/datasets/ttc-routes/</span>

<span class="cm">**************************************************************/</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">time</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">string</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="ss">"sqlite3.h"</span>

<span class="n">#define</span><span class="w"> </span><span class="n">INPUTDATA</span><span class="w"> </span><span class="ss">"C:\\TTC_schedule_scheduleitem_10-27-2009.txt"</span>
<span class="n">#define</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="ss">"c:\\TTC_schedule_scheduleitem_10-27-2009.sqlite"</span>
<span class="n">#define</span><span class="w"> </span><span class="nc">TABLE</span><span class="w"> </span><span class="ss">"CREATE TABLE IF NOT EXISTS TTC (id INTEGER PRIMARY KEY, Route_ID TEXT, Branch_Code TEXT, Version INTEGER, Stop INTEGER, Vehicle_Index INTEGER, Day Integer, Time TEXT)"</span>
<span class="n">#define</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="w"> </span><span class="mi">256</span>

<span class="nc">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="nc">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>

<span class="w">    </span><span class="n">sqlite3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">db</span><span class="p">;</span>
<span class="w">    </span><span class="n">sqlite3_stmt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">stmt</span><span class="p">;</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sErrMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">nRetCode</span><span class="p">;</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">clock_t</span><span class="w"> </span><span class="n">cStartClock</span><span class="p">;</span>

<span class="w">    </span><span class="k">FILE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pFile</span><span class="p">;</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="n">sInputBuf</span><span class="w"> </span><span class="o">[</span><span class="n">BUFFER_SIZE</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"\0"</span><span class="p">;</span>

<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sRT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Route */</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sBR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Branch */</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sVR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Version */</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Stop Number */</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sVI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Vehicle */</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sDT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Date */</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sTM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Time */</span>

<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="n">sSQL</span><span class="w"> </span><span class="o">[</span><span class="n">BUFFER_SIZE</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"\0"</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*********************************************/</span>
<span class="w">    </span><span class="cm">/* Open the Database and create the Schema */</span>
<span class="w">    </span><span class="n">sqlite3_open</span><span class="p">(</span><span class="k">DATABASE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">db</span><span class="p">);</span>
<span class="w">    </span><span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="w"> </span><span class="nc">TABLE</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*********************************************/</span>
<span class="w">    </span><span class="cm">/* Open input file and import into Database*/</span>
<span class="w">    </span><span class="n">cStartClock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock</span><span class="p">();</span>

<span class="w">    </span><span class="n">pFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="w"> </span><span class="p">(</span><span class="n">INPUTDATA</span><span class="p">,</span><span class="ss">"r"</span><span class="p">);</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">feof</span><span class="p">(</span><span class="n">pFile</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>

<span class="w">        </span><span class="n">fgets</span><span class="w"> </span><span class="p">(</span><span class="n">sInputBuf</span><span class="p">,</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">pFile</span><span class="p">);</span>

<span class="w">        </span><span class="n">sRT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="w"> </span><span class="p">(</span><span class="n">sInputBuf</span><span class="p">,</span><span class="w"> </span><span class="ss">"\t"</span><span class="p">);</span><span class="w">     </span><span class="cm">/* Get Route */</span>
<span class="w">        </span><span class="n">sBR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="w"> </span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="ss">"\t"</span><span class="p">);</span><span class="w">            </span><span class="cm">/* Get Branch */</span>
<span class="w">        </span><span class="n">sVR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="w"> </span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="ss">"\t"</span><span class="p">);</span><span class="w">            </span><span class="cm">/* Get Version */</span>
<span class="w">        </span><span class="n">sST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="w"> </span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="ss">"\t"</span><span class="p">);</span><span class="w">            </span><span class="cm">/* Get Stop Number */</span>
<span class="w">        </span><span class="n">sVI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="w"> </span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="ss">"\t"</span><span class="p">);</span><span class="w">            </span><span class="cm">/* Get Vehicle */</span>
<span class="w">        </span><span class="n">sDT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="w"> </span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="ss">"\t"</span><span class="p">);</span><span class="w">            </span><span class="cm">/* Get Date */</span>
<span class="w">        </span><span class="n">sTM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="w"> </span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="ss">"\t"</span><span class="p">);</span><span class="w">            </span><span class="cm">/* Get Time */</span>

<span class="w">        </span><span class="cm">/* ACTUAL INSERT WILL GO HERE */</span>

<span class="w">        </span><span class="n">n</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="n">fclose</span><span class="w"> </span><span class="p">(</span><span class="n">pFile</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="ss">"Imported %d records in %4.2f seconds\n"</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">clock</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cStartClock</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="k">double</span><span class="p">)</span><span class="n">CLOCKS_PER_SEC</span><span class="p">);</span>

<span class="w">    </span><span class="n">sqlite3_close</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="err">}</span>
</pre></div>

<hr>
<h3>“控制”</h3>
<p>按原样运行代码实际上不会执行任何数据库操作，但它会让我们了解原始 C 文件 I/O 和字符串处理操作的速度有多快。</p>
<blockquote>
<p>在 0.94 秒内导入 864913 条记录</p>
</blockquote>
<p>伟大的！我们每秒可以执行 920,000 次插入，前提是我们实际上不执行任何插入:-)</p>
<hr>
<h3>“最坏情况”</h3>
<p>我们将使用从文件中读取的值生成 SQL 字符串，并使用 sqlite3_exec 调用该 SQL 操作：</p>
<div class="code"><pre class="code literal-block"><span class="k">sprintf</span><span class="ss">(</span><span class="nv">sSQL</span>,<span class="w"> </span><span class="s2">"INSERT INTO TTC VALUES (NULL, '%s', '%s', '%s', '%s', '%s', '%s', '%s')"</span>,<span class="w"> </span><span class="nv">sRT</span>,<span class="w"> </span><span class="nv">sBR</span>,<span class="w"> </span><span class="nv">sVR</span>,<span class="w"> </span><span class="nv">sST</span>,<span class="w"> </span><span class="nv">sVI</span>,<span class="w"> </span><span class="nv">sDT</span>,<span class="w"> </span><span class="nv">sTM</span><span class="ss">)</span><span class="c1">;</span>
<span class="nv">sqlite3_exec</span><span class="ss">(</span><span class="nv">db</span>,<span class="w"> </span><span class="nv">sSQL</span>,<span class="w"> </span><span class="nv">NULL</span>,<span class="w"> </span><span class="nv">NULL</span>,<span class="w"> </span><span class="o">&amp;</span><span class="nv">sErrMsg</span><span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p>这会很慢，因为 SQL 将被编译为每次插入的 VDBE 代码，并且每次插入都将在其自己的事务中发生。 <em>有多慢？</em></p>
<blockquote>
<p>在 9933.61 秒内导入了 864913 条记录</p>
</blockquote>
<p>哎呀！2小时45分钟！ <strong>每秒</strong> 只有85 次插入。 ****</p>
<h3>使用事务</h3>
<p>默认情况下，SQLite 将评估唯一事务中的每个 INSERT / UPDATE 语句。如果执行大量插入，建议将您的操作包装在事务中：</p>
<div class="code"><pre class="code literal-block"><span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"BEGIN TRANSACTION"</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>

<span class="n">pFile</span> <span class="o">=</span> <span class="n">fopen</span> <span class="p">(</span><span class="n">INPUTDATA</span><span class="p">,</span><span class="s">"r"</span><span class="p">);</span>
<span class="n">while</span> <span class="p">(</span><span class="err">!</span><span class="n">feof</span><span class="p">(</span><span class="n">pFile</span><span class="p">))</span> <span class="p">{</span>

    <span class="p">...</span>

<span class="p">}</span>
<span class="n">fclose</span> <span class="p">(</span><span class="n">pFile</span><span class="p">);</span>

<span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"END TRANSACTION"</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
</pre></div>

<blockquote>
<p>在 38.03 秒内导入 864913 条记录</p>
</blockquote>
<p>那更好。只需将我们所有的插入都包装在一个事务中，就可以将我们的性能提高到 <strong>每秒 23,000 次插入。</strong></p>
<h3>使用准备好的语句</h3>
<p>使用事务是一个巨大的改进，但如果我们反复使用相同的 SQL，则为每个插入重新编译 SQL
语句没有意义。让我们使用<code>sqlite3_prepare_v2</code>一次编译我们的 SQL
语句，然后使用以下方法将我们的参数绑定到该语句<code>sqlite3_bind_text</code>：</p>
<div class="code"><pre class="code literal-block"><span class="o">/*</span> <span class="n">Open</span> <span class="nb">input</span> <span class="n">file</span> <span class="ow">and</span> <span class="kn">import</span> <span class="nn">into</span> <span class="n">the</span> <span class="n">database</span> <span class="o">*/</span>
<span class="n">cStartClock</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>

<span class="n">sprintf</span><span class="p">(</span><span class="n">sSQL</span><span class="p">,</span> <span class="s2">"INSERT INTO TTC VALUES (NULL, @RT, @BR, @VR, @ST, @VI, @DT, @TM)"</span><span class="p">);</span>
<span class="n">sqlite3_prepare_v2</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>  <span class="n">sSQL</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tail</span><span class="p">);</span>

<span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s2">"BEGIN TRANSACTION"</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>

<span class="n">pFile</span> <span class="o">=</span> <span class="n">fopen</span> <span class="p">(</span><span class="n">INPUTDATA</span><span class="p">,</span><span class="s2">"r"</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="err">!</span><span class="n">feof</span><span class="p">(</span><span class="n">pFile</span><span class="p">))</span> <span class="p">{</span>

    <span class="n">fgets</span> <span class="p">(</span><span class="n">sInputBuf</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="n">pFile</span><span class="p">);</span>

    <span class="n">sRT</span> <span class="o">=</span> <span class="n">strtok</span> <span class="p">(</span><span class="n">sInputBuf</span><span class="p">,</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">);</span>   <span class="o">/*</span> <span class="n">Get</span> <span class="n">Route</span> <span class="o">*/</span>
    <span class="n">sBR</span> <span class="o">=</span> <span class="n">strtok</span> <span class="p">(</span><span class="n">NULL</span><span class="p">,</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">);</span>        <span class="o">/*</span> <span class="n">Get</span> <span class="n">Branch</span> <span class="o">*/</span>
    <span class="n">sVR</span> <span class="o">=</span> <span class="n">strtok</span> <span class="p">(</span><span class="n">NULL</span><span class="p">,</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">);</span>        <span class="o">/*</span> <span class="n">Get</span> <span class="n">Version</span> <span class="o">*/</span>
    <span class="n">sST</span> <span class="o">=</span> <span class="n">strtok</span> <span class="p">(</span><span class="n">NULL</span><span class="p">,</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">);</span>        <span class="o">/*</span> <span class="n">Get</span> <span class="n">Stop</span> <span class="n">Number</span> <span class="o">*/</span>
    <span class="n">sVI</span> <span class="o">=</span> <span class="n">strtok</span> <span class="p">(</span><span class="n">NULL</span><span class="p">,</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">);</span>        <span class="o">/*</span> <span class="n">Get</span> <span class="n">Vehicle</span> <span class="o">*/</span>
    <span class="n">sDT</span> <span class="o">=</span> <span class="n">strtok</span> <span class="p">(</span><span class="n">NULL</span><span class="p">,</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">);</span>        <span class="o">/*</span> <span class="n">Get</span> <span class="n">Date</span> <span class="o">*/</span>
    <span class="n">sTM</span> <span class="o">=</span> <span class="n">strtok</span> <span class="p">(</span><span class="n">NULL</span><span class="p">,</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">);</span>        <span class="o">/*</span> <span class="n">Get</span> <span class="n">Time</span> <span class="o">*/</span>

    <span class="n">sqlite3_bind_text</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sRT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SQLITE_TRANSIENT</span><span class="p">);</span>
    <span class="n">sqlite3_bind_text</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sBR</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SQLITE_TRANSIENT</span><span class="p">);</span>
    <span class="n">sqlite3_bind_text</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sVR</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SQLITE_TRANSIENT</span><span class="p">);</span>
    <span class="n">sqlite3_bind_text</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sST</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SQLITE_TRANSIENT</span><span class="p">);</span>
    <span class="n">sqlite3_bind_text</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sVI</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SQLITE_TRANSIENT</span><span class="p">);</span>
    <span class="n">sqlite3_bind_text</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">sDT</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SQLITE_TRANSIENT</span><span class="p">);</span>
    <span class="n">sqlite3_bind_text</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">sTM</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SQLITE_TRANSIENT</span><span class="p">);</span>

    <span class="n">sqlite3_step</span><span class="p">(</span><span class="n">stmt</span><span class="p">);</span>

    <span class="n">sqlite3_clear_bindings</span><span class="p">(</span><span class="n">stmt</span><span class="p">);</span>
    <span class="n">sqlite3_reset</span><span class="p">(</span><span class="n">stmt</span><span class="p">);</span>

    <span class="n">n</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">fclose</span> <span class="p">(</span><span class="n">pFile</span><span class="p">);</span>

<span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s2">"END TRANSACTION"</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>

<span class="n">printf</span><span class="p">(</span><span class="s2">"Imported </span><span class="si">%d</span><span class="s2"> records in </span><span class="si">%4.2f</span><span class="s2"> seconds</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">cStartClock</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">double</span><span class="p">)</span><span class="n">CLOCKS_PER_SEC</span><span class="p">);</span>

<span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">stmt</span><span class="p">);</span>
<span class="n">sqlite3_close</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>

<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>

<blockquote>
<p>在 16.27 秒内导入 864913 条记录</p>
</blockquote>
<p>好的！代码有点多（别忘了调用<code>sqlite3_clear_bindings</code>and <code>sqlite3_reset</code>），但我们的性能提高了一倍以上，达到
<strong>每秒 53,000 次插入。</strong></p>
<h3>杂注同步 = OFF</h3>
<p>By default, SQLite will pause after issuing a OS-level write command. This
guarantees that the data is written to the disk. By setting <code>synchronous =
OFF</code>, we are instructing SQLite to simply hand-off the data to the OS for
writing and then continue. There's a chance that the database file may become
corrupted if the computer suffers a catastrophic crash (or power failure)
before the data is written to the platter:</p>
<div class="code"><pre class="code literal-block"><span class="o">/*</span><span class="w"> </span><span class="n">Open</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="nb">and</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="o">*/</span>
<span class="n">sqlite3_open</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">db</span><span class="p">);</span>
<span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="w"> </span><span class="n">TABLE</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
<span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="w"> </span><span class="s">"PRAGMA synchronous = OFF"</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
</pre></div>

<blockquote>
<p>Imported 864913 records in 12.41 seconds</p>
</blockquote>
<p>The improvements are now smaller, but we're up to <strong>69,600 inserts per
second.</strong></p>
<h3>PRAGMA journal_mode = MEMORY</h3>
<p>Consider storing the rollback journal in memory by evaluating <code>PRAGMA
journal_mode = MEMORY</code>. Your transaction will be faster, but if you lose power
or your program crashes during a transaction you database could be left in a
corrupt state with a partially-completed transaction:</p>
<div class="code"><pre class="code literal-block"><span class="o">/*</span><span class="w"> </span><span class="n">Open</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="nb">and</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="o">*/</span>
<span class="n">sqlite3_open</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">db</span><span class="p">);</span>
<span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="w"> </span><span class="n">TABLE</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
<span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="w"> </span><span class="s">"PRAGMA journal_mode = MEMORY"</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
</pre></div>

<blockquote>
<p>Imported 864913 records in 13.50 seconds</p>
</blockquote>
<p>A little slower than the previous optimization at <strong>64,000 inserts per
second.</strong></p>
<h3>PRAGMA synchronous = OFF <em>and</em> PRAGMA journal_mode = MEMORY</h3>
<p>Let's combine the previous two optimizations. It's a little more risky (in
case of a crash), but we're just importing data (not running a bank):</p>
<div class="code"><pre class="code literal-block"><span class="o">/*</span><span class="w"> </span><span class="n">Open</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="nb">and</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="o">*/</span>
<span class="n">sqlite3_open</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">db</span><span class="p">);</span>
<span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="w"> </span><span class="n">TABLE</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
<span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="w"> </span><span class="s">"PRAGMA synchronous = OFF"</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
<span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="w"> </span><span class="s">"PRAGMA journal_mode = MEMORY"</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
</pre></div>

<blockquote>
<p>Imported 864913 records in 12.00 seconds</p>
</blockquote>
<p>Fantastic! We're able to do <strong>72,000 inserts per second.</strong></p>
<h3>Using an In-Memory Database</h3>
<p>Just for kicks, let's build upon all of the previous optimizations and
redefine the database filename so we're working entirely in RAM:</p>
<div class="code"><pre class="code literal-block">#define DATABASE ":memory:"
</pre></div>

<blockquote>
<p>Imported 864913 records in 10.94 seconds</p>
</blockquote>
<p>It's not super-practical to store our database in RAM, but it's impressive
that we can perform <strong>79,000 inserts per second.</strong></p>
<h3>Refactoring C Code</h3>
<p>Although not specifically an SQLite improvement, I don't like the extra
<code>char*</code> assignment operations in the <code>while</code> loop. Let's quickly refactor that
code to pass the output of <code>strtok()</code> directly into <code>sqlite3_bind_text()</code>, and
let the compiler try to speed things up for us:</p>
<div class="code"><pre class="code literal-block"><span class="nv">pFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fopen</span><span class="w"> </span><span class="ss">(</span><span class="nv">INPUTDATA</span>,<span class="s2">"r"</span><span class="ss">)</span><span class="c1">;</span>
<span class="k">while</span><span class="w"> </span><span class="ss">(</span><span class="o">!</span><span class="nv">feof</span><span class="ss">(</span><span class="nv">pFile</span><span class="ss">))</span><span class="w"> </span>{

<span class="w">    </span><span class="nv">fgets</span><span class="w"> </span><span class="ss">(</span><span class="nv">sInputBuf</span>,<span class="w"> </span><span class="nv">BUFFER_SIZE</span>,<span class="w"> </span><span class="nv">pFile</span><span class="ss">)</span><span class="c1">;</span>

<span class="w">    </span><span class="nv">sqlite3_bind_text</span><span class="ss">(</span><span class="nv">stmt</span>,<span class="w"> </span><span class="mi">1</span>,<span class="w"> </span><span class="nv">strtok</span><span class="w"> </span><span class="ss">(</span><span class="nv">sInputBuf</span>,<span class="w"> </span><span class="s2">"\t"</span><span class="ss">)</span>,<span class="w"> </span><span class="o">-</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">SQLITE_TRANSIENT</span><span class="ss">)</span><span class="c1">; /* Get Route */</span>
<span class="w">    </span><span class="nv">sqlite3_bind_text</span><span class="ss">(</span><span class="nv">stmt</span>,<span class="w"> </span><span class="mi">2</span>,<span class="w"> </span><span class="nv">strtok</span><span class="w"> </span><span class="ss">(</span><span class="nv">NULL</span>,<span class="w"> </span><span class="s2">"\t"</span><span class="ss">)</span>,<span class="w"> </span><span class="o">-</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">SQLITE_TRANSIENT</span><span class="ss">)</span><span class="c1">;    /* Get Branch */</span>
<span class="w">    </span><span class="nv">sqlite3_bind_text</span><span class="ss">(</span><span class="nv">stmt</span>,<span class="w"> </span><span class="mi">3</span>,<span class="w"> </span><span class="nv">strtok</span><span class="w"> </span><span class="ss">(</span><span class="nv">NULL</span>,<span class="w"> </span><span class="s2">"\t"</span><span class="ss">)</span>,<span class="w"> </span><span class="o">-</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">SQLITE_TRANSIENT</span><span class="ss">)</span><span class="c1">;    /* Get Version */</span>
<span class="w">    </span><span class="nv">sqlite3_bind_text</span><span class="ss">(</span><span class="nv">stmt</span>,<span class="w"> </span><span class="mi">4</span>,<span class="w"> </span><span class="nv">strtok</span><span class="w"> </span><span class="ss">(</span><span class="nv">NULL</span>,<span class="w"> </span><span class="s2">"\t"</span><span class="ss">)</span>,<span class="w"> </span><span class="o">-</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">SQLITE_TRANSIENT</span><span class="ss">)</span><span class="c1">;    /* Get Stop Number */</span>
<span class="w">    </span><span class="nv">sqlite3_bind_text</span><span class="ss">(</span><span class="nv">stmt</span>,<span class="w"> </span><span class="mi">5</span>,<span class="w"> </span><span class="nv">strtok</span><span class="w"> </span><span class="ss">(</span><span class="nv">NULL</span>,<span class="w"> </span><span class="s2">"\t"</span><span class="ss">)</span>,<span class="w"> </span><span class="o">-</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">SQLITE_TRANSIENT</span><span class="ss">)</span><span class="c1">;    /* Get Vehicle */</span>
<span class="w">    </span><span class="nv">sqlite3_bind_text</span><span class="ss">(</span><span class="nv">stmt</span>,<span class="w"> </span><span class="mi">6</span>,<span class="w"> </span><span class="nv">strtok</span><span class="w"> </span><span class="ss">(</span><span class="nv">NULL</span>,<span class="w"> </span><span class="s2">"\t"</span><span class="ss">)</span>,<span class="w"> </span><span class="o">-</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">SQLITE_TRANSIENT</span><span class="ss">)</span><span class="c1">;    /* Get Date */</span>
<span class="w">    </span><span class="nv">sqlite3_bind_text</span><span class="ss">(</span><span class="nv">stmt</span>,<span class="w"> </span><span class="mi">7</span>,<span class="w"> </span><span class="nv">strtok</span><span class="w"> </span><span class="ss">(</span><span class="nv">NULL</span>,<span class="w"> </span><span class="s2">"\t"</span><span class="ss">)</span>,<span class="w"> </span><span class="o">-</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">SQLITE_TRANSIENT</span><span class="ss">)</span><span class="c1">;    /* Get Time */</span>

<span class="w">    </span><span class="nv">sqlite3_step</span><span class="ss">(</span><span class="nv">stmt</span><span class="ss">)</span><span class="c1">;        /* Execute the SQL Statement */</span>
<span class="w">    </span><span class="nv">sqlite3_clear_bindings</span><span class="ss">(</span><span class="nv">stmt</span><span class="ss">)</span><span class="c1">;    /* Clear bindings */</span>
<span class="w">    </span><span class="nv">sqlite3_reset</span><span class="ss">(</span><span class="nv">stmt</span><span class="ss">)</span><span class="c1">;        /* Reset VDBE */</span>

<span class="w">    </span><span class="nv">n</span><span class="o">++</span><span class="c1">;</span>
}
<span class="nv">fclose</span><span class="w"> </span><span class="ss">(</span><span class="nv">pFile</span><span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p><strong>Note: We are back to using a real database file. In-memory databases are
fast, but not necessarily practical</strong></p>
<blockquote>
<p>Imported 864913 records in 8.94 seconds</p>
</blockquote>
<p>A slight refactoring to the string processing code used in our parameter
binding has allowed us to perform <strong>96,700 inserts per second.</strong> I think it's
safe to say that this is <em>plenty fast</em>. As we start to tweak other variables
(i.e. page size, index creation, etc.) this will be our benchmark.</p>
<hr>
<h3>Summary (so far)</h3>
<p><em>I hope you're still with me!</em> The reason we started down this road is that
bulk-insert performance varies so wildly with SQLite, and it's not always
obvious what changes need to be made to speed-up our operation. Using the same
compiler (and compiler options), the same version of SQLite and the same data
we've optimized our code and our usage of SQLite to go <strong>from a worst-case
scenario of 85 inserts per second to over 96,000 inserts per second!</strong></p>
<hr>
<h3>CREATE INDEX then INSERT vs. INSERT then CREATE INDEX</h3>
<p>Before we start measuring <code>SELECT</code> performance, we know that we'll be creating
indices. It's been suggested in one of the answers below that when doing bulk
inserts, it is faster to create the index after the data has been inserted (as
opposed to creating the index first then inserting the data). Let's try:</p>
<p><strong>Create Index then Insert Data</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"CREATE  INDEX 'TTC_Stop_Index' ON 'TTC' ('Stop')"</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
<span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"BEGIN TRANSACTION"</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
<span class="p">...</span>
</pre></div>

<blockquote>
<p>Imported 864913 records in 18.13 seconds</p>
</blockquote>
<p><strong>Insert Data then Create Index</strong></p>
<div class="code"><pre class="code literal-block"><span class="p">...</span>
<span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"END TRANSACTION"</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
<span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s">"CREATE  INDEX 'TTC_Stop_Index' ON 'TTC' ('Stop')"</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sErrMsg</span><span class="p">);</span>
</pre></div>

<blockquote>
<p>Imported 864913 records in 13.66 seconds</p>
</blockquote>
<p>As expected, bulk-inserts are slower if one column is indexed, but it does
make a difference if the index is created after the data is inserted. Our no-
index baseline is 96,000 inserts per second. <strong>Creating the index first then
inserting data gives us 47,700 inserts per second, whereas inserting the data
first then creating the index gives us 63,300 inserts per second.</strong></p>
<hr>
<p>I'd gladly take suggestions for other scenarios to try... And will be
compiling similar data for SELECT queries soon.</p>
<p><br><br></p>
<h2>解答</h2>
<p>几个提示：</p>
<ol>
<li>将插入/更新放入事务中。</li>
<li>对于旧版本的 SQLite - 考虑一种不那么偏执的日志模式 ( <code>pragma journal_mode</code>)。有<code>NORMAL</code>，然后有<code>OFF</code>，如果您不太担心操作系统崩溃时数据库可能会损坏，这可以显着提高插入速度。如果您的应用程序崩溃，数据应该没问题。请注意，在较新的版本中，这些<code>OFF/MEMORY</code>设置对于应用程序级别的崩溃是不安全的。</li>
<li>调整页面大小也会产生影响 ( <code>PRAGMA page_size</code>)。拥有更大的页面大小可以使读取和写入速度更快，因为内存中保存的页面更大。请注意，更多内存将用于您的数据库。</li>
<li>如果您有索引，请考虑<code>CREATE INDEX</code>在完成所有插入后调用。这比创建索引然后进行插入要快得多。</li>
<li>如果您对 SQLite 有并发访问，则必须非常小心，因为在完成写入时整个数据库将被锁定，并且尽管可以有多个读取器，但写入将被锁定。通过在较新的 SQLite 版本中添加 WAL，这已经有所改善。</li>
<li>利用节省空间的优势……较小的数据库运行速度更快。<code>INTEGER PRIMARY KEY</code>例如，如果您有键值对，请尽可能尝试将键设为 an ，这将替换表中隐含的唯一行号列。</li>
<li>如果你正在使用多线程，你可以尝试使用共享页面缓存，这将允许加载的页面在线程之间共享，这可以避免昂贵的 I/O 调用。</li>
<li>不要使用<code>!feof(file)</code>！</li>
</ol>
<p>我也在这里和这里问过类似的问题。</p>
<p><br></p>
<h3>更多建议</h3>
<p>尝试使用<code>SQLITE_STATIC</code>instead of<code>SQLITE_TRANSIENT</code>那些插入。</p>
<p><code>SQLITE_TRANSIENT</code>将导致 SQLite 在返回之前复制字符串数据。</p>
<p><code>SQLITE_STATIC</code>告诉它你给它的内存地址在执行查询之前一直有效（在这个循环中总是如此）。这将为您节省每个循环的几个分配、复制和解除分配操作。可能是一个很大的改进。</p>
<p><br><br><a href="posts/improve-insert-per-second-performance-of-sqlite/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/bash-zhong-de-echo-huan-xing-fu-da-yin-wen-zi-n/" class="u-url">Bash 中的 Echo 换行符打印文字 \n</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/bash-zhong-de-echo-huan-xing-fu-da-yin-wen-zi-n/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T19:49:00+08:00" itemprop="datePublished" title="2023-02-16 19:49">2023-02-16 19:49</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>如何打印换行符？这只是打印<code>\n</code>：</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">"Hello,\nWorld!"</span>
Hello,<span class="se">\n</span>World!
</pre></div>

<p><br><br></p>
<h2>解答</h2>
<p>改用<code>printf</code>：</p>
<div class="code"><pre class="code literal-block">printf "hello\nworld\n"
</pre></div>

<p><code>printf</code>在不同环境中表现比<code>echo</code>.</p>
<p><br></p>
<h3>更多建议</h3>
<p>确保你在 Bash 中。</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$0</span>
bash
</pre></div>

<p>所有这四种方式都对我有用：</p>
<div class="code"><pre class="code literal-block">echo -e "Hello\nworld"
echo -e 'Hello\nworld'
echo Hello$'\n'world
echo Hello ; echo world
</pre></div>

<p><br><br><a href="posts/echo-newline-in-bash-prints-literal-n/">查看原文</a></p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-55.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-53.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
