<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 601) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-601.html">
<link rel="prev" href="index-602.html" type="text/html">
<link rel="next" href="index-600.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/datetime2-vs-datetime-in-sql-server/" class="u-url">DateTime2 vs DateTime in SQL Server</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/datetime2-vs-datetime-in-sql-server/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T11:02:33+08:00" itemprop="datePublished" title="2023-02-17 11:02">2023-02-17 11:02</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Which one:</p>
<ul>
<li><code>datetime</code></li>
<li><code>datetime2</code></li>
</ul>
<p>is <em>the</em> recommended way to store date and time in SQL Server 2008+?</p>
<p>I'm aware of differences in precision (and storage space probably), but
ignoring those for now, is there a best practice document on when to use what,
or maybe we should just use <code>datetime2</code> only?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>The MSDN documentation for datetime recommends using datetime2. Here is their
recommendation:</p>
<blockquote>
<p>Use the <code>time</code>, <code>date</code>, <code>datetime2</code> and <code>datetimeoffset</code> data types for new
work. These types align with the SQL Standard. They are more portable.
<code>time</code>, <code>datetime2</code> and <code>datetimeoffset</code> provide more seconds precision.
<code>datetimeoffset</code> provides time zone support for globally deployed
applications.</p>
</blockquote>
<p>datetime2 has larger date range, a larger default fractional precision, and
optional user-specified precision. Also depending on the user-specified
precision it may use less storage.</p>
<p><br></p>
<h3>Suggest</h3>
<p><code>DATETIME2</code> has a date range of "0001 / 01 / 01" through "9999 / 12 / 31"
while the <code>DATETIME</code> type only supports year 1753-9999.</p>
<p>Also, if you need to, <code>DATETIME2</code> can be more precise in terms of time;
DATETIME is limited to 3 1/3 milliseconds, while <code>DATETIME2</code> can be accurate
down to 100ns.</p>
<p>Both types map to <code>System.DateTime</code> in .NET - no difference there.</p>
<p>If you have the choice, I would recommend using <code>DATETIME2</code> whenever possible.
I don't see any benefits using <code>DATETIME</code> (except for backward compatibility)
- you'll have less trouble (with dates being out of range and hassle like
that).</p>
<p>Plus: if you only need the date (without time part), use DATE - it's just as
good as <code>DATETIME2</code> and saves you space, too! :-) Same goes for time only -
use <code>TIME</code>. That's what these types are there for!</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/windows-batch-files-bat-vs-cmd/" class="u-url">Windows batch files: .bat vs .cmd?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/windows-batch-files-bat-vs-cmd/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T11:02:06+08:00" itemprop="datePublished" title="2023-02-17 11:02">2023-02-17 11:02</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>As I understand it, <code>.bat</code> is the old 16-bit naming convention, and <code>.cmd</code> is
for 32-bit Windows, i.e., starting with NT. But I continue to see .bat files
everywhere, and they seem to work exactly the same using either suffix.
Assuming that my code will never need to run on anything older than NT, does
it really matter which way I name my batch files, or is there some <strong>gotcha</strong>
awaiting me by using the wrong suffix?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>From this news group posting by Mark Zbikowski himself:</p>
<blockquote>
<p>The differences between .CMD and .BAT as far as CMD.EXE is concerned are:
With extensions enabled, PATH/APPEND/PROMPT/SET/ASSOC in .CMD files will set
ERRORLEVEL regardless of error. .BAT sets ERRORLEVEL only on errors.</p>
</blockquote>
<p>In other words, if ERRORLEVEL is set to non-0 and then you run one of those
commands, the resulting ERRORLEVEL will be:</p>
<ul>
<li>left alone at its non-0 value in a .bat file </li>
<li>reset to 0 in a .cmd file. </li>
</ul>
<p><br></p>
<h3>Suggest</h3>
<p>Here is a compilation of verified information from the various answers and
cited references in this thread:</p>
<ol>
<li>
<code>command.com</code> is the 16-bit command processor introduced in MS-DOS and was also used in the Win9x series of operating systems.</li>
<li>
<code>cmd.exe</code> is the 32-bit command processor in Windows NT (64-bit Windows OSes also have a 64-bit version). <code>cmd.exe</code> was never part of Windows 9x. It originated in OS/2 version 1.0, and the OS/2 version of <code>cmd</code> began 16-bit (but was nonetheless a fully fledged protected mode program with commands like <code>start</code>). Windows NT inherited <code>cmd</code> from OS/2, but Windows NT's Win32 version started off 32-bit. Although OS/2 went 32-bit in 1992, its <code>cmd</code> remained a 16-bit OS/2 1.x program.</li>
<li>The <code>ComSpec</code> env variable defines which program is launched by <code>.bat</code> and <code>.cmd</code> scripts. (Starting with WinNT this defaults to <code>cmd.exe</code>.)</li>
<li>
<code>cmd.exe</code> is backward compatible with <code>command.com</code>.</li>
<li>A script that is designed for <code>cmd.exe</code> can be named <code>.cmd</code> to prevent accidental execution on Windows 9x. This filename extension also dates back to OS/2 version 1.0 and 1987.</li>
</ol>
<p>Here is a list of <code>cmd.exe</code> features that are not supported by <code>command.com</code>:</p>
<ul>
<li>Long filenames (exceeding the 8.3 format)</li>
<li>Command history</li>
<li>Tab completion</li>
<li>Escape character: <code>^</code> (Use for: <code>\ &amp; | &gt; &lt; ^</code>)</li>
<li>Directory stack: <code>PUSHD</code>/<code>POPD</code>
</li>
<li>Integer arithmetic: <code>SET /A i+=1</code>
</li>
<li>Search/Replace/Substring: <code>SET %varname:expression%</code>
</li>
<li>Command substitution: <code>FOR /F</code> (existed before, has been enhanced)</li>
<li>Functions: <code>CALL :label</code>
</li>
</ul>
<p>Order of Execution:</p>
<p>If both .bat and .cmd versions of a script (test.bat, test.cmd) are in the
same folder and you run the script without the extension (test), by default
the .bat version of the script will run, even on 64-bit Windows 7. The order
of execution is controlled by the PATHEXT environment variable. See Order in
which Command Prompt executes files for more details.</p>
<p>References:</p>
<ul>
<li>cmd.exe</li>
<li>command.com</li>
</ul>
<p>wikipedia: Comparison of command shells</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/file-upload-asp-net-mvc-3-0/" class="u-url">File Upload ASP.NET MVC 3.0</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/file-upload-asp-net-mvc-3-0/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T11:01:36+08:00" itemprop="datePublished" title="2023-02-17 11:01">2023-02-17 11:01</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>(Preface: this question is about ASP.NET MVC 3.0 which was released in 2011,
it is not about <strong>ASP.NET Core 3.0</strong> which was released in 2019)</p>
<p>I want to upload file in asp.net mvc. How can I upload the file using html
<code>input file</code> control?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>You don't use a file input control. Server side controls are not used in
ASP.NET MVC. Checkout the following blog post which illustrates how to achieve
this in ASP.NET MVC.</p>
<p>So you would start by creating an HTML form which would contain a file input:</p>
<div class="code"><pre class="code literal-block"><span class="nv">@using</span><span class="w"> </span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">BeginForm</span><span class="p">(</span><span class="ss">"Index"</span><span class="p">,</span><span class="w"> </span><span class="ss">"Home"</span><span class="p">,</span><span class="w"> </span><span class="n">FormMethod</span><span class="p">.</span><span class="n">Post</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">enctype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"multipart/form-data"</span><span class="w"> </span><span class="err">}</span><span class="p">))</span>
<span class="err">{</span>
<span class="w">    </span><span class="o">&lt;</span><span class="k">input</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="ss">"file"</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="ss">"file"</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="k">input</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="ss">"submit"</span><span class="w"> </span><span class="k">value</span><span class="o">=</span><span class="ss">"OK"</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="err">}</span>
</pre></div>

<p>and then you would have a controller to handle the upload:</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">HomeController</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Controller</span>
<span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="n">renders</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">form</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">ActionResult</span><span class="w"> </span><span class="n">Index</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">View</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="n">handles</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">upload</span>
<span class="w">    </span><span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">ActionResult</span><span class="w"> </span><span class="n">Index</span><span class="p">(</span><span class="n">HttpPostedFileBase</span><span class="w"> </span><span class="n">file</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">selected</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">file</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">file</span><span class="o">.</span><span class="n">ContentLength</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">extract</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">filename</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="o">.</span><span class="n">GetFileName</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">FileName</span><span class="p">);</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">inside</span><span class="w"> </span><span class="o">~/</span><span class="n">App_Data</span><span class="o">/</span><span class="n">uploads</span><span class="w"> </span><span class="n">folder</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="o">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">Server</span><span class="o">.</span><span class="n">MapPath</span><span class="p">(</span><span class="s2">"~/App_Data/uploads"</span><span class="p">),</span><span class="w"> </span><span class="n">fileName</span><span class="p">);</span>
<span class="w">            </span><span class="n">file</span><span class="o">.</span><span class="n">SaveAs</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">redirect</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="n">again</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">RedirectToAction</span><span class="p">(</span><span class="s2">"Index"</span><span class="p">);</span><span class="w">        </span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>to transfer to <code>byte[]</code> (e.g. for saving to DB):</p>
<div class="code"><pre class="code literal-block">using (MemoryStream ms = new MemoryStream()) {
    file.InputStream.CopyTo(ms);
    byte[] array = ms.GetBuffer();
}
</pre></div>

<p>To transfer the input stream directly into the database, without storing it in
the memory you can use this class taken from here and a bit changed:</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">VarbinaryStream</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="p">{</span>
<span class="n">private</span><span class="w"> </span><span class="n">SqlConnection</span><span class="w"> </span><span class="n">_Connection</span><span class="p">;</span>

<span class="n">private</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">_TableName</span><span class="p">;</span>
<span class="n">private</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">_BinaryColumn</span><span class="p">;</span>
<span class="n">private</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">_KeyColumn</span><span class="p">;</span>
<span class="n">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_KeyValue</span><span class="p">;</span>

<span class="n">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">_Offset</span><span class="p">;</span>

<span class="n">private</span><span class="w"> </span><span class="n">SqlDataReader</span><span class="w"> </span><span class="n">_SQLReader</span><span class="p">;</span>
<span class="n">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">_SQLReadPosition</span><span class="p">;</span>

<span class="n">private</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">_AllowedToRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="n">public</span><span class="w"> </span><span class="nf">VarbinaryStream</span><span class="p">(</span>
<span class="w">    </span><span class="n">string</span><span class="w"> </span><span class="n">ConnectionString</span><span class="p">,</span>
<span class="w">    </span><span class="n">string</span><span class="w"> </span><span class="n">TableName</span><span class="p">,</span>
<span class="w">    </span><span class="n">string</span><span class="w"> </span><span class="n">BinaryColumn</span><span class="p">,</span>
<span class="w">    </span><span class="n">string</span><span class="w"> </span><span class="n">KeyColumn</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">KeyValue</span><span class="p">,</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">AllowRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// create own connection with the connection string.</span>
<span class="w">  </span><span class="n">_Connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">SqlConnection</span><span class="p">(</span><span class="n">ConnectionString</span><span class="p">);</span>

<span class="w">  </span><span class="n">_TableName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TableName</span><span class="p">;</span>
<span class="w">  </span><span class="n">_BinaryColumn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BinaryColumn</span><span class="p">;</span>
<span class="w">  </span><span class="n">_KeyColumn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyColumn</span><span class="p">;</span>
<span class="w">  </span><span class="n">_KeyValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyValue</span><span class="p">;</span>


<span class="w">  </span><span class="c1">// only query the database for a result if we are going to be reading, otherwise skip.</span>
<span class="w">  </span><span class="n">_AllowedToRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AllowRead</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_AllowedToRead</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">try</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_Connection</span><span class="p">.</span><span class="n">State</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ConnectionState</span><span class="p">.</span><span class="n">Open</span><span class="p">)</span>
<span class="w">        </span><span class="n">_Connection</span><span class="p">.</span><span class="n">Open</span><span class="p">();</span>

<span class="w">      </span><span class="n">SqlCommand</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">SqlCommand</span><span class="p">(</span>
<span class="w">                      </span><span class="s">@"SELECT TOP 1 ["</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_BinaryColumn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">@"]</span>
<span class="w">                            </span><span class="n">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="s">" + _TableName + @"</span><span class="p">]</span>
<span class="w">                            </span><span class="n">WHERE</span><span class="w"> </span><span class="p">[</span><span class="s">" + _KeyColumn + "</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@</span><span class="kt">id</span><span class="s">",</span>
<span class="w">                  </span><span class="n">_Connection</span><span class="p">);</span>

<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">SqlParameter</span><span class="p">(</span><span class="s">"@id"</span><span class="p">,</span><span class="w"> </span><span class="n">_KeyValue</span><span class="p">));</span>

<span class="w">      </span><span class="n">_SQLReader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">(</span>
<span class="w">          </span><span class="n">CommandBehavior</span><span class="p">.</span><span class="n">SequentialAccess</span><span class="w"> </span><span class="o">|</span>
<span class="w">          </span><span class="n">CommandBehavior</span><span class="p">.</span><span class="n">SingleResult</span><span class="w"> </span><span class="o">|</span>
<span class="w">          </span><span class="n">CommandBehavior</span><span class="p">.</span><span class="n">SingleRow</span><span class="w"> </span><span class="o">|</span>
<span class="w">          </span><span class="n">CommandBehavior</span><span class="p">.</span><span class="n">CloseConnection</span><span class="p">);</span>

<span class="w">      </span><span class="n">_SQLReader</span><span class="p">.</span><span class="n">Read</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// log errors here</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// this method will be called as part of the Stream ímplementation when we try to write to our VarbinaryStream class.</span>
<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Write</span><span class="p">(</span><span class="n">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">try</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_Connection</span><span class="p">.</span><span class="n">State</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ConnectionState</span><span class="p">.</span><span class="n">Open</span><span class="p">)</span>
<span class="w">      </span><span class="n">_Connection</span><span class="p">.</span><span class="n">Open</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_Offset</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// for the first write we just send the bytes to the Column</span>
<span class="w">      </span><span class="n">SqlCommand</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">SqlCommand</span><span class="p">(</span>
<span class="w">                                  </span><span class="s">@"UPDATE [dbo].["</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_TableName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">@"]</span>
<span class="w">                                            </span><span class="n">SET</span><span class="w"> </span><span class="p">[</span><span class="s">" + _BinaryColumn + @"</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@</span><span class="n">firstchunk</span><span class="w"> </span>
<span class="w">                                        </span><span class="n">WHERE</span><span class="w"> </span><span class="p">[</span><span class="s">" + _KeyColumn + "</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@</span><span class="kt">id</span><span class="s">",</span>
<span class="w">                              </span><span class="n">_Connection</span><span class="p">);</span>

<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">SqlParameter</span><span class="p">(</span><span class="s">"@firstchunk"</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">));</span>
<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">SqlParameter</span><span class="p">(</span><span class="s">"@id"</span><span class="p">,</span><span class="w"> </span><span class="n">_KeyValue</span><span class="p">));</span>

<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteNonQuery</span><span class="p">();</span>

<span class="w">      </span><span class="n">_Offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// for all updates after the first one we use the TSQL command .WRITE() to append the data in the database</span>
<span class="w">      </span><span class="n">SqlCommand</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">SqlCommand</span><span class="p">(</span>
<span class="w">                              </span><span class="s">@"UPDATE [dbo].["</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_TableName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">@"]</span>
<span class="w">                                        </span><span class="n">SET</span><span class="w"> </span><span class="p">[</span><span class="s">" + _BinaryColumn + @"</span><span class="p">].</span><span class="n">WRITE</span><span class="p">(@</span><span class="n">chunk</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">@</span><span class="n">length</span><span class="p">)</span>
<span class="w">                                    </span><span class="n">WHERE</span><span class="w"> </span><span class="p">[</span><span class="s">" + _KeyColumn + "</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@</span><span class="kt">id</span><span class="s">",</span>
<span class="w">                           </span><span class="n">_Connection</span><span class="p">);</span>

<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">SqlParameter</span><span class="p">(</span><span class="s">"@chunk"</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">));</span>
<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">SqlParameter</span><span class="p">(</span><span class="s">"@length"</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">));</span>
<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">SqlParameter</span><span class="p">(</span><span class="s">"@id"</span><span class="p">,</span><span class="w"> </span><span class="n">_KeyValue</span><span class="p">));</span>

<span class="w">      </span><span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteNonQuery</span><span class="p">();</span>

<span class="w">      </span><span class="n">_Offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// log errors here</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// this method will be called as part of the Stream ímplementation when we try to read from our VarbinaryStream class.</span>
<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Read</span><span class="p">(</span><span class="n">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">try</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">bytesRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_SQLReader</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">_SQLReadPosition</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="n">_SQLReadPosition</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bytesRead</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">bytesRead</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// log errors here</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">CanRead</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">get</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_AllowedToRead</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">protected</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Dispose</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">disposing</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_Connection</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">null</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_Connection</span><span class="p">.</span><span class="n">State</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ConnectionState</span><span class="p">.</span><span class="n">Closed</span><span class="p">)</span>
<span class="w">      </span><span class="n">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_Connection</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span><span class="w">           </span><span class="p">}</span>
<span class="w">      </span><span class="n">catch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">_Connection</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">base</span><span class="p">.</span><span class="n">Dispose</span><span class="p">(</span><span class="n">disposing</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#region unimplemented methods</span>
<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">CanSeek</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">get</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">CanWrite</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">get</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Flush</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NotImplementedException</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">Length</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">get</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NotImplementedException</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">Position</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">get</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NotImplementedException</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">set</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NotImplementedException</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">Seek</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">SeekOrigin</span><span class="w"> </span><span class="n">origin</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NotImplementedException</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">SetLength</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NotImplementedException</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#endregion unimplemented methods  }</span>
</pre></div>

<p>and the usage:</p>
<div class="code"><pre class="code literal-block"><span class="w">  </span><span class="n">using</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">filestream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">VarbinaryStream</span><span class="p">(</span>
<span class="w">                            </span><span class="s2">"Connection_String"</span><span class="p">,</span>
<span class="w">                            </span><span class="s2">"Table_Name"</span><span class="p">,</span>
<span class="w">                            </span><span class="s2">"Varbinary_Column_name"</span><span class="p">,</span>
<span class="w">                            </span><span class="s2">"Key_Column_Name"</span><span class="p">,</span>
<span class="w">                            </span><span class="n">keyValueId</span><span class="p">,</span>
<span class="w">                            </span><span class="bp">true</span><span class="p">))</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">postedFile</span><span class="o">.</span><span class="n">InputStream</span><span class="o">.</span><span class="n">CopyTo</span><span class="p">(</span><span class="n">filestream</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-602.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-600.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
