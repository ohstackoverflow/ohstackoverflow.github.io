<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1203) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1203.html">
<link rel="prev" href="index-1204.html" type="text/html">
<link rel="next" href="index-1202.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/nginx-no-www-dao-www-he-www-dao-no-www/" class="u-url">Nginx no-www 到 www 和 www 到 no-www</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/nginx-no-www-dao-www-he-www-dao-no-www/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T03:56:59+08:00" itemprop="datePublished" title="2023-02-18 03:56">2023-02-18 03:56</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>我正在按照教程在 Rackspace 云上使用nginx ，并在网上进行了搜索，但到目前为止无法对此进行排序。</p>
<p>出于 SEO 和其他原因，我想在 .htaccess 中正常<code>www.mysite.example</code>访问。<code>mysite.example</code></p>
<p>我的 <strong>/etc/nginx/sites-available/www.example.com.vhost</strong> 配置：</p>
<div class="code"><pre class="code literal-block"><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">       </span><span class="n">server_name</span><span class="w"> </span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">       </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">web</span><span class="p">;</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">http_host</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"www.example.com"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                 </span><span class="n">rewrite</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">$</span><span class="n">request_uri</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
</pre></div>

<p>我也试过</p>
<div class="code"><pre class="code literal-block"><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">       </span><span class="n">server_name</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">       </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">web</span><span class="p">;</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">http_host</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"www.example.com"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                 </span><span class="n">rewrite</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">$</span><span class="n">request_uri</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
</pre></div>

<p>我也试过了。第二次尝试都给出了重定向循环错误。</p>
<div class="code"><pre class="code literal-block"><span class="nt">if</span><span class="w"> </span><span class="o">($</span><span class="nt">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'www.example.com'</span><span class="w"> </span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="err">rewrite</span><span class="w"> </span><span class="err">^</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="err">$</span><span class="n">uri</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>我的 DNS 设置为标准：</p>
<div class="code"><pre class="code literal-block">site.example 192.192.6.8 A type at 300 seconds
www.site.example 192.192.6.8 A type at 300 seconds
</pre></div>

<p>（示例 IP 和文件夹已用于示例并在将来帮助人们）。我使用的是 Ubuntu 11。</p>
<p><br><br></p>
<h2>解答</h2>
<h2>解决方案</h2>
<p>从文档中，“正确的方法是为<code>example.org</code>”定义一个单独的服务器：</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">listen</span><span class="w">       </span><span class="err">80</span><span class="p">;</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">return</span><span class="w">       </span><span class="err">301</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">listen</span><span class="w">       </span><span class="err">80</span><span class="p">;</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">www.example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">...</span>
<span class="p">}</span>
</pre></div>

<h2>HTTPS 解决方案</h2>
<p>对于那些想要解决方案的人，包括<code>https://</code>......</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">listen</span><span class="w"> </span><span class="err">80</span><span class="p">;</span>
<span class="w">        </span><span class="err">server_name</span><span class="w"> </span><span class="err">www.domain.example</span><span class="p">;</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="err">$scheme</span><span class="w"> </span><span class="err">will</span><span class="w"> </span><span class="err">get</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">http</span><span class="w"> </span><span class="err">protocol</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">301</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">best</span><span class="w"> </span><span class="err">practice</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">tablet,</span><span class="w"> </span><span class="err">phone,</span><span class="w"> </span><span class="err">desktop</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">seo</span>
<span class="w">        </span><span class="err">return</span><span class="w"> </span><span class="err">301</span><span class="w"> </span><span class="err">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//</span><span class="n">domain</span><span class="o">.</span><span class="n">example</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">listen</span><span class="w"> </span><span class="err">80</span><span class="p">;</span>
<span class="w">        </span><span class="err">server_name</span><span class="w"> </span><span class="err">domain.example</span><span class="p">;</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="err">here</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">config</span><span class="w"> </span><span class="err">file</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="err">example</span>
<span class="w">        </span><span class="err">location</span><span class="w"> </span><span class="err">/</span><span class="w"> </span><span class="err">{</span>

<span class="w">            </span><span class="err">rewrite</span><span class="w"> </span><span class="err">^/cp/login?$</span><span class="w"> </span><span class="err">/cp/login.php</span><span class="w"> </span><span class="err">last</span><span class="p">;</span>
<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="err">etc</span><span class="w"> </span><span class="err">etc...</span>

<span class="w">        </span><span class="p">}</span>
<span class="err">}</span>
</pre></div>

<p>注意：我最初没有包含<code>https://</code>在我的解决方案中，因为我们使用负载平衡器并且我们的 https:// 服务器是高流量 SSL 支付服务器：我们不混合
https:// 和 http://。</p>
<hr>
<p>要检查 Nginx 版本，请使用<code>nginx -v</code>.</p>
<p><strong>使用 Nginx 重定向从 URL 中删除 www</strong></p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">www.domain.example</span><span class="p">;</span>
<span class="w">    </span><span class="err">rewrite</span><span class="w"> </span><span class="err">^(.*)</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">domain</span><span class="o">.</span><span class="n">example</span><span class="err">$</span><span class="mi">1</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">domain.example</span><span class="p">;</span>
<span class="w">    </span><span class="err">#The</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">configuration</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">here#</span>
<span class="p">}</span>
</pre></div>

<p>所以你需要有两个服务器代码。</p>
<p><strong>使用 Nginx 重定向将 www 添加到 URL</strong></p>
<p>如果你需要的是相反的，从重定向<code>domain.example</code>到<code>www.domain.example</code>，你可以使用这个：</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">domain.example</span><span class="p">;</span>
<span class="w">    </span><span class="err">rewrite</span><span class="w"> </span><span class="err">^(.*)</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">example</span><span class="err">$</span><span class="mi">1</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">  </span><span class="err">www.domain.example</span><span class="p">;</span>
<span class="w">    </span><span class="err">#The</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">configuration</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">here#</span>
<span class="p">}</span>
</pre></div>

<p>您可以想象，这恰恰相反，并且与第一个示例的工作方式相同。这样，您就不会降低 SEO 标记，因为它是完整的 perm 重定向和移动。强制没有 WWW
并显示目录！</p>
<h3>下面显示了我的一些代码以获得更好的视图：</h3>
<div class="code"><pre class="code literal-block"><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w">  </span><span class="n">www</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">rewrite</span><span class="w"> </span><span class="o">^</span><span class="p">(</span><span class="o">.*</span><span class="p">)</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">$</span><span class="mi">1</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">       </span><span class="n">server_name</span><span class="w"> </span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">       </span><span class="n">index</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">html</span><span class="p">;</span>
<span class="w">       </span><span class="c1">####</span>
<span class="w">       </span><span class="c1"># now pull the site from one directory #</span>
<span class="w">       </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">www</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">web</span><span class="p">;</span>
<span class="w">       </span><span class="c1"># done #</span>
<span class="w">       </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">favicon</span><span class="o">.</span><span class="n">ico</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">                </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><br></p>
<h3>更多建议</h3>
<p>实际上你甚至不需要重写。</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">#listen</span><span class="w"> </span><span class="err">80</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">default</span>
<span class="w">    </span><span class="err">server_name</span><span class="w"> </span><span class="err">www.example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">301</span><span class="w"> </span><span class="err">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">#listen</span><span class="w"> </span><span class="err">80</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">default</span>
<span class="w">    </span><span class="err">server_name</span><span class="w"> </span><span class="err">example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">##</span><span class="w"> </span><span class="err">here</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">conf...</span>
<span class="p">}</span>
</pre></div>

<p>由于我的回答越来越多，但以上也是如此。<code>rewrite</code>你永远不应该在这种情况下使用 a 。为什么？因为 nginx
必须处理并开始搜索。如果你使用<code>return</code>（它应该在任何 nginx 版本中可用）它直接停止执行。这在任何情况下都是首选。</p>
<p>将非 SSL 和 SSL 重定向到它们的非 www 对应物：</p>
<div class="code"><pre class="code literal-block"><span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">listen</span><span class="w">               </span><span class="err">80</span><span class="p">;</span>
<span class="w">    </span><span class="err">listen</span><span class="w">               </span><span class="err">443</span><span class="w"> </span><span class="err">ssl</span><span class="p">;</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">          </span><span class="err">www.example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">ssl_certificate</span><span class="w">      </span><span class="err">path/to/cert</span><span class="p">;</span>
<span class="w">    </span><span class="err">ssl_certificate_key</span><span class="w">  </span><span class="err">path/to/key</span><span class="p">;</span>

<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">301</span><span class="w"> </span><span class="err">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">listen</span><span class="w">               </span><span class="err">80</span><span class="p">;</span>
<span class="w">    </span><span class="err">listen</span><span class="w">               </span><span class="err">443</span><span class="w"> </span><span class="err">ssl</span><span class="p">;</span>
<span class="w">    </span><span class="err">server_name</span><span class="w">          </span><span class="err">example.com</span><span class="p">;</span>
<span class="w">    </span><span class="err">ssl_certificate</span><span class="w">      </span><span class="err">path/to/cert</span><span class="p">;</span>
<span class="w">    </span><span class="err">ssl_certificate_key</span><span class="w">  </span><span class="err">path/to/key</span><span class="p">;</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="err">rest</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">here...</span>
<span class="p">}</span>
</pre></div>

<p>仅当您的服务器仅侦听端口 80（默认）并且侦听选项不包含关键字时，该<code>$scheme</code>变量才会包含。不使用该变量不会获得任何性能。<code>http``ssl</code></p>
<p>请注意，如果使用 HSTS，则需要更多服务器块，因为 HSTS 标头不应通过非加密连接发送。因此，您需要带有重定向的未加密服务器块和带有重定向和 HSTS
标头的加密服务器块。</p>
<p>将所有内容重定向到 SSL（在 UNIX 上使用 IPv4、IPv6、SPDY 等的个人配置）：</p>
<div class="code"><pre class="code literal-block"><span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="n">Redirect</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">www</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">www</span>
<span class="err">#</span>
<span class="n">server</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w">          </span><span class="n">www</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate</span><span class="w">      </span><span class="n">ssl</span><span class="o">/</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">crt</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate_key</span><span class="w">  </span><span class="n">ssl</span><span class="o">/</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="k">key</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">*</span><span class="err">:</span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">*</span><span class="err">:</span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">spdy</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">[</span><span class="n">::</span><span class="o">]</span><span class="err">:</span><span class="mi">80</span><span class="w"> </span><span class="n">ipv6only</span><span class="o">=</span><span class="k">on</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">[</span><span class="n">::</span><span class="o">]</span><span class="err">:</span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">spdy</span><span class="w"> </span><span class="n">ipv6only</span><span class="o">=</span><span class="k">on</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="err">}</span>

<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="n">Redirect</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">encrypted</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">encrypted</span>
<span class="err">#</span>
<span class="n">server</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w">          </span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">*</span><span class="err">:</span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">[</span><span class="n">::</span><span class="o">]</span><span class="err">:</span><span class="mi">80</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="err">}</span>

<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="n">There</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="k">go</span><span class="err">!</span>
<span class="err">#</span>
<span class="n">server</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w">          </span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate</span><span class="w">      </span><span class="n">ssl</span><span class="o">/</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">crt</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate_key</span><span class="w">  </span><span class="n">ssl</span><span class="o">/</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="k">key</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">*</span><span class="err">:</span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">spdy</span><span class="p">;</span>
<span class="w">    </span><span class="n">listen</span><span class="w">               </span><span class="o">[</span><span class="n">::</span><span class="o">]</span><span class="err">:</span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">spdy</span><span class="p">;</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">rest</span><span class="w"> </span><span class="n">goes</span><span class="w"> </span><span class="n">here</span><span class="p">...</span>
<span class="err">}</span>
</pre></div>

<p>我想您现在可以自己想象具有这种模式的其他化合物。</p>
<p>更多我的配置？去这里和这里。</p>
<p><br><br><a href="posts/nginx-no-www-to-www-and-www-to-no-www/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/shi-yao-suan-fa-ji-suan-di-tu-shang-cong-a-dian-dao-b-dian-de-fang-xiang/" class="u-url">什么算法计算地图上从 A 点到 B 点的方向？</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/shi-yao-suan-fa-ji-suan-di-tu-shang-cong-a-dian-dao-b-dian-de-fang-xiang/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T03:56:30+08:00" itemprop="datePublished" title="2023-02-18 03:56">2023-02-18 03:56</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>地图提供商（例如 Google 或 Yahoo! Maps）如何提供方向建议？</p>
<p>我的意思是，他们可能有某种形式的真实世界数据，当然包括距离，但也可能包括行驶速度、人行道的存在、火车时刻表等。但假设数据采用更简单的格式，比如一个非常大的有向图边缘权重反映距离。我希望能够快速计算出从一个任意点到另一个点的方向。有时这些点会靠得很近（在一个城市内），而有时它们会相距很远（跨国）。</p>
<p>像 Dijkstra 算法这样的图算法将无法工作，因为图是巨大的。幸运的是，像 A*
这样的启发式算法可能会起作用。但是，我们的数据非常结构化，也许某种分层方法可能有效？（例如，存储一些相距很远的“关键”点之间的预计算方向，以及一些局部方向。那么两个远点的方向将涉及到一个关键点的局部方向，到另一个关键点的全局方向，然后是局部方向再次指示。）</p>
<p>实践中实际使用了哪些算法？</p>
<p>附言。这个问题的动机是在在线地图方向上寻找怪癖。与三角不等式相反，有时谷歌地图认为XZ比使用中间点XYZ花费的时间更长，距离更远。但也许他们的步行方向也针对另一个参数进行了优化？</p>
<p>聚苯硫醚。这是对三角不等式的另一种违反，这表明（对我而言）他们使用某种分层方法：XZ与XYZ。前者似乎使用著名的 Boulevard de
Sebastopol，尽管它有点偏僻。</p>
<p><strong>编辑</strong> ：这些例子似乎都不再起作用了，但在原始帖子发布时都起作用了。</p>
<p><br><br></p>
<h2>解答</h2>
<p>以在地图公司工作 18 个月的人的身份发言，其中包括研究路由算法……是的，Dijkstra确实有效，但有一些修改：</p>
<ul>
<li>不是从源到目标做Dijkstra一次，而是从每一端开始，并扩展两侧直到它们在中间相遇。这消除了大约一半的工作（2<em>pi</em>(r/2)^2 vs pi*r^2）。</li>
<li>为避免探索源和目的地之间每个城市的后巷，您可以拥有多个地图数据层：仅包含高速公路的“高速公路”层，仅包含次要街道的“次要”层，等等。然后，您仅探索更详细层的较小部分，并根据需要进行扩展。显然这个描述遗漏了很多细节，但你明白了。</li>
</ul>
<p>通过沿着这些路线进行修改，您甚至可以在非常合理的时间范围内进行跨国路由。</p>
<p><br></p>
<h3>更多建议</h3>
<p>这个问题在过去几年一直是一个活跃的研究领域。主要思想是对图形进行 <strong>一次</strong> <strong>预处理</strong> ，以 <strong>加速</strong> 所有 <strong>后续查询</strong>
。有了这些附加信息，可以非常快速地计算出行程。 <strong>Dijkstra 算法</strong> 仍然是所有优化的基础。 <strong><em>* </em></strong><em> </em><strong><em> </em></strong>*</p>
<p><em>Arachnid</em>
描述了基于分层信息的双向搜索和边缘修剪的用法。这些加速技术工作得很好，但最新的算法无论如何都优于这些技术。使用当前的算法，在大陆公路网络上计算最短路径的时间比
<strong>一毫秒要短得多。</strong> 快速执行未修改的 Dijkstra 算法大约需要 <strong>10 秒</strong> 。</p>
<p>工程快速路线规划算法一文概述了该领域的研究进展。有关详细信息，请参阅该论文的参考资料。</p>
<p>最快的已知算法不使用数据中有关道路等级状态的信息，即它是高速公路还是地方道路。相反，他们在预处理步骤中计算自己的层次结构，该层次结构经过优化以加快路线规划。然后可以使用此预计算来修剪搜索：在
Dijkstra 算法期间不需要考虑远离起点和目的地的慢速道路。好处是非常好的 <strong>性能</strong> 和结果的 <strong>正确性保证。</strong></p>
<p>第一个优化的路线规划算法只处理静态道路网络，这意味着图中的一条边具有固定的成本值。这在实践中并非如此，因为我们想要考虑交通拥堵或车辆相关限制等动态信息。最新的算法也可以处理此类问题，但仍有问题需要解决，研究正在进行中。</p>
<p>如果您需要最短路径距离来计算 <strong>TSP</strong> 的解决方案，那么您可能对包含源和目的地之间所有距离的矩阵感兴趣。为此，您可以考虑Computing Many-
to-Many Shortest Paths Using Highway Hierarchies。请注意，这在过去 2 年中已通过更新的方法得到改进。</p>
<p><br><br><a href="posts/what-algorithms-compute-directions-from-point-a-to-point-b-on-a-map/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/javascript-zhong-de-di-tu-yu-dui-xiang/" class="u-url">JavaScript 中的地图与对象</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/javascript-zhong-de-di-tu-yu-dui-xiang/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T03:56:05+08:00" itemprop="datePublished" title="2023-02-18 03:56">2023-02-18 03:56</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>我刚刚发现了这个功能：</p>
<blockquote>
<p>地图：地图对象是简单的键/值映射。</p>
</blockquote>
<p>这让我很困惑。<code>Map</code>常规 JavaScript 对象是字典，那么a 与字典有何不同？从概念上讲，它们是相同的（根据Stack Overflow
上的另一个问题）</p>
<p>该文档也无济于事：</p>
<blockquote>
<p>Map 对象是键/值对的集合，其中键和值都可以是任意 ECMAScript 语言值。不同的键值只能出现在 Map
集合中的一个键/值对中。使用创建地图时选择的比较算法区分的不同键值。</p>
<p>Map 对象可以按插入顺序迭代其元素。Map 对象必须使用哈希表或其他机制来实现，平均而言，这些机制提供的访问时间与集合中的元素数量呈次线性关系。本
Map 对象规范中使用的数据结构仅用于描述 Map 对象所需的可观察语义。它不是一个可行的实施模型。</p>
</blockquote>
<p>......对我来说仍然听起来像一个对象，所以很明显我错过了一些东西。</p>
<p>为什么 JavaScript 获得了一个（得到良好支持的）<code>Map</code>对象？它有什么作用？</p>
<p><br><br></p>
<h2>解答</h2>
<p>根据 MDN：</p>
<blockquote>
<p>Map 对象可以按插入顺序迭代其元素 - 循环<code>for..of</code>将为每次迭代返回一个 [key, value] 数组。</p>
</blockquote>
<p>和</p>
<blockquote>
<p>对象与映射的相似之处在于，两者都允许您将键设置为值、检索这些值、删除键以及检测键中是否存储了某些内容。正因为如此，对象在历史上一直被用作地图；但是，对象和地图之间存在重要差异，这使得使用地图更好。</p>
<p>一个对象有一个原型，所以映射中有默认键。但是，这可以使用 map = Object.create(null)
绕过。对象的键是字符串，它们可以是映射的任何值。您可以轻松获得地图的大小，而您必须手动跟踪对象的大小。</p>
</blockquote>
<p><em>地图</em></p>
<p>顺序迭代是开发人员长期以来一直想要的功能，部分原因是它确保在所有浏览器中具有相同的性能。所以对我来说这是一个很大的问题。</p>
<p>该<code>myMap.has(key)</code>方法和属性将特别方便<code>myMap.size</code>。</p>
<p><br></p>
<h3>更多建议</h3>
<p>关键区别在于对象仅支持字符串和符号键，而地图或多或少支持任何键类型。</p>
<p>如果我<code>obj[123] = true</code>这样做然后<code>Object.keys(obj)</code>我会得到<code>["123"]</code>而不是<code>[123]</code>。Map
会保留键的类型并返回，<code>[123]</code>这很好。地图还允许您使用对象作为键。传统上，要执行此操作，您必须为对象提供某种唯一标识符以对它们进行哈希处理（我认为我从未<code>getObjectId</code>在
JavaScript 中看到过类似的东西作为标准的一部分）。地图还保证了秩序的保存，因此更利于保存，有时可以节省您做一些分类的时间。</p>
<p>在实践中，地图和对象之间有几个优点和缺点。对象既有优点也有缺点，它们被非常紧密地集成到 JavaScript 的核心中，这使它们与 Map
的区别显着超出了关键支持的差异。</p>
<p>一个直接的优势是您拥有对对象的语法支持，可以轻松访问元素。您还可以使用 JSON
直接支持它。当用作散列时，得到一个根本没有任何属性的对象是很烦人的。默认情况下，如果您想将对象用作哈希表，它们将被污染，并且您经常需要<code>hasOwnProperty</code>在访问属性时调用它们。您可以在这里看到默认情况下对象是如何被污染的，以及如何创建希望未被污染的对象以用作散列：</p>
<div class="code"><pre class="code literal-block"><span class="p">({}).</span><span class="n">toString</span>
<span class="w">    </span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="n">native</span><span class="w"> </span><span class="n">code</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="n">JSON</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="err">'</span><span class="p">{}</span><span class="err">'</span><span class="p">).</span><span class="n">toString</span>
<span class="w">    </span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="n">native</span><span class="w"> </span><span class="n">code</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="p">(</span><span class="n">Object</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">null</span><span class="p">)).</span><span class="n">toString</span>
<span class="w">    </span><span class="n">undefined</span>
<span class="n">JSON</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="err">'</span><span class="p">{}</span><span class="err">'</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">typeof</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="err">'</span><span class="n">object</span><span class="err">'</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="n">setPrototypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">null</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="n">v</span><span class="p">)).</span><span class="n">toString</span>
<span class="w">    </span><span class="n">undefined</span>
</pre></div>

<p>对象上的污染不仅会使代码更烦人、更慢等，而且还会对安全性产生潜在影响。</p>
<p>对象不是纯粹的哈希表，但它们正在尝试做更多的事情。你有头痛之类的问题<code>hasOwnProperty</code>，无法轻松获得长度 (
<code>Object.keys(obj).length</code>) 等。对象并不意味着纯粹用作哈希映射，而是用作动态可扩展对象，因此当您将它们用作纯哈希表时会出现问题。</p>
<p>各种常用操作的比较/列表：</p>
<div class="code"><pre class="code literal-block"><span class="k">Object</span><span class="err">:</span>
<span class="w">   </span><span class="nf">var</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{}</span><span class="p">;</span>
<span class="w">   </span><span class="nf">var</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">Object</span><span class="p">.</span><span class="k">create</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>
<span class="w">   </span><span class="n">o</span><span class="p">.</span><span class="k">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">   </span><span class="n">o</span><span class="p">.</span><span class="k">key</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="n">o</span><span class="o">[</span><span class="n">k</span><span class="o">]++</span><span class="p">;</span>
<span class="w">   </span><span class="nf">var</span><span class="w"> </span><span class="nf">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">Object</span><span class="p">.</span><span class="k">values</span><span class="p">(</span><span class="n">m</span><span class="p">))</span><span class="w"> </span><span class="nf">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="s1">'key'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">o</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">hasOwnProperty</span><span class="p">(</span><span class="s1">'key'</span><span class="p">));</span>
<span class="w">   </span><span class="k">delete</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="k">key</span><span class="p">);</span>
<span class="w">   </span><span class="k">Object</span><span class="p">.</span><span class="n">keys</span><span class="p">(</span><span class="n">o</span><span class="p">).</span><span class="n">length</span>
<span class="k">Map</span><span class="err">:</span>
<span class="w">   </span><span class="nf">var</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">Map</span><span class="p">();</span>
<span class="w">   </span><span class="n">m</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="s1">'key'</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">   </span><span class="n">m</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="s1">'key'</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s1">'key'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="w">   </span><span class="n">m</span><span class="p">.</span><span class="n">foreach</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">   </span><span class="nf">var</span><span class="w"> </span><span class="nf">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">values</span><span class="p">())</span><span class="w"> </span><span class="nf">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">has</span><span class="p">(</span><span class="s1">'key'</span><span class="p">));</span>
<span class="w">   </span><span class="n">m</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'key'</span><span class="p">);</span>
<span class="w">   </span><span class="n">m</span><span class="p">.</span><span class="k">size</span><span class="p">();</span>
</pre></div>

<p>还有一些其他的选项、方法、方法等有不同的起伏（性能、简洁、可移植、可扩展等）。对象作为语言的核心有点奇怪，所以你有很多静态方法来处理它们。</p>
<p>除了 Maps 保留键类型的优势以及能够支持对象作为键之类的东西之外，它们还与对象所具有的副作用隔离开来。一个 Map
是一个纯粹的散列，没有关于试图同时成为一个对象的混淆。还可以使用代理功能轻松扩展地图。Object 目前有一个 Proxy
类，但是性能和内存使用情况很糟糕，实际上创建你自己的代理看起来像 Map for Objects 目前比 Proxy 执行得更好。</p>
<p>地图的一个重大缺点是它们不直接支持 JSON。解析是可能的，但它有几个问题：</p>
<div class="code"><pre class="code literal-block"><span class="n">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nf">str</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">typeof</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">'object'</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="w">    </span><span class="n">let</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">Map</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="o">[</span><span class="n">k</span><span class="o">]</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="err">}</span><span class="p">);</span>
</pre></div>

<p>以上将引入严重的性能损失，并且也不支持任何字符串键。JSON 编码更加困难和有问题（这是许多方法之一）：</p>
<div class="code"><pre class="code literal-block"><span class="c1">// An alternative to this it to use a replacer in JSON.stringify.</span>
<span class="n">Map</span><span class="p">.</span><span class="n">prototype</span><span class="p">.</span><span class="n">toJSON</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="n">stringify</span><span class="p">({</span>
<span class="w">        </span><span class="n">keys</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">keys</span><span class="p">()),</span>
<span class="w">        </span><span class="n">values</span><span class="p">:</span><span class="w"> </span><span class="n">Array</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">values</span><span class="p">())</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">};</span>
</pre></div>

<p>如果你纯粹使用地图，这还不错，但是当你混合类型或使用非标量值作为键时它会遇到问题（并不是说 JSON 是完美的那种问题，IE 循环对象引用).
我没有测试过它，但与 stringify 相比，它很可能会严重损害性能。</p>
<p>其他脚本语言通常没有这样的问题，因为它们具有 Map、Object 和 Array 的显式非标量类型。对于非标量类型，Web
开发通常是一种痛苦，在这种情况下，您必须处理诸如 PHP 使用 A/M 将 Array/Map 与 Object 合并以获取属性以及 JavaScript
将 Map/Object 与 Array 合并扩展 M/O 之类的事情。合并复杂类型是高级脚本语言的魔鬼克星。</p>
<p>到目前为止，这些主要是关于实施的问题，但基本操作的性能也很重要。性能也很复杂，因为它取决于引擎和使用情况。对我的测试持保留态度，因为我不能排除任何错误（我必须赶时间）。您还应该运行自己的测试以确认我的测试仅检查非常具体的简单场景以仅提供粗略指示。根据
Chrome 中针对非常大的对象/地图的测试，对象的性能更差，因为删除显然与键的数量成正比，而不是 O(1)：</p>
<div class="code"><pre class="code literal-block">Object Set Took: 146
Object Update Took: 7
Object Get Took: 4
Object Delete Took: 8239
Map Set Took: 80
Map Update Took: 51
Map Get Took: 40
Map Delete Took: 2
</pre></div>

<p>Chrome
显然在获取和更新方面有很强的优势，但删除性能非常糟糕。在这种情况下，地图使用的内存稍微多一点（开销），但是只有一个对象/地图使用数百万个键进行测试，地图开销的影响没有很好地表达出来。如果我正确阅读配置文件，内存管理对象似乎也会更早释放，这可能是有利于对象的一个​​好处。</p>
<p>在 Firefox 中，这个特定的基准测试是另一回事：</p>
<div class="code"><pre class="code literal-block">Object Set Took: 435
Object Update Took: 126
Object Get Took: 50
Object Delete Took: 2
Map Set Took: 63
Map Update Took: 59
Map Get Took: 33
Map Delete Took: 1
</pre></div>

<p>我应该立即指出，在这个特定的基准测试中，从 Firefox 中删除对象不会导致任何问题，但是在其他基准测试中它会导致问题，尤其是当有很多键时，就像在
Chrome 中一样。对于大型集合，地图在 Firefox 中显然更胜一筹。</p>
<p>然而，这并不是故事的结局，许多小物体或地图呢？我已经对此做了一个快速基准测试，但不是一个详尽的基准测试（设置/获取），其中在上述操作中使用少量键表现最佳。这个测试更多的是关于内存和初始化。</p>
<div class="code"><pre class="code literal-block">Map Create: 69    // new Map
Object Create: 34 // {}
</pre></div>

<p>同样，这些数字各不相同，但基本上 Object 有很好的领先优势。在某些情况下，Objects 相对于 maps 的领先优势是极端的（大约好 10
倍），但平均而言大约要好 2-3 倍。极端的性能峰值似乎可以双向发挥作用。我只在 Chrome
和创建中对此进行了测试，以分析内存使用情况和开销。我很惊讶地看到，在 Chrome 中，一键地图使用的内存似乎比一键对象多 30 倍。</p>
<p>用于使用上述所有操作（4 个键）测试许多小对象：</p>
<div class="code"><pre class="code literal-block">Chrome Object Took: 61
Chrome Map Took: 67
Firefox Object Took: 54
Firefox Map Took: 139
</pre></div>

<p>在内存分配方面，它们在释放/ GC方面表现相同，但 Map
使用的内存是其五倍。这个测试使用了四个键，而在上一个测试中我只设置了一个键，所以这可以解释内存开销的减少。我跑了几次这个测试，就整体速度而言，地图/对象对于
Chrome 来说或多或少是并驾齐驱的。在 Firefox for small Objects 中，总体上与地图相比具有明显的性能优势。</p>
<p>这当然不包括可能变化很大的个别选项。我不建议对这些数字进行微优化。您可以从中得到的是，根据经验，对于非常大的键值存储更强烈地考虑映射，对于小型键值存储更强烈地考虑对象。</p>
<p>除此之外，这两个的最佳策略是实施它并使其首先起作用。在进行性能分析时，请务必记住，有时您在查看它们时认为不会很慢的事情可能会非常慢，因为在对象键删除情况下会出现引擎怪癖。</p>
<p><br><br><a href="posts/map-vs-object-in-javascript/">查看原文</a></p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1204.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1202.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
