<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 316) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-316.html">
<link rel="prev" href="index-317.html" type="text/html">
<link rel="next" href="index-315.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/retrieving-the-last-record-in-each-group-mysql/" class="u-url">Retrieving the last record in each group - MySQL</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/retrieving-the-last-record-in-each-group-mysql/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T03:47:03+08:00" itemprop="datePublished" title="2023-02-17 03:47">2023-02-17 03:47</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>There is a table <code>messages</code> that contains data as shown below:</p>
<div class="code"><pre class="code literal-block"><span class="gh">Id   Name   Other_Columns</span>
<span class="gh">-------------------------</span>
1    A       A_data_1
2    A       A_data_2
3    A       A_data_3
4    B       B_data_1
5    B       B_data_2
6    C       C_data_1
</pre></div>

<p>If I run a query <code>select * from messages group by name</code>, I will get the result
as:</p>
<div class="code"><pre class="code literal-block"><span class="mf">1</span><span class="w">    </span><span class="n">A</span><span class="w">       </span><span class="n">A_data_1</span>
<span class="mf">4</span><span class="w">    </span><span class="n">B</span><span class="w">       </span><span class="n">B_data_1</span>
<span class="mf">6</span><span class="w">    </span><span class="n">C</span><span class="w">       </span><span class="n">C_data_1</span>
</pre></div>

<p>What query will return the following result?</p>
<div class="code"><pre class="code literal-block"><span class="mf">3</span><span class="w">    </span><span class="n">A</span><span class="w">       </span><span class="n">A_data_3</span>
<span class="mf">5</span><span class="w">    </span><span class="n">B</span><span class="w">       </span><span class="n">B_data_2</span>
<span class="mf">6</span><span class="w">    </span><span class="n">C</span><span class="w">       </span><span class="n">C_data_1</span>
</pre></div>

<p>That is, the last record in each group should be returned.</p>
<p>At present, this is the query that I use:</p>
<div class="code"><pre class="code literal-block">SELECT
  *
FROM (SELECT
  *
FROM messages
ORDER BY id DESC) AS x
GROUP BY name
</pre></div>

<p>But this looks highly inefficient. Any other ways to achieve the same result?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>MySQL 8.0 now supports windowing functions, like almost all popular SQL
implementations. With this standard syntax, we can write greatest-n-per-group
queries:</p>
<div class="code"><pre class="code literal-block">WITH ranked_messages AS (
  SELECT m.*, ROW_NUMBER() OVER (PARTITION BY name ORDER BY id DESC) AS rn
  FROM messages AS m
)
SELECT * FROM ranked_messages WHERE rn = 1;
</pre></div>

<p>This and other approaches to finding groupwise maximal rows are illustrated in
the MySQL manual.</p>
<p>Below is the original answer I wrote for this question in 2009:</p>
<hr>
<p>I write the solution this way:</p>
<div class="code"><pre class="code literal-block">SELECT m1.*
FROM messages m1 LEFT JOIN messages m2
 ON (m1.name = m2.name AND m1.id &lt; m2.id)
WHERE m2.id IS NULL;
</pre></div>

<p>Regarding performance, one solution or the other can be better, depending on
the nature of your data. So you should test both queries and use the one that
is better at performance given your database.</p>
<p>For example, I have a copy of the StackOverflow August data dump. I'll use
that for benchmarking. There are 1,114,357 rows in the <code>Posts</code> table. This is
running on MySQL 5.0.75 on my Macbook Pro 2.40GHz.</p>
<p>I'll write a query to find the most recent post for a given user ID (mine).</p>
<p><strong>First using the technique shown by @Eric with the<code>GROUP BY</code> in a subquery:</strong></p>
<div class="code"><pre class="code literal-block">SELECT p1.postid
FROM Posts p1
INNER JOIN (SELECT pi.owneruserid, MAX(pi.postid) AS maxpostid
            FROM Posts pi GROUP BY pi.owneruserid) p2
  ON (p1.postid = p2.maxpostid)
WHERE p1.owneruserid = 20860;

1 row in set (1 min 17.89 sec)
</pre></div>

<p>Even the <code>EXPLAIN</code> analysis takes over 16 seconds:</p>
<div class="code"><pre class="code literal-block"><span class="nb">+----+-------------+------------+--------+----------------------------+-------------+---------+--------------+---------+-------------+</span>
<span class="c">| id | select_type | table      | type   | possible_keys              | key         | key_len | ref          | rows    | Extra       |</span>
<span class="nb">+----+-------------+------------+--------+----------------------------+-------------+---------+--------------+---------+-------------+</span>
<span class="c">|  1 | PRIMARY     | </span><span class="nv">&lt;</span><span class="c">derived2</span><span class="nv">&gt;</span><span class="c"> | ALL    | NULL                       | NULL        | NULL    | NULL         |   76756 |             | </span>
<span class="c">|  1 | PRIMARY     | p1         | eq_ref | PRIMARY</span><span class="nt">,</span><span class="c">PostId</span><span class="nt">,</span><span class="c">OwnerUserId | PRIMARY     | 8       | p2</span><span class="nt">.</span><span class="c">maxpostid |       1 | Using where | </span>
<span class="c">|  2 | DERIVED     | pi         | index  | NULL                       | OwnerUserId | 8       | NULL         | 1151268 | Using index | </span>
<span class="nb">+----+-------------+------------+--------+----------------------------+-------------+---------+--------------+---------+-------------+</span>
<span class="c">3 rows in set (16</span><span class="nt">.</span><span class="c">09 sec)</span>
</pre></div>

<p><strong>Now produce the same query result using my technique with<code>LEFT JOIN</code>:</strong></p>
<div class="code"><pre class="code literal-block">SELECT p1.postid
FROM Posts p1 LEFT JOIN posts p2
  ON (p1.owneruserid = p2.owneruserid AND p1.postid &lt; p2.postid)
WHERE p2.postid IS NULL AND p1.owneruserid = 20860;

1 row in set (0.28 sec)
</pre></div>

<p>The <code>EXPLAIN</code> analysis shows that both tables are able to use their indexes:</p>
<div class="code"><pre class="code literal-block"><span class="nb">+----+-------------+-------+------+----------------------------+-------------+---------+-------+------+--------------------------------------+</span>
<span class="c">| id | select_type | table | type | possible_keys              | key         | key_len | ref   | rows | Extra                                |</span>
<span class="nb">+----+-------------+-------+------+----------------------------+-------------+---------+-------+------+--------------------------------------+</span>
<span class="c">|  1 | SIMPLE      | p1    | ref  | OwnerUserId                | OwnerUserId | 8       | const | 1384 | Using index                          | </span>
<span class="c">|  1 | SIMPLE      | p2    | ref  | PRIMARY</span><span class="nt">,</span><span class="c">PostId</span><span class="nt">,</span><span class="c">OwnerUserId | OwnerUserId | 8       | const | 1384 | Using where; Using index; Not exists | </span>
<span class="nb">+----+-------------+-------+------+----------------------------+-------------+---------+-------+------+--------------------------------------+</span>
<span class="c">2 rows in set (0</span><span class="nt">.</span><span class="c">00 sec)</span>
</pre></div>

<hr>
<p>Here's the DDL for my <code>Posts</code> table:</p>
<div class="code"><pre class="code literal-block"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n n-Quoted">`posts`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n n-Quoted">`PostId`</span><span class="w"> </span><span class="kt">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">auto_increment</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`PostTypeId`</span><span class="w"> </span><span class="kt">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`AcceptedAnswerId`</span><span class="w"> </span><span class="kt">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`ParentId`</span><span class="w"> </span><span class="kt">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`CreationDate`</span><span class="w"> </span><span class="kt">datetime</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`Score`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">'0'</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`ViewCount`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">'0'</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`Body`</span><span class="w"> </span><span class="kt">text</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`OwnerUserId`</span><span class="w"> </span><span class="kt">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`OwnerDisplayName`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`LastEditorUserId`</span><span class="w"> </span><span class="kt">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`LastEditDate`</span><span class="w"> </span><span class="kt">datetime</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`LastActivityDate`</span><span class="w"> </span><span class="kt">datetime</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`Title`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`Tags`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`AnswerCount`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">'0'</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`CommentCount`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">'0'</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`FavoriteCount`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">'0'</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`ClosedDate`</span><span class="w"> </span><span class="kt">datetime</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w">  </span><span class="p">(</span><span class="n n-Quoted">`PostId`</span><span class="p">),</span>
<span class="w">  </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n n-Quoted">`PostId`</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`PostId`</span><span class="p">),</span>
<span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="n n-Quoted">`PostTypeId`</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`PostTypeId`</span><span class="p">),</span>
<span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="n n-Quoted">`AcceptedAnswerId`</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`AcceptedAnswerId`</span><span class="p">),</span>
<span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="n n-Quoted">`OwnerUserId`</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`OwnerUserId`</span><span class="p">),</span>
<span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="n n-Quoted">`LastEditorUserId`</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`LastEditorUserId`</span><span class="p">),</span>
<span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="n n-Quoted">`ParentId`</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`ParentId`</span><span class="p">),</span>
<span class="w">  </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n n-Quoted">`posts_ibfk_1`</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`PostTypeId`</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n n-Quoted">`posttypes`</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`PostTypeId`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="p">;</span>
</pre></div>

<hr>
<p><strong>Note to commenters: If you want another benchmark with a different version
of MySQL, a different dataset, or different table design, feel free to do it
yourself. I have shown the technique above. Stack Overflow is here to show you
how to do software development work, not to do all the work for you.</strong></p>
<p><br></p>
<h3>Suggest</h3>
<p><em>UPD: 2017-03-31, the version 5.7.5 of MySQL made the ONLY_FULL_GROUP_BY
switch enabled by default (hence, non-deterministic GROUP BY queries became
disabled). Moreover, they updated the GROUP BY implementation and the solution
might not work as expected anymore even with the disabled switch. One needs to
check.</em></p>
<p>Bill Karwin's solution above works fine when item count within groups is
rather small, but the performance of the query becomes bad when the groups are
rather large, since the solution requires about <code>n*n/2 + n/2</code> of only <code>IS
NULL</code> comparisons.</p>
<p>I made my tests on a InnoDB table of <code>18684446</code> rows with <code>1182</code> groups. The
table contains testresults for functional tests and has the <code>(test_id,
request_id)</code> as the primary key. Thus, <code>test_id</code> is a group and I was
searching for the last <code>request_id</code> for each <code>test_id</code>.</p>
<p>Bill's solution has already been running for several hours on my dell e4310
and I do not know when it is going to finish even though it operates on a
coverage index (hence <code>using index</code> in EXPLAIN).</p>
<p>I have a couple of other solutions that are based on the same ideas:</p>
<ul>
<li>if the underlying index is BTREE index (which is usually the case), the largest <code>(group_id, item_value)</code> pair is the last value within each <code>group_id</code>, that is the first for each <code>group_id</code> if we walk through the index in descending order;</li>
<li>if we read the values which are covered by an index, the values are read in the order of the index;</li>
<li>each index implicitly contains primary key columns appended to that (that is the primary key is in the coverage index). In solutions below I operate directly on the primary key, in you case, you will just need to add primary key columns in the result.</li>
<li>in many cases it is much cheaper to collect the required row ids in the required order in a subquery and join the result of the subquery on the id. Since for each row in the subquery result MySQL will need a single fetch based on primary key, the subquery will be put first in the join and the rows will be output in the order of the ids in the subquery (if we omit explicit ORDER BY for the join)</li>
</ul>
<p>3 ways MySQL uses indexes is a great article to understand some details.</p>
<p><strong>Solution 1</strong></p>
<p>This one is incredibly fast, it takes about 0,8 secs on my 18M+ rows:</p>
<div class="code"><pre class="code literal-block">SELECT test_id, MAX(request_id) AS request_id
FROM testresults
GROUP BY test_id DESC;
</pre></div>

<p>If you want to change the order to ASC, put it in a subquery, return the ids
only and use that as the subquery to join to the rest of the columns:</p>
<div class="code"><pre class="code literal-block">SELECT test_id, request_id
FROM (
    SELECT test_id, MAX(request_id) AS request_id
    FROM testresults
    GROUP BY test_id DESC) as ids
ORDER BY test_id;
</pre></div>

<p>This one takes about 1,2 secs on my data.</p>
<p><strong>Solution 2</strong></p>
<p>Here is another solution that takes about 19 seconds for my table:</p>
<div class="code"><pre class="code literal-block"><span class="k">SELECT</span><span class="w"> </span><span class="n">test_id</span><span class="p">,</span><span class="w"> </span><span class="n">request_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">testresults</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="nv">@group</span><span class="err">:</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">init</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">IF</span><span class="p">(</span><span class="n">IFNULL</span><span class="p">(</span><span class="nv">@group</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="nv">@group</span><span class="err">:</span><span class="o">=</span><span class="n">test_id</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">test_id</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">request_id</span><span class="w"> </span><span class="k">DESC</span>
</pre></div>

<p>It returns tests in descending order as well. It is much slower since it does
a full index scan but it is here to give you an idea how to output N max rows
for each group.</p>
<p>The disadvantage of the query is that its result cannot be cached by the query
cache.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-to-call-asynchronous-method-from-synchronous-method-in-c/" class="u-url">How to call asynchronous method from synchronous method in C#?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-to-call-asynchronous-method-from-synchronous-method-in-c/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T03:46:31+08:00" itemprop="datePublished" title="2023-02-17 03:46">2023-02-17 03:46</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I have a <code>public async void Foo()</code> method that I want to call from synchronous
method. So far all I have seen from MSDN documentation is calling async
methods via async methods, but my whole program is not built with async
methods.</p>
<p>Is this even possible?</p>
<p>Here's one example of calling these methods from an asynchronous method:<br>
Walkthrough: Accessing the Web by Using Async and Await (C# and Visual Basic)</p>
<p>Now I'm looking into calling these async methods from sync methods.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Asynchronous programming does "grow" through the code base. It has been
compared to a zombie virus. The best solution is to allow it to grow, but
sometimes that's not possible.</p>
<p>I have written a few types in my Nito.AsyncEx library for dealing with a
partially-asynchronous code base. There's no solution that works in every
situation, though.</p>
<p><strong>Solution A</strong></p>
<p>If you have a simple asynchronous method that doesn't need to synchronize back
to its context, then you can use <code>Task.WaitAndUnwrapException</code>:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyAsyncMethod</span><span class="p">();</span>
<span class="k">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task</span><span class="o">.</span><span class="n">WaitAndUnwrapException</span><span class="p">();</span>
</pre></div>

<p>You do <em>not</em> want to use <code>Task.Wait</code> or <code>Task.Result</code> because they wrap
exceptions in <code>AggregateException</code>.</p>
<p>This solution is only appropriate if <code>MyAsyncMethod</code> does not synchronize back
to its context. In other words, every <code>await</code> in <code>MyAsyncMethod</code> should end
with <code>ConfigureAwait(false)</code>. This means it can't update any UI elements or
access the ASP.NET request context.</p>
<p><strong>Solution B</strong></p>
<p>If <code>MyAsyncMethod</code> does need to synchronize back to its context, then you may
be able to use <code>AsyncContext.RunTask</code> to provide a nested context:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AsyncContext</span><span class="o">.</span><span class="n">RunTask</span><span class="p">(</span><span class="n">MyAsyncMethod</span><span class="p">)</span><span class="o">.</span><span class="n">Result</span><span class="p">;</span>
</pre></div>

<hr>
<p>*Update 4/14/2014: In more recent versions of the library the API is as follows:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AsyncContext</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">MyAsyncMethod</span><span class="p">);</span>
</pre></div>

<hr>
<p>(It's OK to use <code>Task.Result</code> in this example because <code>RunTask</code> will propagate
<code>Task</code> exceptions).</p>
<p>The reason you may need <code>AsyncContext.RunTask</code> instead of
<code>Task.WaitAndUnwrapException</code> is because of a rather subtle deadlock
possibility that happens on WinForms/WPF/SL/ASP.NET:</p>
<ol>
<li>A synchronous method calls an async method, obtaining a <code>Task</code>.</li>
<li>The synchronous method does a blocking wait on the <code>Task</code>.</li>
<li>The <code>async</code> method uses <code>await</code> without <code>ConfigureAwait</code>.</li>
<li>The <code>Task</code> cannot complete in this situation because it only completes when the <code>async</code> method is finished; the <code>async</code> method cannot complete because it is attempting to schedule its continuation to the <code>SynchronizationContext</code>, and WinForms/WPF/SL/ASP.NET will not allow the continuation to run because the synchronous method is already running in that context.</li>
</ol>
<p>This is one reason why it's a good idea to use <code>ConfigureAwait(false)</code> within
every <code>async</code> method as much as possible.</p>
<p><strong>Solution C</strong></p>
<p><code>AsyncContext.RunTask</code> won't work in every scenario. For example, if the
<code>async</code> method awaits something that requires a UI event to complete, then
you'll deadlock even with the nested context. In that case, you could start
the <code>async</code> method on the thread pool:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Task</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">MyAsyncMethod</span><span class="p">());</span>
<span class="k">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task</span><span class="o">.</span><span class="n">WaitAndUnwrapException</span><span class="p">();</span>
</pre></div>

<p>However, this solution requires a <code>MyAsyncMethod</code> that will work in the thread
pool context. So it can't update UI elements or access the ASP.NET request
context. And in that case, you may as well add <code>ConfigureAwait(false)</code> to its
<code>await</code> statements, and use solution A.</p>
<p><strong>Update, 2019-05-01:</strong> The current "least-worst practices" are in an MSDN
article here.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Adding a solution that finally solved my problem, hopefully saves somebody's
time.</p>
<p>Firstly read a couple articles of Stephen Cleary:</p>
<ul>
<li>Async and Await</li>
<li>Don't Block on Async Code</li>
</ul>
<p>From the "two best practices" in "Don't Block on Async Code", the first one
didn't work for me and the second one wasn't applicable (basically if I can
use <code>await</code>, I do!).</p>
<p>So here is my workaround: wrap the call inside a <code>Task.Run&lt;&gt;(async () =&gt; await
FunctionAsync());</code> and hopefully no <strong>deadlock</strong> anymore.</p>
<p>Here is my code:</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">LogReader</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ILogger</span><span class="w"> </span><span class="n">_logger</span><span class="p">;</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">LogReader</span><span class="p">(</span><span class="n">ILogger</span><span class="w"> </span><span class="n">logger</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">_logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logger</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">LogEntity</span><span class="w"> </span><span class="n">GetLog</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">LogEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Task</span><span class="o">.</span><span class="n">Run</span><span class="o">&lt;</span><span class="n">LogEntity</span><span class="o">&gt;</span><span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">GetLogAsync</span><span class="p">());</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">task</span><span class="o">.</span><span class="n">Result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">LogEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetLogAsync</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">_logger</span><span class="o">.</span><span class="n">GetAsync</span><span class="p">();</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">here</span><span class="o">...</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">LogEntity</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/if-python-is-interpreted-what-are-pyc-files/" class="u-url">If Python is interpreted, what are .pyc files?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/if-python-is-interpreted-what-are-pyc-files/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T03:45:28+08:00" itemprop="datePublished" title="2023-02-17 03:45">2023-02-17 03:45</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Python is an interpreted language. But why does my source directory contain
<code>.pyc</code> files, which are identified by Windows as "Compiled Python Files"?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>They contain byte code, which is what the Python interpreter compiles the
source to. This code is then executed by Python's virtual machine.</p>
<p>Python's documentation explains the definition like this:</p>
<blockquote>
<p>Python is an interpreted language, as opposed to a compiled one, though the
distinction can be blurry because of the presence of the bytecode compiler.
This means that source files can be run directly without explicitly creating
an executable which is then run.</p>
</blockquote>
<p><br></p>
<h3>Suggest</h3>
<p>They contain byte code, which is what the Python interpreter compiles the
source to. This code is then executed by Python's virtual machine.</p>
<p>Python's documentation explains the definition like this:</p>
<blockquote>
<p>Python is an interpreted language, as opposed to a compiled one, though the
distinction can be blurry because of the presence of the bytecode compiler.
This means that source files can be run directly without explicitly creating
an executable which is then run.</p>
</blockquote>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-317.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-315.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
