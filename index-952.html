<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 952) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-952.html">
<link rel="prev" href="index-953.html" type="text/html">
<link rel="next" href="index-951.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-to-save-restore-a-model-after-training/" class="u-url">How to save/restore a model after training?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-to-save-restore-a-model-after-training/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T20:25:57+08:00" itemprop="datePublished" title="2023-02-17 20:25">2023-02-17 20:25</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>After you train a model in Tensorflow:</p>
<ol>
<li>How do you save the trained model?</li>
<li>How do you later restore this saved model?</li>
</ol>
<p><br><br></p>
<h2>Answer</h2>
<h2>Tensorflow 2 Docs</h2>
<h4>Saving Checkpoints</h4>
<p>Adapted from the docs</p>
<div class="code"><pre class="code literal-block"><span class="c1"># -------------------------</span>
<span class="c1"># -----  Toy Context  -----</span>
<span class="c1"># -------------------------</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>


<span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A simple linear model."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">toy_dataset</span><span class="p">():</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">inputs</span> <span class="o">*</span> <span class="mf">5.0</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">labels</span><span class="p">))</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Trains `net` on `example` using `optimizer`."""</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s2">"x"</span><span class="p">])</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">output</span> <span class="o">-</span> <span class="n">example</span><span class="p">[</span><span class="s2">"y"</span><span class="p">]))</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">trainable_variables</span>
    <span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">variables</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">loss</span>


<span class="c1"># ----------------------------</span>
<span class="c1"># -----  Create Objects  -----</span>
<span class="c1"># ----------------------------</span>

<span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">toy_dataset</span><span class="p">()</span>
<span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">ckpt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Checkpoint</span><span class="p">(</span>
    <span class="n">step</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">net</span><span class="o">=</span><span class="n">net</span><span class="p">,</span> <span class="n">iterator</span><span class="o">=</span><span class="n">iterator</span>
<span class="p">)</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">CheckpointManager</span><span class="p">(</span><span class="n">ckpt</span><span class="p">,</span> <span class="s2">"./tf_ckpts"</span><span class="p">,</span> <span class="n">max_to_keep</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># ----------------------------</span>
<span class="c1"># -----  Train and Save  -----</span>
<span class="c1"># ----------------------------</span>

<span class="n">ckpt</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">)</span>
<span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Restored from </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Initializing from scratch."</span><span class="p">)</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">example</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
    <span class="n">ckpt</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">assign_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">ckpt</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Saved checkpoint for step </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ckpt</span><span class="o">.</span><span class="n">step</span><span class="p">),</span> <span class="n">save_path</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"loss </span><span class="si">{:1.2f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>


<span class="c1"># ---------------------</span>
<span class="c1"># -----  Restore  -----</span>
<span class="c1"># ---------------------</span>

<span class="c1"># In another script, re-initialize objects</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">toy_dataset</span><span class="p">()</span>
<span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">ckpt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Checkpoint</span><span class="p">(</span>
    <span class="n">step</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">net</span><span class="o">=</span><span class="n">net</span><span class="p">,</span> <span class="n">iterator</span><span class="o">=</span><span class="n">iterator</span>
<span class="p">)</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">CheckpointManager</span><span class="p">(</span><span class="n">ckpt</span><span class="p">,</span> <span class="s2">"./tf_ckpts"</span><span class="p">,</span> <span class="n">max_to_keep</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># Re-use the manager code above ^</span>

<span class="n">ckpt</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">)</span>
<span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Restored from </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Initializing from scratch."</span><span class="p">)</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">example</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
    <span class="c1"># Continue training or evaluate etc.</span>
</pre></div>

<h4>More links</h4>
<ul>
<li>
<p>exhaustive and useful tutorial on <strong><code>saved_model</code></strong> -&gt; https://www.tensorflow.org/guide/saved_model</p>
</li>
<li>
<p><strong><code>keras</code></strong> detailed guide to save models -&gt; https://www.tensorflow.org/guide/keras/save_and_serialize</p>
</li>
</ul>
<blockquote>
<p>Checkpoints capture the exact value of all parameters (tf.Variable objects)
used by a model. <strong>Checkpoints do not contain any description of the
computation defined by the model</strong> and thus are typically only useful when
source code that will use the saved parameter values is available.</p>
<p>The SavedModel format on the other hand <strong>includes a serialized description
of the computation defined by the model</strong> in addition to the parameter
values (checkpoint). Models in this format are <em>independent</em> of the source
code that created the model. They are thus suitable for deployment via
TensorFlow Serving, TensorFlow Lite, TensorFlow.js, or programs in other
programming languages (the C, C++, Java, Go, Rust, C# etc. TensorFlow APIs).</p>
</blockquote>
<p>(Highlights are my own)</p>
<hr>
<h2>Tensorflow &lt; 2</h2>
<hr>
<p>From the docs:</p>
<h4>Save</h4>
<div class="code"><pre class="code literal-block"><span class="c1"># Create some variables.</span>
<span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s2">"v1"</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="n">initializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">zeros_initializer</span><span class="p">)</span>
<span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s2">"v2"</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">initializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">zeros_initializer</span><span class="p">)</span>

<span class="n">inc_v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v1</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">v1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dec_v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v2</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">v2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Add an op to initialize the variables.</span>
<span class="n">init_op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span>

<span class="c1"># Add ops to save and restore all the variables.</span>
<span class="n">saver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>

<span class="c1"># Later, launch the model, initialize the variables, do some work, and save the</span>
<span class="c1"># variables to disk.</span>
<span class="n">with</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">sess</span><span class="p">:</span>
<span class="w">  </span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init_op</span><span class="p">)</span>
<span class="w">  </span><span class="c1"># Do some work with the model.</span>
<span class="w">  </span><span class="n">inc_v1</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="w">  </span><span class="n">dec_v2</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="w">  </span><span class="c1"># Save the variables to disk.</span>
<span class="w">  </span><span class="n">save_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span><span class="w"> </span><span class="s2">"/tmp/model.ckpt"</span><span class="p">)</span>
<span class="w">  </span><span class="nb">print</span><span class="p">(</span><span class="s2">"Model saved in path: </span><span class="si">%s</span><span class="s2">"</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">save_path</span><span class="p">)</span>
</pre></div>

<h4>Restore</h4>
<div class="code"><pre class="code literal-block"><span class="n">tf</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>

<span class="c1"># Create some variables.</span>
<span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s2">"v1"</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s2">"v2"</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

<span class="c1"># Add ops to save and restore all the variables.</span>
<span class="n">saver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>

<span class="c1"># Later, launch the model, use the saver to restore variables from disk, and</span>
<span class="c1"># do some work with the model.</span>
<span class="n">with</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">sess</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Restore variables from disk.</span>
<span class="w">  </span><span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span><span class="w"> </span><span class="s2">"/tmp/model.ckpt"</span><span class="p">)</span>
<span class="w">  </span><span class="nb">print</span><span class="p">(</span><span class="s2">"Model restored."</span><span class="p">)</span>
<span class="w">  </span><span class="c1"># Check the values of the variables</span>
<span class="w">  </span><span class="nb">print</span><span class="p">(</span><span class="s2">"v1 : </span><span class="si">%s</span><span class="s2">"</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">v1</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
<span class="w">  </span><span class="nb">print</span><span class="p">(</span><span class="s2">"v2 : </span><span class="si">%s</span><span class="s2">"</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">v2</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
</pre></div>

<h3><code>simple_save</code></h3>
<p>Many good answer, for completeness I'll add my 2 cents: <strong>simple_save</strong>. Also
a standalone code example using the <code>tf.data.Dataset</code> API.</p>
<p>Python 3 ; Tensorflow <strong>1.14</strong></p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.saved_model</span> <span class="kn">import</span> <span class="n">tag_constants</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="o">...</span>

        <span class="c1"># Saving</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"batch_size_placeholder"</span><span class="p">:</span> <span class="n">batch_size_placeholder</span><span class="p">,</span>
            <span class="s2">"features_placeholder"</span><span class="p">:</span> <span class="n">features_placeholder</span><span class="p">,</span>
            <span class="s2">"labels_placeholder"</span><span class="p">:</span> <span class="n">labels_placeholder</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"prediction"</span><span class="p">:</span> <span class="n">model_output</span><span class="p">}</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">simple_save</span><span class="p">(</span>
            <span class="n">sess</span><span class="p">,</span> <span class="s1">'path/to/your/location/'</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span>
        <span class="p">)</span>
</pre></div>

<p>Restoring:</p>
<div class="code"><pre class="code literal-block"><span class="n">graph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
<span class="n">with</span><span class="w"> </span><span class="n">restored_graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
<span class="w">    </span><span class="n">with</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">sess</span><span class="p">:</span>
<span class="w">        </span><span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
<span class="w">            </span><span class="n">sess</span><span class="p">,</span>
<span class="w">            </span><span class="p">[</span><span class="n">tag_constants</span><span class="o">.</span><span class="n">SERVING</span><span class="p">],</span>
<span class="w">            </span><span class="s1">'path/to/your/location/'</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="n">batch_size_placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">'batch_size_placeholder:0'</span><span class="p">)</span>
<span class="w">        </span><span class="n">features_placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">'features_placeholder:0'</span><span class="p">)</span>
<span class="w">        </span><span class="n">labels_placeholder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">'labels_placeholder:0'</span><span class="p">)</span>
<span class="w">        </span><span class="n">prediction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restored_graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">'dense/BiasAdd:0'</span><span class="p">)</span>

<span class="w">        </span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span><span class="w"> </span><span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span>
<span class="w">            </span><span class="n">batch_size_placeholder</span><span class="p">:</span><span class="w"> </span><span class="n">some_value</span><span class="p">,</span>
<span class="w">            </span><span class="n">features_placeholder</span><span class="p">:</span><span class="w"> </span><span class="n">some_other_value</span><span class="p">,</span>
<span class="w">            </span><span class="n">labels_placeholder</span><span class="p">:</span><span class="w"> </span><span class="n">another_value</span>
<span class="w">        </span><span class="p">})</span>
</pre></div>

<h2>Standalone example</h2>
<p><strong>Original blog post</strong></p>
<p>The following code generates random data for the sake of the demonstration.</p>
<ol>
<li>We start by creating the placeholders. They will hold the data at runtime. From them, we create the <code>Dataset</code> and then its <code>Iterator</code>. We get the iterator's generated tensor, called <code>input_tensor</code> which will serve as input to our model.</li>
<li>The model itself is built from <code>input_tensor</code>: a GRU-based bidirectional RNN followed by a dense classifier. Because why not.</li>
<li>The loss is a <code>softmax_cross_entropy_with_logits</code>, optimized with <code>Adam</code>. After 2 epochs (of 2 batches each), we save the "trained" model with <code>tf.saved_model.simple_save</code>. If you run the code as is, then the model will be saved in a folder called <code>simple/</code> in your current working directory.</li>
<li>In a new graph, we then restore the saved model with <code>tf.saved_model.loader.load</code>. We grab the placeholders and logits with <code>graph.get_tensor_by_name</code> and the <code>Iterator</code> initializing operation with <code>graph.get_operation_by_name</code>.</li>
<li>Lastly we run an inference for both batches in the dataset, and check that the saved and restored model both yield the same values. They do!</li>
</ol>
<p>Code:</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.saved_model</span> <span class="kn">import</span> <span class="n">tag_constants</span>


<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">input_tensor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create the model which consists of</span>
<span class="sd">    a bidirectional rnn (GRU(10)) followed by a dense classifier</span>

<span class="sd">    Args:</span>
<span class="sd">        graph (tf.Graph): Tensors' graph</span>
<span class="sd">        input_tensor (tf.Tensor): Tensor fed as input to the model</span>

<span class="sd">    Returns:</span>
<span class="sd">        tf.Tensor: the model's output layer Tensor</span>
<span class="sd">    """</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">rnn_cell</span><span class="o">.</span><span class="n">GRUCell</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
        <span class="p">((</span><span class="n">fw_outputs</span><span class="p">,</span> <span class="n">bw_outputs</span><span class="p">),</span> <span class="p">(</span><span class="n">fw_state</span><span class="p">,</span> <span class="n">bw_state</span><span class="p">))</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">bidirectional_dynamic_rnn</span><span class="p">(</span>
            <span class="n">cell_fw</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span>
            <span class="n">cell_bw</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">=</span><span class="n">input_tensor</span><span class="p">,</span>
            <span class="n">sequence_length</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="mi">32</span><span class="p">,</span>
            <span class="kp">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">swap_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">fw_outputs</span><span class="p">,</span> <span class="n">bw_outputs</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="kp">mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="kp">mean</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dense</span>


<span class="k">def</span> <span class="nf">get_opt_op</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">labels_tensor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create optimization operation from model's logits and labels</span>

<span class="sd">    Args:</span>
<span class="sd">        graph (tf.Graph): Tensors' graph</span>
<span class="sd">        logits (tf.Tensor): The model's output without activation</span>
<span class="sd">        labels_tensor (tf.Tensor): Target labels</span>

<span class="sd">    Returns:</span>
<span class="sd">        tf.Operation: the operation performing a stem of Adam optimizer</span>
<span class="sd">    """</span>
    <span class="k">with</span> <span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">'loss'</span><span class="p">):</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax_cross_entropy_with_logits</span><span class="p">(</span>
                    <span class="n">logits</span><span class="o">=</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels_tensor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'xent'</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">"mean-xent"</span>
                    <span class="p">)</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">'optimizer'</span><span class="p">):</span>
            <span class="n">opt_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">)</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">opt_op</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="c1"># Set random seed for reproducibility</span>
    <span class="c1"># and create synthetic data</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">eye</span><span class="p">(</span><span class="mi">5</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,))]</span>

    <span class="n">graph1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">graph1</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
        <span class="c1"># Random seed for reproducibility</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Placeholders</span>
        <span class="n">batch_size_ph</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'batch_size_ph'</span><span class="p">)</span>
        <span class="n">features_data_ph</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="s1">'features_data_ph'</span><span class="p">)</span>
        <span class="n">labels_data_ph</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="s1">'labels_data_ph'</span><span class="p">)</span>
        <span class="c1"># Dataset</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="n">features_data_ph</span><span class="p">,</span> <span class="n">labels_data_ph</span><span class="p">))</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size_ph</span><span class="p">)</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Iterator</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">output_types</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">output_shapes</span><span class="p">)</span>
        <span class="n">dataset_init_op</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="n">make_initializer</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'dataset_init'</span><span class="p">)</span>
        <span class="n">input_tensor</span><span class="p">,</span> <span class="n">labels_tensor</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>

        <span class="c1"># Model</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">graph1</span><span class="p">,</span> <span class="n">input_tensor</span><span class="p">)</span>
        <span class="c1"># Optimization</span>
        <span class="n">opt_op</span> <span class="o">=</span> <span class="n">get_opt_op</span><span class="p">(</span><span class="n">graph1</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">labels_tensor</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">graph1</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
            <span class="c1"># Initialize variables</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Initialize dataset (could feed epochs in Dataset.repeat(epochs))</span>
                <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="n">dataset_init_op</span><span class="p">,</span>
                    <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span>
                        <span class="n">features_data_ph</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
                        <span class="n">labels_data_ph</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
                        <span class="n">batch_size_ph</span><span class="p">:</span> <span class="mi">32</span>
                    <span class="p">})</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="c1"># Training</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">opt_op</span><span class="p">,</span> <span class="n">logits</span><span class="p">])</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">'Epoch </span><span class="si">{}</span><span class="s1">, batch </span><span class="si">{}</span><span class="s1"> | Sample value: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="n">batch</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Final inference</span>
                            <span class="n">values</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">logits</span><span class="p">))</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">'Epoch </span><span class="si">{}</span><span class="s1">, batch </span><span class="si">{}</span><span class="s1"> | Final inference | Sample value: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="n">batch</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="n">tf</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">OutOfRangeError</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="c1"># Save model state</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Saving...'</span><span class="p">)</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="s1">'simple'</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">inputs_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">"batch_size_ph"</span><span class="p">:</span> <span class="n">batch_size_ph</span><span class="p">,</span>
                <span class="s2">"features_data_ph"</span><span class="p">:</span> <span class="n">features_data_ph</span><span class="p">,</span>
                <span class="s2">"labels_data_ph"</span><span class="p">:</span> <span class="n">labels_data_ph</span>
            <span class="p">}</span>
            <span class="n">outputs_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">"logits"</span><span class="p">:</span> <span class="n">logits</span>
            <span class="p">}</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">simple_save</span><span class="p">(</span>
                <span class="n">sess</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">inputs_dict</span><span class="p">,</span> <span class="n">outputs_dict</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'Ok'</span><span class="p">)</span>
    <span class="c1"># Restoring</span>
    <span class="n">graph2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">graph2</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">graph2</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
            <span class="c1"># Restore saved values</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Restoring...'</span><span class="p">)</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="kp">load</span><span class="p">(</span>
                <span class="n">sess</span><span class="p">,</span>
                <span class="p">[</span><span class="n">tag_constants</span><span class="o">.</span><span class="n">SERVING</span><span class="p">],</span>
                <span class="n">path</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'Ok'</span><span class="p">)</span>
            <span class="c1"># Get restored placeholders</span>
            <span class="n">labels_data_ph</span> <span class="o">=</span> <span class="n">graph2</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">'labels_data_ph:0'</span><span class="p">)</span>
            <span class="n">features_data_ph</span> <span class="o">=</span> <span class="n">graph2</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">'features_data_ph:0'</span><span class="p">)</span>
            <span class="n">batch_size_ph</span> <span class="o">=</span> <span class="n">graph2</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">'batch_size_ph:0'</span><span class="p">)</span>
            <span class="c1"># Get restored model output</span>
            <span class="n">restored_logits</span> <span class="o">=</span> <span class="n">graph2</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">'dense/BiasAdd:0'</span><span class="p">)</span>
            <span class="c1"># Get dataset initializing operation</span>
            <span class="n">dataset_init_op</span> <span class="o">=</span> <span class="n">graph2</span><span class="o">.</span><span class="n">get_operation_by_name</span><span class="p">(</span><span class="s1">'dataset_init'</span><span class="p">)</span>

            <span class="c1"># Initialize restored dataset</span>
            <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">dataset_init_op</span><span class="p">,</span>
                <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span>
                    <span class="n">features_data_ph</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
                    <span class="n">labels_data_ph</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
                    <span class="n">batch_size_ph</span><span class="p">:</span> <span class="mi">32</span>
                <span class="p">}</span>

            <span class="p">)</span>
            <span class="c1"># Compute inference for both batches in dataset</span>
            <span class="n">restored_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">restored_values</span><span class="o">.</span><span class="kp">append</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">restored_logits</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">'Restored values: '</span><span class="p">,</span> <span class="n">restored_values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Check if original inference and restored inference are equal</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="nb">all</span><span class="p">((</span><span class="n">v</span> <span class="o">==</span> <span class="n">rv</span><span class="p">)</span><span class="o">.</span><span class="kp">all</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">rv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">restored_values</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Inferences match: '</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span>
</pre></div>

<p>This will print:</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>python3<span class="w"> </span>save_and_restore.py

Epoch<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>batch<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Sample<span class="w"> </span>value:<span class="w"> </span><span class="o">[</span>-0.13851789<span class="w"> </span>-0.3087595<span class="w">   </span><span class="m">0</span>.12804556<span class="w">  </span><span class="m">0</span>.20013677<span class="w"> </span>-0.08229901<span class="o">]</span>
Epoch<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>batch<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Sample<span class="w"> </span>value:<span class="w"> </span><span class="o">[</span>-0.00555491<span class="w"> </span>-0.04339041<span class="w"> </span>-0.05111827<span class="w"> </span>-0.2480045<span class="w">  </span>-0.00107776<span class="o">]</span>
Epoch<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>batch<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Sample<span class="w"> </span>value:<span class="w"> </span><span class="o">[</span>-0.19321944<span class="w"> </span>-0.2104792<span class="w">  </span>-0.00602257<span class="w">  </span><span class="m">0</span>.07465433<span class="w">  </span><span class="m">0</span>.11674127<span class="o">]</span>
Epoch<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>batch<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Sample<span class="w"> </span>value:<span class="w"> </span><span class="o">[</span>-0.05275984<span class="w">  </span><span class="m">0</span>.05981954<span class="w"> </span>-0.15913513<span class="w"> </span>-0.3244143<span class="w">   </span><span class="m">0</span>.10673307<span class="o">]</span>
Epoch<span class="w"> </span><span class="m">2</span>,<span class="w"> </span>batch<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Final<span class="w"> </span>inference<span class="w"> </span><span class="p">|</span><span class="w"> </span>Sample<span class="w"> </span>value:<span class="w"> </span><span class="o">[</span>-0.26331693<span class="w"> </span>-0.13013336<span class="w"> </span>-0.12553<span class="w">    </span>-0.04276478<span class="w">  </span><span class="m">0</span>.2933622<span class="w"> </span><span class="o">]</span>
Epoch<span class="w"> </span><span class="m">2</span>,<span class="w"> </span>batch<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Final<span class="w"> </span>inference<span class="w"> </span><span class="p">|</span><span class="w"> </span>Sample<span class="w"> </span>value:<span class="w"> </span><span class="o">[</span>-0.07730117<span class="w">  </span><span class="m">0</span>.11119192<span class="w"> </span>-0.20817074<span class="w"> </span>-0.35660955<span class="w">  </span><span class="m">0</span>.16990358<span class="o">]</span>

Saving...
INFO:tensorflow:Assets<span class="w"> </span>added<span class="w"> </span>to<span class="w"> </span>graph.
INFO:tensorflow:No<span class="w"> </span>assets<span class="w"> </span>to<span class="w"> </span>write.
INFO:tensorflow:SavedModel<span class="w"> </span>written<span class="w"> </span>to:<span class="w"> </span>b<span class="s1">'/some/path/simple/saved_model.pb'</span>
Ok

Restoring...
INFO:tensorflow:Restoring<span class="w"> </span>parameters<span class="w"> </span>from<span class="w"> </span>b<span class="s1">'/some/path/simple/variables/variables'</span>
Ok
Restored<span class="w"> </span>values:<span class="w">  </span><span class="o">[</span>-0.26331693<span class="w"> </span>-0.13013336<span class="w"> </span>-0.12553<span class="w">    </span>-0.04276478<span class="w">  </span><span class="m">0</span>.2933622<span class="w"> </span><span class="o">]</span>
Restored<span class="w"> </span>values:<span class="w">  </span><span class="o">[</span>-0.07730117<span class="w">  </span><span class="m">0</span>.11119192<span class="w"> </span>-0.20817074<span class="w"> </span>-0.35660955<span class="w">  </span><span class="m">0</span>.16990358<span class="o">]</span>

Inferences<span class="w"> </span>match:<span class="w">  </span>True
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>In (and after) TensorFlow version 0.11.0RC1, you can save and restore your
model directly by calling <code>tf.train.export_meta_graph</code> and
<code>tf.train.import_meta_graph</code> according to
https://www.tensorflow.org/programmers_guide/meta_graph.</p>
<h4>Save the model</h4>
<div class="code"><pre class="code literal-block"><span class="n">w1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="p">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="err">[</span><span class="mi">10</span><span class="err">]</span><span class="p">),</span><span class="w"> </span><span class="k">name</span><span class="o">=</span><span class="s1">'w1'</span><span class="p">)</span>
<span class="n">w2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="p">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">truncated_normal</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="err">[</span><span class="mi">20</span><span class="err">]</span><span class="p">),</span><span class="w"> </span><span class="k">name</span><span class="o">=</span><span class="s1">'w2'</span><span class="p">)</span>
<span class="n">tf</span><span class="p">.</span><span class="n">add_to_collection</span><span class="p">(</span><span class="s1">'vars'</span><span class="p">,</span><span class="w"> </span><span class="n">w1</span><span class="p">)</span>
<span class="n">tf</span><span class="p">.</span><span class="n">add_to_collection</span><span class="p">(</span><span class="s1">'vars'</span><span class="p">,</span><span class="w"> </span><span class="n">w2</span><span class="p">)</span>
<span class="n">saver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">Saver</span><span class="p">()</span>
<span class="n">sess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="p">.</span><span class="k">Session</span><span class="p">()</span>
<span class="n">sess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">global_variables_initializer</span><span class="p">())</span>
<span class="n">saver</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span><span class="w"> </span><span class="s1">'my-model'</span><span class="p">)</span>
<span class="c1"># `save` method will call `export_meta_graph` implicitly.</span>
<span class="c1"># you will get saved graph files:my-model.meta</span>
</pre></div>

<h4>Restore the model</h4>
<div class="code"><pre class="code literal-block"><span class="n">sess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">new_saver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">import_meta_graph</span><span class="p">(</span><span class="s1">'my-model.meta'</span><span class="p">)</span>
<span class="n">new_saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="s1">'./'</span><span class="p">))</span>
<span class="n">all_vars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">'vars'</span><span class="p">)</span>
<span class="k">for</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">all_vars</span><span class="p">:</span>
<span class="w">    </span><span class="n">v_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="n">v_</span><span class="p">)</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/preferred-method-to-store-php-arrays-json-encode-vs-serialize/" class="u-url">Preferred method to store PHP arrays (json_encode vs serialize)</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/preferred-method-to-store-php-arrays-json-encode-vs-serialize/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T20:25:21+08:00" itemprop="datePublished" title="2023-02-17 20:25">2023-02-17 20:25</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I need to store a multi-dimensional associative array of data in a flat file
for caching purposes. I might occasionally come across the need to convert it
to JSON for use in my web app but the vast majority of the time I will be
using the array directly in PHP.</p>
<p>Would it be more efficient to store the array as JSON or as a PHP serialized
array in this text file? I've looked around and it seems that in the newest
versions of PHP (5.3), <code>json_decode</code> is actually faster than <code>unserialize</code>.</p>
<p>I'm currently leaning towards storing the array as JSON as I feel its easier
to read by a human if necessary, it can be used in both PHP and JavaScript
with very little effort, and from what I've read, it might even be faster to
decode (not sure about encoding, though).</p>
<p>Does anyone know of any pitfalls? Anyone have good benchmarks to show the
performance benefits of either method?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Depends on your priorities.</p>
<p>If performance is your absolute driving characteristic, then by all means use
the fastest one. Just make sure you have a full understanding of the
differences before you make a choice</p>
<ul>
<li>Unlike <code>serialize()</code> you need to add extra parameter to keep UTF-8 characters untouched: <code>json_encode($array, JSON_UNESCAPED_UNICODE)</code> (otherwise it converts UTF-8 characters to Unicode escape sequences).</li>
<li>JSON will have no memory of what the object's original class was (they are always restored as instances of stdClass).</li>
<li>You can't leverage <code>__sleep()</code> and <code>__wakeup()</code> with JSON</li>
<li>By default, only public properties are serialized with JSON. (in <code>PHP&gt;=5.4</code> you can implement JsonSerializable to change this behavior).</li>
<li>JSON is more portable</li>
</ul>
<p>And there's probably a few other differences I can't think of at the moment.</p>
<p>A simple speed test to compare the two</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>

<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'display_errors'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="k">E_ALL</span><span class="p">);</span>

<span class="c1">// Make a big, honkin test array</span>
<span class="c1">// You may need to adjust this depth to avoid memory limit errors</span>
<span class="nv">$testArray</span> <span class="o">=</span> <span class="nx">fillArray</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

<span class="c1">// Time json encoding</span>
<span class="nv">$start</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="nb">json_encode</span><span class="p">(</span><span class="nv">$testArray</span><span class="p">);</span>
<span class="nv">$jsonTime</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$start</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"JSON encoded in </span><span class="si">$jsonTime</span><span class="s2"> seconds</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="c1">// Time serialization</span>
<span class="nv">$start</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="nb">serialize</span><span class="p">(</span><span class="nv">$testArray</span><span class="p">);</span>
<span class="nv">$serializeTime</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$start</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"PHP serialized in </span><span class="si">$serializeTime</span><span class="s2"> seconds</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="c1">// Compare them</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$jsonTime</span> <span class="o">&lt;</span> <span class="nv">$serializeTime</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s2">"json_encode() was roughly %01.2f%% faster than serialize()</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="p">(</span><span class="nv">$serializeTime</span> <span class="o">/</span> <span class="nv">$jsonTime</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$serializeTime</span> <span class="o">&lt;</span> <span class="nv">$jsonTime</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nb">printf</span><span class="p">(</span><span class="s2">"serialize() was roughly %01.2f%% faster than json_encode()</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="p">(</span><span class="nv">$jsonTime</span> <span class="o">/</span> <span class="nv">$serializeTime</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Impossible!</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">fillArray</span><span class="p">(</span> <span class="nv">$depth</span><span class="p">,</span> <span class="nv">$max</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="nv">$seed</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$seed</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$seed</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">'e'</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">'g'</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">'i'</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$depth</span> <span class="o">&lt;</span> <span class="nv">$max</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$node</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$seed</span> <span class="k">as</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$node</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fillArray</span><span class="p">(</span><span class="nv">$depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$max</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$node</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s1">'empty'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p><strong>JSON</strong> is simpler and faster than PHP's serialization format and should be
used <strong>unless</strong> :</p>
<ul>
<li>You're storing deeply nested arrays: <code>json_decode()</code>: "This function will return false if the JSON encoded data is deeper than 127 elements."</li>
<li>You're storing objects that need to be unserialized as the correct class</li>
<li>You're interacting with old PHP versions that don't support json_decode</li>
</ul>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-do-i-use-wpf-bindings-with-relativesource/" class="u-url">How do I use WPF bindings with RelativeSource?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-do-i-use-wpf-bindings-with-relativesource/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T20:24:40+08:00" itemprop="datePublished" title="2023-02-17 20:24">2023-02-17 20:24</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>How do I use <code>RelativeSource</code> with WPF bindings and what are the different
use-cases?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>If you want to bind to another property on the object:</p>
<div class="code"><pre class="code literal-block">{Binding Path=PathToProperty, RelativeSource={RelativeSource Self}}
</pre></div>

<p>If you want to get a property on an ancestor:</p>
<div class="code"><pre class="code literal-block">{Binding Path=PathToProperty,
    RelativeSource={RelativeSource AncestorType={x:Type typeOfAncestor}}}
</pre></div>

<p>If you want to get a property on the templated parent (so you can do 2 way
bindings in a ControlTemplate)</p>
<div class="code"><pre class="code literal-block">{Binding Path=PathToProperty, RelativeSource={RelativeSource TemplatedParent}}
</pre></div>

<p>or, shorter (this only works for OneWay bindings):</p>
<div class="code"><pre class="code literal-block">{TemplateBinding Path=PathToProperty}
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<div class="code"><pre class="code literal-block">Binding RelativeSource={
    RelativeSource Mode=FindAncestor, AncestorType={x:Type ItemType}
}
...
</pre></div>

<p>The default attribute of <code>RelativeSource</code> is the <code>Mode</code> property. A complete
set of valid values is given here (from MSDN):</p>
<ul>
<li>
<p><em>PreviousData</em> Allows you to bind the previous data item (not that control that contains the data item) in the list of data items being displayed.</p>
</li>
<li>
<p><em>TemplatedParent</em> Refers to the element to which the template (in which the data-bound element exists) is applied. This is similar to setting a TemplateBindingExtension and is only applicable if the Binding is within a template.</p>
</li>
<li>
<p><em>Self</em> Refers to the element on which you are setting the binding and allows you to bind one property of that element to another property on the same element.</p>
</li>
<li>
<p><em>FindAncestor</em> Refers to the ancestor in the parent chain of the data-bound element. You can use this to bind to an ancestor of a specific type or its subclasses. This is the mode you use if you want to specify AncestorType and/or AncestorLevel.</p>
</li>
</ul>
</div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-953.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-951.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
