<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 863) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-863.html">
<link rel="prev" href="index-864.html" type="text/html">
<link rel="next" href="index-862.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/what-s-the-postgresql-datatype-equivalent-to-mysql-auto-increment/" class="u-url">What's the PostgreSQL datatype equivalent to MySQL AUTO INCREMENT?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/what-s-the-postgresql-datatype-equivalent-to-mysql-auto-increment/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T18:00:51+08:00" itemprop="datePublished" title="2023-02-17 18:00">2023-02-17 18:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I'm switching from MySQL to PostgreSQL and I was wondering how can I have an
<code>INT</code> column with <code>AUTO INCREMENT</code>. I saw in the PostgreSQL docs a datatype
called <code>SERIAL</code>, but I get syntax errors when using it.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Yes, SERIAL is the equivalent function.</p>
<div class="code"><pre class="code literal-block"><span class="n">CREATE</span><span class="w"> </span><span class="n">TABLE</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">SERIAL</span><span class="p">,</span>
<span class="w">    </span><span class="n">bar</span><span class="w"> </span><span class="n">varchar</span>
<span class="p">);</span>

<span class="n">INSERT</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">(</span><span class="n">bar</span><span class="p">)</span><span class="w"> </span><span class="n">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">'blah'</span><span class="p">);</span>
<span class="n">INSERT</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">(</span><span class="n">bar</span><span class="p">)</span><span class="w"> </span><span class="n">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">'blah'</span><span class="p">);</span>

<span class="n">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FROM</span><span class="w"> </span><span class="n">foo</span><span class="p">;</span>

<span class="o">+----------+</span>
<span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">blah</span><span class="w"> </span><span class="o">|</span>
<span class="o">+----------+</span>
<span class="o">|</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">blah</span><span class="w"> </span><span class="o">|</span>
<span class="o">+----------+</span>
</pre></div>

<p>SERIAL is just a create table time macro around sequences. You can not alter
SERIAL onto an existing column.</p>
<p><br></p>
<h3>Suggest</h3>
<p>You can use any other integer data type, such as <code>smallint</code>.</p>
<p>Example :</p>
<div class="code"><pre class="code literal-block">CREATE SEQUENCE user_id_seq;
CREATE TABLE user (
    user_id smallint NOT NULL DEFAULT nextval('user_id_seq')
);
ALTER SEQUENCE user_id_seq OWNED BY user.user_id;
</pre></div>

<p>Better to use your own data type, rather than user serial data type.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/making-a-div-vertically-scrollable-using-css/" class="u-url">Making a div vertically scrollable using CSS</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/making-a-div-vertically-scrollable-using-css/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T18:00:22+08:00" itemprop="datePublished" title="2023-02-17 18:00">2023-02-17 18:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>This</p>
<div class="code"><pre class="code literal-block"><span class="o">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="nt">id</span><span class="o">=</span><span class="s2">""</span><span class="w"> </span><span class="nt">style</span><span class="o">=</span><span class="s2">"overflow:scroll; height:400px;"</span><span class="o">&gt;</span>
</pre></div>

<p>gives a <code>div</code> that the user can scroll in both in horizontally and vertically.
How do I change it so that the div is <em>only</em> scrollable vertically?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>You have it covered aside from using the wrong property. The scrollbar can be
triggered with any property <code>overflow</code>, <code>overflow-x</code>, or <code>overflow-y</code> and each
can be set to any of <code>visible</code>, <code>hidden</code>, <code>scroll</code>, <code>auto</code>, or <code>inherit</code>. You
are currently looking at these two:</p>
<ul>
<li>
<p><code>auto</code> - This value will look at the width and height of the box. If they are defined, it won't let the box expand past those boundaries. Instead (if the content exceeds those boundaries), it will create a scrollbar for either boundary (or both) that exceeds its length.</p>
</li>
<li>
<p><code>scroll</code> - This values <em>forces</em> a scrollbar, no matter what, even if the content does not exceed the boundary set. If the content doesn't need to be scrolled, the bar will appear as "disabled" or non-interactive.</p>
</li>
</ul>
<p><strong>If you <em>always</em> want the vertical scrollbar to appear:</strong></p>
<p>You should use <code>overflow-y: scroll</code>. This <em>forces</em> a scrollbar to appear for
the vertical axis whether or not it is needed. If you can't actually scroll
the context, it will appear as a"disabled" scrollbar.</p>
<p><strong>If you only want a scrollbar to appear if you can scroll the box:</strong></p>
<p>Just use <code>overflow: auto</code>. Since your content by default just breaks to the
next line when it cannot fit on the current line, a horizontal scrollbar won't
be created (unless it's on an element that has word-wrapping disabled). For
the vertical bar,it will allow the content to expand up to the height you have
specified. If it exceeds that height, it will show a vertical scrollbar to
view the rest of the content, but will not show a scrollbar if it does not
exceed the height.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Try like this.</p>
<div class="code"><pre class="code literal-block"><span class="o">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="nt">style</span><span class="o">=</span><span class="s2">"overflow-y: scroll; height:400px;"</span><span class="o">&gt;</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-do-i-achieve-the-theoretical-maximum-of-4-flops-per-cycle/" class="u-url">How do I achieve the theoretical maximum of 4 FLOPs per cycle?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-do-i-achieve-the-theoretical-maximum-of-4-flops-per-cycle/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T17:59:06+08:00" itemprop="datePublished" title="2023-02-17 17:59">2023-02-17 17:59</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>How can the theoretical peak performance of 4 floating point operations
(double precision) per cycle be achieved on a modern x86-64 Intel CPU?</p>
<p>As far as I understand it takes three cycles for an SSE <code>add</code> and five cycles
for a <code>mul</code> to complete on most of the modern Intel CPUs (see for example
Agner Fog's 'Instruction Tables' ). Due to pipelining, one can get a
throughput of one <code>add</code> per cycle, if the algorithm has at least three
independent summations. Since that is true for both packed <code>addpd</code> as well as
the scalar <code>addsd</code> versions and SSE registers can contain two <code>double</code>'s, the
throughput can be as much as two flops per cycle.</p>
<p>Furthermore, it seems (although I've not seen any proper documentation on
this) <code>add</code>'s and <code>mul</code>'s can be executed in parallel giving a theoretical max
throughput of four flops per cycle.</p>
<p>However, I've not been able to replicate that performance with a simple C/C++
programme. My best attempt resulted in about 2.7 flops/cycle. If anyone can
contribute a simple C/C++ or assembler programme which demonstrates peak
performance, that'd be greatly appreciated.</p>
<p>My attempt:</p>
<div class="code"><pre class="code literal-block"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/time.h&gt;</span>

<span class="kt">double</span><span class="w"> </span><span class="nf">stoptime</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">struct</span><span class="w"> </span><span class="nc">timeval</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">   </span><span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">tv_usec</span><span class="o">/</span><span class="mf">1000000.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span><span class="w"> </span><span class="nf">addmul</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">add</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">mul</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ops</span><span class="p">){</span>
<span class="w">   </span><span class="c1">// Need to initialise differently otherwise compiler might optimise away</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">sum1</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">sum2</span><span class="o">=</span><span class="mf">-0.1</span><span class="p">,</span><span class="w"> </span><span class="n">sum3</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="n">sum4</span><span class="o">=</span><span class="mf">-0.2</span><span class="p">,</span><span class="w"> </span><span class="n">sum5</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">mul1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="n">mul2</span><span class="o">=</span><span class="w"> </span><span class="mf">1.1</span><span class="p">,</span><span class="w"> </span><span class="n">mul3</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span><span class="w"> </span><span class="n">mul4</span><span class="o">=</span><span class="w"> </span><span class="mf">1.3</span><span class="p">,</span><span class="w"> </span><span class="n">mul5</span><span class="o">=</span><span class="mf">1.4</span><span class="p">;</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">loops</span><span class="o">=</span><span class="n">ops</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span><span class="w">          </span><span class="c1">// We have 10 floating point operations inside the loop</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.0</span><span class="o">*</span><span class="n">add</span><span class="o">*</span><span class="n">loops</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">sum1</span><span class="o">+</span><span class="n">sum2</span><span class="o">+</span><span class="n">sum3</span><span class="o">+</span><span class="n">sum4</span><span class="o">+</span><span class="n">sum5</span><span class="p">)</span>
<span class="w">               </span><span class="o">+</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span><span class="n">loops</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">mul1</span><span class="o">+</span><span class="n">mul2</span><span class="o">+</span><span class="n">mul3</span><span class="o">+</span><span class="n">mul4</span><span class="o">+</span><span class="n">mul5</span><span class="p">);</span>

<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">loops</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">mul1</span><span class="o">*=</span><span class="n">mul</span><span class="p">;</span><span class="w"> </span><span class="n">mul2</span><span class="o">*=</span><span class="n">mul</span><span class="p">;</span><span class="w"> </span><span class="n">mul3</span><span class="o">*=</span><span class="n">mul</span><span class="p">;</span><span class="w"> </span><span class="n">mul4</span><span class="o">*=</span><span class="n">mul</span><span class="p">;</span><span class="w"> </span><span class="n">mul5</span><span class="o">*=</span><span class="n">mul</span><span class="p">;</span>
<span class="w">      </span><span class="n">sum1</span><span class="o">+=</span><span class="n">add</span><span class="p">;</span><span class="w"> </span><span class="n">sum2</span><span class="o">+=</span><span class="n">add</span><span class="p">;</span><span class="w"> </span><span class="n">sum3</span><span class="o">+=</span><span class="n">add</span><span class="p">;</span><span class="w"> </span><span class="n">sum4</span><span class="o">+=</span><span class="n">add</span><span class="p">;</span><span class="w"> </span><span class="n">sum5</span><span class="o">+=</span><span class="n">add</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="k">return</span><span class="w">  </span><span class="n">sum1</span><span class="o">+</span><span class="n">sum2</span><span class="o">+</span><span class="n">sum3</span><span class="o">+</span><span class="n">sum4</span><span class="o">+</span><span class="n">sum5</span><span class="o">+</span><span class="n">mul1</span><span class="o">+</span><span class="n">mul2</span><span class="o">+</span><span class="n">mul3</span><span class="o">+</span><span class="n">mul4</span><span class="o">+</span><span class="n">mul5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">expected</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">"usage: %s &lt;num&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">"number of operations: &lt;num&gt; millions</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">      </span><span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>
<span class="w">       </span><span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">;</span>

<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M_PI</span><span class="p">;</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1e-8</span><span class="p">;</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stoptime</span><span class="p">();</span>
<span class="w">   </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="w">   </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stoptime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">"addmul:</span><span class="se">\t</span><span class="s"> %.3f s, %.3f Gflops, res=%f</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">n</span><span class="o">/</span><span class="n">t</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Compiled with:</p>
<div class="code"><pre class="code literal-block">g++ -O2 -march=native addmul.cpp ; ./a.out 1000
</pre></div>

<p>produces the following output on an Intel Core i5-750, 2.66 GHz:</p>
<div class="code"><pre class="code literal-block"><span class="n">addmul</span><span class="o">:</span><span class="w">  </span><span class="mf">0.270</span><span class="w"> </span><span class="n">s</span><span class="o">,</span><span class="w"> </span><span class="mf">3.707</span><span class="w"> </span><span class="n">Gflops</span><span class="o">,</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="mf">1.326463</span>
</pre></div>

<p>That is, just about 1.4 flops per cycle. Looking at the assembler code with
<code>g++ -S -O2 -march=native -masm=intel addmul.cpp</code> the main loop seems kind of
optimal to me.</p>
<div class="code"><pre class="code literal-block"><span class="nl">.L4:</span>
<span class="nf">inc</span><span class="w">    </span><span class="no">eax</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm8</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm7</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm6</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm5</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm13</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm12</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm11</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm10</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm9</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">cmp</span><span class="w">    </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="no">ebx</span>
<span class="nf">jne</span><span class="w">    </span><span class="no">.L4</span>
</pre></div>

<p>Changing the scalar versions with packed versions (<code>addpd</code> and <code>mulpd</code>) would
double the flop count without changing the execution time and so I'd get just
short of 2.8 flops per cycle. Is there a simple example which achieves four
flops per cycle?</p>
<p>Nice little programme by Mysticial; here are my results (run just for a few
seconds though):</p>
<ul>
<li>
<code>gcc -O2 -march=nocona</code>: 5.6 Gflops out of 10.66 Gflops (2.1 flops/cycle)</li>
<li>
<code>cl /O2</code>, openmp removed: 10.1 Gflops out of 10.66 Gflops (3.8 flops/cycle)</li>
</ul>
<p>It all seems a bit complex, but my conclusions so far:</p>
<ul>
<li>
<p><code>gcc -O2</code> changes the order of independent floating point operations with the aim of alternating <code>addpd</code> and <code>mulpd</code>'s if possible. Same applies to <code>gcc-4.6.2 -O2 -march=core2</code>.</p>
</li>
<li>
<p><code>gcc -O2 -march=nocona</code> seems to keep the order of floating point operations as defined in the C++ source.</p>
</li>
<li>
<p><code>cl /O2</code>, the 64-bit compiler from the SDK for Windows 7 does loop-unrolling automatically and seems to try and arrange operations so that groups of three <code>addpd</code>'s alternate with three <code>mulpd</code>'s (well, at least on my system and for my simple programme).</p>
</li>
<li>
<p>My Core i5 750 (Nehalem architecture) doesn't like alternating add's and mul's and seems unable to run both operations in parallel. However, if grouped in 3's, it suddenly works like magic.</p>
</li>
<li>
<p>Other architectures (possibly Sandy Bridge and others) appear to be able to execute add/mul in parallel without problems if they alternate in the assembly code.</p>
</li>
<li>
<p>Although difficult to admit, but on my system <code>cl /O2</code> does a much better job at low-level optimising operations for my system and achieves close to peak performance for the little C++ example above. I measured between 1.85-2.01 flops/cycle (have used clock() in Windows which is not that precise. I guess, need to use a better timer - thanks Mackie Messer).</p>
</li>
<li>
<p>The best I managed with <code>gcc</code> was to manually loop unroll and arrange additions and multiplications in groups of three. With <code>g++ -O2 -march=nocona addmul_unroll.cpp</code> I get at best <code>0.207s, 4.825 Gflops</code> which corresponds to 1.8 flops/cycle which I'm quite happy with now.</p>
</li>
</ul>
<p>In the C++ code I've replaced the <code>for</code> loop with:</p>
<div class="code"><pre class="code literal-block"><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">int</span><span class="w"> </span><span class="nv">i</span><span class="o">=</span><span class="mi">0</span><span class="c1">; i&lt;loops/3; i++) {</span>
<span class="w">       </span><span class="nv">mul1</span><span class="o">*=</span><span class="nv">mul</span><span class="c1">; mul2*=mul; mul3*=mul;</span>
<span class="w">       </span><span class="nv">sum1</span><span class="o">+=</span><span class="nv">add</span><span class="c1">; sum2+=add; sum3+=add;</span>
<span class="w">       </span><span class="nv">mul4</span><span class="o">*=</span><span class="nv">mul</span><span class="c1">; mul5*=mul; mul1*=mul;</span>
<span class="w">       </span><span class="nv">sum4</span><span class="o">+=</span><span class="nv">add</span><span class="c1">; sum5+=add; sum1+=add;</span>

<span class="w">       </span><span class="nv">mul2</span><span class="o">*=</span><span class="nv">mul</span><span class="c1">; mul3*=mul; mul4*=mul;</span>
<span class="w">       </span><span class="nv">sum2</span><span class="o">+=</span><span class="nv">add</span><span class="c1">; sum3+=add; sum4+=add;</span>
<span class="w">       </span><span class="nv">mul5</span><span class="o">*=</span><span class="nv">mul</span><span class="c1">; mul1*=mul; mul2*=mul;</span>
<span class="w">       </span><span class="nv">sum5</span><span class="o">+=</span><span class="nv">add</span><span class="c1">; sum1+=add; sum2+=add;</span>

<span class="w">       </span><span class="nv">mul3</span><span class="o">*=</span><span class="nv">mul</span><span class="c1">; mul4*=mul; mul5*=mul;</span>
<span class="w">       </span><span class="nv">sum3</span><span class="o">+=</span><span class="nv">add</span><span class="c1">; sum4+=add; sum5+=add;</span>
<span class="w">   </span>}
</pre></div>

<p>And the assembly now looks like:</p>
<div class="code"><pre class="code literal-block"><span class="nl">.L4:</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm8</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm7</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm6</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm13</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm12</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm11</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm5</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">mulsd</span><span class="w">    </span><span class="no">xmm8</span><span class="p">,</span><span class="w"> </span><span class="no">xmm3</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm10</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm9</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="nf">addsd</span><span class="w">    </span><span class="no">xmm13</span><span class="p">,</span><span class="w"> </span><span class="no">xmm2</span>
<span class="na">...</span>
</pre></div>

<p><br><br></p>
<h2>Answer</h2>
<p>I've done this exact task before. But it was mainly to measure power
consumption and CPU temperatures. The following code (which is fairly long)
achieves close to optimal on my Core i7 2600K.</p>
<p>The key thing to note here is the massive amount of manual loop-unrolling as
well as interleaving of multiplies and adds...</p>
<p>The full project can be found on my GitHub: https://github.com/Mysticial/Flops</p>
<h2>Warning:</h2>
<p><strong>If you decide to compile and run this, pay attention to your CPU
temperatures!!!</strong><br>
Make sure you don't overheat it. And make sure CPU-throttling doesn't affect
your results!</p>
<p>Furthermore, I take no responsibility for whatever damage that may result from
running this code.</p>
<p><strong>Notes:</strong></p>
<ul>
<li>This code is optimized for x64. x86 doesn't have enough registers for this to compile well.</li>
<li>
<p>This code has been tested to work well on Visual Studio 2010/2012 and GCC 4.6.<br>
ICC 11 (Intel Compiler 11) surprisingly has trouble compiling it well.</p>
</li>
<li>
<p>These are for pre-FMA processors. In order to achieve peak FLOPS on Intel Haswell and AMD Bulldozer processors (and later), FMA (Fused Multiply Add) instructions will be needed. These are beyond the scope of this benchmark.</p>
<h2>include <emmintrin.h></emmintrin.h>
</h2>
<h2>include <omp.h></omp.h>
</h2>
<h2>include <iostream></iostream>
</h2>
<p>using namespace std;</p>
<p>typedef unsigned long long uint64;</p>
<p>double test_dp_mac_SSE(double x,double y,uint64 iterations){
    register __m128d r0,r1,r2,r3,r4,r5,r6,r7,r8,r9,rA,rB,rC,rD,rE,rF;</p>
<div class="code"><pre class="code literal-block"><span class="c1">//  Generate starting data.</span>
<span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>

<span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0</span><span class="p">);</span>

<span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_xor_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r8</span><span class="p">);</span>
<span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r8</span><span class="p">);</span>
<span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_andnot_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">r0</span><span class="p">);</span>
<span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">0.37796447300922722721</span><span class="p">));</span>
<span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">0.24253562503633297352</span><span class="p">));</span>
<span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">4.1231056256176605498</span><span class="p">));</span>
<span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">0.37796447300922722721</span><span class="p">));</span>
<span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">0.24253562503633297352</span><span class="p">));</span>
<span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">4.1231056256176605498</span><span class="p">));</span>
<span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">4.1231056256176605498</span><span class="p">));</span>

<span class="n">rC</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">1.4142135623730950488</span><span class="p">);</span>
<span class="n">rD</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">1.7320508075688772935</span><span class="p">);</span>
<span class="n">rE</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">0.57735026918962576451</span><span class="p">);</span>
<span class="n">rF</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">0.70710678118654752440</span><span class="p">);</span>

<span class="n">uint64</span><span class="w"> </span><span class="n">iMASK</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x800fffffffffffffull</span><span class="p">;</span>
<span class="n">__m128d</span><span class="w"> </span><span class="n">MASK</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iMASK</span><span class="p">);</span>
<span class="n">__m128d</span><span class="w"> </span><span class="n">vONE</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_set1_pd</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>

<span class="n">uint64</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iterations</span><span class="p">){</span>
<span class="w">    </span><span class="n">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">){</span>
<span class="w">        </span><span class="c1">//  Here's the meat - the part that really matters.</span>

<span class="w">        </span><span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>

<span class="w">        </span><span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>

<span class="w">        </span><span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>

<span class="w">        </span><span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">        </span><span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">        </span><span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">        </span><span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_sub_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">        </span><span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>

<span class="w">        </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//  Need to renormalize to prevent denormal/overflow.</span>
<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_and_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">r9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">rB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_or_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>

<span class="w">    </span><span class="n">c</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r1</span><span class="p">);</span>
<span class="n">r2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">r3</span><span class="p">);</span>
<span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">r5</span><span class="p">);</span>
<span class="n">r6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">r7</span><span class="p">);</span>
<span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">r9</span><span class="p">);</span>
<span class="n">rA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rB</span><span class="p">);</span>

<span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r2</span><span class="p">);</span>
<span class="n">r4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">r6</span><span class="p">);</span>
<span class="n">r8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rA</span><span class="p">);</span>

<span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r4</span><span class="p">);</span>
<span class="n">r0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_mm_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r8</span><span class="p">);</span>

<span class="c1">//  Prevent Dead Code Elimination</span>
<span class="nb">double</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">__m128d</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">r0</span><span class="p">;</span>
<span class="n">out</span><span class="w"> </span><span class="o">+</span><span class="p">=</span><span class="w"> </span><span class="p">((</span><span class="nb">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">out</span><span class="w"> </span><span class="o">+</span><span class="p">=</span><span class="w"> </span><span class="p">((</span><span class="nb">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

<span class="k">return</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
</pre></div>

<p>}</p>
<p>void test_dp_mac_SSE(int tds,uint64 iterations){</p>
<div class="code"><pre class="code literal-block">double *sum = (double*)malloc(tds * sizeof(double));
double start = omp_get_wtime();
</pre></div>

<h2>pragma omp parallel num_threads(tds)</h2>
<div class="code"><pre class="code literal-block">{
<span class="w">    </span><span class="nv">double</span><span class="w"> </span><span class="nv">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">test_dp_mac_SSE</span><span class="ss">(</span><span class="mi">1</span>.<span class="mi">1</span>,<span class="mi">2</span>.<span class="mi">1</span>,<span class="nv">iterations</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">sum</span>[<span class="nv">omp_get_thread_num</span><span class="ss">()</span>]<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ret</span><span class="c1">;</span>
}

<span class="nv">double</span><span class="w"> </span><span class="nv">secs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">omp_get_wtime</span><span class="ss">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">start</span><span class="c1">;</span>
<span class="nv">uint64</span><span class="w"> </span><span class="nv">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">iterations</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">tds</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="c1">;</span>
<span class="nv">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s2">"Seconds = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">secs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">endl</span><span class="c1">;</span>
<span class="nv">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s2">"FP Ops  = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">ops</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">endl</span><span class="c1">;</span>
<span class="nv">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s2">"FLOPs   = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">ops</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">secs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">endl</span><span class="c1">;</span>

<span class="nv">double</span><span class="w"> </span><span class="nv">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">;</span>
<span class="nv">int</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">;</span>
<span class="k">while</span><span class="w"> </span><span class="ss">(</span><span class="nv">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">tds</span><span class="ss">)</span>{
<span class="w">    </span><span class="nv">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">sum</span>[<span class="nv">c</span><span class="o">++</span>]<span class="c1">;</span>
}

<span class="nv">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s2">"sum = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">out</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">endl</span><span class="c1">;</span>
<span class="nv">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nv">endl</span><span class="c1">;</span>

<span class="nv">free</span><span class="ss">(</span><span class="nv">sum</span><span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p>}</p>
<p>int main(){
    //  (threads, iterations)
    test_dp_mac_SSE(8,10000000);</p>
<div class="code"><pre class="code literal-block"><span class="nv">system</span><span class="ss">(</span><span class="s2">"pause"</span><span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p>}</p>
</li>
</ul>
<p><strong>Output (1 thread, 10000000 iterations) - Compiled with Visual Studio 2010
SP1 - x64 Release:</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 55.5104
FP Ops  = 960000000000
FLOPs   = 1.7294e+010
sum = 2.22652
</pre></div>

<p>The machine is a Core i7 2600K @ 4.4 GHz. Theoretical SSE peak is 4 flops *
4.4 GHz = <strong>17.6 GFlops</strong>. This code achieves <strong>17.3 GFlops</strong> - not bad.</p>
<p><strong>Output (8 threads, 10000000 iterations) - Compiled with Visual Studio 2010
SP1 - x64 Release:</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 117.202
FP Ops  = 7680000000000
FLOPs   = 6.55279e+010
sum = 17.8122
</pre></div>

<p>Theoretical SSE peak is 4 flops * 4 cores * 4.4 GHz = <strong>70.4 GFlops.</strong> Actual
is <strong>65.5 GFlops</strong>.</p>
<hr>
<h3>Let's take this one step further. AVX...</h3>
<div class="code"><pre class="code literal-block"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;immintrin.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="n">using</span><span class="w"> </span><span class="n">namespace</span><span class="w"> </span><span class="nn">std</span><span class="p">;</span>

<span class="kr">typedef</span><span class="w"> </span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="n">uint64</span><span class="p">;</span>

<span class="kr">double</span><span class="w"> </span><span class="nf">test_dp_mac_AVX</span><span class="p">(</span><span class="kr">double</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="kr">double</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="n">uint64</span><span class="w"> </span><span class="n">iterations</span><span class="p">){</span>
<span class="w">    </span><span class="kr">register</span><span class="w"> </span><span class="n">__m256d</span><span class="w"> </span><span class="n">r0</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">r3</span><span class="p">,</span><span class="n">r4</span><span class="p">,</span><span class="n">r5</span><span class="p">,</span><span class="n">r6</span><span class="p">,</span><span class="n">r7</span><span class="p">,</span><span class="n">r8</span><span class="p">,</span><span class="n">r9</span><span class="p">,</span><span class="n">rA</span><span class="p">,</span><span class="n">rB</span><span class="p">,</span><span class="n">rC</span><span class="p">,</span><span class="n">rD</span><span class="p">,</span><span class="n">rE</span><span class="p">,</span><span class="n">rF</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//  Generate starting data.</span>
<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="w">    </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>

<span class="w">    </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">-0.0</span><span class="p">);</span>

<span class="w">    </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_xor_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r8</span><span class="p">);</span>
<span class="w">    </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r8</span><span class="p">);</span>
<span class="w">    </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_andnot_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">r0</span><span class="p">);</span>
<span class="w">    </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">0.37796447300922722721</span><span class="p">));</span>
<span class="w">    </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">0.24253562503633297352</span><span class="p">));</span>
<span class="w">    </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">4.1231056256176605498</span><span class="p">));</span>
<span class="w">    </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">0.37796447300922722721</span><span class="p">));</span>
<span class="w">    </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">0.24253562503633297352</span><span class="p">));</span>
<span class="w">    </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">4.1231056256176605498</span><span class="p">));</span>
<span class="w">    </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">4.1231056256176605498</span><span class="p">));</span>

<span class="w">    </span><span class="n">rC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">1.4142135623730950488</span><span class="p">);</span>
<span class="w">    </span><span class="n">rD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">1.7320508075688772935</span><span class="p">);</span>
<span class="w">    </span><span class="n">rE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">0.57735026918962576451</span><span class="p">);</span>
<span class="w">    </span><span class="n">rF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">0.70710678118654752440</span><span class="p">);</span>

<span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">iMASK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x800fffffffffffffull</span><span class="p">;</span>
<span class="w">    </span><span class="n">__m256d</span><span class="w"> </span><span class="n">MASK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kr">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iMASK</span><span class="p">);</span>
<span class="w">    </span><span class="n">__m256d</span><span class="w"> </span><span class="n">vONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>

<span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iterations</span><span class="p">){</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">){</span>
<span class="w">            </span><span class="c1">//  Here's the meat - the part that really matters.</span>

<span class="w">            </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>

<span class="w">            </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>

<span class="w">            </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>

<span class="w">            </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>
<span class="w">            </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rF</span><span class="p">);</span>
<span class="w">            </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">rE</span><span class="p">);</span>
<span class="w">            </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_sub_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rD</span><span class="p">);</span>
<span class="w">            </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">rC</span><span class="p">);</span>

<span class="w">            </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">//  Need to renormalize to prevent denormal/overflow.</span>
<span class="w">        </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_and_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">MASK</span><span class="p">);</span>
<span class="w">        </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r5</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r7</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">r9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">r9</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>
<span class="w">        </span><span class="n">rB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_or_pd</span><span class="p">(</span><span class="n">rB</span><span class="p">,</span><span class="n">vONE</span><span class="p">);</span>

<span class="w">        </span><span class="n">c</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r1</span><span class="p">);</span>
<span class="w">    </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">r3</span><span class="p">);</span>
<span class="w">    </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">r5</span><span class="p">);</span>
<span class="w">    </span><span class="n">r6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r6</span><span class="p">,</span><span class="n">r7</span><span class="p">);</span>
<span class="w">    </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">r9</span><span class="p">);</span>
<span class="w">    </span><span class="n">rA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">rA</span><span class="p">,</span><span class="n">rB</span><span class="p">);</span>

<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r2</span><span class="p">);</span>
<span class="w">    </span><span class="n">r4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r4</span><span class="p">,</span><span class="n">r6</span><span class="p">);</span>
<span class="w">    </span><span class="n">r8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">rA</span><span class="p">);</span>

<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r4</span><span class="p">);</span>
<span class="w">    </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_add_pd</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">r8</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//  Prevent Dead Code Elimination</span>
<span class="w">    </span><span class="kr">double</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">__m256d</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r0</span><span class="p">;</span>
<span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="kr">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="kr">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="kr">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="kr">double</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)[</span><span class="mi">3</span><span class="p">];</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">void</span><span class="w"> </span><span class="nf">test_dp_mac_AVX</span><span class="p">(</span><span class="kr">int</span><span class="w"> </span><span class="n">tds</span><span class="p">,</span><span class="n">uint64</span><span class="w"> </span><span class="n">iterations</span><span class="p">){</span>

<span class="w">    </span><span class="kr">double</span><span class="w"> </span><span class="o">*</span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kr">double</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">tds</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">sizeof</span><span class="p">(</span><span class="kr">double</span><span class="p">));</span>
<span class="w">    </span><span class="kr">double</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omp_get_wtime</span><span class="p">();</span>

<span class="cp">#pragma omp parallel num_threads(tds)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kr">double</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_dp_mac_AVX</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span><span class="mf">2.1</span><span class="p">,</span><span class="n">iterations</span><span class="p">);</span>
<span class="w">        </span><span class="n">sum</span><span class="p">[</span><span class="n">omp_get_thread_num</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">double</span><span class="w"> </span><span class="n">secs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omp_get_wtime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint64</span><span class="w"> </span><span class="n">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tds</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Seconds = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">secs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"FP Ops  = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ops</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"FLOPs   = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ops</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">secs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>

<span class="w">    </span><span class="kr">double</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kr">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tds</span><span class="p">){</span>
<span class="w">        </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sum</span><span class="p">[</span><span class="n">c</span><span class="o">++</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"sum = "</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>

<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">sum</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span>
<span class="w">    </span><span class="c1">//  (threads, iterations)</span>
<span class="w">    </span><span class="n">test_dp_mac_AVX</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">10000000</span><span class="p">);</span>

<span class="w">    </span><span class="n">system</span><span class="p">(</span><span class="s">"pause"</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p><strong>Output (1 thread, 10000000 iterations) - Compiled with Visual Studio 2010
SP1 - x64 Release:</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 57.4679
FP Ops  = 1920000000000
FLOPs   = 3.34099e+010
sum = 4.45305
</pre></div>

<p>Theoretical AVX peak is 8 flops * 4.4 GHz = <strong>35.2 GFlops</strong>. Actual is <strong>33.4
GFlops</strong>.</p>
<p><strong>Output (8 threads, 10000000 iterations) - Compiled with Visual Studio 2010
SP1 - x64 Release:</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 111.119
FP Ops  = 15360000000000
FLOPs   = 1.3823e+011
sum = 35.6244
</pre></div>

<p>Theoretical AVX peak is 8 flops * 4 cores * 4.4 GHz = <strong>140.8 GFlops.</strong> Actual
is <strong>138.2 GFlops</strong>.</p>
<hr>
<p><strong>Now for some explanations:</strong></p>
<p>The performance critical part is obviously the 48 instructions inside the
inner loop. You'll notice that it's broken into 4 blocks of 12 instructions
each. Each of these 12 instructions blocks are completely independent from
each other - and take on average 6 cycles to execute.</p>
<p>So there's 12 instructions and 6 cycles between issue-to-use. The latency of
multiplication is 5 cycles, so it's just enough to avoid latency stalls.</p>
<p>The normalization step is needed to keep the data from over/underflowing. This
is needed since the do-nothing code will slowly increase/decrease the
magnitude of the data.</p>
<p>So it's actually possible to do better than this if you just use all zeros and
get rid of the normalization step. However, since I wrote the benchmark to
measure power consumption and temperature, <strong>I had to make sure the flops were
on "real" data, rather than zeros</strong> - as the execution units may very well
have special case-handling for zeros that use less power and produce less
heat.</p>
<hr>
<h3>More Results:</h3>
<ul>
<li><strong>Intel Core i7 920 @ 3.5 GHz</strong></li>
<li>Windows 7 Ultimate x64</li>
<li>Visual Studio 2010 SP1 - x64 Release</li>
</ul>
<p><strong>Threads: 1</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 72.1116
FP Ops  = 960000000000
FLOPs   = 1.33127e+010
sum = 2.22652
</pre></div>

<p>Theoretical SSE Peak: 4 flops * 3.5 GHz = <strong>14.0 GFlops</strong>. Actual is <strong>13.3
GFlops</strong>.</p>
<p><strong>Threads: 8</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 149.576
FP Ops  = 7680000000000
FLOPs   = 5.13452e+010
sum = 17.8122
</pre></div>

<p>Theoretical SSE Peak: 4 flops * 4 cores * 3.5 GHz = <strong>56.0 GFlops</strong>. Actual is
<strong>51.3 GFlops</strong>.</p>
<p><em><strong>My processor temps hit 76C on the multi-threaded run! If you runs these, be
sure the results aren't affected by CPU throttling.</strong></em></p>
<hr>
<ul>
<li><strong>2 x Intel Xeon X5482 Harpertown @ 3.2 GHz</strong></li>
<li>Ubuntu Linux 10 x64</li>
<li>GCC 4.5.2 x64 - (-O2 -msse3 -fopenmp)</li>
</ul>
<p><strong>Threads: 1</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 78.3357
FP Ops  = 960000000000
FLOPs   = 1.22549e+10
sum = 2.22652
</pre></div>

<p>Theoretical SSE Peak: 4 flops * 3.2 GHz = <strong>12.8 GFlops</strong>. Actual is <strong>12.3
GFlops</strong>.</p>
<p><strong>Threads: 8</strong></p>
<div class="code"><pre class="code literal-block">Seconds = 78.4733
FP Ops  = 7680000000000
FLOPs   = 9.78676e+10
sum = 17.8122
</pre></div>

<p>Theoretical SSE Peak: 4 flops * 8 cores * 3.2 GHz = <strong>102.4 GFlops</strong>. Actual
is <strong>97.9 GFlops</strong>.</p>
<p><br></p>
<h3>Suggest</h3>
<p>There's a point in the Intel architecture that people often forget, the
dispatch ports are shared between Int and FP/SIMD. This means that you will
only get a certain amount of bursts of FP/SIMD before the loop logic will
create bubbles in your floating point stream. Mystical got more flops out of
his code, because he used longer strides in his unrolled loop.</p>
<p>If you look at the Nehalem/Sandy Bridge architecture here
http://www.realworldtech.com/page.cfm?ArticleID=RWT091810191937&amp;p=6 it's quite
clear what happens.</p>
<p>In contrast, it should be easier to reach peak performance on AMD (Bulldozer)
as the INT and FP/SIMD pipes have separate issue ports with their own
scheduler.</p>
<p>This is only theoretical as I have neither of these processors to test.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-864.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-862.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
