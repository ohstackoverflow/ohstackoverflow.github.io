<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 2668) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-2668.html">
<link rel="prev" href="index-2669.html" type="text/html">
<link rel="next" href="index-2667.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-to-find-the-number-of-cpu-cores-via-net-c/" class="u-url">How to find the Number of CPU Cores via .NET/C#?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-to-find-the-number-of-cpu-cores-via-net-c/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T09:00:41+08:00" itemprop="datePublished" title="2023-03-05 09:00">2023-03-05 09:00</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Is there a way via <strong>.NET/C#</strong> to find out the number of CPU cores?</p>
<p>PS This is a straight code question, not a "Should I use multi-threading?"
question! :-)</p>
<p><br><br></p>
<h2>Answer</h2>
<p>There are several different pieces of information relating to processors that
you could get:</p>
<ol>
<li>Number of physical processors</li>
<li>Number of cores</li>
<li>Number of logical processors.</li>
</ol>
<p>These can all be different; in the case of a machine with 2 dual-core hyper-
threading-enabled processors, there are 2 physical processors, 4 cores, and 8
logical processors.</p>
<p>The number of logical processors is available through the Environment class,
but the other information is only available through WMI (and you may have to
install some hotfixes or service packs to get it on some systems):</p>
<p><strong><em>Make sure to add a reference in your project to System.Management.dll</em></strong> In
.NET Core, this is available (for Windows only) as a NuGet package.</p>
<p><strong>Physical Processors:</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">System</span><span class="o">.</span><span class="n">Management</span><span class="o">.</span><span class="n">ManagementObjectSearcher</span><span class="p">(</span><span class="s2">"Select * from Win32_ComputerSystem"</span><span class="p">)</span><span class="o">.</span><span class="n">Get</span><span class="p">())</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s2">"Number Of Physical Processors: {0} "</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="p">[</span><span class="s2">"NumberOfProcessors"</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>

<p><strong>Cores:</strong></p>
<div class="code"><pre class="code literal-block"><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">coreCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">System</span><span class="o">.</span><span class="n">Management</span><span class="o">.</span><span class="n">ManagementObjectSearcher</span><span class="p">(</span><span class="s2">"Select * from Win32_Processor"</span><span class="p">)</span><span class="o">.</span><span class="n">Get</span><span class="p">())</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">coreCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">"NumberOfCores"</span><span class="p">]</span><span class="o">.</span><span class="n">ToString</span><span class="p">());</span>
<span class="p">}</span>
<span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s2">"Number Of Cores: {0}"</span><span class="p">,</span><span class="w"> </span><span class="n">coreCount</span><span class="p">);</span>
</pre></div>

<p><strong>Logical Processors:</strong></p>
<div class="code"><pre class="code literal-block"><span class="nt">Console</span><span class="p">.</span><span class="nc">WriteLine</span><span class="o">(</span><span class="s2">"Number Of Logical Processors: {0}"</span><span class="o">,</span><span class="w"> </span><span class="nt">Environment</span><span class="p">.</span><span class="nc">ProcessorCount</span><span class="o">);</span>
</pre></div>

<p>OR</p>
<div class="code"><pre class="code literal-block"><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">System</span><span class="o">.</span><span class="n">Management</span><span class="o">.</span><span class="n">ManagementObjectSearcher</span><span class="p">(</span><span class="s2">"Select * from Win32_ComputerSystem"</span><span class="p">)</span><span class="o">.</span><span class="n">Get</span><span class="p">())</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s2">"Number Of Logical Processors: {0}"</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="p">[</span><span class="s2">"NumberOfLogicalProcessors"</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>

<p><strong>Processors excluded from Windows:</strong></p>
<p>You can also use Windows API calls in <strong>setupapi.dll</strong> to discover processors
that have been excluded from Windows (e.g. through boot settings) and aren't
detectable using the above means. The code below gives the total number of
logical processors (I haven't been able to figure out how to differentiate
physical from logical processors) that exist, including those that have been
excluded from Windows:</p>
<div class="code"><pre class="code literal-block"><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">Main</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">deviceCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">IntPtr</span><span class="w"> </span><span class="n">deviceList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IntPtr</span><span class="o">.</span><span class="n">Zero</span><span class="p">;</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">GUID</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">processor</span><span class="w"> </span><span class="n">classid</span>
<span class="w">    </span><span class="n">Guid</span><span class="w"> </span><span class="n">processorGuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Guid</span><span class="p">(</span><span class="s2">"{50127dc3-0f36-415e-a6cc-4cb3be910b65}"</span><span class="p">);</span>

<span class="w">    </span><span class="n">try</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">processor</span><span class="w"> </span><span class="n">devices</span>
<span class="w">        </span><span class="n">deviceList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SetupDiGetClassDevs</span><span class="p">(</span><span class="n">ref</span><span class="w"> </span><span class="n">processorGuid</span><span class="p">,</span><span class="w"> </span><span class="s2">"ACPI"</span><span class="p">,</span><span class="w"> </span><span class="n">IntPtr</span><span class="o">.</span><span class="n">Zero</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">int</span><span class="p">)</span><span class="n">DIGCF</span><span class="o">.</span><span class="n">PRESENT</span><span class="p">);</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">attempt</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">list</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">deviceNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">deviceNumber</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">SP_DEVINFO_DATA</span><span class="w"> </span><span class="n">deviceInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">SP_DEVINFO_DATA</span><span class="p">();</span>
<span class="w">            </span><span class="n">deviceInfo</span><span class="o">.</span><span class="n">cbSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Marshal</span><span class="o">.</span><span class="n">SizeOf</span><span class="p">(</span><span class="n">deviceInfo</span><span class="p">);</span>

<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">attempt</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">fails</span><span class="p">,</span><span class="w"> </span><span class="n">we</span><span class="s1">'re at the end of the list</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SetupDiEnumDeviceInfo</span><span class="p">(</span><span class="n">deviceList</span><span class="p">,</span><span class="w"> </span><span class="n">deviceNumber</span><span class="p">,</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="n">deviceInfo</span><span class="p">))</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">deviceCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deviceNumber</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">finally</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deviceList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">IntPtr</span><span class="o">.</span><span class="n">Zero</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">SetupDiDestroyDeviceInfoList</span><span class="p">(</span><span class="n">deviceList</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s2">"Number of cores: {0}"</span><span class="p">,</span><span class="w"> </span><span class="n">deviceCount</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">DllImport</span><span class="p">(</span><span class="s2">"setupapi.dll"</span><span class="p">,</span><span class="w"> </span><span class="n">SetLastError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">)]</span>
<span class="n">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">extern</span><span class="w"> </span><span class="n">IntPtr</span><span class="w"> </span><span class="n">SetupDiGetClassDevs</span><span class="p">(</span><span class="n">ref</span><span class="w"> </span><span class="n">Guid</span><span class="w"> </span><span class="n">ClassGuid</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">MarshalAs</span><span class="p">(</span><span class="n">UnmanagedType</span><span class="o">.</span><span class="n">LPStr</span><span class="p">)]</span><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">enumerator</span><span class="p">,</span>
<span class="w">    </span><span class="n">IntPtr</span><span class="w"> </span><span class="n">hwndParent</span><span class="p">,</span>
<span class="w">    </span><span class="n">Int32</span><span class="w"> </span><span class="n">Flags</span><span class="p">);</span>

<span class="p">[</span><span class="n">DllImport</span><span class="p">(</span><span class="s2">"setupapi.dll"</span><span class="p">,</span><span class="w"> </span><span class="n">SetLastError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">)]</span>
<span class="n">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">extern</span><span class="w"> </span><span class="n">Int32</span><span class="w"> </span><span class="n">SetupDiDestroyDeviceInfoList</span><span class="p">(</span><span class="n">IntPtr</span><span class="w"> </span><span class="n">DeviceInfoSet</span><span class="p">);</span>

<span class="p">[</span><span class="n">DllImport</span><span class="p">(</span><span class="s2">"setupapi.dll"</span><span class="p">,</span><span class="w"> </span><span class="n">SetLastError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">)]</span>
<span class="n">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">extern</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="w"> </span><span class="n">SetupDiEnumDeviceInfo</span><span class="p">(</span><span class="n">IntPtr</span><span class="w"> </span><span class="n">DeviceInfoSet</span><span class="p">,</span>
<span class="w">    </span><span class="n">Int32</span><span class="w"> </span><span class="n">MemberIndex</span><span class="p">,</span>
<span class="w">    </span><span class="n">ref</span><span class="w"> </span><span class="n">SP_DEVINFO_DATA</span><span class="w"> </span><span class="n">DeviceInterfaceData</span><span class="p">);</span>

<span class="p">[</span><span class="n">StructLayout</span><span class="p">(</span><span class="n">LayoutKind</span><span class="o">.</span><span class="n">Sequential</span><span class="p">)]</span>
<span class="n">private</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">SP_DEVINFO_DATA</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">cbSize</span><span class="p">;</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">Guid</span><span class="w"> </span><span class="n">ClassGuid</span><span class="p">;</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">DevInst</span><span class="p">;</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">IntPtr</span><span class="w"> </span><span class="n">Reserved</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">private</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">DIGCF</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1</span><span class="p">,</span>
<span class="w">    </span><span class="n">PRESENT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x2</span><span class="p">,</span>
<span class="w">    </span><span class="n">ALLCLASSES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x4</span><span class="p">,</span>
<span class="w">    </span><span class="n">PROFILE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x8</span><span class="p">,</span>
<span class="w">    </span><span class="n">DEVICEINTERFACE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<div class="code"><pre class="code literal-block">Environment.ProcessorCount
</pre></div>

<p>[Documentation]</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-do-i-modify-fields-inside-the-new-postgresql-json-datatype/" class="u-url">How do I modify fields inside the new PostgreSQL JSON datatype?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-do-i-modify-fields-inside-the-new-postgresql-json-datatype/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T08:58:53+08:00" itemprop="datePublished" title="2023-03-05 08:58">2023-03-05 08:58</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>With postgresql 9.3 I can <code>SELECT</code> specific fields of a JSON data type, but
how do you modify them using <code>UPDATE</code>? I can't find any examples of this in
the postgresql documentation, or anywhere online. I have tried the obvious:</p>
<div class="code"><pre class="code literal-block"><span class="n">postgres</span><span class="o">=</span><span class="err">#</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="nf">table</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">(</span><span class="kt">data</span><span class="w"> </span><span class="n">json</span><span class="p">);</span>
<span class="n">CREATE</span><span class="w"> </span><span class="nf">TABLE</span>
<span class="n">postgres</span><span class="o">=</span><span class="err">#</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="p">(</span><span class="s">'{"</span><span class="n">a</span><span class="s">":1,"</span><span class="n">b</span><span class="s">":2}'</span><span class="p">);</span>
<span class="n">INSERT</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span>
<span class="n">postgres</span><span class="o">=</span><span class="err">#</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="s">'a'</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;&gt;</span><span class="s">'b'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">'2'</span><span class="p">;</span>
<span class="w"> </span><span class="o">?</span><span class="n">column</span><span class="o">?</span>
<span class="o">----------</span>
<span class="w"> </span><span class="mi">1</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="nf">row</span><span class="p">)</span>
<span class="n">postgres</span><span class="o">=</span><span class="err">#</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="nf">set</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="s">'a'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_json</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;&gt;</span><span class="s">'b'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">'2'</span><span class="p">;</span>
<span class="nf">ERROR</span><span class="o">:</span><span class="w">  </span><span class="n">syntax</span><span class="w"> </span><span class="nf">error</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="kr">or</span><span class="w"> </span><span class="n">near</span><span class="w"> </span><span class="s">"-&gt;"</span>
<span class="n">LINE</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="nf">set</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="s">'a'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_json</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;&gt;</span><span class="s">'b'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">'2...</span>
</pre></div>

<p><br><br></p>
<h2>Answer</h2>
<p><strong>Update</strong> : With PostgreSQL 9.5, there are some <code>jsonb</code> manipulation
functionality within PostgreSQL itself (but none for <code>json</code>; casts are
required to manipulate <code>json</code> values).</p>
<p>Merging 2 (or more) JSON objects (or concatenating arrays):</p>
<div class="code"><pre class="code literal-block">SELECT jsonb '{"a":1}' || jsonb '{"b":2}', -- will yield jsonb '{"a":1,"b":2}'
       jsonb '["a",1]' || jsonb '["b",2]'  -- will yield jsonb '["a",1,"b",2]'
</pre></div>

<p>So, <strong>setting a simple key</strong> can be done using:</p>
<div class="code"><pre class="code literal-block">SELECT jsonb '{"a":1}' || jsonb_build_object('&lt;key&gt;', '&lt;value&gt;')
</pre></div>

<p>Where <code>&lt;key&gt;</code> should be string, and <code>&lt;value&gt;</code> can be whatever type
<code>to_jsonb()</code> accepts.</p>
<p>For <strong>setting a value deep in a JSON hierarchy</strong> , the <code>jsonb_set()</code> function
can be used:</p>
<div class="code"><pre class="code literal-block">SELECT jsonb_set('{"a":[null,{"b":[]}]}', '{a,1,b,0}', jsonb '{"c":3}')
-- will yield jsonb '{"a":[null,{"b":[{"c":3}]}]}'
</pre></div>

<p>Full parameter list of <code>jsonb_set()</code>:</p>
<div class="code"><pre class="code literal-block">jsonb_set(target         jsonb,
          path           text[],
          new_value      jsonb,
          create_missing boolean default true)
</pre></div>

<p><code>path</code> can contain JSON array indexes too &amp; negative integers that appear
there count from the end of JSON arrays. However, a non-existing, but positive
JSON array index will append the element to the end of the array:</p>
<div class="code"><pre class="code literal-block">SELECT jsonb_set('{"a":[null,{"b":[1,2]}]}', '{a,1,b,1000}', jsonb '3', true)
-- will yield jsonb '{"a":[null,{"b":[1,2,3]}]}'
</pre></div>

<p>For <strong>inserting into JSON array (while preserving all of the original
values)</strong> , the <code>jsonb_insert()</code> function can be used ( <em>in 9.6+; this
function only, in this section</em> ):</p>
<div class="code"><pre class="code literal-block">SELECT jsonb_insert('{"a":[null,{"b":[1]}]}', '{a,1,b,0}', jsonb '2')
-- will yield jsonb '{"a":[null,{"b":[2,1]}]}', and
SELECT jsonb_insert('{"a":[null,{"b":[1]}]}', '{a,1,b,0}', jsonb '2', true)
-- will yield jsonb '{"a":[null,{"b":[1,2]}]}'
</pre></div>

<p>Full parameter list of <code>jsonb_insert()</code>:</p>
<div class="code"><pre class="code literal-block">jsonb_insert(target       jsonb,
             path         text[],
             new_value    jsonb,
             insert_after boolean default false)
</pre></div>

<p>Again, negative integers that appear in <code>path</code> count from the end of JSON
arrays.</p>
<p>So, f.ex. appending to an end of a JSON array can be done with:</p>
<div class="code"><pre class="code literal-block">SELECT jsonb_insert('{"a":[null,{"b":[1,2]}]}', '{a,1,b,-1}', jsonb '3', true)
-- will yield jsonb '{"a":[null,{"b":[1,2,3]}]}', and
</pre></div>

<p>However, this function is working slightly differently (than <code>jsonb_set()</code>)
when the <code>path</code> in <code>target</code> is a JSON object's key. In that case, it will only
add a new key-value pair for the JSON object when the key is not used. If it's
used, it will raise an error:</p>
<div class="code"><pre class="code literal-block">SELECT jsonb_insert('{"a":[null,{"b":[1]}]}', '{a,1,c}', jsonb '[2]')
-- will yield jsonb '{"a":[null,{"b":[1],"c":[2]}]}', but
SELECT jsonb_insert('{"a":[null,{"b":[1]}]}', '{a,1,b}', jsonb '[2]')
-- will raise SQLSTATE 22023 (invalid_parameter_value): cannot replace existing key
</pre></div>

<p><strong>Deleting a key (or an index)</strong> from a JSON object (or, from an array) can be
done with the <code>-</code> operator:</p>
<div class="code"><pre class="code literal-block">SELECT jsonb '{"a":1,"b":2}' - 'a', -- will yield jsonb '{"b":2}'
       jsonb '["a",1,"b",2]' - 1    -- will yield jsonb '["a","b",2]'
</pre></div>

<p><strong>Deleting, from deep in a JSON hierarchy</strong> can be done with the <code>#-</code>
operator:</p>
<div class="code"><pre class="code literal-block">SELECT '{"a":[null,{"b":[3.14]}]}' #- '{a,1,b,0}'
-- will yield jsonb '{"a":[null,{"b":[]}]}'
</pre></div>

<p><strong>For 9.4</strong> , you can use a modified version of the original answer (below),
but instead of aggregating a JSON string, you can aggregate into a json object
directly with <code>json_object_agg()</code>.</p>
<p><strong>Original answer</strong> : It is possible (without plpython or plv8) in pure SQL
too (but needs 9.3+, will not work with 9.2)</p>
<div class="code"><pre class="code literal-block"><span class="nv">CREATE</span><span class="w"> </span><span class="nv">OR</span><span class="w"> </span><span class="nv">REPLACE</span><span class="w"> </span><span class="nv">FUNCTION</span><span class="w"> </span><span class="s">"json_object_set_key"</span><span class="p">(</span>
<span class="w">  </span><span class="s">"json"</span><span class="w">          </span><span class="nv">json</span><span class="p">,</span>
<span class="w">  </span><span class="s">"key_to_set"</span><span class="w">    </span><span class="nv">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="s">"value_to_set"</span><span class="w">  </span><span class="nv">anyelement</span>
<span class="p">)</span>
<span class="w">  </span><span class="nv">RETURNS</span><span class="w"> </span><span class="nv">json</span>
<span class="w">  </span><span class="nv">LANGUAGE</span><span class="w"> </span><span class="nv">sql</span>
<span class="w">  </span><span class="nv">IMMUTABLE</span>
<span class="w">  </span><span class="nv">STRICT</span>
<span class="nv">AS</span><span class="w"> </span><span class="p">$</span><span class="nv">function</span><span class="p">$</span>
<span class="nv">SELECT</span><span class="w"> </span><span class="nf">concat</span><span class="p">(</span><span class="o">'</span><span class="p">{</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="nf">string_agg</span><span class="p">(</span><span class="k">to</span><span class="nf">_json</span><span class="p">(</span><span class="s">"key"</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">':'</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s">"value"</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="p">,</span><span class="o">'</span><span class="p">),</span><span class="w"> </span><span class="o">'</span><span class="p">}</span><span class="o">'</span><span class="p">)</span><span class="o">::</span><span class="nv">json</span>
<span class="w">  </span><span class="nf">FROM</span><span class="w"> </span><span class="p">(</span><span class="nv">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="w">          </span><span class="nv">FROM</span><span class="w"> </span><span class="nf">json_each</span><span class="p">(</span><span class="s">"json"</span><span class="p">)</span>
<span class="w">         </span><span class="nv">WHERE</span><span class="w"> </span><span class="s">"key"</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">"key_to_set"</span>
<span class="w">         </span><span class="nv">UNION</span><span class="w"> </span><span class="nv">ALL</span>
<span class="w">        </span><span class="nv">SELECT</span><span class="w"> </span><span class="s">"key_to_set"</span><span class="p">,</span><span class="w"> </span><span class="k">to</span><span class="nf">_json</span><span class="p">(</span><span class="s">"value_to_set"</span><span class="p">))</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="s">"fields"</span>
<span class="p">$</span><span class="nv">function</span><span class="p">$;</span>
</pre></div>

<p>SQLFiddle</p>
<p><strong>Edit</strong> :</p>
<p>A version, which sets multiple keys &amp; values:</p>
<div class="code"><pre class="code literal-block"><span class="nv">CREATE</span><span class="w"> </span><span class="nv">OR</span><span class="w"> </span><span class="nv">REPLACE</span><span class="w"> </span><span class="nv">FUNCTION</span><span class="w"> </span><span class="s">"json_object_set_keys"</span><span class="p">(</span>
<span class="w">  </span><span class="s">"json"</span><span class="w">          </span><span class="nv">json</span><span class="p">,</span>
<span class="w">  </span><span class="s">"keys_to_set"</span><span class="w">   </span><span class="nv">TEXT</span><span class="p">[],</span>
<span class="w">  </span><span class="s">"values_to_set"</span><span class="w"> </span><span class="nv">anyarray</span>
<span class="p">)</span>
<span class="w">  </span><span class="nv">RETURNS</span><span class="w"> </span><span class="nv">json</span>
<span class="w">  </span><span class="nv">LANGUAGE</span><span class="w"> </span><span class="nv">sql</span>
<span class="w">  </span><span class="nv">IMMUTABLE</span>
<span class="w">  </span><span class="nv">STRICT</span>
<span class="nv">AS</span><span class="w"> </span><span class="p">$</span><span class="nv">function</span><span class="p">$</span>
<span class="nv">SELECT</span><span class="w"> </span><span class="nf">concat</span><span class="p">(</span><span class="o">'</span><span class="p">{</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="nf">string_agg</span><span class="p">(</span><span class="k">to</span><span class="nf">_json</span><span class="p">(</span><span class="s">"key"</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">':'</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s">"value"</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="p">,</span><span class="o">'</span><span class="p">),</span><span class="w"> </span><span class="o">'</span><span class="p">}</span><span class="o">'</span><span class="p">)</span><span class="o">::</span><span class="nv">json</span>
<span class="w">  </span><span class="nf">FROM</span><span class="w"> </span><span class="p">(</span><span class="nv">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="w">          </span><span class="nv">FROM</span><span class="w"> </span><span class="nf">json_each</span><span class="p">(</span><span class="s">"json"</span><span class="p">)</span>
<span class="w">         </span><span class="nv">WHERE</span><span class="w"> </span><span class="s">"key"</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="nf">ALL</span><span class="w"> </span><span class="p">(</span><span class="s">"keys_to_set"</span><span class="p">)</span>
<span class="w">         </span><span class="nv">UNION</span><span class="w"> </span><span class="nv">ALL</span>
<span class="w">        </span><span class="nv">SELECT</span><span class="w"> </span><span class="nv">DISTINCT</span><span class="w"> </span><span class="nf">ON</span><span class="w"> </span><span class="p">(</span><span class="s">"keys_to_set"</span><span class="p">[</span><span class="s">"index"</span><span class="p">])</span>
<span class="w">               </span><span class="s">"keys_to_set"</span><span class="p">[</span><span class="s">"index"</span><span class="p">],</span>
<span class="w">               </span><span class="nv">CASE</span>
<span class="w">                 </span><span class="nv">WHEN</span><span class="w"> </span><span class="s">"values_to_set"</span><span class="p">[</span><span class="s">"index"</span><span class="p">]</span><span class="w"> </span><span class="nv">IS</span><span class="w"> </span><span class="nv">NULL</span><span class="w"> </span><span class="nv">THEN</span><span class="w"> </span><span class="o">'</span><span class="nv">null</span><span class="o">'::</span><span class="nv">json</span>
<span class="w">                 </span><span class="nv">ELSE</span><span class="w"> </span><span class="k">to</span><span class="nf">_json</span><span class="p">(</span><span class="s">"values_to_set"</span><span class="p">[</span><span class="s">"index"</span><span class="p">])</span>
<span class="w">               </span><span class="nv">END</span>
<span class="w">          </span><span class="nv">FROM</span><span class="w"> </span><span class="nf">generate_subscripts</span><span class="p">(</span><span class="s">"keys_to_set"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="s">"keys"</span><span class="p">(</span><span class="s">"index"</span><span class="p">)</span>
<span class="w">          </span><span class="nv">JOIN</span><span class="w"> </span><span class="nf">generate_subscripts</span><span class="p">(</span><span class="s">"values_to_set"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="s">"values"</span><span class="p">(</span><span class="s">"index"</span><span class="p">)</span>
<span class="w">         </span><span class="nf">USING</span><span class="w"> </span><span class="p">(</span><span class="s">"index"</span><span class="p">))</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="s">"fields"</span>
<span class="p">$</span><span class="nv">function</span><span class="p">$;</span>
</pre></div>

<p><strong>Edit 2</strong> : as @ErwinBrandstetter noted these functions above works like a
so-called <code>UPSERT</code> (updates a field if it exists, inserts if it does not
exist). Here is a variant, which only <code>UPDATE</code>:</p>
<div class="code"><pre class="code literal-block"><span class="nv">CREATE</span><span class="w"> </span><span class="nv">OR</span><span class="w"> </span><span class="nv">REPLACE</span><span class="w"> </span><span class="nv">FUNCTION</span><span class="w"> </span><span class="s">"json_object_update_key"</span><span class="p">(</span>
<span class="w">  </span><span class="s">"json"</span><span class="w">          </span><span class="nv">json</span><span class="p">,</span>
<span class="w">  </span><span class="s">"key_to_set"</span><span class="w">    </span><span class="nv">TEXT</span><span class="p">,</span>
<span class="w">  </span><span class="s">"value_to_set"</span><span class="w">  </span><span class="nv">anyelement</span>
<span class="p">)</span>
<span class="w">  </span><span class="nv">RETURNS</span><span class="w"> </span><span class="nv">json</span>
<span class="w">  </span><span class="nv">LANGUAGE</span><span class="w"> </span><span class="nv">sql</span>
<span class="w">  </span><span class="nv">IMMUTABLE</span>
<span class="w">  </span><span class="nv">STRICT</span>
<span class="nv">AS</span><span class="w"> </span><span class="p">$</span><span class="nv">function</span><span class="p">$</span>
<span class="nv">SELECT</span><span class="w"> </span><span class="nv">CASE</span>
<span class="w">  </span><span class="nf">WHEN</span><span class="w"> </span><span class="p">(</span><span class="s">"json"</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">"key_to_set"</span><span class="p">)</span><span class="w"> </span><span class="nv">IS</span><span class="w"> </span><span class="nv">NULL</span><span class="w"> </span><span class="nv">THEN</span><span class="w"> </span><span class="s">"json"</span>
<span class="w">  </span><span class="nf">ELSE</span><span class="w"> </span><span class="p">(</span><span class="nv">SELECT</span><span class="w"> </span><span class="nf">concat</span><span class="p">(</span><span class="o">'</span><span class="p">{</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="nf">string_agg</span><span class="p">(</span><span class="k">to</span><span class="nf">_json</span><span class="p">(</span><span class="s">"key"</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">':'</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s">"value"</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="p">,</span><span class="o">'</span><span class="p">),</span><span class="w"> </span><span class="o">'</span><span class="p">}</span><span class="o">'</span><span class="p">)</span>
<span class="w">          </span><span class="nf">FROM</span><span class="w"> </span><span class="p">(</span><span class="nv">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="w">                  </span><span class="nv">FROM</span><span class="w"> </span><span class="nf">json_each</span><span class="p">(</span><span class="s">"json"</span><span class="p">)</span>
<span class="w">                 </span><span class="nv">WHERE</span><span class="w"> </span><span class="s">"key"</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">"key_to_set"</span>
<span class="w">                 </span><span class="nv">UNION</span><span class="w"> </span><span class="nv">ALL</span>
<span class="w">                </span><span class="nv">SELECT</span><span class="w"> </span><span class="s">"key_to_set"</span><span class="p">,</span><span class="w"> </span><span class="k">to</span><span class="nf">_json</span><span class="p">(</span><span class="s">"value_to_set"</span><span class="p">))</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="s">"fields"</span><span class="p">)</span><span class="o">::</span><span class="nv">json</span>
<span class="nv">END</span>
<span class="p">$</span><span class="nv">function</span><span class="p">$;</span>
</pre></div>

<p><strong>Edit 3</strong> : Here is recursive variant, which can set (<code>UPSERT</code>) a leaf value
(and uses the first function from this answer), located at a key-path (where
keys can only refer to inner objects, inner arrays not supported):</p>
<div class="code"><pre class="code literal-block"><span class="k">CREATE</span><span class="w"> </span><span class="ow">OR</span><span class="w"> </span><span class="nf">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="ss">"json_object_set_path"</span><span class="p">(</span>
<span class="w">  </span><span class="ss">"json"</span><span class="w">          </span><span class="n">json</span><span class="p">,</span>
<span class="w">  </span><span class="ss">"key_path"</span><span class="w">      </span><span class="nc">TEXT</span><span class="err">[]</span><span class="p">,</span>
<span class="w">  </span><span class="ss">"value_to_set"</span><span class="w">  </span><span class="n">anyelement</span>
<span class="p">)</span>
<span class="w">  </span><span class="k">RETURNS</span><span class="w"> </span><span class="n">json</span>
<span class="w">  </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="k">sql</span>
<span class="w">  </span><span class="n">IMMUTABLE</span>
<span class="w">  </span><span class="n">STRICT</span>
<span class="k">AS</span><span class="w"> </span><span class="err">$</span><span class="k">function</span><span class="err">$</span>
<span class="k">SELECT</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">array_length</span><span class="p">(</span><span class="ss">"key_path"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">         </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">to_json</span><span class="p">(</span><span class="ss">"value_to_set"</span><span class="p">)</span>
<span class="w">         </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="ss">"json_object_set_key"</span><span class="p">(</span><span class="ss">"json"</span><span class="p">,</span><span class="w"> </span><span class="ss">"key_path"</span><span class="o">[</span><span class="n">l</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="ss">"value_to_set"</span><span class="p">)</span>
<span class="w">         </span><span class="k">ELSE</span><span class="w"> </span><span class="ss">"json_object_set_key"</span><span class="p">(</span>
<span class="w">           </span><span class="ss">"json"</span><span class="p">,</span>
<span class="w">           </span><span class="ss">"key_path"</span><span class="o">[</span><span class="n">l</span><span class="o">]</span><span class="p">,</span>
<span class="w">           </span><span class="ss">"json_object_set_path"</span><span class="p">(</span>
<span class="w">             </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">NULLIF</span><span class="p">((</span><span class="ss">"json"</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="ss">"key_path"</span><span class="o">[</span><span class="n">l</span><span class="o">]</span><span class="p">)</span><span class="o">::</span><span class="nc">text</span><span class="p">,</span><span class="w"> </span><span class="s1">'null'</span><span class="p">),</span><span class="w"> </span><span class="s1">'{}'</span><span class="p">)</span><span class="o">::</span><span class="n">json</span><span class="p">,</span>
<span class="w">             </span><span class="ss">"key_path"</span><span class="o">[</span><span class="n">l+1:u</span><span class="o">]</span><span class="p">,</span>
<span class="w">             </span><span class="ss">"value_to_set"</span>
<span class="w">           </span><span class="p">)</span>
<span class="w">         </span><span class="p">)</span>
<span class="w">       </span><span class="k">END</span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">array_lower</span><span class="p">(</span><span class="ss">"key_path"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">l</span><span class="p">,</span>
<span class="w">       </span><span class="n">array_upper</span><span class="p">(</span><span class="ss">"key_path"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">u</span>
<span class="err">$</span><span class="k">function</span><span class="err">$</span><span class="p">;</span>
</pre></div>

<p>Updated: Added function for replacing an existing json field's key by another
given key. Can be in handy for updating data types in migrations or other
scenarios like data structure amending.</p>
<div class="code"><pre class="code literal-block"><span class="nv">CREATE</span><span class="w"> </span><span class="nv">OR</span><span class="w"> </span><span class="nv">REPLACE</span><span class="w"> </span><span class="nv">FUNCTION</span><span class="w"> </span><span class="nf">json_object_replace_key</span><span class="p">(</span>
<span class="w">    </span><span class="nv">json_value</span><span class="w"> </span><span class="nv">json</span><span class="p">,</span>
<span class="w">    </span><span class="nv">existing_key</span><span class="w"> </span><span class="nv">text</span><span class="p">,</span>
<span class="w">    </span><span class="nv">desired_key</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span>
<span class="w">  </span><span class="nv">RETURNS</span><span class="w"> </span><span class="nv">json</span><span class="w"> </span><span class="nv">AS</span>
<span class="p">$</span><span class="nv">BODY</span><span class="p">$</span>
<span class="nv">SELECT</span><span class="w"> </span><span class="nf">COALESCE</span><span class="p">(</span>
<span class="p">(</span>
<span class="w">    </span><span class="nf">SELECT</span><span class="w"> </span><span class="p">(</span><span class="o">'</span><span class="p">{</span><span class="o">'</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nf">string_agg</span><span class="p">(</span><span class="k">to</span><span class="nf">_json</span><span class="p">(</span><span class="nv">key</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">':'</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">value</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="p">,</span><span class="o">'</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">'</span><span class="p">}</span><span class="o">'</span><span class="p">)</span>
<span class="w">    </span><span class="nf">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="nv">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="w">        </span><span class="nv">FROM</span><span class="w"> </span><span class="nf">json_each</span><span class="p">(</span><span class="nv">json_value</span><span class="p">)</span>
<span class="w">        </span><span class="nv">WHERE</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="nv">existing_key</span>
<span class="w">        </span><span class="nv">UNION</span><span class="w"> </span><span class="nv">ALL</span>
<span class="w">        </span><span class="nv">SELECT</span><span class="w"> </span><span class="nv">desired_key</span><span class="p">,</span><span class="w"> </span><span class="nv">json_value</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nv">existing_key</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="s">"fields"</span>
<span class="w">    </span><span class="o">--</span><span class="w"> </span><span class="nv">WHERE</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="nv">IS</span><span class="w"> </span><span class="nv">NOT</span><span class="w"> </span><span class="nf">NULL</span><span class="w"> </span><span class="p">(</span><span class="nv">Actually</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">required</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">string_agg</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">value</span><span class="o">'</span><span class="nv">s</span><span class="w"> </span><span class="nv">being</span><span class="w"> </span><span class="nv">null</span><span class="w"> </span><span class="nv">will</span><span class="w"> </span><span class="s">"discard"</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">entry</span><span class="p">)</span>

<span class="p">),</span>
<span class="w">    </span><span class="o">'</span><span class="p">{}</span><span class="o">'</span>
<span class="p">)</span><span class="o">::</span><span class="nv">json</span>
<span class="p">$</span><span class="nv">BODY</span><span class="p">$</span>
<span class="w">  </span><span class="nv">LANGUAGE</span><span class="w"> </span><span class="nv">sql</span><span class="w"> </span><span class="nv">IMMUTABLE</span><span class="w"> </span><span class="nv">STRICT</span>
<span class="w">  </span><span class="nv">COST</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
</pre></div>

<p><strong>Update</strong> : functions are compacted now.</p>
<p><br></p>
<h3>Suggest</h3>
<p>With 9.5 use jsonb_set-</p>
<div class="code"><pre class="code literal-block">UPDATE objects
SET body = jsonb_set(body, '{name}', '"Mary"', true)
WHERE id = 1;
</pre></div>

<p>where body is a jsonb column type.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-do-i-import-the-javax-servlet-jakarta-servlet-api-in-my-eclipse-project/" class="u-url">How do I import the javax.servlet / jakarta.servlet API in my Eclipse project?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-do-i-import-the-javax-servlet-jakarta-servlet-api-in-my-eclipse-project/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T08:57:23+08:00" itemprop="datePublished" title="2023-03-05 08:57">2023-03-05 08:57</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I want to develop with Servlets in Eclipse, but it says that the package
<code>javax.servlet</code> / <code>jakarta.servlet</code> cannot be resolved. How can I add
<code>javax.servlet</code> / <code>jakarta.servlet</code> package to my Eclipse project?</p>
<p><br><br></p>
<h2>Answer</h2>
<h2>Ensure you've the right Eclipse and Server version</h2>
<p>Ensure that you're using at least Eclipse IDE for <strong>Enterprise</strong> Java (and
Web) developers (with the <strong>Enterprise</strong> ). It contains development tools to
create dynamic web projects and easily integrate servletcontainers (those
tools are part of Web Tools Platform, WTP). In case you already had Eclipse
IDE for Java (without Enterprise), and manually installed some related
plugins, then chances are that it wasn't done properly. You'd best trash it
and grab the real Eclipse IDE for Enterprise Java one.</p>
<p>You also need to ensure that you already have a servletcontainer installed on
your machine which implements at least the same Servlet API version as the
servletcontainer in the production environment, for example Apache Tomcat,
RedHat WildFly, Eclipse GlassFish, etc. Usually, just downloading the ZIP file
and extracting it is sufficient. In case of Tomcat, do <em>not</em> download the EXE
format, that's only for Windows based production environments. See also a.o.
Several ports (8005, 8080, 8009) required by Tomcat Server at localhost are
already in use.</p>
<p>A servletcontainer is a concrete implementation of the Servlet API. Also note
that for example WildFly and GlassFish are <em>more</em> than just a
servletcontainer, they also support JSF (Faces), EJB (Enterprise Beans), JPA
(Persistence) and all other Jakarta EE fanciness. See also a.o. What exactly
is Java EE?</p>
<h2>Ensure that you're using the right Servlet package</h2>
<p>The <code>javax.*</code> package has been renamed to <code>jakarta.*</code> package since Servlet
API version 5.0 which is part of Jakarta EE 9 (Tomcat 10, TomEE 9, WildFly 22
Preview, GlassFish 6, Payara 6, Liberty 22, etc). So if you're targeting these
server versions or newer, then you need to replace</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">javax.servlet.</span><span class="o">*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.</span><span class="o">*</span><span class="p">;</span>
</pre></div>

<p>by</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">jakarta.servlet.</span><span class="o">*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">jakarta.servlet.http.</span><span class="o">*</span><span class="p">;</span>
</pre></div>

<p>in order to get it to compile, else you might risk to face this build error</p>
<blockquote>
<p>The superclass "javax.servlet.http.HttpServlet" was not found on the Java
Build Path</p>
</blockquote>
<h2>Integrate Server in Eclipse and associate it with Project</h2>
<p>Once having installed both Eclipse for Enterprise Java and a servletcontainer
on your machine, do the following steps in Eclipse:</p>
<ol>
<li><strong>Integrate servletcontainer in Eclipse</strong></li>
</ol>
<p>a. <strong>Via Servers view</strong></p>
<div class="code"><pre class="code literal-block">* Open the _Servers_ view in the bottom box.

* Rightclick there and choose _New &gt; Server_.

* Pick the appropriate servletcontainer make and version and walk through the wizard.
</pre></div>

<p><img alt="enter image description here" src="images/99Li8m.png"></p>
<p>b. <strong>Or, via Eclipse preferences</strong></p>
<div class="code"><pre class="code literal-block">* Open _Window &gt; Preferences &gt; Server &gt; Runtime Environments_.

* You can _Add_ , _Edit_ and _Remove_ servers here.
</pre></div>

<p><img alt="enter image description here" src="images/hf9Gom.png"></p>
<ol>
<li><strong>Associate server with project</strong></li>
</ol>
<p>a. <strong>In new project</strong></p>
<div class="code"><pre class="code literal-block"><span class="o">*</span><span class="w"> </span><span class="nv">Open</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">_Project</span><span class="w"> </span><span class="nv">Navigator</span><span class="o">/</span><span class="nv">Explorer_</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">left</span><span class="w"> </span><span class="nv">hand</span><span class="w"> </span><span class="nv">side</span>.

<span class="o">*</span><span class="w"> </span><span class="nv">Rightclick</span><span class="w"> </span><span class="nv">there</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">choose</span><span class="w"> </span><span class="nv">_New</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nv">Project_</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">menu</span><span class="w"> </span><span class="nv">_Web</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nv">Dynamic</span><span class="w"> </span><span class="nv">Web</span><span class="w"> </span><span class="nv">Project_</span>.

<span class="o">*</span><span class="w"> </span><span class="nv">In</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">wizard</span>,<span class="w"> </span><span class="nv">set</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">_Target</span><span class="w"> </span><span class="nv">Runtime_</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">integrated</span><span class="w"> </span><span class="nv">server</span>.
</pre></div>

<p><img alt="enter image description here" src="images/M259Em.png"></p>
<p>b. <strong>Or, in existing project</strong></p>
<div class="code"><pre class="code literal-block">* Rightclick project and choose _Properties_.

* In _Targeted Runtimes_ section, select the integrated server.
</pre></div>

<p><img alt="enter image description here" src="images/jcY3Mm.png"></p>
<p>Either way, Eclipse will then automatically take the servletcontainer's
libraries in the build path. This way you'll be able to import and use the
Servlet API.</p>
<h2>Never carry around loose server-specific JAR files</h2>
<p>You should in any case not have the need to fiddle around in the <em>Build Path</em>
property of the project. You should above all <strong>never</strong> manually
copy/download/move/include the individual servletcontainer-specific libraries
like <code>servlet-api.jar</code>, <code>jsp-api.jar</code>, <code>el-api.jar</code>, <code>j2ee.jar</code>, <code>javaee.jar</code>,
etc. It would only lead to future portability, compatibility, classpath and
maintainability troubles, because your webapp would not work when it's
deployed to a servletcontainer of a different make/version than where those
libraries are originally obtained from.</p>
<p>In case you're using Maven, you need to make absolutely sure that
servletcontainer-specific libraries which are already provided by the target
runtime are marked as <code>&lt;scope&gt;provided&lt;/scope&gt;</code>. You can find examples of
proper <code>pom.xml</code> dependency declarations for Tomcat 10+, Tomcat 9-, JEE 9+ and
JEE 8- in this answer: How to properly configure Jakarta EE libraries in Maven
pom.xml for Tomcat?</p>
<p>Here are some typical exceptions which you can get when you litter the <code>/WEB-
INF/lib</code> or even <code>/JRE/lib</code>, <code>/JRE/lib/ext</code>, etc with servletcontainer-
specific libraries in a careless attempt to fix the compilation errors:</p>
<ul>
<li>java.lang.NullPointerException at org.apache.jsp.index_jsp._jspInit</li>
<li>java.lang.NoClassDefFoundError: javax/el/ELResolver</li>
<li>java.lang.NoSuchFieldError: IS_DIR</li>
<li>java.lang.NoSuchMethodError: javax.servlet.jsp.PageContext.getELContext()Ljavax/el/ELContext;</li>
<li>java.lang.AbstractMethodError: javax.servlet.jsp.JspFactory.getJspApplicationContext(Ljavax/servlet/ServletContext;)Ljavax/servlet/jsp/JspApplicationContext;</li>
<li>org.apache.jasper.JasperException: The method getJspApplicationContext(ServletContext) is undefined for the type JspFactory</li>
<li>java.lang.VerifyError: (class: org/apache/jasper/runtime/JspApplicationContextImpl, method: createELResolver signature: ()Ljavax/el/ELResolver;) Incompatible argument to function</li>
<li>jar not loaded. See Servlet Spec 2.3, section 9.7.2. Offending class: javax/servlet/Servlet.class</li>
</ul>
<p><br></p>
<h3>Suggest</h3>
<p><img alt="import javax.servlet" src="images/4QFXL.png"></p>
<h3>STEP 1</h3>
<p>Go to <strong>properties</strong> of your project ( with <code>Alt</code>+<code>Enter</code> or righ-click )</p>
<h3>STEP 2</h3>
<p>check on <em>Apache Tomcat v7.0</em> under <strong>Targeted Runtime</strong> and it works.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2669.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2667.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
