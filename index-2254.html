<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 2254) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-2254.html">
<link rel="prev" href="index-2255.html" type="text/html">
<link rel="next" href="index-2253.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/call-a-local-function-within-module-exports-from-another-function-in-module-exports/" class="u-url">Call a "local" function within module.exports from another function in module.exports?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/call-a-local-function-within-module-exports-from-another-function-in-module-exports/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-04T02:29:43+08:00" itemprop="datePublished" title="2023-03-04 02:29">2023-03-04 02:29</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>How do you call a function from within another function in a <code>module.exports</code>
declaration?</p>
<p>app.js</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">bla</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">'./bla.js'</span><span class="p">);</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">bla</span><span class="o">.</span><span class="n">bar</span><span class="p">());</span>
</pre></div>

<p>bla.js</p>
<div class="code"><pre class="code literal-block"><span class="n">module</span><span class="o">.</span><span class="n">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="n">foo</span><span class="p">:</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="s1">'foo'</span><span class="p">);</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="n">bar</span><span class="p">:</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">this</span><span class="o">.</span><span class="n">foo</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>

<p>I'm trying to access the function <code>foo</code> from within the function <code>bar</code>, and
I'm getting:</p>
<blockquote>
<p>TypeError: Object # has no method 'foo'</p>
</blockquote>
<p>If I change <code>this.foo()</code> to just <code>foo()</code> I get:</p>
<blockquote>
<p>ReferenceError: foo is not defined</p>
</blockquote>
<p><br><br></p>
<h2>Answer</h2>
<p>Change <code>this.foo()</code> to <code>module.exports.foo()</code></p>
<p><br></p>
<h3>Suggest</h3>
<p>You could declare your functions outside of the <code>module.exports</code> block.</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="s1">'foo'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">var</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>Then:</p>
<div class="code"><pre class="code literal-block"><span class="n">module</span><span class="o">.</span><span class="n">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">foo</span><span class="p">:</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span>
<span class="w">  </span><span class="n">bar</span><span class="p">:</span><span class="w"> </span><span class="n">bar</span>
<span class="p">}</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/creating-a-blurring-overlay-view/" class="u-url">Creating a blurring overlay view</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/creating-a-blurring-overlay-view/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-04T02:28:11+08:00" itemprop="datePublished" title="2023-03-04 02:28">2023-03-04 02:28</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>In the Music app of the new iOS, we can see an album cover behind a view that
blurs it.</p>
<p>How can something like that be accomplished? I've read the documentation, but
did not find anything there.</p>
<p><img alt="" src="images/QXEg4m.jpg"></p>
<p><br><br></p>
<h2>Answer</h2>
<p>You can use <code>UIVisualEffectView</code> to achieve this effect. This is a native API
that has been fine-tuned for performance and great battery life, plus it's
easy to implement.</p>
<p><strong>Swift:</strong></p>
<div class="code"><pre class="code literal-block"><span class="c1">//only apply the blur if the user hasn't disabled transparency effects</span>
<span class="k">if</span><span class="w"> </span>!<span class="n">UIAccessibility</span><span class="p">.</span><span class="n">isReduceTransparencyEnabled</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">view</span><span class="p">.</span><span class="n">backgroundColor</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">.</span><span class="nb">clear</span>

<span class="w">    </span><span class="n">let</span><span class="w"> </span><span class="n">blurEffect</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">UIBlurEffect</span><span class="p">(</span><span class="n">style</span><span class="p">:</span><span class="w"> </span><span class="p">.</span><span class="n">dark</span><span class="p">)</span>
<span class="w">    </span><span class="n">let</span><span class="w"> </span><span class="n">blurEffectView</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">UIVisualEffectView</span><span class="p">(</span><span class="n">effect</span><span class="p">:</span><span class="w"> </span><span class="n">blurEffect</span><span class="p">)</span>
<span class="w">    </span><span class="c1">//always fill the view</span>
<span class="w">    </span><span class="n">blurEffectView</span><span class="p">.</span><span class="n">frame</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">bounds</span>
<span class="w">    </span><span class="n">blurEffectView</span><span class="p">.</span><span class="n">autoresizingMask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[.</span><span class="n">flexibleWidth</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">flexibleHeight</span><span class="p">]</span>

<span class="w">    </span><span class="n">view</span><span class="p">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">blurEffectView</span><span class="p">)</span><span class="w"> </span><span class="c1">//if you have more UIViews, use an insertSubview API to place it where needed</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">view</span><span class="p">.</span><span class="n">backgroundColor</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">.</span><span class="nb">black</span>
<span class="p">}</span>
</pre></div>

<p><strong>Objective-C:</strong></p>
<div class="code"><pre class="code literal-block"><span class="c1">//only apply the blur if the user hasn't disabled transparency effects</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">UIAccessibilityIsReduceTransparencyEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">backgroundColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="bp">UIColor</span><span class="w"> </span><span class="n">clearColor</span><span class="p">];</span>

<span class="w">    </span><span class="bp">UIBlurEffect</span><span class="w"> </span><span class="o">*</span><span class="n">blurEffect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="bp">UIBlurEffect</span><span class="w"> </span><span class="n">effectWithStyle</span><span class="o">:</span><span class="n">UIBlurEffectStyleDark</span><span class="p">];</span>
<span class="w">    </span><span class="bp">UIVisualEffectView</span><span class="w"> </span><span class="o">*</span><span class="n">blurEffectView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[[</span><span class="bp">UIVisualEffectView</span><span class="w"> </span><span class="n">alloc</span><span class="p">]</span><span class="w"> </span><span class="n">initWithEffect</span><span class="o">:</span><span class="n">blurEffect</span><span class="p">];</span>
<span class="w">    </span><span class="c1">//always fill the view</span>
<span class="w">    </span><span class="n">blurEffectView</span><span class="p">.</span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">bounds</span><span class="p">;</span>
<span class="w">    </span><span class="n">blurEffectView</span><span class="p">.</span><span class="n">autoresizingMask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UIViewAutoresizingFlexibleWidth</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UIViewAutoresizingFlexibleHeight</span><span class="p">;</span>

<span class="w">    </span><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="w"> </span><span class="n">addSubview</span><span class="o">:</span><span class="n">blurEffectView</span><span class="p">];</span><span class="w"> </span><span class="c1">//if you have more UIViews, use an insertSubview API to place it where needed</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">backgroundColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="bp">UIColor</span><span class="w"> </span><span class="n">blackColor</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>

<p>If you are presenting this view controller modally to blur the underlying
content, you'll need to set the modal presentation style to Over Current
Context and set the background color to clear to ensure the underlying view
controller will remain visible once this is presented overtop.</p>
<p><br></p>
<h3>Suggest</h3>
<h3>Core Image</h3>
<p>Since that image in the screenshot is static, you could use <code>CIGaussianBlur</code>
from Core Image (requires iOS 6). Here is sample:
https://github.com/evanwdavis/Fun-with-
Masks/blob/master/Fun%20with%20Masks/EWDBlurExampleVC.m</p>
<p>Mind you, this is slower than the other options on this page.</p>
<div class="code"><pre class="code literal-block"><span class="c1">#import &lt;QuartzCore/QuartzCore.h&gt;</span>

<span class="o">-</span> <span class="p">(</span><span class="n">UIImage</span><span class="o">*</span><span class="p">)</span> <span class="n">blur</span><span class="p">:(</span><span class="n">UIImage</span><span class="o">*</span><span class="p">)</span><span class="n">theImage</span>
<span class="p">{</span>   
    <span class="o">//</span> <span class="o">***********</span><span class="n">If</span> <span class="n">you</span> <span class="n">need</span> <span class="n">re</span><span class="o">-</span><span class="n">orienting</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">blur</span> <span class="n">a</span> <span class="n">photo</span> <span class="n">taken</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">device</span> <span class="n">camera</span> <span class="n">front</span> <span class="n">facing</span> <span class="n">camera</span> <span class="ow">in</span> <span class="n">portrait</span> <span class="n">mode</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">theImage</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span> <span class="n">reOrientIfNeeded</span><span class="p">:</span><span class="n">theImage</span><span class="p">];</span>

    <span class="o">//</span> <span class="n">create</span> <span class="n">our</span> <span class="n">blurred</span> <span class="n">image</span>
    <span class="n">CIContext</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="p">[</span><span class="n">CIContext</span> <span class="n">contextWithOptions</span><span class="p">:</span><span class="n">nil</span><span class="p">];</span>
    <span class="n">CIImage</span> <span class="o">*</span><span class="n">inputImage</span> <span class="o">=</span> <span class="p">[</span><span class="n">CIImage</span> <span class="n">imageWithCGImage</span><span class="p">:</span><span class="n">theImage</span><span class="o">.</span><span class="n">CGImage</span><span class="p">];</span>

    <span class="o">//</span> <span class="n">setting</span> <span class="n">up</span> <span class="n">Gaussian</span> <span class="n">Blur</span> <span class="p">(</span><span class="n">we</span> <span class="n">could</span> <span class="n">use</span> <span class="n">one</span> <span class="n">of</span> <span class="n">many</span> <span class="n">filters</span> <span class="n">offered</span> <span class="n">by</span> <span class="n">Core</span> <span class="n">Image</span><span class="p">)</span>
    <span class="n">CIFilter</span> <span class="o">*</span><span class="nb">filter</span> <span class="o">=</span> <span class="p">[</span><span class="n">CIFilter</span> <span class="n">filterWithName</span><span class="p">:</span><span class="o">@</span><span class="s2">"CIGaussianBlur"</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">filter</span> <span class="n">setValue</span><span class="p">:</span><span class="n">inputImage</span> <span class="n">forKey</span><span class="p">:</span><span class="n">kCIInputImageKey</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">filter</span> <span class="n">setValue</span><span class="p">:[</span><span class="n">NSNumber</span> <span class="n">numberWithFloat</span><span class="p">:</span><span class="mf">15.0</span><span class="n">f</span><span class="p">]</span> <span class="n">forKey</span><span class="p">:</span><span class="o">@</span><span class="s2">"inputRadius"</span><span class="p">];</span>
    <span class="n">CIImage</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="nb">filter</span> <span class="n">valueForKey</span><span class="p">:</span><span class="n">kCIOutputImageKey</span><span class="p">];</span>

    <span class="o">//</span> <span class="n">CIGaussianBlur</span> <span class="n">has</span> <span class="n">a</span> <span class="n">tendency</span> <span class="n">to</span> <span class="n">shrink</span> <span class="n">the</span> <span class="n">image</span> <span class="n">a</span> <span class="n">little</span><span class="p">,</span> 
    <span class="o">//</span> <span class="n">this</span> <span class="n">ensures</span> <span class="n">it</span> <span class="n">matches</span> <span class="n">up</span> <span class="n">exactly</span> <span class="n">to</span> <span class="n">the</span> <span class="n">bounds</span> <span class="n">of</span> <span class="n">our</span> <span class="n">original</span> <span class="n">image</span>
    <span class="n">CGImageRef</span> <span class="n">cgImage</span> <span class="o">=</span> <span class="p">[</span><span class="n">context</span> <span class="n">createCGImage</span><span class="p">:</span><span class="n">result</span> <span class="n">fromRect</span><span class="p">:[</span><span class="n">inputImage</span> <span class="n">extent</span><span class="p">]];</span>

    <span class="n">UIImage</span> <span class="o">*</span><span class="n">returnImage</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="n">imageWithCGImage</span><span class="p">:</span><span class="n">cgImage</span><span class="p">];</span><span class="o">//</span><span class="n">create</span> <span class="n">a</span> <span class="n">UIImage</span> <span class="k">for</span> <span class="n">this</span> <span class="n">function</span> <span class="n">to</span> <span class="s2">"return"</span> <span class="n">so</span> <span class="n">that</span> <span class="n">ARC</span> <span class="n">can</span> <span class="n">manage</span> <span class="n">the</span> <span class="n">memory</span> <span class="n">of</span> <span class="n">the</span> <span class="n">blur</span><span class="o">...</span> <span class="n">ARC</span> <span class="n">can</span><span class="s1">'t manage CGImageRefs so we need to release it before this function "returns" and ends.</span>
    <span class="n">CGImageRelease</span><span class="p">(</span><span class="n">cgImage</span><span class="p">);</span><span class="o">//</span><span class="n">release</span> <span class="n">CGImageRef</span> <span class="n">because</span> <span class="n">ARC</span> <span class="n">doesn</span><span class="s1">'t manage this on its own.</span>

    <span class="k">return</span> <span class="n">returnImage</span><span class="p">;</span>

    <span class="o">//</span> <span class="o">***************</span> <span class="k">if</span> <span class="n">you</span> <span class="n">need</span> <span class="n">scaling</span>
    <span class="o">//</span> <span class="k">return</span> <span class="p">[[</span><span class="bp">self</span> <span class="n">class</span><span class="p">]</span> <span class="n">scaleIfNeeded</span><span class="p">:</span><span class="n">cgImage</span><span class="p">];</span>
<span class="p">}</span>

<span class="o">+</span><span class="p">(</span><span class="n">UIImage</span><span class="o">*</span><span class="p">)</span> <span class="n">scaleIfNeeded</span><span class="p">:(</span><span class="n">CGImageRef</span><span class="p">)</span><span class="n">cgimg</span> <span class="p">{</span>
    <span class="nb">bool</span> <span class="n">isRetina</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">UIDevice</span> <span class="n">currentDevice</span><span class="p">]</span> <span class="n">systemVersion</span><span class="p">]</span> <span class="n">intValue</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="p">[[</span><span class="n">UIScreen</span> <span class="n">mainScreen</span><span class="p">]</span> <span class="n">scale</span><span class="p">]</span> <span class="o">==</span> <span class="mf">2.0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isRetina</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">UIImage</span> <span class="n">imageWithCGImage</span><span class="p">:</span><span class="n">cgimg</span> <span class="n">scale</span><span class="p">:</span><span class="mf">2.0</span> <span class="n">orientation</span><span class="p">:</span><span class="n">UIImageOrientationUp</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">UIImage</span> <span class="n">imageWithCGImage</span><span class="p">:</span><span class="n">cgimg</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="n">UIImage</span><span class="o">*</span><span class="p">)</span> <span class="n">reOrientIfNeeded</span><span class="p">:(</span><span class="n">UIImage</span><span class="o">*</span><span class="p">)</span><span class="n">theImage</span><span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">theImage</span><span class="o">.</span><span class="n">imageOrientation</span> <span class="o">!=</span> <span class="n">UIImageOrientationUp</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">CGAffineTransform</span> <span class="n">reOrient</span> <span class="o">=</span> <span class="n">CGAffineTransformIdentity</span><span class="p">;</span>
        <span class="n">switch</span> <span class="p">(</span><span class="n">theImage</span><span class="o">.</span><span class="n">imageOrientation</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">UIImageOrientationDown</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">UIImageOrientationDownMirrored</span><span class="p">:</span>
                <span class="n">reOrient</span> <span class="o">=</span> <span class="n">CGAffineTransformTranslate</span><span class="p">(</span><span class="n">reOrient</span><span class="p">,</span> <span class="n">theImage</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">theImage</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="p">);</span>
                <span class="n">reOrient</span> <span class="o">=</span> <span class="n">CGAffineTransformRotate</span><span class="p">(</span><span class="n">reOrient</span><span class="p">,</span> <span class="n">M_PI</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">UIImageOrientationLeft</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">UIImageOrientationLeftMirrored</span><span class="p">:</span>
                <span class="n">reOrient</span> <span class="o">=</span> <span class="n">CGAffineTransformTranslate</span><span class="p">(</span><span class="n">reOrient</span><span class="p">,</span> <span class="n">theImage</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="n">reOrient</span> <span class="o">=</span> <span class="n">CGAffineTransformRotate</span><span class="p">(</span><span class="n">reOrient</span><span class="p">,</span> <span class="n">M_PI_2</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">UIImageOrientationRight</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">UIImageOrientationRightMirrored</span><span class="p">:</span>
                <span class="n">reOrient</span> <span class="o">=</span> <span class="n">CGAffineTransformTranslate</span><span class="p">(</span><span class="n">reOrient</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">theImage</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="p">);</span>
                <span class="n">reOrient</span> <span class="o">=</span> <span class="n">CGAffineTransformRotate</span><span class="p">(</span><span class="n">reOrient</span><span class="p">,</span> <span class="o">-</span><span class="n">M_PI_2</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">UIImageOrientationUp</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">UIImageOrientationUpMirrored</span><span class="p">:</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">switch</span> <span class="p">(</span><span class="n">theImage</span><span class="o">.</span><span class="n">imageOrientation</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">UIImageOrientationUpMirrored</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">UIImageOrientationDownMirrored</span><span class="p">:</span>
                <span class="n">reOrient</span> <span class="o">=</span> <span class="n">CGAffineTransformTranslate</span><span class="p">(</span><span class="n">reOrient</span><span class="p">,</span> <span class="n">theImage</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="n">reOrient</span> <span class="o">=</span> <span class="n">CGAffineTransformScale</span><span class="p">(</span><span class="n">reOrient</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">UIImageOrientationLeftMirrored</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">UIImageOrientationRightMirrored</span><span class="p">:</span>
                <span class="n">reOrient</span> <span class="o">=</span> <span class="n">CGAffineTransformTranslate</span><span class="p">(</span><span class="n">reOrient</span><span class="p">,</span> <span class="n">theImage</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="n">reOrient</span> <span class="o">=</span> <span class="n">CGAffineTransformScale</span><span class="p">(</span><span class="n">reOrient</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">UIImageOrientationUp</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">UIImageOrientationDown</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">UIImageOrientationLeft</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">UIImageOrientationRight</span><span class="p">:</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">CGContextRef</span> <span class="n">myContext</span> <span class="o">=</span> <span class="n">CGBitmapContextCreate</span><span class="p">(</span><span class="n">NULL</span><span class="p">,</span> <span class="n">theImage</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">theImage</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">CGImageGetBitsPerComponent</span><span class="p">(</span><span class="n">theImage</span><span class="o">.</span><span class="n">CGImage</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGImageGetColorSpace</span><span class="p">(</span><span class="n">theImage</span><span class="o">.</span><span class="n">CGImage</span><span class="p">),</span> <span class="n">CGImageGetBitmapInfo</span><span class="p">(</span><span class="n">theImage</span><span class="o">.</span><span class="n">CGImage</span><span class="p">));</span>

        <span class="n">CGContextConcatCTM</span><span class="p">(</span><span class="n">myContext</span><span class="p">,</span> <span class="n">reOrient</span><span class="p">);</span>

        <span class="n">switch</span> <span class="p">(</span><span class="n">theImage</span><span class="o">.</span><span class="n">imageOrientation</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">UIImageOrientationLeft</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">UIImageOrientationLeftMirrored</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">UIImageOrientationRight</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">UIImageOrientationRightMirrored</span><span class="p">:</span>
                <span class="n">CGContextDrawImage</span><span class="p">(</span><span class="n">myContext</span><span class="p">,</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">theImage</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="p">,</span><span class="n">theImage</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="n">theImage</span><span class="o">.</span><span class="n">CGImage</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="n">default</span><span class="p">:</span>
                <span class="n">CGContextDrawImage</span><span class="p">(</span><span class="n">myContext</span><span class="p">,</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">theImage</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">,</span><span class="n">theImage</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="p">),</span> <span class="n">theImage</span><span class="o">.</span><span class="n">CGImage</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">CGImageRef</span> <span class="n">CGImg</span> <span class="o">=</span> <span class="n">CGBitmapContextCreateImage</span><span class="p">(</span><span class="n">myContext</span><span class="p">);</span>
        <span class="n">theImage</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="n">imageWithCGImage</span><span class="p">:</span><span class="n">CGImg</span><span class="p">];</span>

        <span class="n">CGImageRelease</span><span class="p">(</span><span class="n">CGImg</span><span class="p">);</span>
        <span class="n">CGContextRelease</span><span class="p">(</span><span class="n">myContext</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">theImage</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<h3>Stack blur (Box + Gaussian)</h3>
<ul>
<li>StackBlur This implements a mix of Box and Gaussian blur. 7x faster than non accelerated gaussian, but not so ugly as box blur. See a demo in here (Java plugin version) or here (JavaScript version). This algorithm is used in KDE and Camera+ and others. It doesn't use the Accelerate Framework but it's fast.</li>
</ul>
<h3>Accelerate Framework</h3>
<ul>
<li>
<p>In the session “Implementing Engaging UI on iOS” from WWDC 2013 Apple explains how to create a blurred background (at 14:30), and mentions a method <code>applyLightEffect</code> implemented in the sample code using Accelerate.framework. </p>
</li>
<li>
<p>GPUImage uses OpenGL shaders to create dynamic blurs. It has several types of blur: GPUImageBoxBlurFilter, GPUImageFastBlurFilter, GaussianSelectiveBlur, GPUImageGaussianBlurFilter. There is even a GPUImageiOSBlurFilter that “should fully replicate the blur effect provided by iOS 7's control panel” (tweet, article). The article is detailed and informative.</p>
<div class="code"><pre class="code literal-block"><span class="p">-(</span><span class="bp">UIImage</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="nf">blurryGPUImage:</span><span class="p">(</span><span class="bp">UIImage</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="nv">image</span><span class="w"> </span><span class="nf">withBlurLevel:</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nv">blur</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">GPUImageFastBlurFilter</span><span class="w"> </span><span class="o">*</span><span class="n">blurFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">GPUImageFastBlurFilter</span><span class="w"> </span><span class="n">new</span><span class="p">];</span>
<span class="w">    </span><span class="n">blurFilter</span><span class="p">.</span><span class="n">blurSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blur</span><span class="p">;</span>
<span class="w">    </span><span class="bp">UIImage</span><span class="w"> </span><span class="o">*</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">blurFilter</span><span class="w"> </span><span class="n">imageByFilteringImage</span><span class="o">:</span><span class="n">image</span><span class="p">];</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

</li>
<li>
<p>From indieambitions.com: Perform a blur using vImage. The algorithm is also used in iOS-RealTimeBlur.</p>
</li>
<li>
<p>From Nick Lockwood: https://github.com/nicklockwood/FXBlurView The example shows the blur over a scroll view. It blurs with dispatch_async, then syncs to call updates with UITrackingRunLoopMode so the blur is not lagged when UIKit gives more priority to the scroll of the UIScrollView. This is explained in Nick's book iOS Core Animation, which btw it's great.</p>
</li>
<li>
<p>iOS-blur This takes the blurring layer of the UIToolbar and puts it elsewhere. Apple will reject your app if you use this method. See https://github.com/mochidev/MDBlurView/issues/4</p>
</li>
<li>
<p>From Evadne blog: LiveFrost: Fast, Synchronous UIView Snapshot Convolving. Great code and a great read. Some ideas from this post: </p>
<ul>
<li>Use a serial queue to throttle updates from CADisplayLink.</li>
<li>Reuse bitmap contexts unless bounds change.</li>
<li>Draw smaller images using -[CALayer renderInContext:] with a 0.5f scale factor.</li>
</ul>
</li>
</ul>
<h3>Other stuff</h3>
<p>Andy Matuschak said on Twitter: “you know, a lot of the places where it looks
like we're doing it in real time, it's static with clever tricks.”</p>
<p>At doubleencore.com they say “we’ve found that a 10 pt blur radius plus a 10
pt increase in saturation best mimics iOS 7’s blur effect under most
circumstances”.</p>
<p>A peek at the private headers of Apple's SBFProceduralWallpaperView.</p>
<p>Finally, this isn't a real blur, but remember you can set rasterizationScale
to get a pixelated image: http://www.dimzzy.com/blog/2010/11/blur-effect-for-
uiview/</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/asp-net-core-web-api-exception-handling/" class="u-url">ASP.NET Core Web API exception handling</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/asp-net-core-web-api-exception-handling/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-04T02:26:37+08:00" itemprop="datePublished" title="2023-03-04 02:26">2023-03-04 02:26</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I am using ASP.NET Core for my new REST API project after using regular
ASP.NET Web API for many years. I don't see any good way to handle exceptions
in ASP.NET Core Web API. I tried to implement an exception handling
filter/attribute:</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">ErrorHandlingFilter</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ExceptionFilterAttribute</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">override</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">OnException</span><span class="p">(</span><span class="n">ExceptionContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">HandleExceptionAsync</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
<span class="w">        </span><span class="n">context</span><span class="o">.</span><span class="n">ExceptionHandled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">HandleExceptionAsync</span><span class="p">(</span><span class="n">ExceptionContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">Exception</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exception</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">MyNotFoundException</span><span class="p">)</span>
<span class="w">            </span><span class="n">SetExceptionResult</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">exception</span><span class="p">,</span><span class="w"> </span><span class="n">HttpStatusCode</span><span class="o">.</span><span class="n">NotFound</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exception</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">MyUnauthorizedException</span><span class="p">)</span>
<span class="w">            </span><span class="n">SetExceptionResult</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">exception</span><span class="p">,</span><span class="w"> </span><span class="n">HttpStatusCode</span><span class="o">.</span><span class="n">Unauthorized</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exception</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">MyException</span><span class="p">)</span>
<span class="w">            </span><span class="n">SetExceptionResult</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">exception</span><span class="p">,</span><span class="w"> </span><span class="n">HttpStatusCode</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">SetExceptionResult</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">exception</span><span class="p">,</span><span class="w"> </span><span class="n">HttpStatusCode</span><span class="o">.</span><span class="n">InternalServerError</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">SetExceptionResult</span><span class="p">(</span>
<span class="w">        </span><span class="n">ExceptionContext</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">Exception</span><span class="w"> </span><span class="n">exception</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">HttpStatusCode</span><span class="w"> </span><span class="n">code</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">context</span><span class="o">.</span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">JsonResult</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">ApiResponse</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">StatusCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">int</span><span class="p">)</span><span class="n">code</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>And here is my Startup filter registration:</p>
<div class="code"><pre class="code literal-block">services.AddMvc(options =&gt;
{
    options.Filters.Add(new AuthorizationFilter());
    options.Filters.Add(new ErrorHandlingFilter());
});
</pre></div>

<p>The issue I was having is that when an exception occurs in my
<code>AuthorizationFilter</code> it's not being handled by <code>ErrorHandlingFilter</code>. I was
expecting it to be caught there just like it worked with the old ASP.NET Web
API.</p>
<p>So how can I catch all application exceptions as well as any exceptions from
Action Filters?</p>
<p><br><br></p>
<h2>Answer</h2>
<h3>Quick and Easy Exception Handling</h3>
<p>Simply add this middleware before ASP.NET routing into your middleware
registrations.</p>
<div class="code"><pre class="code literal-block"><span class="n">app</span><span class="o">.</span><span class="n">UseExceptionHandler</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">Features</span>
<span class="w">        </span><span class="o">.</span><span class="n">Get</span><span class="o">&lt;</span><span class="n">IExceptionHandlerPathFeature</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">        </span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exception</span><span class="o">.</span><span class="n">Message</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">WriteAsJsonAsync</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
<span class="p">}));</span>
<span class="n">app</span><span class="o">.</span><span class="n">UseMvc</span><span class="p">();</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="o">.</span><span class="n">UseRouting</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="o">.</span><span class="n">UseEndpoints</span><span class="p">()</span>
</pre></div>

<p>Done!</p>
<hr>
<h3>Enable Dependency Injection for logging and other purposes</h3>
<p><strong>Step 1.</strong> In your startup, register your exception handling route:</p>
<div class="code"><pre class="code literal-block"><span class="c1">// It should be one of your very first registrations</span>
<span class="n">app</span><span class="p">.</span><span class="n">UseExceptionHandler</span><span class="p">(</span><span class="s">"/error"</span><span class="p">);</span><span class="w"> </span><span class="c1">// Add this</span>
<span class="n">app</span><span class="p">.</span><span class="n">UseEndpoints</span><span class="p">(</span><span class="n">endpoints</span><span class="w"> </span><span class="p">=</span><span class="o">&gt;</span><span class="w"> </span><span class="n">endpoints</span><span class="p">.</span><span class="n">MapControllers</span><span class="p">());</span>
</pre></div>

<p><strong>Step 2.</strong> Create controller that will handle all exceptions and produce
error response:</p>
<div class="code"><pre class="code literal-block"><span class="k">[AllowAnonymous]</span>
<span class="k">[ApiExplorerSettings(IgnoreApi = true)]</span>
<span class="na">public class ErrorsController</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">ControllerBase</span>
<span class="na">{</span>
<span class="w">    </span><span class="k">[Route("error")]</span>
<span class="w">    </span><span class="na">public MyErrorResponse Error()</span>
<span class="w">    </span><span class="na">{</span>
<span class="w">        </span><span class="na">var context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">HttpContext.Features.Get&lt;IExceptionHandlerFeature&gt;()</span><span class="c1">;</span>
<span class="w">        </span><span class="na">var exception</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">context.Error</span><span class="c1">; // Your exception</span>
<span class="w">        </span><span class="na">var code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">500</span><span class="c1">; // Internal Server Error by default</span>

<span class="w">        </span><span class="na">if      (exception is MyNotFoundException) code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">404</span><span class="c1">; // Not Found</span>
<span class="w">        </span><span class="na">else if (exception is MyUnauthException)   code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">401</span><span class="c1">; // Unauthorized</span>
<span class="w">        </span><span class="na">else if (exception is MyException)         code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">400</span><span class="c1">; // Bad Request</span>

<span class="w">        </span><span class="na">Response.StatusCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">code</span><span class="c1">; // You can use HttpStatusCode enum instead</span>

<span class="w">        </span><span class="na">return new MyErrorResponse(exception); // Your error model</span>
<span class="w">    </span><span class="na">}</span>
<span class="na">}</span>
</pre></div>

<p>A few important notes and observations:</p>
<ul>
<li>You can <strong>inject your dependencies</strong> into the Controller's constructor.</li>
<li>
<code>[ApiExplorerSettings(IgnoreApi = true)]</code> is needed. Otherwise, it may break your Swashbuckle swagger</li>
<li>Again, <code>app.UseExceptionHandler("/error");</code> has to be one of the very top registrations in your Startup <code>Configure(...)</code> method. It's probably safe to place it at the top of the method.</li>
<li>The path in <code>app.UseExceptionHandler("/error")</code> and in controller <code>[Route("error")]</code> should be the same, to allow the controller handle exceptions redirected from exception handler middleware.</li>
</ul>
<p>Here is the link to official Microsoft documentation.</p>
<hr>
<h3>Response model ideas.</h3>
<p>Implement your own response model and exceptions. This example is just a good
starting point. Every service would need to handle exceptions in its own way.
With the described approach you have full flexibility and control over
handling exceptions and returning the right response from your service.</p>
<p>An example of error response model (just to give you some ideas):</p>
<div class="code"><pre class="code literal-block">public class MyErrorResponse
{
    public string Type { get; set; }
    public string Message { get; set; }
    public string StackTrace { get; set; }

    public MyErrorResponse(Exception ex)
    {
        Type = ex.GetType().Name;
        Message = ex.Message;
        StackTrace = ex.ToString();
    }
}
</pre></div>

<p>For simpler services, you might want to implement http status code exception
that would look like this:</p>
<div class="code"><pre class="code literal-block">public class HttpStatusException : Exception
{
    public HttpStatusCode Status { get; private set; }

    public HttpStatusException(HttpStatusCode status, string msg) : base(msg)
    {
        Status = status;
    }
}
</pre></div>

<p>This can be thrown from anywhere this way:</p>
<div class="code"><pre class="code literal-block">throw new HttpStatusCodeException(HttpStatusCode.NotFound, "User not found");
</pre></div>

<p>Then your handling code could be simplified to just this:</p>
<div class="code"><pre class="code literal-block"><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">exception</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">HttpStatusException</span><span class="w"> </span><span class="nv">httpException</span><span class="ss">)</span>
{
<span class="w">    </span><span class="nv">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">(</span><span class="nv">int</span><span class="ss">)</span><span class="w"> </span><span class="nv">httpException</span>.<span class="nv">Status</span><span class="c1">;</span>
}
</pre></div>

<hr>
<p><code>HttpContext.Features.Get&lt;IExceptionHandlerFeature&gt;()</code> WAT?</p>
<p>ASP.NET Core developers embraced the concept of middlewares where different
aspects of functionality such as Auth, MVC, Swagger etc. are separated and
executed sequentially in the request processing pipeline. Each middleware has
access to request context and can write into the response if needed. Taking
exception handling out of MVC makes sense if it's important to handle errors
from non-MVC middlewares the same way as MVC exceptions, which I find is very
common in real world apps. So because built-in exception handling middleware
is not a part of MVC, MVC itself knows nothing about it and vice versa,
exception handling middleware doesn't really know where the exception is
coming from, besides of course it knows that it happened somewhere down the
pipe of request execution. But both may needed to be "connected" with one
another. So when exception is not caught anywhere, exception handling
middleware catches it and re-runs the pipeline for a route, registered in it.
This is how you can "pass" exception handling back to MVC with consistent
content negotiation or some other middleware if you wish. The exception itself
is extracted from the common middleware context. Looks funny but gets the job
done :).</p>
<p><br></p>
<h3>Suggest</h3>
<p>There is a built-in middleware for that:</p>
<p><code>ASP.NET Core 5</code> version:</p>
<div class="code"><pre class="code literal-block"><span class="n">app</span><span class="o">.</span><span class="n">UseExceptionHandler</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">exceptionHandlerPathFeature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">Features</span><span class="o">.</span><span class="n">Get</span><span class="o">&lt;</span><span class="n">IExceptionHandlerPathFeature</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exceptionHandlerPathFeature</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>

<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">WriteAsJsonAsync</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exception</span><span class="o">.</span><span class="n">Message</span><span class="w"> </span><span class="p">});</span>
<span class="p">}));</span>
</pre></div>

<p>Older versions (they did not have <code>WriteAsJsonAsync</code> extension):</p>
<div class="code"><pre class="code literal-block"><span class="n">app</span><span class="o">.</span><span class="n">UseExceptionHandler</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">exceptionHandlerPathFeature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">Features</span><span class="o">.</span><span class="n">Get</span><span class="o">&lt;</span><span class="n">IExceptionHandlerPathFeature</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exceptionHandlerPathFeature</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>

<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JsonConvert</span><span class="o">.</span><span class="n">SerializeObject</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exception</span><span class="o">.</span><span class="n">Message</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="n">context</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">ContentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"application/json"</span><span class="p">;</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}));</span>
</pre></div>

<p>It should do pretty much the same, just a bit less code to write.</p>
<p><strong>Important:</strong> Remember to add it before <code>MapControllers</code> \ <code>UseMvc</code> (or
<code>UseRouting</code> in .Net Core 3) as order is important.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2255.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2253.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
