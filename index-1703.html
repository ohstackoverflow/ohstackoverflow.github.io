<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1703) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1703.html">
<link rel="prev" href="index-1704.html" type="text/html">
<link rel="next" href="index-1702.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/static-linking-vs-dynamic-linking/" class="u-url">Static linking vs dynamic linking</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/static-linking-vs-dynamic-linking/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T07:21:36+08:00" itemprop="datePublished" title="2023-03-03 07:21">2023-03-03 07:21</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Are there any compelling performance reasons to choose static linking over
dynamic linking or vice versa in certain situations? I've heard or read the
following, but I don't know enough on the subject to vouch for its veracity.</p>
<p>1) The difference in runtime performance between static linking and dynamic
linking is usually negligible.</p>
<p>2) (1) is not true if using a profiling compiler that uses profile data to
optimize program hotpaths because with static linking, the compiler can
optimize both your code and the library code. With dynamic linking only your
code can be optimized. If most of the time is spent running library code, this
can make a big difference. Otherwise, (1) still applies.</p>
<p><br><br></p>
<h2>Answer</h2>
<ul>
<li>
<strong>Dynamic</strong> linking can <strong>reduce total resource consumption</strong> (if more than one process shares the same library (including the version in "the same", of course)). I believe this is the argument that drives its presence in most environments. Here "resources" include disk space, RAM, and cache space. Of course, if your dynamic linker is insufficiently flexible there is a risk of DLL hell.</li>
<li>
<strong>Dynamic</strong> linking means that bug fixes and upgrades to libraries <strong>propagate</strong> to improve <em>your</em> product without requiring you to ship anything.</li>
<li>
<strong>Plugins</strong> always call for <strong>dynamic</strong> linking.</li>
<li>
<strong>Static</strong> linking, means that you can know the code will run in very <strong>limited environments</strong> (early in the boot process, or in rescue mode).</li>
<li>
<strong>Static</strong> linking can make binaries <strong>easier to distribute</strong> to diverse user environments (at the cost of sending a larger and more resource-hungry program).</li>
<li>
<strong>Static</strong> linking may allow slightly <strong>faster startup</strong> times, but this depends to some degree on both the size and complexity of your program <em>and</em> on the details of the OS's loading strategy.</li>
</ul>
<hr>
<p>Some edits to include the very relevant suggestions in the comments and in
other answers. I'd like to note that the way you break on this depends a lot
on what environment you plan to run in. Minimal embedded systems may not have
enough resources to support dynamic linking. Slightly larger small systems may
well support dynamic linking because their memory is small enough to make the
RAM savings from dynamic linking very attractive. Full-blown consumer PCs
have, as Mark notes, enormous resources, and you can probably let the
convenience issues drive your thinking on this matter.</p>
<hr>
<p>To address the performance and efficiency issues: <strong>it depends</strong>.</p>
<p>Classically, dynamic libraries require some kind of glue layer which often
means double dispatch or an extra layer of indirection in function addressing
and can cost a little speed (but is the function calling time actually a big
part of your running time???).</p>
<p>However, if you are running multiple processes which all call the same library
a lot, you can end up saving cache lines (and thus winning on running
performance) when using dynamic linking relative to using static linking.
(Unless modern OS's are smart enough to notice identical segments in
statically linked binaries. Seems hard, does anyone know?)</p>
<p>Another issue: loading time. You pay loading costs at some point. When you pay
this cost depends on how the OS works as well as what linking you use. Maybe
you'd rather put off paying it until you know you need it.</p>
<p>Note that static-vs-dynamic linking is traditionally <em>not</em> an optimization
issue, because they both involve separate compilation down to object files.
However, this is not required: a compiler can in principle, "compile" "static
libraries" to a digested AST form initially, and "link" them by adding those
ASTs to the ones generated for the main code, thus empowering global
optimization. None of the systems I use do this, so I can't comment on how
well it works.</p>
<p>The way to answer performance questions is <em>always</em> by testing (and use a test
environment as much like the deployment environment as possible).</p>
<p><br></p>
<h3>Suggest</h3>
<p>1) is based on the fact that calling a DLL function is always using an extra
indirect jump. Today, this is usually negligible. Inside the DLL there is some
more overhead on i386 CPU's, because they can't generate position independent
code. On amd64, jumps can be relative to the program counter, so this is a
huge improvement.</p>
<p>2) This is correct. With optimizations guided by profiling you can usually win
about 10-15 percent performance. Now that CPU speed has reached its limits it
might be worth doing it.</p>
<p>I would add: (3) the linker can arrange functions in a more cache efficient
grouping, so that expensive cache level misses are minimised. It also might
especially effect the startup time of applications (based on results i have
seen with the Sun C++ compiler)</p>
<p>And don't forget that with DLLs no dead code elimination can be performed.
Depending on the language, the DLL code might not be optimal either. Virtual
functions are always virtual because the compiler doesn't know whether a
client is overwriting it.</p>
<p>For these reasons, in case there is no real need for DLLs, then just use
static compilation.</p>
<p>EDIT (to answer the comment, by user underscore)</p>
<p>Here is a good resource about the position independent code problem
http://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-
shared-libraries/</p>
<p>As explained x86 does not have them AFAIK for anything else then 15 bit jump
ranges and not for unconditional jumps and calls. That's why functions (from
generators) having more then 32K have always been a problem and needed
embedded trampolines.</p>
<p>But on popular x86 OS like Linux you do not need to care if the .so/DLL file
is not generated with the <code>gcc</code> switch <code>-fpic</code> (which enforces the use of the
indirect jump tables). Because if you don't, the code is just fixed like a
normal linker would relocate it. But while doing this it makes the code
segment non shareable and it would need a full mapping of the code from disk
into memory and touching it all before it can be used (emptying most of the
caches, hitting TLBs) etc. There was a time when this was considered slow.</p>
<p>So you would not have any benefit anymore.</p>
<p>I do not recall what OS (Solaris or FreeBSD) gave me problems with my Unix
build system because I just wasn't doing this and wondered why it crashed
until I applied <code>-fPIC</code> to <code>gcc</code>.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/use-of-apply-with-new-operator-is-this-possible/" class="u-url">Use of .apply() with 'new' operator. Is this possible?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/use-of-apply-with-new-operator-is-this-possible/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T07:21:09+08:00" itemprop="datePublished" title="2023-03-03 07:21">2023-03-03 07:21</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>In JavaScript, I want to create an object instance (via the <code>new</code> operator),
but pass an arbitrary number of arguments to the constructor. Is this
possible?</p>
<p>What I want to do is something like this (but the code below does not work):</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">Something</span><span class="p">(){</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="n">stuff</span>
<span class="p">}</span>
<span class="n">function</span><span class="w"> </span><span class="n">createSomething</span><span class="p">(){</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Something</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb nb-Type">null</span><span class="p">,</span><span class="w"> </span><span class="n">arguments</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">var</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createSomething</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="s1">'s'</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Something</span>
</pre></div>

<hr>
<p><strong>The Answer</strong></p>
<p>From the responses here, it became clear that there's no built-in way to call
<code>.apply()</code> with the <code>new</code> operator. However, people suggested a number of
really interesting solutions to the problem.</p>
<p>My preferred solution was this one from Matthew Crumley (I've modified it to
pass the <code>arguments</code> property):</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">createSomething</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">F</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Something</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">F</span><span class="o">.</span><span class="n">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Something</span><span class="o">.</span><span class="n">prototype</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">F</span><span class="p">(</span><span class="n">arguments</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">})();</span>
</pre></div>

<p><br><br></p>
<h2>Answer</h2>
<p>With ECMAScript5's <code>Function.prototype.bind</code> things get pretty clean:</p>
<div class="code"><pre class="code literal-block"><span class="nv">function</span><span class="w"> </span><span class="nv">newCall</span><span class="ss">(</span><span class="nv">Cls</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="ss">(</span><span class="nv">Function</span>.<span class="nv">prototype</span>.<span class="nv">bind</span>.<span class="nv">apply</span><span class="ss">(</span><span class="nv">Cls</span>,<span class="w"> </span><span class="nv">arguments</span><span class="ss">))</span><span class="c1">;</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">even</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="ss">(</span><span class="nv">Cls</span>.<span class="nv">bind</span>.<span class="nv">apply</span><span class="ss">(</span><span class="nv">Cls</span>,<span class="w"> </span><span class="nv">arguments</span><span class="ss">))</span><span class="c1">;</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">you</span><span class="w"> </span><span class="nv">know</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">Cls</span>.<span class="nv">bind</span><span class="w"> </span><span class="nv">has</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">been</span><span class="w"> </span><span class="nv">overwritten</span>
}
</pre></div>

<p>It can be used as follows:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCall</span><span class="p">(</span><span class="n">Something</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
</pre></div>

<p>or even directly:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="p">(</span><span class="n">Function</span><span class="o">.</span><span class="n">prototype</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">Something</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">));</span>

<span class="k">var</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="p">(</span><span class="n">Function</span><span class="o">.</span><span class="n">prototype</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Something</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nb nb-Type">null</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">]));</span>
</pre></div>

<p>This and the eval-based solution are the only ones that always work, even with
special constructors like <code>Date</code>:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCall</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="mi">2012</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="n">instanceof</span><span class="w"> </span><span class="n">Date</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="bp">true</span>
</pre></div>

<hr>
<p><strong>edit</strong></p>
<p>A bit of explanation: We need to run <code>new</code> on a function that takes a limited
number of arguments. The <code>bind</code> method allows us to do it like so:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cls</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">anything</span><span class="p">,</span><span class="w"> </span><span class="n">arg1</span><span class="p">,</span><span class="w"> </span><span class="n">arg2</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">);</span>
<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>

<p>The <code>anything</code> parameter doesn't matter much, since the <code>new</code> keyword resets
<code>f</code>'s context. However, it is required for syntactical reasons. Now, for the
<code>bind</code> call: We need to pass a variable number of arguments, so this does the
trick:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cls</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Cls</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">anything</span><span class="p">,</span><span class="w"> </span><span class="n">arg1</span><span class="p">,</span><span class="w"> </span><span class="n">arg2</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">]);</span>
<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>

<p>Let's wrap that in a function. <code>Cls</code> is passed as argument 0, so it's gonna be
our <code>anything</code>.</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">newCall</span><span class="p">(</span><span class="n">Cls</span><span class="w"> </span><span class="o">/*</span><span class="p">,</span><span class="w"> </span><span class="n">arg1</span><span class="p">,</span><span class="w"> </span><span class="n">arg2</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="o">*/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cls</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Cls</span><span class="p">,</span><span class="w"> </span><span class="n">arguments</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>Actually, the temporary <code>f</code> variable is not needed at all:</p>
<div class="code"><pre class="code literal-block"><span class="nv">function</span><span class="w"> </span><span class="nv">newCall</span><span class="ss">(</span><span class="nv">Cls</span><span class="w"> </span><span class="cm">/*, arg1, arg2, ... */</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="ss">(</span><span class="nv">Cls</span>.<span class="nv">bind</span>.<span class="nv">apply</span><span class="ss">(</span><span class="nv">Cls</span>,<span class="w"> </span><span class="nv">arguments</span><span class="ss">))()</span><span class="c1">;</span>
}
</pre></div>

<p>Finally, we should make sure that <code>bind</code> is really what we need. (<code>Cls.bind</code>
may have been overwritten). So replace it by <code>Function.prototype.bind</code>, and we
get the final result as above.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Here's a generalized solution that can call any constructor (except native
constructors that behave differently when called as functions, like <code>String</code>,
<code>Number</code>, <code>Date</code>, etc.) with an array of arguments:</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">construct</span><span class="p">(</span><span class="n">constructor</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">F</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">constructor</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">F</span><span class="o">.</span><span class="n">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor</span><span class="o">.</span><span class="n">prototype</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">F</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>An object created by calling <code>construct(Class, [1, 2, 3])</code> would be identical
to an object created with <code>new Class(1, 2, 3)</code>.</p>
<p>You could also make a more specific version so you don't have to pass the
constructor every time. This is also slightly more efficient, since it doesn't
need to create a new instance of the inner function every time you call it.</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">createSomething</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">F</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Something</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">F</span><span class="o">.</span><span class="n">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Something</span><span class="o">.</span><span class="n">prototype</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">F</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">})();</span>
</pre></div>

<p>The reason for creating and calling the outer anonymous function like that is
to keep function <code>F</code> from polluting the global namespace. It's sometimes
called the module pattern.</p>
<p><strong>[UPDATE]</strong></p>
<p>For those who want to use this in TypeScript, since TS gives an error if <code>F</code>
returns anything:</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">construct</span><span class="p">(</span><span class="n">constructor</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">F</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">constructor</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">F</span><span class="o">.</span><span class="n">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor</span><span class="o">.</span><span class="n">prototype</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">F</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-to-check-if-an-object-is-a-list-or-tuple-but-not-string/" class="u-url">How to check if an object is a list or tuple (but not string)?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-to-check-if-an-object-is-a-list-or-tuple-but-not-string/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T07:20:34+08:00" itemprop="datePublished" title="2023-03-03 07:20">2023-03-03 07:20</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>This is what I normally do in order to ascertain that the input is a
<code>list</code>/<code>tuple</code> - but not a <code>str</code>. Because many times I stumbled upon bugs
where a function passes a <code>str</code> object by mistake, and the target function
does <code>for x in lst</code> assuming that <code>lst</code> is actually a <code>list</code> or <code>tuple</code>.</p>
<div class="code"><pre class="code literal-block">assert isinstance(lst, (list, tuple))
</pre></div>

<p>My question is: is there a better way of achieving this?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>In python 2 only (not python 3):</p>
<div class="code"><pre class="code literal-block">assert not isinstance(lst, basestring)
</pre></div>

<p>Is actually what you want, otherwise you'll miss out on a lot of things which
act like lists, but aren't subclasses of <code>list</code> or <code>tuple</code>.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Remember that in Python we want to use "duck typing". So, anything that acts
like a list can be treated as a list. So, don't check for the type of a list,
just see if it acts like a list.</p>
<p>But strings act like a list too, and often that is not what we want. There are
times when it is even a problem! So, check explicitly for a string, but then
use duck typing.</p>
<p>Here is a function I wrote for fun. It is a special version of <code>repr()</code> that
prints any sequence in angle brackets ('&lt;', '&gt;').</p>
<div class="code"><pre class="code literal-block"><span class="nv">def</span><span class="w"> </span><span class="nv">srepr</span><span class="ss">(</span><span class="nv">arg</span><span class="ss">)</span>:
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">isinstance</span><span class="ss">(</span><span class="nv">arg</span>,<span class="w"> </span><span class="nv">basestring</span><span class="ss">)</span>:<span class="w"> </span>#<span class="w"> </span><span class="nv">Python</span><span class="w"> </span><span class="mi">3</span>:<span class="w"> </span><span class="nv">isinstance</span><span class="ss">(</span><span class="nv">arg</span>,<span class="w"> </span><span class="nv">str</span><span class="ss">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nv">repr</span><span class="ss">(</span><span class="nv">arg</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">try</span>:
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s1">'&lt;'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">", "</span>.<span class="nv">join</span><span class="ss">(</span><span class="nv">srepr</span><span class="ss">(</span><span class="nv">x</span><span class="ss">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">arg</span><span class="ss">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'&gt;'</span>
<span class="w">    </span><span class="nv">except</span><span class="w"> </span><span class="nv">TypeError</span>:<span class="w"> </span>#<span class="w"> </span><span class="nv">catch</span><span class="w"> </span><span class="nv">when</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">loop</span><span class="w"> </span><span class="nv">fails</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nv">repr</span><span class="ss">(</span><span class="nv">arg</span><span class="ss">)</span><span class="w"> </span>#<span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">sequence</span><span class="w"> </span><span class="nv">so</span><span class="w"> </span><span class="nv">just</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nv">repr</span>
</pre></div>

<p>This is clean and elegant, overall. But what's that <code>isinstance()</code> check doing
there? That's kind of a hack. But it is essential.</p>
<p>This function calls itself recursively on anything that acts like a list. If
we didn't handle the string specially, then it would be treated like a list,
and split up one character at a time. But then the recursive call would try to
treat each character as a list -- and it would work! Even a one-character
string works as a list! The function would keep on calling itself recursively
until stack overflow.</p>
<p>Functions like this one, that depend on each recursive call breaking down the
work to be done, have to special-case strings--because you can't break down a
string below the level of a one-character string, and even a one-character
string acts like a list.</p>
<p>Note: the <code>try</code>/<code>except</code> is the cleanest way to express our intentions. But if
this code were somehow time-critical, we might want to replace it with some
sort of test to see if <code>arg</code> is a sequence. Rather than testing the type, we
should probably test behaviors. If it has a <code>.strip()</code> method, it's a string,
so don't consider it a sequence; otherwise, if it is indexable or iterable,
it's a sequence:</p>
<div class="code"><pre class="code literal-block"><span class="nv">def</span><span class="w"> </span><span class="nv">is_sequence</span><span class="ss">(</span><span class="nv">arg</span><span class="ss">)</span>:
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ss">(</span><span class="nv">not</span><span class="w"> </span><span class="nv">hasattr</span><span class="ss">(</span><span class="nv">arg</span>,<span class="w"> </span><span class="s2">"strip"</span><span class="ss">)</span><span class="w"> </span><span class="nv">and</span>
<span class="w">            </span><span class="nv">hasattr</span><span class="ss">(</span><span class="nv">arg</span>,<span class="w"> </span><span class="s2">"__getitem__"</span><span class="ss">)</span><span class="w"> </span><span class="nv">or</span>
<span class="w">            </span><span class="nv">hasattr</span><span class="ss">(</span><span class="nv">arg</span>,<span class="w"> </span><span class="s2">"__iter__"</span><span class="ss">))</span>

<span class="nv">def</span><span class="w"> </span><span class="nv">srepr</span><span class="ss">(</span><span class="nv">arg</span><span class="ss">)</span>:
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">is_sequence</span><span class="ss">(</span><span class="nv">arg</span><span class="ss">)</span>:
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s1">'&lt;'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">", "</span>.<span class="nv">join</span><span class="ss">(</span><span class="nv">srepr</span><span class="ss">(</span><span class="nv">x</span><span class="ss">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">arg</span><span class="ss">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'&gt;'</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">repr</span><span class="ss">(</span><span class="nv">arg</span><span class="ss">)</span>
</pre></div>

<p>EDIT: I originally wrote the above with a check for <code>__getslice__()</code> but I
noticed that in the <code>collections</code> module documentation, the interesting method
is <code>__getitem__()</code>; this makes sense, that's how you index an object. That
seems more fundamental than <code>__getslice__()</code> so I changed the above.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1704.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1702.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
