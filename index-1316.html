<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1316) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1316.html">
<link rel="prev" href="index-1317.html" type="text/html">
<link rel="next" href="index-1315.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/spring-transactional-isolation-propagation/" class="u-url">Spring @Transactional - isolation, propagation</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/spring-transactional-isolation-propagation/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T06:28:16+08:00" itemprop="datePublished" title="2023-02-18 06:28">2023-02-18 06:28</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Can someone explain what <strong>isolation</strong> &amp; <strong>propagation</strong> parameters are for in
the <code>@Transactional</code> annotation via real-world example?</p>
<p>Basically when and why I should choose to change their default values.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Good question, although not a trivial one to answer.</p>
<h4>Propagation</h4>
<p>Defines how transactions relate to each other. Common options:</p>
<ul>
<li>
<code>REQUIRED</code>: Code will always run in a transaction. Creates a new transaction or reuses one if available.</li>
<li>
<code>REQUIRES_NEW</code>: Code will always run in a new transaction. Suspends the current transaction if one exists.</li>
</ul>
<p>The default value for <code>@Transactional</code> is <code>REQUIRED</code>, and this is often what
you want.</p>
<h4>Isolation</h4>
<p>Defines the data contract between transactions.</p>
<ul>
<li>
<code>ISOLATION_READ_UNCOMMITTED</code>: Allows dirty reads.</li>
<li>
<code>ISOLATION_READ_COMMITTED</code>: Does not allow dirty reads.</li>
<li>
<code>ISOLATION_REPEATABLE_READ</code>: If a row is read twice in the same transaction, the result will always be the same.</li>
<li>
<code>ISOLATION_SERIALIZABLE</code>: Performs all transactions in a sequence.</li>
</ul>
<p>The different levels have different performance characteristics in a multi-
threaded application. I think if you understand the <em>dirty reads</em> concept you
will be able to select a good option.</p>
<p>Defaults may vary between difference databases. As an example, for MariaDB it
is <code>REPEATABLE READ</code>.</p>
<hr>
<p>Example of when a dirty read can occur:</p>
<div class="code"><pre class="code literal-block">  thread 1   thread 2      
      |         |
    write(x)    |
      |         |
      |        read(x)
      |         |
    rollback    |
      v         v 
           value (x) is now dirty (incorrect)
</pre></div>

<p>So a sane default (if such can be claimed) could be
<code>ISOLATION_READ_COMMITTED</code>, which only lets you read values which have already
been committed by other running transactions, in combination with a
propagation level of <code>REQUIRED</code>. Then you can work from there if your
application has other needs.</p>
<hr>
<p>A practical example of where a new transaction will always be created when
entering the <code>provideService</code> routine and completed when leaving:</p>
<div class="code"><pre class="code literal-block"><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">FooService</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">Repository</span><span class="w"> </span><span class="n">repo1</span><span class="p">;</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">Repository</span><span class="w"> </span><span class="n">repo2</span><span class="p">;</span>

<span class="w">    </span><span class="nv">@Transactional</span><span class="p">(</span><span class="n">propagation</span><span class="o">=</span><span class="n">Propagation</span><span class="p">.</span><span class="n">REQUIRES_NEW</span><span class="p">)</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">provideService</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">repo1</span><span class="p">.</span><span class="n">retrieveFoo</span><span class="p">();</span>
<span class="w">        </span><span class="n">repo2</span><span class="p">.</span><span class="n">retrieveFoo</span><span class="p">();</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>Had we instead used <code>REQUIRED</code>, the transaction would remain open if the
transaction was already open when entering the routine. Note also that the
result of a <code>rollback</code> could be different as several executions could take
part in the same transaction.</p>
<hr>
<p>We can easily verify the behaviour with a test and see how results differ with
propagation levels:</p>
<div class="code"><pre class="code literal-block"><span class="nv">@RunWith</span><span class="p">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="p">.</span><span class="k">class</span><span class="p">)</span>
<span class="nv">@ContextConfiguration</span><span class="p">(</span><span class="n">locations</span><span class="o">=</span><span class="ss">"classpath:/fooService.xml"</span><span class="p">)</span>
<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">FooServiceTests</span><span class="w"> </span><span class="err">{</span>

<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="nv">@Autowired</span><span class="w"> </span><span class="n">TransactionManager</span><span class="w"> </span><span class="n">transactionManager</span><span class="p">;</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="nv">@Autowired</span><span class="w"> </span><span class="n">FooService</span><span class="w"> </span><span class="n">fooService</span><span class="p">;</span>

<span class="w">    </span><span class="nv">@Test</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">testProvideService</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">TransactionStatus</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transactionManager</span><span class="p">.</span><span class="n">getTransaction</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DefaultTransactionDefinition</span><span class="p">());</span>
<span class="w">        </span><span class="n">fooService</span><span class="p">.</span><span class="n">provideService</span><span class="p">();</span>
<span class="w">        </span><span class="n">transactionManager</span><span class="p">.</span><span class="k">rollback</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="n">repository</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">unchanged</span><span class="w"> </span><span class="p">...</span><span class="w"> </span>
<span class="err">}</span>
</pre></div>

<p>With a propagation level of</p>
<ul>
<li>
<p><code>REQUIRES_NEW</code>: we would expect <code>fooService.provideService()</code> was <em>NOT</em> rolled back since it created its own sub-transaction.</p>
</li>
<li>
<p><code>REQUIRED</code>: we would expect everything was rolled back and the backing store was unchanged.</p>
</li>
</ul>
<p><br></p>
<h3>Suggest</h3>
<p><strong>PROPAGATION_REQUIRED = 0</strong> ; If DataSourceTransactionObject T1 is already
started for Method M1. If for another Method M2 Transaction object is
required, no new Transaction object is created. Same object T1 is used for M2.</p>
<p><strong>PROPAGATION_MANDATORY = 2</strong> ; method must run within a transaction. If no
existing transaction is in progress, an exception will be thrown.</p>
<p><strong>PROPAGATION_REQUIRES_NEW = 3</strong> ; If DataSourceTransactionObject T1 is
already started for Method M1 and it is in progress (executing method M1). If
another method M2 start executing then T1 is suspended for the duration of
method M2 with new DataSourceTransactionObject T2 for M2. M2 run within its
own transaction context.</p>
<p><strong>PROPAGATION_NOT_SUPPORTED = 4</strong> ; If DataSourceTransactionObject T1 is
already started for Method M1. If another method M2 is run concurrently. Then
M2 should not run within transaction context. T1 is suspended till M2 is
finished.</p>
<p><strong>PROPAGATION_NEVER = 5</strong> ; None of the methods run in transaction context.</p>
<hr>
<p><strong>An isolation level:</strong> It is about how much a transaction may be impacted by
the activities of other concurrent transactions. It a supports consistency
leaving the data across many tables in a consistent state. It involves locking
rows and/or tables in a database.</p>
<p><strong>The problem with multiple transaction</strong></p>
<p><strong>Scenario 1</strong>. If T1 transaction reads data from table A1 that was written by
another concurrent transaction T2. If on the way T2 is rollback, the data
obtained by T1 is invalid one. E.g. a=2 is original data. If T1 read a=1 that
was written by T2. If T2 rollback then a=1 will be rollback to a=2 in DB. But,
now, T1 has a=1 but in DB table it is changed to a=2.</p>
<p><strong>Scenario2</strong>. If T1 transaction reads data from table A1. If another
concurrent transaction (T2) update data on table A1. Then the data that T1 has
read is different from table A1. Because T2 has updated the data on table A1.
E.g. if T1 read a=1 and T2 updated a=2. Then a!=b.</p>
<p><strong>Scenario 3</strong>. If T1 transaction reads data from table A1 with certain number
of rows. If another concurrent transaction (T2) inserts more rows on table A1.
The number of rows read by T1 is different from rows on table A1.</p>
<p>Scenario 1 is called <strong>Dirty reads.</strong></p>
<p>Scenario 2 is called <strong>Non-repeatable reads.</strong></p>
<p>Scenario 3 is called <strong>Phantom reads.</strong></p>
<p>So, isolation level is the extend to which <strong>Scenario 1, Scenario 2, Scenario
3</strong> can be prevented. You can obtain complete isolation level by implementing
locking. That is preventing concurrent reads and writes to the same data from
occurring. But it affects performance. The level of isolation depends upon
application to application how much isolation is required.</p>
<p><strong>ISOLATION_READ_UNCOMMITTED</strong> : Allows to read changes that haven’t yet been
committed. It suffer from Scenario 1, Scenario 2, Scenario 3.</p>
<p><strong>ISOLATION_READ_COMMITTED</strong> : Allows reads from concurrent transactions that
have been committed. It may suffer from Scenario 2 and Scenario 3. Because
other transactions may be updating the data.</p>
<p><strong>ISOLATION_REPEATABLE_READ</strong> : Multiple reads of the same field will yield
the same results untill it is changed by itself. It may suffer from Scenario
3. Because other transactions may be inserting the data.</p>
<p><strong>ISOLATION_SERIALIZABLE</strong> : Scenario 1, Scenario 2, Scenario 3 never happen.
It is complete isolation. It involves full locking. It affects performace
because of locking.</p>
<p>You can test using:</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">class</span><span class="w"> </span><span class="nv">TransactionBehaviour</span><span class="w"> </span>{
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="nv">set</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">either</span><span class="w"> </span><span class="nv">using</span><span class="w"> </span><span class="nv">xml</span><span class="w"> </span><span class="nv">Or</span><span class="w"> </span><span class="nv">annotation</span>
<span class="w">    </span><span class="nv">DataSourceTransactionManager</span><span class="w"> </span><span class="nv">manager</span><span class="o">=</span><span class="nv">new</span><span class="w"> </span><span class="nv">DataSourceTransactionManager</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">SimpleTransactionStatus</span><span class="w"> </span><span class="nv">status</span><span class="o">=</span><span class="nv">new</span><span class="w"> </span><span class="nv">SimpleTransactionStatus</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">   </span><span class="c1">;</span>


<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">beginTransaction</span><span class="ss">()</span>
<span class="w">    </span>{
<span class="w">        </span><span class="nv">DefaultTransactionDefinition</span><span class="w"> </span><span class="nv">Def</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">DefaultTransactionDefinition</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nv">overwrite</span><span class="w"> </span><span class="nv">default</span><span class="w"> </span><span class="nv">PROPAGATION_REQUIRED</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">ISOLATION_DEFAULT</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nv">set</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">either</span><span class="w"> </span><span class="nv">using</span><span class="w"> </span><span class="nv">xml</span><span class="w"> </span><span class="nv">Or</span><span class="w"> </span><span class="nv">annotation</span>
<span class="w">        </span><span class="nv">manager</span>.<span class="nv">setPropagationBehavior</span><span class="ss">(</span><span class="nv">XX</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span><span class="nv">manager</span>.<span class="nv">setIsolationLevelName</span><span class="ss">(</span><span class="nv">XX</span><span class="ss">)</span><span class="c1">;</span>

<span class="w">        </span><span class="nv">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">manager</span>.<span class="nv">getTransaction</span><span class="ss">(</span><span class="nv">Def</span><span class="ss">)</span><span class="c1">;</span>

<span class="w">    </span>}

<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">commitTransaction</span><span class="ss">()</span>
<span class="w">    </span>{


<span class="w">            </span><span class="k">if</span><span class="ss">(</span><span class="nv">status</span>.<span class="nv">isCompleted</span><span class="ss">())</span>{
<span class="w">                </span><span class="nv">manager</span>.<span class="nv">commit</span><span class="ss">(</span><span class="nv">status</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span>}<span class="w"> </span>
<span class="w">    </span>}

<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">rollbackTransaction</span><span class="ss">()</span>
<span class="w">    </span>{

<span class="w">            </span><span class="k">if</span><span class="ss">(</span><span class="o">!</span><span class="nv">status</span>.<span class="nv">isCompleted</span><span class="ss">())</span>{
<span class="w">                </span><span class="nv">manager</span>.<span class="nv">rollback</span><span class="ss">(</span><span class="nv">status</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">    </span>}
<span class="w">    </span><span class="nv">Main</span><span class="w"> </span><span class="nv">method</span>{
<span class="w">        </span><span class="nv">beginTransaction</span><span class="ss">()</span>
<span class="w">        </span><span class="nv">M1</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">        </span><span class="k">If</span><span class="w"> </span><span class="nv">error</span><span class="ss">()</span>{
<span class="w">            </span><span class="nv">rollbackTransaction</span><span class="ss">()</span>
<span class="w">        </span>}
<span class="w">         </span><span class="nv">commitTransaction</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span>}

}
</pre></div>

<p>You can debug and see the result with different values for isolation and
propagation.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-do-i-get-the-path-and-name-of-the-file-that-is-currently-executing/" class="u-url">How do I get the path and name of the file that is currently executing?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-do-i-get-the-path-and-name-of-the-file-that-is-currently-executing/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T06:27:50+08:00" itemprop="datePublished" title="2023-02-18 06:27">2023-02-18 06:27</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I have scripts calling other script files but I need to get the filepath of
the file that is currently running within the process.</p>
<p>For example, let's say I have three files. Using execfile:</p>
<ul>
<li>
<code>script_1.py</code> calls <code>script_2.py</code>. </li>
<li>In turn, <code>script_2.py</code> calls <code>script_3.py</code>. </li>
</ul>
<p>How can I get the file name and path of <strong><code>script_3.py</code></strong> , <em>from code
within<code>script_3.py</code></em>, without having to pass that information as arguments
from <code>script_2.py</code>?</p>
<p>(Executing <code>os.getcwd()</code> returns the original starting script's filepath not
the current file's.)</p>
<p><br><br></p>
<h2>Answer</h2>
<p>p1.py:</p>
<div class="code"><pre class="code literal-block">execfile("p2.py")
</pre></div>

<p>p2.py:</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">os</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()))</span> <span class="c1"># script filename (usually with path)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()))))</span> <span class="c1"># script directory</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>p1.py:</p>
<div class="code"><pre class="code literal-block">execfile("p2.py")
</pre></div>

<p>p2.py:</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">os</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()))</span> <span class="c1"># script filename (usually with path)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()))))</span> <span class="c1"># script directory</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/check-if-all-elements-in-a-list-are-identical/" class="u-url">Check if all elements in a list are identical</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/check-if-all-elements-in-a-list-are-identical/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T06:27:23+08:00" itemprop="datePublished" title="2023-02-18 06:27">2023-02-18 06:27</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I need a function which takes in a <code>list</code> and outputs <code>True</code> if all elements
in the input list evaluate as equal to each other using the standard equality
operator and <code>False</code> otherwise.</p>
<p>I feel it would be best to iterate through the list comparing adjacent
elements and then <code>AND</code> all the resulting Boolean values. But I'm not sure
what's the most Pythonic way to do that.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Use <code>itertools.groupby</code> (see the <code>itertools</code> recipes):</p>
<div class="code"><pre class="code literal-block"><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">groupby</span>

<span class="k">def</span> <span class="nf">all_equal</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>

<p>or without <code>groupby</code>:</p>
<div class="code"><pre class="code literal-block"><span class="nv">def</span><span class="w"> </span><span class="nv">all_equal</span><span class="ss">(</span><span class="nv">iterator</span><span class="ss">)</span>:
<span class="w">    </span><span class="nv">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">iter</span><span class="ss">(</span><span class="nv">iterator</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">try</span>:
<span class="w">        </span><span class="nv">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">next</span><span class="ss">(</span><span class="nv">iterator</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">except</span><span class="w"> </span><span class="nv">StopIteration</span>:
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nv">True</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">all</span><span class="ss">(</span><span class="nv">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">iterator</span><span class="ss">)</span>
</pre></div>

<hr>
<p>There are a number of alternative one-liners you might consider:</p>
<ol>
<li>
<p>Converting the input to a set and checking that it only has one or zero (in case the input is empty) items</p>
<div class="code"><pre class="code literal-block"><span class="nv">def</span><span class="w"> </span><span class="nv">all_equal2</span><span class="ss">(</span><span class="nv">iterator</span><span class="ss">)</span>:
<span class="k">return</span><span class="w"> </span><span class="nv">len</span><span class="ss">(</span><span class="nv">set</span><span class="ss">(</span><span class="nv">iterator</span><span class="ss">))</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span>
</pre></div>

</li>
<li>
<p>Comparing against the input list without the first item</p>
<div class="code"><pre class="code literal-block"><span class="s s-Atom">def</span> <span class="nf">all_equal3</span><span class="p">(</span><span class="s s-Atom">lst</span><span class="p">)</span><span class="o">:</span>
<span class="s s-Atom">return</span> <span class="s s-Atom">lst</span><span class="p">[</span><span class="o">:-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s s-Atom">lst</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="p">]</span>
</pre></div>

</li>
<li>
<p>Counting how many times the first item appears in the list</p>
<div class="code"><pre class="code literal-block"><span class="nv">def</span><span class="w"> </span><span class="nv">all_equal_ivo</span><span class="ss">(</span><span class="nv">lst</span><span class="ss">)</span>:
<span class="k">return</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">lst</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">lst</span>.<span class="nv">count</span><span class="ss">(</span><span class="nv">lst</span>[<span class="mi">0</span>]<span class="ss">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">len</span><span class="ss">(</span><span class="nv">lst</span><span class="ss">)</span>
</pre></div>

</li>
<li>
<p>Comparing against a list of the first element repeated</p>
<div class="code"><pre class="code literal-block"><span class="nv">def</span><span class="w"> </span><span class="nv">all_equal_6502</span><span class="ss">(</span><span class="nv">lst</span><span class="ss">)</span>:
<span class="k">return</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">lst</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span>[<span class="nv">lst</span>[<span class="mi">0</span>]]<span class="o">*</span><span class="nv">len</span><span class="ss">(</span><span class="nv">lst</span><span class="ss">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">lst</span>
</pre></div>

</li>
</ol>
<p>But they have some downsides, namely:</p>
<ol>
<li>
<code>all_equal</code> and <code>all_equal2</code> can use any iterators, but the others must take a sequence input, typically concrete containers like a list or tuple.</li>
<li>
<code>all_equal</code> and <code>all_equal3</code> stop as soon as a difference is found (what is called "short circuit"), whereas all the alternatives require iterating over the entire list, even if you can tell that the answer is <code>False</code> just by looking at the first two elements.</li>
<li>In <code>all_equal2</code> the content must be hashable. A list of lists will raise a <code>TypeError</code> for example.</li>
<li>
<code>all_equal2</code> (in the worst case) and <code>all_equal_6502</code> create a copy of the list, meaning you need to use double the memory.</li>
</ol>
<p>On Python 3.9, using <code>perfplot</code>, we get these timings (lower <code>Runtime [s]</code> is
better):</p>
<p><img alt="for a list with a difference in the first two elements, groupby is
fastest" src="images/P44QA.png"><img alt="for a list with no differences, count(l[0])
is fastest" src="images/jLwdT.png"></p>
<p><br></p>
<h3>Suggest</h3>
<p>A solution faster than using set() that works on sequences (not iterables) is
to simply count the first element. This assumes the list is non-empty (but
that's trivial to check, and decide yourself what the outcome should be on an
empty list)</p>
<div class="code"><pre class="code literal-block">x.count(x[0]) == len(x)
</pre></div>

<p>some simple benchmarks:</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; timeit.timeit('len(set(s1))&lt;=1', 's1=[1]*5000', number=10000)
1.4383411407470703
&gt;&gt;&gt; timeit.timeit('len(set(s1))&lt;=1', 's1=[1]*4999+[2]', number=10000)
1.4765670299530029
&gt;&gt;&gt; timeit.timeit('s1.count(s1[0])==len(s1)', 's1=[1]*5000', number=10000)
0.26274609565734863
&gt;&gt;&gt; timeit.timeit('s1.count(s1[0])==len(s1)', 's1=[1]*4999+[2]', number=10000)
0.25654196739196777
</pre></div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1317.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1315.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
