<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1616) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1616.html">
<link rel="prev" href="index-1617.html" type="text/html">
<link rel="next" href="index-1615.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/stopping-scripters-from-slamming-your-website/" class="u-url">Stopping scripters from slamming your website</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/stopping-scripters-from-slamming-your-website/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T05:15:33+08:00" itemprop="datePublished" title="2023-03-03 05:15">2023-03-03 05:15</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <blockquote>
<p>I've accepted an answer, but sadly, I believe we're stuck with our original
worst case scenario: <strong>CAPTCHA everyone on purchase attempts of the crap</strong>.
Short explanation: caching / web farms make it impossible to track hits, and
any workaround (sending a non-cached web-beacon, writing to a unified table,
etc.) slows the site down worse than the bots would. There is likely some
pricey hardware from Cisco or the like that can help at a high level, but
it's hard to justify the cost if CAPTCHA-ing everyone is an alternative.
I'll attempt a more full explanation later, as well as cleaning this up for
future searchers (though others are welcome to try, as it's community wiki).</p>
</blockquote>
<h3>Situation</h3>
<p>This is about the bag o' crap sales on woot.com. I'm the president of Woot
Workshop, the subsidiary of Woot that does the design, writes the product
descriptions, podcasts, blog posts, and moderates the forums. I work with
CSS/HTML and am only barely familiar with other technologies. I work closely
with the developers and have talked through all of the answers here (and many
other ideas we've had).</p>
<p>Usability is a massive part of my job, and making the site exciting and fun is
most of the rest of it. That's where the three goals below derive. CAPTCHA
harms usability, and bots steal the fun and excitement out of our crap sales.</p>
<p>Bots are slamming our front page tens of times a second screen scraping
(and/or scanning our RSS) for the Random Crap sale. The moment they see that,
it triggers a second stage of the program that logs in, clicks I want One,
fills out the form, and buys the crap.</p>
<h3>Evaluation</h3>
<blockquote>
<p>lc: On stackoverflow and other sites that use this method, they're almost
always dealing with authenticated (logged in) users, because the task being
attempted requires that.</p>
</blockquote>
<p>On Woot, anonymous (non-logged) users can view our home page. In other words,
the slamming bots can be non-authenticated (and essentially non-trackable
except by IP address).</p>
<p>So we're back to scanning for IPs, which a) is fairly useless in this age of
cloud networking and spambot zombies and b) catches too many innocents given
the number of businesses that come from one IP address (not to mention the
issues with non-static IP ISPs and potential performance hits to trying to
track this).</p>
<p>Oh, and having people call us would be the worst possible scenario. Can we
have them call you?</p>
<blockquote>
<p>BradC: Ned Batchelder's methods look pretty cool, but they're pretty firmly
designed to defeat bots built for a network of sites. Our problem is bots
are built specifically to defeat our site. Some of these methods could
likely work for a short time until the scripters evolved their bots to
ignore the honeypot, screen-scrape for nearby label names instead of form
ids, and use a javascript-capable browser control.</p>
<p>lc again: "Unless, of course, the hype is part of your marketing scheme."
Yes, it definitely is. The surprise of when the item appears, as well as the
excitement if you manage to get one is probably as much or more important
than the crap you actually end up getting. Anything that eliminates first-
come/first-serve is detrimental to the thrill of 'winning' the crap.</p>
<p>novatrust: And I, for one, welcome our new bot overlords. We actually do
offer RSSfeeds to allow 3rd party apps to scan our site for product info,
but not ahead of the main site HTML. If I'm interpreting it right, your
solution does help goal 2 (performance issues) by completely sacrificing
goal 1, and just resigning the fact that bots will be buying most of the
crap. I up-voted your response, because your last paragraph pessimism feels
accurate to me. There seems to be no silver bullet here.</p>
</blockquote>
<p>The rest of the responses generally rely on IP tracking, which, again, seems
to both be useless (with botnets/zombies/cloud networking) and detrimental
(catching many innocents who come from same-IP destinations).</p>
<p>Any other approaches / ideas? My developers keep saying "let's just do
CAPTCHA" but I'm hoping there's less intrusive methods to all actual humans
wanting some of our crap.</p>
<h3>Original question</h3>
<p>Say you're selling something cheap that has a very high perceived value, and
you have a very limited amount. No one knows exactly when you will sell this
item. And over a million people regularly come by to see what you're selling.</p>
<p>You end up with scripters and bots attempting to programmatically [a] figure
out when you're selling said item, and [b] make sure they're among the first
to buy it. This sucks for two reasons:</p>
<ol>
<li>Your site is slammed by non-humans, slowing everything down for everyone.</li>
<li>The scripters end up 'winning' the product, causing the regulars to feel cheated.</li>
</ol>
<p>A seemingly obvious solution is to create some hoops for your users to jump
through before placing their order, but there are at least three problems with
this:</p>
<ul>
<li>The user experience sucks for humans, as they have to decipher CAPTCHA, pick out the cat, or solve a math problem.</li>
<li>If the perceived benefit is high enough, and the crowd large enough, some group will find their way around any tweak, leading to an arms race. (This is especially true the simpler the tweak is; hidden 'comments' form, re-arranging the form elements, mis-labeling them, hidden 'gotcha' text all will work once and then need to be changed to fight targeting this specific form.)</li>
<li>Even if the scripters can't 'solve' your tweak it doesn't prevent them from slamming your front page, and then sounding an alarm for the scripter to fill out the order, manually. Given they get the advantage from solving [a], they will likely still win [b] since they'll be the first humans reaching the order page. Additionally, 1. still happens, causing server errors and a decreased performance for everyone.</li>
</ul>
<p>Another solution is to watch for IPs hitting too often, block them from the
firewall, or otherwise prevent them from ordering. This could solve 2. and
prevent [b] but the performance hit from scanning for IPs is massive and would
likely cause more problems like 1. than the scripters were causing on their
own. Additionally, the possibility of cloud networking and spambot zombies
makes IP checking fairly useless.</p>
<p>A third idea, forcing the order form to be loaded for some time (say, half a
second) would potentially slow the progress of the speedy orders, but again,
the scripters would still be the first people in, at any speed not detrimental
to actual users.</p>
<h3>Goals</h3>
<ol>
<li>Sell the item to non-scripting humans.</li>
<li>Keep the site running at a speed not slowed by bots.</li>
<li>Don't hassle the 'normal' users with any tasks to complete to prove they're human.</li>
</ol>
<p><br><br></p>
<h2>Answer</h2>
<p>How about implementing something like SO does with the CAPTCHAs?</p>
<p>If you're using the site normally, you'll probably never see one. If you
happen to reload the same page too often, post successive comments too
quickly, or something else that triggers an alarm, make them prove they're
human. In your case, this would probably be constant reloads of the same page,
following every link on a page quickly, or filling in an order form too fast
to be human.</p>
<p>If they fail the check x times in a row (say, 2 or 3), give that IP a timeout
or other such measure. Then at the end of the timeout, dump them back to the
check again.</p>
<hr>
<p>Since you have unregistered users accessing the site, you do have only IPs to
go on. You can issue sessions to each browser and track that way if you wish.
And, of course, throw up a human-check if too many sessions are being
(re-)created in succession (in case a bot keeps deleting the cookie).</p>
<p>As far as catching too many innocents, you can put up a disclaimer on the
human-check page: "This page may also appear if too many anonymous users are
viewing our site from the same location. We encourage you to register or login
to avoid this." (Adjust the wording appropriately.)</p>
<p>Besides, what are the odds that X people are loading the same page(s) at the
same time from one IP? If they're high, maybe you need a different trigger
mechanism for your bot alarm.</p>
<hr>
<p>Edit: Another option is if they fail too many times, and you're confident
about the product's demand, to block them and make them personally CALL you to
remove the block.</p>
<p>Having people call does seem like an asinine measure, but it <em>makes sure
there's a human somewhere behind the computer</em>. The key is to have the block
only be in place for a condition which should almost never happen unless it's
a bot (e.g. fail the check multiple times in a row). Then it FORCES human
interaction - to pick up the phone.</p>
<p>In response to the comment of having them call me, there's obviously that
tradeoff here. Are you worried enough about ensuring your users are human to
accept a couple phone calls when they go on sale? If I were so concerned about
a product getting to human users, I'd have to make this decision, perhaps
sacrificing a (small) bit of my time in the process.</p>
<p>Since it seems like you're determined to not let bots get the upper hand/slam
your site, I believe the phone may be a good option. Since I don't make a
profit off your product, I have no interest in receiving these calls. Were you
to share some of that profit, however, I may become interested. As this is
your product, you have to decide how much you care and implement accordingly.</p>
<hr>
<p>The other ways of releasing the block just aren't as effective: a timeout (but
they'd get to slam your site again after, rinse-repeat), a long timeout (if it
was really a human trying to buy your product, they'd be SOL and punished for
failing the check), email (easily done by bots), fax (same), or snail mail
(takes too long).</p>
<p>You could, of course, instead have the timeout period increase per IP for each
time they get a timeout. Just make sure you're not punishing true humans
inadvertently.</p>
<p><br></p>
<h3>Suggest</h3>
<p>You need to figure a way to make the bots buy stuff that is massively
overpriced: 12mm wingnut: $20. See how many bots snap up before the script-
writers decide you're gaming them.</p>
<p>Use the profits to buy more servers and pay for bandwidth.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/simple-tool-to-accept-theirs-or-accept-mine-on-a-whole-file-using-git/" class="u-url">Simple tool to 'accept theirs' or 'accept mine' on a whole file using git</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/simple-tool-to-accept-theirs-or-accept-mine-on-a-whole-file-using-git/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T05:15:08+08:00" itemprop="datePublished" title="2023-03-03 05:15">2023-03-03 05:15</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I don't want a visual merge tool, and I also don't want to have to vi the
conflicted file and manually choose the between HEAD (mine) and the imported
change (theirs). Most of the time I either want all of their changes or all of
mine. Commonly this is because my change made it upsteam and is coming back to
me through a pull, but may be slightly modified in various places.</p>
<p>Is there a command line tool which will get rid of the conflict markers and
choose all one way or another based on my choice? Or a set of git commands
which I can alias myself to do each one.</p>
<div class="code"><pre class="code literal-block"># accept mine
alias am="some_sequence;of;commands"
alias at="some_other_sequence;of;commands"
</pre></div>

<p>Doing this is rather annoying. For 'accept mine' I have tried:</p>
<div class="code"><pre class="code literal-block"><span class="n">randy</span><span class="nv">@sabotage</span><span class="w"> </span><span class="o">~/</span><span class="n">linus</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="k">merge</span><span class="w"> </span><span class="n">test</span><span class="o">-</span><span class="n">branch</span>
<span class="n">Auto</span><span class="o">-</span><span class="n">merging</span><span class="w"> </span><span class="n">Makefile</span>
<span class="n">CONFLICT</span><span class="w"> </span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="k">Merge</span><span class="w"> </span><span class="n">conflict</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Makefile</span>
<span class="n">Automatic</span><span class="w"> </span><span class="k">merge</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span><span class="w"> </span><span class="n">fix</span><span class="w"> </span><span class="n">conflicts</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="k">commit</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">result</span><span class="p">.</span>

<span class="n">randy</span><span class="nv">@sabotage</span><span class="w"> </span><span class="o">~/</span><span class="n">linus</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">checkout</span><span class="w"> </span><span class="n">Makefile</span><span class="w"> </span>
<span class="nl">error</span><span class="p">:</span><span class="w"> </span><span class="k">path</span><span class="w"> </span><span class="s1">'Makefile'</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">unmerged</span>

<span class="n">andy</span><span class="nv">@sabotage</span><span class="w"> </span><span class="o">~/</span><span class="n">linus</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="o">--</span><span class="n">hard</span><span class="w"> </span><span class="n">HEAD</span><span class="w"> </span><span class="n">Makefile</span><span class="w"> </span>
<span class="nl">fatal</span><span class="p">:</span><span class="w"> </span><span class="n">Cannot</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">hard</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">paths</span><span class="p">.</span>
</pre></div>

<p>How am I supposed to get rid of these change markers?</p>
<p>I can do:</p>
<div class="code"><pre class="code literal-block">git reset HEAD Makefile; rm Makefile; git checkout Makefile
</pre></div>

<p>But this seems rather round about, there must be a better way. And at this
point, I'm not sure if git even thinks the merge happened, so I don't think
this necessarily even works.</p>
<p>Going the other way, doing 'accept theirs' is equally messy. The only way I
can figure it out is do:</p>
<div class="code"><pre class="code literal-block"><span class="nt">git</span><span class="w"> </span><span class="nt">show</span><span class="w"> </span><span class="nt">test-branch</span><span class="p">:</span><span class="nd">Makefile</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nt">Makefile</span><span class="o">;</span><span class="w"> </span><span class="nt">git</span><span class="w"> </span><span class="nt">add</span><span class="w"> </span><span class="nt">Makefile</span><span class="o">;</span>
</pre></div>

<p>This also gives me a messed up commit message, which has Conflicts: Makefile
in it twice.</p>
<p>Can someone please point out how to do the above two actions in a simpler way?
Thanks</p>
<p><br><br></p>
<h2>Answer</h2>
<p>The solution is very simple. <code>git checkout &lt;filename&gt;</code> tries to check out file
from <strong>the index</strong> , and therefore fails on merge.</p>
<p>What you need to do is (i.e. checkout a <strong>commit</strong> ):</p>
<p><strong>To checkout your own version</strong> you can use <em>one</em> of:</p>
<div class="code"><pre class="code literal-block">git checkout HEAD -- &lt;filename&gt;
</pre></div>

<p>or</p>
<div class="code"><pre class="code literal-block">git checkout --ours -- &lt;filename&gt;
</pre></div>

<p>(Warning!: If you are rebasing <code>--ours</code> and <code>--theirs</code> are swapped.)</p>
<p>or</p>
<div class="code"><pre class="code literal-block"><span class="nv">git</span><span class="w"> </span><span class="k">show</span><span class="w"> </span>:<span class="mi">2</span>:<span class="o">&lt;</span><span class="nv">filename</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">filename</span><span class="o">&gt;</span><span class="w"> </span>#<span class="w"> </span><span class="ss">(</span><span class="nv">stage</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">ours</span><span class="ss">)</span>
</pre></div>

<p><strong>To checkout the other version</strong> you can use <em>one</em> of:</p>
<div class="code"><pre class="code literal-block">git checkout test-branch -- &lt;filename&gt;
</pre></div>

<p>or</p>
<div class="code"><pre class="code literal-block">git checkout --theirs -- &lt;filename&gt;
</pre></div>

<p>or</p>
<div class="code"><pre class="code literal-block"><span class="nv">git</span><span class="w"> </span><span class="k">show</span><span class="w"> </span>:<span class="mi">3</span>:<span class="o">&lt;</span><span class="nv">filename</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">filename</span><span class="o">&gt;</span><span class="w"> </span>#<span class="w"> </span><span class="ss">(</span><span class="nv">stage</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">theirs</span><span class="ss">)</span>
</pre></div>

<p>You would also need to run 'add' to mark it as resolved:</p>
<div class="code"><pre class="code literal-block">git add &lt;filename&gt;
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>Try this:</p>
<ul>
<li>To accept <strong>their</strong> changes: <code>git merge --strategy-option theirs</code>
</li>
<li>To accept <strong>your</strong> changes: <code>git merge --strategy-option ours</code>
</li>
</ul>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/aren-t-promises-just-callbacks/" class="u-url">Aren't promises just callbacks?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/aren-t-promises-just-callbacks/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T05:14:43+08:00" itemprop="datePublished" title="2023-03-03 05:14">2023-03-03 05:14</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I've been developing JavaScript for a few years and I don't understand the
fuss about promises at all.</p>
<p>It seems like all I do is change:</p>
<div class="code"><pre class="code literal-block"><span class="nv">api</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nb">result</span><span class="ss">)</span>{
<span class="w">    </span><span class="nv">api2</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">result2</span><span class="ss">)</span>{
<span class="w">        </span><span class="nv">api3</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">result3</span><span class="ss">)</span>{
<span class="w">             </span><span class="o">//</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">work</span>
<span class="w">        </span>}<span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span>}<span class="ss">)</span><span class="c1">;</span>
}<span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p>Which I could use a library like async for anyway, with something like:</p>
<div class="code"><pre class="code literal-block"><span class="nv">api</span><span class="ss">()</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nb">result</span><span class="ss">)</span>{
<span class="w">     </span><span class="nv">api2</span><span class="ss">()</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">result2</span><span class="ss">)</span>{
<span class="w">          </span><span class="nv">api3</span><span class="ss">()</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">result3</span><span class="ss">)</span>{
<span class="w">               </span><span class="o">//</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">work</span>
<span class="w">          </span>}<span class="ss">)</span><span class="c1">;</span>
<span class="w">     </span>}<span class="ss">)</span><span class="c1">;</span>
}<span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p>Which is more code and less readable. I didn't gain anything here, it's not
suddenly magically 'flat' either. Not to mention having to convert things to
promises.</p>
<p>So, what's the big fuss about promises here?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Promises are not callbacks. A promise represents the <strong>future result of an
asynchronous operation</strong>. Of course, writing them the way you do, you get
little benefit. But if you write them the way they are meant to be used, you
can write asynchronous code in a way that resembles synchronous code and is
much more easy to follow:</p>
<div class="code"><pre class="code literal-block"><span class="nv">api</span><span class="ss">()</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nb">result</span><span class="ss">)</span>{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">api2</span><span class="ss">()</span><span class="c1">;</span>
}<span class="ss">)</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">result2</span><span class="ss">)</span>{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">api3</span><span class="ss">()</span><span class="c1">;</span>
}<span class="ss">)</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">result3</span><span class="ss">)</span>{
<span class="w">     </span><span class="o">//</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">work</span>
}<span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p>Certainly, not much less code, but much more readable.</p>
<p>But this is not the end. Let's discover the true benefits: What if you wanted
to check for any error in any of the steps? It would be hell to do it with
callbacks, but with promises, is a piece of cake:</p>
<div class="code"><pre class="code literal-block"><span class="nv">api</span><span class="ss">()</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nb">result</span><span class="ss">)</span>{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">api2</span><span class="ss">()</span><span class="c1">;</span>
}<span class="ss">)</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">result2</span><span class="ss">)</span>{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">api3</span><span class="ss">()</span><span class="c1">;</span>
}<span class="ss">)</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">result3</span><span class="ss">)</span>{
<span class="w">     </span><span class="o">//</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">work</span>
}<span class="ss">)</span>.<span class="nv">catch</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">error</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">     </span><span class="o">//</span><span class="nv">handle</span><span class="w"> </span><span class="nv">any</span><span class="w"> </span><span class="nv">error</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">may</span><span class="w"> </span><span class="nv">occur</span><span class="w"> </span><span class="nv">before</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">point</span>
}<span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p>Pretty much the same as a <code>try { ... } catch</code> block.</p>
<p>Even better:</p>
<div class="code"><pre class="code literal-block"><span class="nv">api</span><span class="ss">()</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nb">result</span><span class="ss">)</span>{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">api2</span><span class="ss">()</span><span class="c1">;</span>
}<span class="ss">)</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">result2</span><span class="ss">)</span>{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">api3</span><span class="ss">()</span><span class="c1">;</span>
}<span class="ss">)</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">result3</span><span class="ss">)</span>{
<span class="w">     </span><span class="o">//</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">work</span>
}<span class="ss">)</span>.<span class="nv">catch</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">error</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">     </span><span class="o">//</span><span class="nv">handle</span><span class="w"> </span><span class="nv">any</span><span class="w"> </span><span class="nv">error</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">may</span><span class="w"> </span><span class="nv">occur</span><span class="w"> </span><span class="nv">before</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">point</span>
}<span class="ss">)</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">     </span><span class="o">//</span><span class="k">do</span><span class="w"> </span><span class="nv">something</span><span class="w"> </span><span class="nv">whether</span><span class="w"> </span><span class="nv">there</span><span class="w"> </span><span class="nv">was</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">error</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">not</span>
<span class="w">     </span><span class="o">//</span><span class="nv">like</span><span class="w"> </span><span class="nv">hiding</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">spinner</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">you</span><span class="w"> </span><span class="nv">were</span><span class="w"> </span><span class="nv">performing</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">AJAX</span><span class="w"> </span><span class="nv">request</span>.
}<span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p>And even better: What if those 3 calls to <code>api</code>, <code>api2</code>, <code>api3</code> could run
simultaneously (e.g. if they were AJAX calls) but you needed to wait for the
three? Without promises, you should have to create some sort of counter. With
promises, using the ES6 notation, is another piece of cake and pretty neat:</p>
<div class="code"><pre class="code literal-block"><span class="nv">Promise</span>.<span class="nv">all</span><span class="ss">(</span>[<span class="nv">api</span><span class="ss">()</span>,<span class="w"> </span><span class="nv">api2</span><span class="ss">()</span>,<span class="w"> </span><span class="nv">api3</span><span class="ss">()</span>]<span class="ss">)</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nb">result</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="o">//</span><span class="k">do</span><span class="w"> </span><span class="nv">work</span>.<span class="w"> </span><span class="nb">result</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">array</span><span class="w"> </span><span class="nv">contains</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">values</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">three</span><span class="w"> </span><span class="nv">fulfilled</span><span class="w"> </span><span class="nv">promises</span>.
}<span class="ss">)</span>.<span class="nv">catch</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">error</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="o">//</span><span class="nv">handle</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">error</span>.<span class="w"> </span><span class="nv">At</span><span class="w"> </span><span class="nv">least</span><span class="w"> </span><span class="nv">one</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">promises</span><span class="w"> </span><span class="nv">rejected</span>.
}<span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p>Hope you see Promises in a new light now.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Yes, Promises are asynchronous callbacks. They can't do anything that
callbacks can't do, and you face the same problems with asynchrony as with
plain callbacks.</p>
<p>However, Promises are <em>more</em> than just callbacks. They are a very mighty
abstraction, allow cleaner and better, functional code with less error-prone
boilerplate.</p>
<blockquote>
<p>So what's the main idea?</p>
</blockquote>
<p>Promises are objects representing the result of a single (asynchronous)
computation. They <em>resolve</em> to that result only once. There's a few things
what this means:</p>
<p>Promises implement an observer pattern:</p>
<ul>
<li>You don't need to know the callbacks that will use the value before the task completes. </li>
<li>Instead of expecting callbacks as arguments to your functions, you can easily <code>return</code> a Promise object</li>
<li>The promise will store the value, and you can <em>transparently</em> add a callback whenever you want. It will be called when the result is available. "Transparency" implies that when you have a promise and add a callback to it, it doesn't make a difference to your code whether the result has arrived yet - the API and contracts are the same, simplifying caching/memoisation a lot.</li>
<li>You can add multiple callbacks easily</li>
</ul>
<p>Promises are chainable ( <em>monadic</em> , if you want):</p>
<ul>
<li>If you need to transform the value that a promise represents, you <em>map</em> a transform function over the promise and get back a new promise that represents the transformed result. You cannot synchronously get the value to use it somehow, but you can easily <em>lift</em> the transformation in the promise context. No boilerplate callbacks.</li>
<li>If you want to chain two asynchronous tasks, you can use the <code>.then()</code> method. It will take a callback to be called with the first result, and returns a promise for the result of the promise that the callback returns.</li>
</ul>
<p>Sounds complicated? Time for a code example.</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api1</span><span class="p">();</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">returning</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">promise</span>
<span class="k">var</span><span class="w"> </span><span class="n">p3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p1</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">api1Result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api2</span><span class="p">();</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">returning</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">promise</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p2</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="err">…</span>
<span class="p">});</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">becomes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">p3</span>

<span class="o">//</span><span class="w"> </span><span class="n">So</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="n">whether</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">write</span>
<span class="n">api1</span><span class="p">()</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">api1Result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">api2</span><span class="p">()</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
<span class="p">})</span>
<span class="o">//</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">flattened</span><span class="w"> </span><span class="n">version</span>
<span class="n">api1</span><span class="p">()</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">api1Result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">api2</span><span class="p">();</span>
<span class="p">})</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
</pre></div>

<p>Flattening does not come magically, but you can easily do it. For your heavily
nested example, the (near) equivalent would be</p>
<div class="code"><pre class="code literal-block"><span class="nv">api1</span><span class="ss">()</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">api2</span><span class="ss">)</span>.<span class="k">then</span><span class="ss">(</span><span class="nv">api3</span><span class="ss">)</span>.<span class="k">then</span><span class="ss">(</span><span class="cm">/* do-work-callback */</span><span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p>If seeing the code of these methods helps understanding, here's a most basic
promise lib in a few lines.</p>
<blockquote>
<p>What's the big fuss about promises?</p>
</blockquote>
<p>The Promise abstraction allows much better composability of functions. For
example, next to <code>then</code> for chaining, the <code>all</code> function creates a promise for
the combined result of multiple parallel-waiting promises.</p>
<p>Last but not least Promises come with integrated error handling. The result of
the computation might be that either the promise is <em>fulfilled</em> with a value,
or it is <em>rejected</em> with a reason. All the composition functions handle this
automatically and propagate errors in promise chains, so that you don't need
to care about it explicitly everywhere - in contrast to a plain-callback
implementation. In the end, you can add a dedicated error callback for all
occurred exceptions.</p>
<blockquote>
<p>Not to mention having to convert things to promises.</p>
</blockquote>
<p>That's quite trivial actually with good promise libraries, see How do I
convert an existing callback API to promises?</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1617.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1615.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
