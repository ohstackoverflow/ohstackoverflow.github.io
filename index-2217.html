<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 2217) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-2217.html">
<link rel="prev" href="index-2218.html" type="text/html">
<link rel="next" href="index-2216.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/saving-a-numpy-array-as-an-image/" class="u-url">Saving a Numpy array as an image</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/saving-a-numpy-array-as-an-image/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T23:35:28+08:00" itemprop="datePublished" title="2023-03-03 23:35">2023-03-03 23:35</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I have a matrix in the type of a Numpy array. How would I write it to disk it
as an image? Any format works (png, jpeg, bmp...). One important constraint is
that PIL is not present.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>You can use PyPNG. It's a pure Python (no dependencies) open source PNG
encoder/decoder and it supports writing NumPy arrays as images.</p>
<p><br></p>
<h3>Suggest</h3>
<p>This uses PIL, but maybe some might find it useful:</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">scipy.misc</span>
<span class="n">scipy</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="s1">'outfile.jpg'</span><span class="p">,</span> <span class="n">image_array</span><span class="p">)</span>
</pre></div>

<p><strong>EDIT</strong> : The current <code>scipy</code> version started to normalize all images so that
min(data) become black and max(data) become white. This is unwanted if the
data should be exact grey levels or exact RGB channels. The solution:</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">scipy.misc</span>
<span class="n">scipy</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">toimage</span><span class="p">(</span><span class="n">image_array</span><span class="p">,</span> <span class="n">cmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">cmax</span><span class="o">=...</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">'outfile.jpg'</span><span class="p">)</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/what-s-the-difference-between-the-various-methods-to-get-an-android-context/" class="u-url">What's the difference between the various methods to get an Android Context?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/what-s-the-difference-between-the-various-methods-to-get-an-android-context/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T23:33:52+08:00" itemprop="datePublished" title="2023-03-03 23:33">2023-03-03 23:33</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>In various bits of Android code I've seen:</p>
<div class="code"><pre class="code literal-block"><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MyActivity</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">method</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">mContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">;</span><span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">Context</span>
<span class="w">       </span><span class="n">mContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getApplicationContext</span><span class="p">();</span>
<span class="w">       </span><span class="n">mContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getBaseContext</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>
</pre></div>

<p>However I can't find any decent explanation of which is preferable, and under
what circumstances which should be used.</p>
<p>Pointers to documentation on this, and guidance about what might break if the
wrong one is chosen, would be much appreciated.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>I agree that documentation is sparse when it comes to Contexts in Android, but
you can piece together a few facts from various sources.</p>
<p>This blog post on the official Google Android developers blog was written
mostly to help address memory leaks, but provides some good information about
contexts as well:</p>
<blockquote>
<p>In a regular Android application, you usually have two kinds of Context,
Activity and Application.</p>
</blockquote>
<p>Reading the article a little bit further tells about the difference between
the two and when you might want to consider using the application Context
(<code>Activity.getApplicationContext()</code>) rather than using the Activity context
<code>this</code>). Basically the Application context is associated with the Application
and will always be the same throughout the life cycle of your app, where as
the Activity context is associated with the activity and could possibly be
destroyed many times as the activity is destroyed during screen orientation
changes and such.</p>
<p>I couldn't find really anything about when to use getBaseContext() other than
a post from Dianne Hackborn, one of the Google engineers working on the
Android SDK:</p>
<blockquote>
<p>Don't use getBaseContext(), just use the Context you have.</p>
</blockquote>
<p>That was from a post on the android-developers newsgroup, you may want to
consider asking your question there as well, because a handful of the people
working on Android actual monitor that newsgroup and answer questions.</p>
<p>So overall it seems preferable to use the global application context when
possible.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Here's what I've found regarding the use of <code>context</code>:</p>
<p><strong>1) .</strong> Within an <code>Activity</code> itself, use <code>this</code> for inflating layouts and
menus, register context menus, instantiating widgets, start other activities,
create new <code>Intent</code> within an <code>Activity</code>, instantiating preferences, or other
methods available in an <code>Activity</code>.</p>
<p><strong>Inflate layout:</strong></p>
<div class="code"><pre class="code literal-block">View mView = this.getLayoutInflater().inflate(R.layout.myLayout, myViewGroup);
</pre></div>

<p><strong>Inflate menu:</strong></p>
<div class="code"><pre class="code literal-block"><span class="nv">@Override</span>
<span class="k">public</span><span class="w"> </span><span class="k">boolean</span><span class="w"> </span><span class="n">onCreateOptionsMenu</span><span class="p">(</span><span class="n">Menu</span><span class="w"> </span><span class="n">menu</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">super</span><span class="p">.</span><span class="n">onCreateOptionsMenu</span><span class="p">(</span><span class="n">menu</span><span class="p">);</span>
<span class="w">    </span><span class="n">this</span><span class="p">.</span><span class="n">getMenuInflater</span><span class="p">().</span><span class="n">inflate</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">menu</span><span class="p">.</span><span class="n">mymenu</span><span class="p">,</span><span class="w"> </span><span class="n">menu</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
<span class="err">}</span>
</pre></div>

<p><strong>Register context menu:</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">this</span><span class="p">.</span><span class="n">registerForContextMenu</span><span class="p">(</span><span class="n">myView</span><span class="p">);</span>
</pre></div>

<p><strong>Instantiate widget:</strong></p>
<div class="code"><pre class="code literal-block">TextView myTextView = (TextView) this.findViewById(R.id.myTextView);
</pre></div>

<p><strong>Start an<code>Activity</code>:</strong></p>
<div class="code"><pre class="code literal-block">Intent mIntent = new Intent(this, MyActivity.class);
this.startActivity(mIntent);
</pre></div>

<p><strong>Instantiate preferences:</strong></p>
<div class="code"><pre class="code literal-block">SharedPreferences mSharedPreferences = this.getPreferenceManager().getSharedPreferences();
</pre></div>

<p><strong>2) .</strong> For application-wide class, use <code>getApplicationContext()</code> as this
context exist for the lifespan of the application.</p>
<p><strong>Retrieve the name of the current Android package:</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MyApplication</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="p">{</span><span class="w">    </span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">getPackageName</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">packageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="w">        </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">PackageInfo</span><span class="w"> </span><span class="n">mPackageInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getApplicationContext</span><span class="p">()</span><span class="o">.</span><span class="n">getPackageManager</span><span class="p">()</span><span class="o">.</span><span class="n">getPackageInfo</span><span class="p">(</span><span class="n">getApplicationContext</span><span class="p">()</span><span class="o">.</span><span class="n">getPackageName</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="n">packageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mPackageInfo</span><span class="o">.</span><span class="n">packageName</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">NameNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">Log</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">here</span><span class="o">.</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">packageName</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><strong>Bind an application-wide class:</strong></p>
<div class="code"><pre class="code literal-block"><span class="nv">Intent</span><span class="w"> </span><span class="nv">mIntent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">Intent</span><span class="ss">(</span><span class="nv">this</span>,<span class="w"> </span><span class="nv">MyPersistent</span>.<span class="nv">class</span><span class="ss">)</span><span class="c1">;</span>
<span class="nv">MyServiceConnection</span><span class="w"> </span><span class="nv">mServiceConnection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">MyServiceConnection</span><span class="ss">()</span><span class="c1">;</span>
<span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">mServiceConnection</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="nv">getApplicationContext</span><span class="ss">()</span>.<span class="nv">bindService</span><span class="ss">(</span><span class="nv">mIntent</span>,<span class="w"> </span><span class="nv">mServiceConnection</span>,<span class="w"> </span><span class="nv">Context</span>.<span class="nv">BIND_AUTO_CREATE</span><span class="ss">)</span><span class="c1">;</span>
}
</pre></div>

<p><strong>3) .</strong> For Listeners and other type of Android classes (e.g.
ContentObserver), use a Context substitution like:</p>
<div class="code"><pre class="code literal-block">mContext = this;    // Example 1
mContext = context; // Example 2
</pre></div>

<p>where <code>this</code> or <code>context</code> is the context of a class (Activity, etc).</p>
<p><strong><code>Activity</code> context substitution:</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MyActivity</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">mContext</span><span class="p">;</span>
<span class="w">    </span><span class="err">@</span><span class="n">Override</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">onCreate</span><span class="p">(</span><span class="n">Bundle</span><span class="w"> </span><span class="n">savedInstanceState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">super</span><span class="o">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">);</span><span class="w">        </span>
<span class="w">        </span><span class="n">mContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><strong>Listener context substitution:</strong></p>
<div class="code"><pre class="code literal-block">public class MyLocationListener implements LocationListener {
    private Context mContext;
    public MyLocationListener(Context context) {
        mContext = context;
    }
}
</pre></div>

<p><strong><code>ContentObserver</code> context substitution:</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MyContentObserver</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">ContentObserver</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">mContext</span><span class="p">;</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">MyContentObserver</span><span class="p">(</span><span class="n">Handler</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">super</span><span class="p">(</span><span class="n">handler</span><span class="p">);</span>
<span class="w">        </span><span class="n">mContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><strong>4) .</strong> For <code>BroadcastReceiver</code> (including inlined/embedded receiver), use
the receiver's own context.</p>
<p><strong>External<code>BroadcastReceiver</code>:</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MyBroadcastReceiver</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">@</span><span class="n">Override</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">onReceive</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">final</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="o">.</span><span class="n">getAction</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">Intent</span><span class="o">.</span><span class="n">ACTION_SCREEN_OFF</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sendReceiverAction</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">sendReceiverAction</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">boolean</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Intent</span><span class="w"> </span><span class="n">mIntent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"."</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">context</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">receiver_action</span><span class="p">));</span>
<span class="w">            </span><span class="n">mIntent</span><span class="o">.</span><span class="n">putExtra</span><span class="p">(</span><span class="s2">"extra"</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>
<span class="w">            </span><span class="n">context</span><span class="o">.</span><span class="n">sendBroadcast</span><span class="p">(</span><span class="n">mIntent</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><strong>Inlined/Embedded<code>BroadcastReceiver</code>:</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MyActivity</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">mBroadcastReceiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">@</span><span class="n">Override</span>
<span class="w">        </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">onReceive</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">final</span><span class="w"> </span><span class="n">boolean</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="o">.</span><span class="n">getBooleanExtra</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">connected</span><span class="p">),</span><span class="w"> </span><span class="bp">false</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">connected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="n">something</span><span class="o">.</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>
</pre></div>

<p><strong>5) .</strong> For Services, use the service's own context.</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">MyService</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="n">mBroadcastReceiver</span><span class="p">;</span>
<span class="w">    </span><span class="err">@</span><span class="n">Override</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">super</span><span class="o">.</span><span class="n">onCreate</span><span class="p">();</span>
<span class="w">        </span><span class="n">registerReceiver</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">registerReceiver</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">IntentFilter</span><span class="w"> </span><span class="n">mIntentFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">IntentFilter</span><span class="p">();</span>
<span class="w">        </span><span class="n">mIntentFilter</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">Intent</span><span class="o">.</span><span class="n">ACTION_SCREEN_OFF</span><span class="p">);</span>
<span class="w">        </span><span class="n">this</span><span class="o">.</span><span class="n">mBroadcastReceiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MyBroadcastReceiver</span><span class="p">();</span>
<span class="w">        </span><span class="n">this</span><span class="o">.</span><span class="n">registerReceiver</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">mBroadcastReceiver</span><span class="p">,</span><span class="w"> </span><span class="n">mIntentFilter</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span>
<span class="p">}</span>
</pre></div>

<p><strong>6) .</strong> For Toasts, generally use <code>getApplicationContext()</code>, but where
possible, use the context passed from an Activity, Service, etc.</p>
<p><strong>Use context of the application:</strong></p>
<div class="code"><pre class="code literal-block"><span class="nv">Toast</span><span class="w"> </span><span class="nv">mToast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Toast</span>.<span class="nv">makeText</span><span class="ss">(</span><span class="nv">getApplicationContext</span><span class="ss">()</span>,<span class="w"> </span><span class="nv">message</span>,<span class="w"> </span><span class="nv">Toast</span>.<span class="nv">LENGTH_LONG</span><span class="ss">)</span><span class="c1">;</span>
<span class="nv">mToast</span>.<span class="k">show</span><span class="ss">()</span><span class="c1">;</span>
</pre></div>

<p><strong>Use context passed from a source:</strong></p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">static</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">showLongToast</span><span class="ss">(</span><span class="nv">Context</span><span class="w"> </span><span class="nv">context</span>,<span class="w"> </span><span class="nv">String</span><span class="w"> </span><span class="nv">message</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">context</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">message</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">        </span><span class="nv">Toast</span><span class="w"> </span><span class="nv">mToast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Toast</span>.<span class="nv">makeText</span><span class="ss">(</span><span class="nv">context</span>,<span class="w"> </span><span class="nv">message</span>,<span class="w"> </span><span class="nv">Toast</span>.<span class="nv">LENGTH_LONG</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span><span class="nv">mToast</span>.<span class="k">show</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span>}
}
</pre></div>

<p>And last, don't use <code>getBaseContext()</code> as advised by Android's framework
developers.</p>
<p><strong>UPDATE:</strong> Add examples of <code>Context</code> usage.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/do-httpclient-and-httpclienthandler-have-to-be-disposed-between-requests/" class="u-url">Do HttpClient and HttpClientHandler have to be disposed between requests?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/do-httpclient-and-httpclienthandler-have-to-be-disposed-between-requests/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T23:32:18+08:00" itemprop="datePublished" title="2023-03-03 23:32">2023-03-03 23:32</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>System.Net.Http.HttpClient and System.Net.Http.HttpClientHandler in .NET
Framework 4.5 implement IDisposable (via System.Net.Http.HttpMessageInvoker).</p>
<p>The <code>using</code> statement documentation says:</p>
<blockquote>
<p>As a rule, when you use an IDisposable object, you should declare and
instantiate it in a using statement.</p>
</blockquote>
<p>This answer uses this pattern:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">baseAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Uri</span><span class="p">(</span><span class="s2">"http://example.com"</span><span class="p">);</span>
<span class="k">var</span><span class="w"> </span><span class="n">cookieContainer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">CookieContainer</span><span class="p">();</span>
<span class="n">using</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">HttpClientHandler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">CookieContainer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cookieContainer</span><span class="w"> </span><span class="p">})</span>
<span class="n">using</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">HttpClient</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">BaseAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baseAddress</span><span class="w"> </span><span class="p">})</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">FormUrlEncodedContent</span><span class="p">(</span><span class="n">new</span><span class="p">[]</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">new</span><span class="w"> </span><span class="n">KeyValuePair</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">,</span><span class="w"> </span><span class="s2">"bar"</span><span class="p">),</span>
<span class="w">        </span><span class="n">new</span><span class="w"> </span><span class="n">KeyValuePair</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s2">"baz"</span><span class="p">,</span><span class="w"> </span><span class="s2">"bazinga"</span><span class="p">),</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="n">cookieContainer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">baseAddress</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Cookie</span><span class="p">(</span><span class="s2">"CookieName"</span><span class="p">,</span><span class="w"> </span><span class="s2">"cookie_value"</span><span class="p">));</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="o">.</span><span class="n">PostAsync</span><span class="p">(</span><span class="s2">"/test"</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">Result</span><span class="p">;</span>
<span class="w">    </span><span class="n">result</span><span class="o">.</span><span class="n">EnsureSuccessStatusCode</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>But the most visible examples from Microsoft don't call <code>Dispose()</code> either
explicitly or implicitly. For instance:</p>
<ul>
<li>The original blog article announcing the relase of HttpClient.</li>
<li>The actual MSDN documentation for HttpClient.</li>
<li>BingTranslateSample</li>
<li>GoogleMapsSample</li>
<li>WorldBankSample</li>
</ul>
<p>In the announcement's comments, someone asked the Microsoft employee:</p>
<blockquote>
<p>After checking your samples, I saw that you didn't perform the dispose
action on HttpClient instance. I have used all instances of HttpClient with
using statement on my app and I thought that it is the right way since
HttpClient implements the IDisposable interface. Am I on the right path?</p>
</blockquote>
<p>His answer was:</p>
<blockquote>
<p>In general that is correct although you have to be careful with "using" and
async as they dont' really mix in .Net 4, In .Net 4.5 you can use "await"
inside a "using" statement.</p>
<p>Btw, you can reuse the same HttpClient as many times are [as] you like so
typically you won't create/dispose them all the time.</p>
</blockquote>
<p>The second paragraph is superfluous to this question, which is not concerned
about how many times you can use an HttpClient instance, but about if it is
necessary to dispose it after you no longer need it.</p>
<p>(Update: in fact that second paragraph is the key to the answer, as provided
below by @DPeden.)</p>
<p>So my questions are:</p>
<ol>
<li>
<p>Is it necessary, given the current implementation (.NET Framework 4.5), to call Dispose() on HttpClient and HttpClientHandler instances? Clarification: by "necessary" I mean if there are any negative consequences for not disposing, such as resource leakage or data corruption risks.</p>
</li>
<li>
<p>If it's not necessary, would it be a "good practice" anyway, since they implement IDisposable?</p>
</li>
<li>
<p>If it's necessary (or recommended), is this code mentioned above implementing it safely (for .NET Framework 4.5)?</p>
</li>
<li>
<p>If these classes don't require calling Dispose(), why were they implemented as IDisposable?</p>
</li>
<li>
<p>If they require, or if it's a recommended practice, are the Microsoft examples misleading or unsafe?</p>
</li>
</ol>
<p><br><br></p>
<h2>Answer</h2>
<p>The general consensus is that you do not (should not) need to dispose of
HttpClient.</p>
<p>Many people who are intimately involved in the way it works have stated this.</p>
<p>See Darrel Miller's blog post and a related SO post: HttpClient crawling
results in memory leak for reference.</p>
<p>I'd also strongly suggest that you read the HttpClient chapter from <em>Designing
Evolvable Web APIs with ASP.NET</em> for context on what is going on under the
hood, particularly the "Lifecycle" section quoted here:</p>
<blockquote>
<p>Although HttpClient does indirectly implement the IDisposable interface, the
standard usage of HttpClient is not to dispose of it after every request.
The HttpClient object is intended to live for as long as your application
needs to make HTTP requests. Having an object exist across multiple requests
enables a place for setting DefaultRequestHeaders and prevents you from
having to re-specify things like CredentialCache and CookieContainer on
every request as was necessary with HttpWebRequest.</p>
</blockquote>
<p>Or even open up DotPeek.</p>
<p><br></p>
<h3>Suggest</h3>
<p>The current answers are a bit confusing and misleading, and they are missing
some important DNS implications. I'll try to summarize where things stand
clearly.</p>
<ol>
<li>Generally speaking most <code>IDisposable</code> objects <strong>should ideally be disposed when you are done with them</strong> , especially those that own Named/shared OS resources. <code>HttpClient</code> is no exception, since as Darrel Miller points out it allocates cancellation tokens, and request/response bodies can be unmanaged streams.</li>
<li>However, the best practice for HttpClient says you should create one instance and reuse it as much as possible (using its thread-safe members in multi-threaded scenarios). Therefore, in most scenarios <strong>you'll never dispose of it simply because you will be needing it all the time</strong>.</li>
<li>The problem with re-using the same HttpClient "forever" is that the underlying HTTP connection might remain open against the originally DNS-resolved IP, regardless of DNS changes. This can be an issue in scenarios like <strong>blue/green deployment and DNS-based failover</strong>. There are various approaches for dealing with this issue, the most reliable one involving the server sending out a <code>Connection:close</code> header after DNS changes take place. Another possibility involves recycling the <code>HttpClient</code> on the client side, either periodically or via some mechanism that learns about the DNS change. See https://github.com/dotnet/corefx/issues/11224 for more information (I suggest reading it carefully before blindly using the code suggested in the linked blog post).</li>
</ol>
</div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2218.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2216.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
