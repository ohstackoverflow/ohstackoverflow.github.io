<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1205) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1205.html">
<link rel="prev" href="index-1206.html" type="text/html">
<link rel="next" href="index-1204.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/detect-when-a-browser-receives-a-file-download/" class="u-url">Detect when a browser receives a file download</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/detect-when-a-browser-receives-a-file-download/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T03:46:15+08:00" itemprop="datePublished" title="2023-02-18 03:46">2023-02-18 03:46</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I have a page that allows the user to download a dynamically-generated file.
It takes a long time to generate, so I'd like to show a "waiting" indicator.
The problem is, I can't figure out how to detect when the browser has received
the file so that I can hide the indicator.</p>
<p>I'm requesting a hidden form, which POSTs to the server, and targets a hidden
iframe for its results. This is, so I don't replace the entire browser window
with the result. I listen for a "load" event on the iframe, hoping that it
will fire when the download is complete.</p>
<p>I return a "<code>Content-Disposition: attachment</code>" header with the file, which
causes the browser to show the "Save" dialog. But the browser doesn't fire a
"load" event in the iframe.</p>
<p>One approach I tried is using a <code>multi-part</code> response. So it would send an
empty HTML file, as well as the attached downloadable file.</p>
<p>For example:</p>
<div class="code"><pre class="code literal-block"><span class="nt">Content-type</span><span class="o">:</span><span class="w"> </span><span class="nt">multipart</span><span class="o">/</span><span class="nt">x-mixed-replace</span><span class="o">;</span><span class="nt">boundary</span><span class="o">=</span><span class="s2">"abcde"</span>

<span class="nt">--abcde</span>
<span class="nt">Content-type</span><span class="o">:</span><span class="w"> </span><span class="nt">text</span><span class="o">/</span><span class="nt">html</span>

<span class="nt">--abcde</span>
<span class="nt">Content-type</span><span class="o">:</span><span class="w"> </span><span class="nt">application</span><span class="o">/</span><span class="nt">vnd</span><span class="p">.</span><span class="nc">fdf</span>
<span class="nt">Content-Disposition</span><span class="o">:</span><span class="w"> </span><span class="nt">attachment</span><span class="o">;</span><span class="w"> </span><span class="nt">filename</span><span class="o">=</span><span class="nt">foo</span><span class="p">.</span><span class="nc">fdf</span>

<span class="nt">file-content</span>
<span class="nt">--abcde</span>
</pre></div>

<p>This works in Firefox; it receives the empty HTML file, fires the <em>"load"</em>
event, and then shows the <em>"Save"</em> dialog for the downloadable file. But it
fails on Internet Explorer and Safari; Internet Explorer fires the "load"
event, but it doesn't download the file, and <em>Safari downloads</em> the file (with
the wrong name and content-type) and doesn't fire the <em>"load"</em> event.</p>
<p>A different approach might be to call to start the file creation, poll the
server until it's ready, and then download the already-created file. But I'd
rather avoid creating temporary files on the server.</p>
<p>What should I do?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>One possible solution uses JavaScript on the client.</p>
<p>The client algorithm:</p>
<ol>
<li>Generate a random unique token.</li>
<li>Submit the download request, and include the token in a GET/POST field.</li>
<li>Show the "waiting" indicator.</li>
<li>Start a timer, and every second or so, look for a cookie named "fileDownloadToken" (or whatever you decide).</li>
<li>If the cookie exists, and its value matches the token, hide the "waiting" indicator.</li>
</ol>
<p>The server algorithm:</p>
<ol>
<li>Look for the GET/POST field in the request.</li>
<li>If it has a non-empty value, drop a cookie (e.g. "fileDownloadToken"), and set its value to the token's value.</li>
</ol>
<hr>
<p>Client source code (JavaScript):</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">getCookie</span><span class="p">(</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">var</span><span class="w"> </span><span class="n">parts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">cookie</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"="</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parts</span><span class="o">.</span><span class="n">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">parts</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">";"</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">function</span><span class="w"> </span><span class="n">expireCookie</span><span class="p">(</span><span class="w"> </span><span class="n">cName</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">document</span><span class="o">.</span><span class="n">cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">        </span><span class="n">encodeURIComponent</span><span class="p">(</span><span class="n">cName</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"=deleted; expires="</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Date</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="n">toUTCString</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">function</span><span class="w"> </span><span class="n">setCursor</span><span class="p">(</span><span class="w"> </span><span class="n">docStyle</span><span class="p">,</span><span class="w"> </span><span class="n">buttonStyle</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="w"> </span><span class="s2">"doc"</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">docStyle</span><span class="p">;</span>
<span class="w">    </span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="w"> </span><span class="s2">"button-id"</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buttonStyle</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">function</span><span class="w"> </span><span class="n">setFormToken</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">downloadToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Date</span><span class="p">()</span><span class="o">.</span><span class="n">getTime</span><span class="p">();</span>
<span class="w">    </span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="w"> </span><span class="s2">"downloadToken"</span><span class="w"> </span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">downloadToken</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">downloadToken</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">var</span><span class="w"> </span><span class="n">downloadTimer</span><span class="p">;</span>
<span class="k">var</span><span class="w"> </span><span class="n">attempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>

<span class="o">//</span><span class="w"> </span><span class="n">Prevents</span><span class="w"> </span><span class="n">double</span><span class="o">-</span><span class="n">submits</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">server</span><span class="o">.</span>
<span class="n">function</span><span class="w"> </span><span class="n">blockResubmit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">downloadToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setFormToken</span><span class="p">();</span>
<span class="w">    </span><span class="n">setCursor</span><span class="p">(</span><span class="w"> </span><span class="s2">"wait"</span><span class="p">,</span><span class="w"> </span><span class="s2">"wait"</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="n">downloadTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">window</span><span class="o">.</span><span class="n">setInterval</span><span class="p">(</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCookie</span><span class="p">(</span><span class="w"> </span><span class="s2">"downloadToken"</span><span class="w"> </span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">downloadToken</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">attempts</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">unblockSubmit</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">attempts</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="p">);</span>
<span class="p">}</span>

<span class="n">function</span><span class="w"> </span><span class="n">unblockSubmit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">setCursor</span><span class="p">(</span><span class="w"> </span><span class="s2">"auto"</span><span class="p">,</span><span class="w"> </span><span class="s2">"pointer"</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="n">window</span><span class="o">.</span><span class="n">clearInterval</span><span class="p">(</span><span class="w"> </span><span class="n">downloadTimer</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="n">expireCookie</span><span class="p">(</span><span class="w"> </span><span class="s2">"downloadToken"</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="n">attempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Example server code (PHP):</p>
<div class="code"><pre class="code literal-block"><span class="o">$</span><span class="n">TOKEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"downloadToken"</span><span class="p">;</span>

<span class="o">//</span><span class="w"> </span><span class="n">Sets</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">download</span><span class="w"> </span><span class="n">begins</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">browser</span><span class="w"> </span><span class="n">can</span>
<span class="o">//</span><span class="w"> </span><span class="n">unblock</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">submit</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="p">(</span><span class="n">thus</span><span class="w"> </span><span class="n">helping</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">prevent</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="n">clicks</span><span class="p">)</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="bp">false</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="n">allows</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">exposed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">JavaScript</span><span class="o">.</span>
<span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">setCookieToken</span><span class="p">(</span><span class="w"> </span><span class="o">$</span><span class="n">TOKEN</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">_GET</span><span class="p">[</span><span class="w"> </span><span class="o">$</span><span class="n">TOKEN</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="bp">false</span><span class="w"> </span><span class="p">);</span>

<span class="o">$</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sendFile</span><span class="p">();</span>
</pre></div>

<p>Where:</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span> <span class="n">function</span> <span class="n">setCookieToken</span>(
    <span class="nv">$cookieName</span>, <span class="nv">$cookieValue</span>, <span class="nv">$httpOnly</span> = <span class="n">true</span>, <span class="nv">$secure</span> = <span class="n">false</span> ) {

    // <span class="n">See:</span> <span class="n">http:</span>//<span class="n">stackoverflow</span>.<span class="n">com</span><span class="o">/</span><span class="n">a</span><span class="o">/</span><span class="mi">1459794</span><span class="o">/</span><span class="mi">59087</span>
    // <span class="n">See:</span> <span class="n">http:</span>//<span class="n">shiflett</span>.<span class="n">org</span><span class="o">/</span><span class="n">blog</span><span class="o">/</span><span class="mi">2006</span><span class="o">/</span><span class="n">mar</span><span class="o">/</span><span class="n">server-name-versus-http-host</span>
    // <span class="n">See:</span> <span class="n">http:</span>//<span class="n">stackoverflow</span>.<span class="n">com</span><span class="o">/</span><span class="n">a</span><span class="o">/</span><span class="mi">3290474</span><span class="o">/</span><span class="mi">59087</span>
    <span class="n">setcookie</span>(
        <span class="nv">$cookieName</span>,
        <span class="nv">$cookieValue</span>,
        <span class="mi">2147483647</span>,<span class="sr">            //</span> <span class="n">expires</span> <span class="n">January</span> <span class="mi">1</span>, <span class="mi">2038</span>
        <span class="s">"/"</span>,<span class="sr">                   //</span> <span class="n">your</span> <span class="nb">path</span>
        <span class="nv">$_SERVER</span>[<span class="s">"HTTP_HOST"</span>],<span class="sr"> //</span> <span class="n">your</span> <span class="n">domain</span>
        <span class="nv">$secure</span>,<span class="sr">               //</span> <span class="n">Use</span> <span class="n">true</span> <span class="n">over</span> <span class="n">HTTPS</span>
        <span class="nv">$httpOnly</span>              // <span class="nb">Set</span> <span class="n">true</span> <span class="k">for</span> <span class="nv">$AUTH_COOKIE_NAME</span>
    );
}
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>A very simple (and lame) one line solution is to use the <code>window.onblur()</code>
event to close the loading dialog. Of course, if it takes too long and the
user decides to do something else (like reading emails) the loading dialog
will close.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/what-is-the-most-efficient-elegant-way-to-parse-a-flat-table-into-a-tree/" class="u-url">What is the most efficient/elegant way to parse a flat table into a tree?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/what-is-the-most-efficient-elegant-way-to-parse-a-flat-table-into-a-tree/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T03:45:48+08:00" itemprop="datePublished" title="2023-02-18 03:45">2023-02-18 03:45</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Assume you have a flat table that stores an ordered tree hierarchy:</p>
<div class="code"><pre class="code literal-block">Id   Name         ParentId   Order
 1   'Node 1'            0      10
 2   'Node 1.1'          1      10
 3   'Node 2'            0      20
 4   'Node 1.1.1'        2      10
 5   'Node 2.1'          3      10
 6   'Node 1.2'          1      20
</pre></div>

<p>Here's a diagram, where we have <code>[id] Name</code>. Root node 0 is fictional.</p>
<div class="code"><pre class="code literal-block">                       [0] ROOT
                          /    \ 
              [1] Node 1          [3] Node 2
              /       \                   \
    [2] Node 1.1     [6] Node 1.2      [5] Node 2.1
          /          
 [4] Node 1.1.1
</pre></div>

<p>What minimalistic approach would you use to output that to HTML (or text, for
that matter) as a correctly ordered, correctly indented tree?</p>
<p>Assume further you only have basic data structures (arrays and hashmaps), no
fancy objects with parent/children references, no ORM, no framework, just your
two hands. The table is represented as a result set, which can be accessed
randomly.</p>
<p>Pseudo code or plain English is okay, this is purely a conceptional question.</p>
<p>Bonus question: Is there a fundamentally better way to store a tree structure
like this in a RDBMS?</p>
<hr>
<p><strong>EDITS AND ADDITIONS</strong></p>
<p>To answer one commenter's (Mark Bessey's) question: A root node is not
necessary, because it is never going to be displayed anyway. ParentId = 0 is
the convention to express "these are top level". The Order column defines how
nodes with the same parent are going to be sorted.</p>
<p>The "result set" I spoke of can be pictured as an array of hashmaps (to stay
in that terminology). For my example was meant to be already there. Some
answers go the extra mile and construct it first, but thats okay.</p>
<p>The tree can be arbitrarily deep. Each node can have N children. I did not
exactly have a "millions of entries" tree in mind, though.</p>
<p>Don't mistake my choice of node naming ('Node 1.1.1') for something to rely
on. The nodes could equally well be called 'Frank' or 'Bob', no naming
structure is implied, this was merely to make it readable.</p>
<p><em>I have posted my own solution so you guys can pull it to pieces.</em></p>
<p><br><br></p>
<h2>Answer</h2>
<p>Now that MySQL 8.0 supports recursive queries, we can say that all popular SQL
databases support recursive queries in standard syntax.</p>
<div class="code"><pre class="code literal-block">WITH RECURSIVE MyTree AS (
    SELECT * FROM MyTable WHERE ParentId IS NULL
    UNION ALL
    SELECT m.* FROM MyTABLE AS m JOIN MyTree AS t ON m.ParentId = t.Id
)
SELECT * FROM MyTree;
</pre></div>

<p>I tested recursive queries in MySQL 8.0 in my presentation Recursive Query
Throwdown in 2017.</p>
<p>Below is my original answer from 2008:</p>
<hr>
<p>There are several ways to store tree-structured data in a relational database.
What you show in your example uses two methods:</p>
<ul>
<li>
<strong>Adjacency List</strong> (the "parent" column) and</li>
<li>
<strong>Path Enumeration</strong> (the dotted-numbers in your name column).</li>
</ul>
<p>Another solution is called <strong>Nested Sets</strong> , and it can be stored in the same
table too. Read "Trees and Hierarchies in SQL for Smarties" by Joe Celko for a
lot more information on these designs.</p>
<p>I usually prefer a design called <strong>Closure Table</strong> (aka "Adjacency Relation")
for storing tree-structured data. It requires another table, but then querying
trees is pretty easy.</p>
<p>I cover Closure Table in my presentation Models for Hierarchical Data with SQL
and PHP and in my book SQL Antipatterns Volume 1: Avoiding the Pitfalls of
Database Programming.</p>
<div class="code"><pre class="code literal-block">CREATE TABLE ClosureTable (
  ancestor_id   INT NOT NULL REFERENCES FlatTable(id),
  descendant_id INT NOT NULL REFERENCES FlatTable(id),
  PRIMARY KEY (ancestor_id, descendant_id)
);
</pre></div>

<p>Store all paths in the Closure Table, where there is a direct ancestry from
one node to another. Include a row for each node to reference itself. For
example, using the data set you showed in your question:</p>
<div class="code"><pre class="code literal-block">INSERT INTO ClosureTable (ancestor_id, descendant_id) VALUES
  (1,1), (1,2), (1,4), (1,6),
  (2,2), (2,4),
  (3,3), (3,5),
  (4,4),
  (5,5),
  (6,6);
</pre></div>

<p>Now you can get a tree starting at node 1 like this:</p>
<div class="code"><pre class="code literal-block">SELECT f.* 
FROM FlatTable f 
  JOIN ClosureTable a ON (f.id = a.descendant_id)
WHERE a.ancestor_id = 1;
</pre></div>

<p>The output (in MySQL client) looks like the following:</p>
<div class="code"><pre class="code literal-block">+----+
| id |
+----+
|  1 | 
|  2 | 
|  4 | 
|  6 | 
+----+
</pre></div>

<p>In other words, nodes 3 and 5 are excluded, because they're part of a separate
hierarchy, not descending from node 1.</p>
<hr>
<p>Re: comment from e-satis about immediate children (or immediate parent). You
can add a "<code>path_length</code>" column to the <code>ClosureTable</code> to make it easier to
query specifically for an immediate child or parent (or any other distance).</p>
<div class="code"><pre class="code literal-block">INSERT INTO ClosureTable (ancestor_id, descendant_id, path_length) VALUES
  (1,1,0), (1,2,1), (1,4,2), (1,6,1),
  (2,2,0), (2,4,1),
  (3,3,0), (3,5,1),
  (4,4,0),
  (5,5,0),
  (6,6,0);
</pre></div>

<p>Then you can add a term in your search for querying the immediate children of
a given node. These are descendants whose <code>path_length</code> is 1.</p>
<div class="code"><pre class="code literal-block">SELECT f.* 
FROM FlatTable f 
  JOIN ClosureTable a ON (f.id = a.descendant_id)
WHERE a.ancestor_id = 1
  AND path_length = 1;

+----+
| id |
+----+
|  2 | 
|  6 | 
+----+
</pre></div>

<hr>
<p>Re comment from @ashraf: "How about sorting the whole tree [by name]?"</p>
<p>Here's an example query to return all nodes that are descendants of node 1,
join them to the FlatTable that contains other node attributes such as <code>name</code>,
and sort by the name.</p>
<div class="code"><pre class="code literal-block">SELECT f.name
FROM FlatTable f 
JOIN ClosureTable a ON (f.id = a.descendant_id)
WHERE a.ancestor_id = 1
ORDER BY f.name;
</pre></div>

<hr>
<p>Re comment from @Nate:</p>
<div class="code"><pre class="code literal-block">SELECT f.name, GROUP_CONCAT(b.ancestor_id order by b.path_length desc) AS breadcrumbs
FROM FlatTable f 
JOIN ClosureTable a ON (f.id = a.descendant_id) 
JOIN ClosureTable b ON (b.descendant_id = a.descendant_id) 
WHERE a.ancestor_id = 1 
GROUP BY a.descendant_id 
ORDER BY f.name

+------------+-------------+
| name       | breadcrumbs |
+------------+-------------+
| Node 1     | 1           |
| Node 1.1   | 1,2         |
| Node 1.1.1 | 1,2,4       |
| Node 1.2   | 1,6         |
+------------+-------------+
</pre></div>

<hr>
<p>A user suggested an edit today. SO moderators approved the edit, but I am
reversing it.</p>
<p>The edit suggested that the ORDER BY in the last query above should be <code>ORDER
BY b.path_length, f.name</code>, presumably to make sure the ordering matches the
hierarchy. But this doesn't work, because it would order "Node 1.1.1" after
"Node 1.2".</p>
<p>If you want the ordering to match the hierarchy in a sensible way, that is
possible, but not simply by ordering by the path length. For example, see my
answer to MySQL Closure Table hierarchical database - How to pull information
out in the correct order.</p>
<p><br></p>
<h3>Suggest</h3>
<p>If you use nested sets (sometimes referred to as Modified Pre-order Tree
Traversal) you can extract the entire tree structure or any subtree within it
in tree order with a single query, at the cost of inserts being more
expensive, as you need to manage columns which describe an in-order path
through thee tree structure.</p>
<p>For django-mptt, I used a structure like this:</p>
<div class="code"><pre class="code literal-block">id  parent_id  tree_id  level  lft  rght
--  ---------  -------  -----  ---  ----
 1       null        1      0    1    14
 2          1        1      1    2     7
 3          2        1      2    3     4
 4          2        1      2    5     6
 5          1        1      1    8    13
 6          5        1      2    9    10
 7          5        1      2    11   12
</pre></div>

<p>Which describes a tree which looks like this (with <code>id</code> representing each
item):</p>
<div class="code"><pre class="code literal-block"> 1
 +-- 2
 |   +-- 3
 |   +-- 4
 |
 +-- 5
     +-- 6
     +-- 7
</pre></div>

<p>Or, as a nested set diagram which makes it more obvious how the <code>lft</code> and
<code>rght</code> values work:</p>
<div class="code"><pre class="code literal-block"> __________________________________________________________________________
|  Root 1                                                                  |
|   ________________________________    ________________________________   |
|  |  Child 1.1                     |  |  Child 1.2                     |  |
|  |   ___________    ___________   |  |   ___________    ___________   |  |
|  |  |  C 1.1.1  |  |  C 1.1.2  |  |  |  |  C 1.2.1  |  |  C 1.2.2  |  |  |
1  2  3___________4  5___________6  7  8  9___________10 11__________12 13 14
|  |________________________________|  |________________________________|  |
|__________________________________________________________________________|
</pre></div>

<p>As you can see, to get the entire subtree for a given node, in tree order, you
simply have to select all rows which have <code>lft</code> and <code>rght</code> values between its
<code>lft</code> and <code>rght</code> values. It's also simple to retrieve the tree of ancestors
for a given node.</p>
<p>The <code>level</code> column is a bit of denormalisation for convenience more than
anything and the <code>tree_id</code> column allows you to restart the <code>lft</code> and <code>rght</code>
numbering for each top-level node, which reduces the number of columns
affected by inserts, moves and deletions, as the <code>lft</code> and <code>rght</code> columns have
to be adjusted accordingly when these operations take place in order to create
or close gaps. I made some development notes at the time when I was trying to
wrap my head around the queries required for each operation.</p>
<p>In terms of actually working with this data to display a tree, I created a
<code>tree_item_iterator</code> utility function which, for each node, should give you
sufficient information to generate whatever kind of display you want.</p>
<p>More info about MPTT:</p>
<ul>
<li>Trees in SQL</li>
<li>Storing Hierarchical Data in a Database</li>
<li>Managing Hierarchical Data in MySQL</li>
</ul>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/logout-get-or-post/" class="u-url">Logout: GET or POST?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/logout-get-or-post/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T03:45:23+08:00" itemprop="datePublished" title="2023-02-18 03:45">2023-02-18 03:45</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p><strong>This question is not about when to use GET or POST in general;</strong> it is about
which is the recommended one for handling logging out of a web application. I
have found plenty of information on the differences between GET and POST in
the general sense, but I did not find a definite answer for this particular
scenario.</p>
<p>As a pragmatist, I'm inclined to use GET, because implementing it is way
simpler than POST; just drop a simple link and you're done. This seems to be
case with the vast majority of websites I can think of, at least from the top
of my head. Even Stack Overflow handles logging out with GET.</p>
<p>The thing making me hesitate is the (albeit old) argument that some web
accelerators/proxies pre-cache pages by going and retrieving every link they
find in the page, so the user gets a faster response when she clicks on them.
I'm not sure if this still applies, but if this was the case, then in theory a
user with one of these accelerators would get kicked out of the application as
soon as she logs in, because her accelerator would find and retrieve the
logout link even if she never clicked on it.</p>
<p>Everything I have read so far suggest that <em>POST should be used for
"destructive actions", whereas actions that do not alter the internal state of
the application -like querying and such- should be handled with GET</em>. Based on
this, the real question here is:</p>
<p>Is logging out of an application considered a destructive action/does it alter
the internal state of the application?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Use <code>POST</code>.</p>
<p>In 2010, using <code>GET</code> was probably an acceptable answer. But today (in 2013),
browsers will pre-fetch pages they "think" you will visit next.</p>
<p>Here is one of the StackOverflow developers talking about this issue on
twitter:</p>
<blockquote>
<p>I'd like to thank my bank for making log off a GET request, and the Chrome
team for handy URL prefetching.- Nick Craver (@Nick_Craver) January 29, 2013</p>
</blockquote>
<p><em>fun fact: StackOverflow used to handle log-out via GET, but not anymore.</em></p>
<p><br></p>
<h3>Suggest</h3>
<p>In REST there should be no session, therefore there is nothing to destroy. A
REST client authenticates on every request. Logged in, or out, it's just an
illusion.</p>
<p>What you are really asking is should the browser continue sending the
authentication information on every request.</p>
<p>Arguably, if your application does create the illusion of being logged in,
then you should be able to to "log out" using javascript. No round trip
required.</p>
<hr>
<p>Fielding Dissertation - Section 5.1.3</p>
<blockquote>
<p>each request from client to server must contain all of the information
necessary to understand the request, and cannot take advantage of any stored
context on the server. Session state is therefore kept entirely on the
client</p>
</blockquote>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1206.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1204.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
