<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 2707) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-2707.html">
<link rel="prev" href="index-2708.html" type="text/html">
<link rel="next" href="index-2706.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/stack-smashing-detected/" class="u-url">Stack smashing detected</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/stack-smashing-detected/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T11:55:41+08:00" itemprop="datePublished" title="2023-03-05 11:55">2023-03-05 11:55</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I am executing my a.out file. After execution the program runs for some time
then exits with the message:</p>
<div class="code"><pre class="code literal-block">**** stack smashing detected ***: ./a.out terminated*
*======= Backtrace: =========*
*/lib/tls/i686/cmov/libc.so.6(__fortify_fail+0x48)Aborted*
</pre></div>

<p>What could be the possible reasons for this and how do I rectify it?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Stack Smashing here is actually caused due to a protection mechanism used by
gcc to detect buffer overflow errors. For example in the following snippet:</p>
<div class="code"><pre class="code literal-block"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">func</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="w">    </span><span class="n">gets</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">func</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>The compiler, (in this case gcc) adds protection variables (called canaries)
which have known values. An input string of size greater than 10 causes
corruption of this variable resulting in SIGABRT to terminate the program.</p>
<p>To get some insight, you can try disabling this protection of gcc using option
<code>-fno-stack-protector</code> while compiling. In that case you will get a
different error, most likely a segmentation fault as you are trying to access
an illegal memory location. Note that <code>-fstack-protector</code> should always be
turned on for release builds as it is a security feature.</p>
<p>You can get some information about the point of overflow by running the
program with a debugger. Valgrind doesn't work well with stack-related errors,
but like a debugger, it may help you pin-point the location and reason for the
crash.</p>
<p><br></p>
<h3>Suggest</h3>
<p><strong>Minimal reproduction example with disassembly analysis</strong></p>
<p>main.c</p>
<div class="code"><pre class="code literal-block"><span class="n">void</span><span class="w"> </span><span class="n">myfunc</span><span class="p">(</span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="n">const</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="nf">len</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nf">len</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">src</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>

<span class="nc">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="n">arr</span><span class="err">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'b'</span><span class="p">,</span><span class="w"> </span><span class="s1">'c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'d'</span><span class="err">}</span><span class="p">;</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="nf">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sizeof</span><span class="p">(</span><span class="n">arr</span><span class="p">);</span>
<span class="w">    </span><span class="n">myfunc</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="w"> </span><span class="nf">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Cause smashing by writing one byte too many. */</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="err">}</span>
</pre></div>

<p>GitHub upstream.</p>
<p>Compile and run:</p>
<div class="code"><pre class="code literal-block">gcc -fstack-protector-all -g -O0 -std=c99 main.c
ulimit -c unlimited &amp;&amp; rm -f core
./a.out
</pre></div>

<p>fails as desired:</p>
<div class="code"><pre class="code literal-block">*** stack smashing detected ***: terminated
Aborted (core dumped)
</pre></div>

<p>Tested on Ubuntu 20.04, GCC 10.2.0.</p>
<p>On Ubuntu 16.04, GCC 6.4.0, I could reproduce with <code>-fstack-protector</code> instead
of <code>-fstack-protector-all</code>, but it stopped blowing up when I tested on GCC
10.2.0 as per Geng Jiawen's comment. <code>man gcc</code> clarifies that as suggested by
the option name, the <code>-all</code> version adds checks more aggressively, and
therefore presumably incurs a larger performance loss:</p>
<blockquote>
<p>-fstack-protector</p>
<p>Emit extra code to check for buffer overflows, such as stack smashing
attacks. This is done by adding a guard variable to functions with
vulnerable objects. This includes functions that call "alloca", and
functions with buffers larger than or equal to 8 bytes. The guards are
initialized when a function is entered and then checked when the function
exits. If a guard check fails, an error message is printed and the program
exits. Only variables that are actually allocated on the stack are
considered, optimized away variables or variables allocated in registers
don't count.</p>
<p>-fstack-protector-all</p>
<p>Like -fstack-protector except that all functions are protected.</p>
</blockquote>
<p><strong>Disassembly</strong></p>
<p>Now we look at the disassembly:</p>
<div class="code"><pre class="code literal-block">objdump -D a.out
</pre></div>

<p>which contains:</p>
<div class="code"><pre class="code literal-block"><span class="nc">int</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="err">{</span>
<span class="w">  </span><span class="mi">400579</span><span class="err">:</span><span class="w">       </span><span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">  </span><span class="mi">40057</span><span class="nl">a</span><span class="p">:</span><span class="w">       </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span>

<span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="k">Allocate</span><span class="w"> </span><span class="mh">0x10</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="nf">space</span><span class="p">.</span>
<span class="w">  </span><span class="mi">40057</span><span class="nl">d</span><span class="p">:</span><span class="w">       </span><span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="mi">10</span><span class="w">             </span><span class="n">sub</span><span class="w">    </span><span class="err">$</span><span class="mh">0x10</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span>

<span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Put</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">canary</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">%</span><span class="nl">fs</span><span class="p">:</span><span class="mh">0x28</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="o">-</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span>
<span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nf">right</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">bottom</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">stack</span><span class="p">.</span>
<span class="w">  </span><span class="mi">400581</span><span class="err">:</span><span class="w">       </span><span class="mi">64</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">04</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="nl">fs</span><span class="p">:</span><span class="mh">0x28</span><span class="p">,</span><span class="o">%</span><span class="n">rax</span>
<span class="w">  </span><span class="mi">400588</span><span class="err">:</span><span class="w">       </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span>
<span class="w">  </span><span class="mi">40058</span><span class="nl">a</span><span class="p">:</span><span class="w">       </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="n">f8</span><span class="w">             </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>

<span class="w">  </span><span class="mi">40058</span><span class="nl">e</span><span class="p">:</span><span class="w">       </span><span class="mi">31</span><span class="w"> </span><span class="n">c0</span><span class="w">                   </span><span class="n">xor</span><span class="w">    </span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="w">    </span><span class="nc">char</span><span class="w"> </span><span class="n">arr</span><span class="err">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'b'</span><span class="p">,</span><span class="w"> </span><span class="s1">'c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'d'</span><span class="err">}</span><span class="p">;</span>
<span class="w">  </span><span class="mi">400590</span><span class="err">:</span><span class="w">       </span><span class="n">c6</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="n">f4</span><span class="w"> </span><span class="mi">61</span><span class="w">             </span><span class="n">movb</span><span class="w">   </span><span class="err">$</span><span class="mh">0x61</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
<span class="w">  </span><span class="mi">400594</span><span class="err">:</span><span class="w">       </span><span class="n">c6</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="n">f5</span><span class="w"> </span><span class="mi">62</span><span class="w">             </span><span class="n">movb</span><span class="w">   </span><span class="err">$</span><span class="mh">0x62</span><span class="p">,</span><span class="o">-</span><span class="mh">0xb</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
<span class="w">  </span><span class="mi">400598</span><span class="err">:</span><span class="w">       </span><span class="n">c6</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="n">f6</span><span class="w"> </span><span class="mi">63</span><span class="w">             </span><span class="n">movb</span><span class="w">   </span><span class="err">$</span><span class="mh">0x63</span><span class="p">,</span><span class="o">-</span><span class="mh">0xa</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
<span class="w">  </span><span class="mi">40059</span><span class="nl">c</span><span class="p">:</span><span class="w">       </span><span class="n">c6</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="n">f7</span><span class="w"> </span><span class="mi">64</span><span class="w">             </span><span class="n">movb</span><span class="w">   </span><span class="err">$</span><span class="mh">0x64</span><span class="p">,</span><span class="o">-</span><span class="mh">0x9</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="nf">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sizeof</span><span class="p">(</span><span class="n">arr</span><span class="p">);</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">a0</span><span class="p">:</span><span class="w">       </span><span class="n">c7</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="n">f0</span><span class="w"> </span><span class="mi">04</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">movl</span><span class="w">   </span><span class="err">$</span><span class="mh">0x4</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
<span class="w">    </span><span class="n">myfunc</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="w"> </span><span class="nf">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">a7</span><span class="p">:</span><span class="w">       </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="n">f0</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">aa</span><span class="p">:</span><span class="w">       </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="mi">01</span><span class="w">                </span><span class="n">lea</span><span class="w">    </span><span class="mh">0x1</span><span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">),</span><span class="o">%</span><span class="n">edx</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">ad</span><span class="p">:</span><span class="w">       </span><span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="n">f4</span><span class="w">             </span><span class="n">lea</span><span class="w">    </span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span><span class="o">%</span><span class="n">rax</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">b1</span><span class="p">:</span><span class="w">       </span><span class="mi">89</span><span class="w"> </span><span class="n">d6</span><span class="w">                   </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="o">%</span><span class="n">esi</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">b3</span><span class="p">:</span><span class="w">       </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">c7</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="o">%</span><span class="n">rdi</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">b6</span><span class="p">:</span><span class="w">       </span><span class="n">e8</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">          </span><span class="n">callq</span><span class="w">  </span><span class="mi">400546</span><span class="w"> </span><span class="o">&lt;</span><span class="n">myfunc</span><span class="o">&gt;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">bb</span><span class="p">:</span><span class="w">       </span><span class="n">b8</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">          </span><span class="n">mov</span><span class="w">    </span><span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="err">}</span>



<span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="k">Check</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">canary</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="o">-</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span><span class="w"> </span><span class="n">hasn</span><span class="err">'</span><span class="n">t</span><span class="w"> </span><span class="n">changed</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="n">calling</span><span class="w"> </span><span class="n">myfunc</span><span class="p">.</span>
<span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">has</span><span class="p">,</span><span class="w"> </span><span class="n">jump</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">__stack_chk_fail</span><span class="p">.</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">c0</span><span class="p">:</span><span class="w">       </span><span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">b</span><span class="w"> </span><span class="mi">4</span><span class="n">d</span><span class="w"> </span><span class="n">f8</span><span class="w">             </span><span class="n">mov</span><span class="w">    </span><span class="o">-</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span><span class="o">%</span><span class="n">rcx</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">c4</span><span class="p">:</span><span class="w">       </span><span class="mi">64</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="mi">33</span><span class="w"> </span><span class="mi">0</span><span class="n">c</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">xor</span><span class="w">    </span><span class="o">%</span><span class="nl">fs</span><span class="p">:</span><span class="mh">0x28</span><span class="p">,</span><span class="o">%</span><span class="n">rcx</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">cb</span><span class="p">:</span><span class="w">       </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">cd</span><span class="p">:</span><span class="w">       </span><span class="mi">74</span><span class="w"> </span><span class="mi">05</span><span class="w">                   </span><span class="n">je</span><span class="w">     </span><span class="mi">4005</span><span class="n">d4</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x5b</span><span class="o">&gt;</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">cf</span><span class="p">:</span><span class="w">       </span><span class="n">e8</span><span class="w"> </span><span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="n">fe</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">          </span><span class="n">callq</span><span class="w">  </span><span class="mi">400420</span><span class="w"> </span><span class="o">&lt;</span><span class="n">__stack_chk_fail</span><span class="nv">@plt</span><span class="o">&gt;</span>

<span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Otherwise</span><span class="p">,</span><span class="w"> </span><span class="k">exit</span><span class="w"> </span><span class="n">normally</span><span class="p">.</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">d4</span><span class="p">:</span><span class="w">       </span><span class="n">c9</span><span class="w">                      </span><span class="n">leaveq</span><span class="w"> </span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">d5</span><span class="p">:</span><span class="w">       </span><span class="n">c3</span><span class="w">                      </span><span class="n">retq</span><span class="w">   </span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">d6</span><span class="p">:</span><span class="w">       </span><span class="mi">66</span><span class="w"> </span><span class="mi">2</span><span class="n">e</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">1</span><span class="n">f</span><span class="w"> </span><span class="mi">84</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">    </span><span class="n">nopw</span><span class="w">   </span><span class="o">%</span><span class="nl">cs</span><span class="p">:</span><span class="mh">0x0</span><span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="mi">4005</span><span class="nl">dd</span><span class="p">:</span><span class="w">       </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span>
</pre></div>

<p>Notice the handy comments automatically added by <code>objdump</code>'s artificial
intelligence module.</p>
<p>If you run this program multiple times through GDB, you will see that:</p>
<ul>
<li>the canary gets a different random value every time</li>
<li>the last loop of <code>myfunc</code> is exactly what modifies the address of the canary</li>
</ul>
<p>The canary randomized by setting it with <code>%fs:0x28</code>, which contains a random
value as explained at:</p>
<ul>
<li>https://unix.stackexchange.com/questions/453749/what-sets-fs0x28-stack-canary</li>
<li>Why does this memory address %fs:0x28 ( fs[0x28] ) have a random value?</li>
</ul>
<p><strong>Debug attempts</strong></p>
<p>From now on, we modify the code:</p>
<div class="code"><pre class="code literal-block">    myfunc(arr, len + 1);
</pre></div>

<p>to be instead:</p>
<div class="code"><pre class="code literal-block">    myfunc(arr, len);
    myfunc(arr, len + 1); /* line 12 */
    myfunc(arr, len);
</pre></div>

<p>to be more interesting.</p>
<p>We will then try to see if we can pinpoint the culprit <code>+ 1</code> call with a
method more automated than just reading and understanding the entire source
code.</p>
<p><strong><code>gcc -fsanitize=address</code> to enable Google's Address Sanitizer (ASan)</strong></p>
<p>If you recompile with this flag and run the program, it outputs:</p>
<div class="code"><pre class="code literal-block"><span class="c1">#0 0x4008bf in myfunc /home/ciro/test/main.c:4</span>
<span class="c1">#1 0x40099b in main /home/ciro/test/main.c:12</span>
<span class="c1">#2 0x7fcd2e13d82f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)</span>
<span class="c1">#3 0x400798 in _start (/home/ciro/test/a.out+0x40079</span>
</pre></div>

<p>followed by some more colored output.</p>
<p>This clearly pinpoints the problematic line 12.</p>
<p>The source code for this is at: https://github.com/google/sanitizers but as we
saw from the example it is already upstreamed into GCC.</p>
<p>ASan can also detect other memory problems such as memory leaks: How to find
memory leak in a C++ code/project?</p>
<p><strong>Valgrind SGCheck</strong></p>
<p>As mentioned by others, Valgrind is not good at solving this kind of problem.</p>
<p>It does have an experimental tool called SGCheck:</p>
<blockquote>
<p>SGCheck is a tool for finding overruns of stack and global arrays. It works
by using a heuristic approach derived from an observation about the likely
forms of stack and global array accesses.</p>
</blockquote>
<p>So I was not very surprised when it did not find the error:</p>
<div class="code"><pre class="code literal-block"><span class="n">valgrind</span><span class="w"> </span><span class="o">--</span><span class="k">tool</span><span class="o">=</span><span class="nb">exp</span><span class="o">-</span><span class="n">sgcheck</span><span class="w"> </span><span class="o">./</span><span class="n">a</span><span class="o">.</span><span class="n">out</span>
</pre></div>

<p>The error message should look like this apparently: Valgrind missing error</p>
<p><strong>GDB</strong></p>
<p>An important observation is that if you run the program through GDB, or
examine the <code>core</code> file after the fact:</p>
<div class="code"><pre class="code literal-block">gdb -nh -q a.out core
</pre></div>

<p>then, as we saw on the assembly, GDB should point you to the end of the
function that did the canary check:</p>
<div class="code"><pre class="code literal-block"><span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">bt</span>
<span class="n">#0</span><span class="w">  </span><span class="mh">0x00007f0f66e20428</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__GI_raise</span><span class="w"> </span><span class="p">(</span><span class="n">sig</span><span class="o">=</span><span class="n">sig</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">raise</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">54</span>
<span class="n">#1</span><span class="w">  </span><span class="mh">0x00007f0f66e2202a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__GI_abort</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">abort</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">89</span>
<span class="n">#2</span><span class="w">  </span><span class="mh">0x00007f0f66e627ea</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__libc_message</span><span class="w"> </span><span class="p">(</span><span class="n">do_abort</span><span class="o">=</span><span class="n">do_abort</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="nv">@entry</span><span class="o">=</span><span class="mh">0x7f0f66f7a49f</span><span class="w"> </span><span class="ss">"*** %s ***: %s terminated\n"</span><span class="p">)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">posix</span><span class="o">/</span><span class="n">libc_fatal</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">175</span>
<span class="n">#3</span><span class="w">  </span><span class="mh">0x00007f0f66f0415c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__GI___fortify_fail</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="o">=&lt;</span><span class="n">optimized</span><span class="w"> </span><span class="k">out</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="nv">@entry</span><span class="o">=</span><span class="mh">0x7f0f66f7a481</span><span class="w"> </span><span class="ss">"stack smashing detected"</span><span class="p">)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">fortify_fail</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">37</span>
<span class="n">#4</span><span class="w">  </span><span class="mh">0x00007f0f66f04100</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__stack_chk_fail</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">stack_chk_fail</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">28</span>
<span class="n">#5</span><span class="w">  </span><span class="mh">0x00000000004005f6</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">15</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="mi">5</span>
<span class="n">#5</span><span class="w">  </span><span class="mh">0x00000000004005f6</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">15</span>
<span class="mi">15</span><span class="w">      </span><span class="err">}</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span>
</pre></div>

<p>And therefore the problem is likely in one of the calls that this function
made.</p>
<p>Next we try to pinpoint the exact failing call by first single stepping up
just after the canary is set:</p>
<div class="code"><pre class="code literal-block">  400581:       64 48 8b 04 25 28 00    mov    %fs:0x28,%rax
  400588:       00 00 
  40058a:       48 89 45 f8             mov    %rax,-0x8(%rbp)
</pre></div>

<p>and watching the address:</p>
<div class="code"><pre class="code literal-block"><span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">$</span><span class="n">rbp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x8</span>
<span class="o">$</span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="mh">0x7fffffffcf18</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">watch</span><span class="w"> </span><span class="mh">0x7fffffffcf18</span>
<span class="n">Hardware</span><span class="w"> </span><span class="n">watchpoint</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="mh">0x7fffffffcf18</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">c</span>
<span class="n">Continuing</span><span class="o">.</span>

<span class="n">Hardware</span><span class="w"> </span><span class="n">watchpoint</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="mh">0x7fffffffcf18</span>

<span class="n">Old</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1800814336</span>
<span class="n">New</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1800814378</span>
<span class="n">myfunc</span><span class="w"> </span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="mh">0x7fffffffcf14</span><span class="w"> </span><span class="s2">"*****?Vk</span><span class="se">\266</span><span class="s2">"</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="n">incomplete</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span>\<span class="mi">355</span>\<span class="mi">216</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">3</span>
<span class="mi">3</span><span class="w">           </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">len</span>
<span class="o">$</span><span class="mi">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">i</span>
<span class="o">$</span><span class="mi">3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">bt</span>
<span class="c1">#0  myfunc (src=0x7fffffffcf14 "*****?Vk\266", &lt;incomplete sequence \355\216&gt;, len=5) at main.c:3</span>
<span class="c1">#1  0x00000000004005cc in main () at main.c:12</span>
</pre></div>

<p>Now, this does leaves us at the right offending instruction: <code>len = 5</code> and <code>i
= 4</code>, and in this particular case, did point us to the culprit line 12.</p>
<p>However, the backtrace is corrupted, and contains some trash. A correct
backtrace would look like:</p>
<div class="code"><pre class="code literal-block"><span class="c1">#0  myfunc (src=0x7fffffffcf14 "abcd", len=4) at main.c:3</span>
<span class="c1">#1  0x00000000004005b8 in main () at main.c:11</span>
</pre></div>

<p>so maybe this could corrupt the stack and prevent you from seeing the trace.</p>
<p>Also, this method requires knowing what is the last call of the canary
checking function otherwise you will have false positives, which will not
always be feasible, unless you use reverse debugging.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/javascript-setting-location-href-versus-location/" class="u-url">JavaScript: Setting location.href versus location</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/javascript-setting-location-href-versus-location/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T11:54:25+08:00" itemprop="datePublished" title="2023-03-05 11:54">2023-03-05 11:54</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>When would you set <code>location</code> to a URL string versus setting <code>location.href</code>?</p>
<div class="code"><pre class="code literal-block"><span class="nt">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"http://www.stackoverflow.com"</span><span class="o">;</span>
</pre></div>

<p>vs</p>
<div class="code"><pre class="code literal-block"><span class="nt">location</span><span class="p">.</span><span class="nc">href</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"http://www.stackoverflow.com"</span><span class="o">;</span>
</pre></div>

<p>Mozilla Developer Network Reference</p>
<p><br><br></p>
<h2>Answer</h2>
<p>You might set <code>location</code> directly because it's slightly shorter. If you're
trying to be terse, you can usually omit the <code>window.</code> too.</p>
<p>URL assignments to both <code>location.href</code> and <code>location</code> are defined to work in
JavaScript 1.0, back in Netscape 2, and have been implemented in every browser
since. So take your pick and use whichever you find clearest.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Even if both work, I would use the latter.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/sibling-package-imports/" class="u-url">Sibling package imports</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/sibling-package-imports/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T11:52:53+08:00" itemprop="datePublished" title="2023-03-05 11:52">2023-03-05 11:52</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I've tried reading through questions about sibling imports and even the
package documentation, but I've yet to find an answer.</p>
<p>With the following structure:</p>
<div class="code"><pre class="code literal-block">├── LICENSE.md
├── README.md
├── api
│   ├── __init__.py
│   ├── api.py
│   └── api_key.py
├── examples
│   ├── __init__.py
│   ├── example_one.py
│   └── example_two.py
└── tests
│   ├── __init__.py
│   └── test_one.py
</pre></div>

<p>How can the scripts in the <code>examples</code> and <code>tests</code> directories import from the
<code>api</code> module and be run from the commandline?</p>
<p>Also, I'd like to avoid the ugly <code>sys.path.insert</code> hack for every file. Surely
this can be done in Python, right?</p>
<p><br><br></p>
<h2>Answer</h2>
<h3>Seven years after</h3>
<p>Since I wrote the answer below, modifying <code>sys.path</code> is still a quick-and-
dirty trick that works well for private scripts, but there has been several
improvements</p>
<ul>
<li>Installing the package (in a virtualenv or not) will give you what you want, though I would suggest using pip to do it rather than using setuptools directly (and using <code>setup.cfg</code> to store the metadata)</li>
<li>Using the <code>-m</code> flag and running as a package works too (but will turn out a bit awkward if you want to convert your working directory into an installable package).</li>
<li>For the tests, specifically, pytest is able to find the api package in this situation and takes care of the <code>sys.path</code> hacks for you</li>
</ul>
<p>So it really depends on what you want to do. In your case, though, since it
seems that your goal is to make a proper package at some point, installing
through <code>pip -e</code> is probably your best bet, even if it is not perfect yet.</p>
<h3>Old answer</h3>
<p>As already stated elsewhere, the awful truth is that you have to do ugly hacks
to allow imports from siblings modules or parents package from a <code>__main__</code>
module. The issue is detailed in PEP 366. PEP 3122 attempted to handle imports
in a more rational way but Guido has rejected it one the account of</p>
<blockquote>
<p>The only use case seems to be running scripts that happen to be living
inside a module's directory, which I've always seen as an antipattern.</p>
</blockquote>
<p>(here)</p>
<p>Though, I use this pattern on a regular basis with</p>
<div class="code"><pre class="code literal-block"><span class="c1"># Ugly hack to allow absolute import from the root folder</span>
<span class="c1"># whatever its name is. Please forgive the heresy.</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span> <span class="ow">and</span> <span class="n">__package__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">path</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">dirname</span> <span class="k">as</span> <span class="nb">dir</span>

    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">__package__</span> <span class="o">=</span> <span class="s2">"examples"</span>

<span class="kn">import</span> <span class="nn">api</span>
</pre></div>

<p>Here <code>path[0]</code> is your running script's parent folder and <code>dir(path[0])</code> your
top level folder.</p>
<p>I have still not been able to use relative imports with this, though, but it
does allow absolute imports from the top level (in your example <code>api</code>'s parent
folder).</p>
<p><br></p>
<h3>Suggest</h3>
<h3>Seven years after</h3>
<p>Since I wrote the answer below, modifying <code>sys.path</code> is still a quick-and-
dirty trick that works well for private scripts, but there has been several
improvements</p>
<ul>
<li>Installing the package (in a virtualenv or not) will give you what you want, though I would suggest using pip to do it rather than using setuptools directly (and using <code>setup.cfg</code> to store the metadata)</li>
<li>Using the <code>-m</code> flag and running as a package works too (but will turn out a bit awkward if you want to convert your working directory into an installable package).</li>
<li>For the tests, specifically, pytest is able to find the api package in this situation and takes care of the <code>sys.path</code> hacks for you</li>
</ul>
<p>So it really depends on what you want to do. In your case, though, since it
seems that your goal is to make a proper package at some point, installing
through <code>pip -e</code> is probably your best bet, even if it is not perfect yet.</p>
<h3>Old answer</h3>
<p>As already stated elsewhere, the awful truth is that you have to do ugly hacks
to allow imports from siblings modules or parents package from a <code>__main__</code>
module. The issue is detailed in PEP 366. PEP 3122 attempted to handle imports
in a more rational way but Guido has rejected it one the account of</p>
<blockquote>
<p>The only use case seems to be running scripts that happen to be living
inside a module's directory, which I've always seen as an antipattern.</p>
</blockquote>
<p>(here)</p>
<p>Though, I use this pattern on a regular basis with</p>
<div class="code"><pre class="code literal-block"><span class="c1"># Ugly hack to allow absolute import from the root folder</span>
<span class="c1"># whatever its name is. Please forgive the heresy.</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span> <span class="ow">and</span> <span class="n">__package__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">path</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">dirname</span> <span class="k">as</span> <span class="nb">dir</span>

    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">__package__</span> <span class="o">=</span> <span class="s2">"examples"</span>

<span class="kn">import</span> <span class="nn">api</span>
</pre></div>

<p>Here <code>path[0]</code> is your running script's parent folder and <code>dir(path[0])</code> your
top level folder.</p>
<p>I have still not been able to use relative imports with this, though, but it
does allow absolute imports from the top level (in your example <code>api</code>'s parent
folder).</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2708.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2706.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
