<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 511) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-511.html">
<link rel="prev" href="index-512.html" type="text/html">
<link rel="next" href="index-510.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/string-representation-of-an-enum/" class="u-url">String representation of an Enum</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/string-representation-of-an-enum/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T08:43:45+08:00" itemprop="datePublished" title="2023-02-17 08:43">2023-02-17 08:43</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I have the following enumeration:</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">AuthenticationMethod</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">FORMS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">WINDOWSAUTHENTICATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="n">SINGLESIGNON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="p">}</span>
</pre></div>

<p>The problem however is that I need the word "FORMS" when I ask for
AuthenticationMethod.FORMS and not the id 1.</p>
<p>I have found the following solution for this problem (link):</p>
<p>First I need to create a custom attribute called "StringValue":</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">class</span><span class="w"> </span><span class="nv">StringValue</span><span class="w"> </span>:<span class="w"> </span><span class="nv">System</span>.<span class="nv">Attribute</span>
{
<span class="w">    </span><span class="nv">private</span><span class="w"> </span><span class="nv">readonly</span><span class="w"> </span><span class="nv">string</span><span class="w"> </span><span class="nv">_value</span><span class="c1">;</span>

<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">StringValue</span><span class="ss">(</span><span class="nv">string</span><span class="w"> </span><span class="nv">value</span><span class="ss">)</span>
<span class="w">    </span>{
<span class="w">        </span><span class="nv">_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">value</span><span class="c1">;</span>
<span class="w">    </span>}

<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">string</span><span class="w"> </span><span class="nv">Value</span>
<span class="w">    </span>{
<span class="w">        </span><span class="nv">get</span><span class="w"> </span>{<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nv">_value</span><span class="c1">; }</span>
<span class="w">    </span>}

}
</pre></div>

<p>Then I can add this attribute to my enumerator:</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">AuthenticationMethod</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">[</span><span class="n">StringValue</span><span class="p">(</span><span class="s2">"FORMS"</span><span class="p">)]</span>
<span class="w">    </span><span class="n">FORMS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">StringValue</span><span class="p">(</span><span class="s2">"WINDOWS"</span><span class="p">)]</span>
<span class="w">    </span><span class="n">WINDOWSAUTHENTICATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">StringValue</span><span class="p">(</span><span class="s2">"SSO"</span><span class="p">)]</span>
<span class="w">    </span><span class="n">SINGLESIGNON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="p">}</span>
</pre></div>

<p>And of course I need something to retrieve that StringValue:</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">static</span><span class="w"> </span><span class="nv">class</span><span class="w"> </span><span class="nv">StringEnum</span>
{
<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">static</span><span class="w"> </span><span class="nv">string</span><span class="w"> </span><span class="nv">GetStringValue</span><span class="ss">(</span><span class="nv">Enum</span><span class="w"> </span><span class="nv">value</span><span class="ss">)</span>
<span class="w">    </span>{
<span class="w">        </span><span class="nv">string</span><span class="w"> </span><span class="nv">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">null</span><span class="c1">;</span>
<span class="w">        </span><span class="nv">Type</span><span class="w"> </span><span class="nv">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">value</span>.<span class="nv">GetType</span><span class="ss">()</span><span class="c1">;</span>

<span class="w">        </span><span class="o">//</span><span class="nv">Check</span><span class="w"> </span><span class="nv">first</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">our</span><span class="w"> </span><span class="nv">cached</span><span class="w"> </span><span class="nv">results</span>...

<span class="w">        </span><span class="o">//</span><span class="nv">Look</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">our</span><span class="w"> </span><span class="s1">'StringValueAttribute'</span>

<span class="w">        </span><span class="o">//</span><span class="nv">in</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">field</span><span class="err">'s custom attributes</span>

<span class="err">        FieldInfo fi = type.GetField(value.ToString());</span>
<span class="err">        StringValue[] attrs =</span>
<span class="err">           fi.GetCustomAttributes(typeof(StringValue),</span>
<span class="err">                                   false) as StringValue[];</span>
<span class="err">        if (attrs.Length &gt; 0)</span>
<span class="err">        {</span>
<span class="err">            output = attrs[0].Value;</span>
<span class="err">        }</span>

<span class="err">        return output;</span>
<span class="err">    }</span>
<span class="err">}</span>
</pre></div>

<p>Good now I've got the tools to get a string value for an enumerator. I can
then use it like this:</p>
<div class="code"><pre class="code literal-block">string valueOfAuthenticationMethod = StringEnum.GetStringValue(AuthenticationMethod.FORMS);
</pre></div>

<p>Okay now all of these work like a charm but I find it a whole lot of work. I
was wondering if there is a better solution for this.</p>
<p>I also tried something with a dictionary and static properties but that wasn't
better either.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Try type-safe-enum pattern.</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">sealed</span><span class="w"> </span><span class="nv">class</span><span class="w"> </span><span class="nv">AuthenticationMethod</span><span class="w"> </span>{

<span class="w">    </span><span class="nv">private</span><span class="w"> </span><span class="nv">readonly</span><span class="w"> </span><span class="nv">String</span><span class="w"> </span><span class="nv">name</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">private</span><span class="w"> </span><span class="nv">readonly</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">value</span><span class="c1">;</span>

<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">static</span><span class="w"> </span><span class="nv">readonly</span><span class="w"> </span><span class="nv">AuthenticationMethod</span><span class="w"> </span><span class="nv">FORMS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">AuthenticationMethod</span><span class="w"> </span><span class="ss">(</span><span class="mi">1</span>,<span class="w"> </span><span class="s2">"FORMS"</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">static</span><span class="w"> </span><span class="nv">readonly</span><span class="w"> </span><span class="nv">AuthenticationMethod</span><span class="w"> </span><span class="nv">WINDOWSAUTHENTICATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">AuthenticationMethod</span><span class="w"> </span><span class="ss">(</span><span class="mi">2</span>,<span class="w"> </span><span class="s2">"WINDOWS"</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">static</span><span class="w"> </span><span class="nv">readonly</span><span class="w"> </span><span class="nv">AuthenticationMethod</span><span class="w"> </span><span class="nv">SINGLESIGNON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">AuthenticationMethod</span><span class="w"> </span><span class="ss">(</span><span class="mi">3</span>,<span class="w"> </span><span class="s2">"SSN"</span><span class="ss">)</span><span class="c1">;</span>

<span class="w">    </span><span class="nv">private</span><span class="w"> </span><span class="nv">AuthenticationMethod</span><span class="ss">(</span><span class="nv">int</span><span class="w"> </span><span class="nv">value</span>,<span class="w"> </span><span class="nv">String</span><span class="w"> </span><span class="nv">name</span><span class="ss">)</span>{
<span class="w">        </span><span class="nv">this</span>.<span class="nv">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">name</span><span class="c1">;</span>
<span class="w">        </span><span class="nv">this</span>.<span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">value</span><span class="c1">;</span>
<span class="w">    </span>}

<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">override</span><span class="w"> </span><span class="nv">String</span><span class="w"> </span><span class="nv">ToString</span><span class="ss">()</span>{
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nv">name</span><span class="c1">;</span>
<span class="w">    </span>}

}
</pre></div>

<hr>
<p><strong>Update</strong> Explicit (or implicit) type conversion can be done by</p>
<ul>
<li>
<p>adding static field with mapping</p>
<div class="code"><pre class="code literal-block">private static readonly Dictionary&lt;string, AuthenticationMethod&gt; instance = new Dictionary&lt;string,AuthenticationMethod&gt;();
</pre></div>

<ul>
<li>n.b. In order that the initialisation of the the "enum member" fields doesn't throw a NullReferenceException when calling the instance constructor, be sure to put the Dictionary field before the "enum member" fields in your class. This is because static field initialisers are called in declaration order, and before the static constructor, creating the weird and necessary but confusing situation that the instance constructor can be called before all static fields have been initialised, and before the static constructor is called.</li>
<li>
<p>filling this mapping in instance constructor</p>
<p>instance[name] = this;</p>
</li>
</ul>
</li>
<li>
<p>and adding user-defined type conversion operator</p>
<div class="code"><pre class="code literal-block">public static explicit operator AuthenticationMethod(string str)
</pre></div>

<p>{
    AuthenticationMethod result;
    if (instance.TryGetValue(str, out result))
        return result;
    else
        throw new InvalidCastException();
}</p>
</li>
</ul>
<p><br></p>
<h3>Suggest</h3>
<p>Use method</p>
<div class="code"><pre class="code literal-block"><span class="n">Enum</span><span class="o">.</span><span class="n">GetName</span><span class="p">(</span><span class="n">Type</span><span class="w"> </span><span class="n">MyEnumType</span><span class="p">,</span><span class="w">  </span><span class="n">object</span><span class="w"> </span><span class="n">enumvariable</span><span class="p">)</span>
</pre></div>

<p>as in (Assume <code>Shipper</code> is a defined Enum)</p>
<div class="code"><pre class="code literal-block">Shipper x = Shipper.FederalExpress;
string s = Enum.GetName(typeof(Shipper), x);
</pre></div>

<p>There are a bunch of other static methods on the Enum class worth
investigating too...</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/sending-email-in-net-through-gmail/" class="u-url">Sending email in .NET through Gmail</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/sending-email-in-net-through-gmail/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T08:43:16+08:00" itemprop="datePublished" title="2023-02-17 08:43">2023-02-17 08:43</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Instead of relying on my host to send an email, I was thinking of sending the
email messages using my <strong>Gmail</strong> account. The emails are personalized emails
to the bands I play on my show.</p>
<p>Is it possible to do it?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Be sure to use <code>System.Net.Mail</code>, not the deprecated <code>System.Web.Mail</code>. Doing
SSL with <code>System.Web.Mail</code> is a gross mess of hacky extensions.</p>
<div class="code"><pre class="code literal-block"><span class="n">using</span><span class="w"> </span><span class="n">System</span><span class="o">.</span><span class="n">Net</span><span class="p">;</span>
<span class="n">using</span><span class="w"> </span><span class="n">System</span><span class="o">.</span><span class="n">Net</span><span class="o">.</span><span class="n">Mail</span><span class="p">;</span>

<span class="k">var</span><span class="w"> </span><span class="n">fromAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MailAddress</span><span class="p">(</span><span class="s2">"from@gmail.com"</span><span class="p">,</span><span class="w"> </span><span class="s2">"From Name"</span><span class="p">);</span>
<span class="k">var</span><span class="w"> </span><span class="n">toAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MailAddress</span><span class="p">(</span><span class="s2">"to@example.com"</span><span class="p">,</span><span class="w"> </span><span class="s2">"To Name"</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">fromPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"fromPassword"</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Subject"</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Body"</span><span class="p">;</span>

<span class="k">var</span><span class="w"> </span><span class="n">smtp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">SmtpClient</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"smtp.gmail.com"</span><span class="p">,</span>
<span class="w">    </span><span class="n">Port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">587</span><span class="p">,</span>
<span class="w">    </span><span class="n">EnableSsl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">,</span>
<span class="w">    </span><span class="n">DeliveryMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SmtpDeliveryMethod</span><span class="o">.</span><span class="n">Network</span><span class="p">,</span>
<span class="w">    </span><span class="n">UseDefaultCredentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">Credentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NetworkCredential</span><span class="p">(</span><span class="n">fromAddress</span><span class="o">.</span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="n">fromPassword</span><span class="p">)</span>
<span class="p">};</span>
<span class="n">using</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MailMessage</span><span class="p">(</span><span class="n">fromAddress</span><span class="p">,</span><span class="w"> </span><span class="n">toAddress</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subject</span><span class="p">,</span>
<span class="w">    </span><span class="n">Body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">body</span>
<span class="p">})</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">smtp</span><span class="o">.</span><span class="n">Send</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Additionally go to the <em>Google Account &gt; Security</em> page and look at the
<em>Signing in to Google &gt; 2-Step Verification</em> setting.</p>
<ul>
<li>If it is enabled, then you have to generate a password allowing .NET to bypass the 2-Step Verification. To do this, click on <em>Signing in to Google &gt; App passwords</em>, select app = Mail, and device = Windows Computer, and finally generate the password. Use the generated password in the <code>fromPassword</code> constant instead of your standard Gmail password.</li>
<li>If it is disabled, then you have to turn on <em>Less secure app access</em> , which is not recommended! So better enable the 2-Step verification.</li>
</ul>
<p><br></p>
<h3>Suggest</h3>
<p>The above answer doesn't work. You have to set <code>DeliveryMethod =
SmtpDeliveryMethod.Network</code> or it will come back with a " <strong>client was not
authenticated</strong> " error. Also it's always a good idea to put a timeout.</p>
<p>Revised code:</p>
<div class="code"><pre class="code literal-block"><span class="n">using</span><span class="w"> </span><span class="n">System</span><span class="o">.</span><span class="n">Net</span><span class="o">.</span><span class="n">Mail</span><span class="p">;</span>
<span class="n">using</span><span class="w"> </span><span class="n">System</span><span class="o">.</span><span class="n">Net</span><span class="p">;</span>

<span class="k">var</span><span class="w"> </span><span class="n">fromAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MailAddress</span><span class="p">(</span><span class="s2">"from@gmail.com"</span><span class="p">,</span><span class="w"> </span><span class="s2">"From Name"</span><span class="p">);</span>
<span class="k">var</span><span class="w"> </span><span class="n">toAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MailAddress</span><span class="p">(</span><span class="s2">"to@yahoo.com"</span><span class="p">,</span><span class="w"> </span><span class="s2">"To Name"</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">fromPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"password"</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test"</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Hey now!!"</span><span class="p">;</span>

<span class="k">var</span><span class="w"> </span><span class="n">smtp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">SmtpClient</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"smtp.gmail.com"</span><span class="p">,</span>
<span class="w">    </span><span class="n">Port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">587</span><span class="p">,</span>
<span class="w">    </span><span class="n">EnableSsl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">,</span>
<span class="w">    </span><span class="n">DeliveryMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SmtpDeliveryMethod</span><span class="o">.</span><span class="n">Network</span><span class="p">,</span>
<span class="w">    </span><span class="n">Credentials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NetworkCredential</span><span class="p">(</span><span class="n">fromAddress</span><span class="o">.</span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="n">fromPassword</span><span class="p">),</span>
<span class="w">    </span><span class="n">Timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20000</span>
<span class="p">};</span>
<span class="n">using</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MailMessage</span><span class="p">(</span><span class="n">fromAddress</span><span class="p">,</span><span class="w"> </span><span class="n">toAddress</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subject</span><span class="p">,</span>
<span class="w">    </span><span class="n">Body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">body</span>
<span class="p">})</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">smtp</span><span class="o">.</span><span class="n">Send</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/is-there-any-way-to-kill-a-thread/" class="u-url">Is there any way to kill a Thread?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/is-there-any-way-to-kill-a-thread/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T08:42:43+08:00" itemprop="datePublished" title="2023-02-17 08:42">2023-02-17 08:42</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Is it possible to terminate a running thread without setting/checking any
flags/semaphores/etc.?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>It is generally a bad pattern to kill a thread abruptly, in Python, and in any
language. Think of the following cases:</p>
<ul>
<li>the thread is holding a critical resource that must be closed properly</li>
<li>the thread has created several other threads that must be killed as well.</li>
</ul>
<p>The nice way of handling this, if you can afford it (if you are managing your
own threads), is to have an exit_request flag that each thread checks on a
regular interval to see if it is time for it to exit.</p>
<p><strong>For example:</strong></p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">threading</span>

<span class="k">class</span> <span class="nc">StoppableThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Thread class with a stop() method. The thread itself has to check</span>
<span class="sd">    regularly for the stopped() condition."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StoppableThread</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>
</pre></div>

<p>In this code, you should call <code>stop()</code> on the thread when you want it to exit,
and wait for the thread to exit properly using <code>join()</code>. The thread should
check the stop flag at regular intervals.</p>
<p>There are cases, however, when you really need to kill a thread. An example is
when you are wrapping an external library that is busy for long calls, and you
want to interrupt it.</p>
<p>The following code allows (with some restrictions) to raise an Exception in a
Python thread:</p>
<div class="code"><pre class="code literal-block"><span class="nv">def</span><span class="w"> </span><span class="nv">_async_raise</span><span class="ss">(</span><span class="nv">tid</span>,<span class="w"> </span><span class="nv">exctype</span><span class="ss">)</span>:
<span class="w">    </span><span class="s1">'''Raises an exception in the threads with id tid'''</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">inspect</span>.<span class="nv">isclass</span><span class="ss">(</span><span class="nv">exctype</span><span class="ss">)</span>:
<span class="w">        </span><span class="nv">raise</span><span class="w"> </span><span class="nv">TypeError</span><span class="ss">(</span><span class="s2">"Only types can be raised (not instances)"</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ctypes</span>.<span class="nv">pythonapi</span>.<span class="nv">PyThreadState_SetAsyncExc</span><span class="ss">(</span><span class="nv">ctypes</span>.<span class="nv">c_long</span><span class="ss">(</span><span class="nv">tid</span><span class="ss">)</span>,
<span class="w">                                                     </span><span class="nv">ctypes</span>.<span class="nv">py_object</span><span class="ss">(</span><span class="nv">exctype</span><span class="ss">))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>:
<span class="w">        </span><span class="nv">raise</span><span class="w"> </span><span class="nv">ValueError</span><span class="ss">(</span><span class="s2">"invalid thread id"</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">elif</span><span class="w"> </span><span class="nv">res</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span>:
<span class="w">        </span>#<span class="w"> </span><span class="err">"if it returns a number greater than one, you're in trouble,</span>
<span class="w">        </span>#<span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">you</span><span class="w"> </span><span class="nv">should</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="nl">it</span><span class="w"> </span><span class="nv">again</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">exc</span><span class="o">=</span><span class="nv">NULL</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">revert</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">effect</span><span class="err">"</span>
<span class="err">        ctypes.pythonapi.PyThreadState_SetAsyncExc(ctypes.c_long(tid), None)</span>
<span class="w">        </span><span class="nv">raise</span><span class="w"> </span><span class="nv">SystemError</span><span class="ss">(</span><span class="s2">"PyThreadState_SetAsyncExc failed"</span><span class="ss">)</span>

<span class="nv">class</span><span class="w"> </span><span class="nv">ThreadWithExc</span><span class="ss">(</span><span class="nv">threading</span>.<span class="nv">Thread</span><span class="ss">)</span>:
<span class="w">    </span><span class="s1">''</span><span class="err">'A thread class that supports raising an exception in the thread from</span>
<span class="err">       another thread.</span>
<span class="w">    </span><span class="s1">''</span><span class="err">'</span>
<span class="err">    def _get_my_tid(self):</span>
<span class="w">        </span><span class="s2">""</span><span class="err">"determines this (self's) thread id</span>

<span class="err">        CAREFUL: this function is executed in the context of the caller</span>
<span class="err">        thread, to get the identity of the thread represented by this</span>
<span class="err">        instance.</span>
<span class="w">        </span><span class="s2">""</span><span class="err">"</span>
<span class="err">        if not self.isAlive():</span>
<span class="w">            </span><span class="nv">raise</span><span class="w"> </span><span class="nv">threading</span>.<span class="nv">ThreadError</span><span class="ss">(</span><span class="s2">"the thread is not active"</span><span class="ss">)</span>

<span class="w">        </span>#<span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nv">we</span><span class="w"> </span><span class="nv">have</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">cached</span>?
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nv">hasattr</span><span class="ss">(</span><span class="nv">self</span>,<span class="w"> </span><span class="s2">"_thread_id"</span><span class="ss">)</span>:
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nv">self</span>.<span class="nv">_thread_id</span>

<span class="w">        </span>#<span class="w"> </span><span class="nv">no</span>,<span class="w"> </span><span class="nv">look</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">_active</span><span class="w"> </span><span class="nv">dict</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nv">tid</span>,<span class="w"> </span><span class="nv">tobj</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">threading</span>.<span class="nv">_active</span>.<span class="nv">items</span><span class="ss">()</span>:
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nv">tobj</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">self</span>:
<span class="w">                </span><span class="nv">self</span>.<span class="nv">_thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">tid</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nv">tid</span>

<span class="w">        </span>#<span class="w"> </span><span class="nv">TODO</span>:<span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">python</span><span class="w"> </span><span class="mi">2</span>.<span class="mi">6</span>,<span class="w"> </span><span class="nv">there</span><span class="err">'s a simpler way to do: self.ident</span>

<span class="w">        </span><span class="nv">raise</span><span class="w"> </span><span class="nv">AssertionError</span><span class="ss">(</span><span class="s2">"could not determine the thread's id"</span><span class="ss">)</span>

<span class="w">    </span><span class="nv">def</span><span class="w"> </span><span class="nv">raiseExc</span><span class="ss">(</span><span class="nv">self</span>,<span class="w"> </span><span class="nv">exctype</span><span class="ss">)</span>:
<span class="w">        </span><span class="s2">""</span><span class="err">"Raises the given exception type in the context of this thread.</span>

<span class="err">        If the thread is busy in a system call (time.sleep(),</span>
<span class="err">        socket.accept(), ...), the exception is simply ignored.</span>

<span class="err">        If you are sure that your exception should terminate the thread,</span>
<span class="err">        one way to ensure that it works is:</span>

<span class="err">            t = ThreadWithExc( ... )</span>
<span class="err">            ...</span>
<span class="err">            t.raiseExc( SomeException )</span>
<span class="err">            while t.isAlive():</span>
<span class="err">                time.sleep( 0.1 )</span>
<span class="err">                t.raiseExc( SomeException )</span>

<span class="err">        If the exception is to be caught by the thread, you need a way to</span>
<span class="err">        check that your thread has caught it.</span>

<span class="err">        CAREFUL: this function is executed in the context of the</span>
<span class="err">        caller thread, to raise an exception in the context of the</span>
<span class="err">        thread represented by this instance.</span>
<span class="w">        </span><span class="s2">""</span><span class="err">"</span>
<span class="err">        _async_raise( self._get_my_tid(), exctype )</span>
</pre></div>

<p>(Based on Killable Threads by Tomer Filiba. The quote about the return value
of <code>PyThreadState_SetAsyncExc</code> appears to be from an old version of Python.)</p>
<p>As noted in the documentation, this is not a magic bullet because if the
thread is busy outside the Python interpreter, it will not catch the
interruption.</p>
<p>A good usage pattern of this code is to have the thread catch a specific
exception and perform the cleanup. That way, you can interrupt a task and
still have proper cleanup.</p>
<p><br></p>
<h3>Suggest</h3>
<p>A <code>multiprocessing.Process</code> can <code>p.terminate()</code></p>
<p>In the cases where I want to kill a thread, but do not want to use
flags/locks/signals/semaphores/events/whatever, I promote the threads to full
blown processes. For code that makes use of just a few threads the overhead is
not that bad.</p>
<p>E.g. this comes in handy to easily terminate helper "threads" which execute
blocking I/O</p>
<p>The conversion is trivial: In related code replace all <code>threading.Thread</code> with
<code>multiprocessing.Process</code> and all <code>queue.Queue</code> with <code>multiprocessing.Queue</code>
and add the required calls of <code>p.terminate()</code> to your parent process which
wants to kill its child <code>p</code></p>
<p>See the Python documentation for <code>multiprocessing</code>.</p>
<p>Example:</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="n">proc</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">your_proc_function</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span>
<span class="n">proc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="c1"># Terminate the process</span>
<span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>  <span class="c1"># sends a SIGTERM</span>
</pre></div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-512.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-510.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
