<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1603) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1603.html">
<link rel="prev" href="index-1604.html" type="text/html">
<link rel="next" href="index-1602.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/what-is-the-python-with-statement-designed-for/" class="u-url">What is the python "with" statement designed for?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/what-is-the-python-with-statement-designed-for/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T04:57:10+08:00" itemprop="datePublished" title="2023-03-03 04:57">2023-03-03 04:57</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I came across the Python <code>with</code> statement for the first time today. I've been
using Python lightly for several months and didn't even know of its existence!
Given its somewhat obscure status, I thought it would be worth asking:</p>
<ol>
<li>What is the Python <code>with</code> statement designed to be used for? </li>
<li>What do you use it for? </li>
<li>Are there any gotchas I need to be aware of, or common anti-patterns associated with its use? Any cases where it is better use <code>try..finally</code> than <code>with</code>?</li>
<li>Why isn't it used more widely?</li>
<li>Which standard library classes are compatible with it?</li>
</ol>
<p><br><br></p>
<h2>Answer</h2>
<ol>
<li>
<p>I believe this has already been answered by other users before me, so I only add it for the sake of completeness: the <code>with</code> statement simplifies exception handling by encapsulating common preparation and cleanup tasks in so-called context managers. More details can be found in PEP 343. For instance, the <code>open</code> statement is a context manager in itself, which lets you open a file, keep it open as long as the execution is in the context of the <code>with</code> statement where you used it, and close it as soon as you leave the context, no matter whether you have left it because of an exception or during regular control flow. The <code>with</code> statement can thus be used in ways similar to the RAII pattern in C++: some resource is acquired by the <code>with</code> statement and released when you leave the <code>with</code> context.</p>
</li>
<li>
<p>Some examples are: opening files using <code>with open(filename) as fp:</code>, acquiring locks using <code>with lock:</code> (where <code>lock</code> is an instance of <code>threading.Lock</code>). You can also construct your own context managers using the <code>contextmanager</code> decorator from <code>contextlib</code>. For instance, I often use this when I have to change the current directory temporarily and then return to where I was:</p>
<div class="code"><pre class="code literal-block"><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
</pre></div>

<p>import os</p>
<p>@contextmanager
def working_directory(path):
    current_dir = os.getcwd()
    os.chdir(path)
    try:
        yield
    finally:
        os.chdir(current_dir)</p>
<p>with working_directory("data/stuff"):
    # do something within data/stuff</p>
<h2>here I am back again in the original working directory</h2>
</li>
</ol>
<p>Here's another example that temporarily redirects <code>sys.stdin</code>, <code>sys.stdout</code>
and <code>sys.stderr</code> to some other file handle and restores them later:</p>
<div class="code"><pre class="code literal-block">    <span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">redirected</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="n">stream_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"stdin"</span><span class="p">,</span> <span class="s2">"stdout"</span><span class="p">,</span> <span class="s2">"stderr"</span><span class="p">]</span>
    <span class="n">old_streams</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sname</span> <span class="ow">in</span> <span class="n">stream_names</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stream</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">sname</span><span class="p">):</span>
                <span class="n">old_streams</span><span class="p">[</span><span class="n">sname</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">sname</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">sname</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sname</span><span class="p">,</span> <span class="n">stream</span> <span class="ow">in</span> <span class="n">old_streams</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">sname</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>

<span class="k">with</span> <span class="n">redirected</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s2">"/tmp/log.txt"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)):</span>
     <span class="c1"># these print statements will go to /tmp/log.txt</span>
     <span class="nb">print</span> <span class="s2">"Test entry 1"</span>
     <span class="nb">print</span> <span class="s2">"Test entry 2"</span>
<span class="c1"># back to the normal stdout</span>
<span class="nb">print</span> <span class="s2">"Back to normal stdout again"</span>
</pre></div>

<p>And finally, another example that creates a temporary folder and cleans it up
when leaving the context:</p>
<div class="code"><pre class="code literal-block">    <span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">mkdtemp</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">temporary_dir</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mkdtemp</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">name</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="k">with</span> <span class="n">temporary_dir</span><span class="p">()</span> <span class="k">as</span> <span class="n">dirname</span><span class="p">:</span>
    <span class="c1"># do whatever you want</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>I would suggest two interesting lectures:</p>
<ul>
<li>PEP 343 The "with" Statement</li>
<li>Effbot Understanding Python's "with" statement</li>
</ul>
<p><strong>1.</strong> The <code>with</code> statement is used to wrap the execution of a block with
methods defined by a context manager. This allows common
<code>try...except...finally</code> usage patterns to be encapsulated for convenient
reuse.</p>
<p><strong>2.</strong> You could do something like:</p>
<div class="code"><pre class="code literal-block">with open("foo.txt") as foo_file:
    data = foo_file.read()
</pre></div>

<p>OR</p>
<div class="code"><pre class="code literal-block"><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">nested</span>
<span class="k">with</span> <span class="n">nested</span><span class="p">(</span><span class="n">A</span><span class="p">(),</span> <span class="n">B</span><span class="p">(),</span> <span class="n">C</span><span class="p">())</span> <span class="k">as</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
   <span class="n">do_something</span><span class="p">()</span>
</pre></div>

<p>OR (Python 3.1)</p>
<div class="code"><pre class="code literal-block"><span class="nv">with</span><span class="w"> </span><span class="nv">open</span><span class="ss">(</span><span class="s1">'data'</span><span class="ss">)</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">input_file</span>,<span class="w"> </span><span class="nv">open</span><span class="ss">(</span><span class="s1">'result'</span>,<span class="w"> </span><span class="s1">'w'</span><span class="ss">)</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">output_file</span>:
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="nv">line</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">input_file</span>:
<span class="w">     </span><span class="nv">output_file</span>.<span class="nv">write</span><span class="ss">(</span><span class="nv">parse</span><span class="ss">(</span><span class="nv">line</span><span class="ss">))</span>
</pre></div>

<p>OR</p>
<div class="code"><pre class="code literal-block">lock = threading.Lock()
with lock:
    # Critical section of code
</pre></div>

<p><strong>3.</strong> I don't see any Antipattern here.<br>
Quoting Dive into Python:</p>
<blockquote>
<p><strong>try..finally is good. with is better.</strong></p>
</blockquote>
<p><strong>4.</strong> I guess it's related to programmers's habit to use
<code>try..catch..finally</code> statement from other languages.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/when-to-use-on-update-cascade/" class="u-url">When to use "ON UPDATE CASCADE"</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/when-to-use-on-update-cascade/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T04:56:46+08:00" itemprop="datePublished" title="2023-03-03 04:56">2023-03-03 04:56</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I use <code>ON DELETE CASCADE</code> regularly but I never use <code>ON UPDATE CASCADE</code> as I
am not so sure in what situation it will be useful.</p>
<p>For the sake of discussion let see some code.</p>
<div class="code"><pre class="code literal-block">CREATE TABLE parent (
    id INT NOT NULL AUTO_INCREMENT,
    PRIMARY KEY (id)
);

CREATE TABLE child (
    id INT NOT NULL AUTO_INCREMENT, parent_id INT,
    INDEX par_ind (parent_id),
    FOREIGN KEY (parent_id)
        REFERENCES parent(id)
        ON DELETE CASCADE
);
</pre></div>

<p>For <code>ON DELETE CASCADE</code>, if a parent with an <code>id</code> is deleted, a record in
child with <code>parent_id = parent.id</code> will be automatically deleted. This should
be no problem.</p>
<ol>
<li>
<p>This means that <code>ON UPDATE CASCADE</code> will do the same thing when <code>id</code> of the parent is updated?</p>
</li>
<li>
<p>If (1) is true, it means that there is no need to use <code>ON UPDATE CASCADE</code> if <code>parent.id</code> is not updatable (or will never be updated) like when it is <code>AUTO_INCREMENT</code> or always set to be <code>TIMESTAMP</code>. Is that right?</p>
</li>
<li>
<p>If (2) is not true, in what other kind of situation should we use <code>ON UPDATE CASCADE</code>?</p>
</li>
<li>
<p>What if I (for some reason) update the <code>child.parent_id</code> to be something not existing, will it then be automatically deleted?</p>
</li>
</ol>
<p>Well, I know, some of the question above can be test programmatically to
understand but I want also know if any of this is database vendor dependent or
not.</p>
<p>Please shed some light.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>It's true that if your primary key is just an identity value auto incremented,
you would have no real use for <code>ON UPDATE CASCADE</code>.</p>
<p>However, let's say that your primary key is a 10 digit UPC bar code and
because of expansion, you need to change it to a 13-digit UPC bar code. In
that case, <code>ON UPDATE CASCADE</code> would allow you to change the primary key value
and any tables that have foreign key references to the value will be changed
accordingly.</p>
<p>In reference to #4, if you change the child ID to something that doesn't exist
in the parent table (and you have referential integrity), you should get a
foreign key error.</p>
<p><br></p>
<h3>Suggest</h3>
<ol>
<li>
<p>Yes, it means that for example if you do <code>UPDATE parent SET id = 20 WHERE id = 10</code> all children parent_id's of 10 will also be updated to 20</p>
</li>
<li>
<p>If you don't update the field the foreign key refers to, this setting is not needed</p>
</li>
<li>
<p>Can't think of any other use.</p>
</li>
<li>
<p>You can't do that as the foreign key constraint would fail.</p>
</li>
</ol>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/why-does-gcc-generate-15-20-faster-code-if-i-optimize-for-size-instead-of-speed/" class="u-url">Why does GCC generate 15-20% faster code if I optimize for size instead of speed?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/why-does-gcc-generate-15-20-faster-code-if-i-optimize-for-size-instead-of-speed/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T04:56:20+08:00" itemprop="datePublished" title="2023-03-03 04:56">2023-03-03 04:56</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I first noticed in 2009 that GCC (at least on my projects and on my machines)
have the tendency to generate noticeably faster code if I optimize for
<strong>size</strong> (<code>-Os</code>) instead of speed (<code>-O2</code> or <code>-O3</code>), and I have been wondering
ever since why.</p>
<p>I have managed to create (rather silly) code that shows this surprising
behavior and is sufficiently small to be posted here.</p>
<div class="code"><pre class="code literal-block"><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">LOOP_BOUND</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200000000</span><span class="p">;</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
<span class="k">static</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
<span class="k">static</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">work</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">xval</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">yval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">LOOP_BOUND</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="n">xval</span><span class="o">+</span><span class="n">sum</span><span class="p">);</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">yval</span><span class="o">+</span><span class="n">sum</span><span class="p">);</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb nb-Type">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nb">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">work</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>If I compile it with <code>-Os</code>, it takes 0.38 s to execute this program, and 0.44
s if it is compiled with <code>-O2</code> or <code>-O3</code>. These times are obtained consistently
and with practically no noise (gcc 4.7.2, x86_64 GNU/Linux, Intel Core
i5-3320M).</p>
<p><em>(Update: I have moved all assembly code to GitHub: They made the post bloated
and apparently add very little value to the questions as the<code>fno-align-*</code>
flags have the same effect.)</em></p>
<p>Here is the generated assembly with <code>-Os</code> and <code>-O2</code>.</p>
<p>Unfortunately, my understanding of assembly is very limited, so I have no idea
whether what I did next was correct: I grabbed the assembly for <code>-O2</code> and
merged all its differences into the assembly for <code>-Os</code> <em>except</em> the <code>.p2align</code>
lines, result here. This code still runs in 0.38s and <strong>the only difference is
the</strong> <code>.p2align</code> <strong>stuff.</strong></p>
<p>If I guess correctly, these are paddings for stack alignment. According to Why
does GCC pad functions with NOPs? it is done in the hope that the code will
run faster, but apparently this optimization backfired in my case.</p>
<p><strong>Is it the padding that is the culprit in this case? Why and how?</strong></p>
<p>The noise it makes pretty much makes timing micro-optimizations impossible.</p>
<p><strong>How can I make sure that such accidental lucky / unlucky alignments are not
interfering when I do micro-optimizations (unrelated to stack alignment) on C
or C++ source code?</strong></p>
<hr>
<p><strong>UPDATE:</strong></p>
<p>Following Pascal Cuoq's answer I tinkered a little bit with the alignments. By
passing <code>-O2 -fno-align-functions -fno-align-loops</code> to gcc, all <code>.p2align</code> are
gone from the assembly and the generated executable runs in 0.38s. According
to the gcc documentation:</p>
<blockquote>
<p>-Os enables all -O2 optimizations [but] -Os disables the following
optimization flags:</p>
<div class="code"><pre class="code literal-block"><span class="w">  </span><span class="o">-</span><span class="nv">falign</span><span class="o">-</span><span class="nv">functions</span><span class="w">  </span><span class="o">-</span><span class="nv">falign</span><span class="o">-</span><span class="nv">jumps</span><span class="w">  </span><span class="o">-</span><span class="nv">falign</span><span class="o">-</span><span class="nv">loops</span>
<span class="w">  </span><span class="o">-</span><span class="nv">falign</span><span class="o">-</span><span class="nv">labels</span><span class="w">  </span><span class="o">-</span><span class="nv">freorder</span><span class="o">-</span><span class="nv">blocks</span><span class="w">  </span><span class="o">-</span><span class="nv">freorder</span><span class="o">-</span><span class="nv">blocks</span><span class="o">-</span><span class="nv">and</span><span class="o">-</span><span class="nv">partition</span>
<span class="w">  </span><span class="o">-</span><span class="nv">fprefetch</span><span class="o">-</span><span class="k">loop</span><span class="o">-</span><span class="nv">arrays</span>
</pre></div>

</blockquote>
<p><strong>So, it pretty much seems like a (mis)alignment issue.</strong></p>
<p>I am still skeptical about <code>-march=native</code> as suggested in Marat Dukhan's
answer. I am not convinced that it isn't just interfering with this
(mis)alignment issue; it has absolutely no effect on my machine.
(Nevertheless, I upvoted his answer.)</p>
<hr>
<p><strong>UPDATE 2:</strong></p>
<p><strong>We can take<code>-Os</code> out of the picture.</strong> The following times are obtained by
compiling with</p>
<ul>
<li>
<p><code>-O2 -fno-omit-frame-pointer</code> 0.37s</p>
</li>
<li>
<p><code>-O2 -fno-align-functions -fno-align-loops</code> 0.37s</p>
</li>
<li>
<p><code>-S -O2</code> then manually moving the assembly of <code>add()</code> after <code>work()</code> 0.37s</p>
</li>
<li>
<p><code>-O2</code> 0.44s</p>
</li>
</ul>
<p>It looks like to me the distance of <code>add()</code> from the call site matters a lot.
I have tried <code>perf</code>, but the output of <code>perf stat</code> and <code>perf report</code> makes
very little sense to me. However, I could only get one consistent result out
of it:</p>
<p><code>-O2</code>:</p>
<div class="code"><pre class="code literal-block"><span class="w"> </span><span class="mi">602</span><span class="p">,</span><span class="mi">312</span><span class="p">,</span><span class="mi">864</span><span class="w"> </span><span class="n">stalled</span><span class="o">-</span><span class="n">cycles</span><span class="o">-</span><span class="n">frontend</span><span class="w">   </span><span class="c1">#    0.00% frontend cycles idle</span>
<span class="w">       </span><span class="mi">3</span><span class="p">,</span><span class="mi">318</span><span class="w"> </span><span class="n">cache</span><span class="o">-</span><span class="n">misses</span>
<span class="w"> </span><span class="mf">0.432703993</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">elapsed</span>
<span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="w"> </span><span class="mf">81.23</span><span class="o">%</span><span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="w">              </span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="w"> </span><span class="n">work</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">)</span>
<span class="w"> </span><span class="mf">18.50</span><span class="o">%</span><span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="w">              </span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">clone</span><span class="w"> </span><span class="o">.</span><span class="n">isra</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
<span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="err">¦</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="mf">100.00</span><span class="w"> </span><span class="err">¦</span><span class="w">     </span><span class="n">lea</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="p">}</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="err">?</span><span class="w"> </span><span class="n">retq</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="w">       </span><span class="err">¦</span><span class="w">            </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="w">  </span><span class="mf">1.93</span><span class="w"> </span><span class="err">¦</span><span class="w">    </span><span class="err">?</span><span class="w"> </span><span class="n">callq</span><span class="w">  </span><span class="n">add</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">clone</span><span class="w"> </span><span class="o">.</span><span class="n">isra</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
<span class="w">       </span><span class="err">¦</span><span class="w">            </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="w"> </span><span class="mf">79.79</span><span class="w"> </span><span class="err">¦</span><span class="w">      </span><span class="n">add</span><span class="w">    </span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">ebx</span>
</pre></div>

<p>For <code>fno-align-*</code>:</p>
<div class="code"><pre class="code literal-block"><span class="w"> </span><span class="mi">604</span><span class="p">,</span><span class="mi">072</span><span class="p">,</span><span class="mi">552</span><span class="w"> </span><span class="n">stalled</span><span class="o">-</span><span class="n">cycles</span><span class="o">-</span><span class="n">frontend</span><span class="w">   </span><span class="c1">#    0.00% frontend cycles idle</span>
<span class="w">       </span><span class="mi">9</span><span class="p">,</span><span class="mi">508</span><span class="w"> </span><span class="n">cache</span><span class="o">-</span><span class="n">misses</span>
<span class="w"> </span><span class="mf">0.375681928</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">elapsed</span>
<span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="w"> </span><span class="mf">82.58</span><span class="o">%</span><span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="w">              </span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="w"> </span><span class="n">work</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">)</span>
<span class="w"> </span><span class="mf">16.83</span><span class="o">%</span><span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="w">              </span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">clone</span><span class="w"> </span><span class="o">.</span><span class="n">isra</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
<span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="err">¦</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w"> </span><span class="mf">51.59</span><span class="w"> </span><span class="err">¦</span><span class="w">     </span><span class="n">lea</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="p">}</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="w">       </span><span class="err">¦</span><span class="w">    </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
<span class="w">       </span><span class="err">¦</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">work</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">xval</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">yval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="err">¦</span><span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">       </span><span class="err">¦</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">LOOP_BOUND</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="err">¦</span><span class="w">            </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="n">xval</span><span class="o">+</span><span class="n">sum</span><span class="p">);</span>
<span class="w">  </span><span class="mf">8.20</span><span class="w"> </span><span class="err">¦</span><span class="w">      </span><span class="n">lea</span><span class="w">    </span><span class="mh">0x0</span><span class="p">(</span><span class="o">%</span><span class="n">r13</span><span class="p">,</span><span class="o">%</span><span class="n">rbx</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="o">%</span><span class="n">edi</span>
<span class="w">       </span><span class="err">¦</span><span class="w">            </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">yval</span><span class="o">+</span><span class="n">sum</span><span class="p">);</span>
<span class="w">       </span><span class="err">¦</span><span class="w">            </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="w"> </span><span class="mf">35.34</span><span class="w"> </span><span class="err">¦</span><span class="w">    </span><span class="err">?</span><span class="w"> </span><span class="n">callq</span><span class="w">  </span><span class="n">add</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">clone</span><span class="w"> </span><span class="o">.</span><span class="n">isra</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
<span class="w">       </span><span class="err">¦</span><span class="w">            </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="w"> </span><span class="mf">39.48</span><span class="w"> </span><span class="err">¦</span><span class="w">      </span><span class="n">add</span><span class="w">    </span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">ebx</span>
<span class="w">       </span><span class="err">¦</span><span class="w">    </span><span class="p">}</span>
</pre></div>

<p>For <code>-fno-omit-frame-pointer</code>:</p>
<div class="code"><pre class="code literal-block"><span class="w"> </span><span class="mi">404</span><span class="p">,</span><span class="mi">625</span><span class="p">,</span><span class="mi">639</span><span class="w"> </span><span class="n">stalled</span><span class="o">-</span><span class="n">cycles</span><span class="o">-</span><span class="n">frontend</span><span class="w">   </span><span class="c1">#    0.00% frontend cycles idle</span>
<span class="w">      </span><span class="mi">10</span><span class="p">,</span><span class="mi">514</span><span class="w"> </span><span class="n">cache</span><span class="o">-</span><span class="n">misses</span>
<span class="w"> </span><span class="mf">0.375445137</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">elapsed</span>
<span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="w"> </span><span class="mf">75.35</span><span class="o">%</span><span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="w">              </span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">clone</span><span class="w"> </span><span class="o">.</span><span class="n">isra</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span><span class="w">                                                                                     </span><span class="err">¦</span>
<span class="w"> </span><span class="mf">24.46</span><span class="o">%</span><span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="w">  </span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="w">              </span><span class="p">[</span><span class="o">.</span><span class="p">]</span><span class="w"> </span><span class="n">work</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">)</span>
<span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="mf">18.67</span><span class="w"> </span><span class="err">¦</span><span class="w">     </span><span class="n">push</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">       </span><span class="err">¦</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w"> </span><span class="mf">18.49</span><span class="w"> </span><span class="err">¦</span><span class="w">     </span><span class="n">lea</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">LOOP_BOUND</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200000000</span><span class="p">;</span>
<span class="w">       </span><span class="err">¦</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="err">¦</span><span class="w">     </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span>
<span class="w">       </span><span class="err">¦</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="p">}</span>
<span class="w"> </span><span class="mf">12.71</span><span class="w"> </span><span class="err">¦</span><span class="w">     </span><span class="n">pop</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">       </span><span class="err">¦</span><span class="w">   </span><span class="err">?</span><span class="w"> </span><span class="n">retq</span>
<span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="w">       </span><span class="err">¦</span><span class="w">            </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="w">       </span><span class="err">¦</span><span class="w">    </span><span class="err">?</span><span class="w"> </span><span class="n">callq</span><span class="w">  </span><span class="n">add</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">clone</span><span class="w"> </span><span class="o">.</span><span class="n">isra</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
<span class="w">       </span><span class="err">¦</span><span class="w">            </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="w"> </span><span class="mf">29.83</span><span class="w"> </span><span class="err">¦</span><span class="w">      </span><span class="n">add</span><span class="w">    </span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">ebx</span>
</pre></div>

<p>It looks like we are stalling on the call to <code>add()</code> in the slow case.</p>
<p>I have examined <em>everything</em> that <code>perf -e</code> can spit out on my machine; not
just the stats that are given above.</p>
<p>For the same executable, the <code>stalled-cycles-frontend</code> shows linear
correlation with the execution time; I did not notice anything else that would
correlate so clearly. (Comparing <code>stalled-cycles-frontend</code> for different
executables doesn't make sense to me.)</p>
<p>I included the cache misses as it came up as the first comment. I examined all
the cache misses that can be measured on my machine by <code>perf</code>, not just the
ones given above. The cache misses are very very noisy and show little to no
correlation with the execution times.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>My colleague helped me find a plausible answer to my question. He noticed the
importance of the 256 byte boundary. He is not registered here and encouraged
me to post the answer myself (and take all the fame).</p>
<hr>
<p><strong>Short answer:</strong></p>
<blockquote>
<p>Is it the padding that is the culprit in this case? Why and how?</p>
</blockquote>
<p><strong>It all boils down to alignment.</strong> Alignments can have a significant impact
on the performance, that is why we have the <code>-falign-*</code> flags in the first
place.</p>
<p>I have submitted a (bogus?) bug report to the gcc developers. It turns out
that the default behavior is <em>"we align loops to 8 byte by default but try to
align it to 16 byte if we don't need to fill in over 10 bytes."</em> Apparently,
this default is not the best choice in this particular case and on my machine.
Clang 3.4 (trunk) with <code>-O3</code> does the appropriate alignment and the generated
code does not show this weird behavior.</p>
<p>Of course, <strong>if an inappropriate alignment is done, it makes things worse.</strong>
An unnecessary / bad alignment just eats up bytes for no reason and
potentially increases cache misses, etc.</p>
<blockquote>
<p>The noise it makes pretty much makes timing micro-optimizations impossible.</p>
<p>How can I make sure that such accidental lucky / unlucky alignments are not
interfering when I do micro-optimizations (unrelated to stack alignment) on
C or C++ source codes?</p>
</blockquote>
<p><strong>Simply by telling gcc to do the right alignment:</strong></p>
<p><code>g++ -O2 -falign-functions=16 -falign-loops=16</code></p>
<hr>
<p><strong>Long answer:</strong></p>
<p>The code will run slower if:</p>
<ul>
<li>
<p>an <code>XX</code> byte boundary cuts <code>add()</code> in the middle (<code>XX</code> being machine dependent).</p>
</li>
<li>
<p>if the call to <code>add()</code> has to jump over an <code>XX</code> byte boundary and the target is not aligned.</p>
</li>
<li>
<p>if <code>add()</code> is not aligned.</p>
</li>
<li>
<p>if the loop is not aligned.</p>
</li>
</ul>
<p>The first 2 are beautifully visible on the codes and results that Marat Dukhan
kindly posted. In this case, <code>gcc-4.8.1 -Os</code> (executes in 0.994 secs):</p>
<div class="code"><pre class="code literal-block"><span class="mf">00000000004004</span><span class="n">fd</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_ZL3addRKiS0_</span><span class="mf">.</span><span class="n">isra</span><span class="mf">.0</span><span class="o">&gt;</span><span class="p">:</span>
<span class="w">  </span><span class="mf">4004</span><span class="n">fd</span><span class="p">:</span><span class="w">       </span><span class="mf">8</span><span class="n">d</span><span class="w"> </span><span class="mf">04</span><span class="w"> </span><span class="mf">37</span><span class="w">                </span><span class="n">lea</span><span class="w">    </span><span class="n">eax</span><span class="p">,</span><span class="err">[</span><span class="n">rdi</span><span class="o">+</span><span class="n">rsi</span><span class="o">*</span><span class="mf">1</span><span class="err">]</span>
<span class="w">  </span><span class="mf">400500</span><span class="p">:</span><span class="w">       </span><span class="n">c3</span>
</pre></div>

<p>a 256 byte boundary cuts <code>add()</code> right in the middle and neither <code>add()</code> nor
the loop is aligned. Surprise, surprise, this is the slowest case!</p>
<p>In case <code>gcc-4.7.3 -Os</code> (executes in 0.822 secs), the 256 byte boundary only
cuts into a cold section (but neither the loop, nor <code>add()</code> is cut):</p>
<div class="code"><pre class="code literal-block"><span class="mf">00000000004004</span><span class="n">fa</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_ZL3addRKiS0_</span><span class="mf">.</span><span class="n">isra</span><span class="mf">.0</span><span class="o">&gt;</span><span class="p">:</span>
<span class="w">  </span><span class="mf">4004</span><span class="n">fa</span><span class="p">:</span><span class="w">       </span><span class="mf">8</span><span class="n">d</span><span class="w"> </span><span class="mf">04</span><span class="w"> </span><span class="mf">37</span><span class="w">                </span><span class="n">lea</span><span class="w">    </span><span class="n">eax</span><span class="p">,</span><span class="err">[</span><span class="n">rdi</span><span class="o">+</span><span class="n">rsi</span><span class="o">*</span><span class="mf">1</span><span class="err">]</span>
<span class="w">  </span><span class="mf">4004</span><span class="n">fd</span><span class="p">:</span><span class="w">       </span><span class="n">c3</span><span class="w">                      </span><span class="n">ret</span>

<span class="err">[</span><span class="mf">...</span><span class="err">]</span>

<span class="w">  </span><span class="mf">40051</span><span class="n">a</span><span class="p">:</span><span class="w">       </span><span class="n">e8</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">          </span><span class="n">call</span><span class="w">   </span><span class="mf">4004</span><span class="n">fa</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_ZL3addRKiS0_</span><span class="mf">.</span><span class="n">isra</span><span class="mf">.0</span><span class="o">&gt;</span>
</pre></div>

<p>Nothing is aligned, and the call to <code>add()</code> has to jump over the 256 byte
boundary. This code is the second slowest.</p>
<p>In case <code>gcc-4.6.4 -Os</code> (executes in 0.709 secs), although nothing is aligned,
the call to <code>add()</code> doesn't have to jump over the 256 byte boundary and the
target is exactly 32 byte away:</p>
<div class="code"><pre class="code literal-block">  4004f2:       e8 db ff ff ff          call   4004d2 &lt;_ZL3addRKiS0_.isra.0&gt;
  4004f7:       01 c3                   add    ebx,eax
  4004f9:       ff cd                   dec    ebp
  4004fb:       75 ec                   jne    4004e9 &lt;_ZL4workii+0x13&gt;
</pre></div>

<p>This is the fastest of all three. Why the 256 byte boundary is speacial on his
machine, I will leave it up to him to figure it out. I don't have such a
processor.</p>
<p>Now, on my machine I don't get this 256 byte boundary effect. Only the
function and the loop alignment kicks in on my machine. If I pass <code>g++ -O2
-falign-functions=16 -falign-loops=16</code> then everything is back to normal: I
always get the fastest case and the time isn't sensitive to the <code>-fno-omit-
frame-pointer</code> flag anymore. I can pass <code>g++ -O2 -falign-functions=32 -falign-
loops=32</code> or any multiples of 16, the code is not sensitive to that either.</p>
<blockquote>
<p>I first noticed in 2009 that gcc (at least on my projects and on my
machines) have the tendency to generate noticeably faster code if I optimize
for size (-Os) instead of speed (-O2 or -O3) and I have been wondering ever
since why.</p>
</blockquote>
<p>A likely explanation is that I had hotspots which were sensitive to the
alignment, just like the one in this example. By messing with the flags
(passing <code>-Os</code> instead of <code>-O2</code>), those hotspots were aligned in a lucky way
by accident and the code became faster. <strong>It had nothing to do with optimizing
for size: These were by sheer accident that the hotspots got aligned better.</strong>
From now on, I will check the effects of alignment on my projects.</p>
<p>Oh, and one more thing. <strong>How can such hotspots arise, like the one shown in
the example? How can the inlining of such a tiny function like<code>add()</code> fail?</strong></p>
<p>Consider this:</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="n">add</span><span class="o">.</span><span class="n">cpp</span>
<span class="nb nb-Type">int</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>and in a separate file:</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">cpp</span>
<span class="nb nb-Type">int</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>

<span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">LOOP_BOUND</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200000000</span><span class="p">;</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
<span class="k">static</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">work</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">xval</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">yval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">LOOP_BOUND</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="n">xval</span><span class="o">+</span><span class="n">sum</span><span class="p">);</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">yval</span><span class="o">+</span><span class="n">sum</span><span class="p">);</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb nb-Type">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nb">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">work</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>and compiled as: <code>g++ -O2 add.cpp main.cpp</code>.</p>
<p><strong>gcc won't inline<code>add()</code>!</strong></p>
<p>That's all, it's that easy to unintendedly create hotspots like the one in the
OP. <strong>Of course it is partly my fault: gcc is an excellent compiler.</strong> If
compile the above as: <code>g++ -O2 -flto add.cpp main.cpp</code>, that is, <strong>if I
perform link time optimization, the code runs in 0.19s!</strong></p>
<p>(Inlining is artificially disabled in the OP, hence, the code in the OP was 2x
slower).</p>
<p><br></p>
<h3>Suggest</h3>
<p>My colleague helped me find a plausible answer to my question. He noticed the
importance of the 256 byte boundary. He is not registered here and encouraged
me to post the answer myself (and take all the fame).</p>
<hr>
<p><strong>Short answer:</strong></p>
<blockquote>
<p>Is it the padding that is the culprit in this case? Why and how?</p>
</blockquote>
<p><strong>It all boils down to alignment.</strong> Alignments can have a significant impact
on the performance, that is why we have the <code>-falign-*</code> flags in the first
place.</p>
<p>I have submitted a (bogus?) bug report to the gcc developers. It turns out
that the default behavior is <em>"we align loops to 8 byte by default but try to
align it to 16 byte if we don't need to fill in over 10 bytes."</em> Apparently,
this default is not the best choice in this particular case and on my machine.
Clang 3.4 (trunk) with <code>-O3</code> does the appropriate alignment and the generated
code does not show this weird behavior.</p>
<p>Of course, <strong>if an inappropriate alignment is done, it makes things worse.</strong>
An unnecessary / bad alignment just eats up bytes for no reason and
potentially increases cache misses, etc.</p>
<blockquote>
<p>The noise it makes pretty much makes timing micro-optimizations impossible.</p>
<p>How can I make sure that such accidental lucky / unlucky alignments are not
interfering when I do micro-optimizations (unrelated to stack alignment) on
C or C++ source codes?</p>
</blockquote>
<p><strong>Simply by telling gcc to do the right alignment:</strong></p>
<p><code>g++ -O2 -falign-functions=16 -falign-loops=16</code></p>
<hr>
<p><strong>Long answer:</strong></p>
<p>The code will run slower if:</p>
<ul>
<li>
<p>an <code>XX</code> byte boundary cuts <code>add()</code> in the middle (<code>XX</code> being machine dependent).</p>
</li>
<li>
<p>if the call to <code>add()</code> has to jump over an <code>XX</code> byte boundary and the target is not aligned.</p>
</li>
<li>
<p>if <code>add()</code> is not aligned.</p>
</li>
<li>
<p>if the loop is not aligned.</p>
</li>
</ul>
<p>The first 2 are beautifully visible on the codes and results that Marat Dukhan
kindly posted. In this case, <code>gcc-4.8.1 -Os</code> (executes in 0.994 secs):</p>
<div class="code"><pre class="code literal-block"><span class="mf">00000000004004</span><span class="n">fd</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_ZL3addRKiS0_</span><span class="mf">.</span><span class="n">isra</span><span class="mf">.0</span><span class="o">&gt;</span><span class="p">:</span>
<span class="w">  </span><span class="mf">4004</span><span class="n">fd</span><span class="p">:</span><span class="w">       </span><span class="mf">8</span><span class="n">d</span><span class="w"> </span><span class="mf">04</span><span class="w"> </span><span class="mf">37</span><span class="w">                </span><span class="n">lea</span><span class="w">    </span><span class="n">eax</span><span class="p">,</span><span class="err">[</span><span class="n">rdi</span><span class="o">+</span><span class="n">rsi</span><span class="o">*</span><span class="mf">1</span><span class="err">]</span>
<span class="w">  </span><span class="mf">400500</span><span class="p">:</span><span class="w">       </span><span class="n">c3</span>
</pre></div>

<p>a 256 byte boundary cuts <code>add()</code> right in the middle and neither <code>add()</code> nor
the loop is aligned. Surprise, surprise, this is the slowest case!</p>
<p>In case <code>gcc-4.7.3 -Os</code> (executes in 0.822 secs), the 256 byte boundary only
cuts into a cold section (but neither the loop, nor <code>add()</code> is cut):</p>
<div class="code"><pre class="code literal-block"><span class="mf">00000000004004</span><span class="n">fa</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_ZL3addRKiS0_</span><span class="mf">.</span><span class="n">isra</span><span class="mf">.0</span><span class="o">&gt;</span><span class="p">:</span>
<span class="w">  </span><span class="mf">4004</span><span class="n">fa</span><span class="p">:</span><span class="w">       </span><span class="mf">8</span><span class="n">d</span><span class="w"> </span><span class="mf">04</span><span class="w"> </span><span class="mf">37</span><span class="w">                </span><span class="n">lea</span><span class="w">    </span><span class="n">eax</span><span class="p">,</span><span class="err">[</span><span class="n">rdi</span><span class="o">+</span><span class="n">rsi</span><span class="o">*</span><span class="mf">1</span><span class="err">]</span>
<span class="w">  </span><span class="mf">4004</span><span class="n">fd</span><span class="p">:</span><span class="w">       </span><span class="n">c3</span><span class="w">                      </span><span class="n">ret</span>

<span class="err">[</span><span class="mf">...</span><span class="err">]</span>

<span class="w">  </span><span class="mf">40051</span><span class="n">a</span><span class="p">:</span><span class="w">       </span><span class="n">e8</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w">          </span><span class="n">call</span><span class="w">   </span><span class="mf">4004</span><span class="n">fa</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_ZL3addRKiS0_</span><span class="mf">.</span><span class="n">isra</span><span class="mf">.0</span><span class="o">&gt;</span>
</pre></div>

<p>Nothing is aligned, and the call to <code>add()</code> has to jump over the 256 byte
boundary. This code is the second slowest.</p>
<p>In case <code>gcc-4.6.4 -Os</code> (executes in 0.709 secs), although nothing is aligned,
the call to <code>add()</code> doesn't have to jump over the 256 byte boundary and the
target is exactly 32 byte away:</p>
<div class="code"><pre class="code literal-block">  4004f2:       e8 db ff ff ff          call   4004d2 &lt;_ZL3addRKiS0_.isra.0&gt;
  4004f7:       01 c3                   add    ebx,eax
  4004f9:       ff cd                   dec    ebp
  4004fb:       75 ec                   jne    4004e9 &lt;_ZL4workii+0x13&gt;
</pre></div>

<p>This is the fastest of all three. Why the 256 byte boundary is speacial on his
machine, I will leave it up to him to figure it out. I don't have such a
processor.</p>
<p>Now, on my machine I don't get this 256 byte boundary effect. Only the
function and the loop alignment kicks in on my machine. If I pass <code>g++ -O2
-falign-functions=16 -falign-loops=16</code> then everything is back to normal: I
always get the fastest case and the time isn't sensitive to the <code>-fno-omit-
frame-pointer</code> flag anymore. I can pass <code>g++ -O2 -falign-functions=32 -falign-
loops=32</code> or any multiples of 16, the code is not sensitive to that either.</p>
<blockquote>
<p>I first noticed in 2009 that gcc (at least on my projects and on my
machines) have the tendency to generate noticeably faster code if I optimize
for size (-Os) instead of speed (-O2 or -O3) and I have been wondering ever
since why.</p>
</blockquote>
<p>A likely explanation is that I had hotspots which were sensitive to the
alignment, just like the one in this example. By messing with the flags
(passing <code>-Os</code> instead of <code>-O2</code>), those hotspots were aligned in a lucky way
by accident and the code became faster. <strong>It had nothing to do with optimizing
for size: These were by sheer accident that the hotspots got aligned better.</strong>
From now on, I will check the effects of alignment on my projects.</p>
<p>Oh, and one more thing. <strong>How can such hotspots arise, like the one shown in
the example? How can the inlining of such a tiny function like<code>add()</code> fail?</strong></p>
<p>Consider this:</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="n">add</span><span class="o">.</span><span class="n">cpp</span>
<span class="nb nb-Type">int</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>and in a separate file:</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">cpp</span>
<span class="nb nb-Type">int</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>

<span class="k">const</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">LOOP_BOUND</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200000000</span><span class="p">;</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
<span class="k">static</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">work</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">xval</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">yval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">LOOP_BOUND</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="n">xval</span><span class="o">+</span><span class="n">sum</span><span class="p">);</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">yval</span><span class="o">+</span><span class="n">sum</span><span class="p">);</span>
<span class="w">        </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb nb-Type">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nb">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">work</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>and compiled as: <code>g++ -O2 add.cpp main.cpp</code>.</p>
<p><strong>gcc won't inline<code>add()</code>!</strong></p>
<p>That's all, it's that easy to unintendedly create hotspots like the one in the
OP. <strong>Of course it is partly my fault: gcc is an excellent compiler.</strong> If
compile the above as: <code>g++ -O2 -flto add.cpp main.cpp</code>, that is, <strong>if I
perform link time optimization, the code runs in 0.19s!</strong></p>
<p>(Inlining is artificially disabled in the OP, hence, the code in the OP was 2x
slower).</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1604.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1602.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
