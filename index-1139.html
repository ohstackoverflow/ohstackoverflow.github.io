<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 1139) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-1139.html">
<link rel="prev" href="index-1140.html" type="text/html">
<link rel="next" href="index-1138.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/wu-fa-zai-dai-you-zi-qian-ming-zheng-shu-de-windows-shang-shi-yong-git-jie-jue-wu-fa-huo-qu-ben-di-ban-fa-zhe-zheng-shu/" class="u-url">无法在带有自签名证书的 Windows 上使用 git 解决“无法获取本地颁发者证书”</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/wu-fa-zai-dai-you-zi-qian-ming-zheng-shu-de-windows-shang-shi-yong-git-jie-jue-wu-fa-huo-qu-ben-di-ban-fa-zhe-zheng-shu/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T02:25:42+08:00" itemprop="datePublished" title="2023-02-18 02:25">2023-02-18 02:25</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>我在 Windows 上使用 Git。我安装了 msysGit 包。我的测试存储库在服务器上有一个自签名证书。我可以毫无问题地使用 HTTP
访问和使用存储库。移动到 HTTPS 会出现错误：</p>
<blockquote>
<p>SSL 证书问题：无法获取本地颁发者证书。</p>
</blockquote>
<p>我在 Windows 7 客户端计算机的受信任的根证书颁发机构中安装了自签名证书。我可以在 Internet Explorer 中浏览到 HTTPS 存储库
URL，而不会出现任何错误消息。</p>
<p>Philip Kelley 的这篇博文解释了 cURL 不使用客户端机器的证书存储。我按照博文的建议创建了一个私有副本<code>curl-ca-
bundle.crt</code>并配置 Git 以使用它。我确定 Git 正在使用我的副本。如果我重命名副本；Git 抱怨文件丢失。</p>
<p>我粘贴了我的证书，如博文中所述，我仍然收到消息“无法获得本地颁发者证书”。</p>
<p>我通过 HTTPS 克隆 GitHub 存储库来验证 Git 仍在工作。</p>
<p>我看到的唯一与博客文章不同的是我的证书 <em>是</em> 根证书——没有链可以到达它。我的证书最初来自单击 IIS8 IIS
管理器链接“创建自签名证书”。也许这使得证书在某种程度上与 cURL 所期望的有所不同。</p>
<p>如何让 Git/cURL 接受自签名证书？</p>
<p><br><br></p>
<h2>解答</h2>
<p>Using makecert for Development SSL 的答案为我解决了这个问题。</p>
<p>我不知道为什么，但是通过 IIS 管理器中简单的“创建自签名证书”链接创建的证书不起作用。我遵循了创建和安装自签名 CA Root
的链接问题中的方法；然后使用它为我的服务器颁发服务器身份验证证书。我在 IIS 中安装了它们。</p>
<p>这让我的情况与原始问题中引用的博客文章相同。一旦将根证书复制/粘贴到 curl-ca-bundle.crt 中，git/curl 组合就满足了。</p>
<p><br></p>
<h3>更多建议</h3>
<p>如果要完全禁用 SSL 验证，请打开 Git Bash 并运行命令。</p>
<div class="code"><pre class="code literal-block">git config --global http.sslVerify false
</pre></div>

<p><strong>注意：此解决方案使您容易受到中间人攻击等攻击</strong> 。因此尽快再次开启验证：</p>
<div class="code"><pre class="code literal-block">git config --global http.sslVerify true
</pre></div>

<p><br><br><a href="posts/unable-to-resolve-unable-to-get-local-issuer-certificate-using-git-on-windows-with-self-signed-certificate/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/" class="u-url">如何在 git 历史中查找/识别大型提交？</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T02:25:14+08:00" itemprop="datePublished" title="2023-02-18 02:25">2023-02-18 02:25</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>我有一个 300 MB 的 git 仓库。我当前签出的文件的总大小为 2 MB，其余 git 存储库的总大小为 298 MB。这基本上是一个不应超过几 MB
的纯代码回购。</p>
<p>我怀疑有人不小心提交了一些大文件（视频、图像等），然后删除了它们……但不是从 git 中删除的，所以历史记录仍然包含无用的大文件。如何在 git
历史记录中找到大文件？有 400 多个提交，所以一个一个地进行是不切实际的。</p>
<p><strong>注意</strong> ：我的问题 <strong> <em>不是关于 如何删除文件</em></strong>，而是如何首先 <strong> <em>找到它。</em></strong></p>
<p><br><br></p>
<h2>解答</h2>
<p>我发现这个脚本在过去对于在 git 存储库中查找大型（和不明显的）对象非常有用：</p>
<ul>
<li>http://stubbisms.wordpress.com/2009/07/10/git-script-to-show-largest-pack-objects-and-trim-your-waist-line/</li>
</ul>
<hr>
<div class="code"><table class="codetable">
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-1"><code data-line-number=" 1"></code></a></td>
<td class="code"><code><span class="ch">#!/bin/bash</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-2"><code data-line-number=" 2"></code></a></td>
<td class="code"><code><span class="c1">#set -x</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-3"><code data-line-number=" 3"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-4"><code data-line-number=" 4"></code></a></td>
<td class="code"><code><span class="c1"># Shows you the largest objects in your repo's pack file.</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-5"><code data-line-number=" 5"></code></a></td>
<td class="code"><code><span class="c1"># Written for osx.</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-6"><code data-line-number=" 6"></code></a></td>
<td class="code"><code><span class="c1">#</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-7"><code data-line-number=" 7"></code></a></td>
<td class="code"><code><span class="c1"># @see https://stubbisms.wordpress.com/2009/07/10/git-script-to-show-largest-pack-objects-and-trim-your-waist-line/</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-8"><code data-line-number=" 8"></code></a></td>
<td class="code"><code><span class="c1"># @author Antony Stubbs</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-9"><code data-line-number=" 9"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-10"><code data-line-number="10"></code></a></td>
<td class="code"><code><span class="c1"># set the internal field separator to line break, so that we can iterate easily over the verify-pack output</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-11"><code data-line-number="11"></code></a></td>
<td class="code"><code><span class="nv">IFS</span><span class="o">=</span><span class="s1">$'\n'</span><span class="p">;</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-12"><code data-line-number="12"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-13"><code data-line-number="13"></code></a></td>
<td class="code"><code><span class="c1"># list all objects including their size, sort by size, take top 10</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-14"><code data-line-number="14"></code></a></td>
<td class="code"><code><span class="nv">objects</span><span class="o">=</span><span class="sb">`</span>git<span class="w"> </span>verify-pack<span class="w"> </span>-v<span class="w"> </span>.git/objects/pack/pack-*.idx<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span>chain<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-k3nr<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="sb">`</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-15"><code data-line-number="15"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-16"><code data-line-number="16"></code></a></td>
<td class="code"><code><span class="nb">echo</span><span class="w"> </span><span class="s2">"All sizes are in kB's. The pack column is the size of the object, compressed, inside the pack file."</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-17"><code data-line-number="17"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-18"><code data-line-number="18"></code></a></td>
<td class="code"><code><span class="nv">output</span><span class="o">=</span><span class="s2">"size,pack,SHA,location"</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-19"><code data-line-number="19"></code></a></td>
<td class="code"><code><span class="nv">allObjects</span><span class="o">=</span><span class="sb">`</span>git<span class="w"> </span>rev-list<span class="w"> </span>--all<span class="w"> </span>--objects<span class="sb">`</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-20"><code data-line-number="20"></code></a></td>
<td class="code"><code><span class="k">for</span><span class="w"> </span>y<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$objects</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-21"><code data-line-number="21"></code></a></td>
<td class="code"><code><span class="k">do</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-22"><code data-line-number="22"></code></a></td>
<td class="code"><code><span class="w">    </span><span class="c1"># extract the size in bytes</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-23"><code data-line-number="23"></code></a></td>
<td class="code"><code><span class="w">    </span><span class="nv">size</span><span class="o">=</span><span class="k">$((</span><span class="sb">`</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$y</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f<span class="w"> </span><span class="m">5</span><span class="w"> </span>-d<span class="w"> </span><span class="s1">' '</span><span class="sb">`</span><span class="o">/</span><span class="m">1024</span><span class="k">))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-24"><code data-line-number="24"></code></a></td>
<td class="code"><code><span class="w">    </span><span class="c1"># extract the compressed size in bytes</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-25"><code data-line-number="25"></code></a></td>
<td class="code"><code><span class="w">    </span><span class="nv">compressedSize</span><span class="o">=</span><span class="k">$((</span><span class="sb">`</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$y</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f<span class="w"> </span><span class="m">6</span><span class="w"> </span>-d<span class="w"> </span><span class="s1">' '</span><span class="sb">`</span><span class="o">/</span><span class="m">1024</span><span class="k">))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-26"><code data-line-number="26"></code></a></td>
<td class="code"><code><span class="w">    </span><span class="c1"># extract the SHA</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-27"><code data-line-number="27"></code></a></td>
<td class="code"><code><span class="w">    </span><span class="nv">sha</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$y</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f<span class="w"> </span><span class="m">1</span><span class="w"> </span>-d<span class="w"> </span><span class="s1">' '</span><span class="sb">`</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-28"><code data-line-number="28"></code></a></td>
<td class="code"><code><span class="w">    </span><span class="c1"># find the objects location in the repository tree</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-29"><code data-line-number="29"></code></a></td>
<td class="code"><code><span class="w">    </span><span class="nv">other</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">allObjects</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="nv">$sha</span><span class="sb">`</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-30"><code data-line-number="30"></code></a></td>
<td class="code"><code><span class="w">    </span><span class="c1">#lineBreak=`echo -e "\n"`</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-31"><code data-line-number="31"></code></a></td>
<td class="code"><code><span class="w">    </span><span class="nv">output</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">output</span><span class="si">}</span><span class="s2">\n</span><span class="si">${</span><span class="nv">size</span><span class="si">}</span><span class="s2">,</span><span class="si">${</span><span class="nv">compressedSize</span><span class="si">}</span><span class="s2">,</span><span class="si">${</span><span class="nv">other</span><span class="si">}</span><span class="s2">"</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-32"><code data-line-number="32"></code></a></td>
<td class="code"><code><span class="k">done</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-33"><code data-line-number="33"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="posts/ru-he-zai-git-li-shi-zhong-cha-zhao-shi-bie-da-xing-ti-jiao/#-34"><code data-line-number="34"></code></a></td>
<td class="code"><code><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="nv">$output</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>column<span class="w"> </span>-t<span class="w"> </span>-s<span class="w"> </span><span class="s1">', '</span>
</code></td>
</tr>
</table></div>
<hr>
<p>这将为您提供 blob 的对象名称 (SHA1sum)，然后您可以使用如下脚本：</p>
<ul>
<li>哪个提交有这个斑点？</li>
</ul>
<p>...找到指向每个 blob 的提交。</p>
<p><br></p>
<h3>更多建议</h3>
<p>我在ETH Zurich Department of Physics 维基页面（接近该页面末尾）上找到了一个单行解决方案。只是做一个<code>git
gc</code>删除陈旧的垃圾，然后</p>
<div class="code"><pre class="code literal-block">git rev-list --objects --all \
  | grep "$(git verify-pack -v .git/objects/pack/*.idx \
           | sort -k 3 -n \
           | tail -10 \
           | awk '{print$1}')"
</pre></div>

<p>将为您提供存储库中的 10 个最大文件。</p>
<p>现在还有一个更懒惰的解决方案可用，GitExtensions现在有一个插件可以在 UI 中执行此操作（并且还可以处理历史记录重写）。</p>
<p><img alt="GitExtensions“查找大文件”对话框" src="images/mzKsE.png"></p>
<p><br><br><a href="posts/how-to-find-identify-large-commits-in-git-history/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/ru-he-xuan-zhuan-shu-ju-kuang/" class="u-url">如何旋转数据框？</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/ru-he-xuan-zhuan-shu-ju-kuang/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T02:24:48+08:00" itemprop="datePublished" title="2023-02-18 02:24">2023-02-18 02:24</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <ul>
<li>什么是支点？</li>
<li>我如何旋转？</li>
<li>长格式到宽格式？</li>
</ul>
<p>我见过很多关于数据透视表的问题，即使他们不知道。几乎不可能写出涵盖旋转所有方面的规范问答……但我打算试一试。</p>
<hr>
<p>现有问题和答案的问题在于，问题通常集中在 OP
难以概括的细微差别上，以便使用许多现有的好的答案。但是，没有一个答案试图给出全面的解释（因为这是一项艰巨的任务）。看看我的谷歌搜索中的几个例子：</p>
<ol>
<li>如何在 Pandas 中旋转数据框？- 很好的问答。但答案只回答了具体问题，几乎没有解释。</li>
<li>pandas 数据透视表到数据框- OP 关注数据透视表的输出，即列的外观。OP 希望它看起来像 R。这对 pandas 用户不是很有帮助。</li>
<li>pandas pivoting a dataframe, duplicate rows - 另一个不错的问题，但答案集中在一种方法上，即<code>pd.DataFrame.pivot</code>
</li>
</ol>
<hr>
<h3>设置</h3>
<p>我明显地命名了我的列和相关的列值，以与我将如何在下面的答案中进行调整相对应。</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">numpy.core.defchararray</span> <span class="kn">import</span> <span class="kp">add</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">seed</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">1415</span><span class="p">])</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([</span><span class="s1">'key'</span><span class="p">,</span> <span class="s1">'row'</span><span class="p">,</span> <span class="s1">'item'</span><span class="p">,</span> <span class="s1">'col'</span><span class="p">])</span>
<span class="n">arr1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="kp">randint</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="kp">size</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">//</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="kp">add</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">arr1</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span>
<span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="kp">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">'val'</span><span class="p">)</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>



     <span class="n">key</span>   <span class="n">row</span>   <span class="kp">item</span>   <span class="n">col</span>  <span class="n">val0</span>  <span class="n">val1</span>
<span class="mi">0</span>   <span class="n">key0</span>  <span class="n">row3</span>  <span class="n">item1</span>  <span class="n">col3</span>  <span class="mf">0.81</span>  <span class="mf">0.04</span>
<span class="mi">1</span>   <span class="n">key1</span>  <span class="n">row2</span>  <span class="n">item1</span>  <span class="n">col2</span>  <span class="mf">0.44</span>  <span class="mf">0.07</span>
<span class="mi">2</span>   <span class="n">key1</span>  <span class="n">row0</span>  <span class="n">item1</span>  <span class="n">col0</span>  <span class="mf">0.77</span>  <span class="mf">0.01</span>
<span class="mi">3</span>   <span class="n">key0</span>  <span class="n">row4</span>  <span class="n">item0</span>  <span class="n">col2</span>  <span class="mf">0.15</span>  <span class="mf">0.59</span>
<span class="mi">4</span>   <span class="n">key1</span>  <span class="n">row0</span>  <span class="n">item2</span>  <span class="n">col1</span>  <span class="mf">0.81</span>  <span class="mf">0.64</span>
<span class="mi">5</span>   <span class="n">key1</span>  <span class="n">row2</span>  <span class="n">item2</span>  <span class="n">col4</span>  <span class="mf">0.13</span>  <span class="mf">0.88</span>
<span class="mi">6</span>   <span class="n">key2</span>  <span class="n">row4</span>  <span class="n">item1</span>  <span class="n">col3</span>  <span class="mf">0.88</span>  <span class="mf">0.39</span>
<span class="mi">7</span>   <span class="n">key1</span>  <span class="n">row4</span>  <span class="n">item1</span>  <span class="n">col1</span>  <span class="mf">0.10</span>  <span class="mf">0.07</span>
<span class="mi">8</span>   <span class="n">key1</span>  <span class="n">row0</span>  <span class="n">item2</span>  <span class="n">col4</span>  <span class="mf">0.65</span>  <span class="mf">0.02</span>
<span class="mi">9</span>   <span class="n">key1</span>  <span class="n">row2</span>  <span class="n">item0</span>  <span class="n">col2</span>  <span class="mf">0.35</span>  <span class="mf">0.61</span>
<span class="mi">10</span>  <span class="n">key2</span>  <span class="n">row0</span>  <span class="n">item2</span>  <span class="n">col1</span>  <span class="mf">0.40</span>  <span class="mf">0.85</span>
<span class="mi">11</span>  <span class="n">key2</span>  <span class="n">row4</span>  <span class="n">item1</span>  <span class="n">col2</span>  <span class="mf">0.64</span>  <span class="mf">0.25</span>
<span class="mi">12</span>  <span class="n">key0</span>  <span class="n">row2</span>  <span class="n">item2</span>  <span class="n">col3</span>  <span class="mf">0.50</span>  <span class="mf">0.44</span>
<span class="mi">13</span>  <span class="n">key0</span>  <span class="n">row4</span>  <span class="n">item1</span>  <span class="n">col4</span>  <span class="mf">0.24</span>  <span class="mf">0.46</span>
<span class="mi">14</span>  <span class="n">key1</span>  <span class="n">row3</span>  <span class="n">item2</span>  <span class="n">col3</span>  <span class="mf">0.28</span>  <span class="mf">0.11</span>
<span class="mi">15</span>  <span class="n">key0</span>  <span class="n">row3</span>  <span class="n">item1</span>  <span class="n">col1</span>  <span class="mf">0.31</span>  <span class="mf">0.23</span>
<span class="mi">16</span>  <span class="n">key0</span>  <span class="n">row0</span>  <span class="n">item2</span>  <span class="n">col3</span>  <span class="mf">0.86</span>  <span class="mf">0.01</span>
<span class="mi">17</span>  <span class="n">key0</span>  <span class="n">row4</span>  <span class="n">item0</span>  <span class="n">col3</span>  <span class="mf">0.64</span>  <span class="mf">0.21</span>
<span class="mi">18</span>  <span class="n">key2</span>  <span class="n">row2</span>  <span class="n">item2</span>  <span class="n">col0</span>  <span class="mf">0.13</span>  <span class="mf">0.45</span>
<span class="mi">19</span>  <span class="n">key0</span>  <span class="n">row2</span>  <span class="n">item0</span>  <span class="n">col4</span>  <span class="mf">0.37</span>  <span class="mf">0.70</span>
</pre></div>

<h4>问题</h4>
<ol>
<li>
<p>为什么我得到<code>ValueError: Index contains duplicate entries, cannot reshape</code>？</p>
</li>
<li>
<p>我如何进行透视<code>df</code>以使<code>col</code>值是列，<code>row</code>值是索引，平均值<code>val0</code>是值？</p>
<div class="code"><pre class="code literal-block">col   col0   col1   col2   col3  col4
</pre></div>

<p>row
row0  0.77  0.605    NaN  0.860  0.65
row2  0.13    NaN  0.395  0.500  0.25
row3   NaN  0.310    NaN  0.545   NaN
row4   NaN  0.100  0.395  0.760  0.24</p>
</li>
<li>
<p>我该怎么做才能使缺失值是<code>0</code>？</p>
<div class="code"><pre class="code literal-block">col   col0   col1   col2   col3  col4
</pre></div>

<p>row
row0  0.77  0.605  0.000  0.860  0.65
row2  0.13  0.000  0.395  0.500  0.25
row3  0.00  0.310  0.000  0.545  0.00
row4  0.00  0.100  0.395  0.760  0.24</p>
</li>
<li>
<p><code>mean</code>除了诸如 maybe之外，我还能得到其他东西吗<code>sum</code>？</p>
<div class="code"><pre class="code literal-block">col   col0  col1  col2  col3  col4
</pre></div>

<p>row
row0  0.77  1.21  0.00  0.86  0.65
row2  0.13  0.00  0.79  0.50  0.50
row3  0.00  0.31  0.00  1.09  0.00
row4  0.00  0.10  0.79  1.52  0.24</p>
</li>
<li>
<p>我可以一次做更多的聚合吗？</p>
<div class="code"><pre class="code literal-block">       sum                          mean
</pre></div>

<p>col   col0  col1  col2  col3  col4  col0   col1   col2   col3  col4
row
row0  0.77  1.21  0.00  0.86  0.65  0.77  0.605  0.000  0.860  0.65
row2  0.13  0.00  0.79  0.50  0.50  0.13  0.000  0.395  0.500  0.25
row3  0.00  0.31  0.00  1.09  0.00  0.00  0.310  0.000  0.545  0.00
row4  0.00  0.10  0.79  1.52  0.24  0.00  0.100  0.395  0.760  0.24</p>
</li>
<li>
<p>我可以聚合多个值列吗？</p>
<div class="code"><pre class="code literal-block">      val0                             val1
</pre></div>

<p>col   col0   col1   col2   col3  col4  col0   col1  col2   col3  col4
row
row0  0.77  0.605  0.000  0.860  0.65  0.01  0.745  0.00  0.010  0.02
row2  0.13  0.000  0.395  0.500  0.25  0.45  0.000  0.34  0.440  0.79
row3  0.00  0.310  0.000  0.545  0.00  0.00  0.230  0.00  0.075  0.00
row4  0.00  0.100  0.395  0.760  0.24  0.00  0.070  0.42  0.300  0.46</p>
</li>
<li>
<p>我可以按多列细分吗？</p>
<div class="code"><pre class="code literal-block">item item0             item1                         item2
</pre></div>

<p>col   col2  col3  col4  col0  col1  col2  col3  col4  col0   col1  col3  col4
row
row0  0.00  0.00  0.00  0.77  0.00  0.00  0.00  0.00  0.00  0.605  0.86  0.65
row2  0.35  0.00  0.37  0.00  0.00  0.44  0.00  0.00  0.13  0.000  0.50  0.13
row3  0.00  0.00  0.00  0.00  0.31  0.00  0.81  0.00  0.00  0.000  0.28  0.00
row4  0.15  0.64  0.00  0.00  0.10  0.64  0.88  0.24  0.00  0.000  0.00  0.00</p>
</li>
<li>
<p>或者</p>
<div class="code"><pre class="code literal-block">item      item0             item1                         item2
</pre></div>

<p>col        col2  col3  col4  col0  col1  col2  col3  col4  col0  col1  col3  col4
key  row
key0 row0  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.86  0.00
     row2  0.00  0.00  0.37  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.50  0.00
     row3  0.00  0.00  0.00  0.00  0.31  0.00  0.81  0.00  0.00  0.00  0.00  0.00
     row4  0.15  0.64  0.00  0.00  0.00  0.00  0.00  0.24  0.00  0.00  0.00  0.00
key1 row0  0.00  0.00  0.00  0.77  0.00  0.00  0.00  0.00  0.00  0.81  0.00  0.65
     row2  0.35  0.00  0.00  0.00  0.00  0.44  0.00  0.00  0.00  0.00  0.00  0.13
     row3  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.28  0.00
     row4  0.00  0.00  0.00  0.00  0.10  0.00  0.00  0.00  0.00  0.00  0.00  0.00
key2 row0  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.40  0.00  0.00
     row2  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.13  0.00  0.00  0.00
     row4  0.00  0.00  0.00  0.00  0.00  0.64  0.88  0.00  0.00  0.00  0.00  0.00</p>
</li>
<li>
<p>我可以聚合列和行一起出现的频率，也就是“交叉制表”吗？</p>
<div class="code"><pre class="code literal-block">col   col0  col1  col2  col3  col4
</pre></div>

<p>row
row0     1     2     0     1     1
row2     1     0     2     1     2
row3     0     1     0     2     0
row4     0     1     2     2     1</p>
</li>
<li>
<p>如何通过仅在两列上旋转来将 DataFrame 从长转换为宽？鉴于，</p>
<div class="code"><pre class="code literal-block"><span class="nv">np</span>.<span class="k">random</span>.<span class="nv">seed</span><span class="ss">(</span>[<span class="mi">3</span>,<span class="w"> </span><span class="mi">1415</span>]<span class="ss">)</span>
</pre></div>

<p>df2 = pd.DataFrame({'A': list('aaaabbbc'), 'B': np.random.choice(15, 8)})
df2
   A   B
0  a   0
1  a  11
2  a   2
3  a  11
4  b  10
5  b  10
6  b  14
7  c   7</p>
</li>
</ol>
<p>预期应该看起来像</p>
<div class="code"><pre class="code literal-block">          a     b    c
0   0.0  10.0  7.0
1  11.0  10.0  NaN
2   2.0  14.0  NaN
3  11.0   NaN  NaN
</pre></div>

<ol>
<li>之后如何将多个索引展平为单个索引<code>pivot</code>？</li>
</ol>
<p>从</p>
<div class="code"><pre class="code literal-block">       1  2
   1  1  2
a  2  1  1
b  2  1  0
c  1  0  0
</pre></div>

<p>到</p>
<div class="code"><pre class="code literal-block">       1|1  2|1  2|2
a    2    1    1
b    2    1    0
c    1    0    0
</pre></div>

<p><br><br></p>
<h2>解答</h2>
<p>这是我们可以用来转换的成语列表</p>
<ol>
<li>
<p><code>pd.DataFrame.pivot_table</code></p>
<ul>
<li>具有更直观 API的美化版本<code>groupby</code>。对于许多人来说，这是首选方法。这是开发人员的预期方法。</li>
<li>指定行级别、列级别、要聚合的值以及执行聚合的函数。</li>
<li>
<p><code>pd.DataFrame.groupby</code>+<code>pd.DataFrame.unstack</code></p>
</li>
<li>
<p>用于执行几乎任何类型的枢轴的良好通用方法</p>
</li>
<li>您指定将构成一个分组中的透视行级别和列级别的所有列。您可以通过选择要聚合的其余列和要执行聚合的函数来执行此操作。最后，您<code>unstack</code>可以设置列索引中的级别。</li>
<li>
<p><code>pd.DataFrame.set_index</code>+<code>pd.DataFrame.unstack</code></p>
</li>
<li>
<p>对某些人（包括我自己）来说方便且直观。无法处理重复的分组键。</p>
</li>
<li>与范例类似<code>groupby</code>，我们指定最终将成为行或列级别的所有列，并将它们设置为索引。然后我们<code>unstack</code>在列中设置我们想要的级别。如果剩余的索引级别或列级别不唯一，则此方法将失败。</li>
<li>
<p><code>pd.DataFrame.pivot</code></p>
</li>
<li>
<p>非常相似，因为<code>set_index</code>它共享重复键限制。API 也非常有限。它只需要<code>index</code>, <code>columns</code>,的标量值<code>values</code>。</p>
</li>
<li>类似于<code>pivot_table</code>我们选择要在其上进行透视的行、列和值的方法。但是，我们无法聚合，如果行或列不唯一，此方法将失败。</li>
<li>
<p><code>pd.crosstab</code></p>
</li>
<li>
<p>这是最纯粹的专业版本<code>pivot_table</code>，是执行多项任务的最直观方式。</p>
</li>
<li>
<p><code>pd.factorize</code>+<code>np.bincount</code></p>
</li>
<li>
<p>这是一种非常先进的技术，非常隐蔽但速度非常快。它不能在所有情况下都使用，但是当它可以使用并且您习惯使用它时，您将获得性能回报。</p>
</li>
<li>
<p><code>pd.get_dummies</code>+<code>pd.DataFrame.dot</code></p>
</li>
<li>
<p>我用它来巧妙地执行交叉制表。</p>
</li>
</ul>
</li>
</ol>
<p>也可以看看：</p>
<ul>
<li>重塑和数据透视表— pandas 用户指南</li>
</ul>
<hr>
<h4>问题一</h4>
<blockquote>
<p>为什么我得到<code>ValueError: Index contains duplicate entries, cannot reshape</code></p>
</blockquote>
<p>发生这种情况是因为 pandas 试图重新索引
a<code>columns</code>或<code>index</code>具有重复条目的对象。有多种方法可以执行枢轴。当要求其旋转的键重复时，其中一些不太适合。例如：考虑<code>pd.DataFrame.pivot</code>。我知道有重复的条目共享<code>row</code>和<code>col</code>值：</p>
<div class="code"><pre class="code literal-block">df.duplicated(['row', 'col']).any()

True
</pre></div>

<p>所以当我<code>pivot</code>使用</p>
<div class="code"><pre class="code literal-block">df.pivot(index='row', columns='col', values='val0')
</pre></div>

<p>我收到上面提到的错误。事实上，当我尝试执行相同的任务时，我得到了同样的错误：</p>
<div class="code"><pre class="code literal-block">df.set_index(['row', 'col'])['val0'].unstack()
</pre></div>

<hr>
<h3>例子</h3>
<p>对于每个后续问题，我要做的是使用<code>pd.DataFrame.pivot_table</code>. 然后我将提供替代方法来执行相同的任务。</p>
<h4>问题 2 和 3</h4>
<blockquote>
<p>我如何进行透视<code>df</code>以使<code>col</code>值是列，<code>row</code>值是索引，平均值<code>val0</code>是值？</p>
</blockquote>
<ul>
<li>
<p><code>pd.DataFrame.pivot_table</code></p>
<div class="code"><pre class="code literal-block">df.pivot_table(
values='val0', index='row', columns='col',
aggfunc='mean')
</pre></div>

<p>col   col0   col1   col2   col3  col4
row                                <br>
row0  0.77  0.605    NaN  0.860  0.65
row2  0.13    NaN  0.395  0.500  0.25
row3   NaN  0.310    NaN  0.545   NaN
row4   NaN  0.100  0.395  0.760  0.24</p>
<ul>
<li>
<code>aggfunc='mean'</code>是默认值，我不必设置它。我把它包括在内是为了明确。</li>
</ul>
</li>
</ul>
<blockquote>
<p>如何使缺失值为 0？</p>
</blockquote>
<ul>
<li>
<p><code>pd.DataFrame.pivot_table</code></p>
<ul>
<li>
<p><code>fill_value</code>默认情况下未设置。我倾向于适当地设置它。在这种情况下，我将其设置为<code>0</code>.</p>
<p>df.pivot_table(
values='val0', index='row', columns='col',
fill_value=0, aggfunc='mean')</p>
</li>
</ul>
<p>col   col0   col1   col2   col3  col4
row
row0  0.77  0.605  0.000  0.860  0.65
row2  0.13  0.000  0.395  0.500  0.25
row3  0.00  0.310  0.000  0.545  0.00
row4  0.00  0.100  0.395  0.760  0.24</p>
</li>
<li>
<p><code>pd.DataFrame.groupby</code></p>
<div class="code"><pre class="code literal-block">df.groupby(['row', 'col'])['val0'].mean().unstack(fill_value=0)
</pre></div>

</li>
<li>
<p><code>pd.crosstab</code></p>
<div class="code"><pre class="code literal-block">pd.crosstab(
index=df['row'], columns=df['col'],
values=df['val0'], aggfunc='mean').fillna(0)
</pre></div>

</li>
</ul>
<hr>
<h4>问题四</h4>
<blockquote>
<p><code>mean</code>除了诸如 maybe之外，我还能得到其他东西吗<code>sum</code>？</p>
</blockquote>
<ul>
<li>
<p><code>pd.DataFrame.pivot_table</code></p>
<div class="code"><pre class="code literal-block">df.pivot_table(
values='val0', index='row', columns='col',
fill_value=0, aggfunc='sum')
</pre></div>

<p>col   col0  col1  col2  col3  col4
row
row0  0.77  1.21  0.00  0.86  0.65
row2  0.13  0.00  0.79  0.50  0.50
row3  0.00  0.31  0.00  1.09  0.00
row4  0.00  0.10  0.79  1.52  0.24</p>
</li>
<li>
<p><code>pd.DataFrame.groupby</code></p>
<div class="code"><pre class="code literal-block">df.groupby(['row', 'col'])['val0'].sum().unstack(fill_value=0)
</pre></div>

</li>
<li>
<p><code>pd.crosstab</code></p>
<div class="code"><pre class="code literal-block">pd.crosstab(
index=df['row'], columns=df['col'],
values=df['val0'], aggfunc='sum').fillna(0)
</pre></div>

</li>
</ul>
<hr>
<h4>问题 5</h4>
<blockquote>
<p>我可以一次做更多的聚合吗？</p>
</blockquote>
<p>请注意，for<code>pivot_table</code>和<code>crosstab</code>I
需要传递可调用列表。另一方面，<code>groupby.agg</code>能够为有限数量的特殊函数获取字符串。<code>groupby.agg</code>也会采用我们传递给其他人的相同可调用对象，但利用字符串函数名称通常更有效，因为可以提高效率。</p>
<ul>
<li>
<p><code>pd.DataFrame.pivot_table</code></p>
<div class="code"><pre class="code literal-block">df.pivot_table(
values='val0', index='row', columns='col',
fill_value=0, aggfunc=[np.size, np.mean])

 size                      mean
</pre></div>

<p>col  col0 col1 col2 col3 col4  col0   col1   col2   col3  col4
row
row0    1    2    0    1    1  0.77  0.605  0.000  0.860  0.65
row2    1    0    2    1    2  0.13  0.000  0.395  0.500  0.25
row3    0    1    0    2    0  0.00  0.310  0.000  0.545  0.00
row4    0    1    2    2    1  0.00  0.100  0.395  0.760  0.24</p>
</li>
<li>
<p><code>pd.DataFrame.groupby</code></p>
<div class="code"><pre class="code literal-block">df.groupby(['row', 'col'])['val0'].agg(['size', 'mean']).unstack(fill_value=0)
</pre></div>

</li>
<li>
<p><code>pd.crosstab</code></p>
<div class="code"><pre class="code literal-block">pd.crosstab(
index=df['row'], columns=df['col'],
values=df['val0'], aggfunc=[np.size, np.mean]).fillna(0, downcast='infer')
</pre></div>

</li>
</ul>
<hr>
<h4>问题 6</h4>
<blockquote>
<p>我可以聚合多个值列吗？</p>
</blockquote>
<ul>
<li>
<p><code>pd.DataFrame.pivot_table</code>我们通过了<code>values=['val0', 'val1']</code>，但我们本可以完全忽略它</p>
<div class="code"><pre class="code literal-block">df.pivot_table(
values=['val0', 'val1'], index='row', columns='col',
fill_value=0, aggfunc='mean')

  val0                             val1
</pre></div>

<p>col   col0   col1   col2   col3  col4  col0   col1  col2   col3  col4
row
row0  0.77  0.605  0.000  0.860  0.65  0.01  0.745  0.00  0.010  0.02
row2  0.13  0.000  0.395  0.500  0.25  0.45  0.000  0.34  0.440  0.79
row3  0.00  0.310  0.000  0.545  0.00  0.00  0.230  0.00  0.075  0.00
row4  0.00  0.100  0.395  0.760  0.24  0.00  0.070  0.42  0.300  0.46</p>
</li>
<li>
<p><code>pd.DataFrame.groupby</code></p>
<div class="code"><pre class="code literal-block">df.groupby(['row', 'col'])['val0', 'val1'].mean().unstack(fill_value=0)
</pre></div>

</li>
</ul>
<hr>
<h4>问题 7</h4>
<blockquote>
<p>我可以按多列细分吗？</p>
</blockquote>
<ul>
<li>
<p><code>pd.DataFrame.pivot_table</code></p>
<div class="code"><pre class="code literal-block">df.pivot_table(
values='val0', index='row', columns=['item', 'col'],
fill_value=0, aggfunc='mean')
</pre></div>

<p>item item0             item1                         item2
col   col2  col3  col4  col0  col1  col2  col3  col4  col0   col1  col3  col4
row
row0  0.00  0.00  0.00  0.77  0.00  0.00  0.00  0.00  0.00  0.605  0.86  0.65
row2  0.35  0.00  0.37  0.00  0.00  0.44  0.00  0.00  0.13  0.000  0.50  0.13
row3  0.00  0.00  0.00  0.00  0.31  0.00  0.81  0.00  0.00  0.000  0.28  0.00
row4  0.15  0.64  0.00  0.00  0.10  0.64  0.88  0.24  0.00  0.000  0.00  0.00</p>
</li>
<li>
<p><code>pd.DataFrame.groupby</code></p>
<div class="code"><pre class="code literal-block">df.groupby(
['row', 'item', 'col']
</pre></div>

<p>)['val0'].mean().unstack(['item', 'col']).fillna(0).sort_index(1)</p>
</li>
</ul>
<hr>
<h4>问题 8</h4>
<blockquote>
<p>我可以按多列细分吗？</p>
</blockquote>
<ul>
<li>
<p><code>pd.DataFrame.pivot_table</code></p>
<div class="code"><pre class="code literal-block">df.pivot_table(
values='val0', index=['key', 'row'], columns=['item', 'col'],
fill_value=0, aggfunc='mean')
</pre></div>

<p>item      item0             item1                         item2
col        col2  col3  col4  col0  col1  col2  col3  col4  col0  col1  col3  col4
key  row
key0 row0  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.86  0.00
     row2  0.00  0.00  0.37  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.50  0.00
     row3  0.00  0.00  0.00  0.00  0.31  0.00  0.81  0.00  0.00  0.00  0.00  0.00
     row4  0.15  0.64  0.00  0.00  0.00  0.00  0.00  0.24  0.00  0.00  0.00  0.00
key1 row0  0.00  0.00  0.00  0.77  0.00  0.00  0.00  0.00  0.00  0.81  0.00  0.65
     row2  0.35  0.00  0.00  0.00  0.00  0.44  0.00  0.00  0.00  0.00  0.00  0.13
     row3  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.28  0.00
     row4  0.00  0.00  0.00  0.00  0.10  0.00  0.00  0.00  0.00  0.00  0.00  0.00
key2 row0  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.40  0.00  0.00
     row2  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.13  0.00  0.00  0.00
     row4  0.00  0.00  0.00  0.00  0.00  0.64  0.88  0.00  0.00  0.00  0.00  0.00</p>
</li>
<li>
<p><code>pd.DataFrame.groupby</code></p>
<div class="code"><pre class="code literal-block">df.groupby(
['key', 'row', 'item', 'col']
</pre></div>

<p>)['val0'].mean().unstack(['item', 'col']).fillna(0).sort_index(1)</p>
</li>
<li>
<p><code>pd.DataFrame.set_index</code>因为键集对于行和列都是唯一的</p>
<div class="code"><pre class="code literal-block">df.set_index(
['key', 'row', 'item', 'col']
</pre></div>

<p>)['val0'].unstack(['item', 'col']).fillna(0).sort_index(1)</p>
</li>
</ul>
<hr>
<h4>问题9</h4>
<blockquote>
<p>我可以聚合列和行一起出现的频率，也就是“交叉制表”吗？</p>
</blockquote>
<ul>
<li>
<p><code>pd.DataFrame.pivot_table</code></p>
<div class="code"><pre class="code literal-block">df.pivot_table(index='row', columns='col', fill_value=0, aggfunc='size')
</pre></div>

<p>col   col0  col1  col2  col3  col4
row
row0     1     2     0     1     1
row2     1     0     2     1     2
row3     0     1     0     2     0
row4     0     1     2     2     1</p>
</li>
<li>
<p><code>pd.DataFrame.groupby</code></p>
<div class="code"><pre class="code literal-block">df.groupby(['row', 'col'])['val0'].size().unstack(fill_value=0)
</pre></div>

</li>
<li>
<p><code>pd.crosstab</code></p>
<div class="code"><pre class="code literal-block">pd.crosstab(df['row'], df['col'])
</pre></div>

</li>
<li>
<p><code>pd.factorize</code>+<code>np.bincount</code></p>
<div class="code"><pre class="code literal-block"><span class="c1"># get integer factorization `i` and unique values `r`</span>
</pre></div>

<h2>for column <code>'row'</code>
</h2>
<p>i, r = pd.factorize(df['row'].values)</p>
<h2>get integer factorization <code>j</code> and unique values <code>c</code>
</h2>
<h2>for column <code>'col'</code>
</h2>
<p>j, c = pd.factorize(df['col'].values)</p>
<h2>
<code>n</code> will be the number of rows</h2>
<h2>
<code>m</code> will be the number of columns</h2>
<p>n, m = r.size, c.size</p>
<h2>
<code>i * m + j</code> is a clever way of counting the</h2>
<h2>factorization bins assuming a flat array of length</h2>
<h2>
<code>n * m</code>.  Which is why we subsequently reshape as <code>(n, m)</code>
</h2>
<p>b = np.bincount(i * m + j, minlength=n * m).reshape(n, m)</p>
<h2>BTW, whenever I read this, I think 'Bean, Rice, and Cheese'</h2>
<p>pd.DataFrame(b, r, c)</p>
<div class="code"><pre class="code literal-block">  col3  col2  col0  col1  col4
</pre></div>

<p>row3     2     0     0     1     0
row2     1     2     1     0     2
row0     1     0     1     2     1
row4     2     2     0     1     1</p>
</li>
<li>
<p><code>pd.get_dummies</code></p>
<div class="code"><pre class="code literal-block">pd.get_dummies(df['row']).T.dot(pd.get_dummies(df['col']))

  col0  col1  col2  col3  col4
</pre></div>

<p>row0     1     2     0     1     1
row2     1     0     2     1     2
row3     0     1     0     2     0
row4     0     1     2     2     1</p>
</li>
</ul>
<hr>
<h4>问题10</h4>
<blockquote>
<p>如何通过仅在两列上旋转来将 DataFrame 从长转换为宽？</p>
</blockquote>
<ul>
<li><code>DataFrame.pivot</code></li>
</ul>
<p>第一步是为每一行分配一个数字——这个数字将是旋转结果中该值的行索引。这是使用以下方法完成的<code>GroupBy.cumcount</code>：</p>
<div class="code"><pre class="code literal-block">    df2.insert(0, 'count', df2.groupby('A').cumcount())
df2

   count  A   B
0      0  a   0
1      1  a  11
2      2  a   2
3      3  a  11
4      0  b  10
5      1  b  10
6      2  b  14
7      0  c   7
</pre></div>

<p>第二步，将新建的列作为索引调用<code>DataFrame.pivot</code>。</p>
<div class="code"><pre class="code literal-block">    df2.pivot(*df2)
# df2.pivot(index='count', columns='A', values='B')

A         a     b    c
count
0       0.0  10.0  7.0
1      11.0  10.0  NaN
2       2.0  14.0  NaN
3      11.0   NaN  NaN
</pre></div>

<ul>
<li><code>DataFrame.pivot_table</code></li>
</ul>
<p>而<code>DataFrame.pivot</code>仅接受列，<code>DataFrame.pivot_table</code>也接受数组，因此<code>GroupBy.cumcount</code>可以直接将
传递为 而<code>index</code>无需创建显式列。</p>
<div class="code"><pre class="code literal-block">    df2.pivot_table(index=df2.groupby('A').cumcount(), columns='A', values='B')

A         a     b    c
0       0.0  10.0  7.0
1      11.0  10.0  NaN
2       2.0  14.0  NaN
3      11.0   NaN  NaN
</pre></div>

<hr>
<h4>问题11</h4>
<blockquote>
<p>之后如何将多个索引展平为单个索引<code>pivot</code></p>
</blockquote>
<p>如果<code>columns</code>输入<code>object</code>字符串<code>join</code></p>
<div class="code"><pre class="code literal-block">df.columns = df.columns.map('|'.join)
</pre></div>

<p>别的<code>format</code></p>
<div class="code"><pre class="code literal-block">df.columns = df.columns.map('{0[0]}|{0[1]}'.format)
</pre></div>

<p><br></p>
<h3>更多建议</h3>
<p>扩展@piRSquared 的答案另一个版本的 <strong>问题 10</strong></p>
<h4>问题 10.1</h4>
<p>数据框：</p>
<div class="code"><pre class="code literal-block">d = data = {'A': {0: 1, 1: 1, 2: 1, 3: 2, 4: 2, 5: 3, 6: 5},
 'B': {0: 'a', 1: 'b', 2: 'c', 3: 'a', 4: 'b', 5: 'a', 6: 'c'}}
df = pd.DataFrame(d)

   A  B
0  1  a
1  1  b
2  1  c
3  2  a
4  2  b
5  3  a
6  5  c
</pre></div>

<p>输出：</p>
<div class="code"><pre class="code literal-block">   0     1     2
A
1  a     b     c
2  a     b  None
3  a  None  None
5  c  None  None
</pre></div>

<hr>
<p>使用<code>df.groupby</code>和<code>pd.Series.tolist</code></p>
<div class="code"><pre class="code literal-block">t = df.groupby('A')['B'].apply(list)
out = pd.DataFrame(t.tolist(),index=t.index)
out
   0     1     2
A
1  a     b     c
2  a     b  None
3  a  None  None
5  c  None  None
</pre></div>

<p><code>pd.pivot_table</code>或者使用with更好的选择<code>df.squeeze.</code></p>
<div class="code"><pre class="code literal-block">t = df.pivot_table(index='A',values='B',aggfunc=list).squeeze()
out = pd.DataFrame(t.tolist(),index=t.index)
</pre></div>

<p><br><br><a href="posts/how-can-i-pivot-a-dataframe/">查看原文</a></p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-1140.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1138.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
