<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 2576) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-2576.html">
<link rel="prev" href="index-2577.html" type="text/html">
<link rel="next" href="index-2575.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/add-a-reference-column-migration-in-rails-4/" class="u-url">Add a reference column migration in Rails 4</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/add-a-reference-column-migration-in-rails-4/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T02:15:09+08:00" itemprop="datePublished" title="2023-03-05 02:15">2023-03-05 02:15</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>A user has many uploads. I want to add a column to the <code>uploads</code> table that
references the <code>user</code>. What should the migration look like?</p>
<p>Here is what I have. I'm not sure if I should use (1) <code>:user_id, :int</code> or (2)
<code>:user, :references</code>. I'm not even sure if (2) works. Just trying to do this
the "rails" way.</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">AddUserToUploads</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ActiveRecord</span><span class="p">::</span><span class="n">Migration</span>
<span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="n">change</span>
<span class="w">    </span><span class="n">add_column</span><span class="w"> </span><span class="p">:</span><span class="n">uploads</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="n">integer</span>
<span class="w">  </span><span class="n">end</span>
<span class="n">end</span>
</pre></div>

<p>Relevant question except for Rails 3. Rails 3 migrations: Adding reference
column?</p>
<p><br><br></p>
<h2>Answer</h2>
<p><strong>Rails 4.x</strong></p>
<p>When you <strong>already have</strong> <code>users</code> and <code>uploads</code> tables and wish to <strong>add a new
relationship</strong> between them.</p>
<p>All you need to do is: just generate a migration using the following command:</p>
<div class="code"><pre class="code literal-block"><span class="n">rails</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="n">migration</span><span class="w"> </span><span class="n">AddUserToUploads</span><span class="w"> </span><span class="n">user</span><span class="p">:</span><span class="n">references</span>
</pre></div>

<p>Which will create a migration file as:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">AddUserToUploads</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ActiveRecord</span><span class="p">::</span><span class="n">Migration</span>
<span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="n">change</span>
<span class="w">    </span><span class="n">add_reference</span><span class="w"> </span><span class="p">:</span><span class="n">uploads</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
<span class="w">  </span><span class="n">end</span>
<span class="n">end</span>
</pre></div>

<p>Then, run the migration using <code>rake db:migrate</code>. This migration will take care
of adding a new column named <code>user_id</code> to <code>uploads</code> table (referencing <code>id</code>
column in <code>users</code> table), PLUS it will also add an index on the new column.</p>
<p><strong>UPDATE [For Rails 4.2]</strong></p>
<p>Rails can’t be trusted to maintain referential integrity; <em>relational
databases</em> come to our rescue here. What that means is that we can add foreign
key constraints at the <em>database level</em> itself and ensure that database would
reject any operation that violates this set referential integrity. As @infoget
commented, <strong>Rails 4.2</strong> ships with native support for <em>foreign
keys(referential integrity)</em>. It's not required but you might want to add
foreign key(as it's very useful) to the reference that we created above.</p>
<p>To add foreign key to an <em>existing reference</em> , create a new migration to add
a foreign key:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">AddForeignKeyToUploads</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ActiveRecord</span><span class="p">::</span><span class="n">Migration</span>
<span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="n">change</span>
<span class="w">    </span><span class="n">add_foreign_key</span><span class="w"> </span><span class="p">:</span><span class="n">uploads</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="n">users</span>
<span class="w">  </span><span class="n">end</span>
<span class="n">end</span>
</pre></div>

<p>To create a completely <em>brand new reference with a foreign key(in Rails 4.2)</em>
, generate a migration using the following command:</p>
<div class="code"><pre class="code literal-block"><span class="n">rails</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="n">migration</span><span class="w"> </span><span class="n">AddUserToUploads</span><span class="w"> </span><span class="n">user</span><span class="p">:</span><span class="n">references</span>
</pre></div>

<p>which will create a migration file as:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">AddUserToUploads</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ActiveRecord</span><span class="p">::</span><span class="n">Migration</span>
<span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="n">change</span>
<span class="w">    </span><span class="n">add_reference</span><span class="w"> </span><span class="p">:</span><span class="n">uploads</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
<span class="w">    </span><span class="n">add_foreign_key</span><span class="w"> </span><span class="p">:</span><span class="n">uploads</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="n">users</span>
<span class="w">  </span><span class="n">end</span>
<span class="n">end</span>
</pre></div>

<p>This will add a new foreign key to the <code>user_id</code> column of the <code>uploads</code>
table. The key references the <code>id</code> column in <code>users</code> table.</p>
<p><strong>NOTE:</strong> This is in addition to adding a reference so you still need to
<strong>create a reference first then foreign key</strong> ( <em>you can choose to create a
foreign key in the same migration or a separate migration file</em> ). Active
Record only supports single column foreign keys and currently only <code>mysql</code>,
<code>mysql2</code> and <code>PostgreSQL</code> adapters are supported. Don't try this with other
adapters like <code>sqlite3</code>, etc. Refer to Rails Guides: Foreign Keys for your
reference.</p>
<p><br></p>
<h3>Suggest</h3>
<h3>Rails 5</h3>
<p>You can still use this command to create the migration:</p>
<div class="code"><pre class="code literal-block"><span class="n">rails</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="n">migration</span><span class="w"> </span><span class="n">AddUserToUploads</span><span class="w"> </span><span class="n">user</span><span class="p">:</span><span class="n">references</span>
</pre></div>

<p>The migration looks a bit different to before, but still works:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">AddUserToUploads</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ActiveRecord</span><span class="p">::</span><span class="n">Migration</span><span class="p">[</span><span class="mf">5.0</span><span class="p">]</span>
<span class="w">  </span><span class="n">def</span><span class="w"> </span><span class="n">change</span>
<span class="w">    </span><span class="n">add_reference</span><span class="w"> </span><span class="p">:</span><span class="n">uploads</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">foreign_key</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
<span class="w">  </span><span class="n">end</span>
<span class="n">end</span>
</pre></div>

<p>Note that it's <code>:user</code>, not <code>:user_id</code></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-do-you-convert-an-entire-directory-with-ffmpeg/" class="u-url">How do you convert an entire directory with ffmpeg?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-do-you-convert-an-entire-directory-with-ffmpeg/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T02:13:53+08:00" itemprop="datePublished" title="2023-03-05 02:13">2023-03-05 02:13</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>How do you convert an entire directory/folder with ffmpeg via command line or
with a batch script?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Previous answer will only create 1 output file called out.mov. To make a
separate output file for each old movie, try this.</p>
<div class="code"><pre class="code literal-block">for<span class="w"> </span>i<span class="w"> </span>in<span class="w"> </span>*.avi;
<span class="w">  </span>do<span class="w"> </span>name=`echo<span class="w"> </span>"<span class="nv">$i</span>"<span class="w"> </span>|<span class="w"> </span>cut<span class="w"> </span>-d'.'<span class="w"> </span>-f1`
<span class="w">  </span>echo<span class="w"> </span>"<span class="nv">$name</span>"
<span class="w">  </span>ffmpeg<span class="w"> </span>-i<span class="w"> </span>"<span class="nv">$i</span>"<span class="w"> </span>"<span class="cp">${</span><span class="n">name</span><span class="cp">}</span>.mov"
done
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>Previous answer will only create 1 output file called out.mov. To make a
separate output file for each old movie, try this.</p>
<div class="code"><pre class="code literal-block">for<span class="w"> </span>i<span class="w"> </span>in<span class="w"> </span>*.avi;
<span class="w">  </span>do<span class="w"> </span>name=`echo<span class="w"> </span>"<span class="nv">$i</span>"<span class="w"> </span>|<span class="w"> </span>cut<span class="w"> </span>-d'.'<span class="w"> </span>-f1`
<span class="w">  </span>echo<span class="w"> </span>"<span class="nv">$name</span>"
<span class="w">  </span>ffmpeg<span class="w"> </span>-i<span class="w"> </span>"<span class="nv">$i</span>"<span class="w"> </span>"<span class="cp">${</span><span class="n">name</span><span class="cp">}</span>.mov"
done
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/understanding-fragment-s-setretaininstance-boolean/" class="u-url">Understanding Fragment's setRetainInstance(boolean)</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/understanding-fragment-s-setretaininstance-boolean/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T02:12:33+08:00" itemprop="datePublished" title="2023-03-05 02:12">2023-03-05 02:12</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Starting with the documentation:</p>
<blockquote>
<p>public void setRetainInstance (boolean retain)</p>
<p>Control whether a fragment instance is retained across Activity re-creation
(such as from a configuration change). This can only be used with fragments
not in the back stack. If set, the fragment lifecycle will be slightly
different when an activity is recreated:</p>
<ul>
<li>onDestroy() will not be called (but onDetach() still will be, because
the fragment is being detached from its current activity).</li>
<li>onCreate(Bundle) will not be called since the fragment is not being re-
created.</li>
<li>onAttach(Activity) and onActivityCreated(Bundle) will still be called.
</li>
</ul>
</blockquote>
<p>I have some questions:</p>
<ul>
<li>
<p>Does the fragment also retain its view, or will this be recreated on configuration change? What exactly does "retained" mean?</p>
</li>
<li>
<p>Will the fragment be destroyed when the user leaves the activity?</p>
</li>
<li>
<p>Why doesn't it work with fragments on the back stack?</p>
</li>
<li>
<p>Which are the use cases where it makes sense to use this method?</p>
</li>
</ul>
<p><br><br></p>
<h2>Answer</h2>
<p>First of all, check out <strong>my post</strong> on retained Fragments. It might help.</p>
<p>Now to answer your questions:</p>
<blockquote>
<p>Does the fragment also retain its <del>view</del> state, or will this be recreated
on configuration change - what exactly is "retained"?</p>
</blockquote>
<p>Yes, the <code>Fragment</code>'s state will be retained across the configuration change.
Specifically, "retained" means that the fragment will <em>not</em> be destroyed on
configuration changes. That is, the <code>Fragment</code> will be <em>retained</em> even if the
configuration change causes the underlying <code>Activity</code> to be destroyed.</p>
<blockquote>
<p>Will the fragment be destroyed when the user leaves the activity?</p>
</blockquote>
<p>Just like <code>Activity</code>s, <code>Fragment</code>s may be destroyed by the system when memory
resources are low. Whether you have your fragments retain their instance state
across configuration changes will have no effect on whether or not the system
will destroy the <code>Fragment</code>s once you leave the <code>Activity</code>. If you leave the
<code>Activity</code> (i.e. by pressing the home button), the <code>Fragment</code>s may or may not
be destroyed. If you leave the <code>Activity</code> by pressing the back button (thus,
calling <code>finish()</code> and effectively destroying the <code>Activity</code>), all of the
<code>Activity</code>s attached <code>Fragment</code>s will also be destroyed.</p>
<blockquote>
<p>Why doesn't it work with fragments on the back stack?</p>
</blockquote>
<p>There are probably multiple reasons why it's not supported, but the most
obvious reason to me is that the <code>Activity</code> holds a reference to the
<code>FragmentManager</code>, and the <code>FragmentManager</code> manages the backstack. That is,
no matter if you choose to retain your <code>Fragment</code>s or not, the <code>Activity</code> (and
thus the <code>FragmentManager</code>'s backstack) will be destroyed on a configuration
change. Another reason why it might not work is because things might get
tricky if both retained fragments <em>and</em> non-retained fragments were allowed to
exist on the same backstack.</p>
<blockquote>
<p>Which are the use cases where it makes sense to use this method?</p>
</blockquote>
<p>Retained fragments can be quite useful for propagating state information —
especially thread management — across activity instances. For example, a
fragment can serve as a host for an instance of <code>Thread</code> or <code>AsyncTask</code>,
managing its operation. See <strong>my blog post</strong> on this topic for more
information.</p>
<p>In general, I would treat it similarly to using <code>onConfigurationChanged</code> with
an <code>Activity</code>... don't use it as a bandaid just because you are too lazy to
implement/handle an orientation change correctly. Only use it when you need
to.</p>
<p><br></p>
<h3>Suggest</h3>
<p><code>setRetaininstance</code> is only useful when your <code>activity</code> is destroyed and
recreated due to a configuration change because the instances are saved during
a call to <code>onRetainNonConfigurationInstance</code>. That is, if you rotate the
device, the retained fragments will remain there(they're not destroyed and
recreated.) but when the runtime kills the activity to reclaim resources,
nothing is left. When you press back button and exit the activity, everything
is destroyed.</p>
<p>Usually I use this function to saved orientation changing Time.Say I have
download a bunch of Bitmaps from server and each one is 1MB, when the user
accidentally rotate his device, I certainly don't want to do all the download
work again.So I create a <code>Fragment</code> holding my bitmaps and add it to the
manager and call <code>setRetainInstance</code>,all the Bitmaps are still there even if
the screen orientation changes.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2577.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2575.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
