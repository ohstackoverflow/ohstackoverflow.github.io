<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 2186) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-2186.html">
<link rel="prev" href="index-2187.html" type="text/html">
<link rel="next" href="index-2185.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/handling-errors-in-promise-all/" class="u-url">Handling errors in Promise.all</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/handling-errors-in-promise-all/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T21:22:37+08:00" itemprop="datePublished" title="2023-03-03 21:22">2023-03-03 21:22</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I have an array of Promises that I'm resolving with
<code>Promise.all(arrayOfPromises);</code></p>
<p>I go on to continue the promise chain. Looks something like this</p>
<div class="code"><pre class="code literal-block"><span class="n">existingPromiseChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">existingPromiseChain</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">var</span><span class="w"> </span><span class="n">arrayOfPromises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">route</span><span class="p">){</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">route</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">promiseHandler</span><span class="p">();</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">arrayOfPromises</span><span class="p">)</span>
<span class="p">});</span>

<span class="n">existingPromiseChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">existingPromiseChain</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">arrayResolved</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">stuff</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">resolved</span><span class="w"> </span><span class="n">promises</span><span class="p">,</span><span class="w"> </span><span class="n">eventually</span><span class="w"> </span><span class="n">ending</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">send</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>

<p>I want to add a catch statement to handle an individual promise in case it
errors, but when I try, <code>Promise.all</code> returns the first error it finds
(disregards the rest), and then I can't get the data from the rest of the
promises in the array (that didn't error).</p>
<p>I've tried doing something like ..</p>
<div class="code"><pre class="code literal-block"><span class="n">existingPromiseChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">existingPromiseChain</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">var</span><span class="w"> </span><span class="n">arrayOfPromises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">route</span><span class="p">){</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">route</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">promiseHandler</span><span class="p">()</span>
<span class="w">          </span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">          </span><span class="p">})</span>
<span class="w">          </span><span class="o">.</span><span class="n">catch</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="n">err</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">arrayOfPromises</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="n">existingPromiseChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">existingPromiseChain</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">arrayResolved</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="o">//</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">stuff</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">resolved</span><span class="w"> </span><span class="n">promises</span><span class="p">,</span><span class="w"> </span><span class="n">eventually</span><span class="w"> </span><span class="n">ending</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">send</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>

<p>But that doesn't resolve.</p>
<p>Thanks!</p>
<p>--</p>
<p>Edit:</p>
<p>What the answers below said were completely true, the code was breaking due to
other reasons. In case anyone is interested, this is the solution I ended up
with ...</p>
<p>Node Express Server Chain</p>
<div class="code"><pre class="code literal-block"><span class="n">serverSidePromiseChain</span>
<span class="w">    </span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">AppRouter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">arrayOfPromises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">route</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">route</span><span class="o">.</span><span class="n">async</span><span class="p">();</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">arrayOfPromises</span><span class="p">)</span>
<span class="w">            </span><span class="o">.</span><span class="n">catch</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="nb">log</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">entire</span><span class="w"> </span><span class="n">array</span><span class="p">;</span>
<span class="w">                </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">'A promise failed to resolve'</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">arrayOfPromises</span><span class="p">;</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">            </span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">arrayOfPromises</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">resolved</span><span class="w"> </span><span class="n">promises</span><span class="p">;</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">    </span><span class="p">};</span>
</pre></div>

<hr>
<p>API Call (route.async call)</p>
<div class="code"><pre class="code literal-block"><span class="k">return</span><span class="w"> </span><span class="nv">async</span><span class="ss">()</span>
<span class="w">    </span>.<span class="k">then</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nb">result</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nv">dispatch</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">success</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">result</span><span class="c1">;</span>
<span class="w">    </span>}<span class="ss">)</span>
<span class="w">    </span>.<span class="nv">catch</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">err</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nv">dispatch</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">failure</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">throw</span><span class="w"> </span><span class="nv">error</span>
<span class="w">        </span><span class="nv">throw</span><span class="w"> </span><span class="nv">err</span><span class="c1">;</span>
<span class="w">    </span>}<span class="ss">)</span><span class="c1">;</span>
</pre></div>

<p>Putting the <code>.catch</code> for <code>Promise.all</code> before the <code>.then</code> seems to have served
the purpose of catching any errors from the original promises, but then
returning the entire array to the next <code>.then</code></p>
<p>Thanks!</p>
<p><br><br></p>
<h2>Answer</h2>
<p><code>Promise.all</code> is all or nothing. It resolves once all promises in the array
resolve, or reject as soon as <em>one</em> of them rejects. In other words, it either
resolves with an array of all resolved values, or rejects with a single error.</p>
<p>Some libraries have something called <code>Promise.when</code>, which I understand would
instead wait for <em>all</em> promises in the array to either resolve or reject, but
I'm not familiar with it, and it's not in ES6.</p>
<p><strong>Your code</strong></p>
<p>I agree with others here that your fix should work. It should resolve with an
array that may contain a mix of successful values and errors objects. It's
unusual to pass error objects in the success-path but assuming your code is
expecting them, I see no problem with it.</p>
<p>The only reason I can think of why it would "not resolve" is that it's failing
in code you're not showing us and the reason you're not seeing any error
message about this is because this promise chain is not terminated with a
final catch (as far as what you're showing us anyway).</p>
<p>I've taken the liberty of factoring out the "existing chain" from your example
and terminating the chain with a catch. This may not be right for you, but for
people reading this, it's important to always either return or terminate
chains, or potential errors, even coding errors, will get hidden (which is
what I suspect happened here):</p>
<div class="code"><pre class="code literal-block"><span class="nf">Promise.all</span><span class="p">(</span><span class="no">state.routes.map</span><span class="p">(</span><span class="no">function</span><span class="p">(</span><span class="no">route</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nf">return</span><span class="w"> </span><span class="no">route.handler.promiseHandler</span><span class="p">().</span><span class="no">catch</span><span class="p">(</span><span class="no">function</span><span class="p">(</span><span class="no">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">return</span><span class="w"> </span><span class="no">err</span><span class="c1">;</span>
<span class="w">  </span><span class="err">})</span><span class="c1">;</span>
<span class="err">}))</span>
<span class="na">.then</span><span class="p">(</span><span class="no">function</span><span class="p">(</span><span class="no">arrayOfValuesOrErrors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// handling of my array containing values and/or errors. </span>
<span class="err">})</span>
<span class="na">.catch</span><span class="p">(</span><span class="no">function</span><span class="p">(</span><span class="no">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nf">console.log</span><span class="p">(</span><span class="no">err.message</span><span class="p">)</span><span class="c1">; // some coding error in handling happened</span>
<span class="err">})</span><span class="c1">;</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p><strong>NEW ANSWER</strong></p>
<div class="code"><pre class="code literal-block"><span class="k">const</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">promises</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">catch</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">e</span><span class="p">)));</span>
<span class="k">const</span><span class="w"> </span><span class="n">validResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="n">instanceof</span><span class="w"> </span><span class="n">Error</span><span class="p">));</span>
</pre></div>

<p><strong>FUTURE Promise API</strong></p>
<ul>
<li>Chrome 76: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled</li>
<li>You can download https://www.npmjs.com/package/promise.allsettled to get it now. In certain browsers allSettled comes preinstalled with the browser itself. It's worth downloading the package for peace of mind because eg. TypeScript doesn't have default definitions for allSettled.</li>
</ul>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/what-is-the-some-keyword-in-swift-ui/" class="u-url">What is the "some" keyword in Swift(UI)?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/what-is-the-some-keyword-in-swift-ui/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T21:21:02+08:00" itemprop="datePublished" title="2023-03-03 21:21">2023-03-03 21:21</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>The new SwiftUI tutorial has the following code:</p>
<div class="code"><pre class="code literal-block"><span class="n">struct</span><span class="w"> </span><span class="n">ContentView</span><span class="p">:</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">body</span><span class="p">:</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Text</span><span class="p">(</span><span class="s2">"Hello World"</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>The second line the word <code>some</code>, and on their site is highlighted as if it
were a keyword.</p>
<p>Swift 5.1 does not appear to have <code>some</code> as a keyword, and I don't see what
else the word <code>some</code> could be doing there, since it goes where the type
usually goes. Is there a new, unannounced version of Swift? Is it a function
that's being used on a type in a way I didn't know about?</p>
<p>What does the keyword <code>some</code> do?</p>
<p><br><br></p>
<h2>Answer</h2>
<p><code>some View</code> is an opaque result type as introduced by SE-0244 and is available
in Swift 5.1 with Xcode 11. You can think of this as being a "reverse" generic
placeholder.</p>
<p>Unlike a regular generic placeholder which is satisfied by the caller:</p>
<div class="code"><pre class="code literal-block"><span class="n">protocol</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{}</span>
<span class="n">struct</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{}</span>
<span class="n">struct</span><span class="w"> </span><span class="n">S2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{}</span>

<span class="k">func</span><span class="w"> </span><span class="n">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">P</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="n">foo</span><span class="p">(</span><span class="n">S1</span><span class="p">())</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Caller</span><span class="w"> </span><span class="n">chooses</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">S1</span><span class="o">.</span>
<span class="n">foo</span><span class="p">(</span><span class="n">S2</span><span class="p">())</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Caller</span><span class="w"> </span><span class="n">chooses</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">S2</span><span class="o">.</span>
</pre></div>

<p>An opaque result type is an implicit generic placeholder satisfied by the
<em>implementation</em> , so you can think of this:</p>
<div class="code"><pre class="code literal-block"><span class="k">func</span><span class="w"> </span><span class="n">bar</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">S1</span><span class="p">()</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Implementation</span><span class="w"> </span><span class="n">chooses</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">opaque</span><span class="w"> </span><span class="n">result</span><span class="o">.</span>
<span class="p">}</span>
</pre></div>

<p>as looking like this:</p>
<div class="code"><pre class="code literal-block"><span class="k">func</span><span class="w"> </span><span class="n">bar</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">P</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Output</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">S1</span><span class="p">()</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Implementation</span><span class="w"> </span><span class="n">chooses</span><span class="w"> </span><span class="n">Output</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">S1</span><span class="o">.</span>
<span class="p">}</span>
</pre></div>

<dl>
<dt>In fact, the eventual goal with this feature is to allow reverse generics in</dt>
<dt>this more explicit form, which would also let you add constraints, e.g `-&gt; &lt;T</dt>
<dd>Collection&gt; T where T.Element == Int`. See this post for more info.</dd>
</dl>
<p>The main thing to take away from this is that a function returning <code>some P</code> is
one that returns a value of a specific <em>single</em> concrete type that conforms to
<code>P</code>. Attempting to return different conforming types within the function
yields a compiler error:</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="n">declares</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">opaque</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">return</span>
<span class="o">//</span><span class="w"> </span><span class="n">statements</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">matching</span><span class="w"> </span><span class="n">underlying</span><span class="w"> </span><span class="n">types</span><span class="o">.</span>
<span class="k">func</span><span class="w"> </span><span class="n">bar</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">S1</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">S2</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>As the implicit generic placeholder cannot be satisfied by multiple types.</p>
<p>This is in contrast to a function returning <code>P</code>, which can be used to
represent <em>both</em> <code>S1</code> and <code>S2</code> because it represents an arbitrary <code>P</code>
conforming value:</p>
<div class="code"><pre class="code literal-block"><span class="k">func</span><span class="w"> </span><span class="n">baz</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">S1</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">S2</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Okay, so what benefits do opaque result types <code>-&gt; some P</code> have over protocol
return types <code>-&gt; P</code>?</p>
<hr>
<h4>1. Opaque result types can be used with PATs</h4>
<p>A major current limitation of protocols is that PATs (protocols with
associated types) cannot be used as actual types. Although this is a
restriction that will likely be lifted in a future version of the language,
because opaque result types are effectively just generic placeholders, they
can be used with PATs today.</p>
<p>This means you can do things like:</p>
<div class="code"><pre class="code literal-block"><span class="k">func</span><span class="w"> </span><span class="n">giveMeACollection</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">Collection</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">let</span><span class="w"> </span><span class="n">collection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">giveMeACollection</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">collection</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">3</span>
</pre></div>

<hr>
<h4>2. Opaque result types have identity</h4>
<p>Because opaque result types enforce a single concrete type is returned, the
compiler knows that two calls to the same function must return two values of
the same type.</p>
<p>This means you can do things like:</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w">   </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Equatable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Output</span><span class="w"> </span><span class="p">{</span>
<span class="k">func</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">Equatable</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">opaque</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">inferred</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">Int</span><span class="o">.</span>
<span class="p">}</span>

<span class="n">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span>
<span class="n">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Legal</span><span class="w"> </span><span class="n">both</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">foo</span><span class="o">.</span>
</pre></div>

<p>This is legal because the compiler knows that both <code>x</code> and <code>y</code> have the same
concrete type. This is an important requirement for <code>==</code>, where both
parameters of type <code>Self</code>.</p>
<div class="code"><pre class="code literal-block"><span class="n">protocol</span><span class="w"> </span><span class="n">Equatable</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">func</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">lhs</span><span class="p">:</span><span class="w"> </span><span class="n">Self</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span><span class="p">:</span><span class="w"> </span><span class="n">Self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Bool</span>
<span class="p">}</span>
</pre></div>

<p>This means that it expects two values that are both the same type as the
concrete conforming type. Even if <code>Equatable</code> were usable as a type, you
wouldn't be able to compare two arbitrary <code>Equatable</code> conforming values with
each other, for example:</p>
<div class="code"><pre class="code literal-block"><span class="k">func</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Equatable</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Assume</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">legal</span><span class="o">.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s2">"hello world"</span><span class="w">      </span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Illegal</span><span class="o">.</span>
</pre></div>

<p>As the compiler cannot prove that two arbitrary <code>Equatable</code> values have the
same underlying concrete type.</p>
<p>In a similar manner, if we introduced another opaque type returning function:</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w">   </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Output1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Equatable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Output1</span><span class="w"> </span><span class="p">{</span>
<span class="k">func</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">Equatable</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">opaque</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">inferred</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">Int</span><span class="o">.</span>
<span class="p">}</span>

<span class="o">//</span><span class="w">   </span><span class="n">bar</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Output2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Equatable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Output2</span><span class="w"> </span><span class="p">{</span>
<span class="k">func</span><span class="w"> </span><span class="n">bar</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">Equatable</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s2">""</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">opaque</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">inferred</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="o">.</span>
<span class="p">}</span>

<span class="n">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span>
<span class="n">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bar</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Illegal</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">bar</span><span class="o">.</span>
</pre></div>

<p>The example becomes illegal because although both <code>foo</code> and <code>bar</code> return <code>some
Equatable</code>, their "reverse" generic placeholders <code>Output1</code> and <code>Output2</code> could
be satisfied by different types.</p>
<hr>
<h4>3. Opaque result types compose with generic placeholders</h4>
<p>Unlike regular protocol-typed values, opaque result types compose well with
regular generic placeholders, for example:</p>
<div class="code"><pre class="code literal-block"><span class="n">protocol</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">var</span><span class="w"> </span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">struct</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">var</span><span class="w"> </span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span>
<span class="p">}</span>

<span class="k">func</span><span class="w"> </span><span class="n">makeP</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Opaque</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">inferred</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">S</span><span class="o">.</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="ow">in</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">..&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">func</span><span class="w"> </span><span class="n">bar</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">P</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="o">.</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">y</span><span class="o">.</span><span class="n">i</span><span class="w"> </span><span class="err">?</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">y</span>
<span class="p">}</span>

<span class="n">let</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeP</span><span class="p">()</span>
<span class="n">let</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeP</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bar</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Legal</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">inferred</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">makeP</span><span class="o">.</span>
</pre></div>

<p>This wouldn't have worked if <code>makeP</code> had just returned <code>P</code>, as two <code>P</code> values
may have different underlying concrete types, for example:</p>
<div class="code"><pre class="code literal-block"><span class="n">struct</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">var</span><span class="w"> </span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="n">Int</span>
<span class="p">}</span>

<span class="k">func</span><span class="w"> </span><span class="n">makeP</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">50</span><span class="p">:</span><span class="mi">50</span><span class="w"> </span><span class="n">chance</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">picking</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">branch</span><span class="o">.</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">T</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">let</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeP</span><span class="p">()</span>
<span class="n">let</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeP</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bar</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">))</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Illegal</span><span class="o">.</span>
</pre></div>

<hr>
<h4>Why use an opaque result type over the concrete type?</h4>
<p>At this point you may be thinking to yourself, why not just write the code as:</p>
<div class="code"><pre class="code literal-block"><span class="k">func</span><span class="w"> </span><span class="n">makeP</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

<p>Well, the use of an opaque result type allows you to make the type <code>S</code> an
implementation detail by exposing only the interface provided by <code>P</code>, giving
you flexibility of changing the concrete type later down the line without
breaking any code that depends on the function.</p>
<p>For example, you could replace:</p>
<div class="code"><pre class="code literal-block"><span class="k">func</span><span class="w"> </span><span class="n">makeP</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">S</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

<p>with:</p>
<div class="code"><pre class="code literal-block"><span class="k">func</span><span class="w"> </span><span class="n">makeP</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">T</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

<p>without breaking any code that calls <code>makeP()</code>.</p>
<p>See the Opaque Types section of the language guide and the Swift evolution
proposal for further information on this feature.</p>
<p><br></p>
<h3>Suggest</h3>
<p>The other answer does a good job of explaining the technical aspect of the new
<code>some</code> keyword but this answer will try to easily explain <em>why</em>.</p>
<hr>
<p>Let's say I have a protocol Animal and I want to compare if two animals are
siblings:</p>
<div class="code"><pre class="code literal-block"><span class="n">protocol</span><span class="w"> </span><span class="n">Animal</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">isSibling</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="n">animal</span><span class="p">:</span><span class="w"> </span><span class="n">Self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Bool</span>
<span class="p">}</span>
</pre></div>

<p>This way it <strong>only makes sense to compare if two animals are siblings if they
are the same type</strong> of animal.</p>
<hr>
<p>Now let me just create an example of an animal just for reference</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">Dog</span><span class="p">:</span><span class="w"> </span><span class="n">Animal</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">isSibling</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="n">animal</span><span class="p">:</span><span class="w"> </span><span class="n">Dog</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">true</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">doesn</span><span class="s1">'t really matter implementation of this</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h3>The way without <code>some T</code>
</h3>
<p>Now let's say I have a function that returns an animal from a 'family'.</p>
<div class="code"><pre class="code literal-block"><span class="k">func</span><span class="w"> </span><span class="n">animalFromAnimalFamily</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Animal</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">myDog</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">myDog</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="err">`</span><span class="n">Dog</span><span class="err">`</span>
<span class="p">}</span>
</pre></div>

<blockquote>
<p>Note: this function won't actually compile. This because before the 'some'
feature was added <strong>you cannot return a protocol type if the protocol uses
'Self' or generics</strong>. But let's say you can... pretending this upcasts myDog
to abstract type Animal, let's see what happens</p>
</blockquote>
<p>Now the issue comes is if I try to do this:</p>
<div class="code"><pre class="code literal-block">let animal1: Animal = animalFromAnimalFamily()
let animal2: Animal = animalFromAnimalFamily()

animal1.isSibling(animal2) // error
</pre></div>

<p><strong>This will throw an error</strong>.</p>
<p>Why? Well the reason is, when you call <code>animal1.isSibling(animal2)</code> Swift
doesn't know if the animals are dogs, cats, or whatever. <strong>As far as Swift
knows,<code>animal1</code> and <code>animal2</code> could be unrelated animal species</strong>. Since we
can't compare animals of different types (see above). This will error</p>
<h3>How <code>some T</code> solves this problem</h3>
<p>Let's rewrite the previous function:</p>
<div class="code"><pre class="code literal-block"><span class="k">func</span><span class="w"> </span><span class="n">animalFromAnimalFamily</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">Animal</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">myDog</span>
<span class="p">}</span>



<span class="n">let</span><span class="w"> </span><span class="n">animal1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">animalFromAnimalFamily</span><span class="p">()</span>
<span class="n">let</span><span class="w"> </span><span class="n">animal2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">animalFromAnimalFamily</span><span class="p">()</span>

<span class="n">animal1</span><span class="o">.</span><span class="n">isSibling</span><span class="p">(</span><span class="n">animal2</span><span class="p">)</span>
</pre></div>

<p><code>animal1</code> and <code>animal2</code> are <em>not</em> <code>Animal</code>, <em>but</em> <strong>they are class that
implements Animal</strong>.</p>
<p>What this lets you do now is when you call <code>animal1.isSibling(animal2)</code>, Swift
knows that <code>animal1</code> and <code>animal2</code> are the same type.</p>
<p>So the way I like to think about it:</p>
<blockquote>
<p><code>some T</code> lets <em>Swift</em> know the what implementation of <code>T</code> is being used but
the user of the class doesn't.</p>
</blockquote>
<p>(Self-promotion disclaimer) I've written a blog post that goes a little more
into depth (same example as here) on this new feature</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/why-does-the-order-of-the-loops-affect-performance-when-iterating-over-a-2d-array/" class="u-url">Why does the order of the loops affect performance when iterating over a 2D array?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/why-does-the-order-of-the-loops-affect-performance-when-iterating-over-a-2d-array/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T21:19:41+08:00" itemprop="datePublished" title="2023-03-03 21:19">2023-03-03 21:19</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Below are two programs that are almost identical except that I switched the
<code>i</code> and <code>j</code> variables around. They both run in different amounts of time.
Could someone explain why this happens?</p>
<p>Version 1</p>
<div class="code"><pre class="code literal-block"><span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="n">main</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">x</span><span class="o">[</span><span class="n">4000</span><span class="o">][</span><span class="n">4000</span><span class="o">]</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4000</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="n">x</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w"> </span><span class="err">}</span>
<span class="w">  </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>Version 2</p>
<div class="code"><pre class="code literal-block"><span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="n">main</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">x</span><span class="o">[</span><span class="n">4000</span><span class="o">][</span><span class="n">4000</span><span class="o">]</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4000</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">       </span><span class="n">x</span><span class="o">[</span><span class="n">j</span><span class="o">][</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w"> </span><span class="err">}</span>
<span class="w">   </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p><br><br></p>
<h2>Answer</h2>
<p>As others have said, the issue is the store to the memory location in the
array: <code>x[i][j]</code>. Here's a bit of insight why:</p>
<p>You have a 2-dimensional array, but memory in the computer is inherently
1-dimensional. So while you imagine your array like this:</p>
<div class="code"><pre class="code literal-block">0,0 | 0,1 | 0,2 | 0,3
----+-----+-----+----
1,0 | 1,1 | 1,2 | 1,3
----+-----+-----+----
2,0 | 2,1 | 2,2 | 2,3
</pre></div>

<p>Your computer stores it in memory as a single line:</p>
<div class="code"><pre class="code literal-block"><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="mf">2</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="mf">0</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="mf">1</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="mf">2</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="mf">3</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="mf">0</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="mf">1</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="mf">2</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span>
</pre></div>

<p>In the 2nd example, you access the array by looping over the 2nd number first,
i.e.:</p>
<div class="code"><pre class="code literal-block">x[0][0] 
        x[0][1]
                x[0][2]
                        x[0][3]
                                x[1][0] etc...
</pre></div>

<p>Meaning that you're hitting them all in order. Now look at the 1st version.
You're doing:</p>
<div class="code"><pre class="code literal-block">x[0][0]
                                x[1][0]
                                                                x[2][0]
        x[0][1]
                                        x[1][1] etc...
</pre></div>

<p>Because of the way C laid out the 2-d array in memory, you're asking it to
jump all over the place. But now for the kicker: Why does this matter? All
memory accesses are the same, right?</p>
<p>No: because of caches. Data from your memory gets brought over to the CPU in
little chunks (called 'cache lines'), typically 64 bytes. If you have 4-byte
integers, that means you're geting 16 consecutive integers in a neat little
bundle. It's actually fairly slow to fetch these chunks of memory; your CPU
can do a lot of work in the time it takes for a single cache line to load.</p>
<p>Now look back at the order of accesses: The second example is (1) grabbing a
chunk of 16 ints, (2) modifying all of them, (3) repeat 4000*4000/16 times.
That's nice and fast, and the CPU always has something to work on.</p>
<p>The first example is (1) grab a chunk of 16 ints, (2) modify only one of them,
(3) repeat 4000*4000 times. That's going to require 16 times the number of
"fetches" from memory. Your CPU will actually have to spend time sitting
around waiting for that memory to show up, and while it's sitting around
you're wasting valuable time.</p>
<p><strong>Important Note:</strong></p>
<p>Now that you have the answer, here's an interesting note: there's no inherent
reason that your second example has to be the fast one. For instance, in
Fortran, the first example would be fast and the second one slow. That's
because instead of expanding things out into conceptual "rows" like C does,
Fortran expands into "columns", i.e.:</p>
<div class="code"><pre class="code literal-block"><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="mf">0</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="mf">0</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="mf">1</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="mf">1</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="mf">2</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="mf">2</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="mf">2</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="mf">3</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span>
</pre></div>

<p>The layout of C is called 'row-major' and Fortran's is called 'column-major'.
As you can see, it's very important to know whether your programming language
is row-major or column-major! Here's a link for more info:
http://en.wikipedia.org/wiki/Row-major_order</p>
<p><br></p>
<h3>Suggest</h3>
<p>Nothing to do with assembly. This is due to cache misses.</p>
<p>C multidimensional arrays are stored with the last dimension as the fastest.
So the first version will miss the cache on every iteration, whereas the
second version won't. So the second version should be substantially faster.</p>
<p>See also: http://en.wikipedia.org/wiki/Loop_interchange.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2187.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2185.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
