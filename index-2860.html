<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 2860) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-2860.html">
<link rel="prev" href="index-2861.html" type="text/html">
<link rel="next" href="index-2859.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/proper-repository-pattern-design-in-php/" class="u-url">Proper Repository Pattern Design in PHP?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/proper-repository-pattern-design-in-php/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T23:23:10+08:00" itemprop="datePublished" title="2023-03-05 23:23">2023-03-05 23:23</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p><em>Preface: I'm attempting to use the repository pattern in an MVC architecture
with relational databases.</em></p>
<p>I've recently started learning TDD in PHP, and I'm realizing that my database
is coupled much too closely with the rest of my application. I've read about
repositories and using an IoC container to "inject" it into my controllers.
Very cool stuff. But now have some practical questions about repository
design. Consider the follow example.</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">DbUserRepository</span> <span class="k">implements</span> <span class="nx">UserRepositoryInterface</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$db</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$db</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span> <span class="o">=</span> <span class="nv">$db</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">findAll</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">findById</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">findByName</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">remove</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h3>Issue #1: Too many fields</h3>
<p>All of these find methods use a select all fields (<code>SELECT *</code>) approach.
However, in my apps, I'm always trying to limit the number of fields I get, as
this often adds overhead and slows things down. For those using this pattern,
how do you deal with this?</p>
<h3>Issue #2: Too many methods</h3>
<p>While this class looks nice right now, I know that in a real-world app I need
a lot more methods. For example:</p>
<ul>
<li>findAllByNameAndStatus</li>
<li>findAllInCountry</li>
<li>findAllWithEmailAddressSet</li>
<li>findAllByAgeAndGender</li>
<li>findAllByAgeAndGenderOrderByAge</li>
<li>Etc.</li>
</ul>
<p>As you can see, there could be a very, very long list of possible methods. And
then if you add in the field selection issue above, the problem worsens. In
the past I'd normally just put all this logic right in my controller:</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">MyController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">users</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$users</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="s1">'name, email, status'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">byCountry</span><span class="p">(</span><span class="s1">'Canada'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">rows</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">View</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'users'</span> <span class="o">=&gt;</span> <span class="nv">$users</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>With my repository approach, I don't want to end up with this:</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">MyController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">users</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$users</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">repo</span><span class="o">-&gt;</span><span class="na">get_first_name_last_name_email_username_status_by_country_order_by_name</span><span class="p">(</span><span class="s1">'Canada'</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">View</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'users'</span> <span class="o">=&gt;</span> <span class="nv">$users</span><span class="p">))</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>

<h3>Issue #3: Impossible to match an interface</h3>
<p>I see the benefit in using interfaces for repositories, so I can swap out my
implementation (for testing purposes or other). My understanding of interfaces
is that they define a contract that an implementation must follow. This is
great until you start adding additional methods to your repositories like
<code>findAllInCountry()</code>. Now I need to update my interface to also have this
method, otherwise, other implementations may not have it, and that could break
my application. By this feels insane...a case of the tail wagging the dog.</p>
<h4>Specification Pattern?</h4>
<p>This leads me to believe that repository should only have a fixed number of
methods (like <code>save()</code>, <code>remove()</code>, <code>find()</code>, <code>findAll()</code>, etc). But then how
do I run specific lookups? I've heard of the Specification Pattern, but it
seems to me that this only reduces an entire set of records (via
<code>IsSatisfiedBy()</code>), which clearly has major performance issues if you're
pulling from a database.</p>
<h3>Help?</h3>
<p>Clearly, I need to rethink things a little when working with repositories. Can
anyone enlighten on how this is best handled?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>I thought I'd take a crack at answering my own question. What follows is just
one way of solving the issues 1-3 in my original question.</p>
<p><em>Disclaimer: I may not always use the right terms when describing patterns or
techniques. Sorry for that.</em></p>
<h3>The Goals:</h3>
<ul>
<li>Create a complete example of a basic controller for viewing and editing <code>Users</code>.</li>
<li>All code must be fully testable and mockable.</li>
<li>The controller should have no idea where the data is stored (meaning it can be changed).</li>
<li>Example to show a SQL implementation (most common).</li>
<li>For maximum performance, controllers should only receive the data they need—no extra fields.</li>
<li>Implementation should leverage some type of data mapper for ease of development.</li>
<li>Implementation should have the ability to perform complex data lookups.</li>
</ul>
<h3>The Solution</h3>
<p>I'm splitting my persistent storage (database) interaction into two
categories: <strong>R</strong> (Read) and <strong>CUD</strong> (Create, Update, Delete). My experience
has been that reads are really what causes an application to slow down. And
while data manipulation (CUD) is actually slower, it happens much less
frequently, and is therefore much less of a concern.</p>
<p><strong>CUD</strong> (Create, Update, Delete) is easy. This will involve working with
actual models, which are then passed to my <code>Repositories</code> for persistence.
Note, my repositories will still provide a Read method, but simply for object
creation, not display. More on that later.</p>
<p><strong>R</strong> (Read) is not so easy. No models here, just value objects. Use arrays if
you prefer. These objects may represent a single model or a blend of many
models, anything really. These are not very interesting on their own, but how
they are generated is. I'm using what I'm calling <code>Query Objects</code>.</p>
<h3>The Code:</h3>
<h4>User Model</h4>
<p>Let's start simple with our basic user model. Note that there is no ORM
extending or database stuff at all. Just pure model glory. Add your getters,
setters, validation, whatever.</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span> <span class="n">User</span>
{
    <span class="n">public</span> <span class="nv">$id</span>;
    <span class="n">public</span> <span class="nv">$first_name</span>;
    <span class="n">public</span> <span class="nv">$last_name</span>;
    <span class="n">public</span> <span class="nv">$gender</span>;
    <span class="n">public</span> <span class="nv">$email</span>;
    <span class="n">public</span> <span class="nv">$password</span>;
}
</pre></div>

<h4>Repository Interface</h4>
<p>Before I create my user repository, I want to create my repository interface.
This will define the "contract" that repositories must follow in order to be
used by my controller. Remember, my controller will not know where the data is
actually stored.</p>
<p>Note that my repositories will only every contain these three methods. The
<code>save()</code> method is responsible for both creating and updating users, simply
depending on whether or not the user object has an id set.</p>
<div class="code"><pre class="code literal-block">interface UserRepositoryInterface
{
    public function find($id);
    public function save(User $user);
    public function remove(User $user);
}
</pre></div>

<h4>SQL Repository Implementation</h4>
<p>Now to create my implementation of the interface. As mentioned, my example was
going to be with an SQL database. Note the use of a data mapper to prevent
having to write repetitive SQL queries.</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">SQLUserRepository</span><span class="w"> </span><span class="n">implements</span><span class="w"> </span><span class="n">UserRepositoryInterface</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">db</span><span class="p">;</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(</span><span class="n">Database</span><span class="w"> </span><span class="o">$</span><span class="n">db</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">db</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="o">$</span><span class="n">id</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">id</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="s1">'users'</span><span class="w"> </span><span class="n">table</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">object</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="o">$</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="s1">'users'</span><span class="p">,</span><span class="w"> </span><span class="s1">'User'</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">save</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="o">$</span><span class="n">user</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Insert</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="o">$</span><span class="n">user</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="s1">'users'</span><span class="w"> </span><span class="n">table</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">(</span><span class="o">$</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="s1">'users'</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">remove</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="o">$</span><span class="n">user</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Remove</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="o">$</span><span class="n">user</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="s1">'users'</span><span class="w"> </span><span class="n">table</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="o">$</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="s1">'users'</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h4>Query Object Interface</h4>
<p>Now with <strong>CUD</strong> (Create, Update, Delete) taken care of by our repository, we
can focus on the <strong>R</strong> (Read). Query objects are simply an encapsulation of
some type of data lookup logic. They are <strong>not</strong> query builders. By
abstracting it like our repository we can change it's implementation and test
it easier. An example of a Query Object might be an <code>AllUsersQuery</code> or
<code>AllActiveUsersQuery</code>, or even <code>MostCommonUserFirstNames</code>.</p>
<p>You may be thinking "can't I just create methods in my repositories for those
queries?" Yes, but here is why I'm not doing this:</p>
<ul>
<li>My repositories are meant for working with model objects. In a real world app, why would I ever need to get the <code>password</code> field if I'm looking to list all my users?</li>
<li>Repositories are often model specific, yet queries often involve more than one model. So what repository do you put your method in?</li>
<li>This keeps my repositories very simple—not an bloated class of methods.</li>
<li>All queries are now organized into their own classes.</li>
<li>Really, at this point, repositories exist simply to abstract my database layer.</li>
</ul>
<p>For my example I'll create a query object to lookup "AllUsers". Here is the
interface:</p>
<div class="code"><pre class="code literal-block">interface AllUsersQueryInterface
{
    public function fetch($fields);
}
</pre></div>

<h4>Query Object Implementation</h4>
<p>This is where we can use a data mapper again to help speed up development.
Notice that I am allowing one tweak to the returned dataset—the fields. This
is about as far as I want to go with manipulating the performed query.
Remember, my query objects are not query builders. They simply perform a
specific query. However, since I know that I'll probably be using this one a
lot, in a number of different situations, I'm giving myself the ability to
specify the fields. I never want to return fields I don't need!</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">AllUsersQuery</span><span class="w"> </span><span class="n">implements</span><span class="w"> </span><span class="n">AllUsersQueryInterface</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">db</span><span class="p">;</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(</span><span class="n">Database</span><span class="w"> </span><span class="o">$</span><span class="n">db</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">db</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">fetch</span><span class="p">(</span><span class="o">$</span><span class="n">fields</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">(</span><span class="o">$</span><span class="n">fields</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">'last_name, first_name'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rows</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Before moving on to the controller, I want to show another example to
illustrate how powerful this is. Maybe I have a reporting engine and need to
create a report for <code>AllOverdueAccounts</code>. This could be tricky with my data
mapper, and I may want to write some actual <code>SQL</code> in this situation. No
problem, here is what this query object could look like:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">AllOverdueAccountsQuery</span><span class="w"> </span><span class="n">implements</span><span class="w"> </span><span class="n">AllOverdueAccountsQueryInterface</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">db</span><span class="p">;</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(</span><span class="n">Database</span><span class="w"> </span><span class="o">$</span><span class="n">db</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">db</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">fetch</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sql</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">rows</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">sql</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s2">"SELECT..."</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>This nicely keeps all my logic for this report in one class, and it's easy to
test. I can mock it to my hearts content, or even use a different
implementation entirely.</p>
<h4>The Controller</h4>
<p>Now the fun part—bringing all the pieces together. Note that I am using
dependency injection. Typically dependencies are injected into the
constructor, but I actually prefer to inject them right into my controller
methods (routes). This minimizes the controller's object graph, and I actually
find it more legible. Note, if you don't like this approach, just use the
traditional constructor method.</p>
<div class="code"><pre class="code literal-block"><span class="nt">class</span><span class="w"> </span><span class="nt">UsersController</span>
<span class="p">{</span>
<span class="w">    </span><span class="err">public</span><span class="w"> </span><span class="err">function</span><span class="w"> </span><span class="err">index(AllUsersQueryInterface</span><span class="w"> </span><span class="err">$query)</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">Fetch</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">data</span>
<span class="w">        </span><span class="err">$users</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$query-&gt;fetch(</span><span class="cp">[</span><span class="s1">'first_name'</span><span class="p">,</span><span class="w"> </span><span class="s1">'last_name'</span><span class="p">,</span><span class="w"> </span><span class="s1">'email'</span><span class="cp">]</span><span class="err">)</span><span class="p">;</span>

<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">Return</span><span class="w"> </span><span class="err">view</span>
<span class="w">        </span><span class="err">return</span><span class="w"> </span><span class="n">Response</span><span class="p">:</span><span class="o">:</span><span class="nf">view</span><span class="p">(</span><span class="s1">'all_users.php'</span><span class="p">,</span><span class="w"> </span><span class="cp">[</span><span class="s1">'users'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">$users</span><span class="cp">]</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nt">public</span><span class="w"> </span><span class="nt">function</span><span class="w"> </span><span class="nt">add</span><span class="o">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="err">return</span><span class="w"> </span><span class="n">Response</span><span class="p">:</span><span class="o">:</span><span class="nf">view</span><span class="p">(</span><span class="s1">'add_user.php'</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nt">public</span><span class="w"> </span><span class="nt">function</span><span class="w"> </span><span class="nt">insert</span><span class="o">(</span><span class="nt">UserRepositoryInterface</span><span class="w"> </span><span class="o">$</span><span class="nt">repository</span><span class="o">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">Create</span><span class="w"> </span><span class="err">new</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">model</span>
<span class="w">        </span><span class="err">$user</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">new</span><span class="w"> </span><span class="err">User</span><span class="p">;</span>
<span class="w">        </span><span class="err">$user-&gt;first_name</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$_POST</span><span class="cp">[</span><span class="s1">'first_name'</span><span class="cp">]</span><span class="p">;</span>
<span class="w">        </span><span class="err">$user-&gt;last_name</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$_POST</span><span class="cp">[</span><span class="s1">'last_name'</span><span class="cp">]</span><span class="p">;</span>
<span class="w">        </span><span class="err">$user-&gt;gender</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$_POST</span><span class="cp">[</span><span class="s1">'gender'</span><span class="cp">]</span><span class="p">;</span>
<span class="w">        </span><span class="err">$user-&gt;email</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$_POST</span><span class="cp">[</span><span class="s1">'email'</span><span class="cp">]</span><span class="p">;</span>

<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">Save</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">new</span><span class="w"> </span><span class="err">user</span>
<span class="w">        </span><span class="err">$repository-&gt;save($user)</span><span class="p">;</span>

<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">Return</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">id</span>
<span class="w">        </span><span class="err">return</span><span class="w"> </span><span class="n">Response</span><span class="p">:</span><span class="o">:</span><span class="nf">json</span><span class="p">(</span><span class="cp">[</span><span class="s1">'id'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">$user</span><span class="o">-&gt;</span><span class="nb">id</span><span class="cp">]</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nt">public</span><span class="w"> </span><span class="nt">function</span><span class="w"> </span><span class="nt">view</span><span class="o">(</span><span class="nt">SpecificUserQueryInterface</span><span class="w"> </span><span class="o">$</span><span class="nt">query</span><span class="o">,</span><span class="w"> </span><span class="o">$</span><span class="nt">id</span><span class="o">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">Load</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">data</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">(!$user</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$query-&gt;fetch($id,</span><span class="w"> </span><span class="cp">[</span><span class="s1">'first_name'</span><span class="p">,</span><span class="w"> </span><span class="s1">'last_name'</span><span class="p">,</span><span class="w"> </span><span class="s1">'gender'</span><span class="p">,</span><span class="w"> </span><span class="s1">'email'</span><span class="cp">]</span><span class="err">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="err">return</span><span class="w"> </span><span class="n">Response</span><span class="p">:</span><span class="o">:</span><span class="nf">notFound</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nt">Return</span><span class="w"> </span><span class="nt">view</span>
<span class="w">        </span><span class="nt">return</span><span class="w"> </span><span class="nt">Response</span><span class="p">::</span><span class="nd">view</span><span class="o">(</span><span class="s1">'view_user.php'</span><span class="o">,</span><span class="w"> </span><span class="cp">[</span><span class="s1">'user'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">$user</span><span class="cp">]</span><span class="o">);</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="nt">public</span><span class="w"> </span><span class="nt">function</span><span class="w"> </span><span class="nt">edit</span><span class="o">(</span><span class="nt">SpecificUserQueryInterface</span><span class="w"> </span><span class="o">$</span><span class="nt">query</span><span class="o">,</span><span class="w"> </span><span class="o">$</span><span class="nt">id</span><span class="o">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">Load</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">data</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">(!$user</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$query-&gt;fetch($id,</span><span class="w"> </span><span class="cp">[</span><span class="s1">'first_name'</span><span class="p">,</span><span class="w"> </span><span class="s1">'last_name'</span><span class="p">,</span><span class="w"> </span><span class="s1">'gender'</span><span class="p">,</span><span class="w"> </span><span class="s1">'email'</span><span class="cp">]</span><span class="err">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="err">return</span><span class="w"> </span><span class="n">Response</span><span class="p">:</span><span class="o">:</span><span class="nf">notFound</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nt">Return</span><span class="w"> </span><span class="nt">view</span>
<span class="w">        </span><span class="nt">return</span><span class="w"> </span><span class="nt">Response</span><span class="p">::</span><span class="nd">view</span><span class="o">(</span><span class="s1">'edit_user.php'</span><span class="o">,</span><span class="w"> </span><span class="cp">[</span><span class="s1">'user'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">$user</span><span class="cp">]</span><span class="o">);</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="nt">public</span><span class="w"> </span><span class="nt">function</span><span class="w"> </span><span class="nt">update</span><span class="o">(</span><span class="nt">UserRepositoryInterface</span><span class="w"> </span><span class="o">$</span><span class="nt">repository</span><span class="o">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">Load</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">model</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">(!$user</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$repository-&gt;find($id))</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="err">return</span><span class="w"> </span><span class="n">Response</span><span class="p">:</span><span class="o">:</span><span class="nf">notFound</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nt">Update</span><span class="w"> </span><span class="nt">the</span><span class="w"> </span><span class="nt">user</span>
<span class="w">        </span><span class="o">$</span><span class="nt">user-</span><span class="o">&gt;</span><span class="nt">first_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="nt">_POST</span><span class="cp">[</span><span class="s1">'first_name'</span><span class="cp">]</span><span class="o">;</span>
<span class="w">        </span><span class="o">$</span><span class="nt">user-</span><span class="o">&gt;</span><span class="nt">last_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="nt">_POST</span><span class="cp">[</span><span class="s1">'last_name'</span><span class="cp">]</span><span class="o">;</span>
<span class="w">        </span><span class="o">$</span><span class="nt">user-</span><span class="o">&gt;</span><span class="nt">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="nt">_POST</span><span class="cp">[</span><span class="s1">'gender'</span><span class="cp">]</span><span class="o">;</span>
<span class="w">        </span><span class="o">$</span><span class="nt">user-</span><span class="o">&gt;</span><span class="nt">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="nt">_POST</span><span class="cp">[</span><span class="s1">'email'</span><span class="cp">]</span><span class="o">;</span>

<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nt">Save</span><span class="w"> </span><span class="nt">the</span><span class="w"> </span><span class="nt">user</span>
<span class="w">        </span><span class="o">$</span><span class="nt">repository-</span><span class="o">&gt;</span><span class="nt">save</span><span class="o">($</span><span class="nt">user</span><span class="o">);</span>

<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nt">Return</span><span class="w"> </span><span class="nt">success</span>
<span class="w">        </span><span class="nt">return</span><span class="w"> </span><span class="nt">true</span><span class="o">;</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="nt">public</span><span class="w"> </span><span class="nt">function</span><span class="w"> </span><span class="nt">delete</span><span class="o">(</span><span class="nt">UserRepositoryInterface</span><span class="w"> </span><span class="o">$</span><span class="nt">repository</span><span class="o">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">Load</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">model</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">(!$user</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$repository-&gt;find($id))</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="err">return</span><span class="w"> </span><span class="n">Response</span><span class="p">:</span><span class="o">:</span><span class="nf">notFound</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nt">Delete</span><span class="w"> </span><span class="nt">the</span><span class="w"> </span><span class="nt">user</span>
<span class="w">        </span><span class="o">$</span><span class="nt">repository-</span><span class="o">&gt;</span><span class="nt">delete</span><span class="o">($</span><span class="nt">user</span><span class="o">);</span>

<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nt">Return</span><span class="w"> </span><span class="nt">success</span>
<span class="w">        </span><span class="nt">return</span><span class="w"> </span><span class="nt">true</span><span class="o">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<h3>Final Thoughts:</h3>
<p>The important things to note here are that when I'm modifying (creating,
updating or deleting) entities, I'm working with real model objects, and
performing the persistance through my repositories.</p>
<p>However, when I'm displaying (selecting data and sending it to the views) I'm
not working with model objects, but rather plain old value objects. I only
select the fields I need, and it's designed so I can maximum my data lookup
performance.</p>
<p>My repositories stay very clean, and instead this "mess" is organized into my
model queries.</p>
<p>I use a data mapper to help with development, as it's just ridiculous to write
repetitive SQL for common tasks. However, you absolutely can write SQL where
needed (complicated queries, reporting, etc.). And when you do, it's nicely
tucked away into a properly named class.</p>
<p>I'd love to hear your take on my approach!</p>
<hr>
<p><strong><em>July 2015 Update:</em></strong></p>
<p>I've been asked in the comments where I ended up with all this. Well, not that
far off actually. Truthfully, I still don't really like repositories. I find
them overkill for basic lookups (especially if you're already using an ORM),
and messy when working with more complicated queries.</p>
<p>I generally work with an ActiveRecord style ORM, so most often I'll just
reference those models directly throughout my application. However, in
situations where I have more complex queries, I'll use query objects to make
these more reusable. I should also note that I always inject my models into my
methods, making them easier to mock in my tests.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Based on my experience, here are some answers to your questions:</p>
<p><strong>Q:</strong> How do we deal with bringing back fields we don't need?</p>
<p><strong>A:</strong> From my experience this really boils down to dealing with complete
entities versus ad-hoc queries.</p>
<p>A complete entity is something like a <code>User</code> object. It has properties and
methods, etc. It's a first class citizen in your codebase.</p>
<p>An ad-hoc query returns some data, but we don't know anything beyond that. As
the data gets passed around the application, it is done so without context. Is
it a <code>User</code>? A <code>User</code> with some <code>Order</code> information attached? We don't really
know.</p>
<p>I prefer working with full entities.</p>
<p>You are right that you will often bring back data you won't use, but you can
address this in various ways:</p>
<ol>
<li>Aggressively cache the entities so you only pay the read price once from the database.</li>
<li>Spend more time modeling your entities so they have good distinctions between them. (Consider splitting a large entity into two smaller entities, etc.)</li>
<li>Consider having multiple versions of entities. You can have a <code>User</code> for the back end and maybe a <code>UserSmall</code> for AJAX calls. One might have 10 properties and one has 3 properties.</li>
</ol>
<p>The downsides of working with ad-hoc queries:</p>
<ol>
<li>You end up with essentially the same data across many queries. For example, with a <code>User</code>, you'll end up writing essentially the same <code>select *</code> for many calls. One call will get 8 of 10 fields, one will get 5 of 10, one will get 7 of 10. Why not replace all with one call that gets 10 out of 10? The reason this is bad is that it is murder to re-factor/test/mock.</li>
<li>It becomes very hard to reason at a high level about your code over time. Instead of statements like "Why is the <code>User</code> so slow?" you end up tracking down one-off queries and so bug fixes tend to be small and localized. </li>
<li>It's really hard to replace the underlying technology. If you store everything in MySQL now and want to move to MongoDB, it's a lot harder to replace 100 ad-hoc calls than it is a handful of entities.</li>
</ol>
<p><strong>Q:</strong> I will have too many methods in my repository.</p>
<p><strong>A:</strong> I haven't really seen any way around this other than consolidating
calls. The method calls in your repository really map to features in your
application. The more features, the more data specific calls. You can push
back on features and try to merge similar calls into one.</p>
<p>The complexity at the end of the day has to exist somewhere. With a repository
pattern we've pushed it into the repository interface instead of maybe making
a bunch of stored procedures.</p>
<p>Sometimes I have to tell myself, "Well it had to give somewhere! There are no
silver bullets."</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-do-i-profile-memory-usage-in-python/" class="u-url">How do I profile memory usage in Python?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-do-i-profile-memory-usage-in-python/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T23:21:25+08:00" itemprop="datePublished" title="2023-03-05 23:21">2023-03-05 23:21</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I've recently become interested in algorithms and have begun exploring them by
writing a naive implementation and then optimizing it in various ways.</p>
<p>I'm already familiar with the standard Python module for profiling runtime
(for most things I've found the timeit magic function in IPython to be
sufficient), but I'm also interested in memory usage so I can explore those
tradeoffs as well (e.g. the cost of caching a table of previously computed
values versus recomputing them as needed). Is there a module that will profile
the memory usage of a given function for me?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>This one has been answered already here: Python memory profiler</p>
<p>Basically you do something like that (cited from Guppy-PE):</p>
<div class="code"><pre class="code literal-block"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">guppy</span> <span class="kn">import</span> <span class="n">hpy</span><span class="p">;</span> <span class="n">h</span><span class="o">=</span><span class="n">hpy</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">h</span><span class="o">.</span><span class="n">heap</span><span class="p">()</span>
<span class="n">Partition</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">set</span> <span class="n">of</span> <span class="mi">48477</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">3265516</span> <span class="nb">bytes</span><span class="o">.</span>
 <span class="n">Index</span>  <span class="n">Count</span>   <span class="o">%</span>     <span class="n">Size</span>   <span class="o">%</span> <span class="n">Cumulative</span>  <span class="o">%</span> <span class="n">Kind</span> <span class="p">(</span><span class="k">class</span> <span class="err">/ </span><span class="nc">dict</span> <span class="n">of</span> <span class="n">class</span><span class="p">)</span>
     <span class="mi">0</span>  <span class="mi">25773</span>  <span class="mi">53</span>  <span class="mi">1612820</span>  <span class="mi">49</span>   <span class="mi">1612820</span>  <span class="mi">49</span> <span class="nb">str</span>
     <span class="mi">1</span>  <span class="mi">11699</span>  <span class="mi">24</span>   <span class="mi">483960</span>  <span class="mi">15</span>   <span class="mi">2096780</span>  <span class="mi">64</span> <span class="nb">tuple</span>
     <span class="mi">2</span>    <span class="mi">174</span>   <span class="mi">0</span>   <span class="mi">241584</span>   <span class="mi">7</span>   <span class="mi">2338364</span>  <span class="mi">72</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">module</span>
     <span class="mi">3</span>   <span class="mi">3478</span>   <span class="mi">7</span>   <span class="mi">222592</span>   <span class="mi">7</span>   <span class="mi">2560956</span>  <span class="mi">78</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span>
     <span class="mi">4</span>   <span class="mi">3296</span>   <span class="mi">7</span>   <span class="mi">184576</span>   <span class="mi">6</span>   <span class="mi">2745532</span>  <span class="mi">84</span> <span class="n">function</span>
     <span class="mi">5</span>    <span class="mi">401</span>   <span class="mi">1</span>   <span class="mi">175112</span>   <span class="mi">5</span>   <span class="mi">2920644</span>  <span class="mi">89</span> <span class="nb">dict</span> <span class="n">of</span> <span class="k">class</span>
     <span class="err">6    108   0    81888   3   3002532  92 </span><span class="nc">dict</span> <span class="p">(</span><span class="n">no</span> <span class="n">owner</span><span class="p">)</span>
     <span class="mi">7</span>    <span class="mi">114</span>   <span class="mi">0</span>    <span class="mi">79632</span>   <span class="mi">2</span>   <span class="mi">3082164</span>  <span class="mi">94</span> <span class="nb">dict</span> <span class="n">of</span> <span class="nb">type</span>
     <span class="mi">8</span>    <span class="mi">117</span>   <span class="mi">0</span>    <span class="mi">51336</span>   <span class="mi">2</span>   <span class="mi">3133500</span>  <span class="mi">96</span> <span class="nb">type</span>
     <span class="mi">9</span>    <span class="mi">667</span>   <span class="mi">1</span>    <span class="mi">24012</span>   <span class="mi">1</span>   <span class="mi">3157512</span>  <span class="mi">97</span> <span class="n">__builtin__</span><span class="o">.</span><span class="n">wrapper_descriptor</span>
<span class="o">&lt;</span><span class="mi">76</span> <span class="n">more</span> <span class="n">rows</span><span class="o">.</span> <span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="s1">'_.more'</span> <span class="n">to</span> <span class="n">view</span><span class="o">.&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">h</span><span class="o">.</span><span class="n">iso</span><span class="p">(</span><span class="mi">1</span><span class="p">,[],{})</span>
<span class="n">Partition</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">set</span> <span class="n">of</span> <span class="mi">3</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">176</span> <span class="nb">bytes</span><span class="o">.</span>
 <span class="n">Index</span>  <span class="n">Count</span>   <span class="o">%</span>     <span class="n">Size</span>   <span class="o">%</span> <span class="n">Cumulative</span>  <span class="o">%</span> <span class="n">Kind</span> <span class="p">(</span><span class="k">class</span> <span class="err">/ </span><span class="nc">dict</span> <span class="n">of</span> <span class="n">class</span><span class="p">)</span>
     <span class="mi">0</span>      <span class="mi">1</span>  <span class="mi">33</span>      <span class="mi">136</span>  <span class="mi">77</span>       <span class="mi">136</span>  <span class="mi">77</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">no</span> <span class="n">owner</span><span class="p">)</span>
     <span class="mi">1</span>      <span class="mi">1</span>  <span class="mi">33</span>       <span class="mi">28</span>  <span class="mi">16</span>       <span class="mi">164</span>  <span class="mi">93</span> <span class="nb">list</span>
     <span class="mi">2</span>      <span class="mi">1</span>  <span class="mi">33</span>       <span class="mi">12</span>   <span class="mi">7</span>       <span class="mi">176</span> <span class="mi">100</span> <span class="nb">int</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span><span class="o">=</span><span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">h</span><span class="o">.</span><span class="n">iso</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sp</span>
 <span class="mi">0</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="s1">'__main__'</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>This one has been answered already here: Python memory profiler</p>
<p>Basically you do something like that (cited from Guppy-PE):</p>
<div class="code"><pre class="code literal-block"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">guppy</span> <span class="kn">import</span> <span class="n">hpy</span><span class="p">;</span> <span class="n">h</span><span class="o">=</span><span class="n">hpy</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">h</span><span class="o">.</span><span class="n">heap</span><span class="p">()</span>
<span class="n">Partition</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">set</span> <span class="n">of</span> <span class="mi">48477</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">3265516</span> <span class="nb">bytes</span><span class="o">.</span>
 <span class="n">Index</span>  <span class="n">Count</span>   <span class="o">%</span>     <span class="n">Size</span>   <span class="o">%</span> <span class="n">Cumulative</span>  <span class="o">%</span> <span class="n">Kind</span> <span class="p">(</span><span class="k">class</span> <span class="err">/ </span><span class="nc">dict</span> <span class="n">of</span> <span class="n">class</span><span class="p">)</span>
     <span class="mi">0</span>  <span class="mi">25773</span>  <span class="mi">53</span>  <span class="mi">1612820</span>  <span class="mi">49</span>   <span class="mi">1612820</span>  <span class="mi">49</span> <span class="nb">str</span>
     <span class="mi">1</span>  <span class="mi">11699</span>  <span class="mi">24</span>   <span class="mi">483960</span>  <span class="mi">15</span>   <span class="mi">2096780</span>  <span class="mi">64</span> <span class="nb">tuple</span>
     <span class="mi">2</span>    <span class="mi">174</span>   <span class="mi">0</span>   <span class="mi">241584</span>   <span class="mi">7</span>   <span class="mi">2338364</span>  <span class="mi">72</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">module</span>
     <span class="mi">3</span>   <span class="mi">3478</span>   <span class="mi">7</span>   <span class="mi">222592</span>   <span class="mi">7</span>   <span class="mi">2560956</span>  <span class="mi">78</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span>
     <span class="mi">4</span>   <span class="mi">3296</span>   <span class="mi">7</span>   <span class="mi">184576</span>   <span class="mi">6</span>   <span class="mi">2745532</span>  <span class="mi">84</span> <span class="n">function</span>
     <span class="mi">5</span>    <span class="mi">401</span>   <span class="mi">1</span>   <span class="mi">175112</span>   <span class="mi">5</span>   <span class="mi">2920644</span>  <span class="mi">89</span> <span class="nb">dict</span> <span class="n">of</span> <span class="k">class</span>
     <span class="err">6    108   0    81888   3   3002532  92 </span><span class="nc">dict</span> <span class="p">(</span><span class="n">no</span> <span class="n">owner</span><span class="p">)</span>
     <span class="mi">7</span>    <span class="mi">114</span>   <span class="mi">0</span>    <span class="mi">79632</span>   <span class="mi">2</span>   <span class="mi">3082164</span>  <span class="mi">94</span> <span class="nb">dict</span> <span class="n">of</span> <span class="nb">type</span>
     <span class="mi">8</span>    <span class="mi">117</span>   <span class="mi">0</span>    <span class="mi">51336</span>   <span class="mi">2</span>   <span class="mi">3133500</span>  <span class="mi">96</span> <span class="nb">type</span>
     <span class="mi">9</span>    <span class="mi">667</span>   <span class="mi">1</span>    <span class="mi">24012</span>   <span class="mi">1</span>   <span class="mi">3157512</span>  <span class="mi">97</span> <span class="n">__builtin__</span><span class="o">.</span><span class="n">wrapper_descriptor</span>
<span class="o">&lt;</span><span class="mi">76</span> <span class="n">more</span> <span class="n">rows</span><span class="o">.</span> <span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="s1">'_.more'</span> <span class="n">to</span> <span class="n">view</span><span class="o">.&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">h</span><span class="o">.</span><span class="n">iso</span><span class="p">(</span><span class="mi">1</span><span class="p">,[],{})</span>
<span class="n">Partition</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">set</span> <span class="n">of</span> <span class="mi">3</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">176</span> <span class="nb">bytes</span><span class="o">.</span>
 <span class="n">Index</span>  <span class="n">Count</span>   <span class="o">%</span>     <span class="n">Size</span>   <span class="o">%</span> <span class="n">Cumulative</span>  <span class="o">%</span> <span class="n">Kind</span> <span class="p">(</span><span class="k">class</span> <span class="err">/ </span><span class="nc">dict</span> <span class="n">of</span> <span class="n">class</span><span class="p">)</span>
     <span class="mi">0</span>      <span class="mi">1</span>  <span class="mi">33</span>      <span class="mi">136</span>  <span class="mi">77</span>       <span class="mi">136</span>  <span class="mi">77</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">no</span> <span class="n">owner</span><span class="p">)</span>
     <span class="mi">1</span>      <span class="mi">1</span>  <span class="mi">33</span>       <span class="mi">28</span>  <span class="mi">16</span>       <span class="mi">164</span>  <span class="mi">93</span> <span class="nb">list</span>
     <span class="mi">2</span>      <span class="mi">1</span>  <span class="mi">33</span>       <span class="mi">12</span>   <span class="mi">7</span>       <span class="mi">176</span> <span class="mi">100</span> <span class="nb">int</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span><span class="o">=</span><span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">h</span><span class="o">.</span><span class="n">iso</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sp</span>
 <span class="mi">0</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="s1">'__main__'</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/load-and-execute-order-of-scripts/" class="u-url">load and execute order of scripts</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/load-and-execute-order-of-scripts/" rel="bookmark">
            <time class="published dt-published" datetime="2023-03-05T23:19:59+08:00" itemprop="datePublished" title="2023-03-05 23:19">2023-03-05 23:19</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>There are so many different ways to include JavaScript in a html page. I know
about the following options:</p>
<ul>
<li>inline code or loaded from external URI</li>
<li>included in  or  tag [1,2]</li>
<li>having none, <code>defer</code> or <code>async</code> attribute (only external scripts)</li>
<li>included in static source or added dynamically by other scripts (at different parse states, with different methods)</li>
</ul>
<p>Not counting browserscripts from the harddisk, javascript:URIs and
<code>onEvent</code>-attributes [3], there are already 16 alternatives to get JS executed
and I'm sure I forgot something.</p>
<p>I'm not so concerned with fast (parallel) loading, I'm more curious about the
execution order (which may depend on loading order and document order). <strong>Is
there a good</strong> (cross-browser) <strong>reference that covers really all cases?</strong>
E.g. http://www.websiteoptimization.com/speed/tweak/defer/ only deals with 6
of them, and tests mostly old browsers.</p>
<p>As I fear there's not, here is my specific question: I've got some (external)
head scripts for initialisation and script loading. Then I've got two static,
inline scripts in the end of the body. The first one lets the script loader
dynamically append another script element (referencing external js) to the
body. The second of the static, inline scripts wants to use js from the added,
external script. Can it rely on the other having been executed (and why :-)?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>If you aren't dynamically loading scripts or marking them as <code>defer</code> or
<code>async</code>, then scripts are loaded in the order encountered in the page. It
doesn't matter whether it's an external script or an inline script - they are
executed in the order they are encountered in the page. Inline scripts that
come after external scripts are held until all external scripts that came
before them have loaded and run.</p>
<p>Async scripts (regardless of how they are specified as async) load and run in
an unpredictable order. The browser loads them in parallel and it is free to
run them in whatever order it wants.</p>
<p>There is no predictable order among multiple async things. If one needed a
predictable order, then it would have to be coded in by registering for load
notifications from the async scripts and manually sequencing javascript calls
when the appropriate things are loaded.</p>
<p>When a script tag is inserted dynamically, how the execution order behaves
will depend upon the browser. You can see how Firefox behaves in this
reference article. In a nutshell, the newer versions of Firefox default a
dynamically added script tag to async unless the script tag has been set
otherwise.</p>
<p>A script tag with <code>async</code> may be run as soon as it is loaded. In fact, the
browser may pause the parser from whatever else it was doing and run that
script. So, it really can run at almost any time. If the script was cached, it
might run almost immediately. If the script takes awhile to load, it might run
after the parser is done. The one thing to remember with <code>async</code> is that it
can run anytime and that time is not predictable.</p>
<p>A script tag with <code>defer</code> waits until the entire parser is done and then runs
all scripts marked with <code>defer</code> in the order they were encountered. This
allows you to mark several scripts that depend upon one another as <code>defer</code>.
They will all get postponed until after the document parser is done, but they
will execute in the order they were encountered preserving their dependencies.
I think of <code>defer</code> like the scripts are dropped into a queue that will be
processed after the parser is done. Technically, the browser may be
downloading the scripts in the background at any time, but they won't execute
or block the parser until after the parser is done parsing the page and
parsing and running any inline scripts that are not marked <code>defer</code> or <code>async</code>.</p>
<p>Here's a quote from that article:</p>
<blockquote>
<p>script-inserted scripts execute asynchronously in IE and WebKit, but
synchronously in Opera and pre-4.0 Firefox.</p>
</blockquote>
<p>The relevant part of the HTML5 spec (for newer compliant browsers) is here.
There is a lot written in there about async behavior. Obviously, this spec
doesn't apply to older browsers (or mal-conforming browsers) whose behavior
you would probably have to test to determine.</p>
<p>A quote from the HTML5 spec:</p>
<blockquote>
<p>Then, the first of the following options that describes the situation must
be followed:</p>
<p><strong>If the element has a src attribute, and the element has a defer attribute,
and the element has been flagged as "parser-inserted", and the element does
not have an async attribute</strong> The element must be added to the end of the
list of scripts that will execute when the document has finished parsing
associated with the Document of the parser that created the element.</p>
<p>The task that the networking task source places on the task queue once the
fetching algorithm has completed must set the element's "ready to be parser-
executed" flag. The parser will handle executing the script.</p>
<p><strong>If the element has a src attribute, and the element has been flagged as
"parser-inserted", and the element does not have an async attribute</strong> The
element is the pending parsing-blocking script of the Document of the parser
that created the element. (There can only be one such script per Document at
a time.)</p>
<p>The task that the networking task source places on the task queue once the
fetching algorithm has completed must set the element's "ready to be parser-
executed" flag. The parser will handle executing the script.</p>
<p><strong>If the element does not have a src attribute, and the element has been
flagged as "parser-inserted", and the Document of the HTML parser or XML
parser that created the script element has a style sheet that is blocking
scripts</strong> The element is the pending parsing-blocking script of the Document
of the parser that created the element. (There can only be one such script
per Document at a time.)</p>
<p>Set the element's "ready to be parser-executed" flag. The parser will handle
executing the script.</p>
<p><strong>If the element has a src attribute, does not have an async attribute, and
does not have the "force-async" flag set</strong> The element must be added to the
end of the list of scripts that will execute in order as soon as possible
associated with the Document of the script element at the time the prepare a
script algorithm started.</p>
<p>The task that the networking task source places on the task queue once the
fetching algorithm has completed must run the following steps:</p>
<p><strong>If the element is not now the first element in the list of scripts that
will execute in order as soon as possible to which it was added above,</strong>
then mark the element as ready but abort these steps without executing the
script yet.</p>
<p>Execution: Execute the script block corresponding to the first script
element in this list of scripts that will execute in order as soon as
possible.</p>
<p>Remove the first element from this list of scripts that will execute in
order as soon as possible.</p>
<p>If this list of scripts that will execute in order as soon as possible is
still not empty and the first entry has already been marked as ready, then
jump back to the step labeled execution.</p>
<p><strong>If the element has a src attribute</strong> The element must be added to the set
of scripts that will execute as soon as possible of the Document of the
script element at the time the prepare a script algorithm started.</p>
<p>The task that the networking task source places on the task queue once the
fetching algorithm has completed must execute the script block and then
remove the element from the set of scripts that will execute as soon as
possible.</p>
<p><strong>Otherwise</strong> The user agent must immediately execute the script block, even
if other scripts are already executing.</p>
</blockquote>
<hr>
<p><strong>What about Javascript module scripts,<code>type="module"</code>?</strong></p>
<p>Javascript now has support for module loading with syntax like this:</p>
<div class="code"><pre class="code literal-block"><span class="o">&lt;</span><span class="n">script</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"module"</span><span class="o">&gt;</span>
  <span class="kn">import</span> <span class="p">{</span><span class="n">addTextToBody</span><span class="p">}</span> <span class="kn">from</span> <span class="s1">'./utils.mjs'</span><span class="p">;</span>

  <span class="n">addTextToBody</span><span class="p">(</span><span class="s1">'Modules are pretty cool.'</span><span class="p">);</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>

<p>Or, with <code>src</code> attribute:</p>
<div class="code"><pre class="code literal-block"><span class="nt">&lt;script</span><span class="w"> </span><span class="na">type=</span><span class="s">"module"</span><span class="w"> </span><span class="na">src=</span><span class="s">"http://somedomain.com/somescript.mjs"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>
</pre></div>

<p>All scripts with <code>type="module"</code> are automatically given the <code>defer</code>
attribute. This downloads them in parallel (if not inline) with other loading
of the page and then runs them in order, but after the parser is done.</p>
<p>Module scripts can also be given the <code>async</code> attribute which will run inline
module scripts as soon as possible, not waiting until the parser is done and
not waiting to run the <code>async</code> script in any particular order relative to
other scripts.</p>
<p>There's a pretty useful timeline chart that shows fetch and execution of
different combinations of scripts, including module scripts here in this
article: Javascript Module Loading.</p>
<p><br></p>
<h3>Suggest</h3>
<p>A great summary by @addyosmani</p>
<p><img alt="enter image description here" src="images/lHuHk.png"></p>
<p>Shamelessly copied from https://addyosmani.com/blog/script-priorities/</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2861.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-2859.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
