<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 12) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-12.html">
<link rel="prev" href="index-13.html" type="text/html">
<link rel="next" href="index-11.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/shi-yong-git-jiang-zui-jin-de-ti-jiao-yi-dong-dao-xin-fen-zhi/" class="u-url">使用 Git 将最近的提交移动到新分支</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/shi-yong-git-jiang-zui-jin-de-ti-jiao-yi-dong-dao-xin-fen-zhi/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T18:31:24+08:00" itemprop="datePublished" title="2023-02-16 18:31">2023-02-16 18:31</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>如何将我最近在 master 上的提交移动到一个新分支，并将 master 重置为这些提交之前的状态？例如从这个：</p>
<div class="code"><pre class="code literal-block">master A - B - C - D - E
</pre></div>

<p>对此：</p>
<div class="code"><pre class="code literal-block">newbranch     C - D - E
             /
master A - B
</pre></div>

<p><br><br></p>
<h2>解答</h2>
<h3>移动到现有分支</h3>
<p>如果你想将你的提交移动到一个 <strong>现有的分支</strong> ，它看起来像这样：</p>
<div class="code"><pre class="code literal-block"><span class="n">git</span><span class="w"> </span><span class="n">checkout</span><span class="w"> </span><span class="n">existingbranch</span>
<span class="n">git</span><span class="w"> </span><span class="k">merge</span><span class="w"> </span><span class="n">branchToMoveCommitFrom</span>
<span class="n">git</span><span class="w"> </span><span class="n">checkout</span><span class="w"> </span><span class="n">branchToMoveCommitFrom</span>
<span class="n">git</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="o">--</span><span class="n">hard</span><span class="w"> </span><span class="n">HEAD</span><span class="o">~</span><span class="mi">3</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">Go</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">commits</span><span class="p">.</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="o">*</span><span class="n">will</span><span class="o">*</span><span class="w"> </span><span class="n">lose</span><span class="w"> </span><span class="n">uncommitted</span><span class="w"> </span><span class="k">work</span><span class="p">.</span>
<span class="n">git</span><span class="w"> </span><span class="n">checkout</span><span class="w"> </span><span class="n">existingbranch</span>
</pre></div>

<p>您可以在执行此操作之前将未提交的编辑存储到您的存储中，使用<code>git stash</code>. 完成后，您可以检索隐藏的未提交编辑<code>git stash pop</code></p>
<h3>搬到一个新的分支机构</h3>
<p><strong>警告：</strong> 此方法有效，因为您正在使用第一个命令创建一个新分支：<code>git branch newbranch</code>。如果你想将提交移动到 <strong>现有分支</strong>
，你需要在执行之前将你的更改合并到现有分支中<code>git reset --hard HEAD~3</code>（请参阅上面的 _ <strong>移动到现有分支</strong>_ ）。
<strong>如果您不先合并您的更改，它们将会丢失。</strong></p>
<p>除非涉及其他情况，否则可以通过分支和回滚轻松完成。</p>
<div class="code"><pre class="code literal-block"><span class="err">#</span><span class="w"> </span><span class="nl">Note</span><span class="p">:</span><span class="w"> </span><span class="ow">Any</span><span class="w"> </span><span class="n">changes</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">committed</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">lost</span><span class="p">.</span>
<span class="n">git</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">newbranch</span><span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="k">Create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">branch</span><span class="p">,</span><span class="w"> </span><span class="n">saving</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">desired</span><span class="w"> </span><span class="n">commits</span>
<span class="n">git</span><span class="w"> </span><span class="n">checkout</span><span class="w"> </span><span class="n">master</span><span class="w">       </span><span class="err">#</span><span class="w"> </span><span class="n">checkout</span><span class="w"> </span><span class="n">master</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">place</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="n">back</span>
<span class="n">git</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="o">--</span><span class="n">hard</span><span class="w"> </span><span class="n">HEAD</span><span class="o">~</span><span class="mi">3</span><span class="w">   </span><span class="err">#</span><span class="w"> </span><span class="n">Move</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">commits</span><span class="w"> </span><span class="p">(</span><span class="n">Make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">know</span><span class="w"> </span><span class="n">how</span><span class="w"> </span><span class="n">many</span><span class="w"> </span><span class="n">commits</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="n">back</span><span class="p">)</span>
<span class="n">git</span><span class="w"> </span><span class="n">checkout</span><span class="w"> </span><span class="n">newbranch</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">desired</span><span class="w"> </span><span class="n">commits</span>
</pre></div>

<p>但是一定要确保有多少提交要返回。或者，您可以简单地提供要在 <em>master (/current) 分支上“恢复到”的提交的哈希值（或像</em>
<em>origin/master</em><code>HEAD~3</code>这样的引用） ，例如： <strong> </strong></p>
<div class="code"><pre class="code literal-block">git reset --hard a1b2c3d4
</pre></div>

<p><em>1 你 </em><em>只会</em>* “丢失”来自 master 分支的提交，但别担心，你会在 newbranch 中拥有这些提交！</p>
<p>最后，您可能需要强制将最新更改推送到主仓库：</p>
<div class="code"><pre class="code literal-block">git push origin master --force
</pre></div>

<p><strong>警告：</strong> 对于 Git 2.0 版及更高版本，如果您稍后<code>git rebase</code>在原始 ( )
分支上创建新分支<code>master</code>，则在变基期间可能需要一个显式<code>--no-fork-
point</code>选项以避免丢失遗留的提交。设置<code>branch.autosetuprebase always</code>使这更有可能。有关详细信息，请参阅John
Mellor 的回答。</p>
<p><br></p>
<h3>更多建议</h3>
<p>对于那些想知道它为什么有效的人（就像我一开始那样）：</p>
<p>您想回到 C，并将 D 和 E 移动到新分支。这是它最初的样子：</p>
<div class="code"><pre class="code literal-block">A-B-C-D-E (HEAD)
        ↑
      master
</pre></div>

<p>之后<code>git branch newBranch</code>：</p>
<div class="code"><pre class="code literal-block">    newBranch
        ↓
A-B-C-D-E (HEAD)
        ↑
      master
</pre></div>

<p>之后<code>git reset --hard HEAD~2</code>：</p>
<div class="code"><pre class="code literal-block">    newBranch
        ↓
A-B-C-D-E (HEAD)
    ↑
  master
</pre></div>

<p>由于分支只是一个指针，因此 <em>master</em> 指向最后一次提交。当你创建 <em>newBranch</em> 时，你只是创建了一个指向上次提交的新指针。然后使用<code>git
reset</code>您将 <em>主</em> 指针移回两次提交。但是由于您没有移动 <em>newBranch</em> ，它仍然指向它最初所做的提交。</p>
<p><br><br><a href="posts/move-the-most-recent-commit-s-to-a-new-branch-with-git/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/px-dip-dp-he-sp-zhi-jian-you-shi-yao-qu-bie/" class="u-url">px、dip、dp 和 sp 之间有什么区别？</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/px-dip-dp-he-sp-zhi-jian-you-shi-yao-qu-bie/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T18:30:55+08:00" itemprop="datePublished" title="2023-02-16 18:30">2023-02-16 18:30</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>测量单位 px、dip、dp 和 sp 之间有什么区别？</p>
<p><br><br></p>
<h2>解答</h2>
<p>来自Android 开发者文档：</p>
<ol>
<li>
<blockquote>
<p><strong>px</strong><br><strong>像素</strong> - 对应于屏幕上的实际像素。</p>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>以</strong><br><strong>英寸为单位</strong> - 基于屏幕的物理尺寸。<br>
1 英寸或 2.54 厘米</p>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>mm</strong>  </p>
<blockquote>
<p><strong>毫米</strong> - 基于屏幕的物理尺寸。</p>
</blockquote>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>pt</strong>  </p>
<blockquote>
<p><strong>Points</strong> - 基于屏幕物理尺寸的 1/72 英寸。</p>
</blockquote>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>dp</strong> 或 <strong>dip</strong>  </p>
<blockquote>
<p><strong>密度</strong> 无关像素 - 基于屏幕物理密度的抽象单位。这些单位是相对于 160 dpi 屏幕而言的，因此 1 dp 是 160 dpi
屏幕上的一个像素。dp-to-pixel
的比例会随着屏幕密度的变化而变化，但不一定成正比。注意：编译器接受“dip”和“dp”，但“dp”与“sp”更一致。</p>
</blockquote>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>sp</strong>  </p>
<blockquote>
<p>Scaleable Pixels  <strong>OR</strong> scale-independent pixels - 这类似于 dp
单位，但它也根据用户的字体大小偏好进行缩放。建议您在指定字体大小时使用此单位，这样它们将根据屏幕密度和用户偏好进行调整。请注意，Android
文档在<code>sp</code>实际代表什么方面并不一致，一个文档说“与比例无关的像素”，另一个说“可缩放像素”。</p>
</blockquote>
</blockquote>
</li>
</ol>
<p>从了解 Android 中的密度独立性：</p>
<table>
<thead><tr>
<th>密度桶</th>
<th>屏幕密度</th>
<th>物理尺寸</th>
<th>像素大小</th>
</tr></thead>
<tbody>
<tr>
<td>低密度脂蛋白</td>
<td>120dpi</td>
<td>0.5 x 0.5 英寸</td>
<td>0.5 英寸 * 120 dpi = 60x60 像素</td>
</tr>
<tr>
<td>mdpi</td>
<td>160dpi</td>
<td>0.5 x 0.5 英寸</td>
<td>0.5 英寸 * 160 dpi = 80x80 像素</td>
</tr>
<tr>
<td>高清像素</td>
<td>240dpi</td>
<td>0.5 x 0.5 英寸</td>
<td>0.5 英寸 * 240 dpi = 120x120 像素</td>
</tr>
<tr>
<td>xhdpi</td>
<td>320dpi</td>
<td>0.5 x 0.5 英寸</td>
<td>0.5 英寸 * 320 dpi = 160x160 像素</td>
</tr>
<tr>
<td>xxhdpi</td>
<td>480dpi</td>
<td>0.5 x 0.5 英寸</td>
<td>0.5 英寸 * 480 dpi = 240x240 像素</td>
</tr>
<tr>
<td>xxxhdpi</td>
<td>640dpi</td>
<td>0.5 x 0.5 英寸</td>
<td>0.5 英寸 * 640 dpi = 320x320 像素</td>
</tr>
</tbody>
</table>
<table>
<thead><tr>
<th>单元</th>
<th>描述</th>
<th>每物理英寸单位</th>
<th>密度无关？</th>
<th>每个屏幕上的物理尺寸都一样吗？</th>
</tr></thead>
<tbody>
<tr>
<td>像素</td>
<td>像素</td>
<td>变化</td>
<td>不</td>
<td>不</td>
</tr>
<tr>
<td>在</td>
<td>英寸</td>
<td>1个</td>
<td>是的</td>
<td>是的</td>
</tr>
<tr>
<td>毫米</td>
<td>毫米</td>
<td>25.4</td>
<td>是的</td>
<td>是的</td>
</tr>
<tr>
<td>点</td>
<td>积分</td>
<td>72</td>
<td>是的</td>
<td>是的</td>
</tr>
<tr>
<td>dp</td>
<td>密度独立像素</td>
<td>~160</td>
<td>是的</td>
<td>不</td>
</tr>
<tr>
<td>sp</td>
<td>缩放独立像素</td>
<td>~160</td>
<td>是的</td>
<td>不</td>
</tr>
</tbody>
</table>
<p>更多信息也可以在谷歌设计文档中找到。</p>
<p><br></p>
<h3>更多建议</h3>
<p>关于这一点的几乎所有内容以及如何实现对不同尺寸和密度的多个屏幕的最佳支持都在这里得到了很好的记录：</p>
<ul>
<li>支持多屏</li>
</ul>
<blockquote>
<p><strong>屏幕尺寸</strong><br>
 实际物理尺寸，以屏幕的对角线测量。为简单起见，Android 将所有实际屏幕尺寸分为四种通用尺寸：小、普通、大和超大。</p>
<p><strong>屏幕密度</strong><br>
 屏幕物理区域内的像素数；通常称为
dpi（每英寸点数）。例如，与“正常”或“高”密度屏幕相比，“低”密度屏幕在给定物理区域内具有更少的像素。为简单起见，Android
将所有实际屏幕密度分为六种通用密度：低、中、高、超高、超超高和超超超超高。</p>
<p><strong>方向</strong>  </p>
<p>从用户的角度来看屏幕的方向。这是横向或纵向，这意味着屏幕的宽高比分别为宽或高。请注意，不仅不同的设备在默认情况下以不同的方向运行，而且当用户旋转设备时，方向可能会在运行时发生变化。</p>
<p><strong>分辨率</strong><br>
 屏幕上物理像素的总数。添加对多屏幕的支持时，应用程序不会直接使用分辨率；应用程序应该只关心屏幕尺寸和密度，如通用尺寸和密度组所指定的那样。</p>
<p><strong>密度无关像素 (dp)</strong><br>
 定义 UI 布局时应使用的虚拟像素单位，以与密度无关的方式表达布局尺寸或位置。与密度无关的像素相当于 160 dpi
屏幕上的一个物理像素，这是系统为“中等”密度屏幕假定的基线密度。在运行时，系统根据使用中屏幕的实际密度，根据需要透明地处理 dp 单位的任何缩放。dp
单位到屏幕像素的转换很简单：<code>px = dp * (dpi / 160)</code>. 例如，在 240 dpi 的屏幕上，1 dp 等于 1.5
个物理像素。在定义应用程序的 UI 时，您应该始终使用 dp 单位，以确保您的 UI 在不同密度的屏幕上正确显示。</p>
</blockquote>
<p>如果您真的想为不止一种类型的设备开发 Android
应用程序，您应该至少阅读一次屏幕支持开发文档。除此之外，了解具有特定屏幕配置的活动设备的实际数量总是一件好事。</p>
<ul>
<li>屏幕尺寸和密度</li>
</ul>
<p><br><br><a href="posts/what-is-the-difference-between-px-dip-dp-and-sp/">查看原文</a></p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/ru-he-fan-hui-yi-bu-diao-yong-de-xiang-ying/" class="u-url">如何返回异步调用的响应？</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/ru-he-fan-hui-yi-bu-diao-yong-de-xiang-ying/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T18:30:21+08:00" itemprop="datePublished" title="2023-02-16 18:30">2023-02-16 18:30</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>如何从<code>foo</code>发出异步请求的函数返回响应/结果？</p>
<p>我正在尝试从回调中返回值，并将结果分配给函数内的局部变量并返回该局部变量，但这些方法都没有真正返回响应——它们都返回或返回变量的初始<code>undefined</code>值<code>result</code>是。</p>
<p><strong>接受回调的异步函数示例</strong> （使用 jQuery 的<code>ajax</code>函数）：</p>
<div class="code"><pre class="code literal-block"><span class="k">function</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">var</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="n">$</span><span class="p">.</span><span class="n">ajax</span><span class="p">(</span><span class="err">{</span>
<span class="w">        </span><span class="n">url</span><span class="o">:</span><span class="w"> </span><span class="s1">'...'</span><span class="p">,</span>
<span class="w">        </span><span class="n">success</span><span class="o">:</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">;</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">tried</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="k">one</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">well</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="k">always</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="n n-Quoted">`undefined`</span>
<span class="err">}</span>
</pre></div>

<p><strong>使用 Node.js 的示例：</strong></p>
<div class="code"><pre class="code literal-block"><span class="k">function</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">var</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="n">fs</span><span class="p">.</span><span class="n">readFile</span><span class="p">(</span><span class="s2">"path/to/file"</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="p">;</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">tried</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="k">one</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">well</span>
<span class="w">    </span><span class="err">}</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="k">always</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="n n-Quoted">`undefined`</span>
<span class="err">}</span>
</pre></div>

<p><strong>使用<code>then</code>承诺块的示例：</strong></p>
<div class="code"><pre class="code literal-block"><span class="k">function</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">var</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="k">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">;</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">tried</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="k">one</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">well</span>
<span class="w">    </span><span class="err">}</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="k">always</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="n n-Quoted">`undefined`</span>
<span class="err">}</span>
</pre></div>

<p><br><br></p>
<h2>解答</h2>
<blockquote>
<p><em>→ 有关不同示例的异步行为的更一般解释，请参阅</em> 为什么我的变量在函数内部修改后未更改？- 异步代码参考</p>
<p><em>→ 如果您已经了解问题，请跳至以下可能的解决方案。</em></p>
</blockquote>
<h2>问题</h2>
<p>Ajax <strong>中</strong> 的A代表 <strong>异步</strong>
。这意味着发送请求（或者更确切地说接收响应）被从正常的执行流程中取出。在您的示例中，立即返回并且下一条语句在您作为回调传递的函数被调用之前执行。
****<code>$.ajax``return result;``success</code></p>
<p>这是一个类比，希望能使同步和异步流之间的区别更清楚：</p>
<h3>同步</h3>
<p>想象一下，您打电话给朋友，请他为您查找一些东西。虽然这可能需要一段时间，但您会在电话中等待并凝视太空，直到您的朋友给您所需的答案。</p>
<p>当您进行包含“正常”代码的函数调用时，也会发生同样的情况：</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">findItem</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">item</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">item_not_found</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">search</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">item</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">var</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findItem</span><span class="p">();</span>

<span class="o">//</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">item</span>
<span class="n">doSomethingElse</span><span class="p">();</span>
</pre></div>

<p>尽管<code>findItem</code>可能需要很长时间才能执行，但之后的任何代码都<code>var item = findItem();</code>必须 <em>等到</em> 函数返回结果。</p>
<h3>异步</h3>
<p>你出于同样的原因再次打电话给你的朋友。但是这次你告诉他你有急事，他应该用你的手机给 <em>你回电话。</em>
你挂断电话，离开房子，做你想做的事。一旦你的朋友给你回电话，你就在处理他给你的信息。</p>
<p>这正是您发出 Ajax 请求时发生的情况。</p>
<div class="code"><pre class="code literal-block"><span class="nv">findItem</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">item</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Do</span><span class="w"> </span><span class="nv">something</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">item</span>
}<span class="ss">)</span><span class="c1">;</span>
<span class="nv">doSomethingElse</span><span class="ss">()</span><span class="c1">;</span>
</pre></div>

<p>不是等待响应，而是立即继续执行并执行 Ajax 调用之后的语句。为了最终获得响应，您提供了一个函数，一旦收到响应就会被调用，一个 <em>回调</em> （注意什么？
<em>回调</em> ？）。在调用回调之前执行该调用之后的任何语句。</p>
<hr>
<h2>解决方案</h2>
<p><strong>拥抱 JavaScript 的异步特性！</strong> 虽然某些异步操作提供了同步对应物（“Ajax”也是如此），但通常不鼓励使用它们，尤其是在浏览器上下文中。</p>
<p>你问为什么不好？</p>
<p>JavaScript 在浏览器的 UI 线程中运行，任何长时间运行的进程都会锁定 UI，使其无响应。另外，JavaScript
的执行时间是有上限的，浏览器会询问用户是否继续执行。</p>
<p>所有这些都会导致非常糟糕的用户体验。用户将无法判断是否一切正常。此外，对于连接速度较慢的用户，效果会更差。</p>
<p>在下文中，我们将研究三种不同的解决方案，它们都是相互构建的：</p>
<ul>
<li>
<strong>Promises with<code>async/await</code></strong>（ES2017+，如果您使用转译器或再生器，则在旧浏览器中可用）</li>
<li>
<strong>回调</strong> （node中流行）</li>
<li>
<strong>Promises with<code>then()</code></strong>（ES2015+，如果您使用许多 promise 库之一，则在旧浏览器中可用）</li>
</ul>
<p><strong>所有这三个在当前浏览器和节点 7+ 中都可用。</strong></p>
<hr>
<h3>ES2017+：承诺<code>async/await</code>
</h3>
<p>2017 年发布的 ECMAScript 版本引入了对异步函数的 <em>语法级支持</em>
。<code>async</code>在和的帮助下<code>await</code>，您可以用“同步风格”编写异步代码。代码仍然是异步的，但更容易阅读/理解。</p>
<p><code>async/await</code>建立在承诺之上：一个<code>async</code>函数总是返回一个承诺。<code>await</code>“解开”一个承诺，要么产生承诺被解决的价值，要么在承诺被拒绝时抛出错误。</p>
<p><strong>重要提示：</strong> 您只能在函数<code>await</code>内部<code>async</code>或JavaScript
模块中使用。模块外部不支持顶层，因此如果不使用模块，<code>await</code>您可能必须创建一个异步 IIFE（立即调用函数表达式）来启动上下文。<code>async</code></p>
<p>您可以在 MDN 上阅读更多<code>async</code>内容<code>await</code>。</p>
<p>这是一个详细说明上述 <em>延迟</em> 功能的示例<code>findItem()</code>：</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="s1">'superagent'</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">promise</span><span class="p">.</span>
<span class="n">var</span><span class="w"> </span><span class="n">superagent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">require</span><span class="p">(</span><span class="s1">'superagent'</span><span class="p">)</span>

<span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">isn</span><span class="s1">'t declared as `async` because it already returns a promise</span>
<span class="s1">function delay() {</span>
<span class="s1">  // `delay` returns a promise</span>
<span class="s1">  return new Promise(function(resolve, reject) {</span>
<span class="s1">    // Only `delay` is able to resolve or reject the promise</span>
<span class="s1">    setTimeout(function() {</span>
<span class="s1">      resolve(42); // After 3 seconds, resolve the promise with value 42</span>
<span class="s1">    }, 3000);</span>
<span class="s1">  });</span>
<span class="s1">}</span>

<span class="s1">async function getAllBooks() {</span>
<span class="s1">  try {</span>
<span class="s1">    // GET a list of book IDs of the current user</span>
<span class="s1">    var bookIDs = await superagent.get('</span><span class="o">/</span><span class="k">user</span><span class="o">/</span><span class="n">books</span><span class="s1">');</span>
<span class="s1">    // wait for 3 seconds (just for the sake of this example)</span>
<span class="s1">    await delay();</span>
<span class="s1">    // GET information about each book</span>
<span class="s1">    return superagent.get('</span><span class="o">/</span><span class="n">books</span><span class="o">/</span><span class="n">ids</span><span class="o">=</span><span class="s1">'+JSON.stringify(bookIDs));</span>
<span class="s1">  } catch(error) {</span>
<span class="s1">    // If any of the awaited promises was rejected, this catch block</span>
<span class="s1">    // would catch the rejection reason</span>
<span class="s1">    return null;</span>
<span class="s1">  }</span>
<span class="s1">}</span>

<span class="s1">// Start an IIFE to use `await` at the top level</span>
<span class="s1">(async function(){</span>
<span class="s1">  let books = await getAllBooks();</span>
<span class="s1">  console.log(books);</span>
<span class="s1">})();</span>
</pre></div>

<p>当前浏览器和节点版本支持<code>async/await</code>. 您还可以借助regenerator（或使用 regenerator
的工具，例如Babel）将您的代码转换为 ES5，从而支持较旧的环境。</p>
<hr>
<h3>让函数接受 <em>回调</em>
</h3>
<p>回调是当函数 1 传递给函数 2 时。函数 2 可以在准备就绪时调用函数 1。在异步进程的上下文中，只要异步进程完成，就会调用回调。通常，结果会传递给回调。</p>
<p>在问题的示例中，您可以<code>foo</code>接受回调并将其用作<code>success</code>回调。所以这</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span>
<span class="o">//</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="s1">'result'</span>
</pre></div>

<p>成为</p>
<div class="code"><pre class="code literal-block">foo(function(result) {
    // Code that depends on 'result'
});
</pre></div>

<p>这里我们定义了“内联”函数，但您可以传递任何函数引用：</p>
<div class="code"><pre class="code literal-block">function myCallback(result) {
    // Code that depends on 'result'
}

foo(myCallback);
</pre></div>

<p><code>foo</code>本身定义如下：</p>
<div class="code"><pre class="code literal-block"><span class="nt">function</span><span class="w"> </span><span class="nt">foo</span><span class="o">(</span><span class="nt">callback</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">$.ajax({</span>
<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">...</span>
<span class="w">        </span><span class="n">success</span><span class="p">:</span><span class="w"> </span><span class="n">callback</span>
<span class="w">    </span><span class="p">}</span><span class="o">);</span>
<span class="err">}</span>
</pre></div>

<p><code>callback</code>将引用我们调用它时传递给的函数<code>foo</code>，然后将其传递给<code>success</code>. 即一旦 Ajax
请求成功，<code>$.ajax</code>将调用<code>callback</code>并将响应传递给回调（可以用 引用<code>result</code>，因为这是我们定义回调的方式）。</p>
<p>您还可以在将响应传递给回调之前对其进行处理：</p>
<div class="code"><pre class="code literal-block"><span class="nt">function</span><span class="w"> </span><span class="nt">foo</span><span class="o">(</span><span class="nt">callback</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">$.ajax({</span>
<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">...</span>
<span class="w">        </span><span class="n">success</span><span class="p">:</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">example</span><span class="p">,</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">response</span>
<span class="w">            </span><span class="nf">callback</span><span class="p">(</span><span class="n">filtered_response</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="err">}</span><span class="o">);</span>
<span class="err">}</span>
</pre></div>

<p>使用回调编写代码比看起来更容易。毕竟，浏览器中的 JavaScript 是高度事件驱动的（DOM 事件）。接收 Ajax
响应只是一个事件。当您必须使用第三方代码时可能会遇到困难，但大多数问题都可以通过考虑应用程序流程来解决。</p>
<hr>
<h3>ES2015+：用then()承诺</h3>
<p>Promise API是 ECMAScript 6 (ES2015) 的一个新特性，但它已经有很好的浏览器支持。还有许多库实现了标准的 Promises
API，并提供了额外的方法来简化异步函数的使用和组合（例如，bluebird）。</p>
<p><em>承诺是未来</em> 价值的容器。当 promise 收到值（已 <em>解决</em> ）或取消（ <em>已拒绝</em> ）时，它会通知所有想要访问该值的“侦听器”。</p>
<p>与普通回调相比的优势在于它们允许您解耦代码并且更易于编写。</p>
<p>下面是一个使用 promise 的例子：</p>
<div class="code"><pre class="code literal-block"><span class="k">function</span><span class="w"> </span><span class="n">delay</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n n-Quoted">`delay`</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">promise</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Promise</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">resolve</span><span class="p">,</span><span class="w"> </span><span class="n">reject</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Only</span><span class="w"> </span><span class="n n-Quoted">`delay`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">able</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">resolve</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">reject</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">promise</span>
<span class="w">    </span><span class="k">set</span><span class="n">Timeout</span><span class="p">(</span><span class="k">function</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="n">resolve</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">After</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">seconds</span><span class="p">,</span><span class="w"> </span><span class="n">resolve</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">promise</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="mi">42</span>
<span class="w">    </span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="mi">3000</span><span class="p">);</span>
<span class="w">  </span><span class="err">}</span><span class="p">);</span>
<span class="err">}</span>

<span class="n">delay</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="k">then</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n n-Quoted">`delay`</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">promise</span>
<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">v</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Log</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">resolved</span>
<span class="w">  </span><span class="err">}</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">catch</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Or</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">rejected</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="n">would</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">happen</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">example</span><span class="p">,</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n n-Quoted">`reject`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">called</span><span class="p">).</span>
<span class="w">  </span><span class="err">}</span><span class="p">);</span>


<span class="p">.</span><span class="k">as</span><span class="o">-</span><span class="n">console</span><span class="o">-</span><span class="k">wrapper</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">max</span><span class="o">-</span><span class="n">height</span><span class="o">:</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span><span class="w"> </span><span class="o">!</span><span class="n">important</span><span class="p">;</span><span class="w"> </span><span class="n">top</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="err">}</span>
</pre></div>

<p>Applied to our Ajax call we could use promises like this:</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">ajax</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Promise</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">resolve</span><span class="p">,</span><span class="w"> </span><span class="n">reject</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">xhr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">XMLHttpRequest</span><span class="p">();</span>
<span class="w">    </span><span class="n">xhr</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">resolve</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">responseText</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">xhr</span><span class="o">.</span><span class="n">onerror</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reject</span><span class="p">;</span>
<span class="w">    </span><span class="n">xhr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p">);</span>
<span class="w">    </span><span class="n">xhr</span><span class="o">.</span><span class="n">send</span><span class="p">();</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="n">ajax</span><span class="p">(</span><span class="s2">"https://jsonplaceholder.typicode.com/todos/1"</span><span class="p">)</span>
<span class="w">  </span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="n">depending</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">result</span>
<span class="w">  </span><span class="p">})</span>
<span class="w">  </span><span class="o">.</span><span class="n">catch</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">An</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">occurred</span>
<span class="w">  </span><span class="p">});</span>


<span class="o">.</span><span class="k">as</span><span class="o">-</span><span class="n">console</span><span class="o">-</span><span class="n">wrapper</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">max</span><span class="o">-</span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span><span class="w"> </span><span class="o">!</span><span class="n">important</span><span class="p">;</span><span class="w"> </span><span class="n">top</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</pre></div>

<p>Describing all the advantages that promise offer is beyond the scope of this
answer, but if you write new code, you should seriously consider them. They
provide a great abstraction and separation of your code.</p>
<p>More information about promises: HTML5 rocks - JavaScript Promises.</p>
<h4>Side note: jQuery's deferred objects</h4>
<p>Deferred objects are jQuery's custom implementation of promises (before the
Promise API was standardized). They behave almost like promises but expose a
slightly different API.</p>
<p>Every Ajax method of jQuery already returns a "deferred object" (actually a
promise of a deferred object) which you can just return from your function:</p>
<div class="code"><pre class="code literal-block"><span class="nv">function</span><span class="w"> </span><span class="nv">ajax</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">    </span><span class="k">return</span><span class="w"> </span>$.<span class="nv">ajax</span><span class="ss">(</span>...<span class="ss">)</span><span class="c1">;</span>
}

<span class="nv">ajax</span><span class="ss">()</span>.<span class="nv">done</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nb">result</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nv">Code</span><span class="w"> </span><span class="nv">depending</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nb">result</span>
}<span class="ss">)</span>.<span class="nv">fail</span><span class="ss">(</span><span class="nv">function</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nv">An</span><span class="w"> </span><span class="nv">error</span><span class="w"> </span><span class="nv">occurred</span>
}<span class="ss">)</span><span class="c1">;</span>
</pre></div>

<h4>Side note: Promise gotchas</h4>
<p>Keep in mind that promises and deferred objects are just <em>containers</em> for a
future value, they are not the value itself. For example, suppose you had the
following:</p>
<div class="code"><pre class="code literal-block"><span class="nt">function</span><span class="w"> </span><span class="nt">checkPassword</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">$.ajax({</span>
<span class="w">        </span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="s1">'/password'</span><span class="p">,</span>
<span class="w">        </span><span class="n">data</span><span class="o">:</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">username</span><span class="o">:</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="s1">'#username'</span><span class="p">)</span><span class="o">.</span><span class="nf">val</span><span class="p">(),</span>
<span class="w">            </span><span class="n">password</span><span class="o">:</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="s1">'#password'</span><span class="p">)</span><span class="o">.</span><span class="nf">val</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span><span class="o">,</span>
<span class="w">        </span><span class="nt">type</span><span class="o">:</span><span class="w"> </span><span class="s1">'POST'</span><span class="o">,</span>
<span class="w">        </span><span class="nt">dataType</span><span class="o">:</span><span class="w"> </span><span class="s1">'json'</span>
<span class="w">    </span><span class="err">}</span><span class="o">);</span>
<span class="err">}</span>

<span class="nt">if</span><span class="w"> </span><span class="o">(</span><span class="nt">checkPassword</span><span class="o">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">Tell</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">they're</span><span class="w"> </span><span class="err">logged</span><span class="w"> </span><span class="err">in</span>
<span class="p">}</span>
</pre></div>

<p>This code misunderstands the above asynchronous issues. Specifically,
<code>$.ajax()</code> doesn't freeze the code while it checks the '/password' page on
your server - it sends a request to the server and while it waits, it
immediately returns a jQuery Ajax Deferred object, not the response from the
server. That means the <code>if</code> statement is going to always get this Deferred
object, treat it as <code>true</code>, and proceed as though the user is logged in. Not
good.</p>
<p>But the fix is easy:</p>
<div class="code"><pre class="code literal-block"><span class="nf">checkPassword</span><span class="p">()</span>
<span class="na">.done</span><span class="p">(</span><span class="no">function</span><span class="p">(</span><span class="no">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="no">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Tell the user they're logged in</span>
<span class="w">    </span><span class="err">}</span><span class="w"> </span><span class="nf">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Tell the user their password was bad</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">})</span>
<span class="na">.fail</span><span class="p">(</span><span class="no">function</span><span class="p">(</span><span class="no">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Tell the user something bad happened</span>
<span class="err">})</span><span class="c1">;</span>
</pre></div>

<hr>
<h3>Not recommended: Synchronous "Ajax" calls</h3>
<p>As I mentioned, some(!) asynchronous operations have synchronous counterparts.
I don't advocate their use, but for completeness' sake, here is how you would
perform a synchronous call:</p>
<h4>Without jQuery</h4>
<p>If you directly use a <code>XMLHttpRequest</code> object, pass <code>false</code> as third argument
to <code>.open</code>.</p>
<h4>jQuery</h4>
<p>If you use jQuery, you can set the <code>async</code> option to <code>false</code>. Note that this
option is <em>deprecated</em> since jQuery 1.8. You can then either still use a
<code>success</code> callback or access the <code>responseText</code> property of the jqXHR object:</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">jqXHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$.</span><span class="n">ajax</span><span class="p">({</span>
<span class="w">        </span><span class="o">//...</span>
<span class="w">        </span><span class="n">async</span><span class="p">:</span><span class="w"> </span><span class="bp">false</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">jqXHR</span><span class="o">.</span><span class="n">responseText</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>If you use any other jQuery Ajax method, such as <code>$.get</code>, <code>$.getJSON</code>, etc.,
you have to change it to <code>$.ajax</code> (since you can only pass configuration
parameters to <code>$.ajax</code>).</p>
<p><strong>Heads up!</strong> It is not possible to make a synchronous JSONP request. JSONP by
its very nature is always asynchronous (one more reason to not even consider
this option).</p>
<p><br></p>
<h3>更多建议</h3>
<h2>如果您 <em>没有</em> 在代码中使用 jQuery，那么这个答案适合您</h2>
<p>你的代码应该是这样的：</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">httpRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">XMLHttpRequest</span><span class="p">();</span>
<span class="w">    </span><span class="n">httpRequest</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span><span class="w"> </span><span class="s2">"/echo/json"</span><span class="p">);</span>
<span class="w">    </span><span class="n">httpRequest</span><span class="o">.</span><span class="n">send</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">httpRequest</span><span class="o">.</span><span class="n">responseText</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Always</span><span class="w"> </span><span class="n">ends</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">being</span><span class="w"> </span><span class="s1">'undefined'</span>
</pre></div>

<p>Felix Kling 为使用 jQuery for AJAX 的人写了一个很好的答案，但我决定为那些不使用 jQuery 的人提供一个替代方案。</p>
<p>（注意，对于那些使用新<code>fetch</code>API、Angular 或 promises 的人，我在下面添加了另一个答案）</p>
<hr>
<h2>你面对的是什么</h2>
<p>这是来自另一个答案的“问题解释”的简短摘要，如果您在阅读本文后不确定，请阅读。</p>
<p><strong>AJAX中</strong> 的A代表 <strong>异步</strong>
。这意味着发送请求（或者更确切地说接收响应）被从正常的执行流程中取出。在您的示例中，<code>.send</code>立即返回并且下一条语句<code>return
result;</code>在您作为回调传递的函数<code>success</code>被调用之前执行。</p>
<p>这意味着当您返回时，您定义的侦听器尚未执行，这意味着您返回的值尚未定义。</p>
<p>这是一个简单的类比：</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">getFive</span><span class="p">(){</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="n">setTimeout</span><span class="p">(</span><span class="n">function</span><span class="p">(){</span>
<span class="w">         </span><span class="n">a</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>（小提琴）</p>
<p>返回的值<code>a</code>是<code>undefined</code>因为该<code>a=5</code>部分尚未执行。AJAX 就像这样，您在服务器有机会告诉您的浏览器该值是什么之前返回该值。</p>
<p>此问题的一种可能解决方案是 <em>重新</em> 编码，告诉您的程序在计算完成后要做什么。</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">onComplete</span><span class="p">(</span><span class="n">a</span><span class="p">){</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">When</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">completes</span><span class="p">,</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">this</span>
<span class="w">    </span><span class="n">alert</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">function</span><span class="w"> </span><span class="n">getFive</span><span class="p">(</span><span class="n">whenDone</span><span class="p">){</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="n">setTimeout</span><span class="p">(</span><span class="n">function</span><span class="p">(){</span>
<span class="w">         </span><span class="n">a</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
<span class="w">         </span><span class="n">whenDone</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>这称为CPS。基本上，我们传递<code>getFive</code>一个动作以在它完成时执行，我们告诉我们的代码如何在事件完成时做出反应（比如我们的 AJAX
调用，或者在本例中为超时）。</p>
<p>用法是：</p>
<div class="code"><pre class="code literal-block">getFive(onComplete);
</pre></div>

<p>哪个应该在屏幕上提醒“5”。（小提琴）。</p>
<h2>可能的解决方案</h2>
<p>基本上有两种方法可以解决这个问题：</p>
<ol>
<li>使 AJAX 调用同步（我们称之为 SJAX）。</li>
<li>重组您的代码以正确使用回调。</li>
</ol>
<h3>1. 同步 AJAX - 不要这样做！！</h3>
<p>至于同步AJAX， <strong>千万别做！</strong> Felix
的回答引发了一些令人信服的论点，说明为什么这是个坏主意。总而言之，它会冻结用户的浏览器，直到服务器返回响应并造成非常糟糕的用户体验。这是另一个来自 MDN
的简短摘要，说明了原因：</p>
<blockquote>
<p>XMLHttpRequest 支持同步和异步通信。然而，一般来说，出于性能原因，异步请求应该优于同步请求。</p>
<p>简而言之，同步请求会阻塞代码的执行…………这会导致严重的问题……</p>
</blockquote>
<p>如果你 <em>必须</em> 这样做，你可以传递一个标志。方法如下：</p>
<div class="code"><pre class="code literal-block"><span class="n">var</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XMLHttpRequest</span><span class="p">();</span>
<span class="n">request</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yourURL'</span><span class="p">,</span><span class="w"> </span><span class="no">false</span><span class="p">);</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n n-Quoted">`false`</span><span class="w"> </span><span class="n">makes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">synchronous</span>
<span class="n">request</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="no">null</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="k">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="o">//</span><span class="w"> </span><span class="n">That</span><span class="s1">'s HTTP for '</span><span class="n">ok</span><span class="s1">'</span>
<span class="s1">  console.log(request.responseText);</span>
<span class="s1">}</span>
</pre></div>

<h3>2.重构代码</h3>
<p>让您的函数接受回调。在示例代码中<code>foo</code>可以接受回调。我们将告诉我们的代码在完成时如何 <em>反应</em><code>foo</code>。</p>
<p>所以：</p>
<div class="code"><pre class="code literal-block"><span class="n">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span>
<span class="o">//</span><span class="w"> </span><span class="k">Code</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n n-Quoted">`result`</span><span class="w"> </span><span class="n">goes</span><span class="w"> </span><span class="n">here</span>
</pre></div>

<p>变成：</p>
<div class="code"><pre class="code literal-block"><span class="n">foo</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Code</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n n-Quoted">`result`</span>
<span class="err">}</span><span class="p">);</span>
</pre></div>

<p>这里我们传递了一个匿名函数，但我们也可以轻松地传递对现有函数的引用，使其看起来像：</p>
<div class="code"><pre class="code literal-block"><span class="k">function</span><span class="w"> </span><span class="n">myHandler</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Code</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n n-Quoted">`result`</span>
<span class="err">}</span>
<span class="n">foo</span><span class="p">(</span><span class="n">myHandler</span><span class="p">);</span>
</pre></div>

<p>有关如何完成此类回调设计的更多详细信息，请查看 Felix 的回答。</p>
<p>现在，让我们定义 foo 本身以相应地采取行动</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">httpRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">XMLHttpRequest</span><span class="p">();</span>
<span class="w">    </span><span class="n">httpRequest</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">(){</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">When</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">loaded</span>
<span class="w">       </span><span class="n">callback</span><span class="p">(</span><span class="n">httpRequest</span><span class="o">.</span><span class="n">responseText</span><span class="p">);</span><span class="o">//</span><span class="w"> </span><span class="n">We</span><span class="s1">'re calling our method</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">httpRequest</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span><span class="w"> </span><span class="s2">"/echo/json"</span><span class="p">);</span>
<span class="w">    </span><span class="n">httpRequest</span><span class="o">.</span><span class="n">send</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>（小提琴）</p>
<p>我们现在已经让我们的 <em>foo</em> 函数接受一个动作，在 AJAX 成功完成时运行。我们可以通过检查响应状态是否不是 200
并采取相应行动（创建失败处理程序等）来进一步扩展它。它有效地解决了我们的问题。</p>
<p>如果您仍然难以理解这一点，请阅读 MDN 上的 AJAX 入门指南。</p>
<p><br><br><a href="posts/how-do-i-return-the-response-from-an-asynchronous-call/">查看原文</a></p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-13.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-11.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
