<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a snapshot site for StackOverflow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StackOverflow Snapshot (old posts, page 12) | StackOverflow Snapshot</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/index-12.html">
<link rel="prev" href="index-13.html" type="text/html">
<link rel="next" href="index-11.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/what-is-the-difference-between-px-dip-dp-and-sp/" class="u-url">What is the difference between px, dip, dp, and sp?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/what-is-the-difference-between-px-dip-dp-and-sp/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T18:30:30+08:00" itemprop="datePublished" title="2023-02-16 18:30">2023-02-16 18:30</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>What is the difference between the units of measure px, dip, dp, and sp?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>From the Android Developer Documentation:</p>
<ol>
<li>
<blockquote>
<p><strong>px</strong><br><strong>Pixels</strong> - corresponds to actual pixels on the screen.</p>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>in</strong><br><strong>Inches</strong> - based on the physical size of the screen.<br>
 1 Inch OR 2.54 centimeters</p>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>mm</strong>  </p>
<blockquote>
<p><strong>Millimeters</strong> - based on the physical size of the screen.</p>
</blockquote>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>pt</strong>  </p>
<blockquote>
<p><strong>Points</strong> - 1/72 of an inch based on the physical size of the screen.</p>
</blockquote>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>dp</strong> or <strong>dip</strong>  </p>
<blockquote>
<p><strong>Density</strong> -independent Pixels - an abstract unit that is based on the
physical density of the screen. These units are relative to a 160 dpi
screen, so one dp is one pixel on a 160 dpi screen. The ratio of dp-to-pixel
will change with the screen density, but not necessarily in direct
proportion. Note: The compiler accepts both "dip" and "dp", though "dp" is
more consistent with "sp".</p>
</blockquote>
</blockquote>
</li>
<li>
<blockquote>
<p><strong>sp</strong>  </p>
<blockquote>
<p>Scaleable Pixels <strong>OR</strong> scale-independent pixels - this is like the dp
unit, but it is also scaled by the user's font size preference. It is
recommended you use this unit when specifying font sizes, so they will be
adjusted for both the screen density and the user's preference. Note, the
Android documentation is inconsistent on what <code>sp</code> actually stands for, one
doc says "scale-independent pixels", the other says "scaleable pixels".</p>
</blockquote>
</blockquote>
</li>
</ol>
<p>From Understanding Density Independence In Android:</p>
<table>
<thead><tr>
<th>Density Bucket</th>
<th>Screen Density</th>
<th>Physical Size</th>
<th>Pixel Size</th>
</tr></thead>
<tbody>
<tr>
<td>ldpi</td>
<td>120 dpi</td>
<td>0.5 x 0.5 in</td>
<td>0.5 in * 120 dpi = 60x60 px</td>
</tr>
<tr>
<td>mdpi</td>
<td>160 dpi</td>
<td>0.5 x 0.5 in</td>
<td>0.5 in * 160 dpi = 80x80 px</td>
</tr>
<tr>
<td>hdpi</td>
<td>240 dpi</td>
<td>0.5 x 0.5 in</td>
<td>0.5 in * 240 dpi = 120x120 px</td>
</tr>
<tr>
<td>xhdpi</td>
<td>320 dpi</td>
<td>0.5 x 0.5 in</td>
<td>0.5 in * 320 dpi = 160x160 px</td>
</tr>
<tr>
<td>xxhdpi</td>
<td>480 dpi</td>
<td>0.5 x 0.5 in</td>
<td>0.5 in * 480 dpi = 240x240 px</td>
</tr>
<tr>
<td>xxxhdpi</td>
<td>640 dpi</td>
<td>0.5 x 0.5 in</td>
<td>0.5 in * 640 dpi = 320x320 px</td>
</tr>
</tbody>
</table>
<p>Unit | Description | Units Per Physical Inch | Density Independent? | Same
Physical Size On Every Screen?<br>
---|---|---|---|---<br>
px | Pixels | Varies | No | No<br>
in | Inches | 1 | Yes | Yes<br>
mm | Millimeters | 25.4 | Yes | Yes<br>
pt | Points | 72 | Yes | Yes<br>
dp | Density Independent Pixels | ~160 | Yes | No<br>
sp | Scale Independent Pixels | ~160 | Yes | No  </p>
<p>More info can be also be found in the Google Design Documentation.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Pretty much everything about this and how to achieve the best support for
multiple screens of different sizes and densities is very well documented
here:</p>
<ul>
<li>Supporting Multiple Screens</li>
</ul>
<blockquote>
<p><strong>Screen size</strong><br>
 Actual physical size, measured as the screen's diagonal. For simplicity,
Android groups all actual screen sizes into four generalized sizes: small,
normal, large, and extra-large.</p>
<p><strong>Screen density</strong><br>
 The number of pixels within a physical area of the screen; usually referred
to as dpi (dots per inch). For example, a "low" density screen has fewer
pixels within a given physical area, compared to a "normal" or "high"
density screen. For simplicity, Android groups all actual screen densities
into six generalized densities: low, medium, high, extra-high, extra-extra-
high, and extra-extra-extra-high.</p>
<p><strong>Orientation</strong><br>
 The orientation of the screen from the user's point of view. This is either
landscape or portrait, meaning that the screen's aspect ratio is either wide
or tall, respectively. Be aware that not only do different devices operate
in different orientations by default, but the orientation can change at
runtime when the user rotates the device.</p>
<p><strong>Resolution</strong><br>
 The total number of physical pixels on a screen. When adding support for
multiple screens, applications do not work directly with resolution;
applications should be concerned only with screen size and density, as
specified by the generalized size and density groups.</p>
<p><strong>Density-independent pixel (dp)</strong><br>
 A virtual pixel unit that you should use when defining UI layout, to
express layout dimensions or position in a density-independent way. The
density-independent pixel is equivalent to one physical pixel on a 160 dpi
screen, which is the baseline density assumed by the system for a "medium"
density screen. At runtime, the system transparently handles any scaling of
the dp units, as necessary, based on the actual density of the screen in
use. The conversion of dp units to screen pixels is simple: <code>px = dp * (dpi
/ 160)</code>. For example, on a 240 dpi screen, 1 dp equals 1.5 physical pixels.
You should always use dp units when defining your application's UI, to
ensure proper display of your UI on screens with different densities.</p>
</blockquote>
<p>If you are at all serious about developing an Android app for more than one
type of device, you should have read the screens support development document
at least once. In addition to that, it is always a good thing to know the
actual number of active devices that have a particular screen configuration.</p>
<ul>
<li>Screen Sizes and Densities</li>
</ul>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-do-i-return-the-response-from-an-asynchronous-call/" class="u-url">How do I return the response from an asynchronous call?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-do-i-return-the-response-from-an-asynchronous-call/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T18:29:52+08:00" itemprop="datePublished" title="2023-02-16 18:29">2023-02-16 18:29</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>How do I return the response/result from a function <code>foo</code> that makes an
asynchronous request?</p>
<p>I am trying to return the value from the callback, as well as assigning the
result to a local variable inside the function and returning that one, but
none of those ways actually return the response — they all return <code>undefined</code>
or whatever the initial value of the variable <code>result</code> is.</p>
<p><strong>Example of an asynchronous function that accepts a callback</strong> (using
jQuery's <code>ajax</code> function):</p>
<div class="code"><pre class="code literal-block"><span class="k">function</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">var</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="n">$</span><span class="p">.</span><span class="n">ajax</span><span class="p">(</span><span class="err">{</span>
<span class="w">        </span><span class="n">url</span><span class="o">:</span><span class="w"> </span><span class="s1">'...'</span><span class="p">,</span>
<span class="w">        </span><span class="n">success</span><span class="o">:</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">;</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">tried</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="k">one</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">well</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="k">always</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="n n-Quoted">`undefined`</span>
<span class="err">}</span>
</pre></div>

<p><strong>Example using Node.js:</strong></p>
<div class="code"><pre class="code literal-block"><span class="k">function</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">var</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="n">fs</span><span class="p">.</span><span class="n">readFile</span><span class="p">(</span><span class="s2">"path/to/file"</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">data</span><span class="p">;</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">data</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">tried</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="k">one</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">well</span>
<span class="w">    </span><span class="err">}</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="k">always</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="n n-Quoted">`undefined`</span>
<span class="err">}</span>
</pre></div>

<p><strong>Example using the<code>then</code> block of a promise:</strong></p>
<div class="code"><pre class="code literal-block"><span class="k">function</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">var</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="k">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">;</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">tried</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="k">one</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">well</span>
<span class="w">    </span><span class="err">}</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="k">always</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="n n-Quoted">`undefined`</span>
<span class="err">}</span>
</pre></div>

<p><br><br></p>
<h2>Answer</h2>
<blockquote>
<p><em>→ For a more general explanation of asynchronous behaviour with different
examples, see</em> Why is my variable unaltered after I modify it inside of a
function? - Asynchronous code reference</p>
<p><em>→ If you already understand the problem, skip to the possible solutions
below.</em></p>
</blockquote>
<h2>The problem</h2>
<p>The <strong>A</strong> in Ajax stands for <strong>asynchronous</strong>. That means sending the request
(or rather receiving the response) is taken out of the normal execution flow.
In your example, <code>$.ajax</code> returns immediately and the next statement, <code>return
result;</code>, is executed before the function you passed as <code>success</code> callback was
even called.</p>
<p>Here is an analogy which hopefully makes the difference between synchronous
and asynchronous flow clearer:</p>
<h3>Synchronous</h3>
<p>Imagine you make a phone call to a friend and ask him to look something up for
you. Although it might take a while, you wait on the phone and stare into
space, until your friend gives you the answer that you needed.</p>
<p>The same is happening when you make a function call containing "normal" code:</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">findItem</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">item</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">item_not_found</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">search</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">item</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">var</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findItem</span><span class="p">();</span>

<span class="o">//</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">item</span>
<span class="n">doSomethingElse</span><span class="p">();</span>
</pre></div>

<p>Even though <code>findItem</code> might take a long time to execute, any code coming
after <code>var item = findItem();</code> has to <em>wait</em> until the function returns the
result.</p>
<h3>Asynchronous</h3>
<p>You call your friend again for the same reason. But this time you tell him
that you are in a hurry and he should <em>call you back</em> on your mobile phone.
You hang up, leave the house, and do whatever you planned to do. Once your
friend calls you back, you are dealing with the information he gave to you.</p>
<p>That's exactly what's happening when you do an Ajax request.</p>
<div class="code"><pre class="code literal-block"><span class="nv">findItem</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nv">item</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Do</span><span class="w"> </span><span class="nv">something</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">item</span>
}<span class="ss">)</span><span class="c1">;</span>
<span class="nv">doSomethingElse</span><span class="ss">()</span><span class="c1">;</span>
</pre></div>

<p>Instead of waiting for the response, the execution continues immediately and
the statement after the Ajax call is executed. To get the response eventually,
you provide a function to be called once the response was received, a
<em>callback</em> (notice something? <em>call back</em> ?). Any statement coming after that
call is executed before the callback is called.</p>
<hr>
<h2>Solution(s)</h2>
<p><strong>Embrace the asynchronous nature of JavaScript!</strong> While certain asynchronous
operations provide synchronous counterparts (so does "Ajax"), it's generally
discouraged to use them, especially in a browser context.</p>
<p>Why is it bad do you ask?</p>
<p>JavaScript runs in the UI thread of the browser and any long-running process
will lock the UI, making it unresponsive. Additionally, there is an upper
limit on the execution time for JavaScript and the browser will ask the user
whether to continue the execution or not.</p>
<p>All of this results in a really bad user experience. The user won't be able to
tell whether everything is working fine or not. Furthermore, the effect will
be worse for users with a slow connection.</p>
<p>In the following we will look at three different solutions that are all
building on top of each other:</p>
<ul>
<li>
<strong>Promises with<code>async/await</code></strong> (ES2017+, available in older browsers if you use a transpiler or regenerator)</li>
<li>
<strong>Callbacks</strong> (popular in node)</li>
<li>
<strong>Promises with<code>then()</code></strong> (ES2015+, available in older browsers if you use one of the many promise libraries)</li>
</ul>
<p><strong>All three are available in current browsers, and node 7+.</strong></p>
<hr>
<h3>ES2017+: Promises with <code>async/await</code>
</h3>
<p>The ECMAScript version released in 2017 introduced <em>syntax-level support</em> for
asynchronous functions. With the help of <code>async</code> and <code>await</code>, you can write
asynchronous in a "synchronous style". The code is still asynchronous, but
it's easier to read/understand.</p>
<p><code>async/await</code> builds on top of promises: an <code>async</code> function always returns a
promise. <code>await</code> "unwraps" a promise and either result in the value the
promise was resolved with or throws an error if the promise was rejected.</p>
<p><strong>Important:</strong> You can only use <code>await</code> inside an <code>async</code> function or in a
JavaScript module. Top-level <code>await</code> is not supported outside of modules, so
you might have to make an async IIFE (Immediately Invoked Function Expression)
to start an <code>async</code> context if not using a module.</p>
<p>You can read more about <code>async</code> and <code>await</code> on MDN.</p>
<p>Here is an example that elaborates the <em>delay</em> function <code>findItem()</code> above:</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="s1">'superagent'</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">promise</span><span class="p">.</span>
<span class="n">var</span><span class="w"> </span><span class="n">superagent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">require</span><span class="p">(</span><span class="s1">'superagent'</span><span class="p">)</span>

<span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">isn</span><span class="s1">'t declared as `async` because it already returns a promise</span>
<span class="s1">function delay() {</span>
<span class="s1">  // `delay` returns a promise</span>
<span class="s1">  return new Promise(function(resolve, reject) {</span>
<span class="s1">    // Only `delay` is able to resolve or reject the promise</span>
<span class="s1">    setTimeout(function() {</span>
<span class="s1">      resolve(42); // After 3 seconds, resolve the promise with value 42</span>
<span class="s1">    }, 3000);</span>
<span class="s1">  });</span>
<span class="s1">}</span>

<span class="s1">async function getAllBooks() {</span>
<span class="s1">  try {</span>
<span class="s1">    // GET a list of book IDs of the current user</span>
<span class="s1">    var bookIDs = await superagent.get('</span><span class="o">/</span><span class="k">user</span><span class="o">/</span><span class="n">books</span><span class="s1">');</span>
<span class="s1">    // wait for 3 seconds (just for the sake of this example)</span>
<span class="s1">    await delay();</span>
<span class="s1">    // GET information about each book</span>
<span class="s1">    return superagent.get('</span><span class="o">/</span><span class="n">books</span><span class="o">/</span><span class="n">ids</span><span class="o">=</span><span class="s1">'+JSON.stringify(bookIDs));</span>
<span class="s1">  } catch(error) {</span>
<span class="s1">    // If any of the awaited promises was rejected, this catch block</span>
<span class="s1">    // would catch the rejection reason</span>
<span class="s1">    return null;</span>
<span class="s1">  }</span>
<span class="s1">}</span>

<span class="s1">// Start an IIFE to use `await` at the top level</span>
<span class="s1">(async function(){</span>
<span class="s1">  let books = await getAllBooks();</span>
<span class="s1">  console.log(books);</span>
<span class="s1">})();</span>
</pre></div>

<p>Current browser and node versions support <code>async/await</code>. You can also support
older environments by transforming your code to ES5 with the help of
regenerator (or tools that use regenerator, such as Babel).</p>
<hr>
<h3>Let functions accept <em>callbacks</em>
</h3>
<p>A callback is when function 1 is passed to function 2. Function 2 can call
function 1 whenever it is ready. In the context of an asynchronous process,
the callback will be called whenever the asynchronous process is done.
Usually, the result is passed to the callback.</p>
<p>In the example of the question, you can make <code>foo</code> accept a callback and use
it as <code>success</code> callback. So this</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span>
<span class="o">//</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="s1">'result'</span>
</pre></div>

<p>becomes</p>
<div class="code"><pre class="code literal-block">foo(function(result) {
    // Code that depends on 'result'
});
</pre></div>

<p>Here we defined the function "inline" but you can pass any function reference:</p>
<div class="code"><pre class="code literal-block">function myCallback(result) {
    // Code that depends on 'result'
}

foo(myCallback);
</pre></div>

<p><code>foo</code> itself is defined as follows:</p>
<div class="code"><pre class="code literal-block"><span class="nt">function</span><span class="w"> </span><span class="nt">foo</span><span class="o">(</span><span class="nt">callback</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">$.ajax({</span>
<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">...</span>
<span class="w">        </span><span class="n">success</span><span class="p">:</span><span class="w"> </span><span class="n">callback</span>
<span class="w">    </span><span class="p">}</span><span class="o">);</span>
<span class="err">}</span>
</pre></div>

<p><code>callback</code> will refer to the function we pass to <code>foo</code> when we call it and we
pass it on to <code>success</code>. I.e. once the Ajax request is successful, <code>$.ajax</code>
will call <code>callback</code> and pass the response to the callback (which can be
referred to with <code>result</code>, since this is how we defined the callback).</p>
<p>You can also process the response before passing it to the callback:</p>
<div class="code"><pre class="code literal-block"><span class="nt">function</span><span class="w"> </span><span class="nt">foo</span><span class="o">(</span><span class="nt">callback</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">$.ajax({</span>
<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">...</span>
<span class="w">        </span><span class="n">success</span><span class="p">:</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">example</span><span class="p">,</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">response</span>
<span class="w">            </span><span class="nf">callback</span><span class="p">(</span><span class="n">filtered_response</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="err">}</span><span class="o">);</span>
<span class="err">}</span>
</pre></div>

<p>It's easier to write code using callbacks than it may seem. After all,
JavaScript in the browser is heavily event-driven (DOM events). Receiving the
Ajax response is nothing else but an event. Difficulties could arise when you
have to work with third-party code, but most problems can be solved by just
thinking through the application flow.</p>
<hr>
<h3>ES2015+: Promises with then()</h3>
<p>The Promise API is a new feature of ECMAScript 6 (ES2015), but it has good
browser support already. There are also many libraries which implement the
standard Promises API and provide additional methods to ease the use and
composition of asynchronous functions (e.g., bluebird).</p>
<p>Promises are containers for <em>future</em> values. When the promise receives the
value (it is <em>resolved</em> ) or when it is canceled ( <em>rejected</em> ), it notifies
all of its "listeners" who want to access this value.</p>
<p>The advantage over plain callbacks is that they allow you to decouple your
code and they are easier to compose.</p>
<p>Here is an example of using a promise:</p>
<div class="code"><pre class="code literal-block"><span class="k">function</span><span class="w"> </span><span class="n">delay</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n n-Quoted">`delay`</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">promise</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Promise</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">resolve</span><span class="p">,</span><span class="w"> </span><span class="n">reject</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Only</span><span class="w"> </span><span class="n n-Quoted">`delay`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">able</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">resolve</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">reject</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">promise</span>
<span class="w">    </span><span class="k">set</span><span class="n">Timeout</span><span class="p">(</span><span class="k">function</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="n">resolve</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">After</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">seconds</span><span class="p">,</span><span class="w"> </span><span class="n">resolve</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">promise</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="mi">42</span>
<span class="w">    </span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="mi">3000</span><span class="p">);</span>
<span class="w">  </span><span class="err">}</span><span class="p">);</span>
<span class="err">}</span>

<span class="n">delay</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="k">then</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n n-Quoted">`delay`</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">promise</span>
<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">v</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Log</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">resolved</span>
<span class="w">  </span><span class="err">}</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">catch</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Or</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">rejected</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="n">would</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">happen</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">example</span><span class="p">,</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n n-Quoted">`reject`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">called</span><span class="p">).</span>
<span class="w">  </span><span class="err">}</span><span class="p">);</span>


<span class="p">.</span><span class="k">as</span><span class="o">-</span><span class="n">console</span><span class="o">-</span><span class="k">wrapper</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">max</span><span class="o">-</span><span class="n">height</span><span class="o">:</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span><span class="w"> </span><span class="o">!</span><span class="n">important</span><span class="p">;</span><span class="w"> </span><span class="n">top</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="err">}</span>
</pre></div>

<p>Applied to our Ajax call we could use promises like this:</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">ajax</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Promise</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">resolve</span><span class="p">,</span><span class="w"> </span><span class="n">reject</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">xhr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">XMLHttpRequest</span><span class="p">();</span>
<span class="w">    </span><span class="n">xhr</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">resolve</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">responseText</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">xhr</span><span class="o">.</span><span class="n">onerror</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reject</span><span class="p">;</span>
<span class="w">    </span><span class="n">xhr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p">);</span>
<span class="w">    </span><span class="n">xhr</span><span class="o">.</span><span class="n">send</span><span class="p">();</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="n">ajax</span><span class="p">(</span><span class="s2">"https://jsonplaceholder.typicode.com/todos/1"</span><span class="p">)</span>
<span class="w">  </span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="n">depending</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">result</span>
<span class="w">  </span><span class="p">})</span>
<span class="w">  </span><span class="o">.</span><span class="n">catch</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">An</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">occurred</span>
<span class="w">  </span><span class="p">});</span>


<span class="o">.</span><span class="k">as</span><span class="o">-</span><span class="n">console</span><span class="o">-</span><span class="n">wrapper</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">max</span><span class="o">-</span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span><span class="w"> </span><span class="o">!</span><span class="n">important</span><span class="p">;</span><span class="w"> </span><span class="n">top</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</pre></div>

<p>Describing all the advantages that promise offer is beyond the scope of this
answer, but if you write new code, you should seriously consider them. They
provide a great abstraction and separation of your code.</p>
<p>More information about promises: HTML5 rocks - JavaScript Promises.</p>
<h4>Side note: jQuery's deferred objects</h4>
<p>Deferred objects are jQuery's custom implementation of promises (before the
Promise API was standardized). They behave almost like promises but expose a
slightly different API.</p>
<p>Every Ajax method of jQuery already returns a "deferred object" (actually a
promise of a deferred object) which you can just return from your function:</p>
<div class="code"><pre class="code literal-block"><span class="nv">function</span><span class="w"> </span><span class="nv">ajax</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">    </span><span class="k">return</span><span class="w"> </span>$.<span class="nv">ajax</span><span class="ss">(</span>...<span class="ss">)</span><span class="c1">;</span>
}

<span class="nv">ajax</span><span class="ss">()</span>.<span class="nv">done</span><span class="ss">(</span><span class="nv">function</span><span class="ss">(</span><span class="nb">result</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nv">Code</span><span class="w"> </span><span class="nv">depending</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nb">result</span>
}<span class="ss">)</span>.<span class="nv">fail</span><span class="ss">(</span><span class="nv">function</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nv">An</span><span class="w"> </span><span class="nv">error</span><span class="w"> </span><span class="nv">occurred</span>
}<span class="ss">)</span><span class="c1">;</span>
</pre></div>

<h4>Side note: Promise gotchas</h4>
<p>Keep in mind that promises and deferred objects are just <em>containers</em> for a
future value, they are not the value itself. For example, suppose you had the
following:</p>
<div class="code"><pre class="code literal-block"><span class="nt">function</span><span class="w"> </span><span class="nt">checkPassword</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">$.ajax({</span>
<span class="w">        </span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="s1">'/password'</span><span class="p">,</span>
<span class="w">        </span><span class="n">data</span><span class="o">:</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">username</span><span class="o">:</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="s1">'#username'</span><span class="p">)</span><span class="o">.</span><span class="nf">val</span><span class="p">(),</span>
<span class="w">            </span><span class="n">password</span><span class="o">:</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="s1">'#password'</span><span class="p">)</span><span class="o">.</span><span class="nf">val</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span><span class="o">,</span>
<span class="w">        </span><span class="nt">type</span><span class="o">:</span><span class="w"> </span><span class="s1">'POST'</span><span class="o">,</span>
<span class="w">        </span><span class="nt">dataType</span><span class="o">:</span><span class="w"> </span><span class="s1">'json'</span>
<span class="w">    </span><span class="err">}</span><span class="o">);</span>
<span class="err">}</span>

<span class="nt">if</span><span class="w"> </span><span class="o">(</span><span class="nt">checkPassword</span><span class="o">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">Tell</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">they're</span><span class="w"> </span><span class="err">logged</span><span class="w"> </span><span class="err">in</span>
<span class="p">}</span>
</pre></div>

<p>This code misunderstands the above asynchronous issues. Specifically,
<code>$.ajax()</code> doesn't freeze the code while it checks the '/password' page on
your server - it sends a request to the server and while it waits, it
immediately returns a jQuery Ajax Deferred object, not the response from the
server. That means the <code>if</code> statement is going to always get this Deferred
object, treat it as <code>true</code>, and proceed as though the user is logged in. Not
good.</p>
<p>But the fix is easy:</p>
<div class="code"><pre class="code literal-block"><span class="nf">checkPassword</span><span class="p">()</span>
<span class="na">.done</span><span class="p">(</span><span class="no">function</span><span class="p">(</span><span class="no">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="no">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Tell the user they're logged in</span>
<span class="w">    </span><span class="err">}</span><span class="w"> </span><span class="nf">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Tell the user their password was bad</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">})</span>
<span class="na">.fail</span><span class="p">(</span><span class="no">function</span><span class="p">(</span><span class="no">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Tell the user something bad happened</span>
<span class="err">})</span><span class="c1">;</span>
</pre></div>

<hr>
<h3>Not recommended: Synchronous "Ajax" calls</h3>
<p>As I mentioned, some(!) asynchronous operations have synchronous counterparts.
I don't advocate their use, but for completeness' sake, here is how you would
perform a synchronous call:</p>
<h4>Without jQuery</h4>
<p>If you directly use a <code>XMLHttpRequest</code> object, pass <code>false</code> as third argument
to <code>.open</code>.</p>
<h4>jQuery</h4>
<p>If you use jQuery, you can set the <code>async</code> option to <code>false</code>. Note that this
option is <em>deprecated</em> since jQuery 1.8. You can then either still use a
<code>success</code> callback or access the <code>responseText</code> property of the jqXHR object:</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">jqXHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$.</span><span class="n">ajax</span><span class="p">({</span>
<span class="w">        </span><span class="o">//...</span>
<span class="w">        </span><span class="n">async</span><span class="p">:</span><span class="w"> </span><span class="bp">false</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">jqXHR</span><span class="o">.</span><span class="n">responseText</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>If you use any other jQuery Ajax method, such as <code>$.get</code>, <code>$.getJSON</code>, etc.,
you have to change it to <code>$.ajax</code> (since you can only pass configuration
parameters to <code>$.ajax</code>).</p>
<p><strong>Heads up!</strong> It is not possible to make a synchronous JSONP request. JSONP by
its very nature is always asynchronous (one more reason to not even consider
this option).</p>
<p><br></p>
<h3>Suggest</h3>
<h2>If you're <em>not</em> using jQuery in your code, this answer is for you</h2>
<p>Your code should be something along the lines of this:</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">httpRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">XMLHttpRequest</span><span class="p">();</span>
<span class="w">    </span><span class="n">httpRequest</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span><span class="w"> </span><span class="s2">"/echo/json"</span><span class="p">);</span>
<span class="w">    </span><span class="n">httpRequest</span><span class="o">.</span><span class="n">send</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">httpRequest</span><span class="o">.</span><span class="n">responseText</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Always</span><span class="w"> </span><span class="n">ends</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">being</span><span class="w"> </span><span class="s1">'undefined'</span>
</pre></div>

<p>Felix Kling did a fine job writing an answer for people using jQuery for AJAX,
but I've decided to provide an alternative for people who aren't.</p>
<p>(Note, for those using the new <code>fetch</code> API, Angular or promises I've added
another answer below)</p>
<hr>
<h2>What you're facing</h2>
<p>This is a short summary of "Explanation of the problem" from the other answer,
if you're not sure after reading this, read that.</p>
<p>The <strong>A</strong> in AJAX stands for <strong>asynchronous</strong>. That means sending the request
(or rather receiving the response) is taken out of the normal execution flow.
In your example, <code>.send</code> returns immediately and the next statement, <code>return
result;</code>, is executed before the function you passed as <code>success</code> callback was
even called.</p>
<p>This means when you're returning, the listener you've defined did not execute
yet, which means the value you're returning has not been defined.</p>
<p>Here is a simple analogy:</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">getFive</span><span class="p">(){</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="n">setTimeout</span><span class="p">(</span><span class="n">function</span><span class="p">(){</span>
<span class="w">         </span><span class="n">a</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>(Fiddle)</p>
<p>The value of <code>a</code> returned is <code>undefined</code> since the <code>a=5</code> part has not executed
yet. AJAX acts like this, you're returning the value before the server got the
chance to tell your browser what that value is.</p>
<p>One possible solution to this problem is to code <em>re-actively</em> , telling your
program what to do when the calculation completed.</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">onComplete</span><span class="p">(</span><span class="n">a</span><span class="p">){</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">When</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">completes</span><span class="p">,</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">this</span>
<span class="w">    </span><span class="n">alert</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">function</span><span class="w"> </span><span class="n">getFive</span><span class="p">(</span><span class="n">whenDone</span><span class="p">){</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="n">setTimeout</span><span class="p">(</span><span class="n">function</span><span class="p">(){</span>
<span class="w">         </span><span class="n">a</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
<span class="w">         </span><span class="n">whenDone</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>This is called CPS. Basically, we're passing <code>getFive</code> an action to perform
when it completes, we're telling our code how to react when an event completes
(like our AJAX call, or in this case the timeout).</p>
<p>Usage would be:</p>
<div class="code"><pre class="code literal-block">getFive(onComplete);
</pre></div>

<p>Which should alert "5" to the screen. (Fiddle).</p>
<h2>Possible solutions</h2>
<p>There are basically two ways how to solve this:</p>
<ol>
<li>Make the AJAX call synchronous (let’s call it SJAX).</li>
<li>Restructure your code to work properly with callbacks.</li>
</ol>
<h3>1. Synchronous AJAX - Don't do it!!</h3>
<p>As for synchronous AJAX, <strong>don't do it!</strong> Felix's answer raises some
compelling arguments about why it's a bad idea. To sum it up, it'll freeze the
user's browser until the server returns the response and create a very bad
user experience. Here is another short summary taken from MDN on why:</p>
<blockquote>
<p>XMLHttpRequest supports both synchronous and asynchronous communications. In
general, however, asynchronous requests should be preferred to synchronous
requests for performance reasons.</p>
<p>In short, synchronous requests block the execution of code... ...this can
cause serious issues...</p>
</blockquote>
<p>If you <em>have</em> to do it, you can pass a flag. Here is how:</p>
<div class="code"><pre class="code literal-block"><span class="n">var</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XMLHttpRequest</span><span class="p">();</span>
<span class="n">request</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span><span class="w"> </span><span class="s1">'yourURL'</span><span class="p">,</span><span class="w"> </span><span class="no">false</span><span class="p">);</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n n-Quoted">`false`</span><span class="w"> </span><span class="n">makes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">synchronous</span>
<span class="n">request</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="no">null</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="k">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="o">//</span><span class="w"> </span><span class="n">That</span><span class="s1">'s HTTP for '</span><span class="n">ok</span><span class="s1">'</span>
<span class="s1">  console.log(request.responseText);</span>
<span class="s1">}</span>
</pre></div>

<h3>2. Restructure code</h3>
<p>Let your function accept a callback. In the example code <code>foo</code> can be made to
accept a callback. We'll be telling our code how to <em>react</em> when <code>foo</code>
completes.</p>
<p>So:</p>
<div class="code"><pre class="code literal-block"><span class="n">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span>
<span class="o">//</span><span class="w"> </span><span class="k">Code</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n n-Quoted">`result`</span><span class="w"> </span><span class="n">goes</span><span class="w"> </span><span class="n">here</span>
</pre></div>

<p>Becomes:</p>
<div class="code"><pre class="code literal-block"><span class="n">foo</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Code</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n n-Quoted">`result`</span>
<span class="err">}</span><span class="p">);</span>
</pre></div>

<p>Here we passed an anonymous function, but we could just as easily pass a
reference to an existing function, making it look like:</p>
<div class="code"><pre class="code literal-block"><span class="k">function</span><span class="w"> </span><span class="n">myHandler</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Code</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">depends</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n n-Quoted">`result`</span>
<span class="err">}</span>
<span class="n">foo</span><span class="p">(</span><span class="n">myHandler</span><span class="p">);</span>
</pre></div>

<p>For more details on how this sort of callback design is done, check Felix's
answer.</p>
<p>Now, let's define foo itself to act accordingly</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">httpRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">XMLHttpRequest</span><span class="p">();</span>
<span class="w">    </span><span class="n">httpRequest</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">(){</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">When</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">loaded</span>
<span class="w">       </span><span class="n">callback</span><span class="p">(</span><span class="n">httpRequest</span><span class="o">.</span><span class="n">responseText</span><span class="p">);</span><span class="o">//</span><span class="w"> </span><span class="n">We</span><span class="s1">'re calling our method</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">httpRequest</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span><span class="w"> </span><span class="s2">"/echo/json"</span><span class="p">);</span>
<span class="w">    </span><span class="n">httpRequest</span><span class="o">.</span><span class="n">send</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>(fiddle)</p>
<p>We have now made our <em>foo</em> function accept an action to run when the AJAX
completes successfully. We can extend this further by checking if the response
status is not 200 and acting accordingly (create a fail handler and such).
Effectively it is solving our issue.</p>
<p>If you're still having a hard time understanding this, read the AJAX getting
started guide at MDN.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-do-i-merge-two-dictionaries-in-a-single-expression-in-python/" class="u-url">How do I merge two dictionaries in a single expression in Python?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="posts/how-do-i-merge-two-dictionaries-in-a-single-expression-in-python/" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T18:29:02+08:00" itemprop="datePublished" title="2023-02-16 18:29">2023-02-16 18:29</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I want to merge two dictionaries into a new dictionary.</p>
<div class="code"><pre class="code literal-block">x = {'a': 1, 'b': 2}
y = {'b': 3, 'c': 4}
z = merge(x, y)

&gt;&gt;&gt; z
{'a': 1, 'b': 3, 'c': 4}
</pre></div>

<p>Whenever a key <code>k</code> is present in both dictionaries, only the value <code>y[k]</code>
should be kept.</p>
<p><br><br></p>
<h2>Answer</h2>
<h3>How can I merge two Python dictionaries in a single expression?</h3>
<p>For dictionaries <code>x</code> and <code>y</code>, their shallowly-merged dictionary <code>z</code> takes
values from <code>y</code>, replacing those from <code>x</code>.</p>
<ul>
<li>
<p>In Python 3.9.0 or greater (released 17 October 2020, <code>PEP-584</code>, discussed here):</p>
<div class="code"><pre class="code literal-block">z = x | y
</pre></div>

</li>
<li>
<p>In Python 3.5 or greater:</p>
<div class="code"><pre class="code literal-block">z = {**x, **y}
</pre></div>

</li>
<li>
<p>In Python 2, (or 3.4 or lower) write a function:</p>
<div class="code"><pre class="code literal-block"><span class="nv">def</span><span class="w"> </span><span class="nv">merge_two_dicts</span><span class="ss">(</span><span class="nv">x</span>,<span class="w"> </span><span class="nv">y</span><span class="ss">)</span>:
<span class="nv">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">x</span>.<span class="nv">copy</span><span class="ss">()</span><span class="w">   </span>#<span class="w"> </span><span class="nv">start</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">keys</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">values</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">x</span>
<span class="nv">z</span>.<span class="nv">update</span><span class="ss">(</span><span class="nv">y</span><span class="ss">)</span><span class="w">    </span>#<span class="w"> </span><span class="nv">modifies</span><span class="w"> </span><span class="nv">z</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">keys</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">values</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">y</span>
<span class="k">return</span><span class="w"> </span><span class="nv">z</span>
</pre></div>

</li>
</ul>
<p>and now:</p>
<div class="code"><pre class="code literal-block">    z = merge_two_dicts(x, y)
</pre></div>

<h4>Explanation</h4>
<p>Say you have two dictionaries and you want to merge them into a new dictionary
without altering the original dictionaries:</p>
<div class="code"><pre class="code literal-block">x = {'a': 1, 'b': 2}
y = {'b': 3, 'c': 4}
</pre></div>

<p>The desired result is to get a new dictionary (<code>z</code>) with the values merged,
and the second dictionary's values overwriting those from the first.</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; z
{'a': 1, 'b': 3, 'c': 4}
</pre></div>

<p>A new syntax for this, proposed in PEP 448 and available as of Python 3.5, is</p>
<div class="code"><pre class="code literal-block">z = {**x, **y}
</pre></div>

<p>And it is indeed a single expression.</p>
<p>Note that we can merge in with literal notation as well:</p>
<div class="code"><pre class="code literal-block">z = {**x, 'foo': 1, 'bar': 2, **y}
</pre></div>

<p>and now:</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; z
{'a': 1, 'b': 3, 'foo': 1, 'bar': 2, 'c': 4}
</pre></div>

<p>It is now showing as implemented in the release schedule for 3.5, PEP 478, and
it has now made its way into the What's New in Python 3.5 document.</p>
<p>However, since many organizations are still on Python 2, you may wish to do
this in a backward-compatible way. The classically Pythonic way, available in
Python 2 and Python 3.0-3.4, is to do this as a two-step process:</p>
<div class="code"><pre class="code literal-block">z = x.copy()
z.update(y) # which returns None since it mutates z
</pre></div>

<p>In both approaches, <code>y</code> will come second and its values will replace <code>x</code>'s
values, thus <code>b</code> will point to <code>3</code> in our final result.</p>
<h3>Not yet on Python 3.5, but want a <em>single expression</em>
</h3>
<p>If you are not yet on Python 3.5 or need to write backward-compatible code,
and you want this in a <em>single expression</em> , the most performant while the
correct approach is to put it in a function:</p>
<div class="code"><pre class="code literal-block"><span class="nv">def</span><span class="w"> </span><span class="nv">merge_two_dicts</span><span class="ss">(</span><span class="nv">x</span>,<span class="w"> </span><span class="nv">y</span><span class="ss">)</span>:
<span class="w">    </span><span class="s2">"""Given two dictionaries, merge them into a new dict as a shallow copy."""</span>
<span class="w">    </span><span class="nv">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">x</span>.<span class="nv">copy</span><span class="ss">()</span>
<span class="w">    </span><span class="nv">z</span>.<span class="nv">update</span><span class="ss">(</span><span class="nv">y</span><span class="ss">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">z</span>
</pre></div>

<p>and then you have a single expression:</p>
<div class="code"><pre class="code literal-block">z = merge_two_dicts(x, y)
</pre></div>

<p>You can also make a function to merge an arbitrary number of dictionaries,
from zero to a very large number:</p>
<div class="code"><pre class="code literal-block"><span class="nv">def</span><span class="w"> </span><span class="nv">merge_dicts</span><span class="ss">(</span><span class="o">*</span><span class="nv">dict_args</span><span class="ss">)</span>:
<span class="w">    </span><span class="s2">""</span><span class="err">"</span>
<span class="err">    Given any number of dictionaries, shallow copy and merge into a new dict,</span>
<span class="err">    precedence goes to key-value pairs in latter dictionaries.</span>
<span class="w">    </span><span class="s2">""</span><span class="err">"</span>
<span class="err">    result = {}</span>
<span class="err">    for dictionary in dict_args:</span>
<span class="err">        result.update(dictionary)</span>
<span class="err">    return result</span>
</pre></div>

<p>This function will work in Python 2 and 3 for all dictionaries. e.g. given
dictionaries <code>a</code> to <code>g</code>:</p>
<div class="code"><pre class="code literal-block">z = merge_dicts(a, b, c, d, e, f, g)
</pre></div>

<p>and key-value pairs in <code>g</code> will take precedence over dictionaries <code>a</code> to <code>f</code>,
and so on.</p>
<h3>Critiques of Other Answers</h3>
<p>Don't use what you see in the formerly accepted answer:</p>
<div class="code"><pre class="code literal-block">z = dict(x.items() + y.items())
</pre></div>

<p>In Python 2, you create two lists in memory for each dict, create a third list
in memory with length equal to the length of the first two put together, and
then discard all three lists to create the dict. <strong>In Python 3, this will
fail</strong> because you're adding two <code>dict_items</code> objects together, not two lists
-</p>
<div class="code"><pre class="code literal-block"><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">dict</span><span class="ss">(</span><span class="nv">a</span>.<span class="nv">items</span><span class="ss">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">b</span>.<span class="nv">items</span><span class="ss">())</span>
<span class="nv">Traceback</span><span class="w"> </span><span class="ss">(</span><span class="nv">most</span><span class="w"> </span><span class="nv">recent</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="nl">last</span><span class="ss">)</span>:
<span class="w">  </span><span class="nv">File</span><span class="w"> </span><span class="s2">"&lt;stdin&gt;"</span>,<span class="w"> </span><span class="nv">line</span><span class="w"> </span><span class="mi">1</span>,<span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">module</span><span class="o">&gt;</span>
<span class="nv">TypeError</span>:<span class="w"> </span><span class="nv">unsupported</span><span class="w"> </span><span class="nv">operand</span><span class="w"> </span><span class="nv">type</span><span class="ss">(</span><span class="nv">s</span><span class="ss">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">+</span>:<span class="w"> </span><span class="s1">'dict_items'</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="s1">'dict_items'</span>
</pre></div>

<p>and you would have to explicitly create them as lists, e.g. <code>z =
dict(list(x.items()) + list(y.items()))</code>. This is a waste of resources and
computation power.</p>
<p>Similarly, taking the union of <code>items()</code> in Python 3 (<code>viewitems()</code> in Python
2.7) will also fail when values are unhashable objects (like lists, for
example). Even if your values are hashable, <strong>since sets are semantically
unordered, the behavior is undefined in regards to precedence. So don't do
this:</strong></p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; c = dict(a.items() | b.items())
</pre></div>

<p>This example demonstrates what happens when values are unhashable:</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; x = {'a': []}
&gt;&gt;&gt; y = {'b': []}
&gt;&gt;&gt; dict(x.items() | y.items())
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
TypeError: unhashable type: 'list'
</pre></div>

<p>Here's an example where <code>y</code> should have precedence, but instead the value from
<code>x</code> is retained due to the arbitrary order of sets:</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; x = {'a': 2}
&gt;&gt;&gt; y = {'a': 1}
&gt;&gt;&gt; dict(x.items() | y.items())
{'a': 2}
</pre></div>

<p>Another hack you should not use:</p>
<div class="code"><pre class="code literal-block">z = dict(x, **y)
</pre></div>

<p>This uses the <code>dict</code> constructor and is very fast and memory-efficient (even
slightly more so than our two-step process) but unless you know precisely what
is happening here (that is, the second dict is being passed as keyword
arguments to the dict constructor), it's difficult to read, it's not the
intended usage, and so it is not Pythonic.</p>
<p>Here's an example of the usage being remediated in django.</p>
<p>Dictionaries are intended to take hashable keys (e.g. <code>frozenset</code>s or tuples),
but <strong>this method fails in Python 3 when keys are not strings.</strong></p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; c = dict(a, **b)
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
TypeError: keyword arguments must be strings
</pre></div>

<p>From the mailing list, Guido van Rossum, the creator of the language, wrote:</p>
<blockquote>
<p>I am fine with declaring dict({}, <strong>{1:3}) illegal, since after all it is
abuse of the </strong> mechanism.</p>
</blockquote>
<p>and</p>
<blockquote>
<p>Apparently dict(x, **y) is going around as "cool hack" for "call x.update(y)
and return x". Personally, I find it more despicable than cool.</p>
</blockquote>
<p>It is my understanding (as well as the understanding of the creator of the
language) that the intended usage for <code>dict(**y)</code> is for creating dictionaries
for readability purposes, e.g.:</p>
<div class="code"><pre class="code literal-block">dict(a=1, b=10, c=11)
</pre></div>

<p>instead of</p>
<div class="code"><pre class="code literal-block">{'a': 1, 'b': 10, 'c': 11}
</pre></div>

<h3>Response to comments</h3>
<blockquote>
<p>Despite what Guido says, <code>dict(x, **y)</code> is in line with the dict
specification, which btw. works for both Python 2 and 3. The fact that this
only works for string keys is a direct consequence of how keyword parameters
work and not a short-coming of dict. Nor is using the <strong> operator in this
place an abuse of the mechanism, in fact, </strong> was designed precisely to pass
dictionaries as keywords.</p>
</blockquote>
<p>Again, it doesn't work for 3 when keys are not strings. The implicit calling
contract is that namespaces take ordinary dictionaries, while users must only
pass keyword arguments that are strings. All other callables enforced it.
<code>dict</code> broke this consistency in Python 2:</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; foo(**{('a', 'b'): None})
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
TypeError: foo() keywords must be strings
&gt;&gt;&gt; dict(**{('a', 'b'): None})
{('a', 'b'): None}
</pre></div>

<p>This inconsistency was bad given other implementations of Python (PyPy,
Jython, IronPython). Thus it was fixed in Python 3, as this usage could be a
breaking change.</p>
<p>I submit to you that it is malicious incompetence to intentionally write code
that only works in one version of a language or that only works given certain
arbitrary constraints.</p>
<p>More comments:</p>
<blockquote>
<p><code>dict(x.items() + y.items())</code> is still the most readable solution for Python
2. Readability counts.</p>
</blockquote>
<p>My response: <code>merge_two_dicts(x, y)</code> actually seems much clearer to me, if
we're actually concerned about readability. And it is not forward compatible,
as Python 2 is increasingly deprecated.</p>
<blockquote>
<p><code>{**x, **y}</code> does not seem to handle nested dictionaries. the contents of
nested keys are simply overwritten, not merged [...] I ended up being burnt
by these answers that do not merge recursively and I was surprised no one
mentioned it. In my interpretation of the word "merging" these answers
describe "updating one dict with another", and not merging.</p>
</blockquote>
<p>Yes. I must refer you back to the question, which is asking for a <em>shallow</em>
merge of <em><strong>two</strong></em> dictionaries, with the first's values being overwritten by
the second's - in a single expression.</p>
<p>Assuming two dictionaries of dictionaries, one might recursively merge them in
a single function, but you should be careful not to modify the dictionaries
from either source, and the surest way to avoid that is to make a copy when
assigning values. As keys must be hashable and are usually therefore
immutable, it is pointless to copy them:</p>
<div class="code"><pre class="code literal-block"><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="k">def</span> <span class="nf">dict_of_dicts_merge</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">overlapping_keys</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">y</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">overlapping_keys</span><span class="p">:</span>
        <span class="n">z</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_of_dicts_merge</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">-</span> <span class="n">overlapping_keys</span><span class="p">:</span>
        <span class="n">z</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">y</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">-</span> <span class="n">overlapping_keys</span><span class="p">:</span>
        <span class="n">z</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">z</span>
</pre></div>

<p>Usage:</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; x = {'a':{1:{}}, 'b': {2:{}}}
&gt;&gt;&gt; y = {'b':{10:{}}, 'c': {11:{}}}
&gt;&gt;&gt; dict_of_dicts_merge(x, y)
{'b': {2: {}, 10: {}}, 'a': {1: {}}, 'c': {11: {}}}
</pre></div>

<p>Coming up with contingencies for other value types is far beyond the scope of
this question, so I will point you at my answer to the canonical question on a
"Dictionaries of dictionaries merge".</p>
<h3>Less Performant But Correct Ad-hocs</h3>
<p>These approaches are less performant, but they will provide correct behavior.
They will be <em>much less</em> performant than <code>copy</code> and <code>update</code> or the new
unpacking because they iterate through each key-value pair at a higher level
of abstraction, but they <em>do</em> respect the order of precedence (latter
dictionaries have precedence)</p>
<p>You can also chain the dictionaries manually inside a dict comprehension:</p>
<div class="code"><pre class="code literal-block">{<span class="nv">k</span>:<span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">dicts</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">k</span>,<span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">d</span>.<span class="nv">items</span><span class="ss">()</span>}<span class="w"> </span>#<span class="w"> </span><span class="nv">iteritems</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">Python</span><span class="w"> </span><span class="mi">2</span>.<span class="mi">7</span>
</pre></div>

<p>or in Python 2.6 (and perhaps as early as 2.4 when generator expressions were
introduced):</p>
<div class="code"><pre class="code literal-block"><span class="nv">dict</span><span class="ss">((</span><span class="nv">k</span>,<span class="w"> </span><span class="nv">v</span><span class="ss">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">dicts</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">k</span>,<span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">d</span>.<span class="nv">items</span><span class="ss">())</span><span class="w"> </span>#<span class="w"> </span><span class="nv">iteritems</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">Python</span><span class="w"> </span><span class="mi">2</span>
</pre></div>

<p><code>itertools.chain</code> will chain the iterators over the key-value pairs in the
correct order:</p>
<div class="code"><pre class="code literal-block"><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="n">z</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span> <span class="c1"># iteritems in Python 2</span>
</pre></div>

<h3>Performance Analysis</h3>
<p>I'm only going to do the performance analysis of the usages known to behave
correctly. (Self-contained so you can copy and paste yourself.)</p>
<div class="code"><pre class="code literal-block"><span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>

<span class="n">x</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="s1">'abcdefg'</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="s1">'efghijk'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">merge_two_dicts</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">z</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">z</span>

<span class="nb">min</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">y</span><span class="p">}))</span>
<span class="nb">min</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">merge_two_dicts</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>
<span class="nb">min</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}))</span>
<span class="nb">min</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">items</span><span class="p">()))))</span>
<span class="nb">min</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
</pre></div>

<p>In Python 3.8.1, NixOS:</p>
<div class="code"><pre class="code literal-block"><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">min</span><span class="ss">(</span><span class="nv">repeat</span><span class="ss">(</span><span class="nv">lambda</span>:<span class="w"> </span>{<span class="o">**</span><span class="nv">x</span>,<span class="w"> </span><span class="o">**</span><span class="nv">y</span>}<span class="ss">))</span>
<span class="mi">1</span>.<span class="mi">0804965235292912</span>
<span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">min</span><span class="ss">(</span><span class="nv">repeat</span><span class="ss">(</span><span class="nv">lambda</span>:<span class="w"> </span><span class="nv">merge_two_dicts</span><span class="ss">(</span><span class="nv">x</span>,<span class="w"> </span><span class="nv">y</span><span class="ss">)))</span>
<span class="mi">1</span>.<span class="mi">636518670246005</span>
<span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">min</span><span class="ss">(</span><span class="nv">repeat</span><span class="ss">(</span><span class="nv">lambda</span>:<span class="w"> </span>{<span class="nv">k</span>:<span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="ss">(</span><span class="nv">x</span>,<span class="w"> </span><span class="nv">y</span><span class="ss">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">k</span>,<span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">d</span>.<span class="nv">items</span><span class="ss">()</span>}<span class="ss">))</span>
<span class="mi">3</span>.<span class="mi">1779992282390594</span>
<span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">min</span><span class="ss">(</span><span class="nv">repeat</span><span class="ss">(</span><span class="nv">lambda</span>:<span class="w"> </span><span class="nv">dict</span><span class="ss">(</span><span class="nv">chain</span><span class="ss">(</span><span class="nv">x</span>.<span class="nv">items</span><span class="ss">()</span>,<span class="w"> </span><span class="nv">y</span>.<span class="nv">items</span><span class="ss">()))))</span>
<span class="mi">2</span>.<span class="mi">740647904574871</span>
<span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">min</span><span class="ss">(</span><span class="nv">repeat</span><span class="ss">(</span><span class="nv">lambda</span>:<span class="w"> </span><span class="nv">dict</span><span class="ss">(</span><span class="nv">item</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="ss">(</span><span class="nv">x</span>,<span class="w"> </span><span class="nv">y</span><span class="ss">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">item</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">d</span>.<span class="nv">items</span><span class="ss">())))</span>
<span class="mi">4</span>.<span class="mi">266070580109954</span>



$<span class="w"> </span><span class="nv">uname</span><span class="w"> </span><span class="o">-</span><span class="nv">a</span>
<span class="nv">Linux</span><span class="w"> </span><span class="nv">nixos</span><span class="w"> </span><span class="mi">4</span>.<span class="mi">19</span>.<span class="mi">113</span><span class="w"> </span><span class="sc">#1</span><span class="o">-</span><span class="nv">NixOS</span><span class="w"> </span><span class="nv">SMP</span><span class="w"> </span><span class="nv">Wed</span><span class="w"> </span><span class="nv">Mar</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">07</span>:<span class="mi">06</span>:<span class="mi">15</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="mi">2020</span><span class="w"> </span><span class="nv">x86_64</span><span class="w"> </span><span class="nv">GNU</span><span class="o">/</span><span class="nv">Linux</span>
</pre></div>

<h3>Resources on Dictionaries</h3>
<ul>
<li>My explanation of Python's <strong>dictionary implementation</strong> , updated for 3.6.</li>
<li>Answer on how to add new keys to a dictionary</li>
<li>Mapping two lists into a dictionary</li>
<li>The official Python docs on dictionaries</li>
<li>The Dictionary Even Mightier - talk by Brandon Rhodes at Pycon 2017</li>
<li>Modern Python Dictionaries, A Confluence of Great Ideas - talk by Raymond Hettinger at Pycon 2017</li>
</ul>
<p><br></p>
<h3>Suggest</h3>
<p>In your case, you can do:</p>
<div class="code"><pre class="code literal-block">z = dict(list(x.items()) + list(y.items()))
</pre></div>

<p>This will, as you want it, put the final dict in <code>z</code>, and make the value for
key <code>b</code> be properly overridden by the second (<code>y</code>) dict's value:</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; x = {'a':1, 'b': 2}
&gt;&gt;&gt; y = {'b':10, 'c': 11}
&gt;&gt;&gt; z = dict(list(x.items()) + list(y.items()))
&gt;&gt;&gt; z
{'a': 1, 'c': 11, 'b': 10}
</pre></div>

<p>If you use Python 2, you can even remove the <code>list()</code> calls. To create z:</p>
<div class="code"><pre class="code literal-block">&gt;&gt;&gt; z = dict(x.items() + y.items())
&gt;&gt;&gt; z
{'a': 1, 'c': 11, 'b': 10}
</pre></div>

<p>If you use Python version 3.9.0a4 or greater, then you can directly use:</p>
<div class="code"><pre class="code literal-block">x = {'a':1, 'b': 2}
y = {'b':10, 'c': 11}
z = x | y
print(z)



{'a': 1, 'c': 11, 'b': 10}
</pre></div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-13.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-11.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="assets/js/search.js"></script>
</body>
</html>
