<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Can't specify the 'async' modifier on the 'Main' method of a console app | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/can-t-specify-the-async-modifier-on-the-main-method-of-a-console-app/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../select-all-occurrences-of-selected-word-in-vscode/" title="Select all occurrences of selected word in VSCode" type="text/html">
<link rel="next" href="../create-a-temporary-table-in-a-select-statement-without-a-separate-create-table/" title="Create a temporary table in a SELECT statement without a separate CREATE TABLE" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="Can't specify the 'async' modifier on the 'Main' method of a console a">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/can-t-specify-the-async-modifier-on-the-main-method-of-a-console-app/">
<meta property="og:description" content="I am new to asynchronous programming with the async modifier. I am trying to
figure out how to make sure that my Main method of a console application
actually runs asynchronously.
class Program
{
    ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-18T04:47:43+08:00">
<meta property="article:tag" content=".net">
<meta property="article:tag" content=".net-c#">
<meta property="article:tag" content="asynchronous">
<meta property="article:tag" content="console-application">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Can't specify the 'async' modifier on the 'Main' method of a console app</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T04:47:43+08:00" itemprop="datePublished" title="2023-02-18 04:47">2023-02-18 04:47</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>I am new to asynchronous programming with the <code>async</code> modifier. I am trying to
figure out how to make sure that my <code>Main</code> method of a console application
actually runs asynchronously.</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">Program</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">Main</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Bootstrapper</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Bootstrapper</span><span class="p">();</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bs</span><span class="o">.</span><span class="n">GetList</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">Bootstrapper</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">TvChannel</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">GetList</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">GetPrograms</span><span class="w"> </span><span class="n">pro</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">GetPrograms</span><span class="p">();</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">pro</span><span class="o">.</span><span class="n">DownloadTvChannels</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>I know this is not running asynchronously from "the top." Since it is not
possible to specify the <code>async</code> modifier on the <code>Main</code> method, how can I run
code within <code>main</code> asynchronously?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>As you discovered, in VS11 the compiler will disallow an <code>async Main</code> method.
This was allowed (but never recommended) in VS2010 with the Async CTP.</p>
<p><strong>Update, 2017-11-30:</strong> As of Visual Studio 2017 Update 3 (15.3), the language
now supports an <code>async Main</code> - as long as it returns <code>Task</code> or <code>Task&lt;T&gt;</code>. So
you can now do this:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">Program</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="n">Main</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Bootstrapper</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Bootstrapper</span><span class="p">();</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">bs</span><span class="o">.</span><span class="n">GetList</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>The semantics appear to be the same as the <code>GetAwaiter().GetResult()</code> style of
blocking the main thread. However, there's no language spec for C# 7.1 yet, so
this is only an assumption.</p>
<hr>
<p>I have recent blog posts about async/await and asynchronous console programs
in particular. Here's some background info from the intro post:</p>
<blockquote>
<p>If "await" sees that the awaitable has not completed, then it acts
asynchronously. It tells the awaitable to run the remainder of the method
when it completes, and then <em>returns</em> from the async method. Await will also
capture the current <strong>context</strong> when it passes the remainder of the method
to the awaitable.</p>
<p>Later on, when the awaitable completes, it will execute the remainder of the
async method (within the captured context).</p>
</blockquote>
<p>Here's why this is a problem in Console programs with an <code>async Main</code>:</p>
<blockquote>
<p>Remember from our intro post that an async method will <em>return</em> to its
caller before it is complete. This works perfectly in UI applications (the
method just returns to the UI event loop) and ASP.NET applications (the
method returns off the thread but keeps the request alive). It doesn't work
out so well for Console programs: Main returns to the OS - so your program
exits.</p>
</blockquote>
<p>One solution is to provide your own context - a "main loop" for your console
program that is async-compatible.</p>
<p>If you have a machine with the Async CTP, you can use
<code>GeneralThreadAffineContext</code> from <em>My Documents\Microsoft Visual Studio Async
CTP\Samples(C# Testing) Unit Testing\AsyncTestUtilities</em>. Alternatively, you
can use <code>AsyncContext</code> from my Nito.AsyncEx NuGet package.</p>
<p>Here's an example using <code>AsyncContext</code>; <code>GeneralThreadAffineContext</code> has
almost identical usage:</p>
<div class="code"><pre class="code literal-block"><span class="n">using</span><span class="w"> </span><span class="n">Nito</span><span class="o">.</span><span class="n">AsyncEx</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="n">Program</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">Main</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">AsyncContext</span><span class="o">.</span><span class="n">Run</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">MainAsync</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">MainAsync</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Bootstrapper</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Bootstrapper</span><span class="p">();</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">bs</span><span class="o">.</span><span class="n">GetList</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Alternatively, you can just block the main Console thread until your
asynchronous work has completed:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">Program</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">Main</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">MainAsync</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">GetAwaiter</span><span class="p">()</span><span class="o">.</span><span class="n">GetResult</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="n">MainAsync</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Bootstrapper</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Bootstrapper</span><span class="p">();</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">bs</span><span class="o">.</span><span class="n">GetList</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Note the use of <code>GetAwaiter().GetResult()</code>; this avoids the
<code>AggregateException</code> wrapping that happens if you use <code>Wait()</code> or <code>Result</code>.</p>
<p><br></p>
<h3>Suggest</h3>
<p>You can solve this with this simple construct:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span> <span class="n">Program</span>
{
    <span class="n">static</span> <span class="n">void</span> <span class="n">Main</span>(<span class="n">string</span>[] <span class="nb">args</span>)
    {
        <span class="n">Task</span>.<span class="n">Run</span>(<span class="n">async</span> () =&gt;
        {
            // <span class="n">Do</span> <span class="nb">any</span> <span class="n">async</span> <span class="n">anything</span> <span class="n">you</span> <span class="k">need</span> <span class="n">here</span> <span class="k">without</span> <span class="n">worry</span>
        }).<span class="n">GetAwaiter</span>().<span class="n">GetResult</span>();
    }
}
</pre></div>

<p>That will put everything you do out on the ThreadPool where you'd want it (so
other Tasks you start/await don't attempt to rejoin a Thread they shouldn't),
and wait until everything's done before closing the Console app. No need for
special loops or outside libs.</p>
<p>Edit: Incorporate Andrew's solution for uncaught Exceptions.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/net/" rel="tag">.net</a></li>
            <li><a class="tag p-category" href="../../categories/net-c/" rel="tag">.net-c#</a></li>
            <li><a class="tag p-category" href="../../categories/asynchronous/" rel="tag">asynchronous</a></li>
            <li><a class="tag p-category" href="../../categories/console-application/" rel="tag">console-application</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../select-all-occurrences-of-selected-word-in-vscode/" rel="prev" title="Select all occurrences of selected word in VSCode">Previous post</a>
            </li>
            <li class="next">
                <a href="../create-a-temporary-table-in-a-select-statement-without-a-separate-create-table/" rel="next" title="Create a temporary table in a SELECT statement without a separate CREATE TABLE">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
