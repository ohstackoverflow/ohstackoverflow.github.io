<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ExpressJS 如何构建应用程序？ | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/expressjs-ru-he-gou-jian-ying-yong-cheng-xu/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../zi-dong-zhuang-pei-zai-spring-zhong-shi-ru-he-gong-zuo-de/" title="自动装配在 Spring 中是如何工作的？" type="text/html">
<link rel="next" href="../wei-shi-yao-xiang-zhe-yang-de-biao-qing-fu-hao-zi-fu-zai-swift-zi-fu-chuan-zhong-chu-li-de-ru-ci-qi-guai/" title="为什么像 👩‍👩‍👧‍👦 这样的表情符号字符在 Swift 字符串中处理得如此奇怪？" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="ExpressJS 如何构建应用程序？">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/expressjs-ru-he-gou-jian-ying-yong-cheng-xu/">
<meta property="og:description" content="我正在为 NodeJS 使用 ExpressJS Web 框架。
使用 ExpressJS 的人将他们的环境（开发、生产、测试​​...）、他们的路线等放在app.js.
我认为这不是一个漂亮的方式，因为当你有一个大应用程序时，app.js 太大了！
我想要这个目录结构：
| my-application
| -- app.js
| -- config/
     | -- environment">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-18T02:48:26+08:00">
<meta property="article:tag" content="express">
<meta property="article:tag" content="node.js">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">ExpressJS 如何构建应用程序？</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T02:48:26+08:00" itemprop="datePublished" title="2023-02-18 02:48">2023-02-18 02:48</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>我正在为 NodeJS 使用 ExpressJS Web 框架。</p>
<p>使用 ExpressJS 的人将他们的环境（开发、生产、测试​​...）、他们的路线等放在<code>app.js</code>.
我认为这不是一个漂亮的方式，因为当你有一个大应用程序时，app.js 太大了！</p>
<p>我想要这个目录结构：</p>
<div class="code"><pre class="code literal-block">| my-application
| -- app.js
| -- config/
     | -- environment.js
     | -- routes.js
</pre></div>

<p>这是我的代码：</p>
<p><strong>应用程序.js</strong></p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="k">var</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">module</span><span class="o">.</span><span class="n">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">express</span><span class="o">.</span><span class="n">createServer</span><span class="p">();</span>

<span class="n">require</span><span class="p">(</span><span class="s1">'./config/environment.js'</span><span class="p">)(</span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="n">express</span><span class="p">);</span>
<span class="n">require</span><span class="p">(</span><span class="s1">'./config/routes.js'</span><span class="p">)(</span><span class="n">app</span><span class="p">);</span>

<span class="n">app</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>

<p><strong>配置/环境.js</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">module</span><span class="o">.</span><span class="n">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="n">express</span><span class="p">){</span>
<span class="w">    </span><span class="n">app</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">app</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">express</span><span class="o">.</span><span class="n">logger</span><span class="p">());</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="n">app</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s1">'development'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">app</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">express</span><span class="o">.</span><span class="n">errorHandler</span><span class="p">({</span>
<span class="w">        </span><span class="n">dumpExceptions</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">showStack</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
<span class="w">    </span><span class="p">}));</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="n">app</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s1">'production'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">app</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">express</span><span class="o">.</span><span class="n">errorHandler</span><span class="p">());</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">};</span>
</pre></div>

<p><strong>配置/routes.js</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">module</span><span class="o">.</span><span class="n">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">res</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">'Hello world !'</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">};</span>
</pre></div>

<p>我的代码运行良好，我认为目录结构很漂亮。但是，代码必须进行调整，我不确定它是否好/漂亮。</p>
<p>使用我的目录结构并调整代码还是只使用一个文件 (app.js) 更好？</p>
<p>谢谢你的建议！</p>
<p><br><br></p>
<h2>解答</h2>
<p>好的，已经有一段时间了，这是一个热门问题，所以我继续创建了一个带有 JavaScript 代码的脚手架 github 存储库和一个关于我喜欢如何构建中型
express.js 应用程序的长自述文件。</p>
<p>focusaurus/express_code_structure是包含最新代码的仓库。欢迎提出请求。</p>
<p>这是 README 的快照，因为 stackoverflow 不喜欢只是一个链接的答案。我将进行一些更新，因为这是一个我将继续更新的新项目，但最终
github 存储库将是此信息的最新位置。</p>
<hr>
<h2>Express代码结构</h2>
<p>该项目是如何组织中型 express.js Web 应用程序的示例。</p>
<p><strong>Current to at least express v4.14 2016 年 12 月</strong></p>
<p><img alt="构建状态" src="https://semaphoreci.com/api/v1/projects/0de47c2f-0e4f-4a47-8822-5913023312e1/681770/badge.svg"></p>
<p><img alt="js-标准风格" src="https://cdn.rawgit.com/feross/standard/master/badge.svg"></p>
<h3>您的应用程序有多大？</h3>
<p>Web 应用程序并不完全相同，在我看来，没有一种代码结构可以应用于所有 express.js 应用程序。</p>
<p>如果您的应用程序很小，则不需要像此处示例的那样深的目录结构。只需保持简单，将一些<code>.js</code>文件粘贴到存储库的根目录中即可。瞧。</p>
<p>如果你的应用程序很大，在某些时候你需要将它分解成不同的 npm 包。一般来说，node.js 方法似乎有利于许多小包，至少对于库而言，你应该使用几个 npm
包来构建你的应用程序，因为这开始变得有意义并证明开销是合理的。因此，随着您的应用程序的增长，并且某些部分代码变得明显可以在您的应用程序之外重用或者是一个清晰的子系统，请将其移至其自己的
git 存储库并将其放入独立的 npm 包中。</p>
<p><strong>因此，</strong> 该项目的重点是说明中型应用程序的可行结构。</p>
<h3>你的整体架构是什么</h3>
<p>构建 Web 应用程序的方法有很多种，例如</p>
<ul>
<li>服务器端 MVC 就像 Ruby on Rails</li>
<li>单页应用程序风格 la MongoDB/Express/Angular/Node (MEAN)</li>
<li>带有一些表单的基本网站</li>
<li>Models/Operations/Views/Events 风格的MVC 已经死了，是时候继续前进了</li>
<li>以及许多其他当前和历史上的</li>
</ul>
<p>这些中的每一个都很好地适合不同的目录结构。出于本示例的目的，它只是一个脚手架，而不是一个功能完备的应用程序，但我假设以下关键架构点：</p>
<ul>
<li>该网站有一些传统的静态页面/模板</li>
<li>站点的“应用程序”部分被开发为单页应用程序样式</li>
<li>应用程序向浏览器公开一个 REST/JSON 风格的 API</li>
<li>该应用程序模拟一个简单的业务领域，在本例中，它是一个汽车经销商应用程序</li>
</ul>
<h3>那么 Ruby on Rails 呢？</h3>
<p>贯穿这个项目的主题是 Ruby on Rails
中体现的许多想法和他们采用的“约定优于配置”的决定，虽然被广泛接受和使用，但实际上并不是很有帮助，有时甚至与这个存储库的内容相反推荐。</p>
<p>我在这里的主要观点是组织代码有一些基本原则，基于这些原则，Ruby on Rails 约定（主要）对 Ruby on Rails
社区有意义。然而，只是不假思索地模仿这些惯例就没有抓住要点。一旦掌握了基本原则，您的所有项目都会井然有序且清晰：shell
脚本、游戏、移动应用程序、企业项目，甚至您的主目录。</p>
<p>对于 Rails 社区，他们希望能够让单个 Rails 开发人员从一个应用程序切换到另一个应用程序，并且每次都能熟悉并适应它。如果您是 37 signals
或 Pivotal Labs，这很有意义，并且有好处。在服务器端 JavaScript
世界中，整体风气只是更狂野的西部，我们对此没有真正的问题。我们就是这样滚动的。我们已经习惯了。即使在 express.js 中，它也是 Sinatra
的近亲，而不是 Rails，并且从 Rails 中获取约定通常无济于事。我什至会说 <strong>Principles over Convention over
Configuration</strong> 。</p>
<h3>基本原则和动机</h3>
<ul>
<li>精神上易于管理 <ul>
<li>大脑一次只能处理和思考少量的相关事物。这就是我们使用目录的原因。它通过关注小部分来帮助我们处理复杂性。</li>
</ul>
</li>
<li>大小合适 <ul>
<li>不要创建“Mansion Directories”，其中只有 1 个文件单独位于 3 个目录下。你可以在Ansible Best Practices中看到这种情况，它羞辱小项目创建 10 多个目录来保存 10 多个文件，而 1 个目录和 3 个文件会更合适。您不会开公交车上班（除非您是公交车司机，但即便如此，您开公交车上班也不是为了上班），所以不要创建文件系统结构，这些文件系统结构与其中的实际文件不符.</li>
</ul>
</li>
<li>模块化但务实 <ul>
<li>节点社区总体上偏爱小模块。任何可以完全从您的应用程序中分离出来的东西都应该提取到一个模块中供内部使用或在 npm 上公开发布。但是，对于此处范围内的中型应用程序，此开销可能会增加您的工作流程的单调乏味，而没有相应的价值。因此，当您有一些代码被提取出来但不足以证明一个完全独立的 npm 模块时，只需将其视为“ <strong>原型模块</strong> ”，并期望当它超过某个大小阈值时，它就会被提取出来。</li>
<li>有些人，例如@hij1nx甚至包含一个<code>app/node_modules</code>目录，并在 <strong>原型模块</strong><code>package.json</code>目录中包含文件，以促进转换并起到提醒作用。 ****</li>
</ul>
</li>
<li>易于定位代码 <ul>
<li>给定要构建的功能或要修复的错误，我们的目标是开发人员可以毫不费力地找到所涉及的源文件。 </li>
<li>名称有意义且准确</li>
<li>笨拙的代码被完全删除，而不是留在孤立文件中或只是被注释掉</li>
</ul>
</li>
<li>对搜索友好 <ul>
<li>所有第一方源代码都在<code>app</code>目录中，因此您可以<code>cd</code>运行 find/grep/xargs/ag/ack/etc 而不会被第三方匹配分心</li>
</ul>
</li>
<li>使用简单明了的命名 <ul>
<li>npm 现在似乎需要全小写的包名。我觉得这很糟糕，但我必须随大流，因此文件名应该使用，<code>kebab-case</code>即使 JavaScript 中的变量名必须是<code>camelCase</code>，因为<code>-</code>在 JavaScript 中是减号。</li>
<li>变量名称与模块路径的基本名称匹配，但已<code>kebab-case</code>转换为<code>camelCase</code>
</li>
</ul>
</li>
<li>按耦合分组，而不是按功能分组 <ul>
<li>
<code>app/views</code>这与 Ruby on Rails 约定的, <code>app/controllers</code>,<code>app/models</code>等有很大不同</li>
<li>功能被添加到完整堆栈中，因此我想专注于与我的功能相关的完整文件堆栈。当我向用户模型添加电话号码字段时，我不关心用户控制器以外的任何控制器，也不关心用户模型以外的任何模型。</li>
<li>因此，不是编辑 6 个文件，每个文件都在它们自己的目录中并忽略这些目录中的大量其他文件，而是组织此存储库，以便构建功能所需的所有文件都位于同一位置</li>
<li>根据 MVC 的性质，用户视图耦合到用户控制器，而用户控制器又耦合到用户模型。因此，当我更改用户模型时，这 3 个文件通常会一起更改，但交易控制器或客户控制器是解耦的，因此不涉及。这通常也适用于非 MVC 设计。</li>
<li>MVC 或 MOVE 风格的解耦在哪个代码进入哪个模块方面仍然受到鼓励，但是将 MVC 文件分散到同级目录中只是很烦人。</li>
<li>因此，我的每个路线文件都有它拥有的路线部分。如果您想要概览应用程序中的所有路由，则Rails 样式的<code>routes.rb</code>文件很方便，但在实际构建功能和修复错误时，您只关心与您正​​在更改的部分相关的路由。</li>
</ul>
</li>
<li>在代码旁边存储测试 <ul>
<li>这只是“group by coupling”的一个例子，但我想具体地把它叫出来。我写过许多项目，其中测试在一个名为“tests”的并行文件系统下进行，现在我已经开始将我的测试放在与其相应代码相同的目录中，我再也不会回头了。这更加模块化，更容易在文本编辑器中使用，并且减少了很多“../../..”路径的废话。如果您有疑问，请尝试几个项目并自行决定。除了这个我不会做任何事情来说服你它更好。</li>
</ul>
</li>
<li>减少与事件的交叉耦合 <ul>
<li>很容易想到“好吧，每当创建新交易时，我想向所有销售人员发送一封电子邮件”，然后只需将用于发送这些电子邮件的代码放在创建交易的路由中即可。</li>
<li>但是，这种耦合最终会将您的应用程序变成一个巨大的泥球。</li>
<li>相反，DealModel 应该只触发一个“创建”事件，并且完全不知道系统可能会对此做出什么反应。</li>
<li>当您以这种方式编写代码时，就更有可能将所有与用户相关的代码放入其中，<code>app/users</code>因为没有到处都是耦合业务逻辑的鼠窝污染用户代码库的纯度。</li>
</ul>
</li>
<li>代码流是可遵循的 <ul>
<li>不要做神奇的事情。不要从文件系统中的魔法目录自动加载文件。不要成为 Rails。该应用程序开始于<code>app/server.js:1</code>，您可以按照代码查看它加载和执行的所有内容。</li>
<li>不要为您的路线制作 DSL。不要在不需要时进行愚蠢的元编程。</li>
<li>如果您的应用程序太大以至于超过 3 个基本的, , , 调用<code>magicRESTRouter.route(somecontroller, {except: 'POST'})</code>对您来说是一个巨大的胜利，那么您可能正在构建一个太大而无法有效工作的单体应用程序。喜欢大赢，而不是将 3 条简单的线转换为 1 条复杂的线。<code>app.get``app.put``app.del</code>
</li>
</ul>
</li>
<li>使用小写字母的文件名 <ul>
<li>这种格式避免了跨平台的文件系统区分大小写问题</li>
<li>npm 禁止在新包名称中使用大写字母，这与它配合得很好</li>
</ul>
</li>
</ul>
<h3>express.js 细节</h3>
<ul>
<li>不要使用<code>app.configure</code>。它几乎完全没用，你只是不需要它。由于盲目复制，它有很多样板。</li>
<li>快递中的中间件和路由的顺序！！！ <ul>
<li>我在 stackoverflow 上看到的几乎所有路由问题都是乱序的 express 中间件</li>
<li>一般来说，你希望你的路线解耦，而不是那么依赖订单</li>
<li>
<code>app.use</code>如果您真的只需要 2 条路线的中间件，请不要用于整个应用程序（我正在看着您， <code>body-parser</code>）</li>
<li>确保当一切都说完并完成时，你完全按照这个顺序： </li>
<li>任何超级重要的应用程序范围的中间件</li>
<li>你所有的路由和各种路由中间件</li>
<li>THEN 错误处理程序</li>
</ul>
</li>
<li>可悲的是，受 sinatra 的启发，express.js 主要假设你所有的路线都将进入<code>server.js</code>，并且它们是如何排序的。对于中型应用程序，将事物分解为单独的路由模块很好，但它确实引入了无序中间件的危险</li>
</ul>
<h3>应用符号链接技巧</h3>
<p>在伟大的要点Better local require() paths for
Node.js中，社区详细概述和讨论了许多方法。我可能很快就会决定选择“只处理很多
../../../..”或使用requireFrom模块。然而，目前，我一直在使用下面详述的符号链接技巧。</p>
<p>因此，避免项目内需要烦人的相对路径的一种方法<code>require("../../../config")</code>是使用以下技巧：</p>
<ul>
<li>在 node_modules 下为您的应用创建一个符号链接 <ul>
<li>cd node_modules &amp;&amp; ln -nsf ../app</li>
</ul>
</li>
<li>只添加 <strong>node_modules/app 符​​号链接本身</strong> ，而不是整个 node_modules 文件夹，到 git <ul>
<li>git add -f node_modules/app</li>
<li>
<code>.gitignore</code>是的，你的文件中应该还有“node_modules”</li>
<li>不，您不应该将“node_modules”放入您的 git 存储库中。有些人会建议您这样做。他们是不正确的。</li>
</ul>
</li>
<li>现在您可以使用此前缀要求项目内模块 <ul>
<li><code>var config = require("app/config");</code></li>
<li>
<code>var DealModel = require("app/deals/deal-model")</code>;</li>
</ul>
</li>
<li>基本上，这使得项目内需求的工作与外部 npm 模块的需求非常相似。</li>
<li>抱歉，Windows 用户，您需要坚持使用父目录的相对路径。</li>
</ul>
<h3>配置</h3>
<p>Generally code modules and classes to expect only a basic JavaScript <code>options</code>
object passed in. Only <code>app/server.js</code> should load the <code>app/config.js</code> module.
From there it can synthesize small <code>options</code> objects to configure subsystems
as needed, but coupling every subsystem to a big global config module full of
extra information is bad coupling.</p>
<p>Try to centralize creation of DB connections and pass those into subsystems as
opposed to passing connection parameters and having subsystems make outgoing
connections themselves.</p>
<h4>NODE_ENV</h4>
<p>This is another enticing but terrible idea carried over from Rails. There
should be exactly 1 place in your app, <code>app/config.js</code> that looks at the
<code>NODE_ENV</code> environment variable. Everything else should take an explicit
option as a class constructor argument or module configuration parameter.</p>
<p>If the email module has an option as to how to deliver emails (SMTP, log to
stdout, put in queue etc), it should take an option like <code>{deliver: 'stdout'}</code>
but it should absolutely not check <code>NODE_ENV</code>.</p>
<h3>Tests</h3>
<p>I now keep my test files in the same directory as their corresponding code and
use filename extension naming conventions to distinguish tests from production
code.</p>
<ul>
<li>
<code>foo.js</code> has the module "foo"'s code</li>
<li>
<code>foo.tape.js</code> has the node-based tests for foo and lives in the same dir</li>
<li>
<code>foo.btape.js</code> can be used for tests that need to execute in a browser environment</li>
</ul>
<p>I use filesystem globs and the <code>find . -name '*.tape.js'</code> command to get
access to all my tests as necessary.</p>
<h3>How to organize code within each <code>.js</code> module file</h3>
<p>这个项目的范围主要是关于文件和目录的去向，我不想添加太多其他范围，但我只想提一下，我将我的代码组织成 3 个不同的部分。</p>
<ol>
<li>CommonJS 的 opening block 需要调用 state dependencies</li>
<li>纯 JavaScript 的主要代码块。这里没有 CommonJS 污染。不要引用导出、模块或要求。</li>
<li>CommonJS 的关闭块以设置导出</li>
</ol>
<p><br></p>
<h3>更多建议</h3>
<p><strong>更新（2013 年 10 月 29 日）</strong> ：请参阅我的其他答案，其中包含 JavaScript 而不是 CoffeeScript 的流行需求以及样板
github 存储库和详尽的自述文件，详细说明了我关于该主题的最新建议。</p>
<p><strong>配置</strong></p>
<p>你在做什么很好。我喜欢在顶层文件中设置自己的配置命名空间，<code>config.coffee</code>并带有这样的嵌套命名空间。</p>
<div class="code"><pre class="code literal-block"><span class="n">#Set</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">true</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="k">object</span>
<span class="n">currentEnv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">process</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">NODE_ENV</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">'development'</span>
<span class="n">exports</span><span class="p">.</span><span class="n">appName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">"MyApp"</span>
<span class="n">exports</span><span class="p">.</span><span class="n">env</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="nl">production</span><span class="p">:</span><span class="w"> </span><span class="k">false</span>
<span class="w">  </span><span class="nl">staging</span><span class="p">:</span><span class="w"> </span><span class="k">false</span>
<span class="w">  </span><span class="nl">test</span><span class="p">:</span><span class="w"> </span><span class="k">false</span>
<span class="w">  </span><span class="nl">development</span><span class="p">:</span><span class="w"> </span><span class="k">false</span>
<span class="n">exports</span><span class="p">.</span><span class="n">env</span><span class="o">[</span><span class="n">currentEnv</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
<span class="n">exports</span><span class="p">.</span><span class="nf">log</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="k">path</span><span class="err">:</span><span class="w"> </span><span class="n">__dirname</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">"/var/log/app_#{currentEnv}.log"</span>
<span class="n">exports</span><span class="p">.</span><span class="n">server</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="nl">port</span><span class="p">:</span><span class="w"> </span><span class="mi">9600</span>
<span class="w">  </span><span class="n">#In</span><span class="w"> </span><span class="n">staging</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">production</span><span class="p">,</span><span class="w"> </span><span class="n">listen</span><span class="w"> </span><span class="n">loopback</span><span class="p">.</span><span class="w"> </span><span class="n">nginx</span><span class="w"> </span><span class="n">listens</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">network</span><span class="p">.</span>
<span class="w">  </span><span class="nl">ip</span><span class="p">:</span><span class="w"> </span><span class="s1">'127.0.0.1'</span>
<span class="k">if</span><span class="w"> </span><span class="n">currentEnv</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">'production', 'staging'</span><span class="o">]</span>
<span class="w">  </span><span class="n">exports</span><span class="p">.</span><span class="n">enableTests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
<span class="w">  </span><span class="n">#Listen</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">IPs</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">dev</span><span class="o">/</span><span class="n">test</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="n">testing</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">machines</span><span class="p">)</span>
<span class="w">  </span><span class="n">exports</span><span class="p">.</span><span class="n">server</span><span class="p">.</span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'0.0.0.0'</span>
<span class="n">exports</span><span class="p">.</span><span class="n">db</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="nl">URL</span><span class="p">:</span><span class="w"> </span><span class="ss">"mongodb://localhost:27017/#{exports.appName.toLowerCase()}_#{currentEnv}"</span>
</pre></div>

<p>这对系统管理员编辑很友好。然后当我需要一些东西时，比如数据库连接信息，它是</p>
<div class="code"><pre class="code literal-block">require('./config').db.URL
</pre></div>

<p><strong>路由/控制器</strong></p>
<p>我喜欢把我的路线留给我的控制器，并将它们组织在一个<code>app/controllers</code>子目录中。然后我可以加载它们并让他们添加他们需要的任何路线。</p>
<p>在我的<code>app/server.coffee</code>coffeescript 文件中，我这样做：</p>
<div class="code"><pre class="code literal-block"><span class="p">[</span>
<span class="w">  </span><span class="s">'api'</span>
<span class="w">  </span><span class="s">'authorization'</span>
<span class="w">  </span><span class="s">'authentication'</span>
<span class="w">  </span><span class="s">'domains'</span>
<span class="w">  </span><span class="s">'users'</span>
<span class="w">  </span><span class="s">'stylesheets'</span>
<span class="w">  </span><span class="s">'javascripts'</span>
<span class="w">  </span><span class="s">'tests'</span>
<span class="w">  </span><span class="s">'sales'</span>
<span class="p">].</span><span class="nf">map</span><span class="w"> </span><span class="p">(</span><span class="n">controllerName</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">  </span><span class="n">controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="w"> </span><span class="s">'./controllers/'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">controllerName</span>
<span class="w">  </span><span class="n">controller</span><span class="p">.</span><span class="n">setup</span><span class="w"> </span><span class="n">app</span>
</pre></div>

<p>所以我有这样的文件：</p>
<div class="code"><pre class="code literal-block">app/controllers/api.coffee
app/controllers/authorization.coffee
app/controllers/authentication.coffee
app/controllers/domains.coffee
</pre></div>

<p>例如，在我的域控制器中，我有<code>setup</code>这样的功能。</p>
<div class="code"><pre class="code literal-block"><span class="n">exports</span><span class="o">.</span><span class="n">setup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">  </span><span class="n">controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">exports</span><span class="o">.</span><span class="n">DomainController</span>
<span class="w">  </span><span class="n">route</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'/domains'</span>
<span class="w">  </span><span class="n">app</span><span class="o">.</span><span class="n">post</span><span class="w"> </span><span class="n">route</span><span class="p">,</span><span class="w"> </span><span class="n">controller</span><span class="o">.</span><span class="n">create</span>
<span class="w">  </span><span class="n">app</span><span class="o">.</span><span class="n">put</span><span class="w"> </span><span class="n">route</span><span class="p">,</span><span class="w"> </span><span class="n">api</span><span class="o">.</span><span class="n">needId</span>
<span class="w">  </span><span class="n">app</span><span class="o">.</span><span class="n">delete</span><span class="w"> </span><span class="n">route</span><span class="p">,</span><span class="w"> </span><span class="n">api</span><span class="o">.</span><span class="n">needId</span>
<span class="w">  </span><span class="n">route</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'/domains/:id'</span>
<span class="w">  </span><span class="n">app</span><span class="o">.</span><span class="n">put</span><span class="w"> </span><span class="n">route</span><span class="p">,</span><span class="w"> </span><span class="n">controller</span><span class="o">.</span><span class="n">loadDomain</span><span class="p">,</span><span class="w"> </span><span class="n">controller</span><span class="o">.</span><span class="n">update</span>
<span class="w">  </span><span class="n">app</span><span class="o">.</span><span class="n">del</span><span class="w"> </span><span class="n">route</span><span class="p">,</span><span class="w"> </span><span class="n">controller</span><span class="o">.</span><span class="n">loadDomain</span><span class="p">,</span><span class="w"> </span><span class="n">exports</span><span class="o">.</span><span class="n">delete</span>
<span class="w">  </span><span class="n">app</span><span class="o">.</span><span class="n">get</span><span class="w"> </span><span class="n">route</span><span class="p">,</span><span class="w"> </span><span class="n">controller</span><span class="o">.</span><span class="n">loadDomain</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="n">res</span><span class="o">.</span><span class="n">sendJSON</span><span class="w"> </span><span class="n">req</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="o">.</span><span class="n">OK</span>
</pre></div>

<p><strong>观点</strong></p>
<p>放置视图<code>app/views</code>正在成为习惯的地方。我是这样布置的。</p>
<div class="code"><pre class="code literal-block">app/views/layout.jade
app/views/about.jade
app/views/user/EditUser.jade
app/views/domain/EditDomain.jade
</pre></div>

<p><strong>静态文件</strong></p>
<p>进入一个<code>public</code>子目录。</p>
<p><strong>Github/Semver/NPM</strong></p>
<p>将 README.md markdown 文件放在 github 的 git repo root 中。</p>
<p>将带有语义版本号的 package.json 文件放入NPM 的 git 存储库根目录中。</p>
<p><br><br><a href="../expressjs-how-to-structure-an-application/">查看原文</a></p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/express/" rel="tag">express</a></li>
            <li><a class="tag p-category" href="../../categories/nodejs/" rel="tag">node.js</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../zi-dong-zhuang-pei-zai-spring-zhong-shi-ru-he-gong-zuo-de/" rel="prev" title="自动装配在 Spring 中是如何工作的？">Previous post</a>
            </li>
            <li class="next">
                <a href="../wei-shi-yao-xiang-zhe-yang-de-biao-qing-fu-hao-zi-fu-zai-swift-zi-fu-chuan-zhong-chu-li-de-ru-ci-qi-guai/" rel="next" title="为什么像 👩‍👩‍👧‍👦 这样的表情符号字符在 Swift 字符串中处理得如此奇怪？">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
