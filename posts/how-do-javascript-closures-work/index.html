<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>How do JavaScript closures work? | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/how-do-javascript-closures-work/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../does-python-have-a-ternary-conditional-operator/" title="Does Python have a ternary conditional operator?" type="text/html">
<link rel="next" href="../how-do-i-revert-a-git-repository-to-a-previous-commit/" title="How do I revert a Git repository to a previous commit?" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="How do JavaScript closures work?">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/how-do-javascript-closures-work/">
<meta property="og:description" content="This question's answers are a community effort. Edit existing answers to
improve this post. It is not currently accepting new answers or interactions.
How would you explain JavaScript closures to some">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-16T18:23:53+08:00">
<meta property="article:tag" content="closures">
<meta property="article:tag" content="function">
<meta property="article:tag" content="javascript">
<meta property="article:tag" content="scope">
<meta property="article:tag" content="variables">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">How do JavaScript closures work?</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T18:23:53+08:00" itemprop="datePublished" title="2023-02-16 18:23">2023-02-16 18:23</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p><strong>This question's answers are a community effort</strong>. Edit existing answers to
improve this post. It is not currently accepting new answers or interactions.</p>
<p>How would you explain JavaScript closures to someone with a knowledge of the
concepts they consist of (for example functions, variables and the like), but
does not understand closures themselves?</p>
<p>I have seen the Scheme example given on Wikipedia, but unfortunately it did
not help.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>A closure is a pairing of:</p>
<ol>
<li>A function and</li>
<li>A reference to that function's outer scope (lexical environment)</li>
</ol>
<p>A lexical environment is part of every execution context (stack frame) and is
a map between identifiers (i.e. local variable names) and values.</p>
<p>Every function in JavaScript maintains a reference to its outer lexical
environment. This reference is used to configure the execution context created
when a function is invoked. This reference enables code inside the function to
"see" variables declared outside the function, regardless of when and where
the function is called.</p>
<p>If a function was called by a function, which in turn was called by another
function, then a chain of references to outer lexical environments is created.
This chain is called the scope chain.</p>
<p>In the following code, <code>inner</code> forms a closure with the lexical environment of
the execution context created when <code>foo</code> is invoked, <em>closing over</em> variable
<code>secret</code>:</p>
<div class="code"><pre class="code literal-block"><span class="k">function</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="n">const</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="n">trunc</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="k">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="k">inner</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n n-Quoted">`The secret number is ${secret}.`</span><span class="p">)</span>
<span class="w">  </span><span class="err">}</span>
<span class="err">}</span>
<span class="n">const</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n n-Quoted">`secret`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">directly</span><span class="w"> </span><span class="k">accessible</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">outside</span><span class="w"> </span><span class="n n-Quoted">`foo`</span>
<span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="n">way</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">retrieve</span><span class="w"> </span><span class="n n-Quoted">`secret`</span><span class="p">,</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n n-Quoted">`f`</span>
</pre></div>

<p>In other words: in JavaScript, functions carry a reference to a private "box
of state", to which only they (and any other functions declared within the
same lexical environment) have access. This box of the state is invisible to
the caller of the function, delivering an excellent mechanism for data-hiding
and encapsulation.</p>
<p>And remember: functions in JavaScript can be passed around like variables
(first-class functions), meaning these pairings of functionality and state can
be passed around your program: similar to how you might pass an instance of a
class around in C++.</p>
<p>If JavaScript did not have closures, then more states would have to be passed
between functions <em>explicitly</em> , making parameter lists longer and code
noisier.</p>
<p>So, if you want a function to always have access to a private piece of state,
you can use a closure.</p>
<p>...and frequently we <em>do</em> want to associate the state with a function. For
example, in Java or C++, when you add a private instance variable and a method
to a class, you are associating the state with functionality.</p>
<p>In C and most other common languages, after a function returns, all the local
variables are no longer accessible because the stack-frame is destroyed. In
JavaScript, if you declare a function within another function, then the local
variables of the outer function can remain accessible after returning from it.
In this way, in the code above, <code>secret</code> remains available to the function
object <code>inner</code>, <em>after</em> it has been returned from <code>foo</code>.</p>
<h3>Uses of Closures</h3>
<p>Closures are useful whenever you need a private state associated with a
function. This is a very common scenario - and remember: JavaScript did not
have a class syntax until 2015, and it still does not have a private field
syntax. Closures meet this need.</p>
<h4>Private Instance Variables</h4>
<p>In the following code, the function <code>toString</code> closes over the details of the
car.</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">Car</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="err">`</span><span class="o">$</span><span class="p">{</span><span class="n">manufacturer</span><span class="p">}</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">model</span><span class="p">}</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="p">{</span><span class="n">year</span><span class="p">},</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">color</span><span class="p">})</span><span class="err">`</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">const</span><span class="w"> </span><span class="n">car</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Car</span><span class="p">(</span><span class="s1">'Aston Martin'</span><span class="p">,</span><span class="w"> </span><span class="s1">'V8 Vantage'</span><span class="p">,</span><span class="w"> </span><span class="s1">'2012'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Quantum Silver'</span><span class="p">)</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">car</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span>
</pre></div>

<h4>Functional Programming</h4>
<p>In the following code, the function <code>inner</code> closes over both <code>fn</code> and <code>args</code>.</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">curry</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">inner</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">fn</span><span class="o">.</span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">fn</span><span class="p">(</span><span class="o">...</span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="n">args</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">inner</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">function</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>
<span class="p">}</span>

<span class="k">const</span><span class="w"> </span><span class="n">curriedAdd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curry</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">curriedAdd</span><span class="p">(</span><span class="mi">2</span><span class="p">)(</span><span class="mi">3</span><span class="p">)())</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">5</span>
</pre></div>

<h4>Event-Oriented Programming</h4>
<p>In the following code, function <code>onClick</code> closes over variable
<code>BACKGROUND_COLOR</code>.</p>
<div class="code"><pre class="code literal-block">const<span class="w"> </span>$<span class="w"> </span>=<span class="w"> </span>document.querySelector.bind(document)
const<span class="w"> </span>BACKGROUND_COLOR<span class="w"> </span>=<span class="w"> </span>'rgba(200,<span class="w"> </span>200,<span class="w"> </span>242,<span class="w"> </span>1)'

function<span class="w"> </span>onClick()<span class="w"> </span>{
<span class="w">  </span>$('body').style.background<span class="w"> </span>=<span class="w"> </span>BACKGROUND_COLOR
}

$('button').addEventListener('click',<span class="w"> </span>onClick)


<span class="nt">&lt;button&gt;</span>Set<span class="w"> </span>background<span class="w"> </span>color<span class="nt">&lt;/button&gt;</span>
</pre></div>

<h4>Modularization</h4>
<p>In the following example, all the implementation details are hidden inside an
immediately executed function expression. The functions <code>tick</code> and <code>toString</code>
close over the private state and functions they need to complete their work.
Closures have enabled us to modularize and encapsulate our code.</p>
<div class="code"><pre class="code literal-block"><span class="n">let</span><span class="w"> </span><span class="n">namespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="p">(</span><span class="n">function</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">let</span><span class="w"> </span><span class="n">numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="w">  </span><span class="n">function</span><span class="w"> </span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Math</span><span class="o">.</span><span class="n">trunc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">function</span><span class="w"> </span><span class="n">tick</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">numbers</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">function</span><span class="w"> </span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">numbers</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">format</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">n</span><span class="o">.</span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tick</span><span class="p">,</span>
<span class="w">    </span><span class="n">toString</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}(</span><span class="n">namespace</span><span class="p">))</span>

<span class="k">const</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">namespace</span><span class="o">.</span><span class="n">counter</span>
<span class="n">counter</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
<span class="n">counter</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span>
</pre></div>

<h3>Examples</h3>
<h4>Example 1</h4>
<p>This example shows that the local variables are not copied in the closure: the
closure maintains a reference to the original variables <em>themselves</em>. It is as
though the stack-frame stays alive in memory even after the outer function
exits.</p>
<div class="code"><pre class="code literal-block"><span class="nv">function</span><span class="w"> </span><span class="nv">foo</span><span class="ss">()</span><span class="w"> </span>{
<span class="w">  </span><span class="nv">let</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span>
<span class="w">  </span><span class="nv">let</span><span class="w"> </span><span class="nv">inner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">console</span>.<span class="nv">log</span><span class="ss">(</span><span class="nv">x</span><span class="ss">)</span>
<span class="w">  </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nv">inner</span>
}

<span class="nv">foo</span><span class="ss">()()</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nv">logs</span><span class="w"> </span><span class="mi">43</span>
</pre></div>

<h4>Example 2</h4>
<p>In the following code, three methods <code>log</code>, <code>increment</code>, and <code>update</code> all
close over the same lexical environment.</p>
<p>And every time <code>createObject</code> is called, a new execution context (stack frame)
is created and a completely new variable <code>x</code>, and a new set of functions
(<code>log</code> etc.) are created, that close over this new variable.</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">createObject</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">log</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="n">increment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">const</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createObject</span><span class="p">()</span>
<span class="n">o</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>
<span class="n">o</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">43</span>
<span class="n">o</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">o</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">5</span>
<span class="k">const</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createObject</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">42</span>
</pre></div>

<h4>Example 3</h4>
<p>If you are using variables declared using <code>var</code>, be careful you understand
which variable you are closing over. Variables declared using <code>var</code> are
hoisted. This is much less of a problem in modern JavaScript due to the
introduction of <code>let</code> and <code>const</code>.</p>
<p>In the following code, each time around the loop, a new function <code>inner</code> is
created, which closes over <code>i</code>. But because <code>var i</code> is hoisted outside the
loop, all of these inner functions close over the same variable, meaning that
the final value of <code>i</code> (3) is printed, three times.</p>
<div class="code"><pre class="code literal-block"><span class="k">function</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="nf">var</span><span class="w"> </span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nf">var</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">result</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="k">function</span><span class="w"> </span><span class="k">inner</span><span class="p">()</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="p">)</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">result</span>
<span class="err">}</span>

<span class="n">const</span><span class="w"> </span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span>
<span class="o">//</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="k">print</span><span class="w"> </span><span class="err">`</span><span class="mi">3</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="n">three</span><span class="w"> </span><span class="n">times</span><span class="p">...</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nf">var</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="k">result</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">()</span><span class="w"> </span>
<span class="err">}</span>
</pre></div>

<h3>Final points:</h3>
<ul>
<li>Whenever a function is declared in JavaScript closure is created.</li>
<li>Returning a <code>function</code> from inside another function is the classic example of closure, because the state inside the outer function is implicitly available to the returned inner function, even after the outer function has completed execution.</li>
<li>Whenever you use <code>eval()</code> inside a function, a closure is used. The text you <code>eval</code> can reference local variables of the function, and in the non-strict mode, you can even create new local variables by using <code>eval('var foo = …')</code>.</li>
<li>When you use <code>new Function(…)</code> (the Function constructor) inside a function, it does not close over its lexical environment: it closes over the global context instead. The new function cannot reference the local variables of the outer function.</li>
<li>A closure in JavaScript is like keeping a reference ( <strong>NOT</strong> a copy) to the scope at the point of function declaration, which in turn keeps a reference to its outer scope, and so on, all the way to the global object at the top of the scope chain.</li>
<li>A closure is created when a function is declared; this closure is used to configure the execution context when the function is invoked.</li>
<li>A new set of local variables is created every time a function is called.</li>
</ul>
<h3>Links</h3>
<ul>
<li>Douglas Crockford's simulated private attributes and private methods for an object, using closures.</li>
<li>A great explanation of how closures can cause memory leaks in IE if you are not careful.</li>
<li>MDN documentation on JavaScript Closures.</li>
</ul>
<p><br></p>
<h3>Suggest</h3>
<p>Every function in JavaScript maintains a link to its outer lexical
environment. A lexical environment is a map of all the names (eg. variables,
parameters) within a scope, with their values.</p>
<p>So, whenever you see the <code>function</code> keyword, code inside that function has
access to variables declared outside the function.</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">var</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>

<span class="w">  </span><span class="n">function</span><span class="w"> </span><span class="n">bar</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">tmp</span><span class="p">));</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="nb">log</span><span class="w"> </span><span class="mi">16</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">bar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">foo</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</pre></div>

<p>This will log <code>16</code> because function <code>bar</code> closes over the parameter <code>x</code> and
the variable <code>tmp</code>, both of which exist in the lexical environment of outer
function <code>foo</code>.</p>
<p>Function <code>bar</code>, together with its link with the lexical environment of
function <code>foo</code> is a closure.</p>
<p>A function doesn't have to <em>return</em> in order to create a closure. Simply by
virtue of its declaration, every function closes over its enclosing lexical
environment, forming a closure.</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">var</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">tmp</span><span class="p">));</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="nb">log</span><span class="w"> </span><span class="mi">16</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">var</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">bar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">16</span>
<span class="n">bar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">17</span>
</pre></div>

<p>The above function will also log 16, because the code inside <code>bar</code> can still
refer to argument <code>x</code> and variable <code>tmp</code>, even though they are no longer
directly in scope.</p>
<p>However, since <code>tmp</code> is still hanging around inside <code>bar</code>'s closure, it is
available to be incremented. It will be incremented each time you call <code>bar</code>.</p>
<p>The simplest example of a closure is this:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>

<span class="n">function</span><span class="w"> </span><span class="n">test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="mi">10</span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="mi">6</span>
<span class="p">}</span>
<span class="k">var</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<span class="n">test</span><span class="p">();</span>
</pre></div>

<p>When a JavaScript function is invoked, a new execution context <code>ec</code> is
created. Together with the function arguments and the target object, this
execution context also receives a link to the lexical environment of the
calling execution context, meaning the variables declared in the outer lexical
environment (in the above example, both <code>a</code> and <code>b</code>) are available from <code>ec</code>.</p>
<p>Every function creates a closure because every function has a link to its
outer lexical environment.</p>
<p>Note that variables <em>themselves</em> are visible from within a closure, <em>not</em>
copies.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/closures/" rel="tag">closures</a></li>
            <li><a class="tag p-category" href="../../categories/function/" rel="tag">function</a></li>
            <li><a class="tag p-category" href="../../categories/javascript/" rel="tag">javascript</a></li>
            <li><a class="tag p-category" href="../../categories/scope/" rel="tag">scope</a></li>
            <li><a class="tag p-category" href="../../categories/variables/" rel="tag">variables</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../does-python-have-a-ternary-conditional-operator/" rel="prev" title="Does Python have a ternary conditional operator?">Previous post</a>
            </li>
            <li class="next">
                <a href="../how-do-i-revert-a-git-repository-to-a-previous-commit/" rel="next" title="How do I revert a Git repository to a previous commit?">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
