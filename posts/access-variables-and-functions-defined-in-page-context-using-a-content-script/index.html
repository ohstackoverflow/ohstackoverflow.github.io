<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Access variables and functions defined in page context using a content script | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/access-variables-and-functions-defined-in-page-context-using-a-content-script/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../json-net-error-self-referencing-loop-detected-for-type/" title="JSON.NET Error Self referencing loop detected for type" type="text/html">
<link rel="next" href="../how-do-i-change-the-figure-size-with-subplots/" title="How do I change the figure size with subplots?" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="Access variables and functions defined in page context using a content">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/access-variables-and-functions-defined-in-page-context-using-a-content-script/">
<meta property="og:description" content="I'm learning how to create Chrome extensions. I just started developing one to
catch YouTube events. I want to use it with YouTube flash player (later I will
try to make it compatible with HTML5).
man">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-18T01:08:28+08:00">
<meta property="article:tag" content="content-script">
<meta property="article:tag" content="google-chrome">
<meta property="article:tag" content="google-chrome-extension">
<meta property="article:tag" content="javascript">
<meta property="article:tag" content="youtube-api">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Access variables and functions defined in page context using a content script</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T01:08:28+08:00" itemprop="datePublished" title="2023-02-18 01:08">2023-02-18 01:08</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>I'm learning how to create Chrome extensions. I just started developing one to
catch YouTube events. I want to use it with YouTube flash player (later I will
try to make it compatible with HTML5).</p>
<p><strong>manifest.json:</strong></p>
<div class="code"><pre class="code literal-block">{
    "name": "MyExtension",
    "version": "1.0",
    "description": "Gotta catch Youtube events!",
    "permissions": ["tabs", "http://*/*"],
    "content_scripts" : [{
        "matches" : [ "www.youtube.com/*"],
        "js" : ["myScript.js"]
    }]
}
</pre></div>

<p><strong>myScript.js:</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">state</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">"State Changed!"</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="k">var</span><span class="w"> </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s2">"movie_player"</span><span class="p">);</span>
<span class="n">player</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s2">"onStateChange"</span><span class="p">,</span><span class="w"> </span><span class="s2">"state"</span><span class="p">);</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">"Started!"</span><span class="p">);</span>
</pre></div>

<p>The problem is that the console gives me the <em>"Started!"</em> , but there is no
<em>"State Changed!"</em> when I play/pause YouTube videos.</p>
<p>When this code is put in the console, it worked. What am I doing wrong?</p>
<p><br><br></p>
<h2>Answer</h2>
<p><strong>Underlying cause:</strong><br>
Content scripts are executed in an "isolated world" environment.</p>
<p><strong>Solution:</strong><br>
Inject the code into the page using DOM - that code will be able to <em>access</em>
functions/variables of the page context ("main world") or <em>expose</em>
functions/variables to the page context (in your case it's the <code>state()</code>
method).</p>
<ul>
<li>
<p><strong>Note in case communication with the page script is needed:</strong><br>
Use DOM <code>CustomEvent</code> handler. Examples: one, two, and three.</p>
</li>
<li>
<p><strong>Note in case<code>chrome</code> API is needed in the page script:</strong><br>
Since <code>chrome.*</code> APIs can't be used in the page script, you have to use them
in the content script and send the results to the page script via DOM
messaging (see the note above).</p>
</li>
</ul>
<p><strong>Safety warning</strong> :<br>
A page may redefine or augment/hook a built-in prototype so your exposed code
may fail if the page did it in an incompatible fashion. If you want to make
sure your exposed code runs in a safe environment then you should either a)
declare your content script with "run_at": "document_start" and use Methods
2-3 not 1, or b) extract the original native built-ins via an empty iframe,
example. Note that with <code>document_start</code> you may need to use
<code>DOMContentLoaded</code> event inside the exposed code to wait for DOM.</p>
<h2>Table of contents</h2>
<ul>
<li>Method 1: Inject another file - ManifestV3 compatible</li>
<li>Method 2: Inject embedded code - MV2</li>
<li>Method 2b: Using a function - MV2</li>
<li>Method 3: Using an inline event - ManifestV3 compatible</li>
<li>Method 4: Using executeScript's world - ManifestV3 only</li>
<li>Method 5: Using <code>world</code> in manifest.json - ManifestV3 only, Chrome 111+</li>
<li>Dynamic values in the injected code</li>
</ul>
<h3>Method 1: Inject another file (ManifestV3/MV2)</h3>
<p>Particularly good when you have lots of code. Put the code in a file within
your extension, say <code>script.js</code>. Then load it in your content script like
this:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'script'</span><span class="p">);</span>
<span class="n">s</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chrome</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">getURL</span><span class="p">(</span><span class="s1">'script.js'</span><span class="p">);</span>
<span class="n">s</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">this</span><span class="o">.</span><span class="n">remove</span><span class="p">();</span>
<span class="p">};</span>
<span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">head</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">documentElement</span><span class="p">)</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</pre></div>

<p><strong>The js file must be exposed in<code>web_accessible_resources</code></strong>:</p>
<ul>
<li>
<p>manifest.json example for ManifestV2</p>
<div class="code"><pre class="code literal-block">"web_accessible_resources": ["script.js"],
</pre></div>

</li>
<li>
<p>manifest.json example for ManifestV3</p>
<div class="code"><pre class="code literal-block">"web_accessible_resources": [{
</pre></div>

<p>"resources": ["script.js"],
  "matches": ["<all_urls>"]
}]</all_urls></p>
</li>
</ul>
<p>If not, the following error will appear in the console:</p>
<blockquote>
<p>Denying load of chrome-extension://[EXTENSIONID]/script.js. Resources must
be listed in the web_accessible_resources manifest key in order to be loaded
by pages outside the extension.</p>
</blockquote>
<h3>Method 2: Inject embedded code (MV2)</h3>
<p>This method is useful when you want to quickly run a small piece of code. (See
also: How to disable facebook hotkeys with Chrome extension?).</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">`</span><span class="o">//</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="n">here</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">curly</span><span class="w"> </span><span class="n">braces</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">example</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">number</span><span class="p">:</span>
<span class="k">var</span><span class="w"> </span><span class="n">someFixedRandomValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="w"> </span><span class="n">Math</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="o">//</span><span class="w"> </span><span class="n">NOTE</span><span class="p">:</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">way</span><span class="p">,</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">below</span>
<span class="o">//</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="s2">"Dynamic values in the injected code"</span>
<span class="err">`</span><span class="p">;</span>

<span class="k">var</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'script'</span><span class="p">);</span>
<span class="n">script</span><span class="o">.</span><span class="n">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actualCode</span><span class="p">;</span>
<span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">head</span><span class="o">||</span><span class="n">document</span><span class="o">.</span><span class="n">documentElement</span><span class="p">)</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">script</span><span class="p">);</span>
<span class="n">script</span><span class="o">.</span><span class="n">remove</span><span class="p">();</span>
</pre></div>

<p>Note: template literals are only supported in Chrome 41 and above. If you want
the extension to work in Chrome 40-, use:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'/* Code here. Example: */'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'alert(0);'</span><span class="p">,</span>
<span class="w">                  </span><span class="s1">'// Beware! This array have to be joined'</span><span class="p">,</span>
<span class="w">                  </span><span class="s1">'// using a newline. Otherwise, missing semicolons'</span><span class="p">,</span>
<span class="w">                  </span><span class="s1">'// or single-line comments (//) will mess up your'</span><span class="p">,</span>
<span class="w">                  </span><span class="s1">'// code -----&gt;'</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">);</span>
</pre></div>

<h3>Method 2b: Using a function (MV2)</h3>
<p>For a big chunk of code, quoting the string is not feasible. Instead of using
an array, a function can be used, and stringified:</p>
<div class="code"><pre class="code literal-block"><span class="n">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">function</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">All</span><span class="w"> </span><span class="k">code</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">executed</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">local</span><span class="w"> </span><span class="n">scope</span><span class="p">.</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">For</span><span class="w"> </span><span class="n">example</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">following</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">overwrite</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n n-Quoted">`alert`</span><span class="w"> </span><span class="n">method</span>
<span class="w">    </span><span class="n">var</span><span class="w"> </span><span class="n">alert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">null</span><span class="p">;</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">To</span><span class="w"> </span><span class="n">overwrite</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="n n-Quoted">`window`</span><span class="o">:</span>
<span class="w">    </span><span class="k">window</span><span class="p">.</span><span class="n">alert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">null</span><span class="p">;</span>
<span class="err">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')();'</span><span class="p">;</span>
<span class="n">var</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="p">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'script'</span><span class="p">);</span>
<span class="n">script</span><span class="p">.</span><span class="n">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actualCode</span><span class="p">;</span>
<span class="p">(</span><span class="n">document</span><span class="p">.</span><span class="n">head</span><span class="o">||</span><span class="n">document</span><span class="p">.</span><span class="n">documentElement</span><span class="p">).</span><span class="n">appendChild</span><span class="p">(</span><span class="n">script</span><span class="p">);</span>
<span class="n">script</span><span class="p">.</span><span class="k">remove</span><span class="p">();</span>
</pre></div>

<p>This method works, because the <code>+</code> operator on strings and a function converts
all objects to a string. If you intend on using the code more than once, it's
wise to create a function to avoid code repetition. An implementation might
look like:</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">injectScript</span><span class="p">(</span><span class="k">func</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">func</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')();'</span>
<span class="w">    </span><span class="o">...</span>
<span class="p">}</span>
<span class="n">injectScript</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">alert</span><span class="p">(</span><span class="s2">"Injected script"</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>Note: Since the function is serialized, the original scope, and all bound
properties are lost!</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">scriptToInject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">typeof</span><span class="w"> </span><span class="n">scriptToInject</span><span class="p">);</span>
<span class="p">};</span>
<span class="n">injectScript</span><span class="p">(</span><span class="n">scriptToInject</span><span class="p">);</span>
<span class="o">//</span><span class="w"> </span><span class="n">Console</span><span class="w"> </span><span class="n">output</span><span class="p">:</span><span class="w">  </span><span class="s2">"undefined"</span>
</pre></div>

<h3>Method 3: Using an inline event (ManifestV3/MV2)</h3>
<p>Sometimes, you want to run some code immediately, e.g. to run some code before
the <code>&lt;head&gt;</code> element is created. This can be done by inserting a <code>&lt;script&gt;</code>
tag with <code>textContent</code> (see method 2/2b).</p>
<p>An alternative, <strong>but not recommended</strong> is to use inline events. It is not
recommended because if the page defines a Content Security policy that forbids
inline scripts, then inline event listeners are blocked. Inline scripts
injected by the extension, on the other hand, still run. If you still want to
use inline events, this is how:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'// Some code example </span><span class="se">\n</span><span class="s1">'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                 </span><span class="s1">'console.log(document.documentElement.outerHTML);'</span><span class="p">;</span>

<span class="n">document</span><span class="o">.</span><span class="n">documentElement</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s1">'onreset'</span><span class="p">,</span><span class="w"> </span><span class="n">actualCode</span><span class="p">);</span>
<span class="n">document</span><span class="o">.</span><span class="n">documentElement</span><span class="o">.</span><span class="n">dispatchEvent</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">CustomEvent</span><span class="p">(</span><span class="s1">'reset'</span><span class="p">));</span>
<span class="n">document</span><span class="o">.</span><span class="n">documentElement</span><span class="o">.</span><span class="n">removeAttribute</span><span class="p">(</span><span class="s1">'onreset'</span><span class="p">);</span>
</pre></div>

<p>Note: This method assumes that there are no other global event listeners that
handle the <code>reset</code> event. If there is, you can also pick one of the other
global events. Just open the JavaScript console (F12), type
<code>document.documentElement.on</code>, and pick on of the available events.</p>
<h3>Method 4: Using chrome.scripting API <code>world</code> (ManifestV3 only)</h3>
<ul>
<li>Chrome 95 or newer, <code>chrome.scripting.executeScript</code> with <code>world: 'MAIN'</code>
</li>
<li>Chrome 102 or newer, <code>chrome.scripting.registerContentScripts</code> with <code>world: 'MAIN'</code>, also allows <code>runAt: 'document_start'</code> to guarantee early execution of the page script.</li>
</ul>
<p>Unlike the other methods, this one is for the background script or the popup
script, not for the content script. See the documentation and examples.</p>
<h3>Method 5: Using <code>world</code> in manifest.json (ManifestV3 only)</h3>
<p>In Chrome 111 or newer you can add <code>"world": "MAIN"</code> to <code>content_scripts</code>
declaration in manifest.json to override the default value which is
<code>ISOLATED</code>. The scripts run in the listed order.</p>
<div class="code"><pre class="code literal-block">  "content_scripts": [{
    "js": ["content.js"],
    "matches": ["&lt;all_urls&gt;"],
    "run_at": "document_start"
  }, {
    "world": "MAIN",
    "js": ["page.js"],
    "matches": ["&lt;all_urls&gt;"],
    "run_at": "document_start"
  }],
</pre></div>

<h3>Dynamic values in the injected code (MV2)</h3>
<p>Occasionally, you need to pass an arbitrary variable to the injected function.
For example:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">GREETING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Hi, I'm "</span><span class="p">;</span>
<span class="k">var</span><span class="w"> </span><span class="n">NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Rob"</span><span class="p">;</span>
<span class="k">var</span><span class="w"> </span><span class="n">scriptToInject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">alert</span><span class="p">(</span><span class="n">GREETING</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NAME</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>

<p>To inject this code, you need to pass the variables as arguments to the
anonymous function. Be sure to implement it correctly! The following will
<strong>not</strong> work:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">scriptToInject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">GREETING</span><span class="p">,</span><span class="w"> </span><span class="n">NAME</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">};</span>
<span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">scriptToInject</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">GREETING</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NAME</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')'</span><span class="p">;</span>
<span class="o">//</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">numbers</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">booleans</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">strings</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="n">To</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">why</span><span class="p">,</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">resulting</span><span class="w"> </span><span class="n">string</span><span class="p">:</span>
<span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"(function(GREETING, NAME) {...})(Hi, I'm ,Rob)"</span><span class="p">;</span>
<span class="o">//</span><span class="w">                                                 </span><span class="o">^^^^^^^^</span><span class="w"> </span><span class="o">^^^</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">literals</span><span class="o">!</span>
</pre></div>

<p>The solution is to use <code>JSON.stringify</code> before passing the argument. Example:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">greeting</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">...</span>
<span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">GREETING</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">NAME</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')'</span><span class="p">;</span>
</pre></div>

<p>If you have many variables, it's worthwhile to use <code>JSON.stringify</code> once, to
improve readability, as follows:</p>
<div class="code"><pre class="code literal-block">...
} + ')(' + JSON.stringify([arg1, arg2, arg3, arg4]).slice(1, -1) + ')';
</pre></div>

<h3>Dynamic values in the injected code (ManifestV3)</h3>
<ul>
<li>Method 1 can set the URL of the script element in the content script:<div class="code"><pre class="code literal-block"><span class="nt">s</span><span class="p">.</span><span class="nc">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">chrome</span><span class="p">.</span><span class="nc">runtime</span><span class="p">.</span><span class="nc">getURL</span><span class="o">(</span><span class="s1">'script.js?'</span><span class="o">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">URLSearchParams</span><span class="o">(</span><span class="p">{</span><span class="n">foo</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="o">);</span>
</pre></div>

</li>
</ul>
<p>Then script.js can read it:</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">URLSearchParams</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">currentScript</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'?'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">));</span>
</pre></div>

<ul>
<li>Method 4 executeScript has <code>args</code> parameter, registerContentScripts currently doesn't (hopefully it'll be added in the future).</li>
</ul>
<p><br></p>
<h3>Suggest</h3>
<p>The only thing <del>missing</del> hidden from Rob W's excellent answer is how to
communicate between the injected page script and the content script.</p>
<p>On the receiving side (either your content script or the injected page script)
add an event listener:</p>
<div class="code"><pre class="code literal-block"><span class="n">document</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s1">'yourCustomEvent'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">var</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">detail</span><span class="p">;</span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">'received'</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>On the initiator side (content script or injected page script) send the event:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">allowedTypes</span><span class="p">:</span><span class="w"> </span><span class="s1">'those supported by structured cloning, see the list below'</span><span class="p">,</span>
<span class="w">  </span><span class="n">inShort</span><span class="p">:</span><span class="w"> </span><span class="s1">'no DOM elements or classes/functions'</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">document</span><span class="o">.</span><span class="n">dispatchEvent</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">CustomEvent</span><span class="p">(</span><span class="s1">'yourCustomEvent'</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">detail</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">}));</span>
</pre></div>

<p>Notes:</p>
<ul>
<li>DOM messaging uses structured cloning algorithm, which can transfer only some types of data in addition to primitive values. It can't send class instances or functions or DOM elements.</li>
<li>In Firefox, to send an object (i.e. not a primitive value) from the content script to the page context you have to explicitly clone it into the target using <code>cloneInto</code> (a built-in function), otherwise it'll fail with a security violation error.<div class="code"><pre class="code literal-block">document.dispatchEvent(new CustomEvent('yourCustomEvent', {
</pre></div>

<p>detail: cloneInto(data, document.defaultView),
}));</p>
</li>
</ul>
</div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/content-script/" rel="tag">content-script</a></li>
            <li><a class="tag p-category" href="../../categories/google-chrome/" rel="tag">google-chrome</a></li>
            <li><a class="tag p-category" href="../../categories/google-chrome-extension/" rel="tag">google-chrome-extension</a></li>
            <li><a class="tag p-category" href="../../categories/javascript/" rel="tag">javascript</a></li>
            <li><a class="tag p-category" href="../../categories/youtube-api/" rel="tag">youtube-api</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../json-net-error-self-referencing-loop-detected-for-type/" rel="prev" title="JSON.NET Error Self referencing loop detected for type">Previous post</a>
            </li>
            <li class="next">
                <a href="../how-do-i-change-the-figure-size-with-subplots/" rel="next" title="How do I change the figure size with subplots?">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
