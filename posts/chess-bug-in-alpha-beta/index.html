<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chess: Bug in Alpha-Beta | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/chess-bug-in-alpha-beta/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../easy-to-use-perl-modules-for-neural-networks/" title="Easy to use Perl modules for neural networks" type="text/html">
<link rel="next" href="../in-game-programming-how-can-i-test-whether-a-heuristic-used-is-consistent-or-not/" title="In game programming, how can I test whether a heuristic used is consistent or not?" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="Chess: Bug in Alpha-Beta">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/chess-bug-in-alpha-beta/">
<meta property="og:description" content="I am implementing a chess engine, and I have written a fairly complex alpha-
beta search routine with quiescence search and transposition tables. However,
I am observing a strange bug.
The evaluation ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-28T03:33:11+08:00">
<meta property="article:tag" content="algorithm">
<meta property="article:tag" content="alpha-beta-pruning">
<meta property="article:tag" content="artificial-intelligence">
<meta property="article:tag" content="chess">
<meta property="article:tag" content="minimax">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Chess: Bug in Alpha-Beta</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-28T03:33:11+08:00" itemprop="datePublished" title="2023-02-28 03:33">2023-02-28 03:33</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>I am implementing a chess engine, and I have written a fairly complex alpha-
beta search routine with quiescence search and transposition tables. However,
I am observing a strange bug.</p>
<p>The evaluation function is using piece-square tables, like this one for pawns:</p>
<div class="code"><pre class="code literal-block">static int ptable_pawn[64] = {  
   0,  0,  0,  0,  0,  0,  0,  0,
  30, 35, 35, 40, 40, 35, 35, 30,
  20, 25, 25, 30, 30, 25, 25, 20,
  10, 20, 20, 20, 20, 20, 20, 10,
   3,  0, 14, 15, 15, 14,  0,  3,
   0,  5,  3, 10, 10,  3,  5,  0,
   5,  5,  5,  5,  5,  5,  5,  5,
   0,  0,  0,  0,  0,  0,  0,  0
};
</pre></div>

<p>When it is black's turn, the table is reflected across the x-axis.
Specifically, if you are curious, lookups happen like this, where the columns
A-H map to 0-7 and the rows are 0-7 from white's side:</p>
<div class="code"><pre class="code literal-block"><span class="nv">int</span><span class="w"> </span><span class="nv">ptable_index_for_white</span><span class="ss">(</span><span class="nv">int</span><span class="w"> </span><span class="nv">col</span>,<span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">row</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">col</span><span class="o">+</span><span class="mi">56</span><span class="o">-</span><span class="ss">(</span><span class="nv">row</span><span class="o">*</span><span class="mi">8</span><span class="ss">)</span><span class="c1">;</span>
}

<span class="nv">int</span><span class="w"> </span><span class="nv">ptable_index_for_black</span><span class="ss">(</span><span class="nv">int</span><span class="w"> </span><span class="nv">col</span>,<span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">row</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">col</span><span class="o">+</span><span class="ss">(</span><span class="nv">row</span><span class="o">*</span><span class="mi">8</span><span class="ss">)</span><span class="c1">;</span>
}
</pre></div>

<p>So a pawn on h4 (coordinates 7, 3) is worth 3 points (centipawns) for white,
and a pawn on f6 (coord 5, 5) is worth 3 centipawns for black.</p>
<p>The entire evaluation function is currently piece-square tables and material.</p>
<p>At greater search depths, my engine is choosing some genuinely horrible moves.
Consider this output, generated from the starting position:</p>
<div class="code"><pre class="code literal-block">Iterative Deepening Analysis Results (including cached analysis)
Searching at depth 1... d1 [+0.10]: 1.b1c3 
    (4 new nodes, 39 new qnodes, 0 qnode aborts, 0ms), 162kN/s
Searching at depth 2... d2 [+0.00]: 1.e2e4 d7d5 
    (34 new nodes, 78 new qnodes, 0 qnode aborts, 1ms), 135kN/s
Searching at depth 3... d3 [+0.30]: 1.d2d4 d7d5 2.c1f4 
    (179 new nodes, 1310 new qnodes, 0 qnode aborts, 4ms), 337kN/s
Searching at depth 4... d4 [+0.00]: 1.g1f3 b8c6 2.e2e4 d7d5 
    (728 new nodes, 2222 new qnodes, 0 qnode aborts, 14ms), 213kN/s
Searching at depth 5... d5 [+0.20]: 1.b1a3 g8f6 2.d2d4 h8g8 3.c1f4 
    (3508 new nodes, 27635 new qnodes, 0 qnode aborts, 103ms), 302kN/s
Searching at depth 6... d6 [-0.08]: 1.d2d4 a7a5 2.c1f4 b7b6 3.f4c1 c8b7 
    (21033 new nodes, 112915 new qnodes, 0 qnode aborts, 654ms), 205kN/s
Searching at depth 7... d7 [+0.20]: 1.b1a3 g8f6 2.a1b1 h8g8 3.d2d4 g8h8 4.c1f4 
    (39763 new nodes, 330837 new qnodes, 0 qnode aborts, 1438ms), 258kN/s
Searching at depth 8... d8 [-0.05]: 1.e2e4 a7a6 2.e4e5 a6a5 3.h2h4 d7d6 4.e5d6 c7d6 
    (251338 new nodes, 2054526 new qnodes, 0 qnode aborts, 12098ms), 191kN/s
</pre></div>

<p>At depth 8, notice that black opens with the moves "... a7a6 ... a6a5," which
are horrible according to the piece-square table. Additionally, "h2h4" is a
horrible move for white. Why is my search function choosing such bizarre
moves? It's notable that this only starts happening at greater depths (the
moves at depth 3 look fine).</p>
<p>Moreover, the search often blunders away pieces! Consider the following
position:</p>
<p><img alt="Blunder" src="../../images/liacJ.png"></p>
<p>The engine recommends a horrific blunder (3... f5h3), somehow missing the
obvious reply (4. g2h3):</p>
<div class="code"><pre class="code literal-block">Searching at depth 7... d7 [+0.17]: 3...f5h3 4.e3e4 h3g4 5.f2f3 g8f6 6.e4d5 f6d5 
    (156240 new nodes, 3473795 new qnodes, 0 qnode aborts, 17715ms), 205kN/s
</pre></div>

<p>Quiescence search isn't involved, since the blunder happens at ply 1 (!!).</p>
<p>Here is the code for my search functions. I'm sorry it's so lengthy: I
simplified as best I could, but I can't know which parts are irrelevant to the
bug. I assume my algorithm is somehow subtly wrong.</p>
<p>The implementation is based on this one from Wikipedia, almost exactly.
(Update: I have significantly simplified the search, and my bug is still
present.)</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="n">Unified</span><span class="w"> </span><span class="n">alpha</span><span class="o">-</span><span class="n">beta</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">quiescence</span><span class="w"> </span><span class="k">search</span>
<span class="nc">int</span><span class="w"> </span><span class="n">abq</span><span class="p">(</span><span class="n">board</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">beta</span><span class="p">,</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">ply</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">pthread_testcancel</span><span class="p">();</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">To</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="k">search</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">termination</span>
<span class="w">    </span><span class="n">bool</span><span class="w"> </span><span class="n">quiescence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ply</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Generate</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">moves</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">quiscence</span><span class="w"> </span><span class="k">search</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">normal</span><span class="w"> </span><span class="k">search</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">compute</span><span class="w"> </span><span class="n">the</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">evaluation</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">applicable</span><span class="p">.</span>
<span class="w">    </span><span class="n">move</span><span class="w"> </span><span class="o">*</span><span class="n">moves</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">num_available_moves</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">quiescence</span><span class="p">)</span><span class="w"> </span><span class="n">moves</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board_moves</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">num_available_moves</span><span class="p">,</span><span class="w"> </span><span class="k">true</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Generate</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="n">captures</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="n">moves</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board_moves</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">num_available_moves</span><span class="p">,</span><span class="w"> </span><span class="k">false</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Generate</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">moves</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">quiescence</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">!</span><span class="n">useqsearch</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">relative_evaluation</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">qsearch</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">turned</span><span class="w"> </span><span class="k">off</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Abort</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">quiescence</span><span class="w"> </span><span class="k">search</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">too</span><span class="w"> </span><span class="n">deep</span><span class="w"> </span><span class="p">(</span><span class="n">currently</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="n">plies</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ply</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">quiesce_ply_cutoff</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"> </span>
<span class="w">        </span><span class="n">sstats</span><span class="p">.</span><span class="n">qnode_aborts</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">relative_evaluation</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Allow</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">quiescence</span><span class="w"> </span><span class="k">search</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">generate</span><span class="w"> </span><span class="n">cutoffs</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">quiescence</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="nc">int</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">relative_evaluation</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="w">        </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">beta</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">score</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Update</span><span class="w"> </span><span class="k">search</span><span class="w"> </span><span class="n">stats</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">quiescence</span><span class="p">)</span><span class="w"> </span><span class="n">sstats</span><span class="p">.</span><span class="n">qnodes_searched</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="n">sstats</span><span class="p">.</span><span class="n">nodes_searched</span><span class="o">++</span><span class="p">;</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">Search</span><span class="w"> </span><span class="nl">hueristic</span><span class="p">:</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="n">exchanges</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">MVV</span><span class="o">-</span><span class="n">LVA</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">quiescence</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mvvlva</span><span class="p">)</span><span class="w"> </span><span class="n">nlopt_qsort_r</span><span class="p">(</span><span class="n">moves</span><span class="p">,</span><span class="w"> </span><span class="n">num_available_moves</span><span class="p">,</span><span class="w"> </span><span class="n">sizeof</span><span class="p">(</span><span class="n">move</span><span class="p">),</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">capture_move_comparator</span><span class="p">);</span>

<span class="w">    </span><span class="n">move</span><span class="w"> </span><span class="n">best_move_yet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">no_move</span><span class="p">;</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">best_score_yet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NEG_INFINITY</span><span class="p">;</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">num_moves_actually_examined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">might</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">checkmate</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_available_moves</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Iterate</span><span class="w"> </span><span class="n">backwards</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">MVV</span><span class="o">-</span><span class="n">LVA</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="k">order</span>
<span class="w">        </span><span class="n">apply</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">moves</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">check</span>
<span class="w">        </span><span class="n">coord</span><span class="w"> </span><span class="n">king_loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">black_to_move</span><span class="w"> </span><span class="vm">?</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">white_king</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">black_king</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">side</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">moved</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_check</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">king_loc</span><span class="p">.</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">king_loc</span><span class="p">.</span><span class="k">row</span><span class="p">,</span><span class="w"> </span><span class="err">!</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">black_to_move</span><span class="p">)))</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">unapply</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">moves</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">        </span><span class="nc">int</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">abq</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">beta</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">ply</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">num_moves_actually_examined</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="n">unapply</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">moves</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">score</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">best_score_yet</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">best_score_yet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">;</span>
<span class="w">            </span><span class="n">best_move_yet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moves</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">        </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">best_score_yet</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">beta</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">available</span><span class="w"> </span><span class="n">moves</span><span class="w"> </span><span class="p">(</span><span class="ow">or</span><span class="w"> </span><span class="n">captures</span><span class="p">)</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">don</span><span class="s1">'t leave us in check</span>
<span class="s1">    // This means checkmate or stalemate in normal search</span>
<span class="s1">    // It might mean no captures are available in quiescence search</span>
<span class="s1">    if (num_moves_actually_examined == 0) {</span>
<span class="s1">        if (quiescence) return relative_evaluation(b); // TODO: qsearch doesn'</span><span class="n">t</span><span class="w"> </span><span class="n">understand</span><span class="w"> </span><span class="n">stalemate</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">checkmate</span>
<span class="w">        </span><span class="n">coord</span><span class="w"> </span><span class="n">king_loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">black_to_move</span><span class="w"> </span><span class="vm">?</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">black_king</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">white_king</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_check</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">king_loc</span><span class="p">.</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">king_loc</span><span class="p">.</span><span class="k">row</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">-&gt;</span><span class="n">black_to_move</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">NEG_INFINITY</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">checkmate</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">stalemate</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">selected</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">transposition</span><span class="w"> </span><span class="nc">table</span>
<span class="w">    </span><span class="n">evaltype</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">quiescence</span><span class="p">)</span><span class="w"> </span><span class="vm">?</span><span class="w"> </span><span class="n">qexact</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">exact</span><span class="p">;</span>
<span class="w">    </span><span class="n">evaluation</span><span class="w"> </span><span class="n">eval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="p">.</span><span class="n">best</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">best_move_yet</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">best_score_yet</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="k">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ply</span><span class="err">}</span><span class="p">;</span>
<span class="w">    </span><span class="n">tt_put</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">eval</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">best_score_yet</span><span class="p">;</span>
<span class="err">}</span>

<span class="cm">/* </span>
<span class="cm"> * Returns a relative evaluation of the board position from the perspective of the side about to move.</span>
<span class="cm"> */</span>
<span class="nc">int</span><span class="w"> </span><span class="n">relative_evaluation</span><span class="p">(</span><span class="n">board</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">evaluation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">evaluate</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">black_to_move</span><span class="p">)</span><span class="w"> </span><span class="n">evaluation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">evaluation</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">evaluation</span><span class="p">;</span>
<span class="err">}</span>
</pre></div>

<p>I am invoking the search like this:</p>
<div class="code"><pre class="code literal-block">int result = abq(b, NEG_INFINITY, POS_INFINITY, ply);
</pre></div>

<p>Edit: The bug persists even when I have simplified the search routine. The
engine simply blunders away pieces. You can see this easily by loading it in
XBoard (or any other UCI-compatible GUI) and playing it against a strong
engine. At manlio's request, I have uploaded the code:</p>
<p>Here is the GitHub repository (link removed; problem was in snippet above). It
will build using "make" on OS X or any *nix system.</p>
<p><br><br></p>
<h2>Answer</h2>
<div class="code"><pre class="code literal-block"><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">score</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nv">best_score_yet</span><span class="ss">)</span><span class="w"> </span>{
</pre></div>

<p>should be:</p>
<div class="code"><pre class="code literal-block"><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nv">best_score_yet</span><span class="ss">)</span><span class="w"> </span>{
</pre></div>

<p>or you're going to consider bad moves. The first <code>best_move_yet</code> will be
correct (since <code>best_score_yet = NEG_INFINITY</code>) but other moves with <code>score ==
best_score_yet</code> aren't necessarily better.</p>
<p>Changing that line:</p>
<p><strong>Starting position</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">Iterative</span><span class="w"> </span><span class="n">Deepening</span><span class="w"> </span><span class="n">Analysis</span><span class="w"> </span><span class="n">Results</span><span class="w"> </span><span class="p">(</span><span class="n">including</span><span class="w"> </span><span class="n">cached</span><span class="w"> </span><span class="n">analysis</span><span class="p">)</span>
<span class="n">Searching</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mf">1.</span><span class="o">..</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">0.10</span><span class="p">]:</span><span class="w"> </span><span class="mf">1.e2</span><span class="n">e4</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">qnodes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">qnode</span><span class="w"> </span><span class="n">aborts</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="mi">65</span><span class="n">kN</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">ttable</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">27777778</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="o">%</span><span class="w"> </span><span class="nb">load</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">misses</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">inserts</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">overwrites</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span>
<span class="n">Searching</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mf">2.</span><span class="o">..</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">0.00</span><span class="p">]:</span><span class="w"> </span><span class="mf">1.e2</span><span class="n">e4</span><span class="w"> </span><span class="n">g8f6</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="mi">21</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="mi">41</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">qnodes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">qnode</span><span class="w"> </span><span class="n">aborts</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="mi">132</span><span class="n">kN</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">ttable</span><span class="p">:</span><span class="w"> </span><span class="mi">26</span><span class="o">/</span><span class="mi">27777778</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="o">%</span><span class="w"> </span><span class="nb">load</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">misses</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="n">inserts</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">overwrites</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span>
<span class="n">Searching</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mf">3.</span><span class="o">..</span><span class="w"> </span><span class="n">d3</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">0.30</span><span class="p">]:</span><span class="w"> </span><span class="mf">1.</span><span class="n">d2d4</span><span class="w"> </span><span class="n">g8f6</span><span class="w"> </span><span class="mf">2.</span><span class="n">c1f4</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="mi">118</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="mi">247</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">qnodes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">qnode</span><span class="w"> </span><span class="n">aborts</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="mi">73</span><span class="n">kN</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">ttable</span><span class="p">:</span><span class="w"> </span><span class="mi">187</span><span class="o">/</span><span class="mi">27777778</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="o">%</span><span class="w"> </span><span class="nb">load</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">misses</span><span class="p">,</span><span class="w"> </span><span class="mi">161</span><span class="w"> </span><span class="n">inserts</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">overwrites</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span>
<span class="n">Searching</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mf">4.</span><span class="o">..</span><span class="w"> </span><span class="n">d4</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">0.00</span><span class="p">]:</span><span class="w"> </span><span class="mf">1.e2</span><span class="n">e4</span><span class="w"> </span><span class="n">g8f6</span><span class="w"> </span><span class="mf">2.</span><span class="n">f1d3</span><span class="w"> </span><span class="n">b8c6</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="mi">1519</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="mi">3044</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">qnodes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">qnode</span><span class="w"> </span><span class="n">aborts</span><span class="p">,</span><span class="w"> </span><span class="mi">38</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="mi">119</span><span class="n">kN</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">ttable</span><span class="p">:</span><span class="w"> </span><span class="mi">2622</span><span class="o">/</span><span class="mi">27777778</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.01</span><span class="o">%</span><span class="w"> </span><span class="nb">load</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">misses</span><span class="p">,</span><span class="w"> </span><span class="mi">2435</span><span class="w"> </span><span class="n">inserts</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">overwrites</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span>
<span class="n">Searching</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mf">5.</span><span class="o">..</span><span class="w"> </span><span class="n">d5</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">0.10</span><span class="p">]:</span><span class="w"> </span><span class="mf">1.</span><span class="n">g2g3</span><span class="w"> </span><span class="n">g8f6</span><span class="w"> </span><span class="mf">2.</span><span class="n">f1g2</span><span class="w"> </span><span class="n">b8c6</span><span class="w"> </span><span class="mf">3.</span><span class="n">g2f3</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="mi">10895</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="mi">35137</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">qnodes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">qnode</span><span class="w"> </span><span class="n">aborts</span><span class="p">,</span><span class="w"> </span><span class="mi">251</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="mi">184</span><span class="n">kN</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">ttable</span><span class="p">:</span><span class="w"> </span><span class="mi">30441</span><span class="o">/</span><span class="mi">27777778</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.11</span><span class="o">%</span><span class="w"> </span><span class="nb">load</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">misses</span><span class="p">,</span><span class="w"> </span><span class="mi">27819</span><span class="w"> </span><span class="n">inserts</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">overwrites</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span>
<span class="n">Searching</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mf">6.</span><span class="o">..</span><span class="w"> </span><span class="n">d6</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">0.08</span><span class="p">]:</span><span class="w"> </span><span class="mf">1.</span><span class="n">d2d4</span><span class="w"> </span><span class="n">g8f6</span><span class="w"> </span><span class="mf">2.</span><span class="n">c1g5</span><span class="w"> </span><span class="n">b8c6</span><span class="w"> </span><span class="mf">3.</span><span class="n">g5f6</span><span class="w"> </span><span class="n">g7f6</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="mi">88027</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="mi">249718</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">qnodes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">qnode</span><span class="w"> </span><span class="n">aborts</span><span class="p">,</span><span class="w"> </span><span class="mi">1281</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="mi">264</span><span class="n">kN</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">ttable</span><span class="p">:</span><span class="w"> </span><span class="mi">252536</span><span class="o">/</span><span class="mi">27777778</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.91</span><span class="o">%</span><span class="w"> </span><span class="nb">load</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">misses</span><span class="p">,</span><span class="w"> </span><span class="mi">222095</span><span class="w"> </span><span class="n">inserts</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">overwrites</span><span class="p">),</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span>
<span class="n">Searching</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mf">7.</span><span class="o">..</span><span class="w"> </span><span class="n">d7</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">0.15</span><span class="p">]:</span><span class="w"> </span><span class="mf">1.e2</span><span class="n">e4</span><span class="w"> </span><span class="n">g8f6</span><span class="w"> </span><span class="mf">2.</span><span class="n">d2d4</span><span class="w"> </span><span class="n">b8c6</span><span class="w"> </span><span class="mf">3.</span><span class="n">d4d5</span><span class="w"> </span><span class="n">c6b4</span><span class="w"> </span><span class="mf">4.</span><span class="n">g1f3</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="mi">417896</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="mi">1966379</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">qnodes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">qnode</span><span class="w"> </span><span class="n">aborts</span><span class="p">,</span><span class="w"> </span><span class="mi">8485</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="mi">281</span><span class="n">kN</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">ttable</span><span class="p">:</span><span class="w"> </span><span class="mi">1957490</span><span class="o">/</span><span class="mi">27777778</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">7.05</span><span class="o">%</span><span class="w"> </span><span class="nb">load</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">misses</span><span class="p">,</span><span class="w"> </span><span class="mi">1704954</span><span class="w"> </span><span class="n">inserts</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">overwrites</span><span class="p">),</span><span class="w"> </span><span class="mi">817</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span>
</pre></div>

<p>While in the test position:</p>
<div class="code"><pre class="code literal-block"><span class="n">Calculating</span><span class="o">...</span>
<span class="n">Iterative</span><span class="w"> </span><span class="n">Deepening</span><span class="w"> </span><span class="n">Analysis</span><span class="w"> </span><span class="n">Results</span><span class="w"> </span><span class="p">(</span><span class="n">including</span><span class="w"> </span><span class="n">cached</span><span class="w"> </span><span class="n">analysis</span><span class="p">)</span>
<span class="n">Searching</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mf">1.</span><span class="o">..</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">2.25</span><span class="p">]:</span><span class="w"> </span><span class="mf">3.</span><span class="o">..</span><span class="n">g8h6</span><span class="w"> </span><span class="mf">4.</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="n">c3d5</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="n">d8d5</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">qnodes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">qnode</span><span class="w"> </span><span class="n">aborts</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="n">kN</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">ttable</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="o">/</span><span class="mi">27777778</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="o">%</span><span class="w"> </span><span class="nb">load</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">misses</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">inserts</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">overwrites</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span>
<span class="n">Searching</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mf">2.</span><span class="o">..</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">0.13</span><span class="p">]:</span><span class="w"> </span><span class="mf">3.</span><span class="o">..</span><span class="n">f5e4</span><span class="w"> </span><span class="mf">4.</span><span class="n">c3e4</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="n">d5e4</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">qnodes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">qnode</span><span class="w"> </span><span class="n">aborts</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="mi">144</span><span class="n">kN</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">ttable</span><span class="p">:</span><span class="w"> </span><span class="mi">369</span><span class="o">/</span><span class="mi">27777778</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="o">%</span><span class="w"> </span><span class="nb">load</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">misses</span><span class="p">,</span><span class="w"> </span><span class="mi">366</span><span class="w"> </span><span class="n">inserts</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">overwrites</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span>
<span class="n">Searching</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mf">3.</span><span class="o">..</span><span class="w"> </span><span class="n">d3</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">0.25</span><span class="p">]:</span><span class="w"> </span><span class="mf">3.</span><span class="o">..</span><span class="n">g8h6</span><span class="w"> </span><span class="mf">4.</span><span class="n">c3e2</span><span class="w"> </span><span class="n">h6g4</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="mi">230</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="mi">2664</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">qnodes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">qnode</span><span class="w"> </span><span class="n">aborts</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="mi">122</span><span class="n">kN</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">ttable</span><span class="p">:</span><span class="w"> </span><span class="mi">2526</span><span class="o">/</span><span class="mi">27777778</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.01</span><span class="o">%</span><span class="w"> </span><span class="nb">load</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">misses</span><span class="p">,</span><span class="w"> </span><span class="mi">2157</span><span class="w"> </span><span class="n">inserts</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">overwrites</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span>
<span class="n">Searching</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mf">4.</span><span class="o">..</span><span class="w"> </span><span class="n">d4</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mf">0.10</span><span class="p">]:</span><span class="w"> </span><span class="mf">3.</span><span class="o">..</span><span class="n">g8f6</span><span class="w"> </span><span class="mf">4.e3</span><span class="n">e4</span><span class="w"> </span><span class="n">f5e6</span><span class="w"> </span><span class="mf">5.</span><span class="n">f1b5</span><span class="w"> </span>
<span class="w">    </span><span class="p">(</span><span class="mi">2084</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="mi">13998</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">qnodes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">qnode</span><span class="w"> </span><span class="n">aborts</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="mi">162</span><span class="n">kN</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">ttable</span><span class="p">:</span><span class="w"> </span><span class="mi">15663</span><span class="o">/</span><span class="mi">27777778</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.06</span><span class="o">%</span><span class="w"> </span><span class="nb">load</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">misses</span><span class="p">,</span><span class="w"> </span><span class="mi">13137</span><span class="w"> </span><span class="n">inserts</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">overwrites</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span>
<span class="n">Searching</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mf">5.</span><span class="o">..</span><span class="w"> </span><span class="n">d5</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="mf">0.15</span><span class="p">]:</span><span class="w"> </span><span class="mf">3.</span><span class="o">..</span><span class="n">g8f6</span><span class="w"> </span><span class="mf">4.</span><span class="n">f1e2</span><span class="w"> </span><span class="n">h8g8</span><span class="w"> </span><span class="mf">5.</span><span class="n">g2g4</span><span class="w"> </span><span class="n">f5e4</span><span class="w"> </span><span class="mf">6.</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="n">c3e4</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="n">f6e4</span><span class="w"> </span>
<span class="w">   </span><span class="p">(</span><span class="mi">38987</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span><span class="w"> </span><span class="mi">1004867</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">qnodes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">qnode</span><span class="w"> </span><span class="n">aborts</span><span class="p">,</span><span class="w"> </span><span class="mi">2765</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="mi">378</span><span class="n">kN</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="n">ttable</span><span class="p">:</span><span class="w"> </span><span class="mi">855045</span><span class="o">/</span><span class="mi">27777778</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.08</span><span class="o">%</span><span class="w"> </span><span class="nb">load</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">misses</span><span class="p">,</span><span class="w"> </span><span class="mi">839382</span><span class="w"> </span><span class="n">inserts</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">overwrites</span><span class="p">),</span><span class="w"> </span><span class="mi">302</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">failures</span><span class="p">)</span>
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>I'd be happy to take a look at the actual repo, but I've experienced this
exact problem many times implementing similar game playing algorithms. I'll
tell you what was causing the problems for me and you can check if you're
making the same mistakes. These are listed in the order in which I would guess
is most likely to solve your problem.</p>
<h4>Plys are not moves, moves should increase by 2 each iteration (that's what</h4>
<p>a ply is)</p>
<p>This mistake is almost always indicated by making poor choices for almost
every move for the first player because they can never see the consequence of
making a bad move. The way you avoid this is by increasing moves by 2 (or more
generally by the number of players in the game, but you're using minmax so
it's 2). This ensures each player always looks for consequences up to their
next turn.</p>
<h4>The evaluation must always be made from the standpoint of the current</h4>
<p>player</p>
<p>This one sounds obvious but I swear I screw this every time I implement an
evaluation function. When designing an evaluation, we always design it that
way from the standpoint of the first player to play, when what we should be
doing is designing it to return the evaluation of the current player. We can
tell which player's turn it is because we have the full board state, so there
is no need to pass it in.</p>
<p>This is especially hard to debug if your evaluate call isn't the first call in
your minmax function, but you've implemented it that way, so this isn't an
issue.</p>
<h4>The evaluation function must be symmetric</h4>
<p>This is an especially nasty bug when it happens. The idea is that the same
player would evaluate the same position differently depending on whether they
were winning or losing.</p>
<p>Take for example in chess where as the winning player, you want to win the
fewest number of moves, but if you're going to lose, you want to lose in the
longest number of moves. A typical solution for this is to say if you're going
to win, add a bonus for winning in a smaller number of moves, but if you're
going to lose, add a bonus for longer sequences. This results in adding a
bonus for the opposite reasons depending on situation, and removes the
symmetry from the evaluation such that Player A not equal -Player B. When you
lose this symmetry, you can no longer just pass values back up the game tree,
you have to re-evaluate them at each step.</p>
<p>But the trick is that doing adjustments like this <em>is always wrong</em>. With a
deep static evaluation, it will simply cut off early if it finds a guaranteed
win. With iterative deepening solutions it will still find the earlier win
first. A mate in 5 is never a mate in 4 unless the opponent blunders, so
adjustments like this are never needed.</p>
<h4>Double check that you are not having collisions with your transposition</h4>
<p>table</p>
<p>I cannot see the implementation of your transposition table, but if you are
dealing with more states than you have allotted to store, then you have to
ensure that it is the same position before you trust the value. I doubt this
is a problem since it looks like you're only looking at a few million nodes,
but it's always good to double check. Additionally, make sure your hash
function is sufficiently random to avoid regular collisions.</p>
<h4>
<code>mtd_f</code> should not consult the transposition table</h4>
<p><code>mtd_f</code> is a passthrough function that will handle the transposition table
correctly on the first call to <code>negamax</code>. You are improperly using the value
from it as it is implemented now, but just removing that code will clean up
the implementation and handle it correctly. Additionally, you should pass the
evaluation to the <code>mtd_f</code> function on each iteration, not attempt to load it
each time.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/algorithm/" rel="tag">algorithm</a></li>
            <li><a class="tag p-category" href="../../categories/alpha-beta-pruning/" rel="tag">alpha-beta-pruning</a></li>
            <li><a class="tag p-category" href="../../categories/artificial-intelligence/" rel="tag">artificial-intelligence</a></li>
            <li><a class="tag p-category" href="../../categories/chess/" rel="tag">chess</a></li>
            <li><a class="tag p-category" href="../../categories/minimax/" rel="tag">minimax</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../easy-to-use-perl-modules-for-neural-networks/" rel="prev" title="Easy to use Perl modules for neural networks">Previous post</a>
            </li>
            <li class="next">
                <a href="../in-game-programming-how-can-i-test-whether-a-heuristic-used-is-consistent-or-not/" rel="next" title="In game programming, how can I test whether a heuristic used is consistent or not?">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
