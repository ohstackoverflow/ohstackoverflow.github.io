<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Constraint Satisfaction Problem | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/constraint-satisfaction-problem/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../is-the-bias-node-necessary-in-very-large-neural-networks/" title="Is the bias node necessary in very large neural networks?" type="text/html">
<link rel="next" href="../why-does-a-path-finding-sometimes-go-in-straight-lines-and-sometimes-diagonals-java/" title="Why does A* path finding sometimes go in straight lines and sometimes diagonals? (Java)" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="Constraint Satisfaction Problem">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/constraint-satisfaction-problem/">
<meta property="og:description" content="I'm struggling my way through Artificial Intelligence: A Modern Approach in
order to alleviate my natural stupidity. In trying to solve some of the
exercises, I've come up against the &quot;Who Owns the Ze">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-28T03:52:51+08:00">
<meta property="article:tag" content="artificial-intelligence">
<meta property="article:tag" content="constraints">
<meta property="article:tag" content="modeling">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Constraint Satisfaction Problem</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-28T03:52:51+08:00" itemprop="datePublished" title="2023-02-28 03:52">2023-02-28 03:52</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>I'm struggling my way through Artificial Intelligence: A Modern Approach in
order to alleviate my natural stupidity. In trying to solve some of the
exercises, I've come up against the "Who Owns the Zebra" problem, Exercise
5.13 in Chapter 5. This has been a topic here on SO but the responses mostly
addressed the question "how would you solve this if you had a free choice of
problem solving software available?"</p>
<p>I accept that Prolog is a very appropriate programming language for this kind
of problem, and there are some fine packages available, e.g. in Python as
shown by the top-ranked answer and also standalone. Alas, none of this is
helping me "tough it out" in a way as outlined by the book.</p>
<p>The book appears to suggest building a set of dual or perhaps global
constraints, and then implementing some of the algorithms mentioned to find a
solution. I'm having a <em>lot</em> of trouble coming up with a set of constraints
suitable for modelling the problem. I'm studying this on my own so I don't
have access to a professor or TA to get me over the hump - this is where I'm
asking for your help.</p>
<hr>
<p>I see little similarity to the examples in the chapter.</p>
<p>I was eager to build dual constraints and started out by creating (the logical
equivalent of) 25 variables: <code>nationality1</code>, <code>nationality2</code>, <code>nationality3</code>,
... <code>nationality5</code>, <code>pet1</code>, <code>pet2</code>, <code>pet3</code>, ... <code>pet5</code>, <code>drink1</code> ... <code>drink5</code>
and so on, where the number was indicative of the house's position.</p>
<p>This is fine for building the unary constraints, e.g.</p>
<blockquote>
<p>The Norwegian lives in the first house:</p>
</blockquote>
<div class="code"><pre class="code literal-block">nationality1 = { :norway }.
</pre></div>

<p>But most of the constraints are a combination of two such variables through a
common house number, e.g.</p>
<blockquote>
<p>The Swede has a dog:</p>
</blockquote>
<div class="code"><pre class="code literal-block"><span class="n">nationality</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="err">:</span><span class="n">sweden</span><span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="ow">AND</span><span class="w"> </span><span class="n">pet</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="err">:</span><span class="n">dog</span><span class="w"> </span><span class="err">}</span>
</pre></div>

<p>where <code>n</code> can range from 1 to 5, obviously. Or stated another way:</p>
<div class="code"><pre class="code literal-block">    nationality1 = { :sweden } AND pet1 = { :dog } 
XOR nationality2 = { :sweden } AND pet2 = { :dog } 
XOR nationality3 = { :sweden } AND pet3 = { :dog } 
XOR nationality4 = { :sweden } AND pet4 = { :dog } 
XOR nationality5 = { :sweden } AND pet5 = { :dog }
</pre></div>

<p>...which has a decidedly different feel to it than the "list of tuples"
advocated by the book:</p>
<div class="code"><pre class="code literal-block">( X1, X2, X3 = { val1, val2, val3 }, { val4, val5, val6 }, ... )
</pre></div>

<hr>
<p>I'm not looking for a solution per se; I'm looking for a start on how to model
this problem in a way that's compatible with the book's approach. Any help
appreciated.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Thanks to everyone for some helpful information!</p>
<p>The hint I really needed came to me in a traffic jam. Rather than assigning
nationalities, pets etc. to houses (variables named <code>country1</code>, <code>country2</code>,
<code>pet1</code>, <code>pet2</code>), what I needed to do was assign houses to the elements of the
domain! Example:</p>
<div class="code"><pre class="code literal-block"><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="n">norway</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="n">unary</span><span class="w"> </span><span class="n">constraint</span><span class="p">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">Norwegian</span><span class="w"> </span><span class="n">lives</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">1</span><span class="n">st</span><span class="w"> </span><span class="n">house</span>
<span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">britain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dog</span><span class="w">     </span><span class="p">;</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="n">constraint</span><span class="p">:</span><span class="w"> </span><span class="n">Dog</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">house</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Brit</span>
<span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="n">green</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ivory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">relative</span><span class="w"> </span><span class="n">positions</span>
</pre></div>

<p>This allowed me to find simple formulations for my constraints, like this:</p>
<div class="code"><pre class="code literal-block"><span class="p">(</span><span class="n">def</span><span class="w"> </span><span class="n">constraints</span>
<span class="w">  </span><span class="c1">#{</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">england</span><span class="w"> </span><span class="p">:</span><span class="n">red</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">spain</span><span class="w"> </span><span class="p">:</span><span class="n">dog</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="nb">abs</span><span class="o">-</span><span class="n">pos</span><span class="w"> </span><span class="p">:</span><span class="n">norway</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">kools</span><span class="w"> </span><span class="p">:</span><span class="n">yellow</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">next</span><span class="o">-</span><span class="n">to</span><span class="w"> </span><span class="p">:</span><span class="n">chesterfields</span><span class="w"> </span><span class="p">:</span><span class="n">fox</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">next</span><span class="o">-</span><span class="n">to</span><span class="w"> </span><span class="p">:</span><span class="n">norway</span><span class="w"> </span><span class="p">:</span><span class="n">blue</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">winston</span><span class="w"> </span><span class="p">:</span><span class="n">snails</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">lucky</span><span class="w"> </span><span class="p">:</span><span class="n">oj</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">ukraine</span><span class="w"> </span><span class="p">:</span><span class="n">tea</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">japan</span><span class="w"> </span><span class="p">:</span><span class="n">parliaments</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">next</span><span class="o">-</span><span class="n">to</span><span class="w"> </span><span class="p">:</span><span class="n">kools</span><span class="w"> </span><span class="p">:</span><span class="n">horse</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">coffee</span><span class="w"> </span><span class="p">:</span><span class="n">green</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">right</span><span class="o">-</span><span class="n">of</span><span class="w"> </span><span class="p">:</span><span class="n">green</span><span class="w"> </span><span class="p">:</span><span class="n">ivory</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="nb">abs</span><span class="o">-</span><span class="n">pos</span><span class="w"> </span><span class="p">:</span><span class="n">milk</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">   </span><span class="p">})</span>
</pre></div>

<p>I'm not done yet (puttering at this only part time) but I will post a complete
solution once I work it out.</p>
<hr>
<p><strong>Update:</strong> About 2 weeks later, I've come up with a working solution in
Clojure:</p>
<div class="code"><pre class="code literal-block"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="nv">houses</span>
<span class="w">  </span><span class="p">[</span><span class="ss">:use</span><span class="w"> </span><span class="p">[</span><span class="nv">htmllog</span><span class="p">]</span><span class="w"> </span><span class="nv">clojure.set</span><span class="p">]</span><span class="w">  </span>
<span class="w">  </span><span class="p">)</span>

<span class="p">(</span><span class="nf">comment</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Englishman</span><span class="w"> </span><span class="nv">lives</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">red</span><span class="w"> </span><span class="nv">house.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Spaniard</span><span class="w"> </span><span class="nv">owns</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">dog.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Norwegian</span><span class="w"> </span><span class="nv">lives</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">ﬁrst</span><span class="w"> </span><span class="nv">house</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">left.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="nv">Kools</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">smoked</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">yellow</span><span class="w"> </span><span class="nv">house.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">man</span><span class="w"> </span><span class="nv">who</span><span class="w"> </span><span class="nv">smokes</span><span class="w"> </span><span class="nv">Chesterﬁelds</span><span class="w"> </span><span class="nv">lives</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">house</span><span class="w"> </span><span class="nb">next</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">man</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">fox.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Norwegian</span><span class="w"> </span><span class="nv">lives</span><span class="w"> </span><span class="nb">next</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">blue</span><span class="w"> </span><span class="nv">house.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Winston</span><span class="w"> </span><span class="nv">smoker</span><span class="w"> </span><span class="nv">owns</span><span class="w"> </span><span class="nv">snails.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Lucky</span><span class="w"> </span><span class="nv">Strike</span><span class="w"> </span><span class="nv">smoker</span><span class="w"> </span><span class="nv">drinks</span><span class="w"> </span><span class="nv">orange</span><span class="w"> </span><span class="nv">juice.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">9</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Ukrainian</span><span class="w"> </span><span class="nv">drinks</span><span class="w"> </span><span class="nv">tea.</span>
<span class="w">  </span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Japanese</span><span class="w"> </span><span class="nv">smokes</span><span class="w"> </span><span class="nv">Parliaments.</span>
<span class="w">  </span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="nv">Kools</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">smoked</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">house</span><span class="w"> </span><span class="nb">next</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">house</span><span class="w"> </span><span class="nv">where</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">horse</span><span class="w"> </span><span class="k">is </span><span class="nv">kept.</span>
<span class="w">  </span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="nv">Coffee</span><span class="w"> </span><span class="k">is </span><span class="nv">drunk</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">green</span><span class="w"> </span><span class="nv">house.</span>
<span class="w">  </span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Green</span><span class="w"> </span><span class="nv">house</span><span class="w"> </span><span class="k">is </span><span class="nv">immediately</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">right</span><span class="w"> </span><span class="p">(</span><span class="nf">your</span><span class="w"> </span><span class="nv">right</span><span class="p">)</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">ivory</span><span class="w"> </span><span class="nv">house.</span>
<span class="w">  </span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="w"> </span><span class="nv">Milk</span><span class="w"> </span><span class="k">is </span><span class="nv">drunk</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">middle</span><span class="w"> </span><span class="nv">house.</span>

<span class="w">  </span><span class="err">“</span><span class="nv">Where</span><span class="w"> </span><span class="nv">does</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">zebra</span><span class="w"> </span><span class="nv">live</span>,<span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="k">in </span><span class="nv">which</span><span class="w"> </span><span class="nv">house</span><span class="w"> </span><span class="k">do </span><span class="nv">they</span><span class="w"> </span><span class="nv">drink</span><span class="w"> </span><span class="nv">water?</span><span class="err">”</span>
<span class="p">)</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">positions</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="p">})</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">categories</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ss">:country</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="ss">:england</span><span class="w"> </span><span class="ss">:spain</span><span class="w"> </span><span class="ss">:norway</span><span class="w"> </span><span class="ss">:ukraine</span><span class="w"> </span><span class="ss">:japan</span><span class="p">}</span>
<span class="w">          </span><span class="ss">:color</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="ss">:red</span><span class="w"> </span><span class="ss">:yellow</span><span class="w"> </span><span class="ss">:blue</span><span class="w"> </span><span class="ss">:green</span><span class="w"> </span><span class="ss">:ivory</span><span class="p">}</span>
<span class="w">          </span><span class="ss">:pet</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="ss">:dog</span><span class="w"> </span><span class="ss">:fox</span><span class="w"> </span><span class="ss">:snails</span><span class="w"> </span><span class="ss">:horse</span><span class="w"> </span><span class="ss">:zebra</span><span class="p">}</span>
<span class="w">          </span><span class="ss">:smoke</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="ss">:chesterfield</span><span class="w"> </span><span class="ss">:winston</span><span class="w"> </span><span class="ss">:lucky</span><span class="w"> </span><span class="ss">:parliament</span><span class="w"> </span><span class="ss">:kool</span><span class="p">}</span>
<span class="w">          </span><span class="ss">:drink</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="ss">:orange-juice</span><span class="w"> </span><span class="ss">:tea</span><span class="w"> </span><span class="ss">:coffee</span><span class="w"> </span><span class="ss">:milk</span><span class="w"> </span><span class="ss">:water</span><span class="p">}</span>
<span class="p">})</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">constraints</span><span class="w"> </span><span class="o">#</span><span class="p">{</span>
<span class="w">                    </span><span class="c1">; -- unary</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">at</span><span class="w"> </span><span class="ss">:norway</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">; 3</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">at</span><span class="w"> </span><span class="ss">:milk</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="c1">; 14</span>
<span class="w">                    </span><span class="c1">; -- simple binary</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:england</span><span class="w"> </span><span class="ss">:red</span><span class="p">)</span><span class="w"> </span><span class="c1">; 1</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:spain</span><span class="w"> </span><span class="ss">:dog</span><span class="p">)</span><span class="w"> </span><span class="c1">; 2</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:kool</span><span class="w"> </span><span class="ss">:yellow</span><span class="p">)</span><span class="w"> </span><span class="c1">; 4</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:winston</span><span class="w"> </span><span class="ss">:snails</span><span class="p">)</span><span class="w"> </span><span class="c1">; 7</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:lucky</span><span class="w"> </span><span class="ss">:orange-juice</span><span class="p">)</span><span class="w"> </span><span class="c1">; 8</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:ukraine</span><span class="w"> </span><span class="ss">:tea</span><span class="p">)</span><span class="w"> </span><span class="c1">; 9</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:japan</span><span class="w"> </span><span class="ss">:parliament</span><span class="p">)</span><span class="w"> </span><span class="c1">; 10</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:coffee</span><span class="w"> </span><span class="ss">:green</span><span class="p">)</span><span class="w"> </span><span class="c1">; 12</span>
<span class="w">                    </span><span class="c1">; -- interesting binary</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nb">next</span><span class="nv">-to</span><span class="w"> </span><span class="ss">:chesterfield</span><span class="w"> </span><span class="ss">:fox</span><span class="p">)</span><span class="w"> </span><span class="c1">; 5</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nb">next</span><span class="nv">-to</span><span class="w"> </span><span class="ss">:norway</span><span class="w"> </span><span class="ss">:blue</span><span class="p">)</span><span class="w"> </span><span class="c1">; 6</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nb">next</span><span class="nv">-to</span><span class="w"> </span><span class="ss">:kool</span><span class="w"> </span><span class="ss">:horse</span><span class="p">)</span><span class="w"> </span><span class="c1">; 11</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">relative</span><span class="w"> </span><span class="ss">:green</span><span class="w"> </span><span class="ss">:ivory</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">; 13</span>
<span class="p">})</span>

<span class="c1">; ========== Setup ==========</span>

<span class="p">(</span><span class="nf">doseq</span><span class="w"> </span><span class="p">[</span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">3</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="nf">println</span><span class="p">))</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">var-cat</span><span class="w">    </span><span class="c1">; map of variable -&gt; group </span>
<span class="w">      </span><span class="c1">; {:kool :smoke, :water :drink, :ivory :color, ... </span>
<span class="w">    </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nb">hash</span><span class="nv">-map</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nv">concat</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">cat</span><span class="w"> </span><span class="nv">categories</span><span class="w"> </span><span class="nv">vari</span><span class="w"> </span><span class="p">(</span><span class="nf">second</span><span class="w"> </span><span class="nv">cat</span><span class="p">)]</span><span class="w"> </span>
<span class="w">      </span><span class="p">[</span><span class="nv">vari</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="nv">cat</span><span class="p">)]))))</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"var-cat:"</span><span class="w"> </span><span class="nv">var-cat</span><span class="p">)</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">initial-vars</span><span class="w">    </span><span class="c1">; map of variable -&gt; positions</span>
<span class="w">      </span><span class="c1">; {:kool #{1 2 3 4 5}, :water #{1 2 3 4 5}, :ivory #{1 2 3 4 5}, ...</span>
<span class="w">    </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nb">hash</span><span class="nv">-map</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nv">concat</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">v</span><span class="w"> </span><span class="p">(</span><span class="nf">keys</span><span class="w"> </span><span class="nv">var-cat</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="nv">v</span><span class="w"> </span><span class="nv">positions</span><span class="p">]))))</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"initial-vars:"</span><span class="w"> </span><span class="nv">initial-vars</span><span class="p">)</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">apply-unary-constraints</span>
<span class="w">   </span><span class="s">"This applies the 'at' constraint. Separately, because it only needs doing once."</span><span class="w"> </span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">update</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nv">concat</span>
<span class="w">      </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">c</span><span class="w"> </span><span class="nv">constraints</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span><span class="ss">'at</span><span class="p">)</span><span class="w"> </span><span class="ss">:let</span><span class="w"> </span><span class="p">[[</span><span class="nv">v</span><span class="w"> </span><span class="nv">d</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="k">rest </span><span class="nv">c</span><span class="p">)]]</span>
<span class="w">   </span><span class="p">[</span><span class="nv">v</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="nv">d</span><span class="p">}]))]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="k">assoc </span><span class="nb">vars</span><span class="w"> </span><span class="nv">update</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">after-unary</span><span class="w"> </span><span class="p">(</span><span class="nf">apply-unary-constraints</span><span class="w"> </span><span class="nv">initial-vars</span><span class="p">))</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"after-unary:"</span><span class="w"> </span><span class="nv">after-unary</span><span class="p">)</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">binary-constraints</span><span class="w"> </span><span class="p">(</span><span class="nb">remove </span><span class="o">#</span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="ss">'at</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="nv">%</span><span class="p">))</span><span class="w"> </span><span class="nv">constraints</span><span class="p">))</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"binary-constraints:"</span><span class="w"> </span><span class="nv">binary-constraints</span><span class="p">)</span>

<span class="c1">; ========== Utilities ==========</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">dump-vars</span>
<span class="w">   </span><span class="s">"Dump map `vars` as a HTML table in the log, with `title`."</span><span class="w"> </span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="w"> </span><span class="nv">title</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">letfn</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">(</span><span class="nb">vars</span><span class="nv">-for-cat-pos</span><span class="w"> </span><span class="p">[</span><span class="nb">vars</span><span class="w"> </span><span class="nv">var-list</span><span class="w"> </span><span class="nv">pos</span><span class="p">]</span>
<span class="w">          </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nb">str</span><span class="w"> </span><span class="p">(</span><span class="nf">interpose</span><span class="w"> </span><span class="s">"&lt;br/&gt;"</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">((</span><span class="nb">vars</span><span class="w"> </span><span class="nv">%</span><span class="p">)</span><span class="w"> </span><span class="nv">pos</span><span class="p">)</span><span class="w"> </span><span class="nv">var-list</span><span class="p">)))))]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"h2"</span><span class="w"> </span><span class="nv">title</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">log</span><span class="w"> </span><span class="s">"&lt;table border='1'&gt;"</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">log</span><span class="w"> </span><span class="s">"&lt;tr&gt;"</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"th"</span><span class="w"> </span><span class="nv">%</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">cons</span><span class="w"> </span><span class="s">"house"</span><span class="w"> </span><span class="nv">positions</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">log</span><span class="w"> </span><span class="s">"&lt;/tr&gt;"</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">doseq</span><span class="w"> </span><span class="p">[</span><span class="nv">cat</span><span class="w"> </span><span class="nv">categories</span><span class="p">]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">log</span><span class="w"> </span><span class="s">"&lt;tr&gt;"</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"th"</span><span class="w"> </span><span class="p">(</span><span class="nf">name</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="nv">cat</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nf">doseq</span><span class="w"> </span><span class="p">[</span><span class="nv">pos</span><span class="w"> </span><span class="nv">positions</span><span class="p">]</span>
<span class="w">          </span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"td"</span><span class="w"> </span><span class="p">(</span><span class="nb">vars</span><span class="nv">-for-cat-pos</span><span class="w"> </span><span class="nb">vars</span><span class="w"> </span><span class="p">(</span><span class="nf">second</span><span class="w"> </span><span class="nv">cat</span><span class="p">)</span><span class="w"> </span><span class="nv">pos</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">log</span><span class="w"> </span><span class="s">"&lt;/tr&gt;"</span><span class="p">)</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">log</span><span class="w"> </span><span class="s">"&lt;/table&gt;"</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">remove-values</span>
<span class="w">   </span><span class="s">"Given a list of key/value pairs, remove the values from the vars named by key."</span><span class="w"> </span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="w"> </span><span class="nv">kvs</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">names</span><span class="w"> </span><span class="p">(</span><span class="nb">distinct </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="k">first </span><span class="nv">kvs</span><span class="p">))</span>
<span class="w">      </span><span class="nv">delta</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">n</span><span class="w"> </span><span class="nv">names</span><span class="p">]</span>
<span class="w">      </span><span class="p">[</span><span class="nv">n</span><span class="w"> </span><span class="p">(</span><span class="nb">set</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="nv">second</span><span class="w"> </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="nv">%</span><span class="p">))</span><span class="w"> </span><span class="nv">kvs</span><span class="p">)))])</span>
<span class="w">      </span><span class="nv">update</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">kv</span><span class="w"> </span><span class="nv">delta</span>
<span class="w">         </span><span class="ss">:let</span><span class="w"> </span><span class="p">[[</span><span class="nv">cname</span><span class="w"> </span><span class="nv">negative</span><span class="p">]</span><span class="w"> </span><span class="nv">kv</span><span class="p">]]</span>
<span class="w">      </span><span class="p">[</span><span class="nv">cname</span><span class="w"> </span><span class="p">(</span><span class="nf">difference</span><span class="w"> </span><span class="p">(</span><span class="nb">vars</span><span class="w"> </span><span class="nv">cname</span><span class="p">)</span><span class="w"> </span><span class="nv">negative</span><span class="p">)])]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nb">vars</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="k">assoc </span><span class="nb">vars</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nv">concat</span><span class="w"> </span><span class="nv">update</span><span class="p">))]</span>
<span class="w">   </span><span class="nb">vars</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">siblings</span>
<span class="w">   </span><span class="s">"Given a variable name, return a list of the names of variables in the same category."</span>
<span class="w">   </span><span class="p">[</span><span class="nv">vname</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">disj</span><span class="w"> </span><span class="p">(</span><span class="nf">categories</span><span class="w"> </span><span class="p">(</span><span class="nf">var-cat</span><span class="w"> </span><span class="nv">vname</span><span class="p">))</span><span class="w"> </span><span class="nv">vname</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">contradictory?</span>
<span class="w">   </span><span class="s">"Checks for a contradiction in vars, indicated by one variable having an empty domain."</span><span class="w"> </span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">some</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="p">(</span><span class="nb">vars</span><span class="w"> </span><span class="nv">%</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">keys</span><span class="w"> </span><span class="nb">vars</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">solved?</span>
<span class="w">   </span><span class="s">"Checks if all variables in 'vars' have a single-value domain."</span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">every?</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nf">count</span><span class="w"> </span><span class="p">(</span><span class="nb">vars</span><span class="w"> </span><span class="nv">%</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nf">keys</span><span class="w"> </span><span class="nb">vars</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">first-most-constrained</span>
<span class="w">   </span><span class="s">"Finds a variable having the smallest domain size &gt; 1."</span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">best-pair</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="p">(</span><span class="nf">sort</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">v</span><span class="w"> </span><span class="p">(</span><span class="nf">keys</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="ss">:let</span><span class="w"> </span><span class="p">[</span><span class="nv">n</span><span class="w"> </span><span class="p">(</span><span class="nf">count</span><span class="w"> </span><span class="p">(</span><span class="nb">vars</span><span class="w"> </span><span class="nv">v</span><span class="p">))]</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">&gt;</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="nv">n</span><span class="w"> </span><span class="nv">v</span><span class="p">])))]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"best-pair:"</span><span class="w"> </span><span class="nv">best-pair</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">second</span><span class="w"> </span><span class="nv">best-pair</span><span class="p">)))</span>

<span class="c1">;========== Constraint functions ==========</span>

<span class="w">   </span><span class="p">(</span><span class="nf">comment</span>
<span class="w">      </span><span class="nv">These</span><span class="w"> </span><span class="nv">functions</span><span class="w"> </span><span class="nv">make</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">assertion</span><span class="w"> </span><span class="nv">about</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">domains</span><span class="w"> </span><span class="k">in </span><span class="nb">map</span><span class="w"> </span><span class="ss">'bvars</span><span class="o">'</span>,<span class="w"> </span>
<span class="w">      </span><span class="nv">and</span><span class="w"> </span><span class="nb">remove any</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">which</span><span class="w"> </span><span class="nv">those</span><span class="w"> </span><span class="nv">assertions</span><span class="w"> </span><span class="k">do </span><span class="nv">not</span><span class="w"> </span><span class="nv">hold.</span><span class="w"> </span>
<span class="w">      </span><span class="nv">They</span><span class="w"> </span><span class="nb">all</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="p">(</span><span class="nf">hopefully</span><span class="w"> </span><span class="nv">modified</span><span class="p">)</span><span class="w"> </span><span class="nv">domain</span><span class="w"> </span><span class="nv">space</span><span class="w"> </span><span class="ss">'bvars'.</span><span class="p">)</span>

<span class="w">   </span><span class="p">(</span><span class="nf">declare</span><span class="w"> </span><span class="nv">bvars</span><span class="w"> </span><span class="nv">coloc</span><span class="w"> </span><span class="nb">next</span><span class="nv">-to</span><span class="w"> </span><span class="nv">relative</span><span class="w"> </span><span class="nv">alldiff</span><span class="w"> </span><span class="nv">solitary</span><span class="p">)</span>

<span class="w">   </span><span class="p">(</span><span class="kd">defn </span><span class="nv">coloc</span>
<span class="w">      </span><span class="s">"Two variables share the same location."</span><span class="w"> </span>
<span class="w">      </span><span class="p">[</span><span class="nv">vname1</span><span class="w"> </span><span class="nv">vname2</span><span class="p">]</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname2</span><span class="p">))</span><span class="w"> </span><span class="nv">bvars</span>
<span class="w">   </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">inter</span><span class="w"> </span><span class="p">(</span><span class="nf">intersection</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname2</span><span class="p">))]</span>
<span class="w">         </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="k">assoc </span><span class="nv">bvars</span><span class="w"> </span><span class="p">[</span><span class="nv">vname1</span><span class="w"> </span><span class="nv">inter</span><span class="w"> </span><span class="nv">vname2</span><span class="w"> </span><span class="nv">inter</span><span class="p">])))))</span>

<span class="w">   </span><span class="p">(</span><span class="kd">defn </span><span class="nb">next</span><span class="nv">-to</span><span class="w"> </span>
<span class="w">      </span><span class="s">"Two variables have adjoining positions"</span>
<span class="w">      </span><span class="p">[</span><span class="nv">vname1</span><span class="w"> </span><span class="nv">vname2</span><span class="p">]</span>
<span class="w">      </span><span class="c1">; (prn "doing next-to" vname1 vname2)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">v1</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname1</span><span class="p">)</span><span class="w"> </span><span class="nv">v2</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname2</span><span class="p">)</span>
<span class="w">            </span><span class="nv">bad1</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">j1</span><span class="w"> </span><span class="nv">v1</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">not</span><span class="w"> </span><span class="p">(</span><span class="nf">or</span><span class="w"> </span><span class="p">(</span><span class="nf">v2</span><span class="w"> </span><span class="p">(</span><span class="nb">dec </span><span class="nv">j1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">v2</span><span class="w"> </span><span class="p">(</span><span class="nb">inc </span><span class="nv">j1</span><span class="p">))))]</span><span class="w"> </span><span class="p">[</span><span class="nv">vname1</span><span class="w"> </span><span class="nv">j1</span><span class="p">])</span>
<span class="w">        </span><span class="nv">bad2</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">j2</span><span class="w"> </span><span class="nv">v2</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">not</span><span class="w"> </span><span class="p">(</span><span class="nf">or</span><span class="w"> </span><span class="p">(</span><span class="nf">v1</span><span class="w"> </span><span class="p">(</span><span class="nb">dec </span><span class="nv">j2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">v1</span><span class="w"> </span><span class="p">(</span><span class="nb">inc </span><span class="nv">j2</span><span class="p">))))]</span><span class="w"> </span><span class="p">[</span><span class="nv">vname2</span><span class="w"> </span><span class="nv">j2</span><span class="p">])</span>
<span class="w">         </span><span class="nv">allbad</span><span class="w"> </span><span class="p">(</span><span class="nf">concat</span><span class="w"> </span><span class="nv">bad1</span><span class="w"> </span><span class="nv">bad2</span><span class="p">)]</span>
<span class="w">   </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="nv">allbad</span><span class="p">)</span><span class="w"> </span><span class="nv">bvars</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="nf">do</span>
<span class="w">         </span><span class="p">(</span><span class="nf">remove-values</span><span class="w"> </span><span class="nv">bvars</span><span class="w"> </span><span class="nv">allbad</span><span class="p">)))))</span>

<span class="w">   </span><span class="p">(</span><span class="kd">defn </span><span class="nv">relative</span>
<span class="w">      </span><span class="s">"(position vname1) - (position vname2) = diff"</span><span class="w">  </span>
<span class="w">      </span><span class="p">[</span><span class="nv">vname1</span><span class="w"> </span><span class="nv">vname2</span><span class="w"> </span><span class="nv">diff</span><span class="p">]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">v1</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname1</span><span class="p">)</span><span class="w"> </span><span class="nv">v2</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname2</span><span class="p">)</span>
<span class="w">       </span><span class="nv">bad1</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">j1</span><span class="w"> </span><span class="nv">v1</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">not</span><span class="w"> </span><span class="p">(</span><span class="nf">v2</span><span class="w"> </span><span class="p">(</span><span class="nf">-</span><span class="w"> </span><span class="nv">j1</span><span class="w"> </span><span class="nv">diff</span><span class="p">)))]</span><span class="w"> </span><span class="p">[</span><span class="nv">vname1</span><span class="w"> </span><span class="nv">j1</span><span class="p">])</span>
<span class="w">         </span><span class="nv">bad2</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">j2</span><span class="w"> </span><span class="nv">v2</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">not</span><span class="w"> </span><span class="p">(</span><span class="nf">v1</span><span class="w"> </span><span class="p">(</span><span class="nf">+</span><span class="w"> </span><span class="nv">j2</span><span class="w"> </span><span class="nv">diff</span><span class="p">)))]</span><span class="w"> </span><span class="p">[</span><span class="nv">vname2</span><span class="w"> </span><span class="nv">j2</span><span class="p">])</span>
<span class="w">         </span><span class="nv">allbad</span><span class="w"> </span><span class="p">(</span><span class="nf">concat</span><span class="w"> </span><span class="nv">bad1</span><span class="w"> </span><span class="nv">bad2</span><span class="p">)]</span>
<span class="w">   </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="nv">allbad</span><span class="p">)</span><span class="w"> </span><span class="nv">bvars</span>
<span class="w">      </span><span class="p">(</span><span class="nf">do</span>
<span class="w">         </span><span class="p">(</span><span class="nf">remove-values</span><span class="w"> </span><span class="nv">bvars</span><span class="w"> </span><span class="nv">allbad</span><span class="p">)))))</span>

<span class="w">   </span><span class="p">(</span><span class="kd">defn </span><span class="nv">alldiff</span>
<span class="w">      </span><span class="s">"If one variable of a category has only one location, no other variable in that category has it."</span>
<span class="w">      </span><span class="p">[]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">update</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nv">concat</span>
<span class="w">   </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">c</span><span class="w"> </span><span class="nv">categories</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="p">(</span><span class="nf">val</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="p">(</span><span class="nf">count</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="ss">:let</span><span class="w"> </span><span class="p">[</span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">v</span><span class="p">))]]</span>
<span class="w">      </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">s</span><span class="w"> </span><span class="p">(</span><span class="nf">siblings</span><span class="w"> </span><span class="nv">v</span><span class="p">)]</span>
<span class="w">         </span><span class="p">[</span><span class="nv">s</span><span class="w"> </span><span class="nv">x</span><span class="p">])))]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">remove-values</span><span class="w"> </span><span class="nv">bvars</span><span class="w"> </span><span class="nv">update</span><span class="p">)))</span>

<span class="w">   </span><span class="p">(</span><span class="kd">defn </span><span class="nv">solitary</span>
<span class="w">      </span><span class="s">"If only one variable of a category has a location, then that variable has no other locations."</span>
<span class="w">      </span><span class="p">[]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">loners</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nv">concat</span>
<span class="w">   </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">c</span><span class="w"> </span><span class="nv">categories</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="p">(</span><span class="nf">val</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">and</span><span class="w"> </span>
<span class="w">         </span><span class="p">((</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nf">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">count</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nf">not-any?</span><span class="w"> </span><span class="o">#</span><span class="p">((</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">%</span><span class="p">)</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">siblings</span><span class="w"> </span><span class="nv">v</span><span class="p">)))]</span>
<span class="w">      </span><span class="p">[</span><span class="nv">v</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="nv">p</span><span class="p">}]))]</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="nv">loners</span><span class="p">)</span><span class="w"> </span><span class="nv">bvars</span>
<span class="w">   </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="c1">; (prn "loners:" loners)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="k">assoc </span><span class="nv">bvars</span><span class="w"> </span><span class="nv">loners</span><span class="p">)))))</span>

<span class="c1">;========== Solving "engine" ==========</span>

<span class="p">(</span><span class="nb">open</span><span class="p">)</span>

<span class="p">(</span><span class="nf">dump-vars</span><span class="w"> </span><span class="nv">initial-vars</span><span class="w"> </span><span class="s">"Initial vars"</span><span class="p">)</span>

<span class="p">(</span><span class="nf">dump-vars</span><span class="w"> </span><span class="nv">after-unary</span><span class="w"> </span><span class="s">"After unary"</span><span class="p">)</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">rules-list</span><span class="w"> </span><span class="p">(</span><span class="nf">concat</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">'</span><span class="p">(</span><span class="nf">alldiff</span><span class="p">))</span><span class="w"> </span><span class="nv">binary-constraints</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">'</span><span class="p">(</span><span class="nf">solitary</span><span class="p">))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">apply-rule</span>
<span class="w">   </span><span class="s">"Applies the rule to the domain space and checks the result."</span><span class="w"> </span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="w"> </span><span class="nv">rule</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">cond</span>
<span class="w">      </span><span class="p">(</span><span class="nf">nil?</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="nv">nil</span>
<span class="w">      </span><span class="p">(</span><span class="nf">contradictory?</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="nv">nil</span>
<span class="w">      </span><span class="ss">:else</span><span class="w"> </span>
<span class="w">   </span><span class="p">(</span><span class="nf">binding</span><span class="w"> </span><span class="p">[</span><span class="nv">bvars</span><span class="w"> </span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-vars</span><span class="w"> </span><span class="p">(</span><span class="nb">eval</span><span class="w"> </span><span class="nv">rule</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">cond</span>
<span class="w">         </span><span class="p">(</span><span class="nf">contradictory</span><span class="w"> </span><span class="nv">new-vars</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">do </span>
<span class="w">      </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"contradiction after rule:"</span><span class="w"> </span><span class="nv">rule</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="nv">nil</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="nv">new-vars</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="nb">vars</span><span class="w">  </span><span class="c1">; no change</span>
<span class="w">         </span><span class="ss">:else</span><span class="w"> </span><span class="p">(</span><span class="k">do </span>
<span class="w">      </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"applied:"</span><span class="w"> </span><span class="nv">rule</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"p"</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="s">"applied: "</span><span class="w"> </span><span class="p">(</span><span class="nf">pr-str</span><span class="w"> </span><span class="nv">rule</span><span class="p">)))</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"result: "</span><span class="w"> </span><span class="nv">new-vars</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="nv">new-vars</span><span class="p">))))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">apply-rules</span><span class="w"> </span>
<span class="w">   </span><span class="s">"Uses 'reduce' to sequentially apply all the rules from 'rules-list' to 'vars'."</span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">reduce</span><span class="w"> </span><span class="nv">apply-rule</span><span class="w"> </span><span class="nb">vars</span><span class="w"> </span><span class="nv">rules-list</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">infer</span>
<span class="w">   </span><span class="s">"Repeatedly applies all rules until the var domains no longer change."</span><span class="w"> </span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="p">[</span><span class="nb">vars</span><span class="w"> </span><span class="nb">vars</span><span class="p">]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-vars</span><span class="p">(</span><span class="nf">apply-rules</span><span class="w"> </span><span class="nb">vars</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="nv">new-vars</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">do </span>
<span class="w">         </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"no change"</span><span class="p">)</span>
<span class="w">         </span><span class="nb">vars</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">recur</span><span class="w"> </span><span class="nv">new-vars</span><span class="p">))))))</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">after-inference</span><span class="w"> </span><span class="p">(</span><span class="nf">infer</span><span class="w"> </span><span class="nv">after-unary</span><span class="p">))</span>

<span class="p">(</span><span class="nf">dump-vars</span><span class="w"> </span><span class="nv">after-inference</span><span class="w"> </span><span class="s">"Inferred"</span><span class="p">)</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"solved?"</span><span class="w"> </span><span class="p">(</span><span class="nf">solved?</span><span class="w"> </span><span class="nv">after-inference</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">backtrack</span>
<span class="w">   </span><span class="s">"solve by backtracking."</span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">cond</span>
<span class="w">      </span><span class="p">(</span><span class="nf">nil?</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="nv">nil</span>
<span class="w">      </span><span class="p">(</span><span class="nf">solved?</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="nb">vars</span>
<span class="w">      </span><span class="ss">:else</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">fmc</span><span class="w"> </span><span class="p">(</span><span class="nf">first-most-constrained</span><span class="w"> </span><span class="nb">vars</span><span class="p">)]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="p">[</span><span class="nv">hypotheses</span><span class="w"> </span><span class="p">(</span><span class="nf">seq</span><span class="w"> </span><span class="p">(</span><span class="nb">vars</span><span class="w"> </span><span class="nv">fmc</span><span class="p">))]</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="nv">hypotheses</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">do</span>
<span class="w">         </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"dead end."</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"p"</span><span class="w"> </span><span class="s">"dead end."</span><span class="p">)</span>
<span class="w">         </span><span class="nv">nil</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">hyp</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="nv">hypotheses</span><span class="p">)</span><span class="w"> </span><span class="nv">hyp-vars</span><span class="w"> </span><span class="p">(</span><span class="k">assoc </span><span class="nb">vars</span><span class="w"> </span><span class="nv">fmc</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="nv">hyp</span><span class="p">})]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"hypothesis:"</span><span class="w"> </span><span class="nv">fmc</span><span class="w"> </span><span class="nv">hyp</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"p"</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="s">"hypothesis: "</span><span class="w"> </span><span class="nv">hyp</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">dump-vars</span><span class="w"> </span><span class="nv">hyp-vars</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="s">"Hypothesis: "</span><span class="w"> </span><span class="nv">fmc</span><span class="w"> </span><span class="s">" = "</span><span class="w"> </span><span class="nv">hyp</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">bt</span><span class="w"> </span><span class="p">(</span><span class="nf">backtrack</span><span class="w"> </span><span class="p">(</span><span class="nf">infer</span><span class="w"> </span><span class="nv">hyp-vars</span><span class="p">))]</span>
<span class="w">         </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">bt</span><span class="w"> </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"success!"</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nf">dump-vars</span><span class="w"> </span><span class="nv">bt</span><span class="w"> </span><span class="s">"Solved"</span><span class="p">)</span>
<span class="w">         </span><span class="nv">bt</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">recur</span><span class="w"> </span><span class="p">(</span><span class="k">rest </span><span class="nv">hypotheses</span><span class="p">))))))))))</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"first-most-constrained:"</span><span class="w"> </span><span class="p">(</span><span class="nf">first-most-constrained</span><span class="w"> </span><span class="nv">after-inference</span><span class="p">))</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">solution</span><span class="w"> </span><span class="p">(</span><span class="nf">backtrack</span><span class="w"> </span><span class="nv">after-inference</span><span class="p">))</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"solution:"</span><span class="w"> </span><span class="nv">solution</span><span class="p">)</span>

<span class="p">(</span><span class="nf">close</span><span class="p">)</span>

<span class="p">(</span><span class="nf">println</span><span class="w"> </span><span class="s">"houses loaded."</span><span class="p">)</span>
</pre></div>

<p>This is 292 lines, but there's a lot of debug/diagnostic coding in there. In
all, I'm pretty happy to have managed a reasonably short solution in Clojure.
Functional programming made for a bit of a challenge but I managed to maintain
a pretty consistent functional style.</p>
<p><strong>Criticism welcome</strong> though!</p>
<hr>
<p>For anyone who cares, here's the solution:</p>
<div class="code"><pre class="code literal-block">house       1       2               3       4             5
country     norway  ukraine         england spain         japan
color       yellow  blue            red     ivory         green
pet         fox     horse           snails  dog           zebra
smoke       kool    chesterfield    winston lucky         parliament
drink       water   tea             milk    orange-juice  coffee
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>Thanks to everyone for some helpful information!</p>
<p>The hint I really needed came to me in a traffic jam. Rather than assigning
nationalities, pets etc. to houses (variables named <code>country1</code>, <code>country2</code>,
<code>pet1</code>, <code>pet2</code>), what I needed to do was assign houses to the elements of the
domain! Example:</p>
<div class="code"><pre class="code literal-block"><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="n">norway</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="n">unary</span><span class="w"> </span><span class="n">constraint</span><span class="p">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">Norwegian</span><span class="w"> </span><span class="n">lives</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">1</span><span class="n">st</span><span class="w"> </span><span class="n">house</span>
<span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">britain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dog</span><span class="w">     </span><span class="p">;</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="n">constraint</span><span class="p">:</span><span class="w"> </span><span class="n">Dog</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">house</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Brit</span>
<span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="n">green</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ivory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">relative</span><span class="w"> </span><span class="n">positions</span>
</pre></div>

<p>This allowed me to find simple formulations for my constraints, like this:</p>
<div class="code"><pre class="code literal-block"><span class="p">(</span><span class="n">def</span><span class="w"> </span><span class="n">constraints</span>
<span class="w">  </span><span class="c1">#{</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">england</span><span class="w"> </span><span class="p">:</span><span class="n">red</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">spain</span><span class="w"> </span><span class="p">:</span><span class="n">dog</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="nb">abs</span><span class="o">-</span><span class="n">pos</span><span class="w"> </span><span class="p">:</span><span class="n">norway</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">kools</span><span class="w"> </span><span class="p">:</span><span class="n">yellow</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">next</span><span class="o">-</span><span class="n">to</span><span class="w"> </span><span class="p">:</span><span class="n">chesterfields</span><span class="w"> </span><span class="p">:</span><span class="n">fox</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">next</span><span class="o">-</span><span class="n">to</span><span class="w"> </span><span class="p">:</span><span class="n">norway</span><span class="w"> </span><span class="p">:</span><span class="n">blue</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">winston</span><span class="w"> </span><span class="p">:</span><span class="n">snails</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">lucky</span><span class="w"> </span><span class="p">:</span><span class="n">oj</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">ukraine</span><span class="w"> </span><span class="p">:</span><span class="n">tea</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">japan</span><span class="w"> </span><span class="p">:</span><span class="n">parliaments</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">next</span><span class="o">-</span><span class="n">to</span><span class="w"> </span><span class="p">:</span><span class="n">kools</span><span class="w"> </span><span class="p">:</span><span class="n">horse</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">con</span><span class="o">-</span><span class="n">eq</span><span class="w"> </span><span class="p">:</span><span class="n">coffee</span><span class="w"> </span><span class="p">:</span><span class="n">green</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="n">right</span><span class="o">-</span><span class="n">of</span><span class="w"> </span><span class="p">:</span><span class="n">green</span><span class="w"> </span><span class="p">:</span><span class="n">ivory</span><span class="p">]</span>
<span class="w">   </span><span class="p">[:</span><span class="nb">abs</span><span class="o">-</span><span class="n">pos</span><span class="w"> </span><span class="p">:</span><span class="n">milk</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">   </span><span class="p">})</span>
</pre></div>

<p>I'm not done yet (puttering at this only part time) but I will post a complete
solution once I work it out.</p>
<hr>
<p><strong>Update:</strong> About 2 weeks later, I've come up with a working solution in
Clojure:</p>
<div class="code"><pre class="code literal-block"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="nv">houses</span>
<span class="w">  </span><span class="p">[</span><span class="ss">:use</span><span class="w"> </span><span class="p">[</span><span class="nv">htmllog</span><span class="p">]</span><span class="w"> </span><span class="nv">clojure.set</span><span class="p">]</span><span class="w">  </span>
<span class="w">  </span><span class="p">)</span>

<span class="p">(</span><span class="nf">comment</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Englishman</span><span class="w"> </span><span class="nv">lives</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">red</span><span class="w"> </span><span class="nv">house.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Spaniard</span><span class="w"> </span><span class="nv">owns</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">dog.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Norwegian</span><span class="w"> </span><span class="nv">lives</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">ﬁrst</span><span class="w"> </span><span class="nv">house</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">left.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="nv">Kools</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">smoked</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">yellow</span><span class="w"> </span><span class="nv">house.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">man</span><span class="w"> </span><span class="nv">who</span><span class="w"> </span><span class="nv">smokes</span><span class="w"> </span><span class="nv">Chesterﬁelds</span><span class="w"> </span><span class="nv">lives</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">house</span><span class="w"> </span><span class="nb">next</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">man</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">fox.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Norwegian</span><span class="w"> </span><span class="nv">lives</span><span class="w"> </span><span class="nb">next</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">blue</span><span class="w"> </span><span class="nv">house.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Winston</span><span class="w"> </span><span class="nv">smoker</span><span class="w"> </span><span class="nv">owns</span><span class="w"> </span><span class="nv">snails.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Lucky</span><span class="w"> </span><span class="nv">Strike</span><span class="w"> </span><span class="nv">smoker</span><span class="w"> </span><span class="nv">drinks</span><span class="w"> </span><span class="nv">orange</span><span class="w"> </span><span class="nv">juice.</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mi">9</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Ukrainian</span><span class="w"> </span><span class="nv">drinks</span><span class="w"> </span><span class="nv">tea.</span>
<span class="w">  </span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Japanese</span><span class="w"> </span><span class="nv">smokes</span><span class="w"> </span><span class="nv">Parliaments.</span>
<span class="w">  </span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="nv">Kools</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">smoked</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">house</span><span class="w"> </span><span class="nb">next</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">house</span><span class="w"> </span><span class="nv">where</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">horse</span><span class="w"> </span><span class="k">is </span><span class="nv">kept.</span>
<span class="w">  </span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="nv">Coffee</span><span class="w"> </span><span class="k">is </span><span class="nv">drunk</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">green</span><span class="w"> </span><span class="nv">house.</span>
<span class="w">  </span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">Green</span><span class="w"> </span><span class="nv">house</span><span class="w"> </span><span class="k">is </span><span class="nv">immediately</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">right</span><span class="w"> </span><span class="p">(</span><span class="nf">your</span><span class="w"> </span><span class="nv">right</span><span class="p">)</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">ivory</span><span class="w"> </span><span class="nv">house.</span>
<span class="w">  </span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="w"> </span><span class="nv">Milk</span><span class="w"> </span><span class="k">is </span><span class="nv">drunk</span><span class="w"> </span><span class="k">in </span><span class="nv">the</span><span class="w"> </span><span class="nv">middle</span><span class="w"> </span><span class="nv">house.</span>

<span class="w">  </span><span class="err">“</span><span class="nv">Where</span><span class="w"> </span><span class="nv">does</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">zebra</span><span class="w"> </span><span class="nv">live</span>,<span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="k">in </span><span class="nv">which</span><span class="w"> </span><span class="nv">house</span><span class="w"> </span><span class="k">do </span><span class="nv">they</span><span class="w"> </span><span class="nv">drink</span><span class="w"> </span><span class="nv">water?</span><span class="err">”</span>
<span class="p">)</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">positions</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="p">})</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">categories</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="ss">:country</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="ss">:england</span><span class="w"> </span><span class="ss">:spain</span><span class="w"> </span><span class="ss">:norway</span><span class="w"> </span><span class="ss">:ukraine</span><span class="w"> </span><span class="ss">:japan</span><span class="p">}</span>
<span class="w">          </span><span class="ss">:color</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="ss">:red</span><span class="w"> </span><span class="ss">:yellow</span><span class="w"> </span><span class="ss">:blue</span><span class="w"> </span><span class="ss">:green</span><span class="w"> </span><span class="ss">:ivory</span><span class="p">}</span>
<span class="w">          </span><span class="ss">:pet</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="ss">:dog</span><span class="w"> </span><span class="ss">:fox</span><span class="w"> </span><span class="ss">:snails</span><span class="w"> </span><span class="ss">:horse</span><span class="w"> </span><span class="ss">:zebra</span><span class="p">}</span>
<span class="w">          </span><span class="ss">:smoke</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="ss">:chesterfield</span><span class="w"> </span><span class="ss">:winston</span><span class="w"> </span><span class="ss">:lucky</span><span class="w"> </span><span class="ss">:parliament</span><span class="w"> </span><span class="ss">:kool</span><span class="p">}</span>
<span class="w">          </span><span class="ss">:drink</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="ss">:orange-juice</span><span class="w"> </span><span class="ss">:tea</span><span class="w"> </span><span class="ss">:coffee</span><span class="w"> </span><span class="ss">:milk</span><span class="w"> </span><span class="ss">:water</span><span class="p">}</span>
<span class="p">})</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">constraints</span><span class="w"> </span><span class="o">#</span><span class="p">{</span>
<span class="w">                    </span><span class="c1">; -- unary</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">at</span><span class="w"> </span><span class="ss">:norway</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">; 3</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">at</span><span class="w"> </span><span class="ss">:milk</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="c1">; 14</span>
<span class="w">                    </span><span class="c1">; -- simple binary</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:england</span><span class="w"> </span><span class="ss">:red</span><span class="p">)</span><span class="w"> </span><span class="c1">; 1</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:spain</span><span class="w"> </span><span class="ss">:dog</span><span class="p">)</span><span class="w"> </span><span class="c1">; 2</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:kool</span><span class="w"> </span><span class="ss">:yellow</span><span class="p">)</span><span class="w"> </span><span class="c1">; 4</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:winston</span><span class="w"> </span><span class="ss">:snails</span><span class="p">)</span><span class="w"> </span><span class="c1">; 7</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:lucky</span><span class="w"> </span><span class="ss">:orange-juice</span><span class="p">)</span><span class="w"> </span><span class="c1">; 8</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:ukraine</span><span class="w"> </span><span class="ss">:tea</span><span class="p">)</span><span class="w"> </span><span class="c1">; 9</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:japan</span><span class="w"> </span><span class="ss">:parliament</span><span class="p">)</span><span class="w"> </span><span class="c1">; 10</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">coloc</span><span class="w"> </span><span class="ss">:coffee</span><span class="w"> </span><span class="ss">:green</span><span class="p">)</span><span class="w"> </span><span class="c1">; 12</span>
<span class="w">                    </span><span class="c1">; -- interesting binary</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nb">next</span><span class="nv">-to</span><span class="w"> </span><span class="ss">:chesterfield</span><span class="w"> </span><span class="ss">:fox</span><span class="p">)</span><span class="w"> </span><span class="c1">; 5</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nb">next</span><span class="nv">-to</span><span class="w"> </span><span class="ss">:norway</span><span class="w"> </span><span class="ss">:blue</span><span class="p">)</span><span class="w"> </span><span class="c1">; 6</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nb">next</span><span class="nv">-to</span><span class="w"> </span><span class="ss">:kool</span><span class="w"> </span><span class="ss">:horse</span><span class="p">)</span><span class="w"> </span><span class="c1">; 11</span>
<span class="w">          </span><span class="o">'</span><span class="p">(</span><span class="nf">relative</span><span class="w"> </span><span class="ss">:green</span><span class="w"> </span><span class="ss">:ivory</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">; 13</span>
<span class="p">})</span>

<span class="c1">; ========== Setup ==========</span>

<span class="p">(</span><span class="nf">doseq</span><span class="w"> </span><span class="p">[</span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">3</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="nf">println</span><span class="p">))</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">var-cat</span><span class="w">    </span><span class="c1">; map of variable -&gt; group </span>
<span class="w">      </span><span class="c1">; {:kool :smoke, :water :drink, :ivory :color, ... </span>
<span class="w">    </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nb">hash</span><span class="nv">-map</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nv">concat</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">cat</span><span class="w"> </span><span class="nv">categories</span><span class="w"> </span><span class="nv">vari</span><span class="w"> </span><span class="p">(</span><span class="nf">second</span><span class="w"> </span><span class="nv">cat</span><span class="p">)]</span><span class="w"> </span>
<span class="w">      </span><span class="p">[</span><span class="nv">vari</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="nv">cat</span><span class="p">)]))))</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"var-cat:"</span><span class="w"> </span><span class="nv">var-cat</span><span class="p">)</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">initial-vars</span><span class="w">    </span><span class="c1">; map of variable -&gt; positions</span>
<span class="w">      </span><span class="c1">; {:kool #{1 2 3 4 5}, :water #{1 2 3 4 5}, :ivory #{1 2 3 4 5}, ...</span>
<span class="w">    </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nb">hash</span><span class="nv">-map</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nv">concat</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">v</span><span class="w"> </span><span class="p">(</span><span class="nf">keys</span><span class="w"> </span><span class="nv">var-cat</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="nv">v</span><span class="w"> </span><span class="nv">positions</span><span class="p">]))))</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"initial-vars:"</span><span class="w"> </span><span class="nv">initial-vars</span><span class="p">)</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">apply-unary-constraints</span>
<span class="w">   </span><span class="s">"This applies the 'at' constraint. Separately, because it only needs doing once."</span><span class="w"> </span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">update</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nv">concat</span>
<span class="w">      </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">c</span><span class="w"> </span><span class="nv">constraints</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span><span class="ss">'at</span><span class="p">)</span><span class="w"> </span><span class="ss">:let</span><span class="w"> </span><span class="p">[[</span><span class="nv">v</span><span class="w"> </span><span class="nv">d</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="k">rest </span><span class="nv">c</span><span class="p">)]]</span>
<span class="w">   </span><span class="p">[</span><span class="nv">v</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="nv">d</span><span class="p">}]))]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="k">assoc </span><span class="nb">vars</span><span class="w"> </span><span class="nv">update</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">after-unary</span><span class="w"> </span><span class="p">(</span><span class="nf">apply-unary-constraints</span><span class="w"> </span><span class="nv">initial-vars</span><span class="p">))</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"after-unary:"</span><span class="w"> </span><span class="nv">after-unary</span><span class="p">)</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">binary-constraints</span><span class="w"> </span><span class="p">(</span><span class="nb">remove </span><span class="o">#</span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="ss">'at</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="nv">%</span><span class="p">))</span><span class="w"> </span><span class="nv">constraints</span><span class="p">))</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"binary-constraints:"</span><span class="w"> </span><span class="nv">binary-constraints</span><span class="p">)</span>

<span class="c1">; ========== Utilities ==========</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">dump-vars</span>
<span class="w">   </span><span class="s">"Dump map `vars` as a HTML table in the log, with `title`."</span><span class="w"> </span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="w"> </span><span class="nv">title</span><span class="p">]</span>
<span class="w">  </span><span class="p">(</span><span class="nf">letfn</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">(</span><span class="nb">vars</span><span class="nv">-for-cat-pos</span><span class="w"> </span><span class="p">[</span><span class="nb">vars</span><span class="w"> </span><span class="nv">var-list</span><span class="w"> </span><span class="nv">pos</span><span class="p">]</span>
<span class="w">          </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nb">str</span><span class="w"> </span><span class="p">(</span><span class="nf">interpose</span><span class="w"> </span><span class="s">"&lt;br/&gt;"</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">((</span><span class="nb">vars</span><span class="w"> </span><span class="nv">%</span><span class="p">)</span><span class="w"> </span><span class="nv">pos</span><span class="p">)</span><span class="w"> </span><span class="nv">var-list</span><span class="p">)))))]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"h2"</span><span class="w"> </span><span class="nv">title</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">log</span><span class="w"> </span><span class="s">"&lt;table border='1'&gt;"</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">log</span><span class="w"> </span><span class="s">"&lt;tr&gt;"</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">doall</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"th"</span><span class="w"> </span><span class="nv">%</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">cons</span><span class="w"> </span><span class="s">"house"</span><span class="w"> </span><span class="nv">positions</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">log</span><span class="w"> </span><span class="s">"&lt;/tr&gt;"</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">doseq</span><span class="w"> </span><span class="p">[</span><span class="nv">cat</span><span class="w"> </span><span class="nv">categories</span><span class="p">]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">log</span><span class="w"> </span><span class="s">"&lt;tr&gt;"</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"th"</span><span class="w"> </span><span class="p">(</span><span class="nf">name</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="nv">cat</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nf">doseq</span><span class="w"> </span><span class="p">[</span><span class="nv">pos</span><span class="w"> </span><span class="nv">positions</span><span class="p">]</span>
<span class="w">          </span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"td"</span><span class="w"> </span><span class="p">(</span><span class="nb">vars</span><span class="nv">-for-cat-pos</span><span class="w"> </span><span class="nb">vars</span><span class="w"> </span><span class="p">(</span><span class="nf">second</span><span class="w"> </span><span class="nv">cat</span><span class="p">)</span><span class="w"> </span><span class="nv">pos</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">log</span><span class="w"> </span><span class="s">"&lt;/tr&gt;"</span><span class="p">)</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">log</span><span class="w"> </span><span class="s">"&lt;/table&gt;"</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">remove-values</span>
<span class="w">   </span><span class="s">"Given a list of key/value pairs, remove the values from the vars named by key."</span><span class="w"> </span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="w"> </span><span class="nv">kvs</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">names</span><span class="w"> </span><span class="p">(</span><span class="nb">distinct </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="k">first </span><span class="nv">kvs</span><span class="p">))</span>
<span class="w">      </span><span class="nv">delta</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">n</span><span class="w"> </span><span class="nv">names</span><span class="p">]</span>
<span class="w">      </span><span class="p">[</span><span class="nv">n</span><span class="w"> </span><span class="p">(</span><span class="nb">set</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="nv">second</span><span class="w"> </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="nv">%</span><span class="p">))</span><span class="w"> </span><span class="nv">kvs</span><span class="p">)))])</span>
<span class="w">      </span><span class="nv">update</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">kv</span><span class="w"> </span><span class="nv">delta</span>
<span class="w">         </span><span class="ss">:let</span><span class="w"> </span><span class="p">[[</span><span class="nv">cname</span><span class="w"> </span><span class="nv">negative</span><span class="p">]</span><span class="w"> </span><span class="nv">kv</span><span class="p">]]</span>
<span class="w">      </span><span class="p">[</span><span class="nv">cname</span><span class="w"> </span><span class="p">(</span><span class="nf">difference</span><span class="w"> </span><span class="p">(</span><span class="nb">vars</span><span class="w"> </span><span class="nv">cname</span><span class="p">)</span><span class="w"> </span><span class="nv">negative</span><span class="p">)])]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nb">vars</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="k">assoc </span><span class="nb">vars</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nv">concat</span><span class="w"> </span><span class="nv">update</span><span class="p">))]</span>
<span class="w">   </span><span class="nb">vars</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">siblings</span>
<span class="w">   </span><span class="s">"Given a variable name, return a list of the names of variables in the same category."</span>
<span class="w">   </span><span class="p">[</span><span class="nv">vname</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">disj</span><span class="w"> </span><span class="p">(</span><span class="nf">categories</span><span class="w"> </span><span class="p">(</span><span class="nf">var-cat</span><span class="w"> </span><span class="nv">vname</span><span class="p">))</span><span class="w"> </span><span class="nv">vname</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">contradictory?</span>
<span class="w">   </span><span class="s">"Checks for a contradiction in vars, indicated by one variable having an empty domain."</span><span class="w"> </span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">some</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="p">(</span><span class="nb">vars</span><span class="w"> </span><span class="nv">%</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">keys</span><span class="w"> </span><span class="nb">vars</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">solved?</span>
<span class="w">   </span><span class="s">"Checks if all variables in 'vars' have a single-value domain."</span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">every?</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nf">count</span><span class="w"> </span><span class="p">(</span><span class="nb">vars</span><span class="w"> </span><span class="nv">%</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nf">keys</span><span class="w"> </span><span class="nb">vars</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">first-most-constrained</span>
<span class="w">   </span><span class="s">"Finds a variable having the smallest domain size &gt; 1."</span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">best-pair</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="p">(</span><span class="nf">sort</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">v</span><span class="w"> </span><span class="p">(</span><span class="nf">keys</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="ss">:let</span><span class="w"> </span><span class="p">[</span><span class="nv">n</span><span class="w"> </span><span class="p">(</span><span class="nf">count</span><span class="w"> </span><span class="p">(</span><span class="nb">vars</span><span class="w"> </span><span class="nv">v</span><span class="p">))]</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">&gt;</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="mi">1</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="nv">n</span><span class="w"> </span><span class="nv">v</span><span class="p">])))]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"best-pair:"</span><span class="w"> </span><span class="nv">best-pair</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">second</span><span class="w"> </span><span class="nv">best-pair</span><span class="p">)))</span>

<span class="c1">;========== Constraint functions ==========</span>

<span class="w">   </span><span class="p">(</span><span class="nf">comment</span>
<span class="w">      </span><span class="nv">These</span><span class="w"> </span><span class="nv">functions</span><span class="w"> </span><span class="nv">make</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">assertion</span><span class="w"> </span><span class="nv">about</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">domains</span><span class="w"> </span><span class="k">in </span><span class="nb">map</span><span class="w"> </span><span class="ss">'bvars</span><span class="o">'</span>,<span class="w"> </span>
<span class="w">      </span><span class="nv">and</span><span class="w"> </span><span class="nb">remove any</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">which</span><span class="w"> </span><span class="nv">those</span><span class="w"> </span><span class="nv">assertions</span><span class="w"> </span><span class="k">do </span><span class="nv">not</span><span class="w"> </span><span class="nv">hold.</span><span class="w"> </span>
<span class="w">      </span><span class="nv">They</span><span class="w"> </span><span class="nb">all</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="p">(</span><span class="nf">hopefully</span><span class="w"> </span><span class="nv">modified</span><span class="p">)</span><span class="w"> </span><span class="nv">domain</span><span class="w"> </span><span class="nv">space</span><span class="w"> </span><span class="ss">'bvars'.</span><span class="p">)</span>

<span class="w">   </span><span class="p">(</span><span class="nf">declare</span><span class="w"> </span><span class="nv">bvars</span><span class="w"> </span><span class="nv">coloc</span><span class="w"> </span><span class="nb">next</span><span class="nv">-to</span><span class="w"> </span><span class="nv">relative</span><span class="w"> </span><span class="nv">alldiff</span><span class="w"> </span><span class="nv">solitary</span><span class="p">)</span>

<span class="w">   </span><span class="p">(</span><span class="kd">defn </span><span class="nv">coloc</span>
<span class="w">      </span><span class="s">"Two variables share the same location."</span><span class="w"> </span>
<span class="w">      </span><span class="p">[</span><span class="nv">vname1</span><span class="w"> </span><span class="nv">vname2</span><span class="p">]</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname2</span><span class="p">))</span><span class="w"> </span><span class="nv">bvars</span>
<span class="w">   </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">inter</span><span class="w"> </span><span class="p">(</span><span class="nf">intersection</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname2</span><span class="p">))]</span>
<span class="w">         </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="k">assoc </span><span class="nv">bvars</span><span class="w"> </span><span class="p">[</span><span class="nv">vname1</span><span class="w"> </span><span class="nv">inter</span><span class="w"> </span><span class="nv">vname2</span><span class="w"> </span><span class="nv">inter</span><span class="p">])))))</span>

<span class="w">   </span><span class="p">(</span><span class="kd">defn </span><span class="nb">next</span><span class="nv">-to</span><span class="w"> </span>
<span class="w">      </span><span class="s">"Two variables have adjoining positions"</span>
<span class="w">      </span><span class="p">[</span><span class="nv">vname1</span><span class="w"> </span><span class="nv">vname2</span><span class="p">]</span>
<span class="w">      </span><span class="c1">; (prn "doing next-to" vname1 vname2)</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">v1</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname1</span><span class="p">)</span><span class="w"> </span><span class="nv">v2</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname2</span><span class="p">)</span>
<span class="w">            </span><span class="nv">bad1</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">j1</span><span class="w"> </span><span class="nv">v1</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">not</span><span class="w"> </span><span class="p">(</span><span class="nf">or</span><span class="w"> </span><span class="p">(</span><span class="nf">v2</span><span class="w"> </span><span class="p">(</span><span class="nb">dec </span><span class="nv">j1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">v2</span><span class="w"> </span><span class="p">(</span><span class="nb">inc </span><span class="nv">j1</span><span class="p">))))]</span><span class="w"> </span><span class="p">[</span><span class="nv">vname1</span><span class="w"> </span><span class="nv">j1</span><span class="p">])</span>
<span class="w">        </span><span class="nv">bad2</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">j2</span><span class="w"> </span><span class="nv">v2</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">not</span><span class="w"> </span><span class="p">(</span><span class="nf">or</span><span class="w"> </span><span class="p">(</span><span class="nf">v1</span><span class="w"> </span><span class="p">(</span><span class="nb">dec </span><span class="nv">j2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">v1</span><span class="w"> </span><span class="p">(</span><span class="nb">inc </span><span class="nv">j2</span><span class="p">))))]</span><span class="w"> </span><span class="p">[</span><span class="nv">vname2</span><span class="w"> </span><span class="nv">j2</span><span class="p">])</span>
<span class="w">         </span><span class="nv">allbad</span><span class="w"> </span><span class="p">(</span><span class="nf">concat</span><span class="w"> </span><span class="nv">bad1</span><span class="w"> </span><span class="nv">bad2</span><span class="p">)]</span>
<span class="w">   </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="nv">allbad</span><span class="p">)</span><span class="w"> </span><span class="nv">bvars</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="nf">do</span>
<span class="w">         </span><span class="p">(</span><span class="nf">remove-values</span><span class="w"> </span><span class="nv">bvars</span><span class="w"> </span><span class="nv">allbad</span><span class="p">)))))</span>

<span class="w">   </span><span class="p">(</span><span class="kd">defn </span><span class="nv">relative</span>
<span class="w">      </span><span class="s">"(position vname1) - (position vname2) = diff"</span><span class="w">  </span>
<span class="w">      </span><span class="p">[</span><span class="nv">vname1</span><span class="w"> </span><span class="nv">vname2</span><span class="w"> </span><span class="nv">diff</span><span class="p">]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">v1</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname1</span><span class="p">)</span><span class="w"> </span><span class="nv">v2</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">vname2</span><span class="p">)</span>
<span class="w">       </span><span class="nv">bad1</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">j1</span><span class="w"> </span><span class="nv">v1</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">not</span><span class="w"> </span><span class="p">(</span><span class="nf">v2</span><span class="w"> </span><span class="p">(</span><span class="nf">-</span><span class="w"> </span><span class="nv">j1</span><span class="w"> </span><span class="nv">diff</span><span class="p">)))]</span><span class="w"> </span><span class="p">[</span><span class="nv">vname1</span><span class="w"> </span><span class="nv">j1</span><span class="p">])</span>
<span class="w">         </span><span class="nv">bad2</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">j2</span><span class="w"> </span><span class="nv">v2</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">not</span><span class="w"> </span><span class="p">(</span><span class="nf">v1</span><span class="w"> </span><span class="p">(</span><span class="nf">+</span><span class="w"> </span><span class="nv">j2</span><span class="w"> </span><span class="nv">diff</span><span class="p">)))]</span><span class="w"> </span><span class="p">[</span><span class="nv">vname2</span><span class="w"> </span><span class="nv">j2</span><span class="p">])</span>
<span class="w">         </span><span class="nv">allbad</span><span class="w"> </span><span class="p">(</span><span class="nf">concat</span><span class="w"> </span><span class="nv">bad1</span><span class="w"> </span><span class="nv">bad2</span><span class="p">)]</span>
<span class="w">   </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="nv">allbad</span><span class="p">)</span><span class="w"> </span><span class="nv">bvars</span>
<span class="w">      </span><span class="p">(</span><span class="nf">do</span>
<span class="w">         </span><span class="p">(</span><span class="nf">remove-values</span><span class="w"> </span><span class="nv">bvars</span><span class="w"> </span><span class="nv">allbad</span><span class="p">)))))</span>

<span class="w">   </span><span class="p">(</span><span class="kd">defn </span><span class="nv">alldiff</span>
<span class="w">      </span><span class="s">"If one variable of a category has only one location, no other variable in that category has it."</span>
<span class="w">      </span><span class="p">[]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">update</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nv">concat</span>
<span class="w">   </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">c</span><span class="w"> </span><span class="nv">categories</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="p">(</span><span class="nf">val</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="p">(</span><span class="nf">count</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="ss">:let</span><span class="w"> </span><span class="p">[</span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">v</span><span class="p">))]]</span>
<span class="w">      </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">s</span><span class="w"> </span><span class="p">(</span><span class="nf">siblings</span><span class="w"> </span><span class="nv">v</span><span class="p">)]</span>
<span class="w">         </span><span class="p">[</span><span class="nv">s</span><span class="w"> </span><span class="nv">x</span><span class="p">])))]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">remove-values</span><span class="w"> </span><span class="nv">bvars</span><span class="w"> </span><span class="nv">update</span><span class="p">)))</span>

<span class="w">   </span><span class="p">(</span><span class="kd">defn </span><span class="nv">solitary</span>
<span class="w">      </span><span class="s">"If only one variable of a category has a location, then that variable has no other locations."</span>
<span class="w">      </span><span class="p">[]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">loners</span><span class="w"> </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="nv">concat</span>
<span class="w">   </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="nv">c</span><span class="w"> </span><span class="nv">categories</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">positions</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="p">(</span><span class="nf">val</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="ss">:when</span><span class="w"> </span><span class="p">(</span><span class="nf">and</span><span class="w"> </span>
<span class="w">         </span><span class="p">((</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nf">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">count</span><span class="w"> </span><span class="p">(</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nf">not-any?</span><span class="w"> </span><span class="o">#</span><span class="p">((</span><span class="nf">bvars</span><span class="w"> </span><span class="nv">%</span><span class="p">)</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">siblings</span><span class="w"> </span><span class="nv">v</span><span class="p">)))]</span>
<span class="w">      </span><span class="p">[</span><span class="nv">v</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="nv">p</span><span class="p">}]))]</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="nv">loners</span><span class="p">)</span><span class="w"> </span><span class="nv">bvars</span>
<span class="w">   </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="c1">; (prn "loners:" loners)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">apply</span><span class="w"> </span><span class="k">assoc </span><span class="nv">bvars</span><span class="w"> </span><span class="nv">loners</span><span class="p">)))))</span>

<span class="c1">;========== Solving "engine" ==========</span>

<span class="p">(</span><span class="nb">open</span><span class="p">)</span>

<span class="p">(</span><span class="nf">dump-vars</span><span class="w"> </span><span class="nv">initial-vars</span><span class="w"> </span><span class="s">"Initial vars"</span><span class="p">)</span>

<span class="p">(</span><span class="nf">dump-vars</span><span class="w"> </span><span class="nv">after-unary</span><span class="w"> </span><span class="s">"After unary"</span><span class="p">)</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">rules-list</span><span class="w"> </span><span class="p">(</span><span class="nf">concat</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">'</span><span class="p">(</span><span class="nf">alldiff</span><span class="p">))</span><span class="w"> </span><span class="nv">binary-constraints</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">'</span><span class="p">(</span><span class="nf">solitary</span><span class="p">))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">apply-rule</span>
<span class="w">   </span><span class="s">"Applies the rule to the domain space and checks the result."</span><span class="w"> </span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="w"> </span><span class="nv">rule</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">cond</span>
<span class="w">      </span><span class="p">(</span><span class="nf">nil?</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="nv">nil</span>
<span class="w">      </span><span class="p">(</span><span class="nf">contradictory?</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="nv">nil</span>
<span class="w">      </span><span class="ss">:else</span><span class="w"> </span>
<span class="w">   </span><span class="p">(</span><span class="nf">binding</span><span class="w"> </span><span class="p">[</span><span class="nv">bvars</span><span class="w"> </span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-vars</span><span class="w"> </span><span class="p">(</span><span class="nb">eval</span><span class="w"> </span><span class="nv">rule</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">cond</span>
<span class="w">         </span><span class="p">(</span><span class="nf">contradictory</span><span class="w"> </span><span class="nv">new-vars</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">do </span>
<span class="w">      </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"contradiction after rule:"</span><span class="w"> </span><span class="nv">rule</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="nv">nil</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="nv">new-vars</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="nb">vars</span><span class="w">  </span><span class="c1">; no change</span>
<span class="w">         </span><span class="ss">:else</span><span class="w"> </span><span class="p">(</span><span class="k">do </span>
<span class="w">      </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"applied:"</span><span class="w"> </span><span class="nv">rule</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"p"</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="s">"applied: "</span><span class="w"> </span><span class="p">(</span><span class="nf">pr-str</span><span class="w"> </span><span class="nv">rule</span><span class="p">)))</span><span class="w"> </span>
<span class="w">      </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"result: "</span><span class="w"> </span><span class="nv">new-vars</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="nv">new-vars</span><span class="p">))))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">apply-rules</span><span class="w"> </span>
<span class="w">   </span><span class="s">"Uses 'reduce' to sequentially apply all the rules from 'rules-list' to 'vars'."</span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">reduce</span><span class="w"> </span><span class="nv">apply-rule</span><span class="w"> </span><span class="nb">vars</span><span class="w"> </span><span class="nv">rules-list</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">infer</span>
<span class="w">   </span><span class="s">"Repeatedly applies all rules until the var domains no longer change."</span><span class="w"> </span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="p">[</span><span class="nb">vars</span><span class="w"> </span><span class="nb">vars</span><span class="p">]</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-vars</span><span class="p">(</span><span class="nf">apply-rules</span><span class="w"> </span><span class="nb">vars</span><span class="p">)]</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="nv">new-vars</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">do </span>
<span class="w">         </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"no change"</span><span class="p">)</span>
<span class="w">         </span><span class="nb">vars</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">recur</span><span class="w"> </span><span class="nv">new-vars</span><span class="p">))))))</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">after-inference</span><span class="w"> </span><span class="p">(</span><span class="nf">infer</span><span class="w"> </span><span class="nv">after-unary</span><span class="p">))</span>

<span class="p">(</span><span class="nf">dump-vars</span><span class="w"> </span><span class="nv">after-inference</span><span class="w"> </span><span class="s">"Inferred"</span><span class="p">)</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"solved?"</span><span class="w"> </span><span class="p">(</span><span class="nf">solved?</span><span class="w"> </span><span class="nv">after-inference</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">backtrack</span>
<span class="w">   </span><span class="s">"solve by backtracking."</span>
<span class="w">   </span><span class="p">[</span><span class="nb">vars</span><span class="p">]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">cond</span>
<span class="w">      </span><span class="p">(</span><span class="nf">nil?</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="nv">nil</span>
<span class="w">      </span><span class="p">(</span><span class="nf">solved?</span><span class="w"> </span><span class="nb">vars</span><span class="p">)</span><span class="w"> </span><span class="nb">vars</span>
<span class="w">      </span><span class="ss">:else</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">fmc</span><span class="w"> </span><span class="p">(</span><span class="nf">first-most-constrained</span><span class="w"> </span><span class="nb">vars</span><span class="p">)]</span>
<span class="w">   </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="p">[</span><span class="nv">hypotheses</span><span class="w"> </span><span class="p">(</span><span class="nf">seq</span><span class="w"> </span><span class="p">(</span><span class="nb">vars</span><span class="w"> </span><span class="nv">fmc</span><span class="p">))]</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="nv">hypotheses</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">do</span>
<span class="w">         </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"dead end."</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"p"</span><span class="w"> </span><span class="s">"dead end."</span><span class="p">)</span>
<span class="w">         </span><span class="nv">nil</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">hyp</span><span class="w"> </span><span class="p">(</span><span class="k">first </span><span class="nv">hypotheses</span><span class="p">)</span><span class="w"> </span><span class="nv">hyp-vars</span><span class="w"> </span><span class="p">(</span><span class="k">assoc </span><span class="nb">vars</span><span class="w"> </span><span class="nv">fmc</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="nv">hyp</span><span class="p">})]</span>
<span class="w">      </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"hypothesis:"</span><span class="w"> </span><span class="nv">fmc</span><span class="w"> </span><span class="nv">hyp</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">log-tag</span><span class="w"> </span><span class="s">"p"</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="s">"hypothesis: "</span><span class="w"> </span><span class="nv">hyp</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">dump-vars</span><span class="w"> </span><span class="nv">hyp-vars</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="s">"Hypothesis: "</span><span class="w"> </span><span class="nv">fmc</span><span class="w"> </span><span class="s">" = "</span><span class="w"> </span><span class="nv">hyp</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">bt</span><span class="w"> </span><span class="p">(</span><span class="nf">backtrack</span><span class="w"> </span><span class="p">(</span><span class="nf">infer</span><span class="w"> </span><span class="nv">hyp-vars</span><span class="p">))]</span>
<span class="w">         </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">bt</span><span class="w"> </span><span class="p">(</span><span class="nf">do</span>
<span class="w">      </span><span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"success!"</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nf">dump-vars</span><span class="w"> </span><span class="nv">bt</span><span class="w"> </span><span class="s">"Solved"</span><span class="p">)</span>
<span class="w">         </span><span class="nv">bt</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">recur</span><span class="w"> </span><span class="p">(</span><span class="k">rest </span><span class="nv">hypotheses</span><span class="p">))))))))))</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"first-most-constrained:"</span><span class="w"> </span><span class="p">(</span><span class="nf">first-most-constrained</span><span class="w"> </span><span class="nv">after-inference</span><span class="p">))</span>

<span class="p">(</span><span class="kd">def </span><span class="nv">solution</span><span class="w"> </span><span class="p">(</span><span class="nf">backtrack</span><span class="w"> </span><span class="nv">after-inference</span><span class="p">))</span>

<span class="p">(</span><span class="nf">prn</span><span class="w"> </span><span class="s">"solution:"</span><span class="w"> </span><span class="nv">solution</span><span class="p">)</span>

<span class="p">(</span><span class="nf">close</span><span class="p">)</span>

<span class="p">(</span><span class="nf">println</span><span class="w"> </span><span class="s">"houses loaded."</span><span class="p">)</span>
</pre></div>

<p>This is 292 lines, but there's a lot of debug/diagnostic coding in there. In
all, I'm pretty happy to have managed a reasonably short solution in Clojure.
Functional programming made for a bit of a challenge but I managed to maintain
a pretty consistent functional style.</p>
<p><strong>Criticism welcome</strong> though!</p>
<hr>
<p>For anyone who cares, here's the solution:</p>
<div class="code"><pre class="code literal-block">house       1       2               3       4             5
country     norway  ukraine         england spain         japan
color       yellow  blue            red     ivory         green
pet         fox     horse           snails  dog           zebra
smoke       kool    chesterfield    winston lucky         parliament
drink       water   tea             milk    orange-juice  coffee
</pre></div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/artificial-intelligence/" rel="tag">artificial-intelligence</a></li>
            <li><a class="tag p-category" href="../../categories/constraints/" rel="tag">constraints</a></li>
            <li><a class="tag p-category" href="../../categories/modeling/" rel="tag">modeling</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../is-the-bias-node-necessary-in-very-large-neural-networks/" rel="prev" title="Is the bias node necessary in very large neural networks?">Previous post</a>
            </li>
            <li class="next">
                <a href="../why-does-a-path-finding-sometimes-go-in-straight-lines-and-sometimes-diagonals-java/" rel="next" title="Why does A* path finding sometimes go in straight lines and sometimes diagonals? (Java)">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
