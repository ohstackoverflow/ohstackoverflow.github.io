<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Why is my variable unaltered after I modify it inside of a function? - Asynchronous code reference | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/why-is-my-variable-unaltered-after-i-modify-it-inside-of-a-function-asynchronous-code-reference/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../how-to-create-a-new-object-instance-from-a-type/" title="How to create a new object instance from a Type" type="text/html">
<link rel="next" href="../how-to-split-a-string-into-an-array-in-bash/" title="How to split a string into an array in Bash?" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="Why is my variable unaltered after I modify it inside of a function? -">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/why-is-my-variable-unaltered-after-i-modify-it-inside-of-a-function-asynchronous-code-reference/">
<meta property="og:description" content="Given the following examples, why is outerScopeVar undefined in all cases?
var outerScopeVar;

var img = document.createElement('img');
img.onload = function() {
    outerScopeVar = this.width;
};
img">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-17T10:22:40+08:00">
<meta property="article:tag" content="asynchronous">
<meta property="article:tag" content="javascript">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Why is my variable unaltered after I modify it inside of a function? - Asynchronous code reference</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T10:22:40+08:00" itemprop="datePublished" title="2023-02-17 10:22">2023-02-17 10:22</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>Given the following examples, why is <code>outerScopeVar</code> undefined in all cases?</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>

<span class="k">var</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>
<span class="n">img</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">width</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">img</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'lolcat.png'</span><span class="p">;</span>
<span class="n">alert</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>



<span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="n">setTimeout</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Hello Asynchronous World!'</span><span class="p">;</span>
<span class="p">},</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="n">alert</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>



<span class="o">//</span><span class="w"> </span><span class="n">Example</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">jQuery</span>
<span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="o">$.</span><span class="n">post</span><span class="p">(</span><span class="s1">'loldog'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">;</span>
<span class="p">});</span>
<span class="n">alert</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>



<span class="o">//</span><span class="w"> </span><span class="n">Node</span><span class="o">.</span><span class="n">js</span><span class="w"> </span><span class="n">example</span>
<span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="n">fs</span><span class="o">.</span><span class="n">readFile</span><span class="p">(</span><span class="s1">'./catdog.html'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="p">});</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>



<span class="o">//</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">promises</span>
<span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="n">myPromise</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">;</span>
<span class="p">});</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>



<span class="o">//</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">observables</span>
<span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="n">myObservable</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="p">});</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>



<span class="o">//</span><span class="w"> </span><span class="n">geolocation</span><span class="w"> </span><span class="n">API</span>
<span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="n">navigator</span><span class="o">.</span><span class="n">geolocation</span><span class="o">.</span><span class="n">getCurrentPosition</span><span class="p">(</span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span>
<span class="p">});</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>
</pre></div>

<p>Why does it output <code>undefined</code> in all of these examples? I don't want
workarounds, I want to know <strong>why</strong> this is happening.</p>
<hr>
<blockquote>
<p><strong>Note:</strong> This is a canonical question for <em>JavaScript asynchronicity</em>. Feel
free to improve this question and add more simplified examples which the
community can identify with.</p>
</blockquote>
<p><br><br></p>
<h2>Answer</h2>
<p>One word answer: <strong>asynchronicity</strong>.</p>
<h3>Forewords</h3>
<p>This topic has been iterated at least a couple of thousands of times here in
Stack Overflow. Hence, first off I'd like to point out some extremely useful
resources:</p>
<ul>
<li>
<p>@Felix Kling's answer to "How do I return the response from an asynchronous call?". See his excellent answer explaining synchronous and asynchronous flows, as well as the "Restructure code" section.<br>
@Benjamin Gruenbaum has also put a lot of effort into explaining
asynchronicity in the same thread.</p>
</li>
<li>
<p>@Matt Esch's answer to "Get data from fs.readFile" also explains asynchronicity extremely well in a simple manner.</p>
</li>
</ul>
<hr>
<h3>The answer to the question at hand</h3>
<p>Let's trace the common behavior first. In all examples, the <code>outerScopeVar</code> is
modified inside of a <em>function</em>. That function is clearly not executed
immediately; it is being assigned or passed as an argument. That is what we
call a <em><strong>callback</strong></em>.</p>
<p>Now the question is, when is that callback called?</p>
<p>It depends on the case. Let's try to trace some common behavior again:</p>
<ul>
<li>
<code>img.onload</code> may be called <em>sometime in the future</em> when (and if) the image has successfully loaded.</li>
<li>
<code>setTimeout</code> may be called <em>sometime in the future</em> after the delay has expired and the timeout hasn't been canceled by <code>clearTimeout</code>. Note: even when using <code>0</code> as delay, all browsers have a minimum timeout delay cap (specified to be 4ms in the HTML5 spec).</li>
<li>jQuery <code>$.post</code>'s callback may be called <em>sometime in the future</em> when (and if) the Ajax request has been completed successfully.</li>
<li>Node.js's <code>fs.readFile</code> may be called <em>sometime in the future</em> when the file has been read successfully or thrown an error.</li>
</ul>
<p>In all cases, we have a callback that may run <em>sometime in the future</em>. This
"sometime in the future" is what we refer to as <strong>asynchronous flow</strong>.</p>
<p>Asynchronous execution is pushed out of the synchronous flow. That is, the
asynchronous code will <strong>never</strong> execute while the synchronous code stack is
executing. This is the meaning of JavaScript being single-threaded.</p>
<p>More specifically, when the JS engine is idle -- not executing a stack of
(a)synchronous code -- it will poll for events that may have triggered
asynchronous callbacks (e.g. expired timeout, received network response) and
execute them one after another. This is regarded as Event Loop.</p>
<p>That is, the asynchronous code highlighted in the hand-drawn red shapes may
execute only after all the remaining synchronous code in their respective code
blocks have executed:</p>
<p><img alt="async code highlighted" src="../../images/40IwM.png"></p>
<p>In short, the callback functions are created synchronously but executed
asynchronously. You can't rely on the execution of an asynchronous function
until you know it has been executed, and how to do that?</p>
<p>It is simple, really. The logic that depends on the asynchronous function
execution should be started/called from inside this asynchronous function. For
example, moving the <code>alert</code>s and <code>console.log</code>s inside the callback function
would output the expected result because the result is available at that
point.</p>
<h4>Implementing your own callback logic</h4>
<p>Often you need to do more things with the result from an asynchronous function
or do different things with the result depending on where the asynchronous
function has been called. Let's tackle a bit more complex example:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="n">helloCatAsync</span><span class="p">();</span>
<span class="n">alert</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>

<span class="n">function</span><span class="w"> </span><span class="n">helloCatAsync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setTimeout</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Nya'</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="n">Math</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2000</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p><strong>Note:</strong> I'm using <code>setTimeout</code> with a random delay as a generic asynchronous
function; the same example applies to Ajax, <code>readFile</code>, <code>onload</code>, and any
other asynchronous flow.</p>
<p>This example clearly suffers from the same issue as the other examples; it is
not waiting until the asynchronous function executes.</p>
<p>Let's tackle it by implementing a callback system of our own. First off, we
get rid of that ugly <code>outerScopeVar</code> which is completely useless in this case.
Then we add a parameter that accepts a function argument, our callback. When
the asynchronous operation finishes, we call this callback, passing the
result. The implementation (please read the comments in order):</p>
<div class="code"><pre class="code literal-block"><span class="c1">// 1. Call helloCatAsync passing a callback function,</span>
<span class="c1">//    which will be called receiving the result from the async operation</span>
<span class="n">helloCatAsync</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 5. Received the result from the async function,</span>
<span class="w">    </span><span class="c1">//    now do whatever you want with it:</span>
<span class="w">    </span><span class="n">alert</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 2. The "callback" parameter is a reference to the function which</span>
<span class="c1">//    was passed as an argument from the helloCatAsync call</span>
<span class="k">function</span><span class="w"> </span><span class="nf">helloCatAsync</span><span class="p">(</span>callback<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 3. Start async operation:</span>
<span class="w">    </span><span class="n">setTimeout</span><span class="p">(</span><span class="k">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 4. Finished async operation,</span>
<span class="w">        </span><span class="c1">//    call the callback, passing the result as an argument</span>
<span class="w">        </span><span class="n">callback</span><span class="p">(</span><span class="s">'Nya'</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2000</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Code snippet of the above example:</p>
<div class="code"><pre class="code literal-block"><span class="c1">// 1. Call helloCatAsync passing a callback function,</span>
<span class="c1">//    which will be called receiving the result from the async operation</span>
<span class="n">console</span><span class="p">.</span><span class="nb">log</span><span class="p">(</span><span class="s">"1. function called..."</span><span class="p">)</span>
<span class="n">helloCatAsync</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 5. Received the result from the async function,</span>
<span class="w">    </span><span class="c1">//    now do whatever you want with it:</span>
<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="nb">log</span><span class="p">(</span><span class="s">"5. result is: "</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 2. The "callback" parameter is a reference to the function which</span>
<span class="c1">//    was passed as an argument from the helloCatAsync call</span>
<span class="k">function</span><span class="w"> </span><span class="nf">helloCatAsync</span><span class="p">(</span>callback<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="nb">log</span><span class="p">(</span><span class="s">"2. callback here is the function passed as argument above..."</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// 3. Start async operation:</span>
<span class="w">    </span><span class="n">setTimeout</span><span class="p">(</span><span class="k">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="nb">log</span><span class="p">(</span><span class="s">"3. start async operation..."</span><span class="p">)</span>
<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="nb">log</span><span class="p">(</span><span class="s">"4. finished async operation, calling the callback, passing the result..."</span><span class="p">)</span>
<span class="w">        </span><span class="c1">// 4. Finished async operation,</span>
<span class="w">        </span><span class="c1">//    call the callback passing the result as argument</span>
<span class="w">        </span><span class="n">callback</span><span class="p">(</span><span class="s">'Nya'</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2000</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Most often in real use cases, the DOM API and most libraries already provide
the callback functionality (the <code>helloCatAsync</code> implementation in this
demonstrative example). You only need to pass the callback function and
understand that it will execute out of the synchronous flow and restructure
your code to accommodate for that.</p>
<p>You will also notice that due to the asynchronous nature, it is impossible to
<code>return</code> a value from an asynchronous flow back to the synchronous flow where
the callback was defined, as the asynchronous callbacks are executed long
after the synchronous code has already finished executing.</p>
<p>Instead of <code>return</code>ing a value from an asynchronous callback, you will have to
make use of the callback pattern, or... Promises.</p>
<h4>Promises</h4>
<p>Although there are ways to keep the callback hell at bay with vanilla JS,
promises are growing in popularity and are currently being standardized in ES6
(see Promise - MDN).</p>
<p>Promises (a.k.a. Futures) provide a more linear, and thus pleasant, reading of
the asynchronous code, but explaining their entire functionality is out of the
scope of this question. Instead, I'll leave these excellent resources for the
interested:</p>
<ul>
<li>JavaScript Promises - HTML5 Rocks</li>
<li>You're Missing the Point of Promises - domenic.me</li>
</ul>
<hr>
<h4>More reading material about JavaScript asynchronicity</h4>
<ul>
<li>The Art of Node - Callbacks explains asynchronous code and callbacks very well with vanilla JS examples and Node.js code as well.</li>
</ul>
<hr>
<blockquote>
<p><strong>Note:</strong> I've marked this answer as Community Wiki. Hence anyone with at
least 100 reputations can edit and improve it! Please feel free to improve
this answer or submit a completely new answer if you'd like as well.</p>
<p>I want to turn this question into a canonical topic to answer asynchronicity
issues that are unrelated to Ajax (there is How to return the response from
an AJAX call? for that), hence this topic needs your help to be as good and
helpful as possible!</p>
</blockquote>
<p><br></p>
<h3>Suggest</h3>
<p><em>Fabrício's answer is spot on; but I wanted to complement his answer with
something less technical, which focusses on an analogy to help explain the
concept of asynchronicity</em>.</p>
<hr>
<h4>An Analogy...</h4>
<p>Yesterday, the work I was doing required some information from a colleague. I
rang him up; here's how the conversation went:</p>
<blockquote>
<p><strong>Me</strong> : Hi Bob, I need to know how we <em>foo</em> 'd the <em>bar</em> 'd last week. Jim
wants a report on it, and you're the only one who knows the details about
it.</p>
<p><strong>Bob</strong> : Sure thing, but it'll take me around 30 minutes?</p>
<p><strong>Me</strong> : That's great Bob. Give me a ring back when you've got the
information!</p>
</blockquote>
<p>At this point, I hung up the phone. Since I needed information from Bob to
complete my report, I left the report and went for a coffee instead, then I
caught up on some email. 40 minutes later (Bob is slow), Bob called back and
gave me the information I needed. At this point, I resumed my work with my
report, as I had all the information I needed.</p>
<hr>
<p>Imagine if the conversation had gone like this instead;</p>
<blockquote>
<p><strong>Me</strong> : Hi Bob, I need to know how we <em>foo</em> 'd the <em>bar</em> 'd last week. Jim
want's a report on it, and you're the only one who knows the details about
it.</p>
<p><strong>Bob</strong> : Sure thing, but it'll take me around 30 minutes?</p>
<p><strong>Me</strong> : That's great Bob. I'll wait.</p>
</blockquote>
<p>And I sat there and waited. And waited. And waited. For 40 minutes. Doing
nothing but waiting. Eventually, Bob gave me the information, we hung up, and
I completed my report. But I'd lost 40 minutes of productivity.</p>
<hr>
<h4>This is asynchronous vs. synchronous behavior</h4>
<p>This is exactly what is happening in all the examples in our question. Loading
an image, loading a file off disk, and requesting a page via AJAX are all slow
operations (in the context of modern computing).</p>
<p>Rather than <em>waiting</em> for these slow operations to complete, JavaScript lets
you register a callback function which will be executed when the slow
operation has completed. In the meantime, however, JavaScript will continue to
execute other code. The fact that JavaScript executes <em>other code</em> whilst
waiting for the slow operation to complete makes the behavior
<strong>asynchronous</strong>. Had JavaScript waited around for the operation to complete
before executing any other code, this would have been <strong>synchronous</strong>
behavior.</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span><span class="w">    </span>
<span class="k">var</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>

<span class="o">//</span><span class="w"> </span><span class="n">Here</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">callback</span><span class="w"> </span><span class="n">function</span><span class="o">.</span>
<span class="n">img</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">executed</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">loaded</span><span class="o">.</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">width</span><span class="p">;</span>
<span class="p">};</span>

<span class="o">//</span><span class="w"> </span><span class="n">But</span><span class="p">,</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">loading</span><span class="p">,</span><span class="w"> </span><span class="n">JavaScript</span><span class="w"> </span><span class="n">continues</span><span class="w"> </span><span class="n">executing</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span>
<span class="o">//</span><span class="w"> </span><span class="n">processes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">JavaScript</span><span class="o">.</span>
<span class="n">img</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'lolcat.png'</span><span class="p">;</span>
<span class="n">alert</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>
</pre></div>

<p>In the code above, we're asking JavaScript to load <code>lolcat.png</code>, which is a
<em>sloooow</em> operation. The callback function will be executed once this slow
operation has done, but in the meantime, JavaScript will keep processing the
next lines of code; i.e. <code>alert(outerScopeVar)</code>.</p>
<p>This is why we see the alert showing <code>undefined</code>; since the <code>alert()</code> is
processed immediately, rather than after the image has been loaded.</p>
<p>In order to fix our code, all we have to do is move the <code>alert(outerScopeVar)</code>
code <em>into</em> the callback function. As a consequence of this, we no longer need
the <code>outerScopeVar</code> variable declared as a global variable.</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>

<span class="n">img</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">localScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">width</span><span class="p">;</span>
<span class="w">    </span><span class="n">alert</span><span class="p">(</span><span class="n">localScopeVar</span><span class="p">);</span>
<span class="p">};</span>

<span class="n">img</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'lolcat.png'</span><span class="p">;</span>
</pre></div>

<p>You'll <strong><em>always</em></strong> see a callback is specified as a function, because that's
the only* way in JavaScript to define some code, but not execute it until
later.</p>
<p>Therefore, in all of our examples, the <code>function() { /* Do something */ }</code> is
the callback; to fix <strong>all</strong> the examples, all we have to do is move the code
which needs the response of the operation into there!</p>
<ul>
<li>Technically you can use <code>eval()</code> as well, but <code>eval()</code> is evil for this purpose</li>
</ul>
<hr>
<h4>How do I keep my caller waiting?</h4>
<p>You might currently have some code similar to this;</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">getWidthOfImage</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>

<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>
<span class="w">    </span><span class="n">img</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">width</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">img</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">src</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">var</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getWidthOfImage</span><span class="p">(</span><span class="s1">'lolcat.png'</span><span class="p">);</span>
<span class="n">alert</span><span class="p">(</span><span class="n">width</span><span class="p">);</span>
</pre></div>

<p>However, we now know that the <code>return outerScopeVar</code> happens immediately;
before the <code>onload</code> callback function has updated the variable. This leads to
<code>getWidthOfImage()</code> returning <code>undefined</code>, and <code>undefined</code> being alerted.</p>
<p>To fix this, we need to allow the function calling <code>getWidthOfImage()</code> to
register a callback, then move the alert'ing of the width to be within that
callback;</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">getWidthOfImage</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">     </span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>
<span class="w">    </span><span class="n">img</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cb</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">width</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">img</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">src</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">getWidthOfImage</span><span class="p">(</span><span class="s1">'lolcat.png'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">alert</span><span class="p">(</span><span class="n">width</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>... as before, note that we've been able to remove the global variables (in
this case <code>width</code>).</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/asynchronous/" rel="tag">asynchronous</a></li>
            <li><a class="tag p-category" href="../../categories/javascript/" rel="tag">javascript</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../how-to-create-a-new-object-instance-from-a-type/" rel="prev" title="How to create a new object instance from a Type">Previous post</a>
            </li>
            <li class="next">
                <a href="../how-to-split-a-string-into-an-array-in-bash/" rel="next" title="How to split a string into an array in Bash?">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
