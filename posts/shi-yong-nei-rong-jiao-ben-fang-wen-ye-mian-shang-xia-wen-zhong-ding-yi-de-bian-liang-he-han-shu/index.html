<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>使用内容脚本访问页面上下文中定义的变量和函数 | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/shi-yong-nei-rong-jiao-ben-fang-wen-ye-mian-shang-xia-wen-zhong-ding-yi-de-bian-liang-he-han-shu/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../jian-ce-dao-lei-xing-de-json-net-cuo-wu-zi-yin-yong-xun-huan/" title="检测到类型的 JSON.NET 错误自引用循环" type="text/html">
<link rel="next" href="../ru-he-shi-yong-zi-tu-geng-gai-tu-xing-da-xiao/" title="如何使用子图更改图形大小？" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="使用内容脚本访问页面上下文中定义的变量和函数">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/shi-yong-nei-rong-jiao-ben-fang-wen-ye-mian-shang-xia-wen-zhong-ding-yi-de-bian-liang-he-han-shu/">
<meta property="og:description" content='我正在学习如何创建 Chrome 扩展程序。我刚开始开发一个来捕捉 YouTube 事件。我想将它与 YouTube flash
播放器一起使用（稍后我会尝试使其与 HTML5 兼容）。
清单.json：
{
    "name": "MyExtension",
    "version": "1.0",
    "description": "Gotta catch Youtube events'>
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-18T01:08:49+08:00">
<meta property="article:tag" content="content-script">
<meta property="article:tag" content="google-chrome">
<meta property="article:tag" content="google-chrome-extension">
<meta property="article:tag" content="javascript">
<meta property="article:tag" content="youtube-api">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">使用内容脚本访问页面上下文中定义的变量和函数</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T01:08:49+08:00" itemprop="datePublished" title="2023-02-18 01:08">2023-02-18 01:08</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>我正在学习如何创建 Chrome 扩展程序。我刚开始开发一个来捕捉 YouTube 事件。我想将它与 YouTube flash
播放器一起使用（稍后我会尝试使其与 HTML5 兼容）。</p>
<p><strong>清单.json：</strong></p>
<div class="code"><pre class="code literal-block">{
    "name": "MyExtension",
    "version": "1.0",
    "description": "Gotta catch Youtube events!",
    "permissions": ["tabs", "http://*/*"],
    "content_scripts" : [{
        "matches" : [ "www.youtube.com/*"],
        "js" : ["myScript.js"]
    }]
}
</pre></div>

<p><strong>我的脚本.js：</strong></p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">state</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">"State Changed!"</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="k">var</span><span class="w"> </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s2">"movie_player"</span><span class="p">);</span>
<span class="n">player</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s2">"onStateChange"</span><span class="p">,</span><span class="w"> </span><span class="s2">"state"</span><span class="p">);</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">"Started!"</span><span class="p">);</span>
</pre></div>

<p>问题是控制台给了我 <em>“已开始！”</em> ，但没有 <em>“状态已更改！”</em> 当我播放/暂停 YouTube 视频时。</p>
<p>当此代码放入控制台时，它起作用了。我究竟做错了什么？</p>
<p><br><br></p>
<h2>解答</h2>
<p><strong>根本原因：内容脚本在</strong> “孤立世界”<br>
环境中执行。</p>
<p><strong>解决方案：</strong><br>
使用 DOM 将代码注入页面 - 该代码将能够 <em>访问</em> 页面上下文（“主世界”）的函数/变量或将函数/变量 <em>暴露</em>
给页面上下文（在您的情况下是方法<code>state()</code>）。</p>
<ul>
<li>
<p><strong>请注意，如果需要与页面脚本进行通信：</strong><br>
使用 DOM<code>CustomEvent</code>处理程序。示例：一、二和三。</p>
</li>
<li>
<p><strong>如果<code>chrome</code>页面脚本中需要 API，请注意：</strong><br>
由于<code>chrome.*</code>API 不能在页面脚本中使用，您必须在内容脚本中使用它们，并通过 DOM 消息传递将结果发送到页面脚本（参见上面的注释）。</p>
</li>
</ul>
<p><strong>安全警告</strong> ：<br>
页面可能会重新定义或扩充/挂接内置原型，因此如果页面以不兼容的方式执行此操作，您公开的代码可能会失败。如果您想确保暴露的代码在安全的环境中运行，那么您应该
a) 使用"run_at": "document_start"声明您的内容脚本并使用方法 2-3 而不是 1，或者 b) 提取原始的原生内置-通过一个空的
iframe 插入，例如. 请注意，<code>document_start</code>您可能需要<code>DOMContentLoaded</code>在公开的代码中使用事件来等待 DOM。</p>
<h2>目录</h2>
<ul>
<li>方法 1：注入另一个文件 - ManifestV3 兼容</li>
<li>方法二：注入嵌入式代码——MV2</li>
<li>方法 2b：使用函数 - MV2</li>
<li>方法 3：使用内联事件 - ManifestV3 兼容</li>
<li>方法 4：使用 executeScript 的世界 - 仅限 ManifestV3</li>
<li>方法 5：<code>world</code>在 manifest.json 中使用 - 仅限 ManifestV3，Chrome 111+</li>
<li>注入代码中的动态值</li>
</ul>
<h3>方法一：注入另一个文件（ManifestV3/MV2）</h3>
<p>当你有很多代码时特别好。将代码放在扩展名中的文件中，比如<code>script.js</code>. 然后像这样将其加载到您的内容脚本中：</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'script'</span><span class="p">);</span>
<span class="n">s</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chrome</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">getURL</span><span class="p">(</span><span class="s1">'script.js'</span><span class="p">);</span>
<span class="n">s</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">this</span><span class="o">.</span><span class="n">remove</span><span class="p">();</span>
<span class="p">};</span>
<span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">head</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">documentElement</span><span class="p">)</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</pre></div>

<p><strong>js 文件必须暴露在<code>web_accessible_resources</code></strong>：</p>
<ul>
<li>
<p>ManifestV2 的 manifest.json 示例</p>
<div class="code"><pre class="code literal-block">"web_accessible_resources": ["script.js"],
</pre></div>

</li>
<li>
<p>ManifestV3 的 manifest.json 示例</p>
<div class="code"><pre class="code literal-block">"web_accessible_resources": [{
</pre></div>

<p>"resources": ["script.js"],
  "matches": ["<all_urls>"]
}]</all_urls></p>
</li>
</ul>
<p>如果没有，控制台会出现如下错误：</p>
<blockquote>
<p>拒绝加载 chrome-extension://[EXTENSIONID]/script.js。资源必须列在
web_accessible_resources 清单键中，以便由扩展之外的页面加载。</p>
</blockquote>
<h3>方法二：注入嵌入式代码（MV2）</h3>
<p>当您想快速运行一小段代码时，此方法很有用。（另请参阅：如何使用 Chrome 扩展程序禁用 facebook 热键？）。</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">`</span><span class="o">//</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="n">here</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">curly</span><span class="w"> </span><span class="n">braces</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">example</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">number</span><span class="p">:</span>
<span class="k">var</span><span class="w"> </span><span class="n">someFixedRandomValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="w"> </span><span class="n">Math</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="o">//</span><span class="w"> </span><span class="n">NOTE</span><span class="p">:</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">way</span><span class="p">,</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">below</span>
<span class="o">//</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="s2">"Dynamic values in the injected code"</span>
<span class="err">`</span><span class="p">;</span>

<span class="k">var</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'script'</span><span class="p">);</span>
<span class="n">script</span><span class="o">.</span><span class="n">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actualCode</span><span class="p">;</span>
<span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">head</span><span class="o">||</span><span class="n">document</span><span class="o">.</span><span class="n">documentElement</span><span class="p">)</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">script</span><span class="p">);</span>
<span class="n">script</span><span class="o">.</span><span class="n">remove</span><span class="p">();</span>
</pre></div>

<p>注意：模板文字仅在 Chrome 41 及更高版本中受支持。如果您希望扩展在 Chrome 40- 中工作，请使用：</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'/* Code here. Example: */'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'alert(0);'</span><span class="p">,</span>
<span class="w">                  </span><span class="s1">'// Beware! This array have to be joined'</span><span class="p">,</span>
<span class="w">                  </span><span class="s1">'// using a newline. Otherwise, missing semicolons'</span><span class="p">,</span>
<span class="w">                  </span><span class="s1">'// or single-line comments (//) will mess up your'</span><span class="p">,</span>
<span class="w">                  </span><span class="s1">'// code -----&gt;'</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">);</span>
</pre></div>

<h3>方法 2b：使用函数（MV2）</h3>
<p>对于大块代码，引用字符串是不可行的。除了使用数组，还可以使用函数并将其字符串化：</p>
<div class="code"><pre class="code literal-block"><span class="n">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">function</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">All</span><span class="w"> </span><span class="k">code</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">executed</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">local</span><span class="w"> </span><span class="n">scope</span><span class="p">.</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">For</span><span class="w"> </span><span class="n">example</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">following</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">overwrite</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n n-Quoted">`alert`</span><span class="w"> </span><span class="n">method</span>
<span class="w">    </span><span class="n">var</span><span class="w"> </span><span class="n">alert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">null</span><span class="p">;</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">To</span><span class="w"> </span><span class="n">overwrite</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="n n-Quoted">`window`</span><span class="o">:</span>
<span class="w">    </span><span class="k">window</span><span class="p">.</span><span class="n">alert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">null</span><span class="p">;</span>
<span class="err">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')();'</span><span class="p">;</span>
<span class="n">var</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="p">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'script'</span><span class="p">);</span>
<span class="n">script</span><span class="p">.</span><span class="n">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actualCode</span><span class="p">;</span>
<span class="p">(</span><span class="n">document</span><span class="p">.</span><span class="n">head</span><span class="o">||</span><span class="n">document</span><span class="p">.</span><span class="n">documentElement</span><span class="p">).</span><span class="n">appendChild</span><span class="p">(</span><span class="n">script</span><span class="p">);</span>
<span class="n">script</span><span class="p">.</span><span class="k">remove</span><span class="p">();</span>
</pre></div>

<p>此方法有效，因为<code>+</code>字符串和函数上的运算符将所有对象转换为字符串。如果您打算多次使用代码，明智的做法是创建一个函数来避免代码重复。一个实现可能看起来像：</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">injectScript</span><span class="p">(</span><span class="k">func</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">func</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')();'</span>
<span class="w">    </span><span class="o">...</span>
<span class="p">}</span>
<span class="n">injectScript</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">alert</span><span class="p">(</span><span class="s2">"Injected script"</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>注意：由于函数是序列化的，原始作用域和所有绑定属性都丢失了！</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">scriptToInject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">typeof</span><span class="w"> </span><span class="n">scriptToInject</span><span class="p">);</span>
<span class="p">};</span>
<span class="n">injectScript</span><span class="p">(</span><span class="n">scriptToInject</span><span class="p">);</span>
<span class="o">//</span><span class="w"> </span><span class="n">Console</span><span class="w"> </span><span class="n">output</span><span class="p">:</span><span class="w">  </span><span class="s2">"undefined"</span>
</pre></div>

<h3>Method 3: Using an inline event (ManifestV3/MV2)</h3>
<p>Sometimes, you want to run some code immediately, e.g. to run some code before
the <code>&lt;head&gt;</code> element is created. This can be done by inserting a <code>&lt;script&gt;</code>
tag with <code>textContent</code> (see method 2/2b).</p>
<p>An alternative, <strong>but not recommended</strong> is to use inline events. It is not
recommended because if the page defines a Content Security policy that forbids
inline scripts, then inline event listeners are blocked. Inline scripts
injected by the extension, on the other hand, still run. If you still want to
use inline events, this is how:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'// Some code example </span><span class="se">\n</span><span class="s1">'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                 </span><span class="s1">'console.log(document.documentElement.outerHTML);'</span><span class="p">;</span>

<span class="n">document</span><span class="o">.</span><span class="n">documentElement</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s1">'onreset'</span><span class="p">,</span><span class="w"> </span><span class="n">actualCode</span><span class="p">);</span>
<span class="n">document</span><span class="o">.</span><span class="n">documentElement</span><span class="o">.</span><span class="n">dispatchEvent</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">CustomEvent</span><span class="p">(</span><span class="s1">'reset'</span><span class="p">));</span>
<span class="n">document</span><span class="o">.</span><span class="n">documentElement</span><span class="o">.</span><span class="n">removeAttribute</span><span class="p">(</span><span class="s1">'onreset'</span><span class="p">);</span>
</pre></div>

<p>Note: This method assumes that there are no other global event listeners that
handle the <code>reset</code> event. If there is, you can also pick one of the other
global events. Just open the JavaScript console (F12), type
<code>document.documentElement.on</code>, and pick on of the available events.</p>
<h3>Method 4: Using chrome.scripting API <code>world</code> (ManifestV3 only)</h3>
<ul>
<li>Chrome 95 or newer, <code>chrome.scripting.executeScript</code> with <code>world: 'MAIN'</code>
</li>
<li>Chrome 102 or newer, <code>chrome.scripting.registerContentScripts</code> with <code>world: 'MAIN'</code>, also allows <code>runAt: 'document_start'</code> to guarantee early execution of the page script.</li>
</ul>
<p>Unlike the other methods, this one is for the background script or the popup
script, not for the content script. See the documentation and examples.</p>
<h3>Method 5: Using <code>world</code> in manifest.json (ManifestV3 only)</h3>
<p>In Chrome 111 or newer you can add <code>"world": "MAIN"</code> to <code>content_scripts</code>
declaration in manifest.json to override the default value which is
<code>ISOLATED</code>. The scripts run in the listed order.</p>
<div class="code"><pre class="code literal-block">  "content_scripts": [{
    "js": ["content.js"],
    "matches": ["&lt;all_urls&gt;"],
    "run_at": "document_start"
  }, {
    "world": "MAIN",
    "js": ["page.js"],
    "matches": ["&lt;all_urls&gt;"],
    "run_at": "document_start"
  }],
</pre></div>

<h3>Dynamic values in the injected code (MV2)</h3>
<p>Occasionally, you need to pass an arbitrary variable to the injected function.
For example:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">GREETING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Hi, I'm "</span><span class="p">;</span>
<span class="k">var</span><span class="w"> </span><span class="n">NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Rob"</span><span class="p">;</span>
<span class="k">var</span><span class="w"> </span><span class="n">scriptToInject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">alert</span><span class="p">(</span><span class="n">GREETING</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NAME</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>

<p>To inject this code, you need to pass the variables as arguments to the
anonymous function. Be sure to implement it correctly! The following will
<strong>not</strong> work:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">scriptToInject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">GREETING</span><span class="p">,</span><span class="w"> </span><span class="n">NAME</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">};</span>
<span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">scriptToInject</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">GREETING</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NAME</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')'</span><span class="p">;</span>
<span class="o">//</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">numbers</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">booleans</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">strings</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="n">To</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">why</span><span class="p">,</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">resulting</span><span class="w"> </span><span class="n">string</span><span class="p">:</span>
<span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"(function(GREETING, NAME) {...})(Hi, I'm ,Rob)"</span><span class="p">;</span>
<span class="o">//</span><span class="w">                                                 </span><span class="o">^^^^^^^^</span><span class="w"> </span><span class="o">^^^</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">literals</span><span class="o">!</span>
</pre></div>

<p>The solution is to use <code>JSON.stringify</code> before passing the argument. Example:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">actualCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">greeting</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">...</span>
<span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">GREETING</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">NAME</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')'</span><span class="p">;</span>
</pre></div>

<p>If you have many variables, it's worthwhile to use <code>JSON.stringify</code> once, to
improve readability, as follows:</p>
<div class="code"><pre class="code literal-block">...
} + ')(' + JSON.stringify([arg1, arg2, arg3, arg4]).slice(1, -1) + ')';
</pre></div>

<h3>Dynamic values in the injected code (ManifestV3)</h3>
<ul>
<li>Method 1 can set the URL of the script element in the content script:<div class="code"><pre class="code literal-block"><span class="nt">s</span><span class="p">.</span><span class="nc">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">chrome</span><span class="p">.</span><span class="nc">runtime</span><span class="p">.</span><span class="nc">getURL</span><span class="o">(</span><span class="s1">'script.js?'</span><span class="o">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">URLSearchParams</span><span class="o">(</span><span class="p">{</span><span class="n">foo</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="o">);</span>
</pre></div>

</li>
</ul>
<p>Then script.js can read it:</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">URLSearchParams</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">currentScript</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'?'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">));</span>
</pre></div>

<ul>
<li>Method 4 executeScript has <code>args</code> parameter, registerContentScripts currently doesn't (hopefully it'll be added in the future).</li>
</ul>
<p><br></p>
<h3>更多建议</h3>
<p>唯一的事情 <del>丢失的</del> Rob W 的出色回答隐藏了如何在注入的页面脚本和内容脚本之间进行通信。</p>
<p>在接收方（您的内容脚本或注入的页面脚本）添加一个事件侦听器：</p>
<div class="code"><pre class="code literal-block"><span class="n">document</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s1">'yourCustomEvent'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">var</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">detail</span><span class="p">;</span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">'received'</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>在发起方（内容脚本或注入的页面脚本）发送事件：</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">allowedTypes</span><span class="p">:</span><span class="w"> </span><span class="s1">'those supported by structured cloning, see the list below'</span><span class="p">,</span>
<span class="w">  </span><span class="n">inShort</span><span class="p">:</span><span class="w"> </span><span class="s1">'no DOM elements or classes/functions'</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">document</span><span class="o">.</span><span class="n">dispatchEvent</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">CustomEvent</span><span class="p">(</span><span class="s1">'yourCustomEvent'</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">detail</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">}));</span>
</pre></div>

<p>笔记：</p>
<ul>
<li>DOM 消息传递使用结构化克隆算法，除了原始值外，它只能传输某些类型的数据。它不能发送类实例或函数或 DOM 元素。</li>
<li>在 Firefox 中，要将对象（即不是原始值）从内容脚本发送到页面上下文，您必须使用<code>cloneInto</code>（内置函数）将其显式克隆到目标中，否则它将因安全违规错误而失败.<div class="code"><pre class="code literal-block">document.dispatchEvent(new CustomEvent('yourCustomEvent', {
</pre></div>

<p>detail: cloneInto(data, document.defaultView),
}));</p>
</li>
</ul>
<p><br><br><a href="../access-variables-and-functions-defined-in-page-context-using-a-content-script/">查看原文</a></p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/content-script/" rel="tag">content-script</a></li>
            <li><a class="tag p-category" href="../../categories/google-chrome/" rel="tag">google-chrome</a></li>
            <li><a class="tag p-category" href="../../categories/google-chrome-extension/" rel="tag">google-chrome-extension</a></li>
            <li><a class="tag p-category" href="../../categories/javascript/" rel="tag">javascript</a></li>
            <li><a class="tag p-category" href="../../categories/youtube-api/" rel="tag">youtube-api</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../jian-ce-dao-lei-xing-de-json-net-cuo-wu-zi-yin-yong-xun-huan/" rel="prev" title="检测到类型的 JSON.NET 错误自引用循环">Previous post</a>
            </li>
            <li class="next">
                <a href="../ru-he-shi-yong-zi-tu-geng-gai-tu-xing-da-xiao/" rel="next" title="如何使用子图更改图形大小？">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
