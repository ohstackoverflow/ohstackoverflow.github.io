<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>为什么我在函数内部修改变量后它没有改变？- 异步代码参考 | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/wei-shi-yao-wo-zai-han-shu-nei-bu-xiu-gai-bian-liang-hou-ta-mei-you-gai-bian-yi-bu-dai-ma-can-kao/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../ru-he-cong-lei-xing-chuang-jian-xin-de-dui-xiang-shi-li/" title="如何从类型创建新的对象实例" type="text/html">
<link rel="next" href="../ru-he-zai-bash-zhong-jiang-zi-fu-chuan-chai-fen-wei-shu-zu/" title="如何在 Bash 中将字符串拆分为数组？" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="为什么我在函数内部修改变量后它没有改变？- 异步代码参考">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/wei-shi-yao-wo-zai-han-shu-nei-bu-xiu-gai-bian-liang-hou-ta-mei-you-gai-bian-yi-bu-dai-ma-can-kao/">
<meta property="og:description" content="鉴于以下示例，为什么outerScopeVar在所有情况下都是未定义的？
var outerScopeVar;

var img = document.createElement('img');
img.onload = function() {
    outerScopeVar = this.width;
};
img.src = 'lolcat.png';
alert(outerScopeV">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-17T10:23:03+08:00">
<meta property="article:tag" content="asynchronous">
<meta property="article:tag" content="javascript">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">为什么我在函数内部修改变量后它没有改变？- 异步代码参考</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T10:23:03+08:00" itemprop="datePublished" title="2023-02-17 10:23">2023-02-17 10:23</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>鉴于以下示例，为什么<code>outerScopeVar</code>在所有情况下都是未定义的？</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>

<span class="k">var</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>
<span class="n">img</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">width</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">img</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'lolcat.png'</span><span class="p">;</span>
<span class="n">alert</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>



<span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="n">setTimeout</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Hello Asynchronous World!'</span><span class="p">;</span>
<span class="p">},</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="n">alert</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>



<span class="o">//</span><span class="w"> </span><span class="n">Example</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">jQuery</span>
<span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="o">$.</span><span class="n">post</span><span class="p">(</span><span class="s1">'loldog'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">;</span>
<span class="p">});</span>
<span class="n">alert</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>



<span class="o">//</span><span class="w"> </span><span class="n">Node</span><span class="o">.</span><span class="n">js</span><span class="w"> </span><span class="n">example</span>
<span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="n">fs</span><span class="o">.</span><span class="n">readFile</span><span class="p">(</span><span class="s1">'./catdog.html'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="p">});</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>



<span class="o">//</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">promises</span>
<span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="n">myPromise</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">;</span>
<span class="p">});</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>



<span class="o">//</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">observables</span>
<span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="n">myObservable</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="p">});</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>



<span class="o">//</span><span class="w"> </span><span class="n">geolocation</span><span class="w"> </span><span class="n">API</span>
<span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="n">navigator</span><span class="o">.</span><span class="n">geolocation</span><span class="o">.</span><span class="n">getCurrentPosition</span><span class="p">(</span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span>
<span class="p">});</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>
</pre></div>

<p><code>undefined</code>为什么它会在所有这些示例中输出？我不想要解决方法，我想知道 <strong>为什么</strong> 会这样。</p>
<hr>
<blockquote>
<p><strong>注意：这是</strong> <em>JavaScript asynchronicity</em> 的规范问题。随意改进这个问题并添加社区可以识别的更多简化示例。</p>
</blockquote>
<p><br><br></p>
<h2>解答</h2>
<p>一句话回答： <strong>异步</strong> 。</p>
<h3>前言</h3>
<p>这个主题在 Stack Overflow 中至少被重复了数千次。因此，首先我想指出一些非常有用的资源：</p>
<ul>
<li>
<p>@Felix Kling 对“如何从异步调用返回响应？”的回答 . 查看他解释同步和异步流程的出色答案，以及“重组代码”部分。<br>
@Benjamin Gruenbaum 也付出了很多努力来解释同一线程中的异步性。</p>
</li>
<li>
<p>@Matt Esch 对“从 fs.readFile 获取数据”的回答也以简单的方式很好地解释了异步性。</p>
</li>
</ul>
<hr>
<h3>手头问题的答案</h3>
<p>让我们首先追踪常见的行为。在所有示例中，都是在
<em>函数</em><code>outerScopeVar</code>内部修改的。该功能显然不会立即执行；它被分配或作为参数传递。这就是我们所说的 _ <strong>回调</strong><em> 。 __ _
****</em></p>
<p>现在的问题是，回调是什么时候调用的？</p>
<p>这取决于具体情况。让我们再次尝试追踪一些常见的行为：</p>
<ul>
<li>
<code>img.onload</code>可能会 <em>在将来某个</em> 时候（如果）图像已成功加载时调用。</li>
<li>
<code>setTimeout</code>可能会在延迟到期且超时未被 取消后的 <em>某个</em><code>clearTimeout</code>时间调用。注意：即使使用<code>0</code>as delay，所有浏览器都有最小超时延迟上限（在 HTML5 规范中指定为 4ms）。</li>
<li>jQuery<code>$.post</code>的回调可能会 <em>在将来某个</em> 时候（如果）Ajax 请求已成功完成时调用。</li>
<li>当文件被成功读取或抛出错误时，Node.js<code>fs.readFile</code>可能会 <em>在将来的某个时间被调用。</em>
</li>
</ul>
<p><em>在所有情况下，我们都有一个可能在未来某个时间</em> 运行的回调。这个“将来的某个时候”就是我们所说的 <strong>异步流</strong> 。</p>
<p>异步执行被推出同步流程。也就是说，异步代码 <strong>永远</strong> 不会在同步代码堆栈执行时执行。这就是 JavaScript 单线程的意义。</p>
<p>更具体地说，当 JS 引擎空闲时——不执行一堆 (a)
同步代码——它会轮询可能触发异步回调的事件（例如过期超时、收到网络响应）并依次执行它们。这被视为事件循环。</p>
<p>也就是说，手绘红色形状中突出显示的异步代码可能只有在其各自代码块中的所有剩余同步代码都已执行后才会执行：</p>
<p><img alt="突出显示异步代码" src="../../images/40IwM.png"></p>
<p>简而言之，回调函数是同步创建但异步执行的。在知道异步函数已执行之前，您不能依赖它的执行，如何做到这一点？</p>
<p>这很简单，真的。依赖于异步函数执行的逻辑应该从这个异步函数内部启动/调用。例如，在回调函数中移动<code>alert</code>s 和<code>console.log</code>s
将输出预期的结果，因为此时结果可用。</p>
<h4>实现自己的回调逻辑</h4>
<p>通常您需要对异步函数的结果做更多​​的事情，或者根据调用异步函数的位置对结果做不同的事情。让我们处理一个更复杂的例子：</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="n">helloCatAsync</span><span class="p">();</span>
<span class="n">alert</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>

<span class="n">function</span><span class="w"> </span><span class="n">helloCatAsync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setTimeout</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Nya'</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="n">Math</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2000</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p><strong>注意：</strong> 我将<code>setTimeout</code>随机延迟用作通用异步函数；相同的示例适用于 Ajax、<code>readFile</code>、<code>onload</code>和任何其他异步流程。</p>
<p>这个例子显然与其他例子存在同样的问题；它不会等到异步函数执行。</p>
<p>让我们通过实现我们自己的回调系统来解决它。首先，我们摆脱了<code>outerScopeVar</code>在这种情况下完全无用的丑陋。然后我们添加一个接受函数参数的参数，我们的回调。当异步操作完成时，我们调用此回调并传递结果。实现（请按顺序阅读评论）：</p>
<div class="code"><pre class="code literal-block"><span class="c1">// 1. Call helloCatAsync passing a callback function,</span>
<span class="c1">//    which will be called receiving the result from the async operation</span>
<span class="n">helloCatAsync</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 5. Received the result from the async function,</span>
<span class="w">    </span><span class="c1">//    now do whatever you want with it:</span>
<span class="w">    </span><span class="n">alert</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 2. The "callback" parameter is a reference to the function which</span>
<span class="c1">//    was passed as an argument from the helloCatAsync call</span>
<span class="k">function</span><span class="w"> </span><span class="nf">helloCatAsync</span><span class="p">(</span>callback<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 3. Start async operation:</span>
<span class="w">    </span><span class="n">setTimeout</span><span class="p">(</span><span class="k">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 4. Finished async operation,</span>
<span class="w">        </span><span class="c1">//    call the callback, passing the result as an argument</span>
<span class="w">        </span><span class="n">callback</span><span class="p">(</span><span class="s">'Nya'</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2000</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>上面例子的代码片段：</p>
<div class="code"><pre class="code literal-block"><span class="c1">// 1. Call helloCatAsync passing a callback function,</span>
<span class="c1">//    which will be called receiving the result from the async operation</span>
<span class="n">console</span><span class="p">.</span><span class="nb">log</span><span class="p">(</span><span class="s">"1. function called..."</span><span class="p">)</span>
<span class="n">helloCatAsync</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 5. Received the result from the async function,</span>
<span class="w">    </span><span class="c1">//    now do whatever you want with it:</span>
<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="nb">log</span><span class="p">(</span><span class="s">"5. result is: "</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 2. The "callback" parameter is a reference to the function which</span>
<span class="c1">//    was passed as an argument from the helloCatAsync call</span>
<span class="k">function</span><span class="w"> </span><span class="nf">helloCatAsync</span><span class="p">(</span>callback<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="nb">log</span><span class="p">(</span><span class="s">"2. callback here is the function passed as argument above..."</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// 3. Start async operation:</span>
<span class="w">    </span><span class="n">setTimeout</span><span class="p">(</span><span class="k">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="nb">log</span><span class="p">(</span><span class="s">"3. start async operation..."</span><span class="p">)</span>
<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="nb">log</span><span class="p">(</span><span class="s">"4. finished async operation, calling the callback, passing the result..."</span><span class="p">)</span>
<span class="w">        </span><span class="c1">// 4. Finished async operation,</span>
<span class="w">        </span><span class="c1">//    call the callback passing the result as argument</span>
<span class="w">        </span><span class="n">callback</span><span class="p">(</span><span class="s">'Nya'</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2000</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>大多数情况下，在实际用例中，DOM API
和大多数库已经提供了回调功能（<code>helloCatAsync</code>此演示示例中的实现）。您只需要传递回调函数并了解它将在同步流之外执行并重组您的代码以适应它。</p>
<p>您还会注意到，由于异步性质，不可能将<code>return</code>异步流中的值返回到定义回调的同步流，因为异步回调是在同步代码执行完很久之后才执行的。</p>
<p><code>return</code>您将不得不使用回调模式，而不是从异步回调中获取值，或者... Promises。</p>
<h4>承诺</h4>
<p>尽管有一些方法可以使用 vanilla JS 来避免回调地狱，但 promises 越来越受欢迎并且目前正在 ES6 中标准化（请参阅Promise -
MDN）。</p>
<p>Promises（又名
Futures）提供了一种更线性的、因此更愉快的异步代码阅读方式，但解释它们的全部功能超出了这个问题的范围。相反，我会将这些优秀的资源留给感兴趣的人：</p>
<ul>
<li>JavaScript Promises - HTML5 Rocks</li>
<li>你错过了承诺的重点 - domenic.me</li>
</ul>
<hr>
<h4>更多关于 JavaScript 异步性的阅读材料</h4>
<ul>
<li>The Art of Node - Callbacks通过 vanilla JS 示例和 Node.js 代码很好地解释了异步代码和回调。</li>
</ul>
<hr>
<blockquote>
<p><strong>注意：</strong> 我已将此答案标记为 Community Wiki。因此，任何拥有至少 100
个声誉的人都可以编辑和改进它！如果您愿意，请随时改进此答案或提交全新的答案。</p>
<p>我想把这个问题变成一个规范的主题来回答与 Ajax 无关的异步问题（有How to return the response from an AJAX
call? for that），因此这个主题需要你的帮助尽可能好和有用！</p>
</blockquote>
<p><br></p>
<h3>更多建议</h3>
<p><em>Fabrício 的回答很准确； 但我想用一些不太技术性的东西来补充他的回答，它侧重于一个类比来帮助解释异步性的概念</em>。</p>
<hr>
<h4>一个类比...</h4>
<p>昨天，我正在做的工作需要同事提供一些信息。我给他打电话；谈话是这样进行的：</p>
<blockquote>
<p><strong>我</strong> ：嗨，鲍勃，我想知道我们上周是怎么 <em>去</em> 酒吧 <em>的。</em> 吉姆想要一份关于它的报告，而你是唯一知道细节的人。</p>
<p><strong>鲍勃</strong> ：没问题，但我需要大约 30 分钟？</p>
<p><strong>我</strong> ：那太好了，鲍勃。得到信息后给我回电话！</p>
</blockquote>
<p>就在这时，我挂断了电话。因为我需要鲍勃的信息来完成我的报告，所以我离开了报告去喝咖啡，然后我赶上了一些电子邮件。40
分钟后（鲍勃很慢），鲍勃回电话并给了我需要的信息。在这一点上，我恢复了我的报告工作，因为我拥有我需要的所有信息。</p>
<hr>
<p>想象一下，如果谈话是这样进行的；</p>
<blockquote>
<p><strong>我</strong> ：嗨，鲍勃，我想知道我们上周是怎么 <em>去</em> 酒吧 <em>的。</em> 吉姆想要一份关于它的报告，而你是唯一知道细节的人。</p>
<p><strong>鲍勃</strong> ：没问题，但我需要大约 30 分钟？</p>
<p><strong>我</strong> ：那太好了，鲍勃。我会等待。</p>
</blockquote>
<p>我坐在那里等待。然后等待。然后等待。40 分钟。除了等待，什么都不做。最后，鲍勃给了我信息，我们挂断了电话，我完成了报告。但是我失去了 40
分钟的工作效率。</p>
<hr>
<h4>这是异步与同步行为</h4>
<p>这正是我们问题中所有示例中发生的情况。加载图像、从磁盘加载文件以及通过 AJAX 请求页面都是缓慢的操作（在现代计算环境中）。</p>
<p>JavaScript无需 <em>等待</em> 这些缓慢的操作完成，而是让您注册一个回调函数，该函数将在缓慢的操作完成时执行。然而，与此同时，JavaScript
将继续执行其他代码。JavaScript在等待缓慢操作完成的同时执行 <em>其他代码</em> 这一事实使得行为 <strong>异步</strong> 。如果 JavaScript
在执行任何其他代码之前等待操作完成，这将是 <strong>同步</strong> 行为。</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span><span class="w">    </span>
<span class="k">var</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>

<span class="o">//</span><span class="w"> </span><span class="n">Here</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">callback</span><span class="w"> </span><span class="n">function</span><span class="o">.</span>
<span class="n">img</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Code</span><span class="w"> </span><span class="n">within</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">executed</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">loaded</span><span class="o">.</span>
<span class="w">    </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">width</span><span class="p">;</span>
<span class="p">};</span>

<span class="o">//</span><span class="w"> </span><span class="n">But</span><span class="p">,</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">loading</span><span class="p">,</span><span class="w"> </span><span class="n">JavaScript</span><span class="w"> </span><span class="n">continues</span><span class="w"> </span><span class="n">executing</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span>
<span class="o">//</span><span class="w"> </span><span class="n">processes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">JavaScript</span><span class="o">.</span>
<span class="n">img</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'lolcat.png'</span><span class="p">;</span>
<span class="n">alert</span><span class="p">(</span><span class="n">outerScopeVar</span><span class="p">);</span>
</pre></div>

<p>在上面的代码中，我们要求 JavaScript 加载<code>lolcat.png</code>，这是一个 <em>sloooow</em>
操作。一旦这个缓慢的操作完成，回调函数将被执行，但与此同时，JavaScript 将继续处理下一行代码；即<code>alert(outerScopeVar)</code>。</p>
<p>这就是我们看到警报显示的原因<code>undefined</code>；因为<code>alert()</code>是立即处理的，而不是在加载图像之后。</p>
<p>为了修复我们的代码，我们所要做的就是将代码移到<code>alert(outerScopeVar)</code>回调函数 <em>中。</em>
因此，我们不再需要<code>outerScopeVar</code>声明为全局变量的变量。</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>

<span class="n">img</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">localScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">width</span><span class="p">;</span>
<span class="w">    </span><span class="n">alert</span><span class="p">(</span><span class="n">localScopeVar</span><span class="p">);</span>
<span class="p">};</span>

<span class="n">img</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'lolcat.png'</span><span class="p">;</span>
</pre></div>

<p>您 <strong> <em>总是</em></strong> 会看到回调被指定为函数，因为这是 JavaScript 中定义某些代码但稍后才执行它的唯一*方式。</p>
<p>因此，在我们所有的示例中，<code>function() { /* Do something */ }</code>是回调；要修复 <strong>所有</strong>
示例，我们要做的就是将需要操作响应的代码移到那里！</p>
<ul>
<li>从技术上讲你<code>eval()</code>也可以使用，但为此目的<code>eval()</code>是邪恶的</li>
</ul>
<hr>
<h4>如何让来电者等待？</h4>
<p>您目前可能有一些与此类似的代码；</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">getWidthOfImage</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>

<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>
<span class="w">    </span><span class="n">img</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">outerScopeVar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">width</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">img</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">src</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">outerScopeVar</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">var</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getWidthOfImage</span><span class="p">(</span><span class="s1">'lolcat.png'</span><span class="p">);</span>
<span class="n">alert</span><span class="p">(</span><span class="n">width</span><span class="p">);</span>
</pre></div>

<p>但是，我们现在知道这<code>return
outerScopeVar</code>会立即发生；<code>onload</code>在回调函数更新变量之前。这导致<code>getWidthOfImage()</code>返回<code>undefined</code>，并被<code>undefined</code>提醒。</p>
<p>为了解决这个问题，我们需要允许函数调用<code>getWidthOfImage()</code>注册一个回调，然后将宽度的警报移动到该回调内；</p>
<div class="code"><pre class="code literal-block"><span class="n">function</span><span class="w"> </span><span class="n">getWidthOfImage</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">     </span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>
<span class="w">    </span><span class="n">img</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cb</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">width</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">img</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">src</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">getWidthOfImage</span><span class="p">(</span><span class="s1">'lolcat.png'</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">alert</span><span class="p">(</span><span class="n">width</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>...和以前一样，请注意我们已经能够删除全局变量（在本例中<code>width</code>）。</p>
<p><br><br><a href="../why-is-my-variable-unaltered-after-i-modify-it-inside-of-a-function-asynchronous-code-reference/">查看原文</a></p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/asynchronous/" rel="tag">asynchronous</a></li>
            <li><a class="tag p-category" href="../../categories/javascript/" rel="tag">javascript</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../ru-he-cong-lei-xing-chuang-jian-xin-de-dui-xiang-shi-li/" rel="prev" title="如何从类型创建新的对象实例">Previous post</a>
            </li>
            <li class="next">
                <a href="../ru-he-zai-bash-zhong-jiang-zi-fu-chuan-chai-fen-wei-shu-zu/" rel="next" title="如何在 Bash 中将字符串拆分为数组？">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
