<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>为什么 lock(this) {...} 不好？ | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/wei-shi-yao-lock-this-bu-hao/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../shi-yao-shi-wu-fu-hao-zi-fu/" title="什么是无符号字符？" type="text/html">
<link rel="next" href="../zai-swift-zhong-jiang-shuang-jing-du-zhi-si-she-wu-ru-dao-x-xiao-shu-wei/" title="在 swift 中将双精度值四舍五入到 x 小数位" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="为什么 lock(this) {...} 不好？">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/wei-shi-yao-lock-this-bu-hao/">
<meta property="og:description" content="MSDN文档说
public class SomeObject
{
  public void SomeOperation()
  {
    lock(this)
    {
      //Access instance variables
    }
  }
}


是“如果可以公开访问实例的问题”。我想知道为什么？是因为锁的持有时间比必要的要长吗？或者有什么更阴险的原因？

解答
在 lo">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-18T06:49:51+08:00">
<meta property="article:tag" content="cSharp">
<meta property="article:tag" content="locking">
<meta property="article:tag" content="multithreading">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">为什么 lock(this) {...} 不好？</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-18T06:49:51+08:00" itemprop="datePublished" title="2023-02-18 06:49">2023-02-18 06:49</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>MSDN文档说</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">SomeObject</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">SomeOperation</span><span class="p">()</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">lock</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="o">//</span><span class="n">Access</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="n">variables</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>是“如果可以公开访问实例的问题”。我想知道为什么？是因为锁的持有时间比必要的要长吗？或者有什么更阴险的原因？</p>
<p><br><br></p>
<h2>解答</h2>
<p>在 lock 语句中使用这种形式是不好的<code>this</code>，因为通常您无法控制还有谁可能锁定该对象。</p>
<p>为了正确规划并行操作，应特别注意考虑可能出现的死锁情况，而未知数量的锁入口点会阻碍这一点。例如，任何引用该对象的人都可以在对象设计者/创建者不知道的情况下锁定它。这增加了多线程解决方案的复杂性，并可能影响它们的正确性。</p>
<p>私有字段通常是更好的选择，因为编译器会对其实施访问限制，并且会封装锁定机制。Using<code>this</code>通过向公众公开部分锁定实现来违反封装。<code>this</code>除非已记录，否则您将获得锁定也不清楚。即便如此，依靠文档来预防问题也不是最佳选择。</p>
<p>最后，还有一个常见的误解，即<code>lock(this)</code>实际上修改了作为参数传递的对象，并以某种方式使其成为只读或不可访问的。这是 <strong>错误的</strong>
。作为参数传递给的对象<code>lock</code>仅用作 <strong>键</strong> 。如果该键已经被锁定，则无法进行锁定；否则，允许锁定。</p>
<p>这就是为什么在语句中使用字符串作为键是不好的<code>lock</code>，因为它们是不可变的并且可以跨应用程序的各个部分共享/访问。您应该改用私有变量，<code>Object</code>实例会做得很好。</p>
<p>运行以下 C# 代码作为示例。</p>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">Person</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">Age</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">get</span><span class="p">;</span><span class="w"> </span><span class="n">set</span><span class="p">;</span><span class="w">  </span><span class="p">}</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">get</span><span class="p">;</span><span class="w"> </span><span class="n">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">LockThis</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">lock</span><span class="w"> </span><span class="p">(</span><span class="n">this</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">System</span><span class="o">.</span><span class="n">Threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="n">Program</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">Main</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">nancy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Person</span><span class="w"> </span><span class="p">{</span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Nancy Drew"</span><span class="p">,</span><span class="w"> </span><span class="n">Age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">};</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">nancy</span><span class="o">.</span><span class="n">LockThis</span><span class="p">);</span>
<span class="w">        </span><span class="n">a</span><span class="o">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">Timewarp</span><span class="p">);</span>
<span class="w">        </span><span class="n">b</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">nancy</span><span class="p">);</span>
<span class="w">        </span><span class="n">Thread</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">anotherNancy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Person</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Nancy Drew"</span><span class="p">,</span><span class="w"> </span><span class="n">Age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">NameChange</span><span class="p">);</span>
<span class="w">        </span><span class="n">c</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">anotherNancy</span><span class="p">);</span>
<span class="w">        </span><span class="n">a</span><span class="o">.</span><span class="n">Join</span><span class="p">();</span>
<span class="w">        </span><span class="n">Console</span><span class="o">.</span><span class="n">ReadLine</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">Timewarp</span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="n">subject</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subject</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Person</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">person</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">ArgumentNullException</span><span class="p">(</span><span class="s2">"subject"</span><span class="p">);</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">read</span><span class="o">-</span><span class="n">only</span><span class="o">.</span>
<span class="w">        </span><span class="n">lock</span><span class="w"> </span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">Age</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">23</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">There</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="s1">'person'</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">LockThis</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">another</span><span class="w"> </span><span class="n">thread</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Monitor</span><span class="o">.</span><span class="n">TryEnter</span><span class="p">(</span><span class="n">person</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">false</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s2">"'this' person is locked!"</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="n">Monitor</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">person</span><span class="p">);</span>
<span class="w">                </span><span class="n">person</span><span class="o">.</span><span class="n">Age</span><span class="o">++</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">Age</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">18</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="o">//</span><span class="w"> </span><span class="n">Changing</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="s1">'person.Name'</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">doesn</span><span class="s1">'t change the lock...</span>
<span class="w">                    </span><span class="n">person</span><span class="o">.</span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Nancy Smith"</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s2">"{0} is {1} years old."</span><span class="p">,</span><span class="w"> </span><span class="n">person</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">person</span><span class="o">.</span><span class="n">Age</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">NameChange</span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="n">subject</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subject</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Person</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">person</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">ArgumentNullException</span><span class="p">(</span><span class="s2">"subject"</span><span class="p">);</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">avoid</span><span class="w"> </span><span class="n">locking</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">strings</span><span class="p">,</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">immutable</span><span class="o">.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Monitor</span><span class="o">.</span><span class="n">TryEnter</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">false</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s2">"Failed to obtain lock on 50 year old Nancy, because Timewarp(object) locked on string </span><span class="se">\"</span><span class="s2">Nancy Drew</span><span class="se">\"</span><span class="s2">."</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="n">Monitor</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">Name</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Monitor</span><span class="o">.</span><span class="n">TryEnter</span><span class="p">(</span><span class="s2">"Nancy Drew"</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">false</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s2">"Failed to obtain lock using 'Nancy Drew' literal, locked by 'person.Name' since both are the same object thanks to inlining!"</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="n">Monitor</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="s2">"Nancy Drew"</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Monitor</span><span class="o">.</span><span class="n">TryEnter</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">string</span><span class="w"> </span><span class="n">oldName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">person</span><span class="o">.</span><span class="n">Name</span><span class="p">;</span>
<span class="w">            </span><span class="n">person</span><span class="o">.</span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Nancy Callahan"</span><span class="p">;</span>
<span class="w">            </span><span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s2">"Name changed from '{0}' to '{1}'."</span><span class="p">,</span><span class="w"> </span><span class="n">oldName</span><span class="p">,</span><span class="w"> </span><span class="n">person</span><span class="o">.</span><span class="n">Name</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="n">Monitor</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">Name</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>控制台输出</p>
<div class="code"><pre class="code literal-block">'this' person is locked!
Nancy Drew is 16 years old.
'this' person is locked!
Nancy Drew is 17 years old.
Failed to obtain lock on 50 year old Nancy, because Timewarp(object) locked on string "Nancy Drew".
'this' person is locked!
Nancy Smith is 18 years old.
'this' person is locked!
Nancy Smith is 19 years old.
'this' person is locked!
Nancy Smith is 20 years old.
Failed to obtain lock using 'Nancy Drew' literal, locked by 'person.Name' since both are the same object thanks to inlining!
'this' person is locked!
Nancy Smith is 21 years old.
'this' person is locked!
Nancy Smith is 22 years old.
'this' person is locked!
Nancy Smith is 23 years old.
'this' person is locked!
Nancy Smith is 24 years old.
Name changed from 'Nancy Drew' to 'Nancy Callahan'.
</pre></div>

<p><br></p>
<h3>更多建议</h3>
<p>因为如果人们可以获得您的对象实例（即：您的<code>this</code>）指针，那么他们也可以尝试锁定同一个对象。现在他们可能不知道你在内部锁定<code>this</code>，所以这可能会导致问题（可能是死锁）</p>
<p>除此之外，这也是不好的做法，因为它锁定“太多”</p>
<p>例如，您可能有一个成员变量<code>List&lt;int&gt;</code>，而您实际需要锁定的唯一东西就是该成员变量。如果你在你的函数中锁定整个对象，那么调用这些函数的其他东西将被阻塞等待锁定。如果这些函数不需要访问成员列表，您将无缘无故地导致其他代码等待并减慢您的应用程序。</p>
<p><br><br><a href="../why-is-lock-this-bad/">查看原文</a></p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/csharp/" rel="tag">cSharp</a></li>
            <li><a class="tag p-category" href="../../categories/locking/" rel="tag">locking</a></li>
            <li><a class="tag p-category" href="../../categories/multithreading/" rel="tag">multithreading</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../shi-yao-shi-wu-fu-hao-zi-fu/" rel="prev" title="什么是无符号字符？">Previous post</a>
            </li>
            <li class="next">
                <a href="../zai-swift-zhong-jiang-shuang-jing-du-zhi-si-she-wu-ru-dao-x-xiao-shu-wei/" rel="next" title="在 swift 中将双精度值四舍五入到 x 小数位">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
