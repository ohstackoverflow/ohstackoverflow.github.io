<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>为什么我不应该在 PHP 中使用 mysql_* 函数？ | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/wei-shi-yao-wo-bu-ying-gai-zai-php-zhong-shi-yong-mysql-han-shu/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../zi-zhi-ruan-jian-an-zhuang-te-ding-ban-ben-de-gong-shi/" title="自制软件安装特定版本的公式？" type="text/html">
<link rel="next" href="../ru-he-zai-javascript-zhong-huo-qu-cha-xun-zi-fu-chuan-zhi/" title="如何在 JavaScript 中获取查询字符串值？" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="为什么我不应该在 PHP 中使用 mysql_* 函数？">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/wei-shi-yao-wo-bu-ying-gai-zai-php-zhong-shi-yong-mysql-han-shu/">
<meta property="og:description" content="想要改进这篇文章？ 提供此问题的详细答案，包括引用和解释为什么你的答案是正确的。不够详细的答案可能会被编辑或删除。
为什么不应该使用mysql_*功能的技术原因是什么？（例如mysql_query()，mysql_connect()或mysql_real_escape_string()）？
为什么我应该使用其他东西，即使它们在我的网站上有效？
如果他们在我的网站上不起作用，为什么我会收到类似这样的">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-16T20:49:08+08:00">
<meta property="article:tag" content="mysql">
<meta property="article:tag" content="php">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">为什么我不应该在 PHP 中使用 mysql_* 函数？</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T20:49:08+08:00" itemprop="datePublished" title="2023-02-16 20:49">2023-02-16 20:49</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p><strong>想要改进这篇文章？</strong> 提供此问题的详细答案，包括引用和解释为什么你的答案是正确的。不够详细的答案可能会被编辑或删除。</p>
<p>为什么不应该使用<code>mysql_*</code>功能的技术原因是什么？（例如<code>mysql_query()</code>，<code>mysql_connect()</code>或<code>mysql_real_escape_string()</code>）？</p>
<p>为什么我应该使用其他东西，即使它们在我的网站上有效？</p>
<p>如果他们在我的网站上不起作用，为什么我会收到类似这样的错误</p>
<blockquote>
<p>警告：mysql_connect()：没有那个文件或目录</p>
</blockquote>
<p><br><br></p>
<h2>解答</h2>
<p>MySQL扩展：</p>
<ul>
<li>不在积极开发中</li>
<li>自 PHP 5.5（2013 年 6 月发布）起 <strong>正式</strong> <strong>弃用</strong> 。</li>
<li>自 PHP 7.0（2015 年 12 月发布）起 已 <strong>完全</strong> <strong>删除</strong><ul>
<li>这意味着截至2018 年 12 月 31 日，它不存在于任何受支持的 PHP 版本中。如果您使用的是支持它的 PHP 版本，那么您使用的是未修复安全问题的版本。</li>
</ul>
</li>
<li>缺少 OO 接口</li>
<li>不支持： <ul>
<li>非阻塞、异步查询</li>
<li><strong>准备好的语句 或参数化查询</strong></li>
<li>存储过程</li>
<li>多重陈述</li>
<li>交易</li>
<li>“新”密码验证方法（在 MySQL 5.6 中默认启用；在 5.7 中需要）</li>
<li>MySQL 5.1 或更高版本中的任何新功能</li>
</ul>
</li>
</ul>
<p>由于它已被弃用，使用它会使您的代码不那么将来。</p>
<p>缺乏对准备语句的支持尤为重要，因为与使用单独的函数调用手动转义外部数据相比，它们提供了一种更清晰、更不容易出错的转义和引用外部数据的方法。</p>
<p>查看 <strong>SQL 扩展的比较</strong> 。</p>
<p><br></p>
<h3>更多建议</h3>
<p>PHP 提供了三种不同的 API 来连接到 MySQL。这些是<code>mysql</code>（从 PHP 7 开始删除）、、<code>mysqli</code>和<code>PDO</code>扩展。</p>
<p>这些<code>mysql_*</code>功能曾经非常流行，但不再鼓励使用它们。文档团队正在讨论数据库安全情况，教育用户远离常用的 ext/mysql 扩展是其中的一部分（检查
<em>php.internals：deprecating ext/mysql</em> ）。</p>
<p>而后来的 PHP 开发团队已经决定 <strong><code>E_DEPRECATED</code></strong> 在用户​​连接 MySQL
时产生错误，无论是通过<code>mysql_connect()</code>.<code>mysql_pconnect()</code>还是内置的隐式连接功能<code>ext/mysql</code>。</p>
<p><strong><code>ext/mysql</code></strong> <strong>从 PHP 5.5 开始正式弃用</strong> ， <strong>从 PHP 7</strong> 开始删除。</p>
<p><strong>看到红框了吗？</strong></p>
<p>当你进入任何<code>mysql_*</code>功能手册页时，你会看到一个红色框，说明它不应该再使用了。</p>
<h3>为什么</h3>
<hr>
<p>远离 MySQL<code>ext/mysql</code>不仅与安全有关，还与访问 MySQL 数据库的所有功能有关。</p>
<p><code>ext/mysql</code>是为 <strong>MySQL 3.23</strong>
构建的，从那时起只增加了很少的内容，同时主要保持与这个旧版本的兼容性，这使得代码更难维护。不支持的缺失功能包括<code>ext/mysql</code>：（ <em>来自 PHP
手册</em> ）。</p>
<ul>
<li>存储过程（不能处理多个结果集）</li>
<li>准备好的陈述</li>
<li>加密（SSL）</li>
<li>压缩</li>
<li>完整的字符集支持</li>
</ul>
<p><strong>不使用<code>mysql_*</code>功能的</strong>原因：</p>
<ul>
<li>未在积极开发中</li>
<li>从 PHP 7 开始删除</li>
<li>缺少 OO 接口</li>
<li>不支持非阻塞、异步查询</li>
<li>不支持准备好的语句或参数化查询</li>
<li>不支持存储过程</li>
<li>不支持多条语句</li>
<li>不支持交易</li>
<li>不支持 MySQL 5.1 中的所有功能</li>
</ul>
<p>以上观点引用自昆汀的回答</p>
<p>缺乏对准备语句的支持尤为重要，因为与使用单独的函数调用手动转义外部数据相比，它们提供了一种更清晰、更不容易出错的转义和引用外部数据的方法。</p>
<p>查看SQL 扩展的比较。</p>
<hr>
<p><strong>抑制弃用警告</strong></p>
<p>在将代码转换为<code>MySQLi</code>/时<code>PDO</code>，<code>E_DEPRECATED</code>可以通过<code>error_reporting</code>在 <strong>php.ini</strong>
中设置排除来抑制错误<code>E_DEPRECATED:</code></p>
<div class="code"><pre class="code literal-block">error_reporting = E_ALL ^ E_DEPRECATED
</pre></div>

<p>请注意，这也会隐藏 <strong>其他弃用警告</strong> ，但是，这些警告可能针对 MySQL 以外的其他内容。（ <em>来自 PHP 手册</em> ）</p>
<p>文章 <em>PDO 与 MySQLi：您应该使用哪个？</em> Dejan <strong>Marjanovic</strong> 将帮助您做出选择。</p>
<p>而更好的方法是<code>PDO</code>，我现在正在写一个简单的<code>PDO</code>教程。</p>
<hr>
<h3>一个简单而简短的 PDO 教程</h3>
<hr>
<h4>问：我想到的第一个问题是：什么是 <code>PDO</code>？</h4>
<p>A. “ <strong>PDO——PHP 数据对象</strong> ——是一个数据库访问层，提供了访问多个数据库的统一方法。”</p>
<blockquote>
<p><img alt="替代文字" src="../../images/Vd7ve.png"></p>
</blockquote>
<hr>
<h4>连接到 MySQL</h4>
<p>With <code>mysql_*</code>function 或者我们可以用旧的方式说（在 PHP 5.5 及更高版本中已弃用）</p>
<div class="code"><pre class="code literal-block">$link = mysql_connect('localhost', 'user', 'pass');
mysql_select_db('testdb', $link);
mysql_set_charset('UTF-8', $link);
</pre></div>

<p>With
<code>PDO</code>：您需要做的就是创建一个新<code>PDO</code>对象。构造函数接受用于指定数据库源<code>PDO</code>的参数，构造函数主要采用四个参数，它们是<code>DSN</code>（数据源名称）和可选的<code>username</code>,
<code>password</code>。</p>
<p>在这里，我认为您对 except
都熟悉<code>DSN</code>；这是新的<code>PDO</code>。A<code>DSN</code>基本上是一串选项，告诉您<code>PDO</code>使用哪个驱动程序和连接详细信息。如需进一步参考，请查看PDO MySQL
DSN。</p>
<div class="code"><pre class="code literal-block"><span class="o">$</span><span class="nt">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">PDO</span><span class="o">(</span><span class="s1">'mysql:host=localhost;dbname=testdb;charset=utf8'</span><span class="o">,</span><span class="w"> </span><span class="s1">'username'</span><span class="o">,</span><span class="w"> </span><span class="s1">'password'</span><span class="o">);</span>
</pre></div>

<p><strong>注意：</strong> 你也可以使用<code>charset=UTF-8</code>，但有时会导致错误，所以最好使用<code>utf8</code>.</p>
<p>如果有任何连接错误，它会抛出一个<code>PDOException</code>可以被捕获的对象来<code>Exception</code>进一步处理。</p>
<p><strong>好读</strong> ：连接和连接管理¶</p>
<p>您还可以将几个驱动程序选项作为数组传递给第四个参数。我建议传递进入异常模式的参数<code>PDO</code>。因为有些<code>PDO</code>驱动不支持原生的prepared
statements，所以<code>PDO</code>执行prepare的仿真。它还允许您手动启用此仿真。要使用本机服务器端准备好的语句，您应该显式设置它<code>false</code>。</p>
<p>另一种是关闭prepare emulation，驱动<code>MySQL</code>默认是开启的，但是prepare emulation应该关闭才能<code>PDO</code>安全使用。</p>
<p>我稍后会解释为什么要关闭准备仿真。要找到原因，请查看这篇文章。</p>
<p>它仅在您使用<code>MySQL</code>我不推荐的旧版本时可用。</p>
<p>以下是您如何做到这一点的示例：</p>
<div class="code"><pre class="code literal-block"><span class="o">$</span><span class="nt">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">PDO</span><span class="o">(</span><span class="s1">'mysql:host=localhost;dbname=testdb;charset=UTF-8'</span><span class="o">,</span><span class="w"> </span>
<span class="w">              </span><span class="s1">'username'</span><span class="o">,</span><span class="w"> </span>
<span class="w">              </span><span class="s1">'password'</span><span class="o">,</span>
<span class="w">              </span><span class="nt">array</span><span class="o">(</span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ATTR_EMULATE_PREPARES</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nt">false</span><span class="o">,</span>
<span class="w">              </span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ATTR_ERRMODE</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ERRMODE_EXCEPTION</span><span class="o">));</span>
</pre></div>

<p><strong>PDO构建后可以设置属性吗？</strong></p>
<p><strong>是的</strong> ，我们也可以在 PDO 构建之后设置一些属性，<code>setAttribute</code>方法是：</p>
<div class="code"><pre class="code literal-block"><span class="o">$</span><span class="nt">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">PDO</span><span class="o">(</span><span class="s1">'mysql:host=localhost;dbname=testdb;charset=UTF-8'</span><span class="o">,</span><span class="w"> </span>
<span class="w">              </span><span class="s1">'username'</span><span class="o">,</span><span class="w"> </span>
<span class="w">              </span><span class="s1">'password'</span><span class="o">);</span>
<span class="o">$</span><span class="nt">db-</span><span class="o">&gt;</span><span class="nt">setAttribute</span><span class="o">(</span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ATTR_ERRMODE</span><span class="o">,</span><span class="w"> </span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ERRMODE_EXCEPTION</span><span class="o">);</span>
<span class="o">$</span><span class="nt">db-</span><span class="o">&gt;</span><span class="nt">setAttribute</span><span class="o">(</span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ATTR_EMULATE_PREPARES</span><span class="o">,</span><span class="w"> </span><span class="nt">false</span><span class="o">);</span>
</pre></div>

<h3>错误处理</h3>
<hr>
<p>错误处理<code>PDO</code>比<code>mysql_*</code>.</p>
<p>使用时的一个常见做法<code>mysql_*</code>是：</p>
<div class="code"><pre class="code literal-block"><span class="c1">//Connected to MySQL</span>
<span class="no">$</span><span class="n">result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">mysql_query</span><span class="p">(</span><span class="s">"SELECT * FROM table"</span><span class="p">,</span><span class="w"> </span><span class="no">$</span><span class="nb">link</span><span class="p">)</span><span class="w"> </span><span class="nb">or</span><span class="w"> </span><span class="n">die</span><span class="p">(</span><span class="n">mysql_error</span><span class="p">(</span><span class="no">$</span><span class="nb">link</span><span class="p">));</span>
</pre></div>

<p><code>OR die()</code>不是处理错误的好方法，因为我们无法处理<code>die</code>.
它只会突然结束脚本，然后将错误回显到您通常不想向最终用户显示的屏幕上，让该死的黑客发现您的模式。或者，函数的返回值通常可以与mysql_error()<code>mysql_*</code>结合使用来处理错误。</p>
<p><code>PDO</code>提供了一个更好的解决方案：异常。我们所做的任何事情都<code>PDO</code>应该包裹在一个<code>try</code>-<code>catch</code>块中。我们可以通过设置错误模式属性强制<code>PDO</code>进入三种错误模式之一。下面是三种错误处理模式。</p>
<ul>
<li>
<code>PDO::ERRMODE_SILENT</code>. <code>mysql_*</code>它只是设置错误代码，其行为与您必须检查每个结果然后查看<code>$db-&gt;errorInfo();</code>以获取错误详细信息的位置几乎相同。</li>
<li>
<code>PDO::ERRMODE_WARNING</code>提高<code>E_WARNING</code>。（运行时警告（非致命错误）。脚本的执行不会停止。）</li>
<li>
<code>PDO::ERRMODE_EXCEPTION</code>: 抛出异常。它表示 PDO 引发的错误。你不应该<code>PDOException</code>从你自己的代码中抛出一个。有关 PHP 异常的更多信息，请参阅 <em>异常。</em><code>or die(mysql_error());</code>当它没有被捕获时，它的行为非常像。但与 不同的是<code>or die()</code>，<code>PDOException</code>如果您选择这样做，则可以优雅地捕获和处理。</li>
</ul>
<p><strong>好读</strong> ：</p>
<ul>
<li>错误和错误处理¶</li>
<li>PDOException 类 ¶</li>
<li>异常¶</li>
</ul>
<p>喜欢：</p>
<div class="code"><pre class="code literal-block"><span class="o">$</span><span class="nt">stmt-</span><span class="o">&gt;</span><span class="nt">setAttribute</span><span class="o">(</span><span class="w"> </span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ATTR_ERRMODE</span><span class="o">,</span><span class="w"> </span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ERRMODE_SILENT</span><span class="w"> </span><span class="o">);</span>
<span class="o">$</span><span class="nt">stmt-</span><span class="o">&gt;</span><span class="nt">setAttribute</span><span class="o">(</span><span class="w"> </span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ATTR_ERRMODE</span><span class="o">,</span><span class="w"> </span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ERRMODE_WARNING</span><span class="w"> </span><span class="o">);</span>
<span class="o">$</span><span class="nt">stmt-</span><span class="o">&gt;</span><span class="nt">setAttribute</span><span class="o">(</span><span class="w"> </span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ATTR_ERRMODE</span><span class="o">,</span><span class="w"> </span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ERRMODE_EXCEPTION</span><span class="w"> </span><span class="o">);</span>
</pre></div>

<p>您可以将其包装在<code>try</code>-中<code>catch</code>，如下所示：</p>
<div class="code"><pre class="code literal-block"><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//Connect as appropriate as above</span>
<span class="w">    </span><span class="err">$</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span><span class="s">'hi'</span><span class="p">);</span><span class="w"> </span><span class="c1">//Invalid query!</span>
<span class="p">}</span><span class="w"> </span>
<span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">PDOException</span><span class="w"> </span><span class="err">$</span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">echo</span><span class="w"> </span><span class="s">"An Error occured!"</span><span class="p">;</span><span class="w"> </span><span class="c1">//User friendly message/message you want to show to user</span>
<span class="w">    </span><span class="n">some_logging_function</span><span class="p">(</span><span class="err">$</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">getMessage</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>

<p>You do not have to handle with <code>try</code>-<code>catch</code> right now. You can catch it at
any time appropriate, but I strongly recommend you to use <code>try</code>-<code>catch</code>. Also
it may make more sense to catch it at outside the function that calls the
<code>PDO</code> stuff:</p>
<div class="code"><pre class="code literal-block"><span class="nt">function</span><span class="w"> </span><span class="nt">data_fun</span><span class="o">($</span><span class="nt">db</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">$stmt</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$db-&gt;query("SELECT</span><span class="w"> </span><span class="err">*</span><span class="w"> </span><span class="err">FROM</span><span class="w"> </span><span class="err">table")</span><span class="p">;</span>
<span class="w">    </span><span class="err">return</span><span class="w"> </span><span class="err">$stmt-&gt;fetchAll(</span><span class="n">PDO</span><span class="p">:</span><span class="o">:</span><span class="n">FETCH_ASSOC</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">//</span><span class="nt">Then</span><span class="w"> </span><span class="nt">later</span>
<span class="nt">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">data_fun($db)</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">catch</span><span class="o">(</span><span class="nt">PDOException</span><span class="w"> </span><span class="o">$</span><span class="nt">ex</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">//Here</span><span class="w"> </span><span class="err">you</span><span class="w"> </span><span class="err">can</span><span class="w"> </span><span class="err">handle</span><span class="w"> </span><span class="err">error</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">show</span><span class="w"> </span><span class="err">message/perform</span><span class="w"> </span><span class="err">action</span><span class="w"> </span><span class="err">you</span><span class="w"> </span><span class="err">want.</span>
<span class="p">}</span>
</pre></div>

<p>Also, you can handle by <code>or die()</code> or we can say like <code>mysql_*</code>, but it will
be really varied. You can hide the dangerous error messages in production by
turning <code>display_errors off</code> and just reading your error log.</p>
<p>Now, after reading all the things above, you are probably thinking: what the
heck is that when I just want to start leaning simple <code>SELECT</code>, <code>INSERT</code>,
<code>UPDATE</code>, or <code>DELETE</code> statements? Don't worry, here we go:</p>
<hr>
<h3>Selecting Data</h3>
<p><img alt="PDO 选择图像" src="../../images/AhIlC.png"></p>
<p>So what you are doing in <code>mysql_*</code> is:</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s1">'SELECT * from table'</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="nb">mysql_error</span><span class="p">());</span>

<span class="nv">$num_rows</span> <span class="o">=</span> <span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>

<span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'field1'</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>

<p>Now in <code>PDO</code>, you can do this like:</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>
<span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">'SELECT * FROM table'</span><span class="p">);</span>

<span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'field1'</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>

<p>Or</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>
<span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">'SELECT * FROM table'</span><span class="p">);</span>
<span class="nv">$results</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>

<span class="c1">//Use $results</span>
</pre></div>

<p><strong>Note</strong> : If you are using the method like below (<code>query()</code>), this method
returns a <code>PDOStatement</code> object. So if you want to fetch the result, use it
like above.</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>
<span class="k">foreach</span><span class="p">(</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">'SELECT * FROM table'</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'field1'</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>

<p>In PDO Data, it is obtained via the <code>-&gt;fetch()</code>, a method of your statement
handle. Before calling fetch, the best approach would be telling PDO how you’d
like the data to be fetched. In the below section I am explaining this.</p>
<h3>Fetch Modes</h3>
<p>Note the use of <code>PDO::FETCH_ASSOC</code> in the <code>fetch()</code> and <code>fetchAll()</code> code
above. This tells <code>PDO</code> to return the rows as an associative array with the
field names as keys. There are many other fetch modes too which I will explain
one by one.</p>
<p>First of all, I explain how to select fetch mode:</p>
<div class="code"><pre class="code literal-block"><span class="w"> </span><span class="err">$</span><span class="n">stmt</span><span class="o">-&gt;</span><span class="nf">fetch</span><span class="p">(</span><span class="n">PDO</span><span class="o">::</span><span class="n">FETCH_ASSOC</span><span class="p">)</span>
</pre></div>

<p>In the above, I have been using <code>fetch()</code>. You can also use:</p>
<ul>
<li>
<code>PDOStatement::fetchAll()</code> - Returns an array containing all of the result set rows</li>
<li>
<code>PDOStatement::fetchColumn()</code> - Returns a single column from the next row of a result set</li>
<li>
<code>PDOStatement::fetchObject()</code> - Fetches the next row and returns it as an object.</li>
<li>
<code>PDOStatement::setFetchMode()</code> - Set the default fetch mode for this statement</li>
</ul>
<p>Now I come to fetch mode:</p>
<ul>
<li>
<code>PDO::FETCH_ASSOC</code>: returns an array indexed by column name as returned in your result set</li>
<li>
<code>PDO::FETCH_BOTH</code> (default): returns an array indexed by both column name and 0-indexed column number as returned in your result set</li>
</ul>
<p>There are even more choices! Read about them all in <code>PDOStatement</code> Fetch
documentation..</p>
<p><strong>Getting the row count</strong> :</p>
<p>Instead of using <code>mysql_num_rows</code> to get the number of returned rows, you can
get a <code>PDOStatement</code> and do <code>rowCount()</code>, like:</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>
<span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">'SELECT * FROM table'</span><span class="p">);</span>
<span class="nv">$row_count</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">rowCount</span><span class="p">();</span>
<span class="k">echo</span> <span class="nv">$row_count</span><span class="o">.</span><span class="s1">' rows selected'</span><span class="p">;</span>
</pre></div>

<p><strong>Getting the Last Inserted ID</strong></p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">(</span><span class="s2">"INSERT INTO table(firstname, lastname) VAULES('John', 'Doe')"</span><span class="p">);</span>
<span class="nv">$insertId</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">lastInsertId</span><span class="p">();</span>
</pre></div>

<hr>
<h3>Insert and Update or Delete statements</h3>
<p><img alt="插入和更新 PDO 映像" src="../../images/yQhPC.png"></p>
<p>What we are doing in <code>mysql_*</code> function is:</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>
<span class="nv">$results</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s2">"UPDATE table SET field='value'"</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="nb">mysql_error</span><span class="p">());</span>
<span class="k">echo</span> <span class="nb">mysql_affected_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
</pre></div>

<p>And in pdo, this same thing can be done by:</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>
<span class="nv">$affected_rows</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">(</span><span class="s2">"UPDATE table SET field='value'"</span><span class="p">);</span>
<span class="k">echo</span> <span class="nv">$affected_rows</span><span class="p">;</span>
</pre></div>

<p>In the above query <code>PDO::exec</code> execute an SQL statement and returns the number
of affected rows.</p>
<p><em>Insert and delete will be covered later.</em></p>
<p>The above method is only useful when you are not using variable in query. But
when you need to use a variable in a query, do not ever ever try like the
above and there for <strong>prepared statement or parameterized statement</strong> is.</p>
<hr>
<h3><strong>Prepared Statements</strong></h3>
<p><strong>Q.</strong> What is a prepared statement and why do I need them?<br><strong>A.</strong> A prepared statement is a pre-compiled SQL statement that can be
executed multiple times by sending only the data to the server.  </p>
<p>The typical workflow of using a prepared statement is as follows (quoted from
Wikipedia three 3 point):</p>
<ol>
<li>
<strong>Prepare</strong> : The statement template is created by the application and sent to the database management system (DBMS). Certain values are left unspecified, called parameters, placeholders or bind variables (labelled <code>?</code> below):</li>
</ol>
<p><code>INSERT INTO PRODUCT (name, price) VALUES (?, ?)</code></p>
<ol>
<li>
<p>The DBMS parses, compiles, and performs query optimization on the statement template, and stores the result without executing it.</p>
</li>
<li>
<p><strong>Execute</strong> : At a later time, the application supplies (or binds) values for the parameters, and the DBMS executes the statement (possibly returning a result). The application may execute the statement as many times as it wants with different values. In this example, it might supply 'Bread' for the first parameter and <code>1.00</code> for the second parameter.</p>
</li>
</ol>
<p>You can use a prepared statement by including placeholders in your SQL. There
are basically three ones without placeholders (don't try this with variable
its above one), one with unnamed placeholders, and one with named
placeholders.</p>
<p><strong>Q.</strong> So now, what are named placeholders and how do I use them?<br><strong>A.</strong> Named placeholders. Use descriptive names preceded by a colon, instead
of question marks. We don't care about position/order of value in name place
holder:</p>
<div class="code"><pre class="code literal-block"><span class="w"> </span><span class="err">$</span><span class="n">stmt</span><span class="o">-&gt;</span><span class="n">bindParam</span><span class="p">(</span><span class="s">':bla'</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">bla</span><span class="p">);</span>
</pre></div>

<p><code>bindParam(parameter,variable,data_type,length,driver_options)</code></p>
<p>You can also bind using an execute array as well:</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>
<span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"SELECT * FROM table WHERE id=:id AND name=:name"</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">':name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">,</span> <span class="s1">':id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span>
<span class="nv">$rows</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>
</pre></div>

<p>Another nice feature for <code>OOP</code> friends is that named placeholders have the
ability to insert objects directly into your database, assuming the properties
match the named fields. For example:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="n">person</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="o">$</span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="o">$</span><span class="n">add</span><span class="p">;</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(</span><span class="o">$</span><span class="n">a</span><span class="p">,</span><span class="o">$</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">a</span><span class="p">;</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
<span class="o">$</span><span class="n">demo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">person</span><span class="p">(</span><span class="s1">'john'</span><span class="p">,</span><span class="s1">'29 bla district'</span><span class="p">);</span>
<span class="o">$</span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s2">"INSERT INTO table (name, add) value (:name, :add)"</span><span class="p">);</span>
<span class="o">$</span><span class="n">stmt</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">((</span><span class="n">array</span><span class="p">)</span><span class="o">$</span><span class="n">demo</span><span class="p">);</span>
</pre></div>

<p><strong>Q.</strong> So now, what are unnamed placeholders and how do I use them?<br><strong>A.</strong> Let's have an example:</p>
<div class="code"><pre class="code literal-block"><span class="cp">&lt;?php</span>
<span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"INSERT INTO folks (name, add) values (?, ?)"</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$name</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_STR</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindValue</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nv">$add</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_STR</span><span class="p">);</span>
<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
</pre></div>

<p>and</p>
<div class="code"><pre class="code literal-block"><span class="err">$</span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">"INSERT INTO folks (name, add) values (?, ?)"</span><span class="p">);</span>
<span class="err">$</span><span class="n">stmt</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="s">'john'</span><span class="p">,</span><span class="w"> </span><span class="s">'29 bla district'</span><span class="p">));</span>
</pre></div>

<p>In the above, you can see those <code>?</code> instead of a name like in a name place
holder. Now in the first example, we assign variables to the various
placeholders (<code>$stmt-&gt;bindValue(1, $name, PDO::PARAM_STR);</code>). Then, we assign
values to those placeholders and execute the statement. In the second example,
the first array element goes to the first <code>?</code> and the second to the second
<code>?</code>.</p>
<p><strong>NOTE</strong> : In <strong>unnamed placeholders</strong> we must take care of the proper order
of the elements in the array that we are passing to the
<code>PDOStatement::execute()</code> method.</p>
<hr>
<h3>
<code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code> prepared queries</h3>
<ol>
<li>
<p><strong><code>SELECT</code></strong> :</p>
<div class="code"><pre class="code literal-block"><span class="err">$</span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">"SELECT * FROM table WHERE id=:id AND name=:name"</span><span class="p">);</span>
</pre></div>

<p>$stmt-&gt;execute(array(':name' =&gt; $name, ':id' =&gt; $id));
$rows = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC);</p>
</li>
<li>
<p><strong><code>INSERT</code></strong> :</p>
<div class="code"><pre class="code literal-block"><span class="err">$</span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">"INSERT INTO table(field1,field2) VALUES(:field1,:field2)"</span><span class="p">);</span>
</pre></div>

<p>$stmt-&gt;execute(array(':field1' =&gt; $field1, ':field2' =&gt; $field2));
$affected_rows = $stmt-&gt;rowCount();</p>
</li>
<li>
<p><strong><code>DELETE</code></strong> :</p>
<div class="code"><pre class="code literal-block"><span class="err">$</span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">"DELETE FROM table WHERE id=:id"</span><span class="p">);</span>
</pre></div>

<p>$stmt-&gt;bindValue(':id', $id, PDO::PARAM_STR);
$stmt-&gt;execute();
$affected_rows = $stmt-&gt;rowCount();</p>
</li>
<li>
<p><strong><code>UPDATE</code></strong> :</p>
<div class="code"><pre class="code literal-block"><span class="err">$</span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">"UPDATE table SET name=? WHERE id=?"</span><span class="p">);</span>
</pre></div>

<p>$stmt-&gt;execute(array($name, $id));
$affected_rows = $stmt-&gt;rowCount();</p>
</li>
</ol>
<hr>
<h3><strong>NOTE:</strong></h3>
<p>However <code>PDO</code> and/or <code>MySQLi</code> are not completely safe. Check the answer <em>Are
PDO prepared statements sufficient to prevent SQL injection?</em> by ircmaxell.
Also, I am quoting some part from his answer:</p>
<div class="code"><pre class="code literal-block"><span class="o">$</span><span class="nt">pdo-</span><span class="o">&gt;</span><span class="nt">setAttribute</span><span class="o">(</span><span class="nt">PDO</span><span class="p">::</span><span class="nd">ATTR_EMULATE_PREPARES</span><span class="o">,</span><span class="w"> </span><span class="nt">false</span><span class="o">);</span>
<span class="o">$</span><span class="nt">pdo-</span><span class="o">&gt;</span><span class="nt">query</span><span class="o">(</span><span class="s1">'SET NAMES GBK'</span><span class="o">);</span>
<span class="o">$</span><span class="nt">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="nt">pdo-</span><span class="o">&gt;</span><span class="nt">prepare</span><span class="o">(</span><span class="s2">"SELECT * FROM test WHERE name = ? LIMIT 1"</span><span class="o">);</span>
<span class="o">$</span><span class="nt">stmt-</span><span class="o">&gt;</span><span class="nt">execute</span><span class="o">(</span><span class="nt">array</span><span class="o">(</span><span class="nt">chr</span><span class="o">(</span><span class="nt">0xbf</span><span class="o">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nt">chr</span><span class="o">(</span><span class="nt">0x27</span><span class="o">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s2">" OR 1=1 /*"</span><span class="o">));</span>
</pre></div>

<p><br><br><a href="../why-shouldn-t-i-use-mysql-functions-in-php/">查看原文</a></p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/mysql/" rel="tag">mysql</a></li>
            <li><a class="tag p-category" href="../../categories/php/" rel="tag">php</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../zi-zhi-ruan-jian-an-zhuang-te-ding-ban-ben-de-gong-shi/" rel="prev" title="自制软件安装特定版本的公式？">Previous post</a>
            </li>
            <li class="next">
                <a href="../ru-he-zai-javascript-zhong-huo-qu-cha-xun-zi-fu-chuan-zhi/" rel="next" title="如何在 JavaScript 中获取查询字符串值？">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
