<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>什么是 NullReferenceException，我该如何修复它？ | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/shi-yao-shi-nullreferenceexception-wo-gai-ru-he-xiu-fu-ta/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../huo-qu-shi-li-de-lei-ming/" title="获取实例的类名" type="text/html">
<link rel="next" href="../addtransient-addscoped-he-addsingleton-fu-wu-chai-yi/" title="AddTransient、AddScoped 和 AddSingleton 服务差异" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="什么是 NullReferenceException，我该如何修复它？">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/shi-yao-shi-nullreferenceexception-wo-gai-ru-he-xiu-fu-ta/">
<meta property="og:description" content="这个问题的答案是 社区的努力。编辑现有答案以改进这篇文章。它目前不接受新的答案或互动。
我有一些代码，当它执行时，它抛出一个NullReferenceException，说：

你调用的对象是空的。

这是什么意思，我该怎么做才能解决这个错误？

解答
是什么原因？
底线
您正在尝试使用null（或Nothing在 VB.NET 中）的东西。这意味着您要么将其设置为null，要么根本不将其设置为任">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-16T23:49:06+08:00">
<meta property="article:tag" content=".net">
<meta property="article:tag" content="cSharp">
<meta property="article:tag" content="null">
<meta property="article:tag" content="nullreferenceexception">
<meta property="article:tag" content="vb.net">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">什么是 NullReferenceException，我该如何修复它？</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T23:49:06+08:00" itemprop="datePublished" title="2023-02-16 23:49">2023-02-16 23:49</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p><strong>这个问题的答案是 社区的努力</strong>。编辑现有答案以改进这篇文章。它目前不接受新的答案或互动。</p>
<p>我有一些代码，当它执行时，它抛出一个<code>NullReferenceException</code>，说：</p>
<blockquote>
<p>你调用的对象是空的。</p>
</blockquote>
<p>这是什么意思，我该怎么做才能解决这个错误？</p>
<p><br><br></p>
<h2>解答</h2>
<h2>是什么原因？</h2>
<h3>底线</h3>
<p>您正在尝试使用<code>null</code>（或<code>Nothing</code>在 VB.NET 中）的东西。这意味着您要么将其设置为<code>null</code>，要么根本不将其设置为任何内容。</p>
<p>像其他任何东西一样，<code>null</code>被传来传去。如果它<code>null</code> <em>在方法“A”中</em> ，则可能是方法“B”将 a 传递<code>null</code> <em>给</em> 方法“A”。</p>
<p><code>null</code>可以有不同的含义：</p>
<ol>
<li>
<strong>未初始化的</strong> 对象变量，因此 <strong>指向任何内容。</strong> 在这种情况下，如果您访问此类对象的成员，则会导致<code>NullReferenceException</code>.</li>
<li>开发人员有意 <strong>使用<code>null</code>它来表示没有可用的有意义的值。</strong>请注意，C# 具有变量的可为空数据类型的概念（例如数据库表可以具有可为空的字段） - 您可以分配<code>null</code>给它们以指示其中没有存储值，例如<code>int? a = null;</code>（这是 的快捷方式<code>Nullable&lt;int&gt; a = null;</code>）其中问号表示允许存储<code>null</code>在变量中<code>a</code>。您可以使用<code>if (a.HasValue) {...}</code>或 使用 来检查<code>if (a==null) {...}</code>。可以为空的变量，就像<code>a</code>这个例子，允许通过<code>a.Value</code>显式访问值，或者像平常一样通过<code>a</code>. <br><strong>请注意</strong> ，通过<code>a.Value</code>throws
an<code>InvalidOperationException</code>而不是<code>NullReferenceException</code>if访问它<code>a</code>是<code>null</code>-
您应该事先进行检查，即如果您有另一个不可为空的变量，那么您应该进行类似或更短的<code>int b;</code>赋值。<code>if (a.HasValue) { b =
a.Value; }``if (a != null) { b = a; }</code>
</li>
</ol>
<p>本文的其余部分将更详细地介绍许多程序员经常犯的错误，这些错误可能会导致<code>NullReferenceException</code>.</p>
<h3>进一步来说</h3>
<p>抛出<code>runtime</code>a<code>NullReferenceException</code> <strong>总是</strong>
意味着同一件事：您正在尝试使用一个引用，并且该引用未被初始化（或者它曾经被 <em>初始化</em> ，但 <em>不再</em> 被初始化）。</p>
<p>这意味着引用是<code>null</code>，您不能通过引用访问成员（例如方法）<code>null</code>。最简单的情况：</p>
<div class="code"><pre class="code literal-block"><span class="nv">string</span><span class="w"> </span><span class="nv">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">null</span><span class="c1">;</span>
<span class="nv">foo</span>.<span class="k">ToUpper</span><span class="ss">()</span><span class="c1">;</span>
</pre></div>

<p>这将<code>NullReferenceException</code>在第二行抛出一个，因为您不能<code>ToUpper()</code>在<code>string</code>指向
的引用上调用实例方法<code>null</code>。</p>
<h2>调试</h2>
<p>你如何找到 a 的来源<code>NullReferenceException</code>？除了查看将在异常发生的位置准确抛出的异常本身之外，还适用 Visual Studio
中调试的一般规则：放置战略断点并检查变量，方法是将鼠标悬停在它们的名称上，打开( Quick)Watch 窗口或使用各种调试面板，如 Locals 和
Autos。</p>
<p>如果您想找出参考在哪里设置或没有设置，请右键单击其名称并选择“查找所有参考”。然后，您可以在每个找到的位置放置一个断点，并在附加调试器的情况下运行您的程序。每次调试器在这样的断点处中断时，您都需要确定您是否希望引用为非空，检查变量，并验证它是否指向您期望的实例。</p>
<p>通过这种方式遵循程序流程，您可以找到实例不应该为 null 的位置，以及为什么它没有正确设置。</p>
<h2>例子</h2>
<p>可能抛出异常的一些常见场景：</p>
<h4>通用的</h4>
<div class="code"><pre class="code literal-block">ref1.ref2.ref3.member
</pre></div>

<p>如果 ref1 或 ref2 或 ref3 为空，那么您将得到一个<code>NullReferenceException</code>.
如果您想解决问题，请通过将表达式重写为更简单的等效表达式来找出哪个为空：</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ref1</span><span class="p">;</span>
<span class="k">var</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r1</span><span class="o">.</span><span class="n">ref2</span><span class="p">;</span>
<span class="k">var</span><span class="w"> </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r2</span><span class="o">.</span><span class="n">ref3</span><span class="p">;</span>
<span class="n">r3</span><span class="o">.</span><span class="n">member</span>
</pre></div>

<p>具体来说，在
中<code>HttpContext.Current.User.Identity.Name</code>，<code>HttpContext.Current</code>可能为空，或者<code>User</code>属性可能为空，或者<code>Identity</code>属性可能为空。</p>
<h4>间接</h4>
<div class="code"><pre class="code literal-block">public class Person 
{
    public int Age { get; set; }
}
public class Book 
{
    public Person Author { get; set; }
}
public class Example 
{
    public void Foo() 
    {
        Book b1 = new Book();
        int authorAge = b1.Author.Age; // You never initialized the Author property.
                                       // there is no Person to get an Age from.
    }
}
</pre></div>

<p>如果你想避免子（Person）空引用，你可以在父（Book）对象的构造函数中初始化它。</p>
<h4>嵌套对象初始化器</h4>
<p>这同样适用于嵌套对象初始值设定项：</p>
<div class="code"><pre class="code literal-block">Book b1 = new Book 
{ 
   Author = { Age = 45 } 
};
</pre></div>

<p>这转化为：</p>
<div class="code"><pre class="code literal-block">Book b1 = new Book();
b1.Author.Age = 45;
</pre></div>

<p>使用关键字时<code>new</code>，它只是创建了一个新的实例<code>Book</code>，而不是一个新的实例<code>Person</code>，所以<code>Author</code>属性仍然是<code>null</code>。</p>
<h4>嵌套集合初始化器</h4>
<div class="code"><pre class="code literal-block">public class Person 
{
    public ICollection&lt;Book&gt; Books { get; set; }
}
public class Book 
{
    public string Title { get; set; }
}
</pre></div>

<p>嵌套集合的<code>Initializers</code>行为相同：</p>
<div class="code"><pre class="code literal-block">Person p1 = new Person 
{
    Books = {
         new Book { Title = "Title1" },
         new Book { Title = "Title2" },
    }
};
</pre></div>

<p>这转化为：</p>
<div class="code"><pre class="code literal-block">Person p1 = new Person();
p1.Books.Add(new Book { Title = "Title1" });
p1.Books.Add(new Book { Title = "Title2" });
</pre></div>

<p>只<code>new
Person</code>创建一个实例<code>Person</code>，但<code>Books</code>集合仍然是<code>null</code>。集合<code>Initializer</code>语法不会为创建集合<code>p1.Books</code>，它只会转换为<code>p1.Books.Add(...)</code>语句。</p>
<h4>大批</h4>
<div class="code"><pre class="code literal-block">int[] numbers = null;
int n = numbers[0]; // numbers is null. There is no array to index.
</pre></div>

<h4>数组元素</h4>
<div class="code"><pre class="code literal-block"><span class="nv">Person</span>[]<span class="w"> </span><span class="nv">people</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">Person</span>[<span class="mi">5</span>]<span class="c1">;</span>
<span class="nv">people</span>[<span class="mi">0</span>].<span class="nv">Age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nv">people</span>[<span class="mi">0</span>]<span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">null</span>.<span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">array</span><span class="w"> </span><span class="nv">was</span><span class="w"> </span><span class="nv">allocated</span><span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">not</span>
<span class="w">                   </span><span class="o">//</span><span class="w"> </span><span class="nv">initialized</span>.<span class="w"> </span><span class="nv">There</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">no</span><span class="w"> </span><span class="nv">Person</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">set</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">Age</span><span class="w"> </span><span class="k">for</span>.
</pre></div>

<h4>锯齿状阵列</h4>
<div class="code"><pre class="code literal-block">long[][] array = new long[1][];
array[0][0] = 3; // is null because only the first dimension is yet initialized.
                 // Use array[0] = new long[2]; first.
</pre></div>

<h4>收藏/列表/字典</h4>
<div class="code"><pre class="code literal-block">Dictionary&lt;string, int&gt; agesForNames = null;
int age = agesForNames["Bob"]; // agesForNames is null.
                               // There is no Dictionary to perform the lookup.
</pre></div>

<h4>范围变量（间接/延迟）</h4>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">Person</span><span class="w"> </span>
<span class="p">{</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">get</span><span class="p">;</span><span class="w"> </span><span class="n">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="k">var</span><span class="w"> </span><span class="n">people</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">people</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="nb nb-Type">null</span><span class="p">);</span>
<span class="k">var</span><span class="w"> </span><span class="n">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">people</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">Name</span><span class="p">;</span>
<span class="n">string</span><span class="w"> </span><span class="n">firstName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">names</span><span class="o">.</span><span class="n">First</span><span class="p">();</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">thrown</span><span class="w"> </span><span class="n">here</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">actually</span><span class="w"> </span><span class="n">occurs</span>
<span class="w">                                  </span><span class="o">//</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="n">above</span><span class="o">.</span><span class="w">  </span><span class="s2">"p"</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">the</span>
<span class="w">                                  </span><span class="o">//</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">added</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="o">.</span>
</pre></div>

<h4>事件 (C#)</h4>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">class</span><span class="w"> </span><span class="nv">Demo</span>
{
<span class="w">    </span><span class="nv">public</span><span class="w"> </span><span class="nv">event</span><span class="w"> </span><span class="nv">EventHandler</span><span class="w"> </span><span class="nv">StateChanged</span><span class="c1">;</span>

<span class="w">    </span><span class="nv">protected</span><span class="w"> </span><span class="nv">virtual</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">OnStateChanged</span><span class="ss">(</span><span class="nv">EventArgs</span><span class="w"> </span><span class="nv">e</span><span class="ss">)</span>
<span class="w">    </span>{<span class="w">        </span>
<span class="w">        </span><span class="nv">StateChanged</span><span class="ss">(</span><span class="nv">this</span>,<span class="w"> </span><span class="nv">e</span><span class="ss">)</span><span class="c1">; // Exception is thrown here </span>
<span class="w">                               </span><span class="o">//</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">no</span><span class="w"> </span><span class="nv">event</span><span class="w"> </span><span class="nv">handlers</span><span class="w"> </span><span class="nv">have</span><span class="w"> </span><span class="nv">been</span><span class="w"> </span><span class="nv">attached</span>
<span class="w">                               </span><span class="o">//</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">StateChanged</span><span class="w"> </span><span class="nv">event</span>
<span class="w">    </span>}
}
</pre></div>

<p>（注意：VB.NET 编译器为事件使用插入空值检查，所以在 VB.NET 中没有必要检查事件<code>Nothing</code>。）</p>
<h4>错误的命名约定：</h4>
<p>如果您以不同于本地人的方式命名字段，您可能已经意识到您从未初始化过该字段。</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">class</span><span class="w"> </span><span class="nv">Form1</span>
{
<span class="w">    </span><span class="nv">private</span><span class="w"> </span><span class="nv">Customer</span><span class="w"> </span><span class="nv">customer</span><span class="c1">;</span>

<span class="w">    </span><span class="nv">private</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">Form1_Load</span><span class="ss">(</span><span class="nv">object</span><span class="w"> </span><span class="nv">sender</span>,<span class="w"> </span><span class="nv">EventArgs</span><span class="w"> </span><span class="nv">e</span><span class="ss">)</span><span class="w"> </span>
<span class="w">    </span>{
<span class="w">        </span><span class="nv">Customer</span><span class="w"> </span><span class="nv">customer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">Customer</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">        </span><span class="nv">customer</span>.<span class="nv">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"John"</span><span class="c1">;</span>
<span class="w">    </span>}

<span class="w">    </span><span class="nv">private</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">Button_Click</span><span class="ss">(</span><span class="nv">object</span><span class="w"> </span><span class="nv">sender</span>,<span class="w"> </span><span class="nv">EventArgs</span><span class="w"> </span><span class="nv">e</span><span class="ss">)</span>
<span class="w">    </span>{
<span class="w">        </span><span class="k">MessageBox</span>.<span class="k">Show</span><span class="ss">(</span><span class="nv">customer</span>.<span class="nv">Name</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span>}
}
</pre></div>

<p>这可以通过遵循以下划线前缀字段的约定来解决：</p>
<div class="code"><pre class="code literal-block">    private Customer _customer;
</pre></div>

<h4>ASP.NET 页面生命周期：</h4>
<div class="code"><pre class="code literal-block"><span class="n">public</span><span class="w"> </span><span class="n">partial</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">Issues_Edit</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">System</span><span class="o">.</span><span class="n">Web</span><span class="o">.</span><span class="n">UI</span><span class="o">.</span><span class="n">Page</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="n">TestIssue</span><span class="w"> </span><span class="n">myIssue</span><span class="p">;</span>

<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">Page_Load</span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">EventArgs</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsPostBack</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">             </span><span class="o">//</span><span class="w"> </span><span class="n">Only</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="nb">load</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="n">clicked</span>
<span class="w">             </span><span class="n">myIssue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">TestIssue</span><span class="p">();</span><span class="w"> </span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">SaveButton_Click</span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">EventArgs</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">myIssue</span><span class="o">.</span><span class="n">Entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"NullReferenceException here!"</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h4>ASP.NET 会话值</h4>
<div class="code"><pre class="code literal-block"><span class="c1">// if the "FirstName" session value has not yet been set,</span>
<span class="c1">// then this line will throw a NullReferenceException</span>
<span class="nb">string</span><span class="w"> </span><span class="n">firstName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Session</span><span class="p">[</span><span class="s">"FirstName"</span><span class="p">].</span><span class="n">ToString</span><span class="p">();</span>
</pre></div>

<h4>ASP.NET MVC 空视图模型</h4>
<p>If the exception occurs when referencing a property of <code>@Model</code> in an <code>ASP.NET
MVC View</code>, you need to understand that the <code>Model</code> gets set in your action
method, when you <code>return</code> a view. When you return an empty model (or model
property) from your controller, the exception occurs when the views access it:</p>
<div class="code"><pre class="code literal-block">//<span class="w"> </span>Controller
public<span class="w"> </span>class<span class="w"> </span>Restaurant:Controller
{
<span class="w">    </span>public<span class="w"> </span>ActionResult<span class="w"> </span>Search()
<span class="w">    </span>{
<span class="w">        </span>return<span class="w"> </span>View();<span class="w">  </span>//<span class="w"> </span>Forgot<span class="w"> </span>the<span class="w"> </span>provide<span class="w"> </span>a<span class="w"> </span>Model<span class="w"> </span>here.
<span class="w">    </span>}
}

//<span class="w"> </span>Razor<span class="w"> </span>view<span class="w"> </span>
@foreach<span class="w"> </span>(var<span class="w"> </span>restaurantSearch<span class="w"> </span>in<span class="w"> </span>Model.RestaurantSearch)<span class="w">  </span>//<span class="w"> </span>Throws.
{
}

<span class="nt">&lt;p&gt;</span>@Model.somePropertyName<span class="nt">&lt;/p&gt;</span><span class="w"> </span><span class="cm">&lt;!-- Also throws --&gt;</span>
</pre></div>

<h4>WPF Control Creation Order and Events</h4>
<p><code>WPF</code> controls are created during the call to <code>InitializeComponent</code> in the
order they appear in the visual tree. A <code>NullReferenceException</code> will be
raised in the case of early-created controls with event handlers, etc., that
fire during <code>InitializeComponent</code> which reference late-created controls.</p>
<p>For example:</p>
<div class="code"><pre class="code literal-block"><span class="nt">&lt;Grid&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- Combobox declared first --&gt;</span>
<span class="w">    </span><span class="nt">&lt;ComboBox</span><span class="w"> </span><span class="na">Name=</span><span class="s">"comboBox1"</span><span class="w"> </span>
<span class="w">              </span><span class="na">Margin=</span><span class="s">"10"</span>
<span class="w">              </span><span class="na">SelectedIndex=</span><span class="s">"0"</span><span class="w"> </span>
<span class="w">              </span><span class="na">SelectionChanged=</span><span class="s">"comboBox1_SelectionChanged"</span><span class="nt">&gt;</span>
<span class="w">       </span><span class="nt">&lt;ComboBoxItem</span><span class="w"> </span><span class="na">Content=</span><span class="s">"Item 1"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">       </span><span class="nt">&lt;ComboBoxItem</span><span class="w"> </span><span class="na">Content=</span><span class="s">"Item 2"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">       </span><span class="nt">&lt;ComboBoxItem</span><span class="w"> </span><span class="na">Content=</span><span class="s">"Item 3"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/ComboBox&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- Label declared later --&gt;</span>
<span class="w">    </span><span class="nt">&lt;Label</span><span class="w"> </span><span class="na">Name=</span><span class="s">"label1"</span><span class="w"> </span>
<span class="w">           </span><span class="na">Content=</span><span class="s">"Label"</span>
<span class="w">           </span><span class="na">Margin=</span><span class="s">"10"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/Grid&gt;</span>
</pre></div>

<p>Here <code>comboBox1</code> is created before <code>label1</code>. If <code>comboBox1_SelectionChanged</code>
attempts to reference `label1, it will not yet have been created.</p>
<div class="code"><pre class="code literal-block">private void comboBox1_SelectionChanged(object sender, SelectionChangedEventArgs e)
{
    label1.Content = comboBox1.SelectedIndex.ToString(); // NullReferenceException here!!
}
</pre></div>

<p>Changing the order of the declarations in the <code>XAML</code> (i.e., listing <code>label1</code>
before <code>comboBox1</code>, ignoring issues of design philosophy) would at least
resolve the <code>NullReferenceException</code> here.</p>
<h4>Cast with <code>as</code>
</h4>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">myThing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">someObject</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Thing</span><span class="p">;</span>
</pre></div>

<p>This doesn't throw an <code>InvalidCastException</code> but returns a <code>null</code> when the
cast fails (and when <code>someObject</code> is itself null). So be aware of that.</p>
<h4>LINQ <code>FirstOrDefault()</code> and <code>SingleOrDefault()</code>
</h4>
<p>The plain versions <code>First()</code> and <code>Single()</code> throw exceptions when there is
nothing. The "OrDefault" versions return <code>null</code> in that case. So be aware of
that.</p>
<h4>foreach</h4>
<p><code>foreach</code> throws when you try to iterate on a <code>null</code> collection. Usually
caused by unexpected <code>null</code> result from methods that return collections.</p>
<div class="code"><pre class="code literal-block"><span class="n">List</span><span class="o">&lt;</span><span class="nb nb-Type">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span><span class="w">    </span>
<span class="n">foreach</span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">NullReferenceException</span><span class="w"> </span><span class="n">here</span>
</pre></div>

<p>More realistic example - select nodes from XML document. Will throw if nodes
are not found but initial debugging shows that all properties valid:</p>
<div class="code"><pre class="code literal-block"><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="k">var</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">myData</span><span class="o">.</span><span class="n">MyXml</span><span class="o">.</span><span class="n">DocumentNode</span><span class="o">.</span><span class="n">SelectNodes</span><span class="p">(</span><span class="s2">"//Data"</span><span class="p">))</span>
</pre></div>

<hr>
<h2>Ways to Avoid</h2>
<h4>Explicitly check for <code>null</code> and ignore <code>null</code> values.</h4>
<p>If you expect the reference sometimes to be <code>null</code>, you can check for it being
<code>null</code> before accessing instance members:</p>
<div class="code"><pre class="code literal-block"><span class="nv">void</span><span class="w"> </span><span class="nv">PrintName</span><span class="ss">(</span><span class="nv">Person</span><span class="w"> </span><span class="nv">p</span><span class="ss">)</span>
{
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span><span class="w"> </span>
<span class="w">    </span>{
<span class="w">        </span><span class="nv">Console</span>.<span class="nv">WriteLine</span><span class="ss">(</span><span class="nv">p</span>.<span class="nv">Name</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span>}
}
</pre></div>

<h4>Explicitly check for <code>null</code> and provide a default value.</h4>
<p>Methods you call expecting an instance can return <code>null</code>, for example when the
object being sought cannot be found. You can choose to return a default value
when this is the case:</p>
<div class="code"><pre class="code literal-block"><span class="nv">string</span><span class="w"> </span><span class="nv">GetCategory</span><span class="ss">(</span><span class="nv">Book</span><span class="w"> </span><span class="nv">b</span><span class="ss">)</span><span class="w"> </span>
{
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s2">"Unknown"</span><span class="c1">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">b</span>.<span class="nv">Category</span><span class="c1">;</span>
}
</pre></div>

<h4>Explicitly check for <code>null</code> from method calls and throw a custom</h4>
<p>exception.</p>
<p>You can also throw a custom exception, only to catch it in the calling code:</p>
<div class="code"><pre class="code literal-block"><span class="n">string</span><span class="w"> </span><span class="n">GetCategory</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">bookTitle</span><span class="p">)</span><span class="w"> </span>
<span class="p">{</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">library</span><span class="o">.</span><span class="n">FindBook</span><span class="p">(</span><span class="n">bookTitle</span><span class="p">);</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">book</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">)</span>
<span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">BookNotFoundException</span><span class="p">(</span><span class="n">bookTitle</span><span class="p">);</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">custom</span><span class="w"> </span><span class="n">exception</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">book</span><span class="o">.</span><span class="n">Category</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<h4>Use <code>Debug.Assert</code> if a value should never be <code>null</code>, to catch the problem</h4>
<p>earlier than the exception occurs.</p>
<p>When you know during development that a method could, but never should return
<code>null</code>, you can use <code>Debug.Assert()</code> to break as soon as possible when it does
occur:</p>
<div class="code"><pre class="code literal-block"><span class="n">string</span><span class="w"> </span><span class="n">GetTitle</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">knownBookID</span><span class="p">)</span><span class="w"> </span>
<span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="n">know</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="o">.</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">library</span><span class="o">.</span><span class="n">GetBook</span><span class="p">(</span><span class="n">knownBookID</span><span class="p">);</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">occur</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">method</span><span class="o">.</span>
<span class="w">    </span><span class="n">Debug</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">book</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">,</span><span class="w"> </span><span class="s2">"Library didn't return a book for known book ID."</span><span class="p">);</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">code</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">book</span><span class="o">.</span><span class="n">Title</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Will</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">NullReferenceException</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Debug</span><span class="w"> </span><span class="n">mode</span><span class="o">.</span>
<span class="p">}</span>
</pre></div>

<p>Though this check will not end up in your release build, causing it to throw
the <code>NullReferenceException</code> again when <code>book == null</code> at runtime in release
mode.</p>
<h4>Use <code>GetValueOrDefault()</code> for <code>nullable</code> value types to provide a default</h4>
<p>value when they are <code>null</code>.</p>
<div class="code"><pre class="code literal-block">DateTime? appointment = null;
Console.WriteLine(appointment.GetValueOrDefault(DateTime.Now));
// Will display the default value provided (DateTime.Now), because appointment is null.

appointment = new DateTime(2022, 10, 20);
Console.WriteLine(appointment.GetValueOrDefault(DateTime.Now));
// Will display the appointment date, not the default
</pre></div>

<h4>Use the null coalescing operator: <code>??</code> [C#] or <code>If()</code> [VB].</h4>
<p>The shorthand to providing a default value when a <code>null</code> is encountered:</p>
<div class="code"><pre class="code literal-block"><span class="n">IService</span><span class="w"> </span><span class="n">CreateService</span><span class="p">(</span><span class="n">ILogger</span><span class="w"> </span><span class="nb">log</span><span class="p">,</span><span class="w"> </span><span class="n">Int32</span><span class="err">?</span><span class="w"> </span><span class="n">frobPowerLevel</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="k">var</span><span class="w"> </span><span class="n">serviceImpl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MyService</span><span class="p">(</span><span class="nb">log</span><span class="w"> </span><span class="err">??</span><span class="w"> </span><span class="n">NullLog</span><span class="o">.</span><span class="n">Instance</span><span class="p">);</span>

<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">Note</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">above</span><span class="w"> </span><span class="s2">"GetValueOrDefault()"</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">rewritten</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">use</span>
<span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">coalesce</span><span class="w"> </span><span class="n">operator</span><span class="p">:</span>
<span class="w">   </span><span class="n">serviceImpl</span><span class="o">.</span><span class="n">FrobPowerLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frobPowerLevel</span><span class="w"> </span><span class="err">??</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<h4>Use the null condition operator: <code>?.</code> or <code>?[x]</code> for arrays (available in</h4>
<p>C# 6 and VB.NET 14):</p>
<p>This is also sometimes called the safe navigation or Elvis (after its shape)
operator. If the expression on the left side of the operator is null, then the
right side will not be evaluated, and null is returned instead. That means
cases like this:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">person</span><span class="o">.</span><span class="n">Title</span><span class="o">.</span><span class="n">ToUpper</span><span class="p">();</span>
</pre></div>

<p>If the person does not have a title, this will throw an exception because it
is trying to call <code>ToUpper</code> on a property with a null value.</p>
<p>In <code>C# 5</code> and below, this can be guarded with:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">person</span><span class="o">.</span><span class="n">Title</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="err">?</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">person</span><span class="o">.</span><span class="n">Title</span><span class="o">.</span><span class="n">ToUpper</span><span class="p">();</span>
</pre></div>

<p>Now the title variable will be null instead of throwing an exception. C# 6
introduces a shorter syntax for this:</p>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">person</span><span class="o">.</span><span class="n">Title</span><span class="err">?</span><span class="o">.</span><span class="n">ToUpper</span><span class="p">();</span>
</pre></div>

<p>This will result in the title variable being <code>null</code>, and the call to <code>ToUpper</code>
is not made if <code>person.Title</code> is <code>null</code>.</p>
<p>Of course, you <em>still</em> have to check <code>title</code> for <code>null</code> or use the null
condition operator together with the null coalescing operator (<code>??</code>) to supply
a default value:</p>
<div class="code"><pre class="code literal-block"><span class="c1">// regular null check</span>
<span class="nb">int</span><span class="w"> </span><span class="n">titleLength</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">title</span><span class="w"> </span>!<span class="p">=</span><span class="w"> </span><span class="nb">null</span><span class="p">)</span>
<span class="w">    </span><span class="n">titleLength</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">title</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span><span class="w"> </span><span class="c1">// If title is null, this would throw NullReferenceException</span>

<span class="c1">// combining the `?` and the `??` operator</span>
<span class="nb">int</span><span class="w"> </span><span class="n">titleLength</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">title</span>?<span class="p">.</span><span class="n">Length</span><span class="w"> </span>??<span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>

<p>Likewise, for arrays you can use <code>?[i]</code> as follows:</p>
<div class="code"><pre class="code literal-block"><span class="nc">int</span><span class="err">[]</span><span class="w"> </span><span class="n">myIntArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>
<span class="nf">var</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="nc">int</span><span class="vm">?</span><span class="w"> </span><span class="n">elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myIntArray</span><span class="vm">?</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">elem</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span><span class="w"> </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="ss">"No value"</span><span class="p">);</span>
</pre></div>

<p>This will do the following: If <code>myIntArray</code> is <code>null</code>, the expression returns
<code>null</code> and you can safely check it. If it contains an array, it will do the
same as: <code>elem = myIntArray[i];</code> and returns the ith element.</p>
<h4>Use null context (available in C# 8):</h4>
<p>Introduced in <code>C# 8</code>, null contexts and nullable reference types perform
static analysis on variables and provide a compiler warning if a value can be
potentially <code>null</code> or have been set to <code>null</code>. The nullable reference types
allow types to be explicitly allowed to be <code>null</code>.</p>
<p>The nullable annotation context and nullable warning context can be set for a
project using the <code>Nullable</code> element in your <code>csproj</code> file. This element
configures how the compiler interprets the nullability of types and what
warnings are generated. Valid settings are:</p>
<ul>
<li>
<code>enable</code>: The nullable annotation context is enabled. The nullable warning context is enabled. Variables of a reference type, string, for example, are non-nullable. All nullability warnings are enabled.</li>
<li>
<code>disable</code>: The nullable annotation context is disabled. The nullable warning context is disabled. Variables of a reference type are oblivious, just like earlier versions of C#. All nullability warnings are disabled.</li>
<li>
<code>safeonly</code>: The nullable annotation context is enabled. The nullable warning context is safeonly. Variables of a reference type are non-nullable. All safety nullability warnings are enabled.</li>
<li>
<code>warnings</code>: The nullable annotation context is disabled. The nullable warning context is enabled. Variables of a reference type are oblivious. All nullability warnings are enabled.</li>
<li>
<code>safeonlywarnings</code>: The nullable annotation context is disabled. The nullable warning context is safeonly. Variables of a reference type are oblivious. All safety nullability warnings are enabled.</li>
</ul>
<p>A nullable reference type is noted using the same syntax as nullable value
types: a <code>?</code> is appended to the type of the variable.</p>
<h4>Special techniques for debugging and fixing null derefs in iterators</h4>
<p><code>C#</code> supports "iterator blocks" (called "generators" in some other popular
languages). <code>NullReferenceException</code> can be particularly tricky to debug in
iterator blocks because of deferred execution:</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">IEnumerable</span><span class="o">&lt;</span><span class="nv">Frob</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">GetFrobs</span><span class="ss">(</span><span class="nv">FrobFactory</span><span class="w"> </span><span class="nv">f</span>,<span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">count</span><span class="ss">)</span>
{
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">int</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="c1">; i &lt; count; ++i)</span>
<span class="w">    </span><span class="nv">yield</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nv">f</span>.<span class="nv">MakeFrob</span><span class="ss">()</span><span class="c1">;</span>
}
...
<span class="nv">FrobFactory</span><span class="w"> </span><span class="nv">factory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">whatever</span><span class="c1">;</span>
<span class="nv">IEnumerable</span><span class="o">&lt;</span><span class="nv">Frobs</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">frobs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">GetFrobs</span><span class="ss">()</span><span class="c1">;</span>
...
<span class="nv">foreach</span><span class="ss">(</span><span class="nv">Frob</span><span class="w"> </span><span class="nv">frob</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">frobs</span><span class="ss">)</span><span class="w"> </span>{<span class="w"> </span>...<span class="w"> </span>}
</pre></div>

<p>If <code>whatever</code> results in <code>null</code> then <code>MakeFrob</code> will throw. Now, you might
think that the right thing to do is this:</p>
<div class="code"><pre class="code literal-block"><span class="c1">// DON'T DO THIS</span>
<span class="n">public</span><span class="w"> </span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">Frob</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetFrobs</span><span class="p">(</span><span class="n">FrobFactory</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">null</span><span class="p">)</span><span class="w"> </span>
<span class="w">      </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">ArgumentNullException</span><span class="p">(</span><span class="s">"f"</span><span class="p">,</span><span class="w"> </span><span class="s">"factory must not be null"</span><span class="p">);</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">      </span><span class="n">yield</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">MakeFrob</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>Why is this wrong? Because the iterator block does not actually <em>run</em> until
the <code>foreach</code>! The call to <code>GetFrobs</code> simply returns an object which <em>when
iterated</em> will run the iterator block.</p>
<p>By writing a <code>null</code> check like this you prevent the <code>NullReferenceException</code>,
but you move the <code>NullArgumentException</code> to the point of the <em>iteration</em> , not
to the point of the <em>call</em> , and that is <em>very confusing to debug</em>.</p>
<p>The correct fix is:</p>
<div class="code"><pre class="code literal-block"><span class="c1">// DO THIS</span>
<span class="n">public</span><span class="w"> </span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">Frob</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetFrobs</span><span class="p">(</span><span class="n">FrobFactory</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="c1">// No yields in a public method that throws!</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">null</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">ArgumentNullException</span><span class="p">(</span><span class="s">"f"</span><span class="p">,</span><span class="w"> </span><span class="s">"factory must not be null"</span><span class="p">);</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">GetFrobsForReal</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">private</span><span class="w"> </span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">Frob</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetFrobsForReal</span><span class="p">(</span><span class="n">FrobFactory</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="c1">// Yields in a private method</span>
<span class="w">   </span><span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">f</span><span class="w"> </span>!<span class="p">=</span><span class="w"> </span><span class="nb">null</span><span class="p">);</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">        </span><span class="n">yield</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">MakeFrob</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>That is, make a private helper method that has the iterator block logic and a
public surface method that does the <code>null</code> check and returns the iterator. Now
when <code>GetFrobs</code> is called, the <code>null</code> check happens immediately, and then
<code>GetFrobsForReal</code> executes when the sequence is iterated.</p>
<p>If you examine the reference source for <code>LINQ</code> to Objects you will see that
this technique is used throughout. It is slightly more clunky to write, but it
makes debugging nullity errors much easier. <strong>Optimize your code for the
convenience of the caller, not the convenience of the author</strong>.</p>
<h4>A note on null dereferences in unsafe code</h4>
<p><code>C#</code> has an "unsafe" mode which is, as the name implies, extremely dangerous
because the normal safety mechanisms which provide memory safety and type
safety are not enforced. <strong>You should not be writing unsafe code unless you
have a thorough and deep understanding of how memory works</strong>.</p>
<p>In unsafe mode, you should be aware of two important facts:</p>
<ul>
<li>dereferencing a null <strong>pointer</strong> produces the same exception as dereferencing a null <strong>reference</strong>
</li>
<li>dereferencing an invalid non-null pointer <strong>can</strong> produce that exception in some circumstances</li>
</ul>
<p>To understand why that is, it helps to understand how .NET produces
<code>NullReferenceException</code> in the first place. (These details apply to .NET
running on Windows; other operating systems use similar mechanisms.)</p>
<p>Memory is virtualized in <code>Windows</code>; each process gets a virtual memory space
of many "pages" of memory that are tracked by the operating system. Each page
of memory has flags set on it that determine how it may be used: read from,
written to, executed, and so on. The <em>lowest</em> page is marked as "produce an
error if ever used in any way".</p>
<p>Both a null pointer and a null reference in <code>C#</code> are internally represented as
the number zero, and so any attempt to dereference it into its corresponding
memory storage causes the operating system to produce an error. The .NET
runtime then detects this error and turns it into the
<code>NullReferenceException</code>.</p>
<p>That's why dereferencing both a null pointer and a null reference produces the
same exception.</p>
<p>What about the second point? Dereferencing <em>any</em> invalid pointer that falls in
the lowest page of virtual memory causes the same operating system error, and
thereby the same exception.</p>
<p>Why does this make sense? Well, suppose we have a struct containing two ints,
and an unmanaged pointer equal to null. If we attempt to dereference the
second int in the struct, the <code>CLR</code> will not attempt to access the storage at
location zero; it will access the storage at location four. But logically this
is a null dereference because we are getting to that address <em>via</em> the null.</p>
<p>If you are working with unsafe code and you get a <code>NullReferenceException</code>,
just be aware that the offending pointer need not be null. It can be any
location in the lowest page, and this exception will be produced.</p>
<p><br></p>
<h3>更多建议</h3>
<h2>NullReference 异常 — Visual Basic</h2>
<p>for <strong>Visual Basic</strong><code>NullReference Exception</code>与 <strong>C#</strong> 中的没有什么不同。毕竟，它们都报告在它们都使用的
.NET Framework 中定义的相同异常。Visual Basic 独有的原因很少见（也许只有一个）。 <strong><em>* </em></strong>*</p>
<p>此答案将使用 Visual Basic 术语、语法和上下文。使用的示例来自大量过去的 Stack Overflow 问题。这是为了通过使用帖子中常见的
<em>各种情况来最大化相关性。</em> 还为可能需要它的人提供了更多解释。 <em>此处很</em> 可能列出了与您的示例类似的示例。</p>
<p><strong>笔记：</strong></p>
<ol>
<li>这是基于概念的：没有代码供您粘贴到您的项目中。它旨在帮助您了解导致<code>NullReferenceException</code>(NRE) 的原因、如何找到它、如何解决它以及如何避免它。NRE 可能由多种原因引起，因此这不太可能是您唯一遇到的情况。</li>
<li>这些示例（来自 Stack Overflow 帖子）并不总是首先展示做某事的最佳方法。</li>
<li>通常，使用最简单的补救措施。</li>
</ol>
<h3>基本含义</h3>
<p>消息 <em>“对象未设置为对象的实例”</em> 意味着您正在尝试使用尚未初始化的对象。这归结为其中之一：</p>
<ul>
<li>您的代码 <em>声明了</em> 一个对象变量，但没有对其 <em>进行初始化</em> （创建实例或“ <em>实例化</em> ”它）</li>
<li>您的代码假设会初始化一个对象的东西，但没有</li>
<li>可能其他代码过早地使仍在使用的对象无效</li>
</ul>
<h3>寻找原因</h3>
<p>由于问题是对象引用 which 是<code>Nothing</code>，答案是检查它们以找出是哪个。然后判断没有初始化的原因。将鼠标悬停在各种变量上，Visual
Studio (VS) 将显示它们的值——罪魁祸首将是<code>Nothing</code>.</p>
<p><img alt="IDE调试显示" src="../../images/5ndSA.jpg"></p>
<p>您还应该从相关代码中删除任何 Try/Catch 块，尤其是那些 Catch 块中没有任何内容的代码。这将导致您的代码在尝试使用<code>Nothing</code>.
<strong>这就是您想要的</strong> ，因为它将确定问题的确切 <em>位置</em> ，并允许您识别导致问题的对象。</p>
<p>A<code>MsgBox</code>在 Catch which displays 中的<code>Error while...</code>作用不大。这种方法也会导致 <em>非常糟糕的</em> Stack
Overflow 问题，因为您无法描述实际的异常、涉及的对象甚至它发生的代码行。</p>
<p>您还可以使用<code>Locals Window</code>（ <strong>Debug - &gt; Windows -&gt; Locals</strong>）来检查您的对象。</p>
<p>一旦您知道问题出在哪里以及问题出在哪里，通常可以很容易地解决问题，而且比发布新问题更快。</p>
<p>也可以看看：</p>
<ul>
<li>断点</li>
<li>MSDN：如何：使用 Try/Catch 块捕获异常</li>
<li>MSDN：异常的最佳实践</li>
</ul>
<h3>示例和补救措施</h3>
<h3>类对象/创建实例</h3>
<div class="code"><pre class="code literal-block"><span class="n">Dim</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">As</span><span class="w"> </span><span class="n">CashRegister</span>
<span class="p">...</span>
<span class="n">TextBox1</span><span class="p">.</span><span class="n">Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">reg</span><span class="p">.</span><span class="n">Amount</span><span class="w">         </span><span class="p">'</span><span class="w"> </span><span class="n">NRE</span>
</pre></div>

<p>问题是<code>Dim</code>没有创建 CashRegister <em>对象</em> ；它只声明一个以<code>reg</code>该类型命名的变量。 <em>声明</em> 一个对象变量和创建一个 <em>实例</em>
是两件不同的事情。</p>
<p><strong>补救</strong></p>
<p>运算<code>New</code>符通常可用于在声明实例时创建实例：</p>
<div class="code"><pre class="code literal-block"><span class="n">Dim</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="k">As</span><span class="w"> </span><span class="k">New</span><span class="w"> </span><span class="n">CashRegister</span><span class="w">        </span><span class="s1">' [New] creates instance, invokes the constructor</span>

<span class="s1">'</span><span class="w"> </span><span class="n">Longer</span><span class="p">,</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">explicit</span><span class="w"> </span><span class="nl">form</span><span class="p">:</span>
<span class="n">Dim</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="k">As</span><span class="w"> </span><span class="n">CashRegister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">New</span><span class="w"> </span><span class="n">CashRegister</span>
</pre></div>

<p>当只适合稍后创建实例时：</p>
<div class="code"><pre class="code literal-block"><span class="n">Private</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">As</span><span class="w"> </span><span class="n">CashRegister</span><span class="w">         </span><span class="p">'</span><span class="w"> </span><span class="n">Declare</span>
<span class="w">  </span><span class="p">...</span>
<span class="kt">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New</span><span class="w"> </span><span class="n">CashRegister</span><span class="p">()</span><span class="w">            </span><span class="p">'</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">instance</span>
</pre></div>

<p>注意： <strong>不要</strong> 在一个过程中再次使用<code>Dim</code>，包括构造函数（<code>Sub New</code>）：</p>
<div class="code"><pre class="code literal-block"><span class="n">Private</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">As</span><span class="w"> </span><span class="n">CashRegister</span>
<span class="p">'...</span>

<span class="n">Public</span><span class="w"> </span><span class="n">Sub</span><span class="w"> </span><span class="n">New</span><span class="p">()</span>
<span class="w">   </span><span class="p">'...</span>
<span class="w">   </span><span class="n">Dim</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">As</span><span class="w"> </span><span class="n">New</span><span class="w"> </span><span class="n">CashRegister</span>
<span class="n">End</span><span class="w"> </span><span class="n">Sub</span>
</pre></div>

<p>这将创建一个 <em>局部</em> 变量，<code>reg</code>它仅存在于该上下文 (sub)
中。您将在其他任何地方使用的<code>reg</code>具有模块级别的变量仍然存在。<code>Scope``Nothing</code></p>
<blockquote>
<p><strong>缺少<code>New``NullReference Exceptions</code></strong>运算符是在审查的 Stack Overflow 问题中看到
<strong>的第一大原因。</strong></p>
<p>Visual Basic 尝试通过以下方式反复使过程清晰 <strong><code>New</code></strong> ： 使用 <strong><code>New</code></strong> 运算符创建一个 <strong>新</strong> 对象并调用
<strong><code>Sub New</code></strong> ——构造函数——您的对象可以在其中执行任何其他初始化。</p>
</blockquote>
<p>要清楚，<code>Dim</code>(or <code>Private</code>) 仅 <em>声明</em> 一个变量及其<code>Type</code>.
变量的范围——无论它存在于整个模块/类中还是局部于一个过程——由它声明的 <em>位置</em> <em>决定。</em><code>Private | Friend |
Public</code>定义访问级别，而不是 <em>Scope</em> 。</p>
<p>有关详细信息，请参阅：</p>
<ul>
<li>新运营商</li>
<li>Visual Basic 中的作用域</li>
<li>Visual Basic 中的访问级别</li>
<li>值类型和引用类型</li>
</ul>
<hr>
<h3>数组</h3>
<p>数组也必须被实例化：</p>
<div class="code"><pre class="code literal-block">Private arr as String()
</pre></div>

<p>这个数组只是被声明，没有被创建。有几种初始化数组的方法：</p>
<div class="code"><pre class="code literal-block"><span class="nv">Private</span><span class="w"> </span><span class="nv">arr</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">String</span><span class="ss">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">New</span><span class="w"> </span><span class="nv">String</span><span class="ss">(</span><span class="mi">10</span><span class="ss">)</span>{}
<span class="err">' or</span>
<span class="err">Private arr() As String = New String(10){}</span>

<span class="s1">' For a local array (in a procedure) and using '</span><span class="nv">Option</span><span class="w"> </span><span class="nv">Infer</span><span class="err">':</span>
<span class="err">Dim arr = New String(10) {}</span>
</pre></div>

<p>注意：从 VS 2010 开始，当使用文字 and 初始化本地数组时<code>Option Infer</code>，<code>As &lt;Type&gt;</code>and<code>New</code>元素是可选的：</p>
<div class="code"><pre class="code literal-block">Dim myDbl As Double() = {1.5, 2, 9.9, 18, 3.14}
Dim myDbl = New Double() {1.5, 2, 9.9, 18, 3.14}
Dim myDbl() = {1.5, 2, 9.9, 18, 3.14}
</pre></div>

<p>数据类型和数组大小是从分配的数据中推断出来的。类/模块级声明仍然需要<code>As &lt;Type&gt;</code>with <code>Option Strict</code>：</p>
<div class="code"><pre class="code literal-block">Private myDoubles As Double() = {1.5, 2, 9.9, 18, 3.14}
</pre></div>

<p><strong>示例：类对象数组</strong></p>
<div class="code"><pre class="code literal-block"><span class="nv">Dim</span><span class="w"> </span><span class="nv">arrFoo</span><span class="ss">(</span><span class="mi">5</span><span class="ss">)</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">Foo</span>

<span class="k">For</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">Integer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">To</span><span class="w"> </span><span class="nv">arrFoo</span>.<span class="nv">Count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="nv">arrFoo</span><span class="ss">(</span><span class="nv">i</span><span class="ss">)</span>.<span class="nv">Bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w">       </span><span class="err">' Exception</span>
<span class="err">Next</span>
</pre></div>

<p>数组已创建，但<code>Foo</code>其中的对象尚未创建。</p>
<p><strong>补救</strong></p>
<div class="code"><pre class="code literal-block"><span class="k">For</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">Integer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">To</span><span class="w"> </span><span class="nv">arrFoo</span>.<span class="nv">Count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="nv">arrFoo</span><span class="ss">(</span><span class="nv">i</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">New</span><span class="w"> </span><span class="nv">Foo</span><span class="ss">()</span><span class="w">         </span><span class="err">' Create Foo instance</span>
<span class="err">    arrFoo(i).Bar = i * 10</span>
<span class="err">Next</span>
</pre></div>

<p>使用 a<code>List(Of T)</code>会使没有有效对象的元素变得相当困难：</p>
<div class="code"><pre class="code literal-block"><span class="n">Dim</span><span class="w"> </span><span class="n">FooList</span><span class="w"> </span><span class="n">As</span><span class="w"> </span><span class="n">New</span><span class="w"> </span><span class="n">List</span><span class="p">(</span><span class="n">Of</span><span class="w"> </span><span class="n">Foo</span><span class="p">)</span><span class="w">     </span><span class="s1">' List created, but it is empty</span>
<span class="n">Dim</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">As</span><span class="w"> </span><span class="n">Foo</span><span class="w">                        </span><span class="s1">' Temporary variable for the loop</span>

<span class="n">For</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">As</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">To</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New</span><span class="w"> </span><span class="n">Foo</span><span class="p">()</span><span class="w">                    </span><span class="s1">' Foo instance created</span>
<span class="w">    </span><span class="n">f</span><span class="o">.</span><span class="n">Bar</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span>
<span class="w">    </span><span class="n">FooList</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w">                   </span><span class="s1">' Foo object added to list</span>
<span class="n">Next</span>
</pre></div>

<p>有关详细信息，请参阅：</p>
<ul>
<li>期权推断语句</li>
<li>Visual Basic 中的作用域</li>
<li>Visual Basic 中的数组</li>
</ul>
<hr>
<h3>列表和集合</h3>
<p>.NET 集合（其中有很多种——列表、字典等）也必须实例化或创建。</p>
<div class="code"><pre class="code literal-block">Private myList As List(Of String)
..
myList.Add("ziggy")           ' NullReference
</pre></div>

<p>出于相同的原因，您会得到相同的异常 -<code>myList</code>仅被声明，但没有创建实例。补救措施是一样的：</p>
<div class="code"><pre class="code literal-block">myList = New List(Of String)

' Or create an instance when declared:
Private myList As New List(Of String)
</pre></div>

<p>一个常见的疏忽是使用集合的类<code>Type</code>：</p>
<div class="code"><pre class="code literal-block"><span class="nv">Public</span><span class="w"> </span><span class="nv">Class</span><span class="w"> </span><span class="nv">Foo</span>
<span class="w">    </span><span class="nv">Private</span><span class="w"> </span><span class="nv">barList</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">List</span><span class="ss">(</span><span class="nv">Of</span><span class="w"> </span><span class="nv">Bar</span><span class="ss">)</span>

<span class="w">    </span><span class="nv">Friend</span><span class="w"> </span><span class="nv">Function</span><span class="w"> </span><span class="nv">BarCount</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">Integer</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="nv">barList</span>.<span class="nv">Count</span>
<span class="w">    </span><span class="k">End</span><span class="w"> </span><span class="nv">Function</span>

<span class="w">    </span><span class="nv">Friend</span><span class="w"> </span><span class="nv">Sub</span><span class="w"> </span><span class="nv">AddItem</span><span class="ss">(</span><span class="nv">newBar</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">Bar</span><span class="ss">)</span>
<span class="w">        </span><span class="k">If</span><span class="w"> </span><span class="nv">barList</span>.<span class="nv">Contains</span><span class="ss">(</span><span class="nv">newBar</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">False</span><span class="w"> </span><span class="k">Then</span>
<span class="w">            </span><span class="nv">barList</span>.<span class="nv">Add</span><span class="ss">(</span><span class="nv">newBar</span><span class="ss">)</span>
<span class="w">        </span><span class="k">End</span><span class="w"> </span><span class="k">If</span>
<span class="w">    </span><span class="k">End</span><span class="w"> </span><span class="nv">Function</span>
</pre></div>

<p>Either procedure will result in an NRE, because <code>barList</code> is only declared,
not instantiated. Creating an instance of <code>Foo</code> will not also create an
instance of the internal <code>barList</code>. It may have been the intent to do this in
the constructor:</p>
<div class="code"><pre class="code literal-block"><span class="nv">Public</span><span class="w"> </span><span class="nv">Sub</span><span class="w"> </span><span class="nv">New</span><span class="w">         </span><span class="err">' Constructor</span>
<span class="w">    </span><span class="err">' Stuff to do when a new Foo is created...</span>
<span class="err">    barList = New List(Of Bar)</span>
<span class="err">End Sub</span>
</pre></div>

<p>As before, this is incorrect:</p>
<div class="code"><pre class="code literal-block"><span class="nv">Public</span><span class="w"> </span><span class="nv">Sub</span><span class="w"> </span><span class="nv">New</span><span class="ss">()</span>
<span class="w">    </span><span class="err">' Creates another barList local to this procedure</span>
<span class="err">     Dim barList As New List(Of Bar)</span>
<span class="err">End Sub</span>
</pre></div>

<p>For more information, see <code>List(Of T)</code> Class.</p>
<hr>
<h3>Data Provider Objects</h3>
<p>Working with databases presents many opportunities for a NullReference because
there can be many objects (<code>Command</code>, <code>Connection</code>, <code>Transaction</code>, <code>Dataset</code>,
<code>DataTable</code>, <code>DataRows</code>....) in use at once. <strong>Note:</strong> It does not matter
which data provider you are using -- MySQL, SQL Server, OleDB, etc. -- the
<em>concepts</em> are the same.</p>
<p><strong>Example 1</strong></p>
<div class="code"><pre class="code literal-block">Dim da As OleDbDataAdapter
Dim ds As DataSet
Dim MaxRows As Integer

con.Open()
Dim sql = "SELECT * FROM tblfoobar_List"
da = New OleDbDataAdapter(sql, con)
da.Fill(ds, "foobar")
con.Close()

MaxRows = ds.Tables("foobar").Rows.Count      ' Error
</pre></div>

<p>As before, the <code>ds</code> Dataset object was declared, but an instance was never
created. The <code>DataAdapter</code> will fill an existing <code>DataSet</code>, not create one. In
this case, since <code>ds</code> is a local variable, <em>the IDE warns you</em> that this might
happen:</p>
<p><img alt="图片" src="../../images/E5d94.jpg"></p>
<p>When declared as a module/class level variable, as appears to be the case with
<code>con</code>, the compiler can't know if the object was created by an upstream
procedure. Do not ignore warnings.</p>
<p><strong>Remedy</strong></p>
<div class="code"><pre class="code literal-block">Dim ds As New DataSet
</pre></div>

<p><strong>Example 2</strong></p>
<div class="code"><pre class="code literal-block">ds = New DataSet
da = New OleDBDataAdapter(sql, con)
da.Fill(ds, "Employees")

txtID.Text = ds.Tables("Employee").Rows(0).Item(1)
txtID.Name = ds.Tables("Employee").Rows(0).Item(2)
</pre></div>

<p>A typo is a problem here: <code>Employees</code> vs <code>Employee</code>. There was no <code>DataTable</code>
named "Employee" created, so a <code>NullReferenceException</code> results trying to
access it. Another potential problem is assuming there will be <code>Items</code> which
may not be so when the SQL includes a WHERE clause.</p>
<p><strong>Remedy</strong></p>
<p>Since this uses one table, using <code>Tables(0)</code> will avoid spelling errors.
Examining <code>Rows.Count</code> can also help:</p>
<div class="code"><pre class="code literal-block"><span class="k">If</span><span class="w"> </span><span class="nv">ds</span>.<span class="nv">Tables</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>.<span class="nv">Rows</span>.<span class="nv">Count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">Then</span>
<span class="w">    </span><span class="nv">txtID</span>.<span class="nv">Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ds</span>.<span class="nv">Tables</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>.<span class="nv">Rows</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>.<span class="nv">Item</span><span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">txtID</span>.<span class="nv">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ds</span>.<span class="nv">Tables</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>.<span class="nv">Rows</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>.<span class="nv">Item</span><span class="ss">(</span><span class="mi">2</span><span class="ss">)</span>
<span class="k">End</span><span class="w"> </span><span class="k">If</span>
</pre></div>

<p><code>Fill</code> is a function returning the number of <code>Rows</code> affected which can also be
tested:</p>
<div class="code"><pre class="code literal-block"><span class="k">If</span><span class="w"> </span><span class="nv">da</span>.<span class="nv">Fill</span><span class="ss">(</span><span class="nv">ds</span>,<span class="w"> </span><span class="s2">"Employees"</span><span class="ss">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">Then</span>...
</pre></div>

<p><strong>Example 3</strong></p>
<div class="code"><pre class="code literal-block"><span class="nv">Dim</span><span class="w"> </span><span class="nv">da</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">New</span><span class="w"> </span><span class="nv">OleDb</span>.<span class="nv">OleDbDataAdapter</span><span class="ss">(</span><span class="err">"SELECT TICKET.TICKET_NO,</span>
<span class="err">        TICKET.CUSTOMER_ID, ... FROM TICKET_RESERVATION AS TICKET INNER JOIN</span>
<span class="w">        </span><span class="nv">FLIGHT_DETAILS</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">FLIGHT</span><span class="w"> </span>...<span class="w"> </span><span class="nv">WHERE</span><span class="w"> </span>[<span class="nv">TICKET</span>.<span class="nv">TICKET_NO</span>]<span class="o">=</span><span class="w"> </span>...<span class="err">", con)</span>
<span class="err">Dim ds As New DataSet</span>
<span class="err">da.Fill(ds)</span>

<span class="k">If</span><span class="w"> </span><span class="nv">ds</span>.<span class="nv">Tables</span><span class="ss">(</span><span class="s2">"TICKET_RESERVATION"</span><span class="ss">)</span>.<span class="nv">Rows</span>.<span class="nv">Count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">Then</span>
</pre></div>

<p>The <code>DataAdapter</code> will provide <code>TableNames</code> as shown in the previous example,
but it does not parse names from the SQL or database table. As a result,
<code>ds.Tables("TICKET_RESERVATION")</code> references a non-existent table.</p>
<p>The <strong>Remedy</strong> is the same, reference the table by index:</p>
<div class="code"><pre class="code literal-block"><span class="k">If</span><span class="w"> </span><span class="nv">ds</span>.<span class="nv">Tables</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>.<span class="nv">Rows</span>.<span class="nv">Count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">Then</span>
</pre></div>

<p>See also DataTable Class.</p>
<hr>
<h3>Object Paths / Nested</h3>
<div class="code"><pre class="code literal-block"><span class="k">If</span><span class="w"> </span><span class="nv">myFoo</span>.<span class="nv">Bar</span>.<span class="nv">Items</span><span class="w"> </span><span class="nv">IsNot</span><span class="w"> </span><span class="nv">Nothing</span><span class="w"> </span><span class="k">Then</span>
<span class="w">   </span>...
</pre></div>

<p>The code is only testing <code>Items</code> while both <code>myFoo</code> and <code>Bar</code> may also be
Nothing. The <strong>remedy</strong> is to test the entire chain or path of objects one at
a time:</p>
<div class="code"><pre class="code literal-block"><span class="k">If</span><span class="w"> </span><span class="ss">(</span><span class="nv">myFoo</span><span class="w"> </span><span class="nv">IsNot</span><span class="w"> </span><span class="nv">Nothing</span><span class="ss">)</span><span class="w"> </span><span class="nv">AndAlso</span>
<span class="w">    </span><span class="ss">(</span><span class="nv">myFoo</span>.<span class="nv">Bar</span><span class="w"> </span><span class="nv">IsNot</span><span class="w"> </span><span class="nv">Nothing</span><span class="ss">)</span><span class="w"> </span><span class="nv">AndAlso</span>
<span class="w">    </span><span class="ss">(</span><span class="nv">myFoo</span>.<span class="nv">Bar</span>.<span class="nv">Items</span><span class="w"> </span><span class="nv">IsNot</span><span class="w"> </span><span class="nv">Nothing</span><span class="ss">)</span><span class="w"> </span><span class="k">Then</span>
<span class="w">    </span>....
</pre></div>

<p><code>AndAlso</code> is important. Subsequent tests will not be performed once the first
<code>False</code> condition is encountered. This allows the code to safely 'drill' into
the object(s) one 'level' at a time, evaluating <code>myFoo.Bar</code> only after (and
if) <code>myFoo</code> is determined to be valid. Object chains or paths can get quite
long when coding complex objects:</p>
<div class="code"><pre class="code literal-block">myBase.myNodes(3).Layer.SubLayer.Foo.Files.Add("somefilename")
</pre></div>

<p>It is not possible to reference anything 'downstream' of a <code>null</code> object. This
also applies to controls:</p>
<div class="code"><pre class="code literal-block">myWebBrowser.Document.GetElementById("formfld1").InnerText = "some value"
</pre></div>

<p>Here, <code>myWebBrowser</code> or <code>Document</code> could be Nothing or the <code>formfld1</code> element
may not exist.</p>
<hr>
<h3>UI Controls</h3>
<div class="code"><pre class="code literal-block">Dim cmd5 As New SqlCommand("select Cartons, Pieces, Foobar " _
     &amp; "FROM Invoice where invoice_no = '" &amp; _
     Me.ComboBox5.SelectedItem.ToString.Trim &amp; "' And category = '" &amp; _
     Me.ListBox1.SelectedItem.ToString.Trim &amp; "' And item_name = '" &amp; _
     Me.ComboBox2.SelectedValue.ToString.Trim &amp; "' And expiry_date = '" &amp; _
     Me.expiry.Text &amp; "'", con)
</pre></div>

<p>Among other things, this code does not anticipate that the user may not have
selected something in one or more UI controls. <code>ListBox1.SelectedItem</code> may
well be <code>Nothing</code>, so <code>ListBox1.SelectedItem.ToString</code> will result in an NRE.</p>
<p><strong>Remedy</strong></p>
<p>Validate data before using it (also use <code>Option Strict</code> and SQL parameters):</p>
<div class="code"><pre class="code literal-block"><span class="nv">Dim</span><span class="w"> </span><span class="nv">expiry</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">DateTime</span><span class="w">         </span><span class="err">' for text date validation</span>
<span class="err">If (ComboBox5.SelectedItems.Count &gt; 0) AndAlso</span>
<span class="err">    (ListBox1.SelectedItems.Count &gt; 0) AndAlso</span>
<span class="err">    (ComboBox2.SelectedItems.Count &gt; 0) AndAlso</span>
<span class="err">    (DateTime.TryParse(expiry.Text, expiry) Then</span>

<span class="w">    </span><span class="err">'... do stuff</span>
<span class="err">Else</span>
<span class="err">    MessageBox.Show(...error message...)</span>
<span class="err">End If</span>
</pre></div>

<p>Alternatively, you can use <code>(ComboBox5.SelectedItem IsNot Nothing) AndAlso...</code></p>
<hr>
<h3>Visual Basic Forms</h3>
<div class="code"><pre class="code literal-block"><span class="n">Public</span><span class="w"> </span><span class="n">Class</span><span class="w"> </span><span class="n">Form1</span>

<span class="w">    </span><span class="n">Private</span><span class="w"> </span><span class="n">NameBoxes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New</span><span class="w"> </span><span class="n">TextBox</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">Controls</span><span class="p">(</span><span class="s2">"TextBox1"</span><span class="p">),</span><span class="w"> </span><span class="n">_</span>
<span class="w">                   </span><span class="n">Controls</span><span class="p">(</span><span class="s2">"TextBox2"</span><span class="p">),</span><span class="w"> </span><span class="n">Controls</span><span class="p">(</span><span class="s2">"TextBox3"</span><span class="p">),</span><span class="w"> </span><span class="n">_</span>
<span class="w">                   </span><span class="n">Controls</span><span class="p">(</span><span class="s2">"TextBox4"</span><span class="p">),</span><span class="w"> </span><span class="n">Controls</span><span class="p">(</span><span class="s2">"TextBox5"</span><span class="p">),</span><span class="w"> </span><span class="n">_</span>
<span class="w">                   </span><span class="n">Controls</span><span class="p">(</span><span class="s2">"TextBox6"</span><span class="p">)}</span>

<span class="w">    </span><span class="s1">' same thing in a different format:</span>
<span class="w">    </span><span class="n">Private</span><span class="w"> </span><span class="n">boxList</span><span class="w"> </span><span class="n">As</span><span class="w"> </span><span class="n">New</span><span class="w"> </span><span class="n">List</span><span class="p">(</span><span class="n">Of</span><span class="w"> </span><span class="n">TextBox</span><span class="p">)</span><span class="w"> </span><span class="n">From</span><span class="w"> </span><span class="p">{</span><span class="n">TextBox1</span><span class="p">,</span><span class="w"> </span><span class="n">TextBox2</span><span class="p">,</span><span class="w"> </span><span class="n">TextBox3</span><span class="w"> </span><span class="o">...</span><span class="p">}</span>

<span class="w">    </span><span class="s1">' Immediate NRE:</span>
<span class="w">    </span><span class="n">Private</span><span class="w"> </span><span class="n">somevar</span><span class="w"> </span><span class="n">As</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Me</span><span class="o">.</span><span class="n">Controls</span><span class="p">(</span><span class="s2">"TextBox1"</span><span class="p">)</span><span class="o">.</span><span class="n">Text</span>
</pre></div>

<p>This is a fairly common way to get an NRE. In C#, depending on how it is
coded, the IDE will report that <code>Controls</code> does not exist in the current
context, or "cannot reference non-static member". So, to some extent, this is
a VB-only situation. It is also complex because it can result in a failure
cascade.</p>
<p><em>The arrays and collections cannot be initialized this way.</em> This
initialization code will run <em>before</em> the constructor creates the <code>Form</code> or
the <code>Controls</code>. As a result:</p>
<ul>
<li>Lists and Collection will simply be empty</li>
<li>The Array will contain five elements of Nothing</li>
<li>The <code>somevar</code> assignment will result in an immediate NRE because Nothing doesn't have a <code>.Text</code> property</li>
</ul>
<p>Referencing array elements later will result in an NRE. If you do this in
<code>Form_Load</code>, due to an odd bug, the IDE <em>may not</em> report the exception when it
happens. The exception will pop up <em>later</em> when your code tries to use the
array. This "silent exception" is detailed in this post. For our purposes, the
key is that when something catastrophic happens while creating a form (<code>Sub
New</code> or <code>Form Load</code> event), exceptions may go unreported, the code exits the
procedure and just displays the form.</p>
<p>Since no other code in your <code>Sub New</code> or <code>Form Load</code> event will run after the
NRE, <em>a great many other things</em> can be left uninitialized.</p>
<div class="code"><pre class="code literal-block"><span class="nv">Sub</span><span class="w"> </span><span class="nv">Form_Load</span><span class="ss">(</span>...<span class="nv">_</span>
<span class="w">   </span><span class="err">'...</span>
<span class="w">   </span><span class="nv">Dim</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">NameBoxes</span><span class="ss">(</span><span class="mi">2</span><span class="ss">)</span>.<span class="nv">Text</span><span class="w">        </span><span class="err">' NRE</span>
<span class="w">   </span><span class="err">' ...</span>
<span class="w">   </span><span class="err">' More code (which will likely not be executed)</span>
<span class="w">   </span><span class="err">' ...</span>
<span class="err">End Sub</span>
</pre></div>

<p><strong>Note</strong> this applies to any and all control and component references making
these illegal where they are:</p>
<div class="code"><pre class="code literal-block">Public Class Form1

    Private myFiles() As String = Me.OpenFileDialog1.FileName &amp; ...
    Private dbcon As String = OpenFileDialog1.FileName &amp; ";Jet Oledb..."
    Private studentName As String = TextBox13.Text
</pre></div>

<p><strong>Partial Remedy</strong></p>
<p>It is curious that VB does not provide a warning, but the remedy is to
<strong>declare</strong> the containers at the form level, but <strong>initialize</strong> them in form
load event handler when the controls <strong>do</strong> exist. This can be done in <code>Sub
New</code> as long as your code is after the <code>InitializeComponent</code> call:</p>
<div class="code"><pre class="code literal-block"><span class="err">' Module level declaration</span>
<span class="err">Private NameBoxes as TextBox()</span>
<span class="err">Private studentName As String</span>

<span class="err">' Form Load, Form Shown or Sub New:</span>
<span class="err">'</span>
<span class="s1">' Using the OP'</span><span class="nv">s</span><span class="w"> </span><span class="nv">approach</span><span class="w"> </span><span class="ss">(</span><span class="nv">illegal</span><span class="w"> </span><span class="nv">using</span><span class="w"> </span><span class="nv">OPTION</span><span class="w"> </span><span class="nv">STRICT</span><span class="ss">)</span>
<span class="nv">NameBoxes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">New</span><span class="w"> </span><span class="nv">TextBox</span><span class="ss">()</span><span class="w"> </span>{<span class="nv">Me</span>.<span class="nv">Controls</span><span class="ss">(</span><span class="s2">"TextBox1"</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">Me</span>.<span class="nv">Controls</span><span class="ss">(</span><span class="s2">"TestBox2"</span><span class="ss">)</span>,<span class="w"> </span>...<span class="ss">)</span>
<span class="nv">studentName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">TextBox32</span>.<span class="nv">Text</span><span class="w">           </span><span class="err">' For simple control references</span>
</pre></div>

<p>The array code may not be out of the woods yet. Any controls which are in a
container control (like a <code>GroupBox</code> or <code>Panel</code>) will not be found in
<code>Me.Controls</code>; they will be in the Controls collection of that Panel or
GroupBox. Nor will a control be returned when the control name is misspelled
(<code>"TeStBox2"</code>). In such cases, <code>Nothing</code> will again be stored in those array
elements and an NRE will result when you attempt to reference it.</p>
<p>These should be easy to find now that you know what you are looking for: <img alt="VS
告诉你你的方式的错误" src="../../images/5ndSA.jpg"></p>
<p>"Button2" resides on a <code>Panel</code></p>
<p><strong>Remedy</strong></p>
<p>Rather than indirect references by name using the form's <code>Controls</code>
collection, use the control reference:</p>
<div class="code"><pre class="code literal-block">' Declaration
Private NameBoxes As TextBox()

' Initialization -  simple and easy to read, hard to botch:
NameBoxes = New TextBox() {TextBox1, TextBox2, ...)

' Initialize a List
NamesList = New List(Of TextBox)({TextBox1, TextBox2, TextBox3...})
' or
NamesList = New List(Of TextBox)
NamesList.AddRange({TextBox1, TextBox2, TextBox3...})
</pre></div>

<hr>
<h3>Function Returning Nothing</h3>
<div class="code"><pre class="code literal-block"><span class="nv">Private</span><span class="w"> </span><span class="nv">bars</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">New</span><span class="w"> </span><span class="nv">List</span><span class="ss">(</span><span class="nv">Of</span><span class="w"> </span><span class="nv">Bars</span><span class="ss">)</span><span class="w">        </span><span class="err">' Declared and created</span>

<span class="err">Public Function BarList() As List(Of Bars)</span>
<span class="err">    bars.Clear</span>
<span class="err">    If someCondition Then</span>
<span class="err">        For n As Integer = 0 to someValue</span>
<span class="err">            bars.Add(GetBar(n))</span>
<span class="err">        Next n</span>
<span class="err">    Else</span>
<span class="err">        Exit Function</span>
<span class="err">    End If</span>

<span class="err">    Return bars</span>
<span class="err">End Function</span>
</pre></div>

<p>This is a case where the IDE will warn you that ' <em>not all paths return a
value and a<code>NullReferenceException</code> may result</em>'. You can suppress the
warning, by replacing <code>Exit Function</code> with <code>Return Nothing</code>, but that does not
solve the problem. Anything which tries to use the return when <code>someCondition
= False</code> will result in an NRE:</p>
<div class="code"><pre class="code literal-block"><span class="nv">bList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">myFoo</span>.<span class="nv">BarList</span><span class="ss">()</span>
<span class="k">For</span><span class="w"> </span><span class="nv">Each</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">Bar</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">bList</span><span class="w">      </span><span class="err">' EXCEPTION</span>
<span class="err">      ...</span>
</pre></div>

<p><strong>Remedy</strong></p>
<p>Replace <code>Exit Function</code> in the function with <code>Return bList</code>. Returning an
<em>empty</em> <code>List</code> is not the same as returning <code>Nothing</code>. If there is a chance
that a returned object can be <code>Nothing</code>, test before using it:</p>
<div class="code"><pre class="code literal-block"><span class="w"> </span><span class="nv">bList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">myFoo</span>.<span class="nv">BarList</span><span class="ss">()</span>
<span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="nv">bList</span><span class="w"> </span><span class="nv">IsNot</span><span class="w"> </span><span class="nv">Nothing</span><span class="w"> </span><span class="k">Then</span>...
</pre></div>

<hr>
<h3>Poorly Implemented Try/Catch</h3>
<p>A badly implemented Try/Catch can hide where the problem is and result in new
ones:</p>
<div class="code"><pre class="code literal-block"><span class="nv">Dim</span><span class="w"> </span><span class="nv">dr</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">SqlDataReader</span>
<span class="nv">Try</span>
<span class="w">    </span><span class="nv">Dim</span><span class="w"> </span><span class="nv">lnk</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">LinkButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">TryCast</span><span class="ss">(</span><span class="nv">sender</span>,<span class="w"> </span><span class="nv">LinkButton</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">Dim</span><span class="w"> </span><span class="nv">gr</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">GridViewRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">DirectCast</span><span class="ss">(</span><span class="nv">lnk</span>.<span class="nv">NamingContainer</span>,<span class="w"> </span><span class="nv">GridViewRow</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">Dim</span><span class="w"> </span><span class="nv">eid</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">GridView1</span>.<span class="nv">DataKeys</span><span class="ss">(</span><span class="nv">gr</span>.<span class="nv">RowIndex</span><span class="ss">)</span>.<span class="nv">Value</span>.<span class="nv">ToString</span><span class="ss">()</span>
<span class="w">    </span><span class="nv">ViewState</span><span class="ss">(</span><span class="s2">"username"</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">eid</span>
<span class="w">    </span><span class="nv">sqlQry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">"select FirstName, Surname, DepartmentName, ExtensionName, jobTitle,</span>
<span class="w">             </span><span class="nv">Pager</span>,<span class="w"> </span><span class="nv">mailaddress</span>,<span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">employees1</span><span class="w"> </span><span class="nv">where</span><span class="w"> </span><span class="nv">username</span><span class="o">=</span><span class="s1">'" &amp; eid &amp; "'</span><span class="err">"</span>
<span class="err">    If connection.State &lt;&gt; ConnectionState.Open Then</span>
<span class="err">        connection.Open()</span>
<span class="err">    End If</span>
<span class="err">    command = New SqlCommand(sqlQry, connection)</span>

<span class="err">    'More code fooing and barring</span>

<span class="err">    dr = command.ExecuteReader()</span>
<span class="err">    If dr.Read() Then</span>
<span class="w">        </span><span class="nv">lblFirstName</span>.<span class="nv">Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Convert</span>.<span class="nv">ToString</span><span class="ss">(</span><span class="nv">dr</span><span class="ss">(</span><span class="s2">"FirstName"</span><span class="ss">))</span>
<span class="w">        </span>...
<span class="w">    </span><span class="k">End</span><span class="w"> </span><span class="k">If</span>
<span class="w">    </span><span class="nv">mpe</span>.<span class="k">Show</span><span class="ss">()</span>
<span class="nv">Catch</span>

<span class="nv">Finally</span>
<span class="w">    </span><span class="nv">command</span>.<span class="nv">Dispose</span><span class="ss">()</span>
<span class="w">    </span><span class="nv">dr</span>.<span class="nv">Close</span><span class="ss">()</span><span class="w">             </span><span class="err">' &lt;-- NRE</span>
<span class="err">    connection.Close()</span>
<span class="err">End Try</span>
</pre></div>

<p>This is a case of an object not being created as expected, but also
demonstrates the counter usefulness of an empty <code>Catch</code>.</p>
<p>There is an extra comma in the SQL (after 'mailaddress') which results in an
exception at <code>.ExecuteReader</code>. After the <code>Catch</code> does nothing, <code>Finally</code> tries
to perform clean up, but since you cannot <code>Close</code> a null <code>DataReader</code> object,
a brand new <code>NullReferenceException</code> results.</p>
<p>An empty <code>Catch</code> block is the devil's playground. This OP was baffled why he
was getting an NRE in the <code>Finally</code> block. In other situations, an empty
<code>Catch</code> may result in something else much further downstream going haywire and
cause you to spend time looking at the wrong things in the wrong place for the
problem. (The "silent exception" described above provides the same
entertainment value.)</p>
<p><strong>Remedy</strong></p>
<p>Don't use empty Try/Catch blocks - let the code crash so you can a) identify
the cause b) identify the location and c) apply a proper remedy. Try/Catch
blocks are not intended to hide exceptions from the person uniquely qualified
to fix them - the developer.</p>
<hr>
<h3>DBNull is not the same as Nothing</h3>
<div class="code"><pre class="code literal-block"><span class="k">For</span><span class="w"> </span><span class="nv">Each</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">DataGridViewRow</span><span class="w"> </span><span class="nv">In</span><span class="w"> </span><span class="nv">dgvPlanning</span>.<span class="nv">Rows</span>
<span class="w">    </span><span class="k">If</span><span class="w"> </span><span class="nv">Not</span><span class="w"> </span><span class="nv">IsDBNull</span><span class="ss">(</span><span class="nv">row</span>.<span class="nv">Cells</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>.<span class="nv">Value</span><span class="ss">)</span><span class="w"> </span><span class="k">Then</span>
<span class="w">        </span>...
</pre></div>

<p>The <code>IsDBNull</code> function is used to test if a <em>value</em> equals <code>System.DBNull</code>:
From MSDN:</p>
<blockquote>
<p>The System.DBNull value indicates that the Object represents missing or non-
existent data. DBNull is not the same as Nothing, which indicates that a
variable has not yet been initialized.</p>
</blockquote>
<p><strong>Remedy</strong></p>
<div class="code"><pre class="code literal-block"><span class="k">If</span><span class="w"> </span><span class="nv">row</span>.<span class="nv">Cells</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span><span class="w"> </span><span class="nv">IsNot</span><span class="w"> </span><span class="nv">Nothing</span><span class="w"> </span><span class="k">Then</span><span class="w"> </span>...
</pre></div>

<p>As before, you can test for Nothing, then for a specific value:</p>
<div class="code"><pre class="code literal-block"><span class="k">If</span><span class="w"> </span><span class="ss">(</span><span class="nv">row</span>.<span class="nv">Cells</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span><span class="w"> </span><span class="nv">IsNot</span><span class="w"> </span><span class="nv">Nothing</span><span class="ss">)</span><span class="w"> </span><span class="nv">AndAlso</span><span class="w"> </span><span class="ss">(</span><span class="nv">IsDBNull</span><span class="ss">(</span><span class="nv">row</span>.<span class="nv">Cells</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>.<span class="nv">Value</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">False</span><span class="ss">)</span><span class="w"> </span><span class="k">Then</span>
</pre></div>

<p><strong>Example 2</strong></p>
<div class="code"><pre class="code literal-block"><span class="nv">Dim</span><span class="w"> </span><span class="nv">getFoo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">(</span><span class="nv">From</span><span class="w"> </span><span class="nv">f</span><span class="w"> </span><span class="nv">In</span><span class="w"> </span><span class="nv">dbContext</span>.<span class="nv">FooBars</span>
<span class="w">               </span><span class="nv">Where</span><span class="w"> </span><span class="nv">f</span>.<span class="nv">something</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">something</span>
<span class="w">               </span><span class="nv">Select</span><span class="w"> </span><span class="nv">f</span><span class="ss">)</span>.<span class="nv">FirstOrDefault</span>

<span class="k">If</span><span class="w"> </span><span class="nv">Not</span><span class="w"> </span><span class="nv">IsDBNull</span><span class="ss">(</span><span class="nv">getFoo</span><span class="ss">)</span><span class="w"> </span><span class="k">Then</span>
<span class="w">    </span><span class="k">If</span><span class="w"> </span><span class="nv">IsDBNull</span><span class="ss">(</span><span class="nv">getFoo</span>.<span class="nv">user_id</span><span class="ss">)</span><span class="w"> </span><span class="k">Then</span>
<span class="w">        </span><span class="nv">txtFirst</span>.<span class="nv">Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">getFoo</span>.<span class="nv">first_name</span>
<span class="w">    </span><span class="k">Else</span>
<span class="w">       </span>...
</pre></div>

<p><code>FirstOrDefault</code> returns the first item or the default value, which is
<code>Nothing</code> for reference types and never <code>DBNull</code>:</p>
<div class="code"><pre class="code literal-block"><span class="k">If</span><span class="w"> </span><span class="nv">getFoo</span><span class="w"> </span><span class="nv">IsNot</span><span class="w"> </span><span class="nv">Nothing</span><span class="w"> </span><span class="k">Then</span>...
</pre></div>

<hr>
<h3>Controls</h3>
<div class="code"><pre class="code literal-block"><span class="nv">Dim</span><span class="w"> </span><span class="nv">chk</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">CheckBox</span>

<span class="nv">chk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">CType</span><span class="ss">(</span><span class="nv">Me</span>.<span class="nv">Controls</span><span class="ss">(</span><span class="nv">chkName</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">CheckBox</span><span class="ss">)</span>
<span class="k">If</span><span class="w"> </span><span class="nv">chk</span>.<span class="nv">Checked</span><span class="w"> </span><span class="k">Then</span>
<span class="w">    </span><span class="k">Return</span><span class="w"> </span><span class="nv">chk</span>
<span class="k">End</span><span class="w"> </span><span class="k">If</span>
</pre></div>

<p>If a <code>CheckBox</code> with <code>chkName</code> can't be found (or exists in a <code>GroupBox</code>),
then <code>chk</code> will be Nothing and be attempting to reference any property will
result in an exception.</p>
<p><strong>Remedy</strong></p>
<div class="code"><pre class="code literal-block"><span class="k">If</span><span class="w"> </span><span class="ss">(</span><span class="nv">chk</span><span class="w"> </span><span class="nv">IsNot</span><span class="w"> </span><span class="nv">Nothing</span><span class="ss">)</span><span class="w"> </span><span class="nv">AndAlso</span><span class="w"> </span><span class="ss">(</span><span class="nv">chk</span>.<span class="nv">Checked</span><span class="ss">)</span><span class="w"> </span><span class="k">Then</span><span class="w"> </span>...
</pre></div>

<h4>The DataGridView</h4>
<p>The DGV has a few quirks seen periodically:</p>
<div class="code"><pre class="code literal-block">dgvBooks.DataSource = loan.Books
dgvBooks.Columns("ISBN").Visible = True       ' NullReferenceException
dgvBooks.Columns("Title").DefaultCellStyle.Format = "C"
dgvBooks.Columns("Author").DefaultCellStyle.Format = "C"
dgvBooks.Columns("Price").DefaultCellStyle.Format = "C"
</pre></div>

<p>If <code>dgvBooks</code> has <code>AutoGenerateColumns = True</code>, it will create the columns,
but it does not name them, so the above code fails when it references them by
name.</p>
<p><strong>Remedy</strong></p>
<p>Name the columns manually, or reference by index:</p>
<div class="code"><pre class="code literal-block">dgvBooks.Columns(0).Visible = True
</pre></div>

<h4>Example 2 — Beware of the NewRow</h4>
<div class="code"><pre class="code literal-block"><span class="nv">xlWorkSheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">xlWorkBook</span>.<span class="nv">Sheets</span><span class="ss">(</span><span class="s2">"sheet1"</span><span class="ss">)</span>

<span class="k">For</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">To</span><span class="w"> </span><span class="nv">myDGV</span>.<span class="nv">RowCount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">For</span><span class="w"> </span><span class="nv">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">To</span><span class="w"> </span><span class="nv">myDGV</span>.<span class="nv">ColumnCount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">For</span><span class="w"> </span><span class="nv">k</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">Integer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">To</span><span class="w"> </span><span class="nv">myDGV</span>.<span class="nv">Columns</span>.<span class="nv">Count</span>
<span class="w">            </span><span class="nv">xlWorkSheet</span>.<span class="nv">Cells</span><span class="ss">(</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">k</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">myDGV</span>.<span class="nv">Columns</span><span class="ss">(</span><span class="nv">k</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="ss">)</span>.<span class="nv">HeaderText</span>
<span class="w">            </span><span class="nv">xlWorkSheet</span>.<span class="nv">Cells</span><span class="ss">(</span><span class="nv">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span>,<span class="w"> </span><span class="nv">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">myDGV</span><span class="ss">(</span><span class="nv">j</span>,<span class="w"> </span><span class="nv">i</span><span class="ss">)</span>.<span class="nv">Value</span>.<span class="nv">ToString</span><span class="ss">()</span>
<span class="w">        </span><span class="k">Next</span>
<span class="w">    </span><span class="k">Next</span>
<span class="k">Next</span>
</pre></div>

<p>When your <code>DataGridView</code> has <code>AllowUserToAddRows</code> as <code>True</code> (the default), the
<code>Cells</code> in the blank/new row at the bottom will all contain <code>Nothing</code>. Most
attempts to use the contents (for example, <code>ToString</code>) will result in an NRE.</p>
<p><strong>Remedy</strong></p>
<p>Use a <code>For/Each</code> loop and test the <code>IsNewRow</code> property to determine if it is
that last row. This works whether <code>AllowUserToAddRows</code> is true or not:</p>
<div class="code"><pre class="code literal-block"><span class="k">For</span><span class="w"> </span><span class="nv">Each</span><span class="w"> </span><span class="nv">r</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">DataGridViewRow</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">myDGV</span>.<span class="nv">Rows</span>
<span class="w">    </span><span class="k">If</span><span class="w"> </span><span class="nv">r</span>.<span class="nv">IsNewRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">False</span><span class="w"> </span><span class="k">Then</span>
<span class="w">         </span><span class="err">' ok to use this row</span>
</pre></div>

<p>If you do use a <code>For n</code> loop, modify the row count or use <code>Exit For</code> when
<code>IsNewRow</code> is true.</p>
<hr>
<h3>My.Settings (StringCollection)</h3>
<p>Under certain circumstances, trying to use an item from <code>My.Settings</code> which is
a <code>StringCollection</code> can result in a NullReference the first time you use it.
The solution is the same, but not as obvious. Consider:</p>
<div class="code"><pre class="code literal-block">My.Settings.FooBars.Add("ziggy")         ' foobars is a string collection
</pre></div>

<p>Since VB is managing Settings for you, it is reasonable to expect it to
initialize the collection. It will, but only if you have previously added an
initial entry to the collection (in the Settings editor). Since the collection
is (apparently) initialized when an item is added, it remains <code>Nothing</code> when
there are no items in the Settings editor to add.</p>
<p><strong>Remedy</strong></p>
<p>Initialize the settings collection in the form's <code>Load</code> event handler, if/when
needed:</p>
<div class="code"><pre class="code literal-block"><span class="k">If</span><span class="w"> </span><span class="nv">My</span>.<span class="nv">Settings</span>.<span class="nv">FooBars</span><span class="w"> </span><span class="nv">Is</span><span class="w"> </span><span class="nv">Nothing</span><span class="w"> </span><span class="k">Then</span>
<span class="w">    </span><span class="nv">My</span>.<span class="nv">Settings</span>.<span class="nv">FooBars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">New</span><span class="w"> </span><span class="nv">System</span>.<span class="nv">Collections</span>.<span class="nv">Specialized</span>.<span class="nv">StringCollection</span>
<span class="k">End</span><span class="w"> </span><span class="k">If</span>
</pre></div>

<p>Typically, the <code>Settings</code> collection will only need to be initialized the
first time the application runs. An alternate remedy is to add an initial
value to your collection in <strong>Project - &gt; Settings | FooBars</strong>, save the
project, then remove the fake value.</p>
<hr>
<h2>Key Points</h2>
<p>You probably forgot the <code>New</code> operator.</p>
<p>or</p>
<p>Something you assumed would perform flawlessly to return an initialized object
to your code, did not.</p>
<p>Don't ignore compiler warnings (ever) and use <code>Option Strict On</code> (always).</p>
<hr>
<p>MSDN NullReference Exception</p>
<p><br><br><a href="../what-is-a-nullreferenceexception-and-how-do-i-fix-it/">查看原文</a></p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/net/" rel="tag">.net</a></li>
            <li><a class="tag p-category" href="../../categories/csharp/" rel="tag">cSharp</a></li>
            <li><a class="tag p-category" href="../../categories/null/" rel="tag">null</a></li>
            <li><a class="tag p-category" href="../../categories/nullreferenceexception/" rel="tag">nullreferenceexception</a></li>
            <li><a class="tag p-category" href="../../categories/vbnet/" rel="tag">vb.net</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../huo-qu-shi-li-de-lei-ming/" rel="prev" title="获取实例的类名">Previous post</a>
            </li>
            <li class="next">
                <a href="../addtransient-addscoped-he-addsingleton-fu-wu-chai-yi/" rel="next" title="AddTransient、AddScoped 和 AddSingleton 服务差异">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
