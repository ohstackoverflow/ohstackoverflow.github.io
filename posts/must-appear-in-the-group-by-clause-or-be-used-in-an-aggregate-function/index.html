<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>must appear in the GROUP BY clause or be used in an aggregate function | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/must-appear-in-the-group-by-clause-or-be-used-in-an-aggregate-function/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../should-i-declare-jackson-s-objectmapper-as-a-static-field/" title="Should I declare Jackson's ObjectMapper as a static field?" type="text/html">
<link rel="next" href="../dyld-library-not-loaded-usr-local-opt-openssl-lib-libssl-1-0-0-dylib/" title="dyld: Library not loaded: /usr/local/opt/openssl/lib/libssl.1.0.0.dylib" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="must appear in the GROUP BY clause or be used in an aggregate function">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/must-appear-in-the-group-by-clause-or-be-used-in-an-aggregate-function/">
<meta property="og:description" content="I have a table that looks like this caller 'makerar'



cname
wmname
avg




canada
zoro
2.0000000000000000


spain
luffy
1.00000000000000000000


spain
usopp
5.0000000000000000



And I want to selec">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-03-03T10:55:41+08:00">
<meta property="article:tag" content="aggregate-functions">
<meta property="article:tag" content="group-by">
<meta property="article:tag" content="postgresql-9.1">
<meta property="article:tag" content="sql">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">must appear in the GROUP BY clause or be used in an aggregate function</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T10:55:41+08:00" itemprop="datePublished" title="2023-03-03 10:55">2023-03-03 10:55</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>I have a table that looks like this caller 'makerar'</p>
<table>
<thead><tr>
<th>cname</th>
<th>wmname</th>
<th>avg</th>
</tr></thead>
<tbody>
<tr>
<td>canada</td>
<td>zoro</td>
<td>2.0000000000000000</td>
</tr>
<tr>
<td>spain</td>
<td>luffy</td>
<td>1.00000000000000000000</td>
</tr>
<tr>
<td>spain</td>
<td>usopp</td>
<td>5.0000000000000000</td>
</tr>
</tbody>
</table>
<p>And I want to select the maximum avg for each cname.</p>
<div class="code"><pre class="code literal-block">SELECT cname, wmname, MAX(avg)  FROM makerar GROUP BY cname;
</pre></div>

<p>but I will get an error,</p>
<div class="code"><pre class="code literal-block"><span class="n">ERROR</span><span class="o">:</span><span class="w">  </span><span class="n">column</span><span class="w"> </span><span class="s2">"makerar.wmname"</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">appear</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">GROUP</span><span class="w"> </span><span class="n">BY</span><span class="w"> </span><span class="n">clause</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">an</span><span class="w">   </span><span class="n">aggregate</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span>
<span class="n">LINE</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">SELECT</span><span class="w"> </span><span class="n">cname</span><span class="o">,</span><span class="w"> </span><span class="n">wmname</span><span class="o">,</span><span class="w"> </span><span class="n">MAX</span><span class="o">(</span><span class="n">avg</span><span class="o">)</span><span class="w">  </span><span class="n">FROM</span><span class="w"> </span><span class="n">makerar</span><span class="w"> </span><span class="n">GROUP</span><span class="w"> </span><span class="n">BY</span><span class="w"> </span><span class="n">cname</span><span class="o">;</span>
</pre></div>

<p>so i do this</p>
<div class="code"><pre class="code literal-block">SELECT cname, wmname, MAX(avg)  FROM makerar GROUP BY cname, wmname;
</pre></div>

<p>however this will not give the intented results, and the incorrect output
below is shown.</p>
<table>
<thead><tr>
<th>cname</th>
<th>wmname</th>
<th>max</th>
</tr></thead>
<tbody>
<tr>
<td>canada</td>
<td>zoro</td>
<td>2.0000000000000000</td>
</tr>
<tr>
<td>spain</td>
<td>luffy</td>
<td>1.00000000000000000000</td>
</tr>
<tr>
<td>spain</td>
<td>usopp</td>
<td>5.0000000000000000</td>
</tr>
</tbody>
</table>
<p>Actual Results should be</p>
<table>
<thead><tr>
<th>cname</th>
<th>wmname</th>
<th>max</th>
</tr></thead>
<tbody>
<tr>
<td>canada</td>
<td>zoro</td>
<td>2.0000000000000000</td>
</tr>
<tr>
<td>spain</td>
<td>usopp</td>
<td>5.0000000000000000</td>
</tr>
</tbody>
</table>
<p>How can I go about fixing this issue?</p>
<p>Note: This table is a VIEW created from a previous operation.</p>
<p><br><br></p>
<h2>Answer</h2>
<p>Yes, this is a common aggregation problem. Before SQL3 (1999), the selected
fields must appear in the <code>GROUP BY</code> clause[*].</p>
<p>To workaround this issue, you must calculate the aggregate in a sub-query and
then join it with itself to get the additional columns you'd need to show:</p>
<div class="code"><pre class="code literal-block">SELECT m.cname, m.wmname, t.mx
FROM (
    SELECT cname, MAX(avg) AS mx
    FROM makerar
    GROUP BY cname
    ) t JOIN makerar m ON m.cname = t.cname AND t.mx = m.avg
;

 cname  | wmname |          mx           
--------+--------+------------------------
 canada | zoro   |     2.0000000000000000
 spain  | usopp  |     5.0000000000000000
</pre></div>

<hr>
<p>But you may also use window functions, which looks simpler:</p>
<div class="code"><pre class="code literal-block">SELECT cname, wmname, MAX(avg) OVER (PARTITION BY cname) AS mx
FROM makerar
;
</pre></div>

<p>The only thing with this method is that it will show all records (window
functions do not group). But it will show the correct (i.e. maxed at <code>cname</code>
level) <code>MAX</code> for the country in each row, so it's up to you:</p>
<div class="code"><pre class="code literal-block"> cname  | wmname |          mx           
--------+--------+------------------------
 canada | zoro   |     2.0000000000000000
 spain  | luffy  |     5.0000000000000000
 spain  | usopp  |     5.0000000000000000
</pre></div>

<p>The solution, arguably less elegant, to show the only <code>(cname, wmname)</code> tuples
matching the max value, is:</p>
<div class="code"><pre class="code literal-block"><span class="n">SELECT</span><span class="w"> </span><span class="n">DISTINCT</span><span class="w"> </span><span class="o">/*</span><span class="w"> </span><span class="n">distinct</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="n">matters</span><span class="p">,</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">maybe</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">various</span><span class="w"> </span><span class="n">tuples</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="nb">max</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="n">m</span><span class="o">.</span><span class="n">cname</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">wmname</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="o">.</span><span class="n">avg</span><span class="w"> </span><span class="n">AS</span><span class="w"> </span><span class="n">mx</span>
<span class="n">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">SELECT</span><span class="w"> </span><span class="n">cname</span><span class="p">,</span><span class="w"> </span><span class="n">wmname</span><span class="p">,</span><span class="w"> </span><span class="n">avg</span><span class="p">,</span><span class="w"> </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="n">BY</span><span class="w"> </span><span class="n">avg</span><span class="w"> </span><span class="n">DESC</span><span class="p">)</span><span class="w"> </span><span class="n">AS</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span>
<span class="w">    </span><span class="n">FROM</span><span class="w"> </span><span class="n">makerar</span>
<span class="p">)</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">JOIN</span><span class="w"> </span><span class="n">makerar</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">ON</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">cname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="o">.</span><span class="n">cname</span><span class="w"> </span><span class="n">AND</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">wmname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="o">.</span><span class="n">wmname</span><span class="w"> </span><span class="n">AND</span><span class="w"> </span><span class="n">t</span><span class="o">.</span><span class="n">rn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="p">;</span>


<span class="w"> </span><span class="n">cname</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">wmname</span><span class="w"> </span><span class="o">|</span><span class="w">          </span><span class="n">mx</span><span class="w">           </span>
<span class="o">--------+--------+------------------------</span>
<span class="w"> </span><span class="n">canada</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">zoro</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="mf">2.0000000000000000</span>
<span class="w"> </span><span class="n">spain</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">usopp</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="mf">5.0000000000000000</span>
</pre></div>

<hr>
<p>[*]: Interestingly enough, even though the spec sort of allows to select non-
grouped fields, major engines seem to not really like it. Oracle and SQLServer
just don't allow this at all. Mysql used to allow it by default, but now since
5.7 the administrator needs to enable this option (<code>ONLY_FULL_GROUP_BY</code>)
manually in the server configuration for this feature to be supported...</p>
<p><br></p>
<h3>Suggest</h3>
<p>In Postgres, you can also use the special <strong><code>DISTINCT ON (expression)</code></strong>
syntax:</p>
<div class="code"><pre class="code literal-block">SELECT DISTINCT ON (cname) 
    cname, wmname, avg
FROM 
    makerar 
ORDER BY 
    cname, avg DESC ;
</pre></div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/aggregate-functions/" rel="tag">aggregate-functions</a></li>
            <li><a class="tag p-category" href="../../categories/group-by/" rel="tag">group-by</a></li>
            <li><a class="tag p-category" href="../../categories/postgresql-91/" rel="tag">postgresql-9.1</a></li>
            <li><a class="tag p-category" href="../../categories/sql/" rel="tag">sql</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../should-i-declare-jackson-s-objectmapper-as-a-static-field/" rel="prev" title="Should I declare Jackson's ObjectMapper as a static field?">Previous post</a>
            </li>
            <li class="next">
                <a href="../dyld-library-not-loaded-usr-local-opt-openssl-lib-libssl-1-0-0-dylib/" rel="next" title="dyld: Library not loaded: /usr/local/opt/openssl/lib/libssl.1.0.0.dylib">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
