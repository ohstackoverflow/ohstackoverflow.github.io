<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Best way to select random rows PostgreSQL | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/best-way-to-select-random-rows-postgresql/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../git-stash-vs-shelve-in-intellij-idea/" title="Git Stash vs Shelve in IntelliJ IDEA" type="text/html">
<link rel="next" href="../jquery-get-the-rendered-height-of-an-element/" title="jQuery get the rendered height of an element?" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="Best way to select random rows PostgreSQL">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/best-way-to-select-random-rows-postgresql/">
<meta property="og:description" content="I want a random selection of rows in PostgreSQL, I tried this:
select * from table where random() &lt; 0.01;


But some other recommend this:
select * from table order by random() limit 1000;


I have a ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-03-03T11:18:24+08:00">
<meta property="article:tag" content="performance">
<meta property="article:tag" content="postgresql">
<meta property="article:tag" content="random">
<meta property="article:tag" content="sql">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Best way to select random rows PostgreSQL</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T11:18:24+08:00" itemprop="datePublished" title="2023-03-03 11:18">2023-03-03 11:18</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>I want a random selection of rows in PostgreSQL, I tried this:</p>
<div class="code"><pre class="code literal-block"><span class="nv">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">table</span><span class="w"> </span><span class="nv">where</span><span class="w"> </span><span class="k">random</span><span class="ss">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>.<span class="mi">01</span><span class="c1">;</span>
</pre></div>

<p>But some other recommend this:</p>
<div class="code"><pre class="code literal-block"><span class="nv">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">table</span><span class="w"> </span><span class="nv">order</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="k">random</span><span class="ss">()</span><span class="w"> </span><span class="nv">limit</span><span class="w"> </span><span class="mi">1000</span><span class="c1">;</span>
</pre></div>

<p>I have a very large table with 500 Million rows, I want it to be fast.</p>
<p>Which approach is better? What are the differences? What is the best way to
select random rows?</p>
<p><br><br></p>
<h2>Answer</h2>
<h3>Fast ways</h3>
<p>Given your specifications (plus additional info in the comments),</p>
<ul>
<li>You have a numeric ID column (integer numbers) with only few (or moderately few) gaps.</li>
<li>Obviously no or few write operations.</li>
<li>Your ID column has to be indexed! A primary key serves nicely.</li>
</ul>
<p>The query below does not need a sequential scan of the big table, only an
index scan.</p>
<p>First, get estimates for the main query:</p>
<div class="code"><pre class="code literal-block">SELECT count(*) AS ct              -- optional
     , min(id)  AS min_id
     , max(id)  AS max_id
     , max(id) - min(id) AS id_span
FROM   big;
</pre></div>

<p>The only possibly expensive part is the <code>count(*)</code> (for huge tables). Given
above specifications, you don't need it. An <strong>estimate to replace the full
count</strong> will do just fine, available at almost no cost:</p>
<div class="code"><pre class="code literal-block"><span class="n">SELECT</span><span class="w"> </span><span class="p">(</span><span class="n">reltuples</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">relpages</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">pg_relation_size</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">8192</span><span class="p">))</span><span class="o">::</span><span class="n">bigint</span><span class="w"> </span><span class="n">AS</span><span class="w"> </span><span class="n">ct</span>
<span class="n">FROM</span><span class="w">   </span><span class="n">pg_class</span>
<span class="n">WHERE</span><span class="w">  </span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">'</span><span class="n">big</span><span class="p">'</span><span class="o">::</span><span class="n">regclass</span><span class="p">;</span><span class="w">  </span><span class="o">--</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">name</span>
</pre></div>

<p>Detailed explanation:</p>
<ul>
<li>Fast way to discover the row count of a table in PostgreSQL</li>
</ul>
<p>As long as <code>ct</code> isn't <em>much</em> smaller than <code>id_span</code>, the query will outperform
other approaches.</p>
<div class="code"><pre class="code literal-block"><span class="nv">WITH</span><span class="w"> </span><span class="nb">params</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="ss">(</span>
<span class="w">   </span><span class="nv">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w">       </span><span class="nv">AS</span><span class="w"> </span><span class="nv">min_id</span><span class="w">           </span><span class="o">--</span><span class="w"> </span><span class="nv">minimum</span><span class="w"> </span><span class="nv">id</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nv">current</span><span class="w"> </span><span class="nv">min</span><span class="w"> </span><span class="nv">id</span>
<span class="w">        </span>,<span class="w"> </span><span class="mi">5100000</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">id_span</span><span class="w">          </span><span class="o">--</span><span class="w"> </span><span class="nv">rounded</span><span class="w"> </span><span class="nv">up</span>.<span class="w"> </span><span class="ss">(</span><span class="nv">max_id</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">min_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">buffer</span><span class="ss">)</span>
<span class="w">    </span><span class="ss">)</span>
<span class="nv">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="nv">FROM</span><span class="w">  </span><span class="ss">(</span>
<span class="w">   </span><span class="nv">SELECT</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">min_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">trunc</span><span class="ss">(</span><span class="k">random</span><span class="ss">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">id_span</span><span class="ss">)</span>::<span class="nv">integer</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">id</span>
<span class="w">   </span><span class="nv">FROM</span><span class="w">   </span><span class="nb">params</span><span class="w"> </span><span class="nv">p</span>
<span class="w">        </span>,<span class="w"> </span><span class="nv">generate_series</span><span class="ss">(</span><span class="mi">1</span>,<span class="w"> </span><span class="mi">1100</span><span class="ss">)</span><span class="w"> </span><span class="nv">g</span><span class="w">  </span><span class="o">--</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">buffer</span>
<span class="w">   </span><span class="nv">GROUP</span><span class="w">  </span><span class="nv">BY</span><span class="w"> </span><span class="mi">1</span><span class="w">                        </span><span class="o">--</span><span class="w"> </span><span class="nv">trim</span><span class="w"> </span><span class="nv">duplicates</span>
<span class="ss">)</span><span class="w"> </span><span class="nv">r</span>
<span class="nv">JOIN</span><span class="w">   </span><span class="nv">big</span><span class="w"> </span><span class="nv">USING</span><span class="w"> </span><span class="ss">(</span><span class="nv">id</span><span class="ss">)</span>
<span class="nv">LIMIT</span><span class="w">  </span><span class="mi">1000</span><span class="c1">;                          -- trim surplus</span>
</pre></div>

<ul>
<li>
<p>Generate random numbers in the <code>id</code> space. You have "few gaps", so add 10 % (enough to easily cover the blanks) to the number of rows to retrieve.</p>
</li>
<li>
<p>Each <code>id</code> can be picked multiple times by chance (though very unlikely with a big id space), so group the generated numbers (or use <code>DISTINCT</code>).</p>
</li>
<li>
<p>Join the <code>id</code>s to the big table. This should be very fast with the index in place.</p>
</li>
<li>
<p>Finally trim surplus <code>id</code>s that have not been eaten by dupes and gaps. Every row has a <strong>completely equal chance</strong> to be picked.</p>
</li>
</ul>
<h4>Short version</h4>
<p>You can <strong>simplify</strong> this query. The CTE in the query above is just for
educational purposes:</p>
<div class="code"><pre class="code literal-block"><span class="nv">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="nv">FROM</span><span class="w">  </span><span class="ss">(</span>
<span class="w">   </span><span class="nv">SELECT</span><span class="w"> </span><span class="nv">DISTINCT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">trunc</span><span class="ss">(</span><span class="k">random</span><span class="ss">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5100000</span><span class="ss">)</span>::<span class="nv">integer</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">id</span>
<span class="w">   </span><span class="nv">FROM</span><span class="w">   </span><span class="nv">generate_series</span><span class="ss">(</span><span class="mi">1</span>,<span class="w"> </span><span class="mi">1100</span><span class="ss">)</span><span class="w"> </span><span class="nv">g</span>
<span class="w">   </span><span class="ss">)</span><span class="w"> </span><span class="nv">r</span>
<span class="nv">JOIN</span><span class="w">   </span><span class="nv">big</span><span class="w"> </span><span class="nv">USING</span><span class="w"> </span><span class="ss">(</span><span class="nv">id</span><span class="ss">)</span>
<span class="nv">LIMIT</span><span class="w">  </span><span class="mi">1000</span><span class="c1">;</span>
</pre></div>

<h3>Refine with rCTE</h3>
<p>Especially if you are not so sure about gaps and estimates.</p>
<div class="code"><pre class="code literal-block"><span class="nv">WITH</span><span class="w"> </span><span class="nv">RECURSIVE</span><span class="w"> </span><span class="nv">random_pick</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="ss">(</span>
<span class="w">   </span><span class="nv">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="w">   </span><span class="nv">FROM</span><span class="w">  </span><span class="ss">(</span>
<span class="w">      </span><span class="nv">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">trunc</span><span class="ss">(</span><span class="k">random</span><span class="ss">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5100000</span><span class="ss">)</span>::<span class="nv">int</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">id</span>
<span class="w">      </span><span class="nv">FROM</span><span class="w">   </span><span class="nv">generate_series</span><span class="ss">(</span><span class="mi">1</span>,<span class="w"> </span><span class="mi">1030</span><span class="ss">)</span><span class="w">  </span><span class="o">--</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">few</span><span class="w"> </span><span class="nv">percent</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">adapt</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">your</span><span class="w"> </span><span class="nv">needs</span>
<span class="w">      </span><span class="nv">LIMIT</span><span class="w">  </span><span class="mi">1030</span><span class="w">                      </span><span class="o">--</span><span class="w"> </span><span class="nv">hint</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">query</span><span class="w"> </span><span class="nv">planner</span>
<span class="w">      </span><span class="ss">)</span><span class="w"> </span><span class="nv">r</span>
<span class="w">   </span><span class="nv">JOIN</span><span class="w">   </span><span class="nv">big</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nv">USING</span><span class="w"> </span><span class="ss">(</span><span class="nv">id</span><span class="ss">)</span><span class="w">             </span><span class="o">--</span><span class="w"> </span><span class="nv">eliminate</span><span class="w"> </span><span class="nv">miss</span>

<span class="w">   </span><span class="nv">UNION</span><span class="w">                               </span><span class="o">--</span><span class="w"> </span><span class="nv">eliminate</span><span class="w"> </span><span class="nv">dupe</span>
<span class="w">   </span><span class="nv">SELECT</span><span class="w"> </span><span class="nv">b</span>.<span class="o">*</span>
<span class="w">   </span><span class="nv">FROM</span><span class="w">  </span><span class="ss">(</span>
<span class="w">      </span><span class="nv">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">trunc</span><span class="ss">(</span><span class="k">random</span><span class="ss">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5100000</span><span class="ss">)</span>::<span class="nv">int</span><span class="w"> </span><span class="nv">AS</span><span class="w"> </span><span class="nv">id</span>
<span class="w">      </span><span class="nv">FROM</span><span class="w">   </span><span class="nv">random_pick</span><span class="w"> </span><span class="nv">r</span><span class="w">             </span><span class="o">--</span><span class="w"> </span><span class="nv">plus</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">percent</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">adapt</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">your</span><span class="w"> </span><span class="nv">needs</span>
<span class="w">      </span><span class="nv">LIMIT</span><span class="w">  </span><span class="mi">999</span><span class="w">                       </span><span class="o">--</span><span class="w"> </span><span class="nv">less</span><span class="w"> </span><span class="nv">than</span><span class="w"> </span><span class="mi">1000</span>,<span class="w"> </span><span class="nv">hint</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">query</span><span class="w"> </span><span class="nv">planner</span>
<span class="w">      </span><span class="ss">)</span><span class="w"> </span><span class="nv">r</span>
<span class="w">   </span><span class="nv">JOIN</span><span class="w">   </span><span class="nv">big</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nv">USING</span><span class="w"> </span><span class="ss">(</span><span class="nv">id</span><span class="ss">)</span><span class="w">             </span><span class="o">--</span><span class="w"> </span><span class="nv">eliminate</span><span class="w"> </span><span class="nv">miss</span>
<span class="w">   </span><span class="ss">)</span>
<span class="nv">TABLE</span><span class="w">  </span><span class="nv">random_pick</span>
<span class="nv">LIMIT</span><span class="w">  </span><span class="mi">1000</span><span class="c1">;  -- actual limit</span>
</pre></div>

<p>We can work with a <em><strong>smaller surplus</strong></em> in the base query. If there are too
many gaps so we don't find enough rows in the first iteration, the rCTE
continues to iterate with the recursive term. We still need relatively <em>few</em>
gaps in the ID space or the recursion may run dry before the limit is reached
- or we have to start with a large enough buffer which defies the purpose of
optimizing performance.</p>
<p>Duplicates are eliminated by the <code>UNION</code> in the rCTE.</p>
<p>The outer <code>LIMIT</code> makes the CTE stop as soon as we have enough rows.</p>
<p>This query is carefully drafted to use the available index, generate actually
random rows and not stop until we fulfill the limit (unless the recursion runs
dry). There are a number of pitfalls here if you are going to rewrite it.</p>
<h3>Wrap into function</h3>
<p>For repeated use with the <strong>same table</strong> with varying parameters:</p>
<div class="code"><pre class="code literal-block"><span class="n">CREATE</span><span class="w"> </span><span class="n">OR</span><span class="w"> </span><span class="n">REPLACE</span><span class="w"> </span><span class="n">FUNCTION</span><span class="w"> </span><span class="n">f_random_sample</span><span class="p">(</span><span class="n">_limit</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1000</span><span class="p">,</span><span class="w"> </span><span class="n">_gaps</span><span class="w"> </span><span class="kt">real</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.03</span><span class="p">)</span>
<span class="w">  </span><span class="n">RETURNS</span><span class="w"> </span><span class="n">SETOF</span><span class="w"> </span><span class="n">big</span>
<span class="w">  </span><span class="n">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="w"> </span><span class="n">VOLATILE</span><span class="w"> </span><span class="n">ROWS</span><span class="w"> </span><span class="mh">1000</span><span class="w"> </span><span class="n">AS</span>
<span class="n">$func</span><span class="err">$</span>
<span class="n">DECLARE</span>
<span class="w">   </span><span class="n">_surplus</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">_limit</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_gaps</span><span class="p">;</span>
<span class="w">   </span><span class="n">_estimate</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="w">           </span><span class="o">--</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">estimate</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">system</span>
<span class="w">      </span><span class="n">SELECT</span><span class="w"> </span><span class="p">(</span><span class="n">reltuples</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">relpages</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">pg_relation_size</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">8192</span><span class="p">))</span><span class="o">::</span><span class="n">bigint</span>
<span class="w">      </span><span class="n">FROM</span><span class="w">   </span><span class="n">pg_class</span>
<span class="w">      </span><span class="n">WHERE</span><span class="w">  </span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">'</span><span class="n">big</span><span class="p">'</span><span class="o">::</span><span class="n">regclass</span><span class="p">);</span>
<span class="n">BEGIN</span>
<span class="w">   </span><span class="n">RETURN</span><span class="w"> </span><span class="n">QUERY</span>
<span class="w">   </span><span class="n">WITH</span><span class="w"> </span><span class="n">RECURSIVE</span><span class="w"> </span><span class="n">random_pick</span><span class="w"> </span><span class="n">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="w">      </span><span class="n">FROM</span><span class="w">  </span><span class="p">(</span>
<span class="w">         </span><span class="n">SELECT</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">trunc</span><span class="p">(</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_estimate</span><span class="p">)</span><span class="o">::</span><span class="kt">int</span>
<span class="w">         </span><span class="n">FROM</span><span class="w">   </span><span class="n">generate_series</span><span class="p">(</span><span class="mh">1</span><span class="p">,</span><span class="w"> </span><span class="n">_surplus</span><span class="p">)</span><span class="w"> </span><span class="n">g</span>
<span class="w">         </span><span class="n">LIMIT</span><span class="w">  </span><span class="n">_surplus</span><span class="w">           </span><span class="o">--</span><span class="w"> </span><span class="n">hint</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">planner</span>
<span class="w">         </span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="w">      </span><span class="n">JOIN</span><span class="w">   </span><span class="n">big</span><span class="w"> </span><span class="n">USING</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">        </span><span class="o">--</span><span class="w"> </span><span class="n">eliminate</span><span class="w"> </span><span class="n">misses</span>

<span class="w">      </span><span class="n">UNION</span><span class="w">                        </span><span class="o">--</span><span class="w"> </span><span class="n">eliminate</span><span class="w"> </span><span class="n">dupes</span>
<span class="w">      </span><span class="n">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="w">      </span><span class="n">FROM</span><span class="w">  </span><span class="p">(</span>
<span class="w">         </span><span class="n">SELECT</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">trunc</span><span class="p">(</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_estimate</span><span class="p">)</span><span class="o">::</span><span class="kt">int</span>
<span class="w">         </span><span class="n">FROM</span><span class="w">   </span><span class="n">random_pick</span><span class="w">        </span><span class="o">--</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">recursive</span>
<span class="w">         </span><span class="n">LIMIT</span><span class="w">  </span><span class="n">_limit</span><span class="w">             </span><span class="o">--</span><span class="w"> </span><span class="n">hint</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">planner</span>
<span class="w">         </span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="w">      </span><span class="n">JOIN</span><span class="w">   </span><span class="n">big</span><span class="w"> </span><span class="n">USING</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">        </span><span class="o">--</span><span class="w"> </span><span class="n">eliminate</span><span class="w"> </span><span class="n">misses</span>
<span class="w">   </span><span class="p">)</span>
<span class="w">   </span><span class="n">TABLE</span><span class="w">  </span><span class="n">random_pick</span>
<span class="w">   </span><span class="n">LIMIT</span><span class="w">  </span><span class="n">_limit</span><span class="p">;</span>
<span class="n">END</span>
<span class="n">$func</span><span class="err">$</span><span class="p">;</span>
</pre></div>

<p>Call:</p>
<div class="code"><pre class="code literal-block">SELECT * FROM f_random_sample();
SELECT * FROM f_random_sample(500, 1.05);
</pre></div>

<h4>Generic function</h4>
<p>We can make this generic to work for <strong>any table</strong> with a unique integer
column (typically the PK): Pass the table as polymorphic type and (optionally)
the name of the PK column and use <code>EXECUTE</code>:</p>
<div class="code"><pre class="code literal-block"><span class="n">CREATE</span><span class="w"> </span><span class="n">OR</span><span class="w"> </span><span class="n">REPLACE</span><span class="w"> </span><span class="n">FUNCTION</span><span class="w"> </span><span class="n">f_random_sample</span><span class="p">(</span><span class="n">_tbl_type</span><span class="w"> </span><span class="n">anyelement</span>
<span class="w">                                         </span><span class="p">,</span><span class="w"> </span><span class="n">_id</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">'</span><span class="n">id</span><span class="p">'</span>
<span class="w">                                         </span><span class="p">,</span><span class="w"> </span><span class="n">_limit</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1000</span>
<span class="w">                                         </span><span class="p">,</span><span class="w"> </span><span class="n">_gaps</span><span class="w"> </span><span class="kt">real</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.03</span><span class="p">)</span>
<span class="w">  </span><span class="n">RETURNS</span><span class="w"> </span><span class="n">SETOF</span><span class="w"> </span><span class="n">anyelement</span>
<span class="w">  </span><span class="n">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="w"> </span><span class="n">VOLATILE</span><span class="w"> </span><span class="n">ROWS</span><span class="w"> </span><span class="mh">1000</span><span class="w"> </span><span class="n">AS</span>
<span class="n">$func</span><span class="err">$</span>
<span class="n">DECLARE</span>
<span class="w">   </span><span class="o">--</span><span class="w"> </span><span class="n">safe</span><span class="w"> </span><span class="n">syntax</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">quotes</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">needed</span>
<span class="w">   </span><span class="n">_tbl</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pg_typeof</span><span class="p">(</span><span class="n">_tbl_type</span><span class="p">)</span><span class="o">::</span><span class="n">text</span><span class="p">;</span>
<span class="w">   </span><span class="n">_estimate</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="n">SELECT</span><span class="w"> </span><span class="p">(</span><span class="n">reltuples</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">relpages</span>
<span class="w">                          </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">pg_relation_size</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">8192</span><span class="p">))</span><span class="o">::</span><span class="n">bigint</span>
<span class="w">                     </span><span class="n">FROM</span><span class="w">   </span><span class="n">pg_class</span><span class="w">  </span><span class="o">--</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">estimate</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">system</span>
<span class="w">                     </span><span class="n">WHERE</span><span class="w">  </span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_tbl</span><span class="o">::</span><span class="n">regclass</span><span class="p">);</span>
<span class="n">BEGIN</span>
<span class="w">   </span><span class="n">RETURN</span><span class="w"> </span><span class="n">QUERY</span><span class="w"> </span><span class="n">EXECUTE</span><span class="w"> </span><span class="n">format</span><span class="p">(</span>
<span class="w">   </span><span class="err">$$</span>
<span class="w">   </span><span class="n">WITH</span><span class="w"> </span><span class="n">RECURSIVE</span><span class="w"> </span><span class="n">random_pick</span><span class="w"> </span><span class="n">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="w">      </span><span class="n">FROM</span><span class="w">  </span><span class="p">(</span>
<span class="w">         </span><span class="n">SELECT</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">trunc</span><span class="p">(</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">$</span><span class="mh">1</span><span class="p">)</span><span class="o">::</span><span class="kt">int</span>
<span class="w">         </span><span class="n">FROM</span><span class="w">   </span><span class="n">generate_series</span><span class="p">(</span><span class="mh">1</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="mh">2</span><span class="p">)</span><span class="w"> </span><span class="n">g</span>
<span class="w">         </span><span class="n">LIMIT</span><span class="w">  </span><span class="err">$</span><span class="mh">2</span><span class="w">                 </span><span class="o">--</span><span class="w"> </span><span class="n">hint</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">planner</span>
<span class="w">         </span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="p">(</span><span class="o">%</span><span class="mh">2</span><span class="n">$I</span><span class="p">)</span>
<span class="w">      </span><span class="n">JOIN</span><span class="w">   </span><span class="o">%</span><span class="mh">1</span><span class="n">$s</span><span class="w"> </span><span class="n">USING</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="mh">2</span><span class="n">$I</span><span class="p">)</span><span class="w">     </span><span class="o">--</span><span class="w"> </span><span class="n">eliminate</span><span class="w"> </span><span class="n">misses</span>

<span class="w">      </span><span class="n">UNION</span><span class="w">                        </span><span class="o">--</span><span class="w"> </span><span class="n">eliminate</span><span class="w"> </span><span class="n">dupes</span>
<span class="w">      </span><span class="n">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="w">      </span><span class="n">FROM</span><span class="w">  </span><span class="p">(</span>
<span class="w">         </span><span class="n">SELECT</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">trunc</span><span class="p">(</span><span class="n">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">$</span><span class="mh">1</span><span class="p">)</span><span class="o">::</span><span class="kt">int</span>
<span class="w">         </span><span class="n">FROM</span><span class="w">   </span><span class="n">random_pick</span><span class="w">        </span><span class="o">--</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">recursive</span>
<span class="w">         </span><span class="n">LIMIT</span><span class="w">  </span><span class="err">$</span><span class="mh">3</span><span class="w">                 </span><span class="o">--</span><span class="w"> </span><span class="n">hint</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">planner</span>
<span class="w">         </span><span class="p">)</span><span class="w"> </span><span class="n">r</span><span class="p">(</span><span class="o">%</span><span class="mh">2</span><span class="n">$I</span><span class="p">)</span>
<span class="w">      </span><span class="n">JOIN</span><span class="w">   </span><span class="o">%</span><span class="mh">1</span><span class="n">$s</span><span class="w"> </span><span class="n">USING</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="mh">2</span><span class="n">$I</span><span class="p">)</span><span class="w">     </span><span class="o">--</span><span class="w"> </span><span class="n">eliminate</span><span class="w"> </span><span class="n">misses</span>
<span class="w">   </span><span class="p">)</span>
<span class="w">   </span><span class="n">TABLE</span><span class="w">  </span><span class="n">random_pick</span>
<span class="w">   </span><span class="n">LIMIT</span><span class="w">  </span><span class="err">$</span><span class="mh">3</span><span class="p">;</span>
<span class="w">   </span><span class="err">$$</span>
<span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">_tbl</span><span class="p">,</span><span class="w"> </span><span class="n">_id</span>
<span class="w">   </span><span class="p">)</span>
<span class="w">   </span><span class="n">USING</span><span class="w"> </span><span class="n">_estimate</span><span class="w">              </span><span class="o">--</span><span class="w"> </span><span class="err">$</span><span class="mh">1</span>
<span class="w">       </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">_limit</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_gaps</span><span class="p">)</span><span class="o">::</span><span class="kt">int</span><span class="w">  </span><span class="o">--</span><span class="w"> </span><span class="err">$</span><span class="mh">2</span><span class="w"> </span><span class="p">(</span><span class="s">"surplus"</span><span class="p">)</span>
<span class="w">       </span><span class="p">,</span><span class="w"> </span><span class="n">_limit</span><span class="w">                 </span><span class="o">--</span><span class="w"> </span><span class="err">$</span><span class="mh">3</span>
<span class="w">   </span><span class="p">;</span>
<span class="n">END</span>
<span class="n">$func</span><span class="err">$</span><span class="p">;</span>
</pre></div>

<p>Call with defaults (important!):</p>
<div class="code"><pre class="code literal-block"><span class="nt">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nt">FROM</span><span class="w"> </span><span class="nt">f_random_sample</span><span class="o">(</span><span class="nt">null</span><span class="p">::</span><span class="nd">big</span><span class="o">);</span><span class="w">  </span><span class="nt">--</span><span class="o">!</span>
</pre></div>

<p>Or more specifically:</p>
<div class="code"><pre class="code literal-block"><span class="nt">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nt">FROM</span><span class="w"> </span><span class="nt">f_random_sample</span><span class="o">(</span><span class="nt">null</span><span class="o">::</span><span class="s2">"my_TABLE"</span><span class="o">,</span><span class="w"> </span><span class="s1">'oDD ID'</span><span class="o">,</span><span class="w"> </span><span class="nt">666</span><span class="o">,</span><span class="w"> </span><span class="nt">1</span><span class="p">.</span><span class="nc">15</span><span class="o">);</span>
</pre></div>

<p>About the same performance as the static version.</p>
<p>Related:</p>
<ul>
<li>Refactor a PL/pgSQL function to return the output of various SELECT queries - chapter <em>"Various complete table types"</em>
</li>
<li>Return SETOF rows from PostgreSQL function</li>
<li>Format specifier for integer variables in format() for EXECUTE?</li>
<li>INSERT with dynamic table name in trigger function</li>
</ul>
<p>This is safe against SQL injection. See:</p>
<ul>
<li>Table name as a PostgreSQL function parameter</li>
<li>SQL injection in Postgres functions vs prepared queries</li>
</ul>
<h3>Possible alternative</h3>
<p>I your requirements allow <strong>identical sets for repeated</strong> calls (and we are
talking about repeated calls) consider a <strong><code>MATERIALIZED VIEW</code></strong>. Execute
above query once and write the result to a table. Users get a quasi random
selection at lightening speed. Refresh your random pick at intervals or events
of your choosing.</p>
<h3>Postgres 9.5 introduces <code>TABLESAMPLE SYSTEM (n)</code>
</h3>
<p>Where <em><code>n</code></em> is a percentage. The manual:</p>
<blockquote>
<p>The <code>BERNOULLI</code> and <code>SYSTEM</code> sampling methods each accept a single argument
which is the fraction of the table to sample, expressed as a <strong>percentage
between 0 and 100</strong>. This argument can be any <code>real</code>-valued expression.</p>
</blockquote>
<p>Bold emphasis mine. It's <em>very fast</em> , but the result is <em>not exactly random</em>.
The manual again:</p>
<blockquote>
<p>The <code>SYSTEM</code> method is significantly faster than the <code>BERNOULLI</code> method when
small sampling percentages are specified, but it may return a less-random
sample of the table as a result of clustering effects.</p>
</blockquote>
<p>The number of rows returned can vary wildly. For our example, to get <em>roughly</em>
1000 rows:</p>
<div class="code"><pre class="code literal-block">SELECT * FROM big TABLESAMPLE SYSTEM ((1000 * 100) / 5100000.0);
</pre></div>

<p>Related:</p>
<ul>
<li>Fast way to discover the row count of a table in PostgreSQL</li>
</ul>
<p><strong>Or</strong> install the additional module <strong>tsm_system_rows</strong> to get the number of
requested rows exactly (if there are enough) and allow for the more convenient
syntax:</p>
<div class="code"><pre class="code literal-block">SELECT * FROM big TABLESAMPLE SYSTEM_ROWS(1000);
</pre></div>

<p>See Evan's answer for details.</p>
<p>But that's still not exactly random.</p>
<p><br></p>
<h3>Suggest</h3>
<p>You can examine and compare the execution plan of both by using</p>
<div class="code"><pre class="code literal-block"><span class="nv">EXPLAIN</span><span class="w"> </span><span class="nv">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">table</span><span class="w"> </span><span class="nv">where</span><span class="w"> </span><span class="k">random</span><span class="ss">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>.<span class="mi">01</span><span class="c1">;</span>
<span class="nv">EXPLAIN</span><span class="w"> </span><span class="nv">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">table</span><span class="w"> </span><span class="nv">order</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="k">random</span><span class="ss">()</span><span class="w"> </span><span class="nv">limit</span><span class="w"> </span><span class="mi">1000</span><span class="c1">;</span>
</pre></div>

<p>A quick test on a large table1 shows, that the <code>ORDER BY</code> first sorts the
complete table and then picks the first 1000 items. Sorting a large table not
only reads that table but also involves reading and writing temporary files.
The <code>where random() &lt; 0.1</code> only scans the complete table once.</p>
<p>For large tables this might not what you want as even one complete table scan
might take to long.</p>
<p>A third proposal would be</p>
<div class="code"><pre class="code literal-block"><span class="nv">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">table</span><span class="w"> </span><span class="nv">where</span><span class="w"> </span><span class="k">random</span><span class="ss">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>.<span class="mi">01</span><span class="w"> </span><span class="nv">limit</span><span class="w"> </span><span class="mi">1000</span><span class="c1">;</span>
</pre></div>

<p>This one stops the table scan as soon as 1000 rows have been found and
therefore returns sooner. Of course this bogs down the randomness a bit, but
perhaps this is good enough in your case.</p>
<p><strong>Edit:</strong> Besides of this considerations, you might check out the already
asked questions for this. Using the query <code>[postgresql] random</code> returns quite
a few hits.</p>
<ul>
<li>quick random row selection in Postgres</li>
<li>How to retrieve randomized data rows from a postgreSQL table?</li>
<li>postgres: get random entries from table - too slow</li>
</ul>
<p>And a linked article of depez outlining several more approaches:</p>
<ul>
<li>http://www.depesz.com/index.php/2007/09/16/my-thoughts-on-getting-random-row/</li>
</ul>
<hr>
<p>1 "large" as in "the complete table will not fit into the memory".</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/performance/" rel="tag">performance</a></li>
            <li><a class="tag p-category" href="../../categories/postgresql/" rel="tag">postgresql</a></li>
            <li><a class="tag p-category" href="../../categories/random/" rel="tag">random</a></li>
            <li><a class="tag p-category" href="../../categories/sql/" rel="tag">sql</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../git-stash-vs-shelve-in-intellij-idea/" rel="prev" title="Git Stash vs Shelve in IntelliJ IDEA">Previous post</a>
            </li>
            <li class="next">
                <a href="../jquery-get-the-rendered-height-of-an-element/" rel="next" title="jQuery get the rendered height of an element?">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
