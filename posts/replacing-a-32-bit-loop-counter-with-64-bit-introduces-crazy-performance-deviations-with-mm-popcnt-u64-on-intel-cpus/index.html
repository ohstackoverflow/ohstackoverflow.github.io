<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Replacing a 32-bit loop counter with 64-bit introduces crazy performance deviations with _mm_popcnt_u64 on Intel CPUs | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/replacing-a-32-bit-loop-counter-with-64-bit-introduces-crazy-performance-deviations-with-mm-popcnt-u64-on-intel-cpus/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../using-auto-layout-in-uitableview-for-dynamic-cell-layouts-variable-row-heights/" title="Using Auto Layout in UITableView for dynamic cell layouts &amp; variable row heights" type="text/html">
<link rel="next" href="../how-do-i-style-a-select-dropdown-with-only-css/" title="How do I style a &lt;select&gt; dropdown with only CSS?" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="Replacing a 32-bit loop counter with 64-bit introduces crazy performan">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/replacing-a-32-bit-loop-counter-with-64-bit-introduces-crazy-performance-deviations-with-mm-popcnt-u64-on-intel-cpus/">
<meta property="og:description" content="I was looking for the fastest way to popcount large arrays of data. I
encountered a very weird effect: Changing the loop variable from unsigned
to uint64_t made the performance drop by 50% on my PC.
T">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-17T01:15:02+08:00">
<meta property="article:tag" content="assembly">
<meta property="article:tag" content="c++">
<meta property="article:tag" content="compiler-optimization">
<meta property="article:tag" content="performance">
<meta property="article:tag" content="x86">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Replacing a 32-bit loop counter with 64-bit introduces crazy performance deviations with _mm_popcnt_u64 on Intel CPUs</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T01:15:02+08:00" itemprop="datePublished" title="2023-02-17 01:15">2023-02-17 01:15</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>I was looking for the fastest way to <code>popcount</code> large arrays of data. I
encountered a <em>very weird</em> effect: Changing the loop variable from <code>unsigned</code>
to <code>uint64_t</code> made the performance drop by 50% on my PC.</p>
<h3>The Benchmark</h3>
<div class="code"><pre class="code literal-block"><span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">iostream</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">chrono</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">x86intrin</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="nc">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="nc">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="err">[]</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>

<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">namespace</span><span class="w"> </span><span class="n">std</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">       </span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">"usage: array_size in MB"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="n">uint64_t</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atol</span><span class="p">(</span><span class="n">argv</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">uint64_t</span><span class="o">[</span><span class="n">size/8</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="nc">char</span><span class="o">*</span><span class="w"> </span><span class="n">charbuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="nc">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">unsigned</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="k">size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">        </span><span class="n">charbuffer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rand</span><span class="p">()</span><span class="o">%</span><span class="mi">256</span><span class="p">;</span>

<span class="w">    </span><span class="n">uint64_t</span><span class="w"> </span><span class="nf">count</span><span class="p">,</span><span class="n">duration</span><span class="p">;</span>
<span class="w">    </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">time_point</span><span class="o">&lt;</span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">system_clock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">startP</span><span class="p">,</span><span class="n">endP</span><span class="p">;</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="n">startP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="nl">system_clock</span><span class="p">:</span><span class="err">:</span><span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="nf">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="err">{</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">Tight</span><span class="w"> </span><span class="n">unrolled</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">unsigned</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">unsigned</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="k">size</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="nf">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">_mm_popcnt_u64</span><span class="p">(</span><span class="n">buffer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">                </span><span class="nf">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">_mm_popcnt_u64</span><span class="p">(</span><span class="n">buffer</span><span class="o">[</span><span class="n">i+1</span><span class="o">]</span><span class="p">);</span>
<span class="w">                </span><span class="nf">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">_mm_popcnt_u64</span><span class="p">(</span><span class="n">buffer</span><span class="o">[</span><span class="n">i+2</span><span class="o">]</span><span class="p">);</span>
<span class="w">                </span><span class="nf">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">_mm_popcnt_u64</span><span class="p">(</span><span class="n">buffer</span><span class="o">[</span><span class="n">i+3</span><span class="o">]</span><span class="p">);</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">        </span><span class="n">endP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="nl">system_clock</span><span class="p">:</span><span class="err">:</span><span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="nl">std</span><span class="p">:</span><span class="err">:</span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">nanoseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">endP</span><span class="o">-</span><span class="n">startP</span><span class="p">).</span><span class="nf">count</span><span class="p">();</span>
<span class="w">        </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">"unsigned\t"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nf">count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">'\t'</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">duration</span><span class="o">/</span><span class="mf">1.0E9</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">" sec \t"</span>
<span class="w">             </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="mf">10000.0</span><span class="o">*</span><span class="k">size</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">" GB/s"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="n">startP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="nl">system_clock</span><span class="p">:</span><span class="err">:</span><span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="nf">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="err">{</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">Tight</span><span class="w"> </span><span class="n">unrolled</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">uint64_t</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="k">size</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span><span class="n">i</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="nf">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">_mm_popcnt_u64</span><span class="p">(</span><span class="n">buffer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">                </span><span class="nf">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">_mm_popcnt_u64</span><span class="p">(</span><span class="n">buffer</span><span class="o">[</span><span class="n">i+1</span><span class="o">]</span><span class="p">);</span>
<span class="w">                </span><span class="nf">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">_mm_popcnt_u64</span><span class="p">(</span><span class="n">buffer</span><span class="o">[</span><span class="n">i+2</span><span class="o">]</span><span class="p">);</span>
<span class="w">                </span><span class="nf">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">_mm_popcnt_u64</span><span class="p">(</span><span class="n">buffer</span><span class="o">[</span><span class="n">i+3</span><span class="o">]</span><span class="p">);</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">        </span><span class="n">endP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="nl">system_clock</span><span class="p">:</span><span class="err">:</span><span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="nl">std</span><span class="p">:</span><span class="err">:</span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">nanoseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">endP</span><span class="o">-</span><span class="n">startP</span><span class="p">).</span><span class="nf">count</span><span class="p">();</span>
<span class="w">        </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">"uint64_t\t"</span><span class="w">  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nf">count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">'\t'</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">duration</span><span class="o">/</span><span class="mf">1.0E9</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">" sec \t"</span>
<span class="w">             </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="mf">10000.0</span><span class="o">*</span><span class="k">size</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">" GB/s"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">free</span><span class="p">(</span><span class="n">charbuffer</span><span class="p">);</span>
<span class="err">}</span>
</pre></div>

<p>As you see, we create a buffer of random data, with the size being <code>x</code>
megabytes where <code>x</code> is read from the command line. Afterwards, we iterate over
the buffer and use an unrolled version of the x86 <code>popcount</code> intrinsic to
perform the popcount. To get a more precise result, we do the popcount 10,000
times. We measure the times for the popcount. In the upper case, the inner
loop variable is <code>unsigned</code>, in the lower case, the inner loop variable is
<code>uint64_t</code>. I thought that this should make no difference, but the opposite is
the case.</p>
<h3>The (absolutely crazy) results</h3>
<p>I compile it like this (g++ version: Ubuntu 4.8.2-19ubuntu1):</p>
<div class="code"><pre class="code literal-block">g++ -O3 -march=native -std=c++11 test.cpp -o test
</pre></div>

<p>Here are the results on my Haswell Core i7-4770K CPU @ 3.50 GHz, running <code>test
1</code> (so 1 MB random data):</p>
<ul>
<li>unsigned 41959360000 0.401554 sec <strong>26.113 GB/s</strong>
</li>
<li>uint64_t 41959360000 0.759822 sec <strong>13.8003 GB/s</strong>
</li>
</ul>
<p>As you see, the throughput of the <code>uint64_t</code> version is <strong>only half</strong> the one
of the <code>unsigned</code> version! The problem seems to be that different assembly
gets generated, but why? First, I thought of a compiler bug, so I tried
<code>clang++</code> (Ubuntu Clang version 3.4-1ubuntu3):</p>
<div class="code"><pre class="code literal-block">clang++ -O3 -march=native -std=c++11 teest.cpp -o test
</pre></div>

<p>Result: <code>test 1</code></p>
<ul>
<li>unsigned 41959360000 0.398293 sec <strong>26.3267 GB/s</strong>
</li>
<li>uint64_t 41959360000 0.680954 sec <strong>15.3986 GB/s</strong>
</li>
</ul>
<p>So, it is almost the same result and is still strange. <em>But now it gets super
strange.</em> I replace the buffer size that was read from input with a constant
<code>1</code>, so I change:</p>
<div class="code"><pre class="code literal-block">uint64_t size = atol(argv[1]) &lt;&lt; 20;
</pre></div>

<p>to</p>
<div class="code"><pre class="code literal-block">uint64_t size = 1 &lt;&lt; 20;
</pre></div>

<p>Thus, the compiler now knows the buffer size at compile time. Maybe it can add
some optimizations! Here are the numbers for <code>g++</code>:</p>
<ul>
<li>unsigned 41959360000 0.509156 sec <strong>20.5944 GB/s</strong>
</li>
<li>uint64_t 41959360000 0.508673 sec <strong>20.6139 GB/s</strong>
</li>
</ul>
<p>Now, both versions are equally fast. However, the <code>unsigned</code> <strong>got even
slower</strong>! It dropped from <code>26</code> to <code>20 GB/s</code>, thus replacing a non-constant by
a constant value lead to a <strong>deoptimization</strong>. Seriously, I have no clue what
is going on here! But now to <code>clang++</code> with the new version:</p>
<ul>
<li>unsigned 41959360000 0.677009 sec <strong>15.4884 GB/s</strong>
</li>
<li>uint64_t 41959360000 0.676909 sec <strong>15.4906 GB/s</strong>
</li>
</ul>
<p><em>Wait, what?</em> Now, both versions dropped to the <strong>slow</strong> number of 15 GB/s.
Thus, replacing a non-constant by a constant value even lead to slow code in
<strong>both</strong> cases for Clang!</p>
<p>I asked a colleague with an Ivy Bridge CPU to compile my benchmark. He got
similar results, so it does not seem to be Haswell. Because two compilers
produce strange results here, it also does not seem to be a compiler bug. We
do not have an AMD CPU here, so we could only test with Intel.</p>
<h3>More madness, please!</h3>
<p>Take the first example (the one with <code>atol(argv[1])</code>) and put a <code>static</code>
before the variable, i.e.:</p>
<div class="code"><pre class="code literal-block">static uint64_t size=atol(argv[1])&lt;&lt;20;
</pre></div>

<p>Here are my results in g++:</p>
<ul>
<li>unsigned 41959360000 0.396728 sec <strong>26.4306 GB/s</strong>
</li>
<li>uint64_t 41959360000 0.509484 sec <strong>20.5811 GB/s</strong>
</li>
</ul>
<p><em>Yay, yet another alternative</em>. We still have the fast 26 GB/s with <code>u32</code>, but
we managed to get <code>u64</code> at least from the 13 GB/s to the 20 GB/s version! <strong>On
my collegue's PC, the<code>u64</code> version became even faster than the <code>u32</code> version,
yielding the fastest result of all.</strong> Sadly, this only works for <code>g++</code>,
<code>clang++</code> does not seem to care about <code>static</code>.</p>
<h3>My question</h3>
<p>Can you explain these results? Especially:</p>
<ul>
<li>How can there be such a difference between <code>u32</code> and <code>u64</code>?</li>
<li>How can replacing a non-constant by a constant buffer size trigger <em>less optimal code</em>?</li>
<li>How can the insertion of the <code>static</code> keyword make the <code>u64</code> loop faster? Even faster than the original code on my collegue's computer!</li>
</ul>
<p>I know that optimization is a tricky territory, however, I never thought that
such small changes can lead to a <strong>100% difference</strong> in execution time and
that small factors like a constant buffer size can again mix results totally.
Of course, I always want to have the version that is able to popcount 26 GB/s.
The only reliable way I can think of is copy paste the assembly for this case
and use inline assembly. This is the only way I can get rid of compilers that
seem to go mad on small changes. What do you think? Is there another way to
reliably get the code with most performance?</p>
<h3>The Disassembly</h3>
<p>Here is the disassembly for the various results:</p>
<p>26 GB/s version from <strong>g++ / u32 / non-const bufsize</strong> :</p>
<div class="code"><pre class="code literal-block"><span class="mh">0x400af8</span><span class="o">:</span>
<span class="n">lea</span><span class="w"> </span><span class="mh">0x1</span><span class="o">(%</span><span class="n">rdx</span><span class="o">),%</span><span class="n">eax</span>
<span class="n">popcnt</span><span class="w"> </span><span class="o">(%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rax</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">r9</span>
<span class="n">lea</span><span class="w"> </span><span class="mh">0x2</span><span class="o">(%</span><span class="n">rdx</span><span class="o">),%</span><span class="n">edi</span>
<span class="n">popcnt</span><span class="w"> </span><span class="o">(%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rcx</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rax</span>
<span class="n">lea</span><span class="w"> </span><span class="mh">0x3</span><span class="o">(%</span><span class="n">rdx</span><span class="o">),%</span><span class="n">esi</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">r9</span><span class="o">,%</span><span class="n">rax</span>
<span class="n">popcnt</span><span class="w"> </span><span class="o">(%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rdi</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rcx</span>
<span class="n">add</span><span class="w"> </span><span class="n">$0x4</span><span class="o">,%</span><span class="n">edx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span><span class="o">,%</span><span class="n">rax</span>
<span class="n">popcnt</span><span class="w"> </span><span class="o">(%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rsi</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rcx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span><span class="o">,%</span><span class="n">rax</span>
<span class="n">mov</span><span class="w"> </span><span class="o">%</span><span class="n">edx</span><span class="o">,%</span><span class="n">ecx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="o">,%</span><span class="n">r14</span>
<span class="n">cmp</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="o">,%</span><span class="n">rcx</span>
<span class="n">jb</span><span class="w"> </span><span class="mh">0x400af8</span>
</pre></div>

<p>13 GB/s version from <strong>g++ / u64 / non-const bufsize</strong> :</p>
<div class="code"><pre class="code literal-block"><span class="mh">0x400c00</span><span class="o">:</span>
<span class="n">popcnt</span><span class="w"> </span><span class="mh">0x8</span><span class="o">(%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rdx</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rcx</span>
<span class="n">popcnt</span><span class="w"> </span><span class="o">(%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rdx</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rax</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span><span class="o">,%</span><span class="n">rax</span>
<span class="n">popcnt</span><span class="w"> </span><span class="mh">0x10</span><span class="o">(%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rdx</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rcx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span><span class="o">,%</span><span class="n">rax</span>
<span class="n">popcnt</span><span class="w"> </span><span class="mh">0x18</span><span class="o">(%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rdx</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rcx</span>
<span class="n">add</span><span class="w"> </span><span class="n">$0x4</span><span class="o">,%</span><span class="n">rdx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span><span class="o">,%</span><span class="n">rax</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="o">,%</span><span class="n">r12</span>
<span class="n">cmp</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="o">,%</span><span class="n">rdx</span>
<span class="n">jb</span><span class="w"> </span><span class="mh">0x400c00</span>
</pre></div>

<p>15 GB/s version from <strong>clang++ / u64 / non-const bufsize</strong> :</p>
<div class="code"><pre class="code literal-block"><span class="mh">0x400e50</span><span class="o">:</span>
<span class="n">popcnt</span><span class="w"> </span><span class="o">(%</span><span class="n">r15</span><span class="o">,%</span><span class="n">rcx</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rdx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rdx</span>
<span class="n">popcnt</span><span class="w"> </span><span class="mh">0x8</span><span class="o">(%</span><span class="n">r15</span><span class="o">,%</span><span class="n">rcx</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rsi</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rdx</span><span class="o">,%</span><span class="n">rsi</span>
<span class="n">popcnt</span><span class="w"> </span><span class="mh">0x10</span><span class="o">(%</span><span class="n">r15</span><span class="o">,%</span><span class="n">rcx</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rdx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span><span class="o">,%</span><span class="n">rdx</span>
<span class="n">popcnt</span><span class="w"> </span><span class="mh">0x18</span><span class="o">(%</span><span class="n">r15</span><span class="o">,%</span><span class="n">rcx</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rbx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rdx</span><span class="o">,%</span><span class="n">rbx</span>
<span class="n">add</span><span class="w"> </span><span class="n">$0x4</span><span class="o">,%</span><span class="n">rcx</span>
<span class="n">cmp</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span><span class="o">,%</span><span class="n">rcx</span>
<span class="n">jb</span><span class="w"> </span><span class="mh">0x400e50</span>
</pre></div>

<p>20 GB/s version from <strong>g++ / u32 &amp;u64 / const bufsize</strong>:</p>
<div class="code"><pre class="code literal-block"><span class="mh">0x400a68</span><span class="o">:</span>
<span class="n">popcnt</span><span class="w"> </span><span class="o">(%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rdx</span><span class="o">,</span><span class="mi">1</span><span class="o">),%</span><span class="n">rax</span>
<span class="n">popcnt</span><span class="w"> </span><span class="mh">0x8</span><span class="o">(%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rdx</span><span class="o">,</span><span class="mi">1</span><span class="o">),%</span><span class="n">rcx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="o">,%</span><span class="n">rcx</span>
<span class="n">popcnt</span><span class="w"> </span><span class="mh">0x10</span><span class="o">(%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rdx</span><span class="o">,</span><span class="mi">1</span><span class="o">),%</span><span class="n">rax</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rax</span><span class="o">,%</span><span class="n">rcx</span>
<span class="n">popcnt</span><span class="w"> </span><span class="mh">0x18</span><span class="o">(%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rdx</span><span class="o">,</span><span class="mi">1</span><span class="o">),%</span><span class="n">rsi</span>
<span class="n">add</span><span class="w"> </span><span class="n">$0x20</span><span class="o">,%</span><span class="n">rdx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span><span class="o">,%</span><span class="n">rcx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span><span class="o">,%</span><span class="n">rbp</span>
<span class="n">cmp</span><span class="w"> </span><span class="n">$0x100000</span><span class="o">,%</span><span class="n">rdx</span>
<span class="n">jne</span><span class="w"> </span><span class="mh">0x400a68</span>
</pre></div>

<p>15 GB/s version from <strong>clang++ / u32 &amp;u64 / const bufsize</strong>:</p>
<div class="code"><pre class="code literal-block"><span class="mh">0x400dd0</span><span class="o">:</span>
<span class="n">popcnt</span><span class="w"> </span><span class="o">(%</span><span class="n">r14</span><span class="o">,%</span><span class="n">rcx</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rdx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rbx</span><span class="o">,%</span><span class="n">rdx</span>
<span class="n">popcnt</span><span class="w"> </span><span class="mh">0x8</span><span class="o">(%</span><span class="n">r14</span><span class="o">,%</span><span class="n">rcx</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rsi</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rdx</span><span class="o">,%</span><span class="n">rsi</span>
<span class="n">popcnt</span><span class="w"> </span><span class="mh">0x10</span><span class="o">(%</span><span class="n">r14</span><span class="o">,%</span><span class="n">rcx</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rdx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span><span class="o">,%</span><span class="n">rdx</span>
<span class="n">popcnt</span><span class="w"> </span><span class="mh">0x18</span><span class="o">(%</span><span class="n">r14</span><span class="o">,%</span><span class="n">rcx</span><span class="o">,</span><span class="mi">8</span><span class="o">),%</span><span class="n">rbx</span>
<span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="n">rdx</span><span class="o">,%</span><span class="n">rbx</span>
<span class="n">add</span><span class="w"> </span><span class="n">$0x4</span><span class="o">,%</span><span class="n">rcx</span>
<span class="n">cmp</span><span class="w"> </span><span class="n">$0x20000</span><span class="o">,%</span><span class="n">rcx</span>
<span class="n">jb</span><span class="w"> </span><span class="mh">0x400dd0</span>
</pre></div>

<p>Interestingly, the fastest (26 GB/s) version is also the longest! It seems to
be the only solution that uses <code>lea</code>. Some versions use <code>jb</code> to jump, others
use <code>jne</code>. But apart from that, all versions seem to be comparable. I don't
see where a 100% performance gap could originate from, but I am not too adept
at deciphering assembly. The slowest (13 GB/s) version looks even very short
and good. Can anyone explain this?</p>
<h3>Lessons learned</h3>
<p>No matter what the answer to this question will be; I have learned that in
really hot loops <em>every</em> detail can matter, <em>even details that do not seem to
have any association to the hot code</em>. I have never thought about what type to
use for a loop variable, but as you see such a minor change can make a <em>100%</em>
difference! Even the storage type of a buffer can make a huge difference, as
we saw with the insertion of the <code>static</code> keyword in front of the size
variable! In the future, I will always test various alternatives on various
compilers when writing really tight and hot loops that are crucial for system
performance.</p>
<p>The interesting thing is also that the performance difference is still so high
although I have already unrolled the loop four times. So even if you unroll,
you can still get hit by major performance deviations. Quite interesting.</p>
<p><br><br></p>
<h2>Answer</h2>
<p><strong>Culprit: False Data Dependency</strong> (and the compiler isn't even aware of it)</p>
<p>On Sandy/Ivy Bridge and Haswell processors, the instruction:</p>
<div class="code"><pre class="code literal-block">popcnt  src, dest
</pre></div>

<p>appears to have a false dependency on the destination register <code>dest</code>. Even
though the instruction only writes to it, the instruction will wait until
<code>dest</code> is ready before executing. This false dependency is (now) documented by
Intel as erratum HSD146 (Haswell) and SKL029 (Skylake)</p>
<p>Skylake fixed this for <code>lzcnt</code> and <code>tzcnt</code>.<br>
Cannon Lake (and Ice Lake) fixed this for <code>popcnt</code>.<br><code>bsf</code>/<code>bsr</code> have a true output dependency: output unmodified for input=0. (But
no way to take advantage of that with intrinsics - only AMD documents it and
compilers don't expose it.)</p>
<p>(Yes, these instructions all run on the same execution unit).</p>
<hr>
<p>This dependency doesn't just hold up the 4 <code>popcnt</code>s from a single loop
iteration. It can carry across loop iterations making it impossible for the
processor to parallelize different loop iterations.</p>
<p>The <code>unsigned</code> vs. <code>uint64_t</code> and other tweaks don't directly affect the
problem. But they influence the register allocator which assigns the registers
to the variables.</p>
<p>In your case, the speeds are a direct result of what is stuck to the (false)
dependency chain depending on what the register allocator decided to do.</p>
<ul>
<li>13 GB/s has a chain: <code>popcnt</code>-<code>add</code>-<code>popcnt</code>-<code>popcnt</code> → next iteration</li>
<li>15 GB/s has a chain: <code>popcnt</code>-<code>add</code>-<code>popcnt</code>-<code>add</code> → next iteration</li>
<li>20 GB/s has a chain: <code>popcnt</code>-<code>popcnt</code> → next iteration</li>
<li>26 GB/s has a chain: <code>popcnt</code>-<code>popcnt</code> → next iteration</li>
</ul>
<p>The difference between 20 GB/s and 26 GB/s seems to be a minor artifact of the
indirect addressing. Either way, the processor starts to hit other bottlenecks
once you reach this speed.</p>
<hr>
<p>To test this, I used inline assembly to bypass the compiler and get exactly
the assembly I want. I also split up the <code>count</code> variable to break all other
dependencies that might mess with the benchmarks.</p>
<p>Here are the results:</p>
<p><strong>Sandy Bridge Xeon @ 3.5 GHz:</strong> (full test code can be found at the bottom)</p>
<ul>
<li>GCC 4.6.3: <code>g++ popcnt.cpp -std=c++0x -O3 -save-temps -march=native</code>
</li>
<li>Ubuntu 12</li>
</ul>
<p>Different Registers: <strong>18.6195 GB/s</strong></p>
<div class="code"><pre class="code literal-block"><span class="nl">.L4:</span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="p">(</span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rax</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="nv">%r8</span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="mi">8</span><span class="p">(</span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rax</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="nv">%r9</span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="mi">16</span><span class="p">(</span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rax</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="nv">%r10</span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="mi">24</span><span class="p">(</span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rax</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="nv">%r11</span>
<span class="w">    </span><span class="nf">addq</span><span class="w">    </span><span class="no">$4</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>

<span class="w">    </span><span class="nf">popcnt</span><span class="w"> </span><span class="nv">%r8</span><span class="p">,</span><span class="w"> </span><span class="nv">%r8</span>
<span class="w">    </span><span class="nf">add</span><span class="w">    </span><span class="nv">%r8</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdx</span>
<span class="w">    </span><span class="nf">popcnt</span><span class="w"> </span><span class="nv">%r9</span><span class="p">,</span><span class="w"> </span><span class="nv">%r9</span>
<span class="w">    </span><span class="nf">add</span><span class="w">    </span><span class="nv">%r9</span><span class="p">,</span><span class="w"> </span><span class="nv">%rcx</span>
<span class="w">    </span><span class="nf">popcnt</span><span class="w"> </span><span class="nv">%r10</span><span class="p">,</span><span class="w"> </span><span class="nv">%r10</span>
<span class="w">    </span><span class="nf">add</span><span class="w">    </span><span class="nv">%r10</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdi</span>
<span class="w">    </span><span class="nf">popcnt</span><span class="w"> </span><span class="nv">%r11</span><span class="p">,</span><span class="w"> </span><span class="nv">%r11</span>
<span class="w">    </span><span class="nf">add</span><span class="w">    </span><span class="nv">%r11</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsi</span>

<span class="w">    </span><span class="nf">cmpq</span><span class="w">    </span><span class="no">$131072</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>
<span class="w">    </span><span class="nf">jne</span><span class="w"> </span><span class="no">.L4</span>
</pre></div>

<p>Same Register: <strong>8.49272 GB/s</strong></p>
<div class="code"><pre class="code literal-block"><span class="nl">.L9:</span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="p">(</span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rdx</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="nv">%r9</span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="mi">8</span><span class="p">(</span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rdx</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="nv">%r10</span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="mi">16</span><span class="p">(</span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rdx</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="nv">%r11</span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="mi">24</span><span class="p">(</span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rdx</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="nv">%rbp</span>
<span class="w">    </span><span class="nf">addq</span><span class="w">    </span><span class="no">$4</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdx</span>

<span class="w">    </span><span class="c1"># This time reuse "rax" for all the popcnts.</span>
<span class="w">    </span><span class="nf">popcnt</span><span class="w"> </span><span class="nv">%r9</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>
<span class="w">    </span><span class="nf">add</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="w"> </span><span class="nv">%rcx</span>
<span class="w">    </span><span class="nf">popcnt</span><span class="w"> </span><span class="nv">%r10</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>
<span class="w">    </span><span class="nf">add</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsi</span>
<span class="w">    </span><span class="nf">popcnt</span><span class="w"> </span><span class="nv">%r11</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>
<span class="w">    </span><span class="nf">add</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="w"> </span><span class="nv">%r8</span>
<span class="w">    </span><span class="nf">popcnt</span><span class="w"> </span><span class="nv">%rbp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>
<span class="w">    </span><span class="nf">add</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdi</span>

<span class="w">    </span><span class="nf">cmpq</span><span class="w">    </span><span class="no">$131072</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdx</span>
<span class="w">    </span><span class="nf">jne</span><span class="w"> </span><span class="no">.L9</span>
</pre></div>

<p>Same Register with broken chain: <strong>17.8869 GB/s</strong></p>
<div class="code"><pre class="code literal-block"><span class="nl">.L14:</span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="p">(</span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rdx</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="nv">%r9</span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="mi">8</span><span class="p">(</span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rdx</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="nv">%r10</span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="mi">16</span><span class="p">(</span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rdx</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="nv">%r11</span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="mi">24</span><span class="p">(</span><span class="nv">%rbx</span><span class="p">,</span><span class="nv">%rdx</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="nv">%rbp</span>
<span class="w">    </span><span class="nf">addq</span><span class="w">    </span><span class="no">$4</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdx</span>

<span class="w">    </span><span class="c1"># Reuse "rax" for all the popcnts.</span>
<span class="w">    </span><span class="nf">xor</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span><span class="w">    </span><span class="c1"># Break the cross-iteration dependency by zeroing "rax".</span>
<span class="w">    </span><span class="nf">popcnt</span><span class="w"> </span><span class="nv">%r9</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>
<span class="w">    </span><span class="nf">add</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="w"> </span><span class="nv">%rcx</span>
<span class="w">    </span><span class="nf">popcnt</span><span class="w"> </span><span class="nv">%r10</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>
<span class="w">    </span><span class="nf">add</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsi</span>
<span class="w">    </span><span class="nf">popcnt</span><span class="w"> </span><span class="nv">%r11</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>
<span class="w">    </span><span class="nf">add</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="w"> </span><span class="nv">%r8</span>
<span class="w">    </span><span class="nf">popcnt</span><span class="w"> </span><span class="nv">%rbp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span>
<span class="w">    </span><span class="nf">add</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdi</span>

<span class="w">    </span><span class="nf">cmpq</span><span class="w">    </span><span class="no">$131072</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdx</span>
<span class="w">    </span><span class="nf">jne</span><span class="w"> </span><span class="no">.L14</span>
</pre></div>

<hr>
<p><strong>So what went wrong with the compiler?</strong></p>
<p>It seems that neither GCC nor Visual Studio are aware that <code>popcnt</code> has such a
false dependency. Nevertheless, these false dependencies aren't uncommon. It's
just a matter of whether the compiler is aware of it.</p>
<p><code>popcnt</code> isn't exactly the most used instruction. So it's not really a
surprise that a major compiler could miss something like this. There also
appears to be no documentation anywhere that mentions this problem. If Intel
doesn't disclose it, then nobody outside will know until someone runs into it
by chance.</p>
<p>( <strong>Update:</strong> As of version 4.9.2, GCC is aware of this false-dependency and
generates code to compensate it when optimizations are enabled. Major
compilers from other vendors, including Clang, MSVC, and even Intel's own ICC
are not yet aware of this microarchitectural erratum and will not emit code
that compensates for it.)</p>
<p><strong>Why does the CPU have such a false dependency?</strong></p>
<p>We can speculate: it runs on the same execution unit as <code>bsf</code> / <code>bsr</code> which
<em>do</em> have an output dependency. (How is POPCNT implemented in hardware?). For
those instructions, Intel documents the integer result for input=0 as
"undefined" (with ZF=1), but Intel hardware actually gives a stronger
guarantee to avoid breaking old software: output unmodified. AMD documents
this behaviour.</p>
<p>Presumably it was somehow inconvenient to make some uops for this execution
unit dependent on the output but others not.</p>
<p>AMD processors do not appear to have this false dependency.</p>
<hr>
<p>The full test code is below for reference:</p>
<div class="code"><pre class="code literal-block"><span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">iostream</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">chrono</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">x86intrin</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="nc">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="nc">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="err">[]</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>

<span class="w">   </span><span class="k">using</span><span class="w"> </span><span class="n">namespace</span><span class="w"> </span><span class="n">std</span><span class="p">;</span>
<span class="w">   </span><span class="n">uint64_t</span><span class="w"> </span><span class="k">size</span><span class="o">=</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">;</span>

<span class="w">   </span><span class="n">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">uint64_t</span><span class="o">[</span><span class="n">size/8</span><span class="o">]</span><span class="p">;</span>
<span class="w">   </span><span class="nc">char</span><span class="o">*</span><span class="w"> </span><span class="n">charbuffer</span><span class="o">=</span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="nc">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">unsigned</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="k">size</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="n">charbuffer</span><span class="o">[</span><span class="n">i</span><span class="o">]=</span><span class="nf">rand</span><span class="p">()</span><span class="o">%</span><span class="mi">256</span><span class="p">;</span>

<span class="w">   </span><span class="n">uint64_t</span><span class="w"> </span><span class="nf">count</span><span class="p">,</span><span class="n">duration</span><span class="p">;</span>
<span class="w">   </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">time_point</span><span class="o">&lt;</span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">system_clock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">startP</span><span class="p">,</span><span class="n">endP</span><span class="p">;</span>
<span class="w">   </span><span class="err">{</span>
<span class="w">      </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">startP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="nl">system_clock</span><span class="p">:</span><span class="err">:</span><span class="n">now</span><span class="p">();</span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="err">{</span>
<span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="k">size</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span><span class="n">i</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">i + 0</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">i + 1</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">i + 2</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">i + 3</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="n">__asm__</span><span class="p">(</span>
<span class="w">                </span><span class="ss">"popcnt %4, %4  \n\t"</span>
<span class="w">                </span><span class="ss">"add %4, %0     \n\t"</span>
<span class="w">                </span><span class="ss">"popcnt %5, %5  \n\t"</span>
<span class="w">                </span><span class="ss">"add %5, %1     \n\t"</span>
<span class="w">                </span><span class="ss">"popcnt %6, %6  \n\t"</span>
<span class="w">                </span><span class="ss">"add %6, %2     \n\t"</span>
<span class="w">                </span><span class="ss">"popcnt %7, %7  \n\t"</span>
<span class="w">                </span><span class="ss">"add %7, %3     \n\t"</span>
<span class="w">                </span><span class="err">:</span><span class="w"> </span><span class="ss">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">c0</span><span class="p">),</span><span class="w"> </span><span class="ss">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">c1</span><span class="p">),</span><span class="w"> </span><span class="ss">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">c2</span><span class="p">),</span><span class="w"> </span><span class="ss">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">c3</span><span class="p">)</span>
<span class="w">                </span><span class="err">:</span><span class="w"> </span><span class="ss">"r"</span><span class="w">  </span><span class="p">(</span><span class="n">r0</span><span class="p">),</span><span class="w"> </span><span class="ss">"r"</span><span class="w">  </span><span class="p">(</span><span class="n">r1</span><span class="p">),</span><span class="w"> </span><span class="ss">"r"</span><span class="w">  </span><span class="p">(</span><span class="n">r2</span><span class="p">),</span><span class="w"> </span><span class="ss">"r"</span><span class="w">  </span><span class="p">(</span><span class="n">r3</span><span class="p">)</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">         </span><span class="err">}</span>
<span class="w">      </span><span class="err">}</span>
<span class="w">      </span><span class="nf">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c3</span><span class="p">;</span>
<span class="w">      </span><span class="n">endP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="nl">system_clock</span><span class="p">:</span><span class="err">:</span><span class="n">now</span><span class="p">();</span>
<span class="w">      </span><span class="n">duration</span><span class="o">=</span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="nl">std</span><span class="p">:</span><span class="err">:</span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">nanoseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">endP</span><span class="o">-</span><span class="n">startP</span><span class="p">).</span><span class="nf">count</span><span class="p">();</span>
<span class="w">      </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">"No Chain\t"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nf">count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">'\t'</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">duration</span><span class="o">/</span><span class="mf">1.0E9</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">" sec \t"</span>
<span class="w">            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="mf">10000.0</span><span class="o">*</span><span class="k">size</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">" GB/s"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w">   </span><span class="err">}</span>
<span class="w">   </span><span class="err">{</span>
<span class="w">      </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">startP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="nl">system_clock</span><span class="p">:</span><span class="err">:</span><span class="n">now</span><span class="p">();</span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="err">{</span>
<span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="k">size</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span><span class="n">i</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">i + 0</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">i + 1</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">i + 2</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">i + 3</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="n">__asm__</span><span class="p">(</span>
<span class="w">                </span><span class="ss">"popcnt %4, %%rax   \n\t"</span>
<span class="w">                </span><span class="ss">"add %%rax, %0      \n\t"</span>
<span class="w">                </span><span class="ss">"popcnt %5, %%rax   \n\t"</span>
<span class="w">                </span><span class="ss">"add %%rax, %1      \n\t"</span>
<span class="w">                </span><span class="ss">"popcnt %6, %%rax   \n\t"</span>
<span class="w">                </span><span class="ss">"add %%rax, %2      \n\t"</span>
<span class="w">                </span><span class="ss">"popcnt %7, %%rax   \n\t"</span>
<span class="w">                </span><span class="ss">"add %%rax, %3      \n\t"</span>
<span class="w">                </span><span class="err">:</span><span class="w"> </span><span class="ss">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">c0</span><span class="p">),</span><span class="w"> </span><span class="ss">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">c1</span><span class="p">),</span><span class="w"> </span><span class="ss">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">c2</span><span class="p">),</span><span class="w"> </span><span class="ss">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">c3</span><span class="p">)</span>
<span class="w">                </span><span class="err">:</span><span class="w"> </span><span class="ss">"r"</span><span class="w">  </span><span class="p">(</span><span class="n">r0</span><span class="p">),</span><span class="w"> </span><span class="ss">"r"</span><span class="w">  </span><span class="p">(</span><span class="n">r1</span><span class="p">),</span><span class="w"> </span><span class="ss">"r"</span><span class="w">  </span><span class="p">(</span><span class="n">r2</span><span class="p">),</span><span class="w"> </span><span class="ss">"r"</span><span class="w">  </span><span class="p">(</span><span class="n">r3</span><span class="p">)</span>
<span class="w">                </span><span class="err">:</span><span class="w"> </span><span class="ss">"rax"</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">         </span><span class="err">}</span>
<span class="w">      </span><span class="err">}</span>
<span class="w">      </span><span class="nf">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c3</span><span class="p">;</span>
<span class="w">      </span><span class="n">endP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="nl">system_clock</span><span class="p">:</span><span class="err">:</span><span class="n">now</span><span class="p">();</span>
<span class="w">      </span><span class="n">duration</span><span class="o">=</span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="nl">std</span><span class="p">:</span><span class="err">:</span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">nanoseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">endP</span><span class="o">-</span><span class="n">startP</span><span class="p">).</span><span class="nf">count</span><span class="p">();</span>
<span class="w">      </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">"Chain 4   \t"</span><span class="w">  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nf">count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">'\t'</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">duration</span><span class="o">/</span><span class="mf">1.0E9</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">" sec \t"</span>
<span class="w">            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="mf">10000.0</span><span class="o">*</span><span class="k">size</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">" GB/s"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w">   </span><span class="err">}</span>
<span class="w">   </span><span class="err">{</span>
<span class="w">      </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">startP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="nl">system_clock</span><span class="p">:</span><span class="err">:</span><span class="n">now</span><span class="p">();</span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="err">{</span>
<span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="k">size</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span><span class="n">i</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">r0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">i + 0</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">i + 1</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">i + 2</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">r3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">i + 3</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="n">__asm__</span><span class="p">(</span>
<span class="w">                </span><span class="ss">"xor %%rax, %%rax   \n\t"</span><span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="o">&lt;---</span><span class="w"> </span><span class="k">Break</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span>
<span class="w">                </span><span class="ss">"popcnt %4, %%rax   \n\t"</span>
<span class="w">                </span><span class="ss">"add %%rax, %0      \n\t"</span>
<span class="w">                </span><span class="ss">"popcnt %5, %%rax   \n\t"</span>
<span class="w">                </span><span class="ss">"add %%rax, %1      \n\t"</span>
<span class="w">                </span><span class="ss">"popcnt %6, %%rax   \n\t"</span>
<span class="w">                </span><span class="ss">"add %%rax, %2      \n\t"</span>
<span class="w">                </span><span class="ss">"popcnt %7, %%rax   \n\t"</span>
<span class="w">                </span><span class="ss">"add %%rax, %3      \n\t"</span>
<span class="w">                </span><span class="err">:</span><span class="w"> </span><span class="ss">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">c0</span><span class="p">),</span><span class="w"> </span><span class="ss">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">c1</span><span class="p">),</span><span class="w"> </span><span class="ss">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">c2</span><span class="p">),</span><span class="w"> </span><span class="ss">"+r"</span><span class="w"> </span><span class="p">(</span><span class="n">c3</span><span class="p">)</span>
<span class="w">                </span><span class="err">:</span><span class="w"> </span><span class="ss">"r"</span><span class="w">  </span><span class="p">(</span><span class="n">r0</span><span class="p">),</span><span class="w"> </span><span class="ss">"r"</span><span class="w">  </span><span class="p">(</span><span class="n">r1</span><span class="p">),</span><span class="w"> </span><span class="ss">"r"</span><span class="w">  </span><span class="p">(</span><span class="n">r2</span><span class="p">),</span><span class="w"> </span><span class="ss">"r"</span><span class="w">  </span><span class="p">(</span><span class="n">r3</span><span class="p">)</span>
<span class="w">                </span><span class="err">:</span><span class="w"> </span><span class="ss">"rax"</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">         </span><span class="err">}</span>
<span class="w">      </span><span class="err">}</span>
<span class="w">      </span><span class="nf">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c3</span><span class="p">;</span>
<span class="w">      </span><span class="n">endP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="nl">system_clock</span><span class="p">:</span><span class="err">:</span><span class="n">now</span><span class="p">();</span>
<span class="w">      </span><span class="n">duration</span><span class="o">=</span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="nl">std</span><span class="p">:</span><span class="err">:</span><span class="nl">chrono</span><span class="p">:</span><span class="err">:</span><span class="n">nanoseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">endP</span><span class="o">-</span><span class="n">startP</span><span class="p">).</span><span class="nf">count</span><span class="p">();</span>
<span class="w">      </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">"Broken Chain\t"</span><span class="w">  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nf">count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">'\t'</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">duration</span><span class="o">/</span><span class="mf">1.0E9</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">" sec \t"</span>
<span class="w">            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="mf">10000.0</span><span class="o">*</span><span class="k">size</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="ss">" GB/s"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w">   </span><span class="err">}</span>

<span class="w">   </span><span class="k">free</span><span class="p">(</span><span class="n">charbuffer</span><span class="p">);</span>
<span class="err">}</span>
</pre></div>

<hr>
<p>An equally interesting benchmark can be found here:
http://pastebin.com/kbzgL8si<br>
This benchmark varies the number of <code>popcnt</code>s that are in the (false)
dependency chain.</p>
<div class="code"><pre class="code literal-block">False Chain 0:  41959360000 0.57748 sec     18.1578 GB/s
False Chain 1:  41959360000 0.585398 sec    17.9122 GB/s
False Chain 2:  41959360000 0.645483 sec    16.2448 GB/s
False Chain 3:  41959360000 0.929718 sec    11.2784 GB/s
False Chain 4:  41959360000 1.23572 sec     8.48557 GB/s
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>I coded up an equivalent C program to experiment, and I can confirm this
strange behaviour. What's more, <code>gcc</code> believes the 64-bit integer (which
should probably be a <code>size_t</code> anyway...) to be better, as using
<code>uint_fast32_t</code> causes gcc to use a 64-bit uint.  </p>
<p>I did a bit of mucking around with the assembly:<br>
Simply take the 32-bit version, replace all 32-bit instructions/registers with
the 64-bit version in the inner popcount-loop of the program. Observation: the
code is <strong>just as fast as the 32-bit version!</strong>  </p>
<p>This is obviously a hack, as the size of the variable isn't really 64 bit, as
other parts of the program still use the 32-bit version, but as long as the
inner popcount-loop dominates performance, this is a good start.  </p>
<p>I then copied the inner loop code from the 32-bit version of the program,
hacked it up to be 64 bit, fiddled with the registers to make it a replacement
for the inner loop of the 64-bit version. <strong>This code also runs as fast as the
32-bit version.</strong>  </p>
<p>My conclusion is that this is bad instruction scheduling by the compiler, not
actual speed/latency advantage of 32-bit instructions.  </p>
<p>(Caveat: I hacked up assembly, could have broken something without noticing. I
don't think so.)</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/assembly/" rel="tag">assembly</a></li>
            <li><a class="tag p-category" href="../../categories/c%2B%2B/" rel="tag">c++</a></li>
            <li><a class="tag p-category" href="../../categories/compiler-optimization/" rel="tag">compiler-optimization</a></li>
            <li><a class="tag p-category" href="../../categories/performance/" rel="tag">performance</a></li>
            <li><a class="tag p-category" href="../../categories/x86/" rel="tag">x86</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../using-auto-layout-in-uitableview-for-dynamic-cell-layouts-variable-row-heights/" rel="prev" title="Using Auto Layout in UITableView for dynamic cell layouts &amp; variable row heights">Previous post</a>
            </li>
            <li class="next">
                <a href="../how-do-i-style-a-select-dropdown-with-only-css/" rel="next" title="How do I style a &lt;select&gt; dropdown with only CSS?">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
