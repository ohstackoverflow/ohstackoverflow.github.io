<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>如何仅克隆 Git 存储库的子目录？ | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/ru-he-jin-ke-long-git-cun-chu-ku-de-zi-mu-lu/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../ru-he-sui-ji-hua-xi-pai-javascript-shu-zu/" title="如何随机化（洗牌）JavaScript 数组？" type="text/html">
<link rel="next" href="../ru-he-cong-ling-yi-ge-fen-zhi-huo-qu-yi-ge-wen-jian/" title="如何从另一个分支获取一个文件？" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="如何仅克隆 Git 存储库的子目录？">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/ru-he-jin-ke-long-git-cun-chu-ku-de-zi-mu-lu/">
<meta property="og:description" content="我有我的 Git 存储库，它在根目录下有两个子目录：
/finisht
/static


当它在SVN中时，/finisht在一个地方检出，而/static在其他地方检出，就像这样：
svn co svn+ssh://admin@domain.example/home/admin/repos/finisht/static static


有没有办法用 Git 做到这一点？

解答
EDIT :">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-16T23:39:27+08:00">
<meta property="article:tag" content="git">
<meta property="article:tag" content="git-clone">
<meta property="article:tag" content="repository">
<meta property="article:tag" content="sparse-checkout">
<meta property="article:tag" content="subdirectory">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">如何仅克隆 Git 存储库的子目录？</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T23:39:27+08:00" itemprop="datePublished" title="2023-02-16 23:39">2023-02-16 23:39</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>我有我的 Git 存储库，它在根目录下有两个子目录：</p>
<div class="code"><pre class="code literal-block">/finisht
/static
</pre></div>

<p>当它在SVN中时，<code>/finisht</code>在一个地方检出，而<code>/static</code>在其他地方检出，就像这样：</p>
<div class="code"><pre class="code literal-block"><span class="n">svn</span><span class="w"> </span><span class="n">co</span><span class="w"> </span><span class="n">svn</span><span class="o">+</span><span class="nl">ssh</span><span class="p">:</span><span class="o">//</span><span class="k">admin</span><span class="nv">@domain</span><span class="p">.</span><span class="n">example</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="k">admin</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">finisht</span><span class="o">/</span><span class="k">static</span><span class="w"> </span><span class="k">static</span>
</pre></div>

<p>有没有办法用 Git 做到这一点？</p>
<p><br><br></p>
<h2>解答</h2>
<p><strong>EDIT</strong> : As of Git 2.19, this is finally possible, as can be seen in this
answer.</p>
<p>Consider upvoting that answer.</p>
<p>Note: in Git 2.19, only client-side support is implemented, server-side
support is still missing, so it only works when cloning local repositories.
Also note that large Git hosters, e.g. GitHub, don't actually use the Git
server, they use their own implementation, so even if support shows up in the
Git server, it does not automatically mean that it works on Git hosters.
(OTOH, since they don't use the Git server, they could implement it faster in
their own implementations before it shows up in Git server.)</p>
<hr>
<p>No, that's not possible in Git.</p>
<p>Implementing something like this in Git would be a substantial effort and it
would mean that the integrity of the clientside repository could no longer be
guaranteed. If you are interested, search for discussions on "sparse clone"
and "sparse fetch" on the git mailinglist.</p>
<p>In general, the consensus in the Git community is that if you have several
directories that are always checked out independently, then these are really
two different projects and should live in two different repositories. You can
glue them back together using Git Submodules.</p>
<p><br></p>
<h3>更多建议</h3>
<p><strong><code>git clone --filter</code> +<code>git sparse-checkout</code>只下载需要的文件</strong></p>
<p>例如，仅克隆<code>small/</code>此测试存储库中子目录中的文件：https://github.com/cirosantilli/test-git-partial-
clone-big-small</p>
<div class="code"><pre class="code literal-block">git clone --depth 1 --filter=blob:none --sparse \
  https://github.com/cirosantilli/test-git-partial-clone-big-small
cd test-git-partial-clone-big-small
git sparse-checkout set small
</pre></div>

<p>测试库包含：</p>
<ul>
<li>
<code>big/</code>包含 10 个 10MB 文件的子目录</li>
<li>一个<code>small/</code>包含 1000 个大小为一个字节的文件的子目录</li>
</ul>
<p>所有内容都是伪随机的，因此不可压缩。</p>
<p>在我的 36.4 Mbps 互联网上的克隆时间：</p>
<ul>
<li>满：24s</li>
<li>部分：“瞬时”</li>
</ul>
<p>2021 年 1 月在 git 2.30.0 上测试。可能适用于 Git 2.25 或 2.19。</p>
<p>该<code>--filter</code>选项与远程协议的更新一起添加，它真正防止了从服务器下载对象。</p>
<p>不幸的是，这<code>sparse-checkout</code>部分也是需要的。您也可以只下载某些更容易理解的文件：</p>
<div class="code"><pre class="code literal-block">git clone --depth 1  --filter=blob:none  --no-checkout \
  https://github.com/cirosantilli/test-git-partial-clone-big-small
cd test-git-partial-clone-big-small
git checkout master -- d1
</pre></div>

<p>但是由于某种原因，该方法一个一个地下载文件非常缓慢，除非目录中的文件很少，否则无法使用。</p>
<p>可以在以下位置看到更小的测试回购： https: //github.com/cirosantilli/test-git-partial-clone</p>
<p><strong>TODO：始终下载根目录中的文件</strong></p>
<p>例如：</p>
<div class="code"><pre class="code literal-block">git clone --depth 1 --filter=blob:none --sparse \
  https://github.com/cirosantilli/test-git-partial-clone-big-small
</pre></div>

<p>下载文件<code>generate.sh</code>，并且还将包含根目录中的任何其他文件。子目录被<code>small/</code>排除<code>big/</code>，但根目录不被排除。如何防止Git下载根目录下的文件？</p>
<p>问：如何防止 git clone --filter=blob:none --sparse 下载根目录下的文件？</p>
<p><strong>分析最小存储库中的对象</strong></p>
<p>克隆命令仅获取：</p>
<ul>
<li>带有分支尖端的单个提交对象<code>master</code>
</li>
<li>存储库的 所有 4 个树对象：<ul>
<li>提交的顶层目录</li>
<li>三个目录<code>d1</code>, <code>d2</code>,<code>master</code>
</li>
</ul>
</li>
</ul>
<p>然后，该<code>git sparse-checkout set</code>命令仅从服务器获取丢失的 blob（文件）：</p>
<ul>
<li><code>d1/a</code></li>
<li><code>d1/b</code></li>
</ul>
<p>更好的是，稍后 GitHub 上可能会开始支持：</p>
<div class="code"><pre class="code literal-block">  --filter=blob:none \
  --filter=tree:0 \
</pre></div>

<p><code>--filter=tree:0</code>从 Git 2.20开始，将防止不必要地<code>clone</code>获取所有树对象，并允许将其推迟到<code>checkout</code>. 但是在我的
2020-09-18 测试中失败了：</p>
<div class="code"><pre class="code literal-block"><span class="n">fatal</span><span class="o">:</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="n">filter</span><span class="o">-</span><span class="n">spec</span><span class="w"> </span><span class="s1">'combine:blob:none+tree:0'</span>
</pre></div>

<p>大概是因为<code>--filter=combine:</code>复合过滤器（在 Git 2.24 中添加，由 multiple 隐含<code>--filter</code>）尚未实现。</p>
<p>我观察了哪些对象被获取：</p>
<div class="code"><pre class="code literal-block">git verify-pack -v .git/objects/pack/*.pack
</pre></div>

<p>如在：How to list ALL git objects in the database?
它并没有给我一个关于每个对象到底是什么的非常清楚的指示，但它确实说明了每个对象的类型（ , <code>commit</code>,
<code>tree</code>）<code>blob</code>，并且由于在那个最小的 repo 中有很少的对象，我可以明确地推断出每个对象是什么.</p>
<p><code>git rev-list --objects
--all</code>确实产生了更清晰的树/斑点路径输出，但不幸的是，当我运行它时它获取了一些对象，这使得很难确定什么时候获取了什么，让我知道是否有人有更好的命令。</p>
<p>TODO 找到 GitHub 公告，说他们什么时候开始支持它。https://github.blog/2020-01-17-bring-your-
monorepo-down-to-size-with-sparse-checkout/从 2020-01-17 已经提到<code>--filter
blob:none</code>。</p>
<p><strong><code>git sparse-checkout</code></strong></p>
<p>我认为这个命令是为了管理一个设置文件，上面写着“我只关心这些子树”，这样以后的命令只会影响那些子树。但这有点难以确定，因为当前的文档有点……稀疏 ;-)</p>
<p>它本身不会阻止获取 blob。</p>
<p>如果这种理解是正确的，那么这将是对<code>git clone --filter</code>上述描述的一个很好的补充，因为如果您打算在部分克隆的 repo 中执行 git
操作，它将防止无意中获取更多对象。</p>
<p>当我尝试使用 Git 2.25.1 时：</p>
<div class="code"><pre class="code literal-block"><span class="nt">git</span><span class="w"> </span><span class="nt">clone</span><span class="w"> </span><span class="err">\</span>
<span class="w">  </span><span class="nt">--depth</span><span class="w"> </span><span class="nt">1</span><span class="w"> </span><span class="err">\</span>
<span class="w">  </span><span class="nt">--filter</span><span class="o">=</span><span class="nt">blob</span><span class="p">:</span><span class="nd">none</span><span class="w"> </span><span class="err">\</span>
<span class="w">  </span><span class="nt">--no-checkout</span><span class="w"> </span><span class="err">\</span>
<span class="w">  </span><span class="nt">https</span><span class="o">://</span><span class="nt">github</span><span class="p">.</span><span class="nc">com</span><span class="o">/</span><span class="nt">cirosantilli</span><span class="o">/</span><span class="nt">test-git-partial-clone</span><span class="w"> </span><span class="err">\</span>
<span class="o">;</span>
<span class="nt">cd</span><span class="w"> </span><span class="nt">test-git-partial-clone</span>
<span class="nt">git</span><span class="w"> </span><span class="nt">sparse-checkout</span><span class="w"> </span><span class="nt">init</span>
</pre></div>

<p>它没有用，因为<code>init</code>实际上获取了所有对象。</p>
<p>然而，在 Git 2.28 中，它并没有按需要获取对象。但是如果我这样做：</p>
<div class="code"><pre class="code literal-block">git sparse-checkout set d1
</pre></div>

<p><code>d1</code>未提取和检出，即使这明确表示应该： https: //github.blog/2020-01-17-bring-your-monorepo-
down-to-size-with-sparse-checkout/#sparse-签出和部分克隆免责声明：</p>
<blockquote>
<p>请留意部分克隆功能是否普遍可用[1]。</p>
<p>[1]：GitHub 仍在内部评估此功能，同时它已在选定的几个存储库（包括本文中使用的示例）上启用。随着该功能的稳定和成熟，我们会及时通知您最新进展。</p>
</blockquote>
<p>所以是的，目前很难确定，部分原因是 GitHub 是封闭源代码的乐趣。但让我们密切关注它。</p>
<p><strong>命令分解</strong></p>
<p>服务器应配置为：</p>
<div class="code"><pre class="code literal-block"><span class="n">git</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">--</span><span class="n">local</span><span class="w"> </span><span class="n">uploadpack</span><span class="o">.</span><span class="n">allowfilter</span><span class="w"> </span><span class="mi">1</span>
<span class="n">git</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">--</span><span class="n">local</span><span class="w"> </span><span class="n">uploadpack</span><span class="o">.</span><span class="n">allowanysha1inwant</span><span class="w"> </span><span class="mi">1</span>
</pre></div>

<p>命令分解：</p>
<ul>
<li>
<p><code>--filter=blob:none</code>跳过所有 blob，但仍获取所有树对象</p>
</li>
<li>
<p><code>--filter=tree:0</code>跳过不需要的树：https://www.spinics.net/lists/git/msg342006.html</p>
</li>
<li>
<p><code>--depth 1</code>已经暗示<code>--single-branch</code>，另请参阅：How do I clone a single branch in Git?</p>
</li>
<li>
<p><code>file://$(path)</code>需要克服<code>git clone</code>协议恶作剧：How to shallow clone a local git repository with a relative path?</p>
</li>
<li>
<p><code>--filter=combine:FILTER1+FILTER2</code>是一次使用多个过滤器的语法，由于某种原因尝试通过<code>--filter</code>失败：“多个过滤器规范无法组合”。这是在 Git 2.24 中添加的 e987df5fe62b8b29be4cdcdeb3704681ada2b29e “list-objects-filter: implement composite filters”</p>
</li>
</ul>
<p>编辑：在 Git 2.28 上，我通过实验看到它<code>--filter=FILTER1 --filter FILTER2</code>也具有相同的效果，因为
GitHub<code>combine:</code>截至 2020-09-18 尚未实施并抱怨<code>fatal: invalid filter-spec
'combine:blob:none+tree:0'</code>。TODO 是在哪个版本引入的？</p>
<p>的格式<code>--filter</code>记录在<code>man git-rev-list</code>.</p>
<p>关于 Git 树的文档：</p>
<ul>
<li>https://github.com/git/git/blob/v2.19.0/Documentation/technical/partial-clone.txt</li>
<li>https://github.com/git/git/blob/v2.19.0/Documentation/rev-list-options.txt#L720</li>
<li>https://github.com/git/git/blob/v2.19.0/t/t5616-partial-clone.sh</li>
</ul>
<p><strong>在本地测试一下</strong></p>
<p>以下脚本在本地可重复生成https://github.com/cirosantilli/test-git-partial-
clone存储库，进行本地克隆，并观察克隆的内容：</p>
<div class="code"><table class="codetable">
<tr>
<td class="linenos linenodiv"><a href="#-1"><code data-line-number=" 1"></code></a></td>
<td class="code"><code><span class="ch">#!/usr/bin/env bash</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-2"><code data-line-number=" 2"></code></a></td>
<td class="code"><code><span class="nb">set</span><span class="w"> </span>-eu
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-3"><code data-line-number=" 3"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-4"><code data-line-number=" 4"></code></a></td>
<td class="code"><code>list-objects<span class="o">()</span><span class="w"> </span><span class="o">(</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-5"><code data-line-number=" 5"></code></a></td>
<td class="code"><code><span class="w">  </span>git<span class="w"> </span>rev-list<span class="w"> </span>--all<span class="w"> </span>--objects
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-6"><code data-line-number=" 6"></code></a></td>
<td class="code"><code><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"master commit SHA: </span><span class="k">$(</span>git<span class="w"> </span>log<span class="w"> </span>-1<span class="w"> </span>--format<span class="o">=</span><span class="s2">"%H"</span><span class="k">)</span><span class="s2">"</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-7"><code data-line-number=" 7"></code></a></td>
<td class="code"><code><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"mybranch commit SHA: </span><span class="k">$(</span>git<span class="w"> </span>log<span class="w"> </span>-1<span class="w"> </span>--format<span class="o">=</span><span class="s2">"%H"</span><span class="k">)</span><span class="s2">"</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-8"><code data-line-number=" 8"></code></a></td>
<td class="code"><code><span class="w">  </span>git<span class="w"> </span>ls-tree<span class="w"> </span>master
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-9"><code data-line-number=" 9"></code></a></td>
<td class="code"><code><span class="w">  </span>git<span class="w"> </span>ls-tree<span class="w"> </span>mybranch<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>mybranch
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-10"><code data-line-number="10"></code></a></td>
<td class="code"><code><span class="w">  </span>git<span class="w"> </span>ls-tree<span class="w"> </span>master~<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>root
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-11"><code data-line-number="11"></code></a></td>
<td class="code"><code><span class="o">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-12"><code data-line-number="12"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-13"><code data-line-number="13"></code></a></td>
<td class="code"><code><span class="c1"># Reproducibility.</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-14"><code data-line-number="14"></code></a></td>
<td class="code"><code><span class="nb">export</span><span class="w"> </span><span class="nv">GIT_COMMITTER_NAME</span><span class="o">=</span><span class="s1">'a'</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-15"><code data-line-number="15"></code></a></td>
<td class="code"><code><span class="nb">export</span><span class="w"> </span><span class="nv">GIT_COMMITTER_EMAIL</span><span class="o">=</span><span class="s1">'a'</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-16"><code data-line-number="16"></code></a></td>
<td class="code"><code><span class="nb">export</span><span class="w"> </span><span class="nv">GIT_AUTHOR_NAME</span><span class="o">=</span><span class="s1">'a'</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-17"><code data-line-number="17"></code></a></td>
<td class="code"><code><span class="nb">export</span><span class="w"> </span><span class="nv">GIT_AUTHOR_EMAIL</span><span class="o">=</span><span class="s1">'a'</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-18"><code data-line-number="18"></code></a></td>
<td class="code"><code><span class="nb">export</span><span class="w"> </span><span class="nv">GIT_COMMITTER_DATE</span><span class="o">=</span><span class="s1">'2000-01-01T00:00:00+0000'</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-19"><code data-line-number="19"></code></a></td>
<td class="code"><code><span class="nb">export</span><span class="w"> </span><span class="nv">GIT_AUTHOR_DATE</span><span class="o">=</span><span class="s1">'2000-01-01T00:00:00+0000'</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-20"><code data-line-number="20"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-21"><code data-line-number="21"></code></a></td>
<td class="code"><code>rm<span class="w"> </span>-rf<span class="w"> </span>server_repo<span class="w"> </span>local_repo
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-22"><code data-line-number="22"></code></a></td>
<td class="code"><code>mkdir<span class="w"> </span>server_repo
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-23"><code data-line-number="23"></code></a></td>
<td class="code"><code><span class="nb">cd</span><span class="w"> </span>server_repo
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-24"><code data-line-number="24"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-25"><code data-line-number="25"></code></a></td>
<td class="code"><code><span class="c1"># Create repo.</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-26"><code data-line-number="26"></code></a></td>
<td class="code"><code>git<span class="w"> </span>init<span class="w"> </span>--quiet
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-27"><code data-line-number="27"></code></a></td>
<td class="code"><code>git<span class="w"> </span>config<span class="w"> </span>--local<span class="w"> </span>uploadpack.allowfilter<span class="w"> </span><span class="m">1</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-28"><code data-line-number="28"></code></a></td>
<td class="code"><code>git<span class="w"> </span>config<span class="w"> </span>--local<span class="w"> </span>uploadpack.allowanysha1inwant<span class="w"> </span><span class="m">1</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-29"><code data-line-number="29"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-30"><code data-line-number="30"></code></a></td>
<td class="code"><code><span class="c1"># First commit.</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-31"><code data-line-number="31"></code></a></td>
<td class="code"><code><span class="c1"># Directories present in all branches.</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-32"><code data-line-number="32"></code></a></td>
<td class="code"><code>mkdir<span class="w"> </span>d1<span class="w"> </span>d2
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-33"><code data-line-number="33"></code></a></td>
<td class="code"><code><span class="nb">printf</span><span class="w"> </span><span class="s1">'d1/a'</span><span class="w"> </span>&gt;<span class="w"> </span>./d1/a
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-34"><code data-line-number="34"></code></a></td>
<td class="code"><code><span class="nb">printf</span><span class="w"> </span><span class="s1">'d1/b'</span><span class="w"> </span>&gt;<span class="w"> </span>./d1/b
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-35"><code data-line-number="35"></code></a></td>
<td class="code"><code><span class="nb">printf</span><span class="w"> </span><span class="s1">'d2/a'</span><span class="w"> </span>&gt;<span class="w"> </span>./d2/a
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-36"><code data-line-number="36"></code></a></td>
<td class="code"><code><span class="nb">printf</span><span class="w"> </span><span class="s1">'d2/b'</span><span class="w"> </span>&gt;<span class="w"> </span>./d2/b
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-37"><code data-line-number="37"></code></a></td>
<td class="code"><code><span class="c1"># Present only in root.</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-38"><code data-line-number="38"></code></a></td>
<td class="code"><code>mkdir<span class="w"> </span><span class="s1">'root'</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-39"><code data-line-number="39"></code></a></td>
<td class="code"><code><span class="nb">printf</span><span class="w"> </span><span class="s1">'root'</span><span class="w"> </span>&gt;<span class="w"> </span>./root/root
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-40"><code data-line-number="40"></code></a></td>
<td class="code"><code>git<span class="w"> </span>add<span class="w"> </span>.
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-41"><code data-line-number="41"></code></a></td>
<td class="code"><code>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">'root'</span><span class="w"> </span>--quiet
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-42"><code data-line-number="42"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-43"><code data-line-number="43"></code></a></td>
<td class="code"><code><span class="c1"># Second commit only on master.</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-44"><code data-line-number="44"></code></a></td>
<td class="code"><code>git<span class="w"> </span>rm<span class="w"> </span>--quiet<span class="w"> </span>-r<span class="w"> </span>./root
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-45"><code data-line-number="45"></code></a></td>
<td class="code"><code>mkdir<span class="w"> </span><span class="s1">'master'</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-46"><code data-line-number="46"></code></a></td>
<td class="code"><code><span class="nb">printf</span><span class="w"> </span><span class="s1">'master'</span><span class="w"> </span>&gt;<span class="w"> </span>./master/master
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-47"><code data-line-number="47"></code></a></td>
<td class="code"><code>git<span class="w"> </span>add<span class="w"> </span>.
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-48"><code data-line-number="48"></code></a></td>
<td class="code"><code>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">'master commit'</span><span class="w"> </span>--quiet
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-49"><code data-line-number="49"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-50"><code data-line-number="50"></code></a></td>
<td class="code"><code><span class="c1"># Second commit only on mybranch.</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-51"><code data-line-number="51"></code></a></td>
<td class="code"><code>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>mybranch<span class="w"> </span>--quiet<span class="w"> </span>master~
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-52"><code data-line-number="52"></code></a></td>
<td class="code"><code>git<span class="w"> </span>rm<span class="w"> </span>--quiet<span class="w"> </span>-r<span class="w"> </span>./root
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-53"><code data-line-number="53"></code></a></td>
<td class="code"><code>mkdir<span class="w"> </span><span class="s1">'mybranch'</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-54"><code data-line-number="54"></code></a></td>
<td class="code"><code><span class="nb">printf</span><span class="w"> </span><span class="s1">'mybranch'</span><span class="w"> </span>&gt;<span class="w"> </span>./mybranch/mybranch
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-55"><code data-line-number="55"></code></a></td>
<td class="code"><code>git<span class="w"> </span>add<span class="w"> </span>.
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-56"><code data-line-number="56"></code></a></td>
<td class="code"><code>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">'mybranch commit'</span><span class="w"> </span>--quiet
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-57"><code data-line-number="57"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-58"><code data-line-number="58"></code></a></td>
<td class="code"><code><span class="nb">echo</span><span class="w"> </span><span class="s2">"# List and identify all objects"</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-59"><code data-line-number="59"></code></a></td>
<td class="code"><code>list-objects
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-60"><code data-line-number="60"></code></a></td>
<td class="code"><code><span class="nb">echo</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-61"><code data-line-number="61"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-62"><code data-line-number="62"></code></a></td>
<td class="code"><code><span class="c1"># Restore master.</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-63"><code data-line-number="63"></code></a></td>
<td class="code"><code>git<span class="w"> </span>checkout<span class="w"> </span>--quiet<span class="w"> </span>master
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-64"><code data-line-number="64"></code></a></td>
<td class="code"><code><span class="nb">cd</span><span class="w"> </span>..
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-65"><code data-line-number="65"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-66"><code data-line-number="66"></code></a></td>
<td class="code"><code><span class="c1"># Clone. Don't checkout for now, only .git/ dir.</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-67"><code data-line-number="67"></code></a></td>
<td class="code"><code>git<span class="w"> </span>clone<span class="w"> </span>--depth<span class="w"> </span><span class="m">1</span><span class="w"> </span>--quiet<span class="w"> </span>--no-checkout<span class="w"> </span>--filter<span class="o">=</span>blob:none<span class="w"> </span><span class="s2">"file://</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">/server_repo"</span><span class="w"> </span>local_repo
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-68"><code data-line-number="68"></code></a></td>
<td class="code"><code><span class="nb">cd</span><span class="w"> </span>local_repo
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-69"><code data-line-number="69"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-70"><code data-line-number="70"></code></a></td>
<td class="code"><code><span class="c1"># List missing objects from master.</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-71"><code data-line-number="71"></code></a></td>
<td class="code"><code><span class="nb">echo</span><span class="w"> </span><span class="s2">"# Missing objects after --no-checkout"</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-72"><code data-line-number="72"></code></a></td>
<td class="code"><code>git<span class="w"> </span>rev-list<span class="w"> </span>--all<span class="w"> </span>--quiet<span class="w"> </span>--objects<span class="w"> </span>--missing<span class="o">=</span>print
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-73"><code data-line-number="73"></code></a></td>
<td class="code"><code><span class="nb">echo</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-74"><code data-line-number="74"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-75"><code data-line-number="75"></code></a></td>
<td class="code"><code><span class="nb">echo</span><span class="w"> </span><span class="s2">"# Git checkout fails without internet"</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-76"><code data-line-number="76"></code></a></td>
<td class="code"><code>mv<span class="w"> </span>../server_repo<span class="w"> </span>../server_repo.off
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-77"><code data-line-number="77"></code></a></td>
<td class="code"><code>!<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>master
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-78"><code data-line-number="78"></code></a></td>
<td class="code"><code><span class="nb">echo</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-79"><code data-line-number="79"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-80"><code data-line-number="80"></code></a></td>
<td class="code"><code><span class="nb">echo</span><span class="w"> </span><span class="s2">"# Git checkout fetches the missing directory from internet"</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-81"><code data-line-number="81"></code></a></td>
<td class="code"><code>mv<span class="w"> </span>../server_repo.off<span class="w"> </span>../server_repo
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-82"><code data-line-number="82"></code></a></td>
<td class="code"><code>git<span class="w"> </span>checkout<span class="w"> </span>master<span class="w"> </span>--<span class="w"> </span>d1/
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-83"><code data-line-number="83"></code></a></td>
<td class="code"><code><span class="nb">echo</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-84"><code data-line-number="84"></code></a></td>
<td class="code"><code>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-85"><code data-line-number="85"></code></a></td>
<td class="code"><code><span class="nb">echo</span><span class="w"> </span><span class="s2">"# Missing objects after checking out d1"</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#-86"><code data-line-number="86"></code></a></td>
<td class="code"><code>git<span class="w"> </span>rev-list<span class="w"> </span>--all<span class="w"> </span>--quiet<span class="w"> </span>--objects<span class="w"> </span>--missing<span class="o">=</span>print
</code></td>
</tr>
</table></div>
<p>GitHub 上游。</p>
<p>Git v2.19.0 中的输出：</p>
<div class="code"><pre class="code literal-block"># List and identify all objects
c6fcdfaf2b1462f809aecdad83a186eeec00f9c1
fc5e97944480982cfc180a6d6634699921ee63ec
7251a83be9a03161acde7b71a8fda9be19f47128
62d67bce3c672fe2b9065f372726a11e57bade7e
b64bf435a3e54c5208a1b70b7bcb0fc627463a75 d1
308150e8fddde043f3dbbb8573abb6af1df96e63 d1/a
f70a17f51b7b30fec48a32e4f19ac15e261fd1a4 d1/b
84de03c312dc741d0f2a66df7b2f168d823e122a d2
0975df9b39e23c15f63db194df7f45c76528bccb d2/a
41484c13520fcbb6e7243a26fdb1fc9405c08520 d2/b
7d5230379e4652f1b1da7ed1e78e0b8253e03ba3 master
8b25206ff90e9432f6f1a8600f87a7bd695a24af master/master
ef29f15c9a7c5417944cc09711b6a9ee51b01d89
19f7a4ca4a038aff89d803f017f76d2b66063043 mybranch
1b671b190e293aa091239b8b5e8c149411d00523 mybranch/mybranch
c3760bb1a0ece87cdbaf9a563c77a45e30a4e30e
a0234da53ec608b54813b4271fbf00ba5318b99f root
93ca1422a8da0a9effc465eccbcb17e23015542d root/root
master commit SHA: fc5e97944480982cfc180a6d6634699921ee63ec
mybranch commit SHA: fc5e97944480982cfc180a6d6634699921ee63ec
040000 tree b64bf435a3e54c5208a1b70b7bcb0fc627463a75    d1
040000 tree 84de03c312dc741d0f2a66df7b2f168d823e122a    d2
040000 tree 7d5230379e4652f1b1da7ed1e78e0b8253e03ba3    master
040000 tree 19f7a4ca4a038aff89d803f017f76d2b66063043    mybranch
040000 tree a0234da53ec608b54813b4271fbf00ba5318b99f    root

# Missing objects after --no-checkout
?f70a17f51b7b30fec48a32e4f19ac15e261fd1a4
?8b25206ff90e9432f6f1a8600f87a7bd695a24af
?41484c13520fcbb6e7243a26fdb1fc9405c08520
?0975df9b39e23c15f63db194df7f45c76528bccb
?308150e8fddde043f3dbbb8573abb6af1df96e63

# Git checkout fails without internet
fatal: '/home/ciro/bak/git/test-git-web-interface/other-test-repos/partial-clone.tmp/server_repo' does not appear to be a git repository
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists.

# Git checkout fetches the missing directory from internet
remote: Enumerating objects: 1, done.
remote: Counting objects: 100% (1/1), done.
remote: Total 1 (delta 0), reused 0 (delta 0)
Receiving objects: 100% (1/1), 45 bytes | 45.00 KiB/s, done.
remote: Enumerating objects: 1, done.
remote: Counting objects: 100% (1/1), done.
remote: Total 1 (delta 0), reused 0 (delta 0)
Receiving objects: 100% (1/1), 45 bytes | 45.00 KiB/s, done.

# Missing objects after checking out d1
?8b25206ff90e9432f6f1a8600f87a7bd695a24af
?41484c13520fcbb6e7243a26fdb1fc9405c08520
?0975df9b39e23c15f63db194df7f45c76528bccb
</pre></div>

<p>结论：来自外部的所有斑点都<code>d1/</code>丢失了。例如<code>0975df9b39e23c15f63db194df7f45c76528bccb</code>，<code>d2/b</code>退房后不存在<code>d1/a</code>。</p>
<p>请注意，<code>root/root</code>和<code>mybranch/mybranch</code>也丢失了，但从<code>--depth 1</code>丢失文件列表中隐藏了它。如果您删除<code>--depth
1</code>，则它们会显示在丢失文件列表中。</p>
<p><strong>我有一个梦想</strong></p>
<p>这个特性可以彻底改变 Git。</p>
<p>Imagine having all the code base of your enterprise in a single monorepo
without ugly third-party tools like <code>repo</code>.</p>
<p>Imagine storing huge blobs directly in the repo without any ugly third party
extensions.</p>
<p>Imagine if GitHub would allow per file / directory metadata like stars and
permissions, so you can store all your personal stuff under a single repo.</p>
<p>Imagine if submodules were treated exactly like regular directories: just
request a tree SHA, and a DNS-like mechanism resolves your request, first
looking on your local <code>~/.git</code>, then first to closer servers (your
enterprise's mirror / cache) and ending up on GitHub.</p>
<p>I have a dream.</p>
<p><br><br><a href="../how-do-i-clone-a-subdirectory-only-of-a-git-repository/">查看原文</a></p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/git/" rel="tag">git</a></li>
            <li><a class="tag p-category" href="../../categories/git-clone/" rel="tag">git-clone</a></li>
            <li><a class="tag p-category" href="../../categories/repository/" rel="tag">repository</a></li>
            <li><a class="tag p-category" href="../../categories/sparse-checkout/" rel="tag">sparse-checkout</a></li>
            <li><a class="tag p-category" href="../../categories/subdirectory/" rel="tag">subdirectory</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../ru-he-sui-ji-hua-xi-pai-javascript-shu-zu/" rel="prev" title="如何随机化（洗牌）JavaScript 数组？">Previous post</a>
            </li>
            <li class="next">
                <a href="../ru-he-cong-ling-yi-ge-fen-zhi-huo-qu-yi-ge-wen-jian/" rel="next" title="如何从另一个分支获取一个文件？">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
