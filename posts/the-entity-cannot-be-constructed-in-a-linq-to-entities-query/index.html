<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>The entity cannot be constructed in a LINQ to Entities query | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/the-entity-cannot-be-constructed-in-a-linq-to-entities-query/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../how-do-i-run-a-program-with-a-different-working-directory-from-current-from-linux-shell/" title="How do I run a program with a different working directory from current, from Linux shell?" type="text/html">
<link rel="next" href="../how-do-i-get-the-picture-size-with-pil/" title="How do I get the picture size with PIL?" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="The entity cannot be constructed in a LINQ to Entities query">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/the-entity-cannot-be-constructed-in-a-linq-to-entities-query/">
<meta property="og:description" content="There is an entity type called Product that is generated by entity
framework. I have written this query
public IQueryable&lt;Product&gt; GetProducts(int categoryID)
{
    return from p in db.Products
      ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-03-03T16:28:14+08:00">
<meta property="article:tag" content=".net-c#">
<meta property="article:tag" content="entity-framework">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">The entity cannot be constructed in a LINQ to Entities query</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-03-03T16:28:14+08:00" itemprop="datePublished" title="2023-03-03 16:28">2023-03-03 16:28</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>There is an entity type called <code>Product</code> that is generated by entity
framework. I have written this query</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">IQueryable</span><span class="o">&lt;</span><span class="nv">Product</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">GetProducts</span><span class="ss">(</span><span class="nv">int</span><span class="w"> </span><span class="nv">categoryID</span><span class="ss">)</span>
{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">db</span>.<span class="nv">Products</span>
<span class="w">           </span><span class="nv">where</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">CategoryID</span><span class="o">==</span><span class="w"> </span><span class="nv">categoryID</span>
<span class="w">           </span><span class="nv">select</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">Product</span><span class="w"> </span>{<span class="w"> </span><span class="nv">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">Name</span>}<span class="c1">;</span>
}
</pre></div>

<p>The code below throws the following error :</p>
<blockquote>
<p>"The entity or complex type Shop.Product cannot be constructed in a LINQ to
Entities query"</p>
</blockquote>
<div class="code"><pre class="code literal-block"><span class="k">var</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">productRepository</span><span class="o">.</span><span class="n">GetProducts</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">Tolist</span><span class="p">();</span>
</pre></div>

<p>But when I use <code>select p</code> instead of <code>select new Product { Name = p.Name};</code> it
works correctly.</p>
<p>How can I preform a custom select section?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>You cannot (and should not be able to) project onto a mapped entity. You can,
however, project onto an anonymous type or onto a DTO:</p>
<div class="code"><pre class="code literal-block">public class ProductDTO
{
    public string Name { get; set; }
    // Other field you may need from the Product entity
}
</pre></div>

<p>And your method will return a List of DTO's.</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">List</span><span class="o">&lt;</span><span class="nv">ProductDTO</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">GetProducts</span><span class="ss">(</span><span class="nv">int</span><span class="w"> </span><span class="nv">categoryID</span><span class="ss">)</span>
{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ss">(</span><span class="nv">from</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">db</span>.<span class="nv">Products</span>
<span class="w">            </span><span class="nv">where</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">CategoryID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">categoryID</span>
<span class="w">            </span><span class="nv">select</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">ProductDTO</span><span class="w"> </span>{<span class="w"> </span><span class="nv">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">Name</span><span class="w"> </span>}<span class="ss">)</span>.<span class="nv">ToList</span><span class="ss">()</span><span class="c1">;</span>
}
</pre></div>

<p><br></p>
<h3>Suggest</h3>
<p>You can project into anonymous type, and then from it to model type</p>
<div class="code"><pre class="code literal-block"><span class="nv">public</span><span class="w"> </span><span class="nv">IEnumerable</span><span class="o">&lt;</span><span class="nv">Product</span><span class="o">&gt;</span><span class="w"> </span><span class="nv">GetProducts</span><span class="ss">(</span><span class="nv">int</span><span class="w"> </span><span class="nv">categoryID</span><span class="ss">)</span>
{
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ss">(</span><span class="nv">from</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">Context</span>.<span class="nv">Set</span><span class="o">&lt;</span><span class="nv">Product</span><span class="o">&gt;</span><span class="ss">()</span>
<span class="w">            </span><span class="nv">where</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">CategoryID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">categoryID</span>
<span class="w">            </span><span class="nv">select</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span>{<span class="w"> </span><span class="nv">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">Name</span><span class="w"> </span>}<span class="ss">)</span>.<span class="nv">ToList</span><span class="ss">()</span>
<span class="w">           </span>.<span class="nv">Select</span><span class="ss">(</span><span class="nv">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">Product</span><span class="w"> </span>{<span class="w"> </span><span class="nv">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">x</span>.<span class="nv">Name</span><span class="w"> </span>}<span class="ss">)</span><span class="c1">;</span>
}
</pre></div>

<p><strong>Edit</strong> : I am going to be a bit more specific since this question got a lot
of attention.</p>
<p>You cannot project into model type directly (EF restriction), so there is no
way around this. The only way is to project into anonymous type (1st
iteration), and then to model type (2nd iteration).</p>
<p>Please also be aware that when you partially load entities in this manner,
they cannot be updated, so they should remain detached, as they are.</p>
<p>I never did completely understand why this is not possible, and the answers on
this thread do not give strong reasons against it (mostly speaking about
partially loaded data). It is correct that in partially loaded state entity
cannot be updated, but then, this entity would be detached, so accidental
attempts to save them would not be possible.</p>
<p>Consider method I used above: we still have a partially loaded model entity as
a result. This entity is detached.</p>
<p>Consider this (wish-to-exist) possible code:</p>
<div class="code"><pre class="code literal-block"><span class="k">return</span><span class="w"> </span><span class="ss">(</span><span class="nv">from</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">Context</span>.<span class="nv">Set</span><span class="o">&lt;</span><span class="nv">Product</span><span class="o">&gt;</span><span class="ss">()</span>
<span class="w">        </span><span class="nv">where</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">CategoryID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">categoryID</span>
<span class="w">        </span><span class="nv">select</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">Product</span><span class="w"> </span>{<span class="w"> </span><span class="nv">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span>.<span class="nv">Name</span><span class="w"> </span>}<span class="ss">)</span>.<span class="nv">AsNoTracking</span><span class="ss">()</span>.<span class="nv">ToList</span><span class="ss">()</span><span class="c1">;</span>
</pre></div>

<p>This could also result in a list of detached entities, so we would not need to
make two iterations. A compiler would be smart to see that AsNoTracking() has
been used, which will result in detached entities, so it could allow us to do
this. If, however, AsNoTracking() was omitted, it could throw the same
exception as it is throwing now, to warn us that we need to be specific enough
about the result we want.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/net-c/" rel="tag">.net-c#</a></li>
            <li><a class="tag p-category" href="../../categories/entity-framework/" rel="tag">entity-framework</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../how-do-i-run-a-program-with-a-different-working-directory-from-current-from-linux-shell/" rel="prev" title="How do I run a program with a different working directory from current, from Linux shell?">Previous post</a>
            </li>
            <li class="next">
                <a href="../how-do-i-get-the-picture-size-with-pil/" rel="next" title="How do I get the picture size with PIL?">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
