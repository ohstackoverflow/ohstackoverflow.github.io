<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>How to use java.net.URLConnection to fire and handle HTTP requests | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/how-to-use-java-net-urlconnection-to-fire-and-handle-http-requests/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../what-s-the-difference-between-a-method-and-a-function/" title="What's the difference between a method and a function?" type="text/html">
<link rel="next" href="../how-to-create-an-array-containing-1-n/" title="How to create an array containing 1...N" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="How to use java.net.URLConnection to fire and handle HTTP requests">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/how-to-use-java-net-urlconnection-to-fire-and-handle-http-requests/">
<meta property="og:description" content="Use of java.net.URLConnection is asked about pretty often here, and the
Oracle tutorial is too concise about it.
That tutorial basically only shows how to fire a GET request and read the
response. It ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-16T22:38:39+08:00">
<meta property="article:tag" content="http">
<meta property="article:tag" content="httprequest">
<meta property="article:tag" content="httpurlconnection">
<meta property="article:tag" content="java">
<meta property="article:tag" content="urlconnection">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">How to use java.net.URLConnection to fire and handle HTTP requests</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-16T22:38:39+08:00" itemprop="datePublished" title="2023-02-16 22:38">2023-02-16 22:38</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>Use of <code>java.net.URLConnection</code> is asked about pretty often here, and the
Oracle tutorial is <em>too</em> concise about it.</p>
<p>That tutorial basically only shows how to fire a GET request and read the
response. It doesn't explain anywhere how to use it to, among others, perform
a POST request, set request headers, read response headers, deal with cookies,
submit a HTML form, upload a file, etc.</p>
<p>So, how can I use <code>java.net.URLConnection</code> to fire and handle "advanced" HTTP
requests?</p>
<p><br><br></p>
<h2>Answer</h2>
<p><em>First a disclaimer beforehand: the posted code snippets are all basic
examples. You'll need to handle trivial<code>IOException</code>s and <code>RuntimeException</code>s
like <code>NullPointerException</code>, <code>ArrayIndexOutOfBoundsException</code> and consorts
yourself.</em></p>
<p><em>In case you're developing for Android instead of Java, note also that since
introduction of API level 28, cleartext HTTP requests are disabled by default.
You are encouraged to use<code>HttpsURLConnection</code>, but if it is really necessary,
cleartext can be enabled in the Application Manifest.</em></p>
<hr>
<h4>Preparing</h4>
<p>We first need to know at least the URL and the charset. The parameters are
optional and depend on the functional requirements.</p>
<div class="code"><pre class="code literal-block"><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"http://example.com"</span><span class="p">;</span>
<span class="nb nb-Type">String</span><span class="w"> </span><span class="n">charset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UTF-8"</span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Or</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Java</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">later</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">constant</span><span class="p">:</span><span class="w"> </span><span class="n">java</span><span class="o">.</span><span class="n">nio</span><span class="o">.</span><span class="n">charset</span><span class="o">.</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="n">UTF_8</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
<span class="nb nb-Type">String</span><span class="w"> </span><span class="n">param1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"value1"</span><span class="p">;</span>
<span class="nb nb-Type">String</span><span class="w"> </span><span class="n">param2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"value2"</span><span class="p">;</span>
<span class="o">//</span><span class="w"> </span><span class="o">...</span>

<span class="nb nb-Type">String</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"param1=</span><span class="si">%s</span><span class="s2">&amp;param2=</span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span>
<span class="w">    </span><span class="n">URLEncoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">param1</span><span class="p">,</span><span class="w"> </span><span class="n">charset</span><span class="p">),</span>
<span class="w">    </span><span class="n">URLEncoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">param2</span><span class="p">,</span><span class="w"> </span><span class="n">charset</span><span class="p">));</span>
</pre></div>

<p>The query parameters must be in <code>name=value</code> format and be concatenated by
<code>&amp;</code>. You would normally also URL-encode the query parameters with the
specified charset using <code>URLEncoder#encode()</code>.</p>
<p>The <code>String#format()</code> is just for convenience. I prefer it when I would need
the String concatenation operator <code>+</code> more than twice.</p>
<hr>
<h4>Firing an HTTP GET request with (optionally) query parameters</h4>
<p>It's a trivial task. It's the default request method.</p>
<div class="code"><pre class="code literal-block">URLConnection connection = new URL(url + "?" + query).openConnection();
connection.setRequestProperty("Accept-Charset", charset);
InputStream response = connection.getInputStream();
// ...
</pre></div>

<p>Any query string should be concatenated to the URL using <code>?</code>. The <code>Accept-
Charset</code> header may hint the server what encoding the parameters are in. If
you don't send any query string, then you can leave the <code>Accept-Charset</code>
header away. If you don't need to set any headers, then you can even use the
<code>URL#openStream()</code> shortcut method.</p>
<div class="code"><pre class="code literal-block">InputStream response = new URL(url).openStream();
// ...
</pre></div>

<p>Either way, if the other side is an <code>HttpServlet</code>, then its <code>doGet()</code> method
will be called and the parameters will be available by
<code>HttpServletRequest#getParameter()</code>.</p>
<p>For testing purposes, you can print the response body to standard output as
below:</p>
<div class="code"><pre class="code literal-block"><span class="nv">try</span><span class="w"> </span><span class="ss">(</span><span class="nv">Scanner</span><span class="w"> </span><span class="nv">scanner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">Scanner</span><span class="ss">(</span><span class="nv">response</span><span class="ss">))</span><span class="w"> </span>{
<span class="w">    </span><span class="nv">String</span><span class="w"> </span><span class="nv">responseBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">scanner</span>.<span class="nv">useDelimiter</span><span class="ss">(</span><span class="s2">"\\A"</span><span class="ss">)</span>.<span class="k">next</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">System</span>.<span class="nv">out</span>.<span class="nv">println</span><span class="ss">(</span><span class="nv">responseBody</span><span class="ss">)</span><span class="c1">;</span>
}
</pre></div>

<hr>
<h4>Firing an HTTP POST request with query parameters</h4>
<p>Setting the <code>URLConnection#setDoOutput()</code> to <code>true</code> implicitly sets the
request method to POST. The standard HTTP POST as web forms do is of type
<code>application/x-www-form-urlencoded</code> wherein the query string is written to the
request body.</p>
<div class="code"><pre class="code literal-block">URLConnection connection = new URL(url).openConnection();
connection.setDoOutput(true); // Triggers POST.
connection.setRequestProperty("Accept-Charset", charset);
connection.setRequestProperty("Content-Type", "application/x-www-form-urlencoded;charset=" + charset);

try (OutputStream output = connection.getOutputStream()) {
    output.write(query.getBytes(charset));
}

InputStream response = connection.getInputStream();
// ...
</pre></div>

<p>Note: whenever you'd like to submit a HTML form programmatically, don't forget
to take the <code>name=value</code> pairs of any <code>&lt;input type="hidden"&gt;</code> elements into
the query string and of course also the <code>name=value</code> pair of the <code>&lt;input
type="submit"&gt;</code> element which you'd like to "press" programmatically (because
that's usually been used in the server side to distinguish if a button was
pressed and if so, which one).</p>
<p>You can also cast the obtained <code>URLConnection</code> to <code>HttpURLConnection</code> and use
its <code>HttpURLConnection#setRequestMethod()</code> instead. But if you're trying to
use the connection for output you still need to set
<code>URLConnection#setDoOutput()</code> to <code>true</code>.</p>
<div class="code"><pre class="code literal-block">HttpURLConnection httpConnection = (HttpURLConnection) new URL(url).openConnection();
httpConnection.setRequestMethod("POST");
// ...
</pre></div>

<p>Either way, if the other side is an <code>HttpServlet</code>, then its <code>doPost()</code> method
will be called and the parameters will be available by
<code>HttpServletRequest#getParameter()</code>.</p>
<hr>
<h4>Actually firing the HTTP request</h4>
<p>You can fire the HTTP request explicitly with <code>URLConnection#connect()</code>, but
the request will automatically be fired on demand when you want to get any
information about the HTTP response, such as the response body using
<code>URLConnection#getInputStream()</code> and so on. The above examples does exactly
that, so the <code>connect()</code> call is in fact superfluous.</p>
<hr>
<h4>Gathering HTTP response information</h4>
<ol>
<li>HTTP response status:</li>
</ol>
<p>You need an <code>HttpURLConnection</code> here. Cast it first if necessary.</p>
<div class="code"><pre class="code literal-block">    int status = httpConnection.getResponseCode();
</pre></div>

<ol>
<li>
<p>HTTP response headers:</p>
<div class="code"><pre class="code literal-block"><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">Entry</span><span class="o">&lt;</span><span class="nv">String</span>,<span class="w"> </span><span class="nv">List</span><span class="o">&lt;</span><span class="nv">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nv">header</span><span class="w"> </span>:<span class="w"> </span><span class="nv">connection</span>.<span class="nv">getHeaderFields</span><span class="ss">()</span>.<span class="nv">entrySet</span><span class="ss">())</span><span class="w"> </span>{
<span class="w"> </span><span class="nv">System</span>.<span class="nv">out</span>.<span class="nv">println</span><span class="ss">(</span><span class="nv">header</span>.<span class="nv">getKey</span><span class="ss">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"="</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">header</span>.<span class="nv">getValue</span><span class="ss">())</span><span class="c1">;</span>
</pre></div>

<p>}</p>
</li>
<li>
<p>HTTP response encoding:</p>
</li>
</ol>
<p>When the <code>Content-Type</code> contains a <code>charset</code> parameter, then the response body
is likely text based and we'd like to process the response body with the
server-side specified character encoding then.</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="nv">String</span><span class="w"> </span><span class="nv">contentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">connection</span>.<span class="nv">getHeaderField</span><span class="ss">(</span><span class="s2">"Content-Type"</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">String</span><span class="w"> </span><span class="nv">charset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">null</span><span class="c1">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">String</span><span class="w"> </span><span class="nv">param</span><span class="w"> </span>:<span class="w"> </span><span class="nv">contentType</span>.<span class="nv">replace</span><span class="ss">(</span><span class="s2">" "</span>,<span class="w"> </span><span class="s2">""</span><span class="ss">)</span>.<span class="nv">split</span><span class="ss">(</span><span class="s2">";"</span><span class="ss">))</span><span class="w"> </span>{
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">param</span>.<span class="nv">startsWith</span><span class="ss">(</span><span class="s2">"charset="</span><span class="ss">))</span><span class="w"> </span>{
<span class="w">            </span><span class="nv">charset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">param</span>.<span class="nv">split</span><span class="ss">(</span><span class="s2">"="</span>,<span class="w"> </span><span class="mi">2</span><span class="ss">)</span>[<span class="mi">1</span>]<span class="c1">;</span>
<span class="w">            </span><span class="k">break</span><span class="c1">;</span>
<span class="w">        </span>}
<span class="w">    </span>}

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">charset</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">null</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">        </span><span class="nv">try</span><span class="w"> </span><span class="ss">(</span><span class="nv">BufferedReader</span><span class="w"> </span><span class="nv">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">BufferedReader</span><span class="ss">(</span><span class="nv">new</span><span class="w"> </span><span class="nv">InputStreamReader</span><span class="ss">(</span><span class="nv">response</span>,<span class="w"> </span><span class="nv">charset</span><span class="ss">)))</span><span class="w"> </span>{
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">String</span><span class="w"> </span><span class="nv">line</span><span class="c1">; (line = reader.readLine()) != null;) {</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span>...<span class="w"> </span><span class="nv">System</span>.<span class="nv">out</span>.<span class="nv">println</span><span class="ss">(</span><span class="nv">line</span><span class="ss">)</span>?
<span class="w">            </span>}
<span class="w">        </span>}
<span class="w">    </span>}<span class="w"> </span><span class="k">else</span><span class="w"> </span>{
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="nv">It</span><span class="err">'s likely binary content, use InputStream/OutputStream.</span>
<span class="err">    }</span>
</pre></div>

<hr>
<h4>Maintaining the session</h4>
<p>The server side session is usually backed by a cookie. Some web forms require
that you're logged in and/or are tracked by a session. You can use the
<code>CookieHandler</code> API to maintain cookies. You need to prepare a <code>CookieManager</code>
with a <code>CookiePolicy</code> of <code>ACCEPT_ALL</code> before sending all HTTP requests.</p>
<div class="code"><pre class="code literal-block"><span class="c1">// First set the default cookie manager.</span>
<span class="n">CookieHandler</span><span class="p">.</span><span class="n">setDefault</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">CookieManager</span><span class="p">(</span><span class="nb">null</span><span class="p">,</span><span class="w"> </span><span class="n">CookiePolicy</span><span class="p">.</span><span class="n">ACCEPT_ALL</span><span class="p">));</span>

<span class="c1">// All the following subsequent URLConnections will use the same cookie manager.</span>
<span class="n">URLConnection</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">openConnection</span><span class="p">();</span>
<span class="c1">// ...</span>

<span class="n">connection</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">openConnection</span><span class="p">();</span>
<span class="c1">// ...</span>

<span class="n">connection</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">openConnection</span><span class="p">();</span>
<span class="c1">// ...</span>
</pre></div>

<p>Note that this is known to not always work properly in all circumstances. If
it fails for you, then best is to manually gather and set the cookie headers.
You basically need to grab all <code>Set-Cookie</code> headers from the response of the
login or the first <code>GET</code> request and then pass this through the subsequent
requests.</p>
<div class="code"><pre class="code literal-block"><span class="c1">// Gather all cookies on the first request.</span>
<span class="n">URLConnection</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">openConnection</span><span class="p">();</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cookies</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">connection</span><span class="p">.</span><span class="n">getHeaderFields</span><span class="p">().</span><span class="k">get</span><span class="p">(</span><span class="s">"Set-Cookie"</span><span class="p">);</span>
<span class="c1">// ...</span>

<span class="c1">// Then use the same cookies on all subsequent requests.</span>
<span class="n">connection</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">openConnection</span><span class="p">();</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cookies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">connection</span><span class="p">.</span><span class="n">addRequestProperty</span><span class="p">(</span><span class="s">"Cookie"</span><span class="p">,</span><span class="w"> </span><span class="n">cookie</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">";"</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>
<span class="c1">// ...</span>
</pre></div>

<p>The <code>split(";", 2)[0]</code> is there to get rid of cookie attributes which are
irrelevant for the server side like <code>expires</code>, <code>path</code>, etc. Alternatively, you
could also use <code>cookie.substring(0, cookie.indexOf(';'))</code> instead of
<code>split()</code>.</p>
<hr>
<h4>Streaming mode</h4>
<p>The <code>HttpURLConnection</code> will by default buffer the <em>entire</em> request body
before actually sending it, regardless of whether you've set a fixed content
length yourself using <code>connection.setRequestProperty("Content-Length",
contentLength);</code>. This may cause <code>OutOfMemoryException</code>s whenever you
concurrently send large POST requests (e.g. uploading files). To avoid this,
you would like to set the <code>HttpURLConnection#setFixedLengthStreamingMode()</code>.</p>
<div class="code"><pre class="code literal-block">httpConnection.setFixedLengthStreamingMode(contentLength);
</pre></div>

<p>But if the content length is really not known beforehand, then you can make
use of chunked streaming mode by setting the
<code>HttpURLConnection#setChunkedStreamingMode()</code> accordingly. This will set the
HTTP <code>Transfer-Encoding</code> header to <code>chunked</code> which will force the request body
being sent in chunks. The below example will send the body in chunks of 1 KB.</p>
<div class="code"><pre class="code literal-block">httpConnection.setChunkedStreamingMode(1024);
</pre></div>

<hr>
<h4>User-Agent</h4>
<p>It can happen that a request returns an unexpected response, while it works
fine with a real web browser. The server side is probably blocking requests
based on the <code>User-Agent</code> request header. The <code>URLConnection</code> will by default
set it to <code>Java/1.6.0_19</code> where the last part is obviously the JRE version.
You can override this as follows:</p>
<div class="code"><pre class="code literal-block"><span class="nv">connection</span>.<span class="nv">setRequestProperty</span><span class="ss">(</span><span class="s2">"User-Agent"</span>,<span class="w"> </span><span class="s2">"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.36"</span><span class="ss">)</span><span class="c1">; // Do as if you're using Chrome 41 on Windows 7.</span>
</pre></div>

<p>Use the User-Agent string from a recent browser.</p>
<hr>
<h4>Error handling</h4>
<p>If the HTTP response code is <code>4nn</code> (Client Error) or <code>5nn</code> (Server Error),
then you may want to read the <code>HttpURLConnection#getErrorStream()</code> to see if
the server has sent any useful error information.</p>
<div class="code"><pre class="code literal-block">InputStream error = ((HttpURLConnection) connection).getErrorStream();
</pre></div>

<p>If the HTTP response code is -1, then something went wrong with connection and
response handling. The <code>HttpURLConnection</code> implementation is in older JREs
somewhat buggy with keeping connections alive. You may want to turn it off by
setting the <code>http.keepAlive</code> system property to <code>false</code>. You can do this
programmatically in the beginning of your application by:</p>
<div class="code"><pre class="code literal-block">System.setProperty("http.keepAlive", "false");
</pre></div>

<hr>
<h4>Uploading files</h4>
<p>You'd normally use <code>multipart/form-data</code> encoding for mixed POST content
(binary and character data). The encoding is in more detail described in
RFC2388.</p>
<div class="code"><pre class="code literal-block"><span class="nt">String</span><span class="w"> </span><span class="nt">param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"value"</span><span class="o">;</span>
<span class="nt">File</span><span class="w"> </span><span class="nt">textFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">File</span><span class="o">(</span><span class="s2">"/path/to/file.txt"</span><span class="o">);</span>
<span class="nt">File</span><span class="w"> </span><span class="nt">binaryFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">File</span><span class="o">(</span><span class="s2">"/path/to/file.bin"</span><span class="o">);</span>
<span class="nt">String</span><span class="w"> </span><span class="nt">boundary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">Long</span><span class="p">.</span><span class="nc">toHexString</span><span class="o">(</span><span class="nt">System</span><span class="p">.</span><span class="nc">currentTimeMillis</span><span class="o">());</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nt">Just</span><span class="w"> </span><span class="nt">generate</span><span class="w"> </span><span class="nt">some</span><span class="w"> </span><span class="nt">unique</span><span class="w"> </span><span class="nt">random</span><span class="w"> </span><span class="nt">value</span><span class="o">.</span>
<span class="nt">String</span><span class="w"> </span><span class="nt">CRLF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"\r\n"</span><span class="o">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nt">Line</span><span class="w"> </span><span class="nt">separator</span><span class="w"> </span><span class="nt">required</span><span class="w"> </span><span class="nt">by</span><span class="w"> </span><span class="nt">multipart</span><span class="o">/</span><span class="nt">form-data</span><span class="o">.</span>
<span class="nt">URLConnection</span><span class="w"> </span><span class="nt">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">URL</span><span class="o">(</span><span class="nt">url</span><span class="o">)</span><span class="p">.</span><span class="nc">openConnection</span><span class="o">();</span>
<span class="nt">connection</span><span class="p">.</span><span class="nc">setDoOutput</span><span class="o">(</span><span class="nt">true</span><span class="o">);</span>
<span class="nt">connection</span><span class="p">.</span><span class="nc">setRequestProperty</span><span class="o">(</span><span class="s2">"Content-Type"</span><span class="o">,</span><span class="w"> </span><span class="s2">"multipart/form-data; boundary="</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nt">boundary</span><span class="o">);</span>

<span class="nt">try</span><span class="w"> </span><span class="o">(</span>
<span class="w">    </span><span class="nt">OutputStream</span><span class="w"> </span><span class="nt">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">connection</span><span class="p">.</span><span class="nc">getOutputStream</span><span class="o">();</span>
<span class="w">    </span><span class="nt">PrintWriter</span><span class="w"> </span><span class="nt">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">PrintWriter</span><span class="o">(</span><span class="nt">new</span><span class="w"> </span><span class="nt">OutputStreamWriter</span><span class="o">(</span><span class="nt">output</span><span class="o">,</span><span class="w"> </span><span class="nt">charset</span><span class="o">),</span><span class="w"> </span><span class="nt">true</span><span class="o">);</span>
<span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">Send</span><span class="w"> </span><span class="err">normal</span><span class="w"> </span><span class="err">param.</span>
<span class="w">    </span><span class="err">writer.append("--"</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">boundary).append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append("</span><span class="n">Content-Disposition</span><span class="p">:</span><span class="w"> </span><span class="n">form-data</span><span class="p">;</span><span class="w"> </span><span class="err">name=\"param\"").append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append("</span><span class="n">Content-Type</span><span class="p">:</span><span class="w"> </span><span class="kc">text</span><span class="o">/</span><span class="n">plain</span><span class="p">;</span><span class="w"> </span><span class="err">charset="</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">charset).append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append(CRLF).append(param).append(CRLF).flush()</span><span class="p">;</span>

<span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">Send</span><span class="w"> </span><span class="err">text</span><span class="w"> </span><span class="err">file.</span>
<span class="w">    </span><span class="err">writer.append("--"</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">boundary).append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append("</span><span class="n">Content-Disposition</span><span class="p">:</span><span class="w"> </span><span class="n">form-data</span><span class="p">;</span><span class="w"> </span><span class="err">name=\"textFile\"</span><span class="p">;</span><span class="w"> </span><span class="err">filename=\""</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">textFile.getName()</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">"\"").append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append("</span><span class="n">Content-Type</span><span class="p">:</span><span class="w"> </span><span class="kc">text</span><span class="o">/</span><span class="n">plain</span><span class="p">;</span><span class="w"> </span><span class="err">charset="</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">charset).append(CRLF)</span><span class="p">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">Text</span><span class="w"> </span><span class="err">file</span><span class="w"> </span><span class="err">itself</span><span class="w"> </span><span class="err">must</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">saved</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">charset!</span>
<span class="w">    </span><span class="err">writer.append(CRLF).flush()</span><span class="p">;</span>
<span class="w">    </span><span class="err">Files.copy(textFile.toPath(),</span><span class="w"> </span><span class="err">output)</span><span class="p">;</span>
<span class="w">    </span><span class="err">output.flush()</span><span class="p">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">Important</span><span class="w"> </span><span class="err">before</span><span class="w"> </span><span class="err">continuing</span><span class="w"> </span><span class="err">with</span><span class="w"> </span><span class="err">writer!</span>
<span class="w">    </span><span class="err">writer.append(CRLF).flush()</span><span class="p">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">CRLF</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">important!</span><span class="w"> </span><span class="err">It</span><span class="w"> </span><span class="err">indicates</span><span class="w"> </span><span class="err">end</span><span class="w"> </span><span class="err">of</span><span class="w"> </span><span class="err">boundary.</span>

<span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">Send</span><span class="w"> </span><span class="err">binary</span><span class="w"> </span><span class="err">file.</span>
<span class="w">    </span><span class="err">writer.append("--"</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">boundary).append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append("</span><span class="n">Content-Disposition</span><span class="p">:</span><span class="w"> </span><span class="n">form-data</span><span class="p">;</span><span class="w"> </span><span class="err">name=\"binaryFile\"</span><span class="p">;</span><span class="w"> </span><span class="err">filename=\""</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">binaryFile.getName()</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">"\"").append(CRLF)</span><span class="p">;</span>
<span class="w">    </span><span class="err">writer.append("</span><span class="n">Content-Type</span><span class="p">:</span><span class="w"> </span><span class="s2">" + URLConnection.guessContentTypeFromName(binaryFile.getName())).append(CRLF);</span>
<span class="s2">    writer.append("</span><span class="n">Content-Transfer-Encoding</span><span class="o">:</span><span class="w"> </span><span class="n">binary</span><span class="s2">").append(CRLF);</span>
<span class="s2">    writer.append(CRLF).flush();</span>
<span class="s2">    Files.copy(binaryFile.toPath(), output);</span>
<span class="s2">    output.flush(); // Important before continuing with writer!</span>
<span class="s2">    writer.append(CRLF).flush(); // CRLF is important! It indicates end of boundary.</span>

<span class="s2">    // End of multipart/form-data.</span>
<span class="s2">    writer.append("</span><span class="o">--</span><span class="s2">" + boundary + "</span><span class="o">--</span><span class="err">"</span><span class="p">)</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">CRLF</span><span class="p">)</span><span class="o">.</span><span class="nf">flush</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>If the other side is an <code>HttpServlet</code>, then its <code>doPost()</code> method will be
called and the parts will be available by <code>HttpServletRequest#getPart()</code>
(note, thus <strong>not</strong> <code>getParameter()</code> and so on!). The <code>getPart()</code> method is
however relatively new, it's introduced in Servlet 3.0 (Glassfish 3, Tomcat 7,
etc.). Prior to Servlet 3.0, your best choice is using Apache Commons
FileUpload to parse a <code>multipart/form-data</code> request. Also see this answer for
examples of both the FileUpload and the Servelt 3.0 approaches.</p>
<hr>
<h4>Dealing with untrusted or misconfigured HTTPS sites</h4>
<p><em>In case you're developing for Android instead of Java, <strong>be careful</strong> : the
workaround below may save your day if you don't have correct certificates
deployed during development. But you should not use it for production. These
days (April 2021) Google will not allow your app be distributed on Play Store
if they detect insecure hostname verifier, see
https://support.google.com/faqs/answer/7188426.</em></p>
<p>Sometimes you need to connect an HTTPS URL, perhaps because you're writing a
web scraper. In that case, you may likely face a <code>javax.net.ssl.SSLException:
Not trusted server certificate</code> on some HTTPS sites who doesn't keep their SSL
certificates up to date, or a <code>java.security.cert.CertificateException: No
subject alternative DNS name matching [hostname] found</code> or
<code>javax.net.ssl.SSLProtocolException: handshake alert: unrecognized_name</code> on
some misconfigured HTTPS sites.</p>
<p>The following one-time-run <code>static</code> initializer in your web scraper class
should make <code>HttpsURLConnection</code> more lenient as to those HTTPS sites and thus
not throw those exceptions anymore.</p>
<div class="code"><pre class="code literal-block"><span class="k">static</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">TrustManager</span><span class="err">[]</span><span class="w"> </span><span class="n">trustAllCertificates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TrustManager</span><span class="err">[]</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">X509TrustManager</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="nv">@Override</span>
<span class="w">            </span><span class="k">public</span><span class="w"> </span><span class="n">X509Certificate</span><span class="err">[]</span><span class="w"> </span><span class="n">getAcceptedIssuers</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="k">null</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="ow">Not</span><span class="w"> </span><span class="n">relevant</span><span class="p">.</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">            </span><span class="nv">@Override</span>
<span class="w">            </span><span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">checkClientTrusted</span><span class="p">(</span><span class="n">X509Certificate</span><span class="err">[]</span><span class="w"> </span><span class="n">certs</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">authType</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="n">nothing</span><span class="p">.</span><span class="w"> </span><span class="n">Just</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="ow">all</span><span class="p">.</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">            </span><span class="nv">@Override</span>
<span class="w">            </span><span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">checkServerTrusted</span><span class="p">(</span><span class="n">X509Certificate</span><span class="err">[]</span><span class="w"> </span><span class="n">certs</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">authType</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="n">nothing</span><span class="p">.</span><span class="w"> </span><span class="n">Just</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="ow">all</span><span class="p">.</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span><span class="p">;</span>

<span class="w">    </span><span class="n">HostnameVerifier</span><span class="w"> </span><span class="n">trustAllHostnames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HostnameVerifier</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="nv">@Override</span>
<span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">boolean</span><span class="w"> </span><span class="n">verify</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">hostname</span><span class="p">,</span><span class="w"> </span><span class="n">SSLSession</span><span class="w"> </span><span class="k">session</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">true</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Just</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="ow">all</span><span class="p">.</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span><span class="p">;</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">System</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="ss">"jsse.enableSNIExtension"</span><span class="p">,</span><span class="w"> </span><span class="ss">"false"</span><span class="p">);</span>
<span class="w">        </span><span class="n">SSLContext</span><span class="w"> </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSLContext</span><span class="p">.</span><span class="n">getInstance</span><span class="p">(</span><span class="ss">"SSL"</span><span class="p">);</span>
<span class="w">        </span><span class="n">sc</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="n">trustAllCertificates</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecureRandom</span><span class="p">());</span>
<span class="w">        </span><span class="n">HttpsURLConnection</span><span class="p">.</span><span class="n">setDefaultSSLSocketFactory</span><span class="p">(</span><span class="n">sc</span><span class="p">.</span><span class="n">getSocketFactory</span><span class="p">());</span>
<span class="w">        </span><span class="n">HttpsURLConnection</span><span class="p">.</span><span class="n">setDefaultHostnameVerifier</span><span class="p">(</span><span class="n">trustAllHostnames</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">GeneralSecurityException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ExceptionInInitializerError</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<hr>
<h4>Last words</h4>
<p>The Apache HttpComponents HttpClient is <em>much</em> more convenient in this all :)</p>
<ul>
<li>HttpClient Tutorial</li>
<li>HttpClient Examples</li>
</ul>
<hr>
<h4>Parsing and extracting HTML</h4>
<p>If all you want is parsing and extracting data from HTML, then better use a
HTML parser like Jsoup.</p>
<ul>
<li>What are the pros/cons of leading HTML parsers in Java</li>
<li>How to scan and extract a webpage in Java</li>
</ul>
<p><br></p>
<h3>Suggest</h3>
<p>When working with HTTP it's almost always more useful to refer to
<code>HttpURLConnection</code> rather than the base class <code>URLConnection</code> (since
<code>URLConnection</code> is an abstract class when you ask for
<code>URLConnection.openConnection()</code> on a HTTP URL that's what you'll get back
anyway).</p>
<p>Then you can instead of relying on <code>URLConnection#setDoOutput(true)</code> to
implicitly set the request method to <em>POST</em> instead do
<code>httpURLConnection.setRequestMethod("POST")</code> which some might find more
natural (and which also allows you to specify other request methods such as
<em>PUT</em> , <em>DELETE</em> , ...).</p>
<p>It also provides useful HTTP constants so you can do:</p>
<div class="code"><pre class="code literal-block"><span class="nv">int</span><span class="w"> </span><span class="nv">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">httpURLConnection</span>.<span class="nv">getResponseCode</span><span class="ss">()</span><span class="c1">;</span>

<span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">responseCode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">HttpURLConnection</span>.<span class="nv">HTTP_OK</span><span class="ss">)</span><span class="w"> </span>{
</pre></div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/http/" rel="tag">http</a></li>
            <li><a class="tag p-category" href="../../categories/httprequest/" rel="tag">httprequest</a></li>
            <li><a class="tag p-category" href="../../categories/httpurlconnection/" rel="tag">httpurlconnection</a></li>
            <li><a class="tag p-category" href="../../categories/java/" rel="tag">java</a></li>
            <li><a class="tag p-category" href="../../categories/urlconnection/" rel="tag">urlconnection</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../what-s-the-difference-between-a-method-and-a-function/" rel="prev" title="What's the difference between a method and a function?">Previous post</a>
            </li>
            <li class="next">
                <a href="../how-to-create-an-array-containing-1-n/" rel="next" title="How to create an array containing 1...N">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow中文网</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
