<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>为什么我们需要中间件来实现 Redux 中的异步流？ | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/wei-shi-yao-wo-men-xu-yao-zhong-jian-jian-lai-shi-xian-redux-zhong-de-yi-bu-liu/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../wo-ru-he-gao-su-maven-shi-yong-zui-xin-ban-ben-de-yi-lai-xiang/" title="我如何告诉 Maven 使用最新版本的依赖项？" type="text/html">
<link rel="next" href="../ru-he-zai-php-zhong-jiang-zi-fu-chuan-zhuan-huan-wei-shu-zi/" title="如何在 PHP 中将字符串转换为数字？" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="为什么我们需要中间件来实现 Redux 中的异步流？">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/wei-shi-yao-wo-men-xu-yao-zhong-jian-jian-lai-shi-xian-redux-zhong-de-yi-bu-liu/">
<meta property="og:description" content="根据文档，“没有中间件，Redux 存储仅支持同步数据流”。我不明白为什么会这样。为什么容器组件不能调用异步 API，然后dispatch调用操作？
例如，想象一个简单的 UI：一个字段和一个按钮。当用户按下按钮时，该字段会填充来自远程服务器的数据。

import * as React from 'react';
import * as Redux from 'redux';
import { ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-17T10:35:39+08:00">
<meta property="article:tag" content="asynchronous">
<meta property="article:tag" content="javascript">
<meta property="article:tag" content="reactjs">
<meta property="article:tag" content="redux">
<meta property="article:tag" content="redux-thunk">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">为什么我们需要中间件来实现 Redux 中的异步流？</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T10:35:39+08:00" itemprop="datePublished" title="2023-02-17 10:35">2023-02-17 10:35</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>根据文档，“没有中间件，Redux 存储仅支持同步数据流”。我不明白为什么会这样。为什么容器组件不能调用异步 API，然后<code>dispatch</code>调用操作？</p>
<p>例如，想象一个简单的 UI：一个字段和一个按钮。当用户按下按钮时，该字段会填充来自远程服务器的数据。</p>
<p><img alt="一个字段和一个按钮" src="../../images/GBI59.png"></p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="o">*</span> <span class="k">as</span> <span class="n">React</span> <span class="kn">from</span> <span class="s1">'react'</span><span class="p">;</span>
<span class="kn">import</span> <span class="o">*</span> <span class="k">as</span> <span class="n">Redux</span> <span class="kn">from</span> <span class="s1">'redux'</span><span class="p">;</span>
<span class="kn">import</span> <span class="p">{</span> <span class="n">Provider</span><span class="p">,</span> <span class="n">connect</span> <span class="p">}</span> <span class="kn">from</span> <span class="s1">'react-redux'</span><span class="p">;</span>

<span class="n">const</span> <span class="n">ActionTypes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">STARTED_UPDATING</span><span class="p">:</span> <span class="s1">'STARTED_UPDATING'</span><span class="p">,</span>
    <span class="n">UPDATED</span><span class="p">:</span> <span class="s1">'UPDATED'</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">AsyncApi</span> <span class="p">{</span>
    <span class="n">static</span> <span class="n">getFieldValue</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">const</span> <span class="n">promise</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Promise</span><span class="p">((</span><span class="n">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="n">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">resolve</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">));</span>
            <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="n">promise</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">App</span> <span class="n">extends</span> <span class="n">React</span><span class="o">.</span><span class="n">Component</span> <span class="p">{</span>
    <span class="n">render</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="o">&lt;</span><span class="n">div</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nb">input</span> <span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">field</span><span class="p">}</span><span class="o">/&gt;</span>
                <span class="o">&lt;</span><span class="n">button</span> <span class="n">disabled</span><span class="o">=</span><span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">isWaiting</span><span class="p">}</span> <span class="n">onClick</span><span class="o">=</span><span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">update</span><span class="p">}</span><span class="o">&gt;</span><span class="n">Fetch</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
                <span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">isWaiting</span> <span class="o">&amp;&amp;</span> <span class="o">&lt;</span><span class="n">div</span><span class="o">&gt;</span><span class="n">Waiting</span><span class="o">...&lt;/</span><span class="n">div</span><span class="o">&gt;</span><span class="p">}</span>
            <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">App</span><span class="o">.</span><span class="n">propTypes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">dispatch</span><span class="p">:</span> <span class="n">React</span><span class="o">.</span><span class="n">PropTypes</span><span class="o">.</span><span class="n">func</span><span class="p">,</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">React</span><span class="o">.</span><span class="n">PropTypes</span><span class="o">.</span><span class="n">any</span><span class="p">,</span>
    <span class="n">isWaiting</span><span class="p">:</span> <span class="n">React</span><span class="o">.</span><span class="n">PropTypes</span><span class="o">.</span><span class="n">bool</span>
<span class="p">};</span>

<span class="n">const</span> <span class="n">reducer</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span> <span class="o">=</span> <span class="p">{</span> <span class="n">field</span><span class="p">:</span> <span class="s1">'No data'</span><span class="p">,</span> <span class="n">isWaiting</span><span class="p">:</span> <span class="n">false</span> <span class="p">},</span> <span class="n">action</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">switch</span> <span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">ActionTypes</span><span class="o">.</span><span class="n">STARTED_UPDATING</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span> <span class="o">...</span><span class="n">state</span><span class="p">,</span> <span class="n">isWaiting</span><span class="p">:</span> <span class="n">true</span> <span class="p">};</span>
        <span class="k">case</span> <span class="n">ActionTypes</span><span class="o">.</span><span class="n">UPDATED</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span> <span class="o">...</span><span class="n">state</span><span class="p">,</span> <span class="n">isWaiting</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">action</span><span class="o">.</span><span class="n">payload</span> <span class="p">};</span>
        <span class="n">default</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="n">const</span> <span class="n">store</span> <span class="o">=</span> <span class="n">Redux</span><span class="o">.</span><span class="n">createStore</span><span class="p">(</span><span class="n">reducer</span><span class="p">);</span>
<span class="n">const</span> <span class="n">ConnectedApp</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span>
    <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span> <span class="o">...</span><span class="n">state</span> <span class="p">};</span>
    <span class="p">},</span>
    <span class="p">(</span><span class="n">dispatch</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">update</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">dispatch</span><span class="p">({</span>
                    <span class="nb">type</span><span class="p">:</span> <span class="n">ActionTypes</span><span class="o">.</span><span class="n">STARTED_UPDATING</span>
                <span class="p">});</span>
                <span class="n">AsyncApi</span><span class="o">.</span><span class="n">getFieldValue</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">result</span> <span class="o">=&gt;</span> <span class="n">dispatch</span><span class="p">({</span>
                        <span class="nb">type</span><span class="p">:</span> <span class="n">ActionTypes</span><span class="o">.</span><span class="n">UPDATED</span><span class="p">,</span>
                        <span class="n">payload</span><span class="p">:</span> <span class="n">result</span>
                    <span class="p">}));</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">})(</span><span class="n">App</span><span class="p">);</span>
<span class="n">export</span> <span class="n">default</span> <span class="k">class</span> <span class="nc">extends</span> <span class="n">React</span><span class="o">.</span><span class="n">Component</span> <span class="p">{</span>
    <span class="n">render</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">&lt;</span><span class="n">Provider</span> <span class="n">store</span><span class="o">=</span><span class="p">{</span><span class="n">store</span><span class="p">}</span><span class="o">&gt;&lt;</span><span class="n">ConnectedApp</span><span class="o">/&gt;&lt;/</span><span class="n">Provider</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>渲染导出的组件后，我可以单击按钮并正确更新输入。</p>
<p>注意调用<code>update</code>中的函数<code>connect</code>。它调度一个动作，告诉应用程序它正在更新，然后执行异步调用。调用完成后，提供的值将作为另一个操作的有效负载进行分派。</p>
<p>这种方法有什么问题？为什么我要像文档中建议的那样使用 Redux Thunk 或 Redux Promise？</p>
<p><strong>编辑：</strong> 我在 Redux 存储库中搜索线索，发现 Action Creators
过去被要求是纯函数。例如，这里有一位用户试图为异步数据流提供更好的解释：</p>
<blockquote>
<p>action creator 本身仍然是一个纯函数，但是它返回的 thunk 函数不需要，它可以做我们的异步调用</p>
</blockquote>
<p>动作创作者不再需要是纯粹的。所以，thunk/promise middleware 以前肯定是需要的，现在好像不是这样了？</p>
<p><br><br></p>
<h2>解答</h2>
<blockquote>
<p>这种方法有什么问题？为什么我要像文档中建议的那样使用 Redux Thunk 或 Redux Promise？</p>
</blockquote>
<p>这种方法没有错。这在大型应用程序中很不方便，因为您将有不同的组件执行相同的操作，您可能想要对某些操作进行去抖动，或者将一些本地状态（如自动递增
ID）保持在操作创建者附近，等等。所以它更容易从维护观点将动作创建者提取到单独的函数中。</p>
<p><strong>您可以阅读 我对“How to dispatch a Redux action with a timeout”的回答以获得更详细的演练。</strong></p>
<p>Redux Thunk 或 Redux Promise 等中间件只是为您提供“语法糖”以分派 thunk 或 promises，但您不必 <em>使用</em> 它。</p>
<p>所以，没有任何中间件，你的动作创建者可能看起来像</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="n">creator</span>
<span class="n">function</span><span class="w"> </span><span class="n">loadData</span><span class="p">(</span><span class="n">dispatch</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">needs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dispatch</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="n">argument</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">fetch</span><span class="p">(</span><span class="err">`</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">data</span><span class="o">.</span><span class="n">com</span><span class="o">/$</span><span class="p">{</span><span class="n">userId</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
<span class="w">    </span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<span class="w">    </span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
<span class="w">      </span><span class="n">data</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">({</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_DATA_SUCCESS'</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">}),</span>
<span class="w">      </span><span class="n">err</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">({</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_DATA_FAILURE'</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>

<span class="o">//</span><span class="w"> </span><span class="n">component</span>
<span class="n">componentWillMount</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">loadData</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">dispatch</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">don</span><span class="s1">'t forget to pass dispatch</span>
<span class="p">}</span>
</pre></div>

<p>但是使用 Thunk Middleware 你可以这样写：</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="n">creator</span>
<span class="n">function</span><span class="w"> </span><span class="n">loadData</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">fetch</span><span class="p">(</span><span class="err">`</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">data</span><span class="o">.</span><span class="n">com</span><span class="o">/$</span><span class="p">{</span><span class="n">userId</span><span class="p">}</span><span class="err">`</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Redux</span><span class="w"> </span><span class="n">Thunk</span><span class="w"> </span><span class="n">handles</span><span class="w"> </span><span class="n">these</span>
<span class="w">    </span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<span class="w">    </span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
<span class="w">      </span><span class="n">data</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">({</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_DATA_SUCCESS'</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">}),</span>
<span class="w">      </span><span class="n">err</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">({</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_DATA_FAILURE'</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>

<span class="o">//</span><span class="w"> </span><span class="n">component</span>
<span class="n">componentWillMount</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">loadData</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">userId</span><span class="p">));</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">like</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">usually</span><span class="w"> </span><span class="n">do</span>
<span class="p">}</span>
</pre></div>

<p>所以没有太大的区别。我喜欢后一种方法的一点是组件不关心动作创建者是异步的。它只是正常调用<code>dispatch</code>，它也可以用<code>mapDispatchToProps</code>一个简短的语法来绑定这样的动作创建者，等等。组件不知道动作创建者是如何实现的，你可以在不同的异步方法之间切换（Redux
Thunk，Redux Promise，Redux Saga ) 而无需更改组件。另一方面，使用前一种显式方法，您的组件 <em>确切地</em>
知道特定调用是异步的，并且需要<code>dispatch</code>通过某种约定（例如，作为同步参数）传递。</p>
<p>还要考虑这段代码将如何更改。假设我们想要第二个数据加载功能，并将它们组合在一个动作创建器中。</p>
<p>对于第一种方法，我们需要注意我们调用的是哪种动作创建者：</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="n">creators</span>
<span class="n">function</span><span class="w"> </span><span class="n">loadSomeData</span><span class="p">(</span><span class="n">dispatch</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">fetch</span><span class="p">(</span><span class="err">`</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">data</span><span class="o">.</span><span class="n">com</span><span class="o">/$</span><span class="p">{</span><span class="n">userId</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
<span class="w">    </span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<span class="w">    </span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
<span class="w">      </span><span class="n">data</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">({</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_SOME_DATA_SUCCESS'</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">}),</span>
<span class="w">      </span><span class="n">err</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">({</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_SOME_DATA_FAILURE'</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
<span class="n">function</span><span class="w"> </span><span class="n">loadOtherData</span><span class="p">(</span><span class="n">dispatch</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">fetch</span><span class="p">(</span><span class="err">`</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">data</span><span class="o">.</span><span class="n">com</span><span class="o">/$</span><span class="p">{</span><span class="n">userId</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
<span class="w">    </span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<span class="w">    </span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
<span class="w">      </span><span class="n">data</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">({</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_OTHER_DATA_SUCCESS'</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">}),</span>
<span class="w">      </span><span class="n">err</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">({</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_OTHER_DATA_FAILURE'</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
<span class="n">function</span><span class="w"> </span><span class="n">loadAllData</span><span class="p">(</span><span class="n">dispatch</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
<span class="w">    </span><span class="n">loadSomeData</span><span class="p">(</span><span class="n">dispatch</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">),</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">pass</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">first</span><span class="p">:</span><span class="w"> </span><span class="n">it</span><span class="s1">'s async</span>
<span class="w">    </span><span class="n">loadOtherData</span><span class="p">(</span><span class="n">dispatch</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">pass</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">first</span><span class="p">:</span><span class="w"> </span><span class="n">it</span><span class="s1">'s async</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>


<span class="o">//</span><span class="w"> </span><span class="n">component</span>
<span class="n">componentWillMount</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">loadAllData</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">dispatch</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">userId</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">pass</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">first</span>
<span class="p">}</span>
</pre></div>

<p>使用 Redux Thunk，动作创建者可以<code>dispatch</code>得到其他动作创建者的结果，甚至不需要考虑它们是同步的还是异步的：</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="n">creators</span>
<span class="n">function</span><span class="w"> </span><span class="n">loadSomeData</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">fetch</span><span class="p">(</span><span class="err">`</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">data</span><span class="o">.</span><span class="n">com</span><span class="o">/$</span><span class="p">{</span><span class="n">userId</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
<span class="w">    </span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<span class="w">    </span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
<span class="w">      </span><span class="n">data</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">({</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_SOME_DATA_SUCCESS'</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">}),</span>
<span class="w">      </span><span class="n">err</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">({</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_SOME_DATA_FAILURE'</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
<span class="n">function</span><span class="w"> </span><span class="n">loadOtherData</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">fetch</span><span class="p">(</span><span class="err">`</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">data</span><span class="o">.</span><span class="n">com</span><span class="o">/$</span><span class="p">{</span><span class="n">userId</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
<span class="w">    </span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<span class="w">    </span><span class="o">.</span><span class="n">then</span><span class="p">(</span>
<span class="w">      </span><span class="n">data</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">({</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_OTHER_DATA_SUCCESS'</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">}),</span>
<span class="w">      </span><span class="n">err</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">({</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_OTHER_DATA_FAILURE'</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
<span class="n">function</span><span class="w"> </span><span class="n">loadAllData</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
<span class="w">    </span><span class="n">dispatch</span><span class="p">(</span><span class="n">loadSomeData</span><span class="p">(</span><span class="n">userId</span><span class="p">)),</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">normally</span><span class="o">!</span>
<span class="w">    </span><span class="n">dispatch</span><span class="p">(</span><span class="n">loadOtherData</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">normally</span><span class="o">!</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>


<span class="o">//</span><span class="w"> </span><span class="n">component</span>
<span class="n">componentWillMount</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">loadAllData</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">userId</span><span class="p">));</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">normally</span><span class="o">!</span>
<span class="p">}</span>
</pre></div>

<p>使用这种方法，如果您稍后希望您的操作创建者查看当前的 Redux 状态，您可以只使用<code>getState</code>传递给 thunk
的第二个参数，而根本不修改调用代码：</p>
<div class="code"><pre class="code literal-block"><span class="k">function</span><span class="w"> </span><span class="n">loadSomeData</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Thanks</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">Redux</span><span class="w"> </span><span class="n">Thunk</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">getState</span><span class="p">()</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="k">without</span><span class="w"> </span><span class="n">changing</span><span class="w"> </span><span class="n">callers</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">dispatch</span><span class="p">,</span><span class="w"> </span><span class="n">getState</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getState</span><span class="p">().</span><span class="k">data</span><span class="o">[</span><span class="n">userId</span><span class="o">]</span><span class="p">.</span><span class="n">isLoaded</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Promise</span><span class="p">.</span><span class="n">resolve</span><span class="p">();</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">fetch</span><span class="p">(</span><span class="err">`</span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="k">data</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="err">${</span><span class="n">userId</span><span class="err">}`</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="k">then</span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">json</span><span class="p">())</span>
<span class="w">      </span><span class="p">.</span><span class="k">then</span><span class="p">(</span>
<span class="w">        </span><span class="k">data</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">(</span><span class="err">{</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_SOME_DATA_SUCCESS'</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="err">}</span><span class="p">),</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dispatch</span><span class="p">(</span><span class="err">{</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_SOME_DATA_FAILURE'</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="err">}</span><span class="p">)</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">  </span><span class="err">}</span>
<span class="err">}</span>
</pre></div>

<p>如果您需要将其更改为同步，也可以在不更改任何调用代码的情况下执行此操作：</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">regular</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="n">creator</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">touching</span><span class="w"> </span><span class="n">callers</span>
<span class="n">function</span><span class="w"> </span><span class="n">loadSomeData</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'LOAD_SOME_DATA_SUCCESS'</span><span class="p">,</span>
<span class="w">    </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="n">localStorage</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="s1">'my-data'</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>所以使用像 Redux Thunk 或 Redux Promise 这样的中间件的好处是组件不知道动作创建者是如何实现的，他们是否关心 Redux
状态，他们是同步的还是异步的，以及他们是否调用其他动作创建者. 缺点是有点间接，但我们相信在实际应用中这是值得的。</p>
<p>最后，Redux Thunk and friends 只是 Redux 应用程序中异步请求的一种可能方法。另一个有趣的方法是Redux
Saga，它允许您定义长时间运行的守护进程（“sagas”），它们会在动作到来时采取行动，并在输出动作之前转换或执行请求。这将逻辑从动作创建者转移到传奇中。您可能想检查一下，然后选择最适合您的。</p>
<blockquote>
<p>我搜索了 Redux repo 寻找线索，发现 Action Creators 过去要求是纯函数。</p>
</blockquote>
<p>这是不正确的。文档是这样说的，但是文档错了。<br>
动作创建者从来不需要是纯函数。<br>
我们修复了文档以反映这一点。</p>
<p><br></p>
<h3>更多建议</h3>
<h2>你不知道。</h2>
<h2>但是......你应该使用 redux-saga :)</h2>
<p>Dan Abramov 的回答是正确的<code>redux-thunk</code>，但我会多谈谈redux-saga，它非常相似但更强大。</p>
<h2>命令式 VS 声明式</h2>
<ul>
<li>
<strong>DOM</strong> ：jQuery 是命令式的/React 是声明式的</li>
<li>
<strong>Monads</strong> ：IO 是命令式的 / Free 是声明式的</li>
<li>
<strong>Redux 效果</strong> ：<code>redux-thunk</code>命令式/<code>redux-saga</code>声明式</li>
</ul>
<p>当您手中有一个 thunk 时，例如 IO monad 或 promise，您无法轻易知道执行后它会做什么。测试 thunk
的唯一方法是执行它，并模拟调度程序（如果它与更多东西交互，则模拟整个外部世界......）。</p>
<p>如果您使用模拟，那么您就不是在进行函数式编程。</p>
<blockquote>
<p>从副作用的角度来看，mocks
是一个标志，表明你的代码是不纯的，在函数式程序员的眼中，它证明了某些地方是错误的。与其下载库来帮助我们检查冰山是否完好，不如绕着它航行。一个铁杆
TDD/Java 人曾经问我你如何在 Clojure 中进行模拟。答案是，我们通常不会。我们通常将其视为需要重构代码的标志。</p>
</blockquote>
<p>来源</p>
<p>sagas（在 中实现<code>redux-saga</code>）是声明性的，并且像 Free monad 或 React 组件一样，它们在没有任何模拟的情况下更容易测试。</p>
<p>另请参阅这篇文章：</p>
<blockquote>
<p>在现代 FP 中，我们不应该编写程序——我们应该编写程序的描述，然后我们可以随意自省、转换和解释。</p>
</blockquote>
<p>（实际上，Redux-saga 就像一个混合体：流程是命令式的，但效果是声明式的）</p>
<h2>混淆：动作/事件/命令...</h2>
<p>在前端世界中，对于 CQRS / EventSourcing 和 Flux / Redux 等后端概念如何相关可能存在很多混淆，主要是因为在 Flux
中我们使用术语“动作”，它有时可以同时表示命令式代码 ( ) 和事件<code>LOAD_USER</code>( <code>USER_LOADED</code>).
我相信像事件溯源一样，你应该只发送事件。</p>
<h2>在实践中使用传奇</h2>
<p>想象一个带有用户个人资料链接的应用程序。用每个中间件处理这个问题的惯用方法是：</p>
<h3><code>redux-thunk</code></h3>
<div class="code"><pre class="code literal-block"><span class="nt">&lt;div</span> <span class="na">onClick=</span><span class="s">{e</span> <span class="err">=</span><span class="nt">&gt;</span><span class="w"> </span>dispatch(actions.loadUserProfile(123)}&gt;Robert<span class="nt">&lt;/div&gt;</span>

function<span class="w"> </span>loadUserProfile(userId)<span class="w"> </span>{
<span class="w">  </span>return<span class="w"> </span>dispatch<span class="w"> </span>=&gt;<span class="w"> </span>fetch(`http://data.com/<span class="cp">${</span><span class="n">userId</span><span class="cp">}</span>`)
<span class="w">    </span>.then(res<span class="w"> </span>=&gt;<span class="w"> </span>res.json())
<span class="w">    </span>.then(
<span class="w">      </span>data<span class="w"> </span>=&gt;<span class="w"> </span>dispatch({<span class="w"> </span>type:<span class="w"> </span>'USER_PROFILE_LOADED',<span class="w"> </span>data<span class="w"> </span>}),
<span class="w">      </span>err<span class="w"> </span>=&gt;<span class="w"> </span>dispatch({<span class="w"> </span>type:<span class="w"> </span>'USER_PROFILE_LOAD_FAILED',<span class="w"> </span>err<span class="w"> </span>})
<span class="w">    </span>);
}
</pre></div>

<h3><code>redux-saga</code></h3>
<div class="code"><pre class="code literal-block"><span class="nt">&lt;div</span> <span class="na">onClick=</span><span class="s">{e</span> <span class="err">=</span><span class="nt">&gt;</span><span class="w"> </span>dispatch({<span class="w"> </span>type:<span class="w"> </span>'USER_NAME_CLICKED',<span class="w"> </span>payload:<span class="w"> </span>123<span class="w"> </span>})}&gt;Robert<span class="nt">&lt;/div&gt;</span>


function*<span class="w"> </span>loadUserProfileOnNameClick()<span class="w"> </span>{
<span class="w">  </span>yield*<span class="w"> </span>takeLatest("USER_NAME_CLICKED",<span class="w"> </span>fetchUser);
}

function*<span class="w"> </span>fetchUser(action)<span class="w"> </span>{
<span class="w">  </span>try<span class="w"> </span>{
<span class="w">    </span>const<span class="w"> </span>userProfile<span class="w"> </span>=<span class="w"> </span>yield<span class="w"> </span>fetch(`http://data.com/<span class="cp">${</span><span class="n">action</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">userId</span> <span class="cp">}</span>`)
<span class="w">    </span>yield<span class="w"> </span>put({<span class="w"> </span>type:<span class="w"> </span>'USER_PROFILE_LOADED',<span class="w"> </span>userProfile<span class="w"> </span>})
<span class="w">  </span>}<span class="w"> </span>
<span class="w">  </span>catch(err)<span class="w"> </span>{
<span class="w">    </span>yield<span class="w"> </span>put({<span class="w"> </span>type:<span class="w"> </span>'USER_PROFILE_LOAD_FAILED',<span class="w"> </span>err<span class="w"> </span>})
<span class="w">  </span>}
}
</pre></div>

<p>这个传奇转化为：</p>
<blockquote>
<p>每次单击用户名时，获取用户配置文件，然后使用加载的配置文件发送事件。</p>
</blockquote>
<p>如您所见，. 有一些优点<code>redux-saga</code>。</p>
<p>使用<code>takeLatest</code>permits
表示您只对获取上次单击的用户名的数据感兴趣（处理并发问题，以防用户快速单击大量用户名）。这种东西很难用thunks。<code>takeEvery</code>如果你不想要这种行为，你可以使用。</p>
<p>你让动作创造者保持纯洁。请注意，保留 actionCreators（在 sagas<code>put</code>和
components中<code>dispatch</code>）仍然有用，因为它可能会帮助您在将来添加操作验证（断言/流程/打字稿）。</p>
<p>由于效果是声明性的，因此您的代码变得更加可测试</p>
<p>您不再需要触发类似 rpc 的调用，例如<code>actions.loadUser()</code>. 您的 UI 只需要发送发生的事情。我们只触发 <strong>事件</strong>
（总是过去式！），不再触发动作。这意味着您可以创建解耦的“鸭子”或限界上下文，并且 saga 可以充当这些模块化组件之间的耦合点。</p>
<p>这意味着您的视图更易于管理，因为它们不再需要在已发生的事情和应该发生的事情之间包含转换层</p>
<p>例如想象一个无限滚动视图。<code>CONTAINER_SCROLLED</code>可以导致<code>NEXT_PAGE_LOADED</code>，但是可滚动容器真的有责任决定我们是否应该加载另一个页面吗？然后他必须知道更复杂的事情，比如最后一页是否加载成功，或者是否已经有一个页面试图加载，或者是否没有更多的项目要加载？我不这么认为：为了最大程度的可重用性，可滚动容器应该只描述它已被滚动。页面的加载是该滚动的“业务效果”</p>
<p>有些人可能会争辩说，生成器可以固有地使用局部变量将状态隐藏在 redux 存储之外，但是如果你开始通过启动计时器等在 thunk
中编排复杂的东西，你无论如何都会遇到同样的问题。现在有一个<code>select</code>效果允许从您的 Redux 存储中获取一些状态。</p>
<p>Sagas 可以进行时间旅行，还可以启用复杂的流日志记录和当前正在开发的开发工具。这是一些已经实现的简单异步流日志记录：</p>
<p><img alt="传奇流日志记录" src="../../images/F9Jsh.png"></p>
<h2>解耦</h2>
<p>Sagas 不仅取代了 redux thunk。它们来自后端/分布式系统/事件源。</p>
<p>这是一个非常普遍的误解，认为 sagas 只是在这里用更好的可测试性来取代你的 redux thunk。实际上这只是 redux-saga
的一个实现细节。在可测试性方面，使用声明式效果比 thunk 更好，但是传奇模式可以在命令式或声明式代码之上实现。</p>
<p>首先，saga 是一个软件，可以协调长期运行的事务（最终一致性）和跨不同限界上下文的事务（领域驱动设计术语）。</p>
<p>为了简化前端世界，假设有 widget1 和 widget2。当 widget1 上的某个按钮被点击时，它应该会对 widget2 产生影响。widget1
没有将 2 个小部件耦合在一起（即 widget1 调度一个针对 widget2 的操作），widget1 仅调度其按钮被单击。然后 saga
侦听此按钮单击，然后通过调度 widget2 知道的新事件来更新 widget2。</p>
<p>这增加了一个简单应用程序不需要的间接级别，但可以更轻松地扩展复杂的应用程序。您现在可以将 widget1 和 widget2 发布到不同的 npm
存储库，这样它们就永远不必了解彼此，也无需让它们共享一个全局操作注册表。这 2
个小部件现在是可以单独存在的限界上下文。它们不需要彼此保持一致，也可以在其他应用程序中重复使用。saga
是两个小部件之间的耦合点，以对您的业务有意义的方式协调它们。</p>
<p>一些关于如何构建 Redux 应用程序的好文章，您可以在这些文章上使用 Redux-saga 来解耦：</p>
<ul>
<li>http://jaysoo.ca/2016/02/28/organizing-redux-application/</li>
<li>http://marmelab.com/blog/2015/12/17/react-directory-structure.html</li>
<li>https://github.com/slorber/scalable-frontend-with-elm-or-redux</li>
</ul>
<h2>具体用例：通知系统</h2>
<p>我希望我的组件能够触发应用内通知的显示。但我不希望我的组件与具有自己业务规则的通知系统高度耦合（同时显示最多 3 个通知、通知排队、4
秒显示时间等...）。</p>
<p>我不希望我的 JSX 组件决定通知何时显示/隐藏。我只是赋予它请求通知的能力，并将复杂的规则留在 saga 中。这种东西很难用 thunk 或
promises 来实现。</p>
<p><img alt="通知" src="../../images/XQ8lx.png"></p>
<p>我在这里描述了如何用传奇来完成</p>
<h2>为什么叫传奇？</h2>
<p>传奇一词来自后端世界。我最初在长时间的讨论中向 Yassine（Redux-saga 的作者）介绍了该术语。</p>
<p>最初，该术语是在一篇论文中引入的，saga
模式应该用于处理分布式事务中的最终一致性，但它的用法已被后端开发人员扩展到更广泛的定义，因此它现在也涵盖了“流程管理器”模式（原始传奇模式在某种程度上是流程管理器的一种特殊形式）。</p>
<p>Today, the term "saga" is confusing as it can describe 2 different things. As
it is used in redux-saga, it does not describe a way to handle distributed
transactions but rather a way to coordinate actions in your app. <code>redux-saga</code>
could also have been called <code>redux-process-manager</code>.</p>
<p>See also:</p>
<ul>
<li>Interview of Yassine about Redux-saga history</li>
<li>Kella Byte: Claryfing the Saga pattern</li>
<li>Microsoft CQRS Journey: A Saga on Sagas</li>
<li>Medium response of Yassine</li>
</ul>
<h2>Alternatives</h2>
<p>If you don't like the idea of using generators but you are interested by the
saga pattern and its decoupling properties, you can also achieve the same with
redux-observable which uses the name <code>epic</code> to describe the exact same
pattern, but with RxJS. If you're already familiar with Rx, you'll feel right
at home.</p>
<div class="code"><pre class="code literal-block"><span class="k">const</span><span class="w"> </span><span class="n">loadUserProfileOnNameClickEpic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">action</span><span class="o">$</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">  </span><span class="n">action</span><span class="o">$.</span><span class="n">ofType</span><span class="p">(</span><span class="s1">'USER_NAME_CLICKED'</span><span class="p">)</span>
<span class="w">    </span><span class="o">.</span><span class="n">switchMap</span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">      </span><span class="n">Observable</span><span class="o">.</span><span class="n">ajax</span><span class="p">(</span><span class="err">`</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">data</span><span class="o">.</span><span class="n">com</span><span class="o">/$</span><span class="p">{</span><span class="n">action</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">userId</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
<span class="w">        </span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">userProfile</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">          </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'USER_PROFILE_LOADED'</span><span class="p">,</span>
<span class="w">          </span><span class="n">userProfile</span>
<span class="w">        </span><span class="p">}))</span>
<span class="w">        </span><span class="o">.</span><span class="n">catch</span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Observable</span><span class="o">.</span><span class="n">of</span><span class="p">({</span>
<span class="w">          </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'USER_PROFILE_LOAD_FAILED'</span><span class="p">,</span>
<span class="w">          </span><span class="n">err</span>
<span class="w">        </span><span class="p">}))</span>
<span class="w">    </span><span class="p">);</span>
</pre></div>

<h2>Some redux-saga useful resources</h2>
<ul>
<li>Redux-saga vs Redux-thunk with async/await</li>
<li>Managing processes in Redux Saga</li>
<li>From actionsCreators to Sagas</li>
<li>Snake game implemented with Redux-saga</li>
</ul>
<h2>2017 advises</h2>
<ul>
<li>Don't overuse Redux-saga just for the sake of using it. Testable API calls only are not worth it.</li>
<li>Don't remove thunks from your project for most simple cases.</li>
<li>Don't hesitate to dispatch thunks in <code>yield put(someActionThunk)</code> if it makes sense.</li>
</ul>
<p>If you are frightened of using Redux-saga (or Redux-observable) but just need
the decoupling pattern, check redux-dispatch-subscribe: it permits to listen
to dispatches and trigger new dispatches in listener.</p>
<div class="code"><pre class="code literal-block"><span class="k">const</span><span class="w"> </span><span class="n">unsubscribe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="o">.</span><span class="n">addDispatchListener</span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'ping'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">store</span><span class="o">.</span><span class="n">dispatch</span><span class="p">({</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s1">'pong'</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p><br><br><a href="../why-do-we-need-middleware-for-async-flow-in-redux/">查看原文</a></p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/asynchronous/" rel="tag">asynchronous</a></li>
            <li><a class="tag p-category" href="../../categories/javascript/" rel="tag">javascript</a></li>
            <li><a class="tag p-category" href="../../categories/reactjs/" rel="tag">reactjs</a></li>
            <li><a class="tag p-category" href="../../categories/redux/" rel="tag">redux</a></li>
            <li><a class="tag p-category" href="../../categories/redux-thunk/" rel="tag">redux-thunk</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../wo-ru-he-gao-su-maven-shi-yong-zui-xin-ban-ben-de-yi-lai-xiang/" rel="prev" title="我如何告诉 Maven 使用最新版本的依赖项？">Previous post</a>
            </li>
            <li class="next">
                <a href="../ru-he-zai-php-zhong-jiang-zi-fu-chuan-zhuan-huan-wei-shu-zi/" rel="next" title="如何在 PHP 中将字符串转换为数字？">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
