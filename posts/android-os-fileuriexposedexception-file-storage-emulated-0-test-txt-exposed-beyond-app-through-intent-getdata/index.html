<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>android.os.FileUriExposedException: file:///storage/emulated/0/test.txt exposed beyond app through Intent.getData() | StackOverflow Snapshot</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://ohstackoverflow.netlify.app/posts/android-os-fileuriexposedexception-file-storage-emulated-0-test-txt-exposed-beyond-app-through-intent-getdata/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Arya">
<link rel="prev" href="../does-javascript-guarantee-object-property-order/" title="Does JavaScript guarantee object property order?" type="text/html">
<link rel="next" href="../how-to-check-ios-version/" title="How to check iOS version?" type="text/html">
<meta property="og:site_name" content="StackOverflow Snapshot">
<meta property="og:title" content="android.os.FileUriExposedException: file:///storage/emulated/0/test.tx">
<meta property="og:url" content="https://ohstackoverflow.netlify.app/posts/android-os-fileuriexposedexception-file-storage-emulated-0-test-txt-exposed-beyond-app-through-intent-getdata/">
<meta property="og:description" content="The app is crashing when I'm trying to open a file. It works below Android
Nougat, but on Android Nougat it crashes. It only crashes when I try to open a
file from the SD card, not from the system par">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-17T10:04:49+08:00">
<meta property="article:tag" content="android">
<meta property="article:tag" content="android-7.0-nougat">
<meta property="article:tag" content="android-file">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ohstackoverflow.netlify.app/">

                <span id="blog-title">StackOverflow Snapshot</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<div style="display:table;min-height:5rem;min-width:27rem;">
					<div class="input-group" style="display: table-cell;vertical-align: middle;">
						<input id="words" type="text" class="form-control" style="max-width:22rem;" onkeydown="if(event.keyCode==13){btn.click()}"><span class="input-group-btn" style="float:left">
							<button id="btn" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
								<span class="glyphicon glyphicon-search">
							</span></button>
						</span>
					</div>
<!-- /input-group -->
				</div>

				
                
                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><!-- 模态框（Modal） --><div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
				</button>
				<h4 class="modal-title" id="myModalLabel">
					查找结果
				</h4>
			</div>
			<div class="modal-body">
				<div id="search-count" style="min-height:4rem;">
				查找中，请稍后...
				</div>
				<div id="search-result">
				</div>

				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">
					关闭
				</button>
			</div>
		</div>
<!-- /.modal-content -->
	</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">android.os.FileUriExposedException: file:///storage/emulated/0/test.txt exposed beyond app through Intent.getData()</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/arya/">Arya</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2023-02-17T10:04:49+08:00" itemprop="datePublished" title="2023-02-17 10:04">2023-02-17 10:04</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>The app is crashing when I'm trying to open a file. It works below Android
Nougat, but on Android Nougat it crashes. It only crashes when I try to open a
file from the SD card, not from the system partition. Some permission problem?</p>
<p>Sample code:</p>
<div class="code"><pre class="code literal-block">File file = new File("/storage/emulated/0/test.txt");
Intent intent = new Intent(Intent.ACTION_VIEW);
intent.setDataAndType(Uri.fromFile(file), "text/*");
intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
startActivity(intent); // Crashes on this line
</pre></div>

<p>Log:</p>
<blockquote>
<p>android.os.FileUriExposedException: file:///storage/emulated/0/test.txt
exposed beyond app through Intent.getData()</p>
</blockquote>
<p><strong>Edit:</strong></p>
<p>When targeting Android Nougat, <code>file://</code> URIs are not allowed anymore. We
should use <code>content://</code> URIs instead. However, my app needs to open files in
root directories. Any ideas?</p>
<p><br><br></p>
<h2>Answer</h2>
<p>If your <code>targetSdkVersion &gt;= 24</code>, then we have to use <code>FileProvider</code> class to
give access to the particular file or folder to make them accessible for other
apps. We create our own class inheriting <code>FileProvider</code> in order to make sure
our FileProvider doesn't conflict with FileProviders declared in imported
dependencies as described here.</p>
<p>Steps to replace <code>file://</code> URI with <code>content://</code> URI:</p>
<ul>
<li>
<p>Add a FileProvider <code>&lt;provider&gt;</code> tag in <code>AndroidManifest.xml</code> under <code>&lt;application&gt;</code> tag. Specify a unique authority for the <code>android:authorities</code> attribute to avoid conflicts, imported dependencies might specify <code>${applicationId}.provider</code> and other commonly used authorities.</p>
<p>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android"
    ...
    &lt;application
        ...
        <provider android:name="androidx.core.content.FileProvider" android:authorities="${applicationId}.provider" android:exported="false" android:granturipermissions="true"><meta-data android:name="android.support.FILE_PROVIDER_PATHS" android:resource="@xml/provider_paths"></meta-data></provider></p>
</li>
<li>
<p>Then create a <code>provider_paths.xml</code> file in <code>res/xml</code> folder. A folder may be needed to be created if it doesn't exist yet. The content of the file is shown below. It describes that we would like to share access to the External Storage at root folder <code>(path=".")</code> with the name <strong>external_files</strong>.</p>
<p>&lt;?xml version="1.0" encoding="utf-8"?&gt;
<paths><external-path name="external_files" path="."></external-path></paths></p>
</li>
<li>
<p>The final step is to change the line of code below in</p>
<div class="code"><pre class="code literal-block"> Uri photoURI = Uri.fromFile(createImageFile());
</pre></div>

</li>
</ul>
<p>to</p>
<div class="code"><pre class="code literal-block">     Uri photoURI = FileProvider.getUriForFile(context, context.getApplicationContext().getPackageName() + ".provider", createImageFile());
</pre></div>

<ul>
<li>
<strong>Edit:</strong> If you're using an intent to make the system open your file, you may need to add the following line of code:<div class="code"><pre class="code literal-block"> intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
</pre></div>

</li>
</ul>
<p>Please refer to the full code and solution that have been explained here.</p>
<p><br></p>
<h3>Suggest</h3>
<p>Besides the solution using the <code>FileProvider</code>, there is another way to work
around this. Simply put</p>
<div class="code"><pre class="code literal-block">StrictMode.VmPolicy.Builder builder = new StrictMode.VmPolicy.Builder();
StrictMode.setVmPolicy(builder.build());
</pre></div>

<p>in <code>Application.onCreate()</code>. In this way the VM ignores the file <code>URI</code>
exposure.</p>
<p><strong>Method</strong></p>
<div class="code"><pre class="code literal-block">builder.detectFileUriExposure()
</pre></div>

<p>enables the file exposure check, which is also the default behavior if we
don't setup a VmPolicy.</p>
<p>I encountered a problem that if I use a <code>content://</code> <code>URI</code> to send something,
some apps just can't understand it. And downgrading the <code>target SDK</code> version
is not allowed. In this case my solution is useful.</p>
<p><strong>Update:</strong></p>
<p>As mentioned in the comment, StrictMode is diagnostic tool, and is not
supposed to be used for this problem. When I posted this answer a year ago,
many apps can only receive File uris. They just crash when I tried to send a
FileProvider uri to them. This is fixed in most apps now, so we should go with
the FileProvider solution.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/android/" rel="tag">android</a></li>
            <li><a class="tag p-category" href="../../categories/android-70-nougat/" rel="tag">android-7.0-nougat</a></li>
            <li><a class="tag p-category" href="../../categories/android-file/" rel="tag">android-file</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../does-javascript-guarantee-object-property-order/" rel="prev" title="Does JavaScript guarantee object property order?">Previous post</a>
            </li>
            <li class="next">
                <a href="../how-to-check-ios-version/" rel="next" title="How to check iOS version?">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         Go to StackOverflow Chinese Site  <a href="http://stackoverflow.ink">StackOverflow-ZH</a>  
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/search.js"></script>
</body>
</html>
